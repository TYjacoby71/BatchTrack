2025-07-07 20:04:32,296 ERROR: Exception on /products/adjust/4 [POST] [in /home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py:875]
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app/blueprints/products/product_inventory_routes.py", line 213, in adjust_sku_inventory
    return redirect(url_for('products.view_sku', sku_id=sku_id))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/helpers.py", line 232, in url_for
    return current_app.url_for(
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1121, in url_for
    return self.handle_url_build_error(error, endpoint, values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1110, in url_for
    rv = url_adapter.build(  # type: ignore[union-attr]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/routing/map.py", line 924, in build
    raise BuildError(endpoint, values, method, self)
werkzeug.routing.exceptions.BuildError: Could not build url for endpoint 'products.view_sku' with values ['sku_id']. Did you mean 'products.view_product' instead?
2025-07-07 20:08:58,816 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:17]
2025-07-07 20:09:22,011 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:17]
2025-07-07 20:09:38,389 INFO: === PRODUCT INVENTORY ADJUSTMENT START === [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:18]
2025-07-07 20:09:38,389 INFO: SKU ID: 4 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:19]
2025-07-07 20:09:38,389 INFO: User: 2 (admin) [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:20]
2025-07-07 20:09:38,389 INFO: Organization: 1 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:21]
2025-07-07 20:09:38,389 INFO: Request method: POST [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:22]
2025-07-07 20:09:38,389 INFO: Request is JSON: False [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:23]
2025-07-07 20:09:38,392 INFO: SKU lookup result: <ProductSKU Admin Apple Sauce - Base - Bulk> [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:31]
2025-07-07 20:09:38,392 INFO: SKU details - inventory_item_id: 4, Product: Admin Apple Sauce, Variant: Base [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:33]
2025-07-07 20:09:38,392 INFO: SKU inventory item: <InventoryItem 4> [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:34]
2025-07-07 20:09:38,393 INFO: Current inventory quantity: 1.0 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:36]
2025-07-07 20:09:38,393 INFO: Form request data: {'csrf_token': 'ImJmMDMzMGUyZTY5OTkzY2EzMTY5YTcyNWI5ZGIzOWI1MzY2NGFlYTMi.aGwpew.ofXIoorILpE3Oh-f9FVGGt3StMo', 'action': 'adjust_fifo', 'inventory_id': '', 'change_type': 'manual_addition', 'quantity': '1', 'notes': '', 'order_id': '', 'sale_price': '', 'restock_cost': '1.0', 'expiration_minutes': '30'} [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:53]
2025-07-07 20:09:38,393 INFO: Extracted quantity: 1 (type: <class 'str'>) [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:59]
2025-07-07 20:09:38,393 INFO: Extracted change_type: manual_addition [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:60]
2025-07-07 20:09:38,393 INFO: Converting quantity '1' to float [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:86]
2025-07-07 20:09:38,394 INFO: Converted quantity: 1.0 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:88]
2025-07-07 20:09:38,394 INFO: Optional fields extracted: [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:102]
2025-07-07 20:09:38,394 INFO:   - notes:  [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:103]
2025-07-07 20:09:38,394 INFO:   - unit: floz [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:104]
2025-07-07 20:09:38,394 INFO:   - customer: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:105]
2025-07-07 20:09:38,394 INFO:   - sale_price: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:106]
2025-07-07 20:09:38,395 INFO:   - order_id:  [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:107]
2025-07-07 20:09:38,395 INFO:   - cost_override: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:108]
2025-07-07 20:09:38,395 INFO: === CALLING CENTRALIZED INVENTORY ADJUSTMENT === [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:125]
2025-07-07 20:09:38,395 INFO: Parameters: [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:126]
2025-07-07 20:09:38,395 INFO:   - item_id (inventory_item_id): 4 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:127]
2025-07-07 20:09:38,395 INFO:   - quantity: 1.0 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:128]
2025-07-07 20:09:38,395 INFO:   - change_type: manual_addition [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:129]
2025-07-07 20:09:38,396 INFO:   - unit: floz [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:130]
2025-07-07 20:09:38,396 INFO:   - notes:  [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:131]
2025-07-07 20:09:38,396 INFO:   - created_by: 2 [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:132]
2025-07-07 20:09:38,396 INFO:   - item_type: product [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:133]
2025-07-07 20:09:38,396 INFO:   - customer: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:134]
2025-07-07 20:09:38,396 INFO:   - sale_price: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:135]
2025-07-07 20:09:38,396 INFO:   - order_id:  [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:136]
2025-07-07 20:09:38,396 INFO:   - cost_override: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:137]
2025-07-07 20:09:38,397 INFO:   - custom_expiration_date: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:138]
2025-07-07 20:09:38,397 INFO:   - custom_shelf_life_days: None [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:139]
2025-07-07 20:09:38,406 ERROR: Exception in SKU inventory adjustment: Error adjusting inventory: (sqlite3.IntegrityError) NOT NULL constraint failed: product_sku_history.sku_id
[SQL: INSERT INTO product_sku_history (inventory_item_id, timestamp, change_type, quantity_change, remaining_quantity, original_quantity, unit, unit_cost, sale_price, customer, fifo_code, fifo_reference_id, fifo_source, is_perishable, shelf_life_days, expiration_date, batch_id, container_id, notes, note, created_by, order_id, reservation_id, is_reserved, sale_location, quantity_used, batch_number, lot_number, temperature_at_time, location_id, location_name, quality_status, compliance_status, quality_checked_by, marketplace_order_id, marketplace_source, organization_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (4, '2025-07-07 20:09:38.405184', 'manual_addition', 1.0, 1.0, None, 'floz', 1.0, None, None, None, None, None, 0, None, None, None, None, '', None, 2, '', None, 0, None, 0.0, None, None, None, None, None, None, None, None, None, None, 1)]
(Background on this error at: https://sqlalche.me/e/20/gkpj) [in /home/runner/workspace/app/blueprints/products/product_inventory_routes.py:203]
