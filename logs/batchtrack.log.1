2025-08-21 05:34:11,177 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:34:12,134 INFO: CANONICAL DISPATCHER: item_id=1, quantity=250.0, change_type=finished_batch, caller=tests/test_inventory_fifo.py:test_inventory_adjustment_delegates_properly [in /home/runner/workspace/app/services/inventory_adjustment/_core.py:36]
2025-08-21 05:34:12,149 INFO: INITIAL STOCK: Detected item 1 has no FIFO history, using initial_stock handler [in /home/runner/workspace/app/services/inventory_adjustment/_core.py:49]
2025-08-21 05:35:32,563 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:35:32,842 INFO: ADJUST INVENTORY - Item: New Item (ID: 1) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:35:32,843 INFO: Form data received: {'adjustment_type': 'restock', 'quantity': '100.0', 'notes': 'Initial stock'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:36:38,725 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:36:53,984 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:36:55,899 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:36:56,353 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:37:31,438 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:37:35,957 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:37:36,307 INFO: ADJUST INVENTORY - Item: New Item (ID: 1) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:37:36,307 INFO: Form data received: {'change_type': 'restock', 'quantity': '100.0', 'input_unit': 'g', 'cost_entry_type': 'no_change', 'notes': 'Initial stock'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:37:55,335 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:37:57,500 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:37:57,871 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,657 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,757 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,758 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,761 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,763 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,764 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,766 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,767 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:04,793 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:07,274 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:07,312 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:07,371 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:09,936 INFO: ADJUST INVENTORY - Item: Admin Apples (ID: 2) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:38:09,936 INFO: Form data received: {'csrf_token': 'IjNmY2I2MDg5Mzc0Y2YyYWMwMzcyYjRjNGY1ODU1NWU5ODA2OTRlNGYi.aKawvw.Hqo4vCBC7Co6ojBS-fvHiUu7lBo', 'change_type': 'restock', 'quantity': '1', 'input_unit': 'count', 'cost_entry_type': 'no_change', 'cost_per_unit': '3', 'notes': ''} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:38:10,010 INFO: CANONICAL DISPATCHER: item_id=2, quantity=1.0, change_type=restock, caller=app/blueprints/inventory/routes.py:adjust_inventory [in /home/runner/workspace/app/services/inventory_adjustment/_core.py:36]
2025-08-21 05:38:10,019 WARNING: FIFO: History entry created but lot creation failed: (sqlite3.IntegrityError) UNIQUE constraint failed: inventory_lot.fifo_code
[SQL: INSERT INTO inventory_lot (inventory_item_id, remaining_quantity, original_quantity, unit, unit_cost, created_at, received_date, expiration_date, shelf_life_days, source_type, source_notes, created_by, fifo_code, organization_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (2, 1.0, 1.0, 'count', 3.0, '2025-08-21 05:38:10.018892', '2025-08-21 05:38:10.018901', None, None, 'restock', 'Restocked inventory', 2, 'LOT', 1)]
(Background on this error at: https://sqlalche.me/e/20/gkpj) [in /home/runner/workspace/app/services/inventory_adjustment/_fifo_ops.py:116]
2025-08-21 05:38:10,020 ERROR: Error in _internal_add_fifo_entry_enhanced: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: inventory_lot.fifo_code
[SQL: INSERT INTO inventory_lot (inventory_item_id, remaining_quantity, original_quantity, unit, unit_cost, created_at, received_date, expiration_date, shelf_life_days, source_type, source_notes, created_by, fifo_code, organization_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (2, 1.0, 1.0, 'count', 3.0, '2025-08-21 05:38:10.018892', '2025-08-21 05:38:10.018901', None, None, 'restock', 'Restocked inventory', 2, 'LOT', 1)]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a) [in /home/runner/workspace/app/services/inventory_adjustment/_fifo_ops.py:127]
2025-08-21 05:38:10,022 ERROR: Error executing handler for restock on item 2: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: inventory_lot.fifo_code
[SQL: INSERT INTO inventory_lot (inventory_item_id, remaining_quantity, original_quantity, unit, unit_cost, created_at, received_date, expiration_date, shelf_life_days, source_type, source_notes, created_by, fifo_code, organization_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (2, 1.0, 1.0, 'count', 3.0, '2025-08-21 05:38:10.018892', '2025-08-21 05:38:10.018901', None, None, 'restock', 'Restocked inventory', 2, 'LOT', 1)]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a) [in /home/runner/workspace/app/services/inventory_adjustment/_core.py:85]
2025-08-21 05:38:10,088 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:10,107 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:38:10,110 INFO: Getting global unit list [in /home/runner/workspace/app/utils/unit_utils.py:32]
2025-08-21 05:39:34,707 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:39:34,982 INFO: ADJUST INVENTORY - Item: New Item (ID: 1) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:39:34,983 INFO: Form data received: {'change_type': 'restock', 'quantity': '100.0', 'input_unit': 'g', 'cost_entry_type': 'no_change', 'notes': 'Initial stock'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:39:35,137 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:39:35,137 INFO: BatchTrack startup [in /home/runner/workspace/app/utils/unit_utils.py:28]
2025-08-21 05:39:35,950 INFO: ADJUST INVENTORY - Item: Test Item (ID: 1) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:39:35,950 INFO: ADJUST INVENTORY - Item: Test Item (ID: 1) [in /home/runner/workspace/app/blueprints/inventory/routes.py:238]
2025-08-21 05:39:35,951 INFO: Form data received: {'adjustment_type': 'recount', 'quantity': '80', 'notes': 'Physical count adjustment'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:39:35,951 INFO: Form data received: {'adjustment_type': 'recount', 'quantity': '80', 'notes': 'Physical count adjustment'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:239]
2025-08-21 05:39:36,569 INFO: EDIT INVENTORY - Item: Admin Apples (ID: 2) [in /home/runner/workspace/app/blueprints/inventory/routes.py:311]
2025-08-21 05:39:36,570 INFO: Form data received: {'csrf_token': 'IjNmY2I2MDg5Mzc0Y2YyYWMwMzcyYjRjNGY1ODU1NWU5ODA2OTRlNGYi.aKawwg.gPDFJl1AK2dFPUIlz4KIerYDEVM', 'name': 'Admin Apples', 'quantity': '10', 'type': 'ingredient', 'is_perishable': 'on', 'shelf_life_days': '1', 'category_id': '', 'unit': 'count', 'density': '0.0', 'cost_per_unit': '3.0', 'confirm_unit_change': 'false', 'convert_inventory': 'false', 'change_type': 'recount'} [in /home/runner/workspace/app/blueprints/inventory/routes.py:312]
2025-08-21 05:39:36,570 INFO: QUANTITY RECOUNT: Target quantity 10.0 for item Admin Apples [in /home/runner/workspace/app/blueprints/inventory/routes.py:319]
2025-08-21 05:39:36,571 INFO: CANONICAL DISPATCHER: item_id=2, quantity=10.0, change_type=recount, caller=app/blueprints/inventory/routes.py:edit_inventory [in /home/runner/workspace/app/services/inventory_adjustment/_core.py:36]
2025-08-21 05:39:36,575 INFO: RECOUNT: Admin Apples - FIFO total: 0, target: 10.0, delta: 10.0 [in /home/runner/workspace/app/services/inventory_adjustment/_recount_logic.py:23]
2025-08-21 05:39:36,578 INFO: RECOUNT INCREASE: Need 10.0, found 0 existing lots with 0 total capacity [in /home/runner/workspace/app/services/inventory_adjustment/_recount_logic.py:78]
