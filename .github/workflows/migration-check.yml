name: Migration Safety Check
on: [push, pull_request]

jobs:
  migration-check:
    runs-on: ubuntu-latest
    env:
      FLASK_APP: wsgi:app
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt

      - name: Check for migration drift
        run: |
          export DATABASE_URL="sqlite:///test_migrations.db"
          flask db upgrade

          # Generate a test migration (autogenerate will produce no file if no changes)
          flask db migrate -m "test_migration_check" --rev-id test_check

          # Detect drift by presence of generated file
          if ls migrations/versions/*test_check*.py >/dev/null 2>&1; then
            echo "❌ Migration drift detected! Models don't match migrations."
            echo "Run 'flask db migrate' locally and commit the new migration."
            exit 1
          else
            echo "✅ No migration drift detected."
          fi

          rm -f test_migrations.db
          rm -f migrations/versions/*test_check*.py

      - name: Check for multiple heads
        run: |
          export DATABASE_URL="sqlite:///test_heads.db"
          flask db upgrade
          heads_count=$(flask db heads | cat | wc -l)
          if [ "$heads_count" -gt 1 ]; then
            echo "❌ Multiple migration heads detected!"
            flask db heads | cat
            exit 1
          else
            echo "✅ Single migration head confirmed."
          fi
          rm -f test_heads.db
