name: Migration Safety Check
on: [push, pull_request]

jobs:
  migration-check:
    runs-on: ubuntu-latest
    env:
      FLASK_APP: wsgi:app           # make sure this is correct for your app
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt

      - name: Check for migration drift (SQLite)
        run: |
          set -euo pipefail
          export DATABASE_URL="sqlite:///test_migrations.db"

          # Fresh start
          rm -f test_migrations.db
          rm -f migrations/versions/*test_check*.py || true

          # Build schema, then attempt autogenerate
          flask db upgrade
          flask db migrate -m "test_migration_check" --rev-id test_check >/dev/null 2>&1 || true

          # Drift = file exists
          if compgen -G 'migrations/versions/*test_check*.py' > /dev/null; then
            echo "❌ Migration drift detected! Models don't match migrations."
            # Show the diff file for context
            cat migrations/versions/*test_check*.py || true
            exit 1
          fi

          # (Optional) verify downgrade->upgrade cycle works
          flask db downgrade base
          flask db upgrade

          echo "✅ No migration drift detected and downgrade/upgrade cycle OK."
          rm -f test_migrations.db
          rm -f migrations/versions/*test_check*.py || true

      - name: Check for multiple heads
        run: |
          set -euo pipefail
          export DATABASE_URL="sqlite:///test_heads.db"
          rm -f test_heads.db

          flask db upgrade
          heads_count="$(flask db heads | wc -l | xargs)"
          if [ "$heads_count" -gt 1 ]; then
            echo "❌ Multiple migration heads detected!"
            flask db heads || true
            exit 1
          fi

          echo "✅ Single migration head confirmed."
          rm -f test_heads.db
