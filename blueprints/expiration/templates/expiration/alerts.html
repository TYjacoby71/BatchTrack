{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Expiration Management</h2>
        <button class="btn btn-outline-secondary btn-sm" onclick="archiveExpired()">
            <i class="fas fa-archive"></i> Archive Expired Items
        </button>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center" id="ingredients-tab" data-bs-toggle="tab" data-bs-target="#ingredients" type="button" role="tab" aria-controls="ingredients" aria-selected="true">
                Ingredients
                {% if expired.fifo_entries|length + expiring_soon.fifo_entries|length > 0 %}
                <span class="badge bg-danger ms-2">{{ expired.fifo_entries|length + expiring_soon.fifo_entries|length }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                Products
                {% if expired.product_inventory|length + expiring_soon.product_inventory|length > 0 %}
                <span class="badge bg-danger ms-2">{{ expired.product_inventory|length + expiring_soon.product_inventory|length }}</span>
                {% endif %}
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <!-- Ingredients Tab -->
        <div class="tab-pane fade show active" id="ingredients" role="tabpanel" aria-labelledby="ingredients-tab">
            <!-- Summary Cards for Ingredients -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-danger mb-2">{{ expired.fifo_entries|length }}</h3>
                            <p class="card-text text-muted mb-0">Expired Ingredients</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-2">{{ expiring_soon.fifo_entries|length }}</h3>
                            <p class="card-text text-muted mb-0">Expiring Within 7 Days</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expired Ingredients -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Expired Ingredients
                    </h5>
                    {% if expired.fifo_entries %}
                        <span class="badge bg-danger">{{ expired.fifo_entries|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expired.fifo_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ingredient</th>
                                        <th>Quantity</th>
                                        <th>Expired</th>
                                        <th class="text-muted">ID</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expired.fifo_entries %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.remaining_quantity }} {{ item.unit }}</td>
                                        <td>
                                            <small class="text-danger">
                                                {{ item.expiration_date.strftime('%Y-%m-%d') }}
                                            </small>
                                        </td>
                                        <td><small class="text-muted">#{{ item.fifo_id }}</small></td>
                                        <td>
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="markAsSpoiled('fifo', {{ item.fifo_id }})">
                                                <i class="fas fa-trash"></i> Spoiled
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success fa-2x mb-3"></i>
                            <p class="text-muted mb-0">No expired ingredients found!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Expiring Soon Ingredients -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-warning me-2"></i>
                        Expiring Within 7 Days
                    </h5>
                    {% if expiring_soon.fifo_entries %}
                        <span class="badge bg-warning text-dark">{{ expiring_soon.fifo_entries|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expiring_soon.fifo_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ingredient</th>
                                        <th>Quantity</th>
                                        <th>Expires</th>
                                        <th>Days Left</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expiring_soon.fifo_entries %}
                                    {% set days_left = (item.expiration_date.date() - today.date()).days %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.remaining_quantity }} {{ item.unit }}</td>
                                        <td>
                                            <small>{{ item.expiration_date.strftime('%Y-%m-%d') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge {% if days_left <= 2 %}bg-danger{% elif days_left <= 5 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                                {{ days_left }} day{{ 's' if days_left != 1 else '' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success fa-2x mb-3"></i>
                            <p class="text-muted mb-0">No ingredients expiring soon!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
            <!-- Summary Cards for Products -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-danger mb-2">{{ expired.product_inventory|length }}</h3>
                            <p class="card-text text-muted mb-0">Expired Products</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-2">{{ expiring_soon.product_inventory|length }}</h3>
                            <p class="card-text text-muted mb-0">Expiring Within 7 Days</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expired Products -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Expired Products
                    </h5>
                    {% if expired.product_inventory %}
                        <span class="badge bg-danger">{{ expired.product_inventory|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expired.product_inventory %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Variant</th>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                        <th>Expired</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expired.product_inventory %}
                                    <tr>
                                        <td>Product #{{ item.product_id }}</td>
                                        <td>{{ item.variant or 'N/A' }}</td>
                                        <td>{{ item.size_label or 'N/A' }}</td>
                                        <td>{{ item.quantity }} {{ item.unit }}</td>
                                        <td>
                                            <small class="text-danger">
                                                {{ item.expiration_date.strftime('%Y-%m-%d') }}
                                            </small>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="markAsSpoiled('product', {{ item.product_inv_id }})">
                                                <i class="fas fa-trash"></i> Spoiled
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success fa-2x mb-3"></i>
                            <p class="text-muted mb-0">No expired products found!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Expiring Soon Products -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-warning me-2"></i>
                        Products Expiring Within 7 Days
                    </h5>
                    {% if expiring_soon.product_inventory %}
                        <span class="badge bg-warning text-dark">{{ expiring_soon.product_inventory|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expiring_soon.product_inventory %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Variant</th>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                        <th>Expires</th>
                                        <th>Days Left</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expiring_soon.product_inventory %}
                                    {% set days_left = (item.expiration_date.date() - today.date()).days %}
                                    <tr>
                                        <td>Product #{{ item.product_id }}</td>
                                        <td>{{ item.variant or 'N/A' }}</td>
                                        <td>{{ item.size_label or 'N/A' }}</td>
                                        <td>{{ item.quantity }} {{ item.unit }}</td>
                                        <td>
                                            <small>{{ item.expiration_date.strftime('%Y-%m-%d') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge {% if days_left <= 1 %}danger{% elif days_left <= 3 %}warning{% else %}secondary{% endif %}">
                                                {{ days_left }} day{{ 's' if days_left != 1 else '' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success fa-2x mb-3"></i>
                            <p class="text-muted mb-0">No products expiring soon!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function archiveExpired() {
    if (!confirm('Archive all expired items with zero quantity? This cannot be undone.')) return;

    try {
        const response = await fetch('/expiration/api/archive-expired', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() }
        });
        const data = await response.json();

        if (response.ok) {
            alert(`Archived ${data.archived_count} expired items`);
            location.reload();
        } else {
            alert('Error archiving items');
        }
    } catch (error) {
        console.error('Archive error:', error);
        alert('Network error occurred');
    }
}

// Add today variable for template
const today = new Date('{{ today.strftime("%Y-%m-%d") }}');

async function markAsSpoiled(type, id) {
    if (!confirm('Only mark this item as spoiled if you have physically removed it from your inventory to maintain proper count.\n\nThis action will remove it from the system and cannot be undone.\n\nProceed?')) return;

    try {
        const response = await fetch('/expiration/api/mark-spoiled', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() 
            },
            body: JSON.stringify({ type: type, id: id })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Marked ${data.spoiled_count} item as spoiled`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Spoilage error:', error);
        alert('Network error occurred');
    }
}
</script>
{% endblock %}