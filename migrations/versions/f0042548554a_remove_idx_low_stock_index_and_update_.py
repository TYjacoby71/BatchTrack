
"""Remove idx_low_stock index and update constraints for inventory_item_id

Revision ID: f0042548554a
Revises: 45e872336209
Create Date: 2025-07-04 21:00:16.687564

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'f0042548554a'
down_revision = '45e872336209'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('product_sku', schema=None) as batch_op:
        # Remove the old index that references current_quantity (which we're removing)
        try:
            batch_op.drop_index('idx_low_stock')
        except:
            pass  # Index might not exist
        
        # Remove the current_quantity column since we're using inventory_item.quantity now
        try:
            batch_op.drop_column('current_quantity')
        except:
            pass  # Column might not exist
        
        # Remove the reserved_quantity column if it exists
        try:
            batch_op.drop_column('reserved_quantity')
        except:
            pass  # Column might not exist
        
        # Ensure the inventory_item_id column exists and is properly constrained
        try:
            batch_op.add_column(sa.Column('inventory_item_id', sa.Integer(), nullable=False))
        except:
            pass  # Column might already exist
        
        # Ensure the inventory_item_id index exists
        try:
            batch_op.create_index('idx_inventory_item', ['inventory_item_id'], unique=False)
        except:
            pass  # Index might already exist
        
        # Ensure the foreign key constraint exists
        try:
            batch_op.create_foreign_key('fk_product_sku_inventory_item', 'inventory_item', ['inventory_item_id'], ['id'])
        except:
            pass  # Constraint might already exist

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('product_sku', schema=None) as batch_op:
        # Re-add the current_quantity column
        try:
            batch_op.add_column(sa.Column('current_quantity', sa.Float(), nullable=True, default=0.0))
        except:
            pass
        
        # Re-add the reserved_quantity column
        try:
            batch_op.add_column(sa.Column('reserved_quantity', sa.Float(), nullable=True, default=0.0))
        except:
            pass
        
        # Drop the inventory_item index
        try:
            batch_op.drop_index('idx_inventory_item')
        except:
            pass
        
        # Drop the foreign key constraint
        try:
            batch_op.drop_constraint('fk_product_sku_inventory_item', type_='foreignkey')
        except:
            pass
        
        # Re-create the old index (only if current_quantity column exists)
        try:
            batch_op.create_index('idx_low_stock', ['current_quantity', 'low_stock_threshold'], unique=False)
        except:
            pass

    # ### end Alembic commands ###
