
{% extends "layout.html" %}
{% block content %}
<div class="container" x-data="timerManager">
  <h2>Timer Management</h2>

  <!-- Timer Summary -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Active Timers</h5>
          <h3 class="text-primary" x-text="timer_summary.active_count">{{ timer_summary.active_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Expired Timers</h5>
          <h3 class="text-danger" x-text="timer_summary.expired_count">{{ timer_summary.expired_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Completed</h5>
          <h3 class="text-success" x-text="timer_summary.completed_count">{{ timer_summary.completed_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Total Timers</h5>
          <h3 class="text-info" x-text="timer_summary.total_timers">{{ timer_summary.total_timers }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Timer List -->
  <div class="table-responsive">
    <table class="table" x-show="timers.length > 0">
      <thead>
        <tr>
          <th>Batch</th>
          <th>Label</th>
          <th>Duration</th>
          <th>Time Left</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="timer in timers" :key="timer.id">
          <tr>
            <td x-text="timer.batch_id ? `Batch #${timer.batch_id}` : '(Manual)'"></td>
            <td x-text="timer.description || 'Timer'"></td>
            <td x-text="formatDuration(timer.duration_seconds)"></td>
            <td x-text="calculateTimeLeft(timer)"></td>
            <td>
              <span x-text="timer.status" :class="{
                'badge bg-success': timer.status === 'completed',
                'badge bg-primary': timer.status === 'active',
                'badge bg-danger': timer.status === 'expired',
                'badge bg-warning': timer.status === 'paused'
              }"></span>
            </td>
            <td>
              <button 
                x-show="timer.status !== 'completed'"
                @click="completeTimer(timer.id)" 
                class="btn btn-sm btn-success me-1">
                Complete
              </button>
              <button 
                @click="deleteTimer(timer.id)"
                class="btn btn-sm btn-danger">
                Delete
              </button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <div x-show="timers.length === 0" class="alert alert-info">
      No active timers found.
    </div>
  </div>

  <!-- New Timer Form -->
  <div class="mt-4">
    <button 
      x-show="!addingTimer"
      @click="addingTimer = true" 
      class="btn btn-primary">
      Add New Timer
    </button>

    <div x-show="addingTimer" class="card mt-3">
      <div class="card-body">
        <form @submit.prevent="createTimer">
          <div class="mb-3">
            <label class="form-label">Batch</label>
            <select class="form-control" x-model="newTimer.batch_id" required>
              <option value="">Select a batch</option>
              <template x-for="batch in activeBatches" :key="batch.id">
                <option :value="batch.id" x-text="`Batch #${batch.id} - ${batch.recipe_name || 'No Recipe'}`"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Timer Label</label>
            <input type="text" class="form-control" x-model="newTimer.name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Duration (H:M:S)</label>
            <div class="d-flex gap-2">
              <input type="number" class="form-control" x-model="hours" placeholder="H" min="0" max="23">
              <input type="number" class="form-control" x-model="minutes" placeholder="M" min="0" max="59">
              <input type="number" class="form-control" x-model="seconds" placeholder="S" min="0" max="59">
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">Create Timer</button>
            <button type="button" @click="addingTimer = false" class="btn btn-secondary">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('timerManager', () => ({
    timers: {{ active_timers|tojson|safe }},
    activeBatches: {{ active_batches|tojson|safe }},
    timer_summary: {{ timer_summary|tojson|safe }},
    addingTimer: false,
    hours: '',
    minutes: '',
    seconds: '',
    newTimer: {
      name: '',
      batch_id: '',
      duration_seconds: null
    },

    init() {
      this.updateTimers();
    },

    updateTimers() {
      setInterval(() => {
        this.timers = this.timers.map(timer => ({
          ...timer,
          status: timer.status === 'active' && 
                 this.isTimerExpired(timer) ? 'expired' : timer.status
        }));
      }, 1000);
    },

    isTimerExpired(timer) {
      if (!timer.start_time) return false;
      const start = new Date(timer.start_time + 'Z');
      const now = new Date();
      const elapsedSeconds = Math.floor((now - start) / 1000);
      return elapsedSeconds > timer.duration_seconds;
    },

    formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;

      if (hours > 0) {
        return `${hours}h ${minutes}m ${remainingSeconds}s`;
      }
      return `${minutes}m ${remainingSeconds}s`;
    },

    calculateTimeLeft(timer) {
      if (timer.status === 'completed') return 'Completed';
      if (timer.status === 'paused') return 'Paused';
      if (!timer.start_time) return 'Not Started';

      const start = new Date(timer.start_time + 'Z');
      const now = new Date();
      const totalSeconds = parseInt(timer.duration_seconds);
      const elapsedSeconds = Math.floor((now - start) / 1000);
      const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);

      if (remainingSeconds <= 0) {
        return 'Expired';
      }

      return this.formatDuration(remainingSeconds);
    },

    async createTimer() {
      const totalSeconds = (parseInt(this.hours || 0) * 3600) + 
                          (parseInt(this.minutes || 0) * 60) + 
                          parseInt(this.seconds || 0);

      if (totalSeconds < 1) {
        alert('Please enter a valid duration');
        return;
      }

      try {
        const response = await fetch('/timers/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            name: this.newTimer.name,
            batch_id: this.newTimer.batch_id,
            duration_seconds: totalSeconds
          })
        });

        const result = await response.json();
        if (result.status === 'success') {
          location.reload();
        } else {
          alert('Failed to create timer');
        }
      } catch (error) {
        alert('Error creating timer: ' + error.message);
      }
    },

    async deleteTimer(timerId) {
      if (!confirm('Are you sure you want to delete this timer?')) return;

      try {
        const response = await fetch(`/timers/delete/${timerId}`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
          }
        });

        if (response.ok) {
          this.timers = this.timers.filter(timer => timer.id !== timerId);
          this.timer_summary.total_timers--;
          this.timer_summary.active_count--;
        }
      } catch (error) {
        alert('Error deleting timer: ' + error.message);
      }
    },

    async completeTimer(timerId) {
      try {
        const response = await fetch(`/timers/complete/${timerId}`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
          }
        });

        if (response.ok) {
          const result = await response.json();
          this.timers = this.timers.map(timer => 
            timer.id === timerId ? {
              ...timer,
              status: 'completed',
              end_time: result.end_time
            } : timer
          );
          this.timer_summary.active_count--;
          this.timer_summary.completed_count++;
        }
      } catch (error) {
        alert('Error completing timer: ' + error.message);
      }
    }
  }));
});
</script>
{% endblock %}
