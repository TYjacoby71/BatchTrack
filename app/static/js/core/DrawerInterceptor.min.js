import{appCache}from'./CacheManager.js';(function(){if(window.__drawerInterceptorInstalled)return;window.__drawerInterceptorInstalled=true;const originalFetch=window.fetch.bind(window);const activeCorrelations=new Set();window.fetch=async function(input,init){const response=await originalFetch(input,init);try{const clone=response.clone();const contentType=clone.headers.get('content-type')||'';if(!contentType.includes('application/json')){return response;}
const data=await clone.json();const payload=data&&(data.drawer_payload||(data.data&&data.data.drawer_payload));const requestUrl=typeof input==='string'?input:input.url;if(payload&&window.drawerProtocol){const correlationId=payload.correlation_id||`${payload.error_type || 'generic'}:${payload.error_code || 'unknown'}`;const cacheKey=`drawer:${payload.error_type}:${payload.error_code}:${payload.modal_url}`;const cached=appCache.get(cacheKey);if(cached){return response;}
if(!activeCorrelations.has(correlationId)){activeCorrelations.add(correlationId);appCache.set(cacheKey,true,30000);const detail={...payload,retry_callback:payload.retry_callback||null};window.dispatchEvent(new CustomEvent('openDrawer',{detail}));setTimeout(()=>{activeCorrelations.delete(correlationId);appCache.delete(cacheKey);},60_000);}}}catch(e){console.warn('DrawerInterceptor: failed to inspect response',e);}
return response;};})();
