!function(t){"use strict";const e=t.SoapTool=t.SoapTool||{},{round:a,toNumber:i}=e.helpers,{formatWeight:l,formatPercent:r}=e.units,o=e.state,s={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function n(t,e){const a=document.getElementById(t);a&&(a.textContent=e)}e.runnerRender={applyServiceResult:function({serviceResult:t,validation:u,selection:c,superfat:d,purity:p,waterMethod:y,waterPct:w,lyeConcentrationInput:_,waterRatioInput:g,showAlerts:m}){const f=t.lye_type||c.lyeType||"NaOH",h=i(t.total_oils_g)||u.totals.totalWeight,O=i(t.superfat_pct),v=isFinite(O)?O:d,C={sapAvg:i(t.sap_avg_koh),usedFallback:!!t.used_sap_fallback},A=i(t.lye_pure_g),b=i(t.lye_adjusted_g),S=i(t.lye_purity_pct)||p,G=t.water_method||y,R=i(t.water_pct)||w,P=i(t.lye_concentration_input_pct)||_,j=i(t.water_ratio_input)||g,k={waterG:i(t.water_g),lyeConcentration:i(t.lye_concentration_pct),waterRatio:i(t.water_lye_ratio)},I=t.results_card||{},M=t.quality_report||{},W=(t.oils||u.oils||[]).map(t=>({name:t.name||null,grams:i(t.grams),sapKoh:i(t.sap_koh??t.sapKoh),iodine:i(t.iodine),fattyProfile:t.fatty_profile||t.fattyProfile||null,global_item_id:t.global_item_id||null,default_unit:t.default_unit||null,ingredient_category_name:t.ingredient_category_name||null})),D={waterG:k.waterG,lyeAdjusted:b,totalOils:h,waterMethod:G,waterPct:R,lyeConcentrationInput:P,waterRatioInput:j,lyeConcentration:k.lyeConcentration,waterRatio:k.waterRatio};e.runnerInputs.updateStageWaterSummary(D),e.runnerInputs.updateLiveCalculationPreview(D);const E=t.additives||s;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(E);const F=i(I.batch_yield_g)||h+b+k.waterG+E.fragranceG+E.lactateG+E.sugarG+E.saltG+E.citricG;return e.mold?.updateWetBatterWarning&&e.mold.updateWetBatterWarning(F),function({resultsCard:t,lyeAdjusted:o,waterData:s,batchYield:u,totalOils:c,superfat:d}){const p=document.getElementById("resultsCard");p&&(p.style.display="block");const y=i(t.water_lye_ratio)||s.waterRatio;n("lyeAdjustedOutput",l(i(t.lye_adjusted_g)||o)),n("waterOutput",l(i(t.water_g)||s.waterG)),n("batchYieldOutput",l(u)),n("lyeConcentrationOutput",r(i(t.lye_concentration_pct)||s.lyeConcentration)),n("waterRatioOutput",isFinite(y)&&y>0?a(y,2).toString():"--"),n("totalOilsOutput",l(c)),n("superfatOutput",r(d)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(t=>e.ui.pulseValue(document.getElementById(t)))}({resultsCard:I,lyeAdjusted:b,waterData:k,batchYield:F,totalOils:h,superfat:v}),e.ui.updateResultsWarnings(k),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:M.qualities||{},fattyPercent:M.fatty_acids_pct||{},coveragePct:i(M.coverage_pct),iodine:i(M.iodine),ins:i(M.ins),sapAvg:C.sapAvg,superfat:v,waterData:k,additives:E,oils:W,totalOils:h,warnings:M.warnings||[]}),e.additives.updateVisualGuidance({tips:M.visual_guidance||[]}),e.stages.updateStageStatuses(),function({showAlerts:t,lyeTotals:i,purity:l,waterData:r}){if(!t)return;i.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),l<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${a(l,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(r.lyeConcentration<25||r.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});const o=e.mold.getMoldSettings();"cylinder"===o.shape&&o.waterWeight>0&&!o.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}({showAlerts:m,lyeTotals:C,purity:S,waterData:k}),o.lastCalc={totalOils:h,oils:W,lyeType:f,superfat:v,purity:S,lyePure:A,lyeAdjusted:b,water:k.waterG,waterMethod:G,waterPct:R,lyeConcentration:k.lyeConcentration,waterRatio:k.waterRatio,sapAvg:C.sapAvg,usedSapFallback:C.usedFallback,additives:E,batchYield:F,qualityReport:M,export:t.export||null},o.lastCalc}}}(window);