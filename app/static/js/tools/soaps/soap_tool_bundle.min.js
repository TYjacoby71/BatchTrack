(()=>{(function(R){"use strict";let e={inventory:"Inventory",global:"Global Library"},d={inventory:"bg-primary",global:"bg-info text-dark"},v={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function N(r,g){let i;return function(){let h=arguments;clearTimeout(i),i=setTimeout(()=>r.apply(null,h),g)}}function z(r){return(r||"").trim().toLowerCase()}function $(r){if(r)return r;let g=document.createElement("div");return g.className="list-group position-absolute w-100 d-none inventory-suggestions",g.style.zIndex="1050",g.style.maxHeight="300px",g.style.overflowY="auto",g}function G(r){return typeof r=="function"?r():r}function C(r){let g=new Set;return(r||[]).forEach(i=>{let h=i&&(i.global_item_id||i.id);h&&g.add(String(h))}),g}function B(r){if(!r)return"";let g=e[r]||r;return`<span class="badge ${d[r]||"bg-secondary"} ms-2">${g}</span>`}function P(r,g,i,h){h=h||{},r.innerHTML="";let c=!1;if(g.forEach(m=>{!m.items||!m.items.length||(c=!0,m.items.forEach(s=>{let A=document.createElement("a");A.href="#",A.className="list-group-item list-group-item-action suggestion-item";let p=h.showSubtitle&&s.subtitle?`<div class="small text-muted mt-1">${s.subtitle}</div>`:"";A.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${s.text||s.display_name||s.name||""}</span>
          ${h.showSourceBadge?B(m.source||s.source):""}
        </div>${p}`,A.addEventListener("click",function(t){t.preventDefault(),i(s,m.source||s.source),r.classList.add("d-none")}),r.appendChild(A)}))}),r.classList.toggle("d-none",!c),!c&&r.dataset.emptyMessage){let m=document.createElement("div");m.className="list-group-item text-muted small",m.textContent=r.dataset.emptyMessage,r.appendChild(m),r.classList.remove("d-none")}}function E(r,g,i){r.innerHTML="";let h=!1;g.forEach(c=>{if(!c.ingredients||!c.ingredients.length)return;h=!0;let m=document.createElement("div");m.className="list-group-item text-muted small fw-semibold",m.textContent=c.title,r.appendChild(m),c.ingredients.forEach(s=>{let A=document.createElement("div");A.className="list-group-item ingredient-result";let p=document.createElement("div");p.className="d-flex justify-content-between align-items-center ingredient-summary",p.setAttribute("role","button"),p.setAttribute("tabindex","0"),p.innerHTML=`<span class="fw-semibold">${s.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${s.forms.length} option${s.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",s.forms.forEach(_=>{let k=document.createElement("button");k.type="button",k.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",k.innerHTML=`<div class="fw-semibold">${_.text||_.display_name||_.name||"Form"}</div>`,k.addEventListener("click",function(){i(_,_.source||c.source),r.classList.add("d-none")}),t.appendChild(k)});function S(_){_.type==="keydown"&&_.key!=="Enter"&&_.key!==" "||(_.preventDefault(),t.classList.toggle("d-none"))}p.addEventListener("click",S),p.addEventListener("keydown",S),A.appendChild(p),A.appendChild(t),r.appendChild(A),s.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!h)}function F(r,g,i){r.innerHTML="";let h=!1;if((g||[]).forEach(c=>{h=!0;let m=document.createElement("a");m.href="#",m.className="list-group-item list-group-item-action suggestion-item";let s=c.inci_name?`<div class="small text-muted">${c.inci_name}</div>`:"";m.innerHTML=`<div class="fw-semibold">${c.text||c.name}</div>${s}`,m.addEventListener("click",function(A){A.preventDefault(),i(c,"definition"),r.classList.add("d-none")}),r.appendChild(m)}),r.classList.toggle("d-none",!h),!h&&r.dataset.emptyMessage){let c=document.createElement("div");c.className="list-group-item text-muted small",c.textContent=r.dataset.emptyMessage,r.appendChild(c),r.classList.remove("d-none")}}function o(r){let g=[];return(r||[]).forEach(i=>{if(i&&Array.isArray(i.forms)&&i.forms.length){let h=i.ingredient&&i.ingredient.name||i.ingredient_name||null,c=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null,m=i.category_tags||[];i.forms.forEach(s=>{var t,S,_,k,w,W,D,U,u,I;let A=s.physical_form||{},p=s.display_name||s.text||s.name||(h&&s.physical_form_name?`${h}, ${s.physical_form_name}`:i.display_name||i.text||i.name||"");g.push({id:s.id,text:p,item_type:s.item_type||i.item_type,default_unit:s.default_unit||s.unit||i.default_unit||i.unit||null,source:"global",global_item_id:s.id,ingredient_id:s.ingredient_id||i.ingredient&&i.ingredient.id||i.ingredient_id||null,ingredient_name:s.ingredient_name||h,physical_form_id:s.physical_form_id||A&&A.id||null,physical_form_name:s.physical_form_name||A&&A.name||null,ingredient_category_name:c,category_tags:m,density:s.density||i.density||null,capacity:s.capacity||i.capacity||null,capacity_unit:s.capacity_unit||i.capacity_unit||null,container_material:s.container_material||i.container_material||null,container_type:s.container_type||i.container_type||null,container_style:s.container_style||i.container_style||null,container_color:s.container_color||i.container_color||null,default_is_perishable:(t=s.default_is_perishable)!=null?t:i.default_is_perishable,recommended_shelf_life_days:(S=s.recommended_shelf_life_days)!=null?S:i.recommended_shelf_life_days,saponification_value:(k=(_=s.saponification_value)!=null?_:i.saponification_value)!=null?k:null,iodine_value:(W=(w=s.iodine_value)!=null?w:i.iodine_value)!=null?W:null,fatty_acid_profile:(U=(D=s.fatty_acid_profile)!=null?D:i.fatty_acid_profile)!=null?U:null,melting_point_c:(I=(u=s.melting_point_c)!=null?u:i.melting_point_c)!=null?I:null})})}else if(i){let h=i.display_name||i.text||i.name||"",c=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null;g.push({id:i.id,text:h,source:"global",item_type:i.item_type,global_item_id:i.id,ingredient_name:i.ingredient&&i.ingredient.name||i.ingredient_name||i.name,ingredient_category_name:c,category_tags:i.category_tags||[],physical_form_name:i.physical_form&&i.physical_form.name||i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,density:i.density||null,capacity:i.capacity||null,capacity_unit:i.capacity_unit||null,container_material:i.container_material||null,container_type:i.container_type||null,container_style:i.container_style||null,container_color:i.container_color||null,default_is_perishable:i.default_is_perishable,recommended_shelf_life_days:i.recommended_shelf_life_days,saponification_value:i.saponification_value||null,iodine_value:i.iodine_value||null,fatty_acid_profile:i.fatty_acid_profile||null,melting_point_c:i.melting_point_c||null})}}),g}function T(r){let g=new Map;return(r||[]).forEach(i=>{let h=i.ingredient_name||i.text||i.name||"",c=i.ingredient_id?`id:${i.ingredient_id}`:`name:${z(h)}`,m=g.get(c)||{ingredient_id:i.ingredient_id||null,name:h,forms:[]};m.forms.push({id:i.id,text:i.text||h,ingredient_name:h,physical_form_name:i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,source:"inventory",global_item_id:i.global_item_id||null}),g.set(c,m)}),Array.from(g.values())}function f(r,g){let i=[];return(r||[]).forEach(h=>{let c=(h.forms||[]).map(s=>({id:s.id,text:s.name||s.display_name||s.text,ingredient_name:s.ingredient_name||h.name||h.ingredient&&h.ingredient.name||"Ingredient",physical_form_name:s.physical_form_name||null,default_unit:s.default_unit||s.unit||null,source:"global",global_item_id:s.id,density:s.density||null,capacity:s.capacity||null,capacity_unit:s.capacity_unit||null,container_material:s.container_material||null,container_type:s.container_type||null,container_style:s.container_style||null,container_color:s.container_color||null,saponification_value:s.saponification_value||null,iodine_value:s.iodine_value||null,fatty_acid_profile:s.fatty_acid_profile||null,melting_point_c:s.melting_point_c||null})),m=g?c.filter(s=>!s.global_item_id||!g.has(String(s.global_item_id))):c;m.length&&i.push({ingredient_id:h.ingredient_id||h.id||null,name:h.name||h.ingredient&&h.ingredient.name||c[0]&&c[0].ingredient_name||"Ingredient",forms:m})}),i}function a(r){let g=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${g.toString()}`).then(i=>i.json()).catch(()=>({results:[]}))}function n(r){let g={...v,...r},i=g.inputEl,h=g.invHiddenEl,c=g.giHiddenEl,m=$(g.listEl),s=g.mode||"recipe",A=g.searchType||"ingredient",p=g.includeInventory,t=g.includeGlobal,S=g.ingredientFirst,_=g.displayVariant,k=typeof g.resultFilter=="function"?g.resultFilter:null,w=typeof g.onSelection=="function"?g.onSelection:null,W=g.globalUrlBuilder;if(!i||!h&&s==="recipe"||!c&&g.requireHidden!==!1)return;m&&!m.classList.contains("list-group")&&m.classList.add("list-group"),!m.parentNode&&i.parentNode&&i.parentNode.appendChild(m);function D(b,L){let O=new URLSearchParams({q:b});return L&&L!=="all"&&O.set("type",L),`/inventory/api/search?${O.toString()}`}function U(b,L,O){if(typeof W=="function")return W(b,L,O);let x=new URLSearchParams({q:b});return L&&L!=="all"&&x.set("type",L),L==="ingredient"&&O&&x.set("group","ingredient"),`${s==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${x.toString()}`}let u=N(function(){let b=(i.value||"").trim();if(!b){m.classList.add("d-none"),m.innerHTML="",h&&(h.value=""),c&&(c.value="");return}let L=(G(A)||"ingredient").toLowerCase(),O=G(p),x=G(t),H=L==="ingredient"&&!!G(S),K=_||(H?"grouped":"compact");if(L==="ingredient_definition"||L==="definition"){a(b).then(M=>{let J=M&&M.results||[];F(m,J.map(Z=>({id:Z.id,text:Z.name,name:Z.name,inci_name:Z.inci_name,slug:Z.slug,ingredient_category_id:Z.ingredient_category_id,ingredient_category_name:Z.ingredient_category_name})),I)}).catch(()=>m.classList.add("d-none"));return}let Q=O!==!1?fetch(D(b,L)).then(M=>M.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),j=x!==!1?fetch(U(b,L,H)).then(M=>M.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([Q,j]).then(M=>{let J=M[0]&&M[0].results||[],Z=M[1]&&M[1].results||[],ne=k?J.filter(ie=>k(ie,"inventory")):J,oe=k?Z.filter(ie=>k(ie,"global")):Z,me=C(ne),fe=o(oe).filter(ie=>!ie.global_item_id||!me.has(String(ie.global_item_id))).filter(ie=>k?k(ie,"global"):!0);if(H){let ie=T(ne),ye=f(oe,me),he=[];ie.length&&he.push({title:"Your Inventory",source:"inventory",ingredients:ie}),ye.length&&he.push({title:"Global Library",source:"global",ingredients:ye}),E(m,he,I);return}let se=[];ne.length&&se.push({title:"Your Inventory",source:"inventory",items:ne}),fe.length&&se.push({title:"Global Library",source:"global",items:fe}),P(m,se,I,{showSourceBadge:g.showSourceBadge!==!1,showSubtitle:K==="detailed"})}).catch(()=>{m.classList.add("d-none")})},200);function I(b,L){i.value=b.text||b.display_name||b.name||"",L==="inventory"?(h&&(h.value=b.id_numeric||b.id||""),c&&(c.value=b.global_item_id||"")):(c&&(c.value=b.global_item_id||b.id||""),h&&(h.value="")),typeof w=="function"&&w(b,L)}i.addEventListener("input",function(){h&&(h.value=""),c&&(c.value=""),u()}),document.addEventListener("click",function(b){!m.contains(b.target)&&!i.contains(b.target)&&m.classList.add("d-none")})}R.attachMergedInventoryGlobalTypeahead=n,R.renderInventoryTypeaheadList=P})(window);(function(R){"use strict";function e(d,v){var N=v&&v.context||"public",z=v&&v.unitOptionsHtml||"",$=v&&v.mode||(N==="public"?"public":"recipe"),G=document.createElement("div");G.className="row g-2 align-items-end mb-2",G.innerHTML=['<div class="col-md-6">','  <label class="form-label">',d==="container"?"Container":d==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',d==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',d==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',z,"  </select>","</div>",'<div class="col-md-3 ',d!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var C=G.querySelector(".tool-typeahead"),B=G.querySelector(".tool-gi-id"),P=G.querySelector('[data-role="suggestions"]');if(typeof R.attachMergedInventoryGlobalTypeahead=="function"){let E=d==="container"?"container":d==="consumable"?"consumable":"ingredient",F=N!=="public";R.attachMergedInventoryGlobalTypeahead({inputEl:C,giHiddenEl:B,listEl:P,mode:$,context:N,ingredientFirst:d==="ingredient",searchType:E,includeInventory:F,includeGlobal:!0})}return G.querySelector(".tool-remove").addEventListener("click",function(){G.remove()}),G}R.buildToolLineRow=e})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};e.config={unitOptionsHtml:R.soapToolConfig&&R.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(R.SOAP_CALC_LIMIT)?R.SOAP_CALC_LIMIT:null,calcTier:R.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(R.soapToolConfig&&R.soapToolConfig.useCsvPrimary),isAuthenticated:R.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:d,toNumber:v,clamp:N,formatTime:z,getStorage:$,buildSoapcalcSearchBuilder:G};function d(C,B=3){if(!isFinite(C))return 0;let P=Math.pow(10,B);return Math.round(C*P)/P}function v(C){let B=C;typeof B=="string"&&(B=B.replace(/,/g,"").trim());let P=parseFloat(B);return isFinite(P)?P:0}function N(C,B,P){return!isFinite(C)||C<B?B:P!=null&&C>P?P:C}function z(C){return C?`Saved ${new Date(C).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function $(){try{return R.localStorage}catch{return null}}function G(){let C=(P,E,F)=>{let o=new URLSearchParams({q:P});return E&&E!=="all"&&o.set("type",E),E==="ingredient"&&F&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},B=(P,E,F)=>{let o=new URLSearchParams({q:P});return F&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?B:C}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},v={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},N={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},z=[41,70],$=100,G=[136,170],C=250,B={hardness:(d.hardness[0]+d.hardness[1])/2,cleansing:(d.cleansing[0]+d.cleansing[1])/2,conditioning:(d.conditioning[0]+d.conditioning[1])/2,bubbly:(d.bubbly[0]+d.bubbly[1])/2,creamy:(d.creamy[0]+d.creamy[1])/2},P={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},E={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},F=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],T={g:1,oz:28.3495,lb:453.592},f=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),g=new Set(["Sugars & Syrups"]),i=new Set(["Salts & Minerals"]),h=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:d,QUALITY_HINTS:v,QUALITY_FEEL_HINTS:N,IODINE_RANGE:z,IODINE_SCALE_MAX:$,INS_RANGE:G,INS_SCALE_MAX:C,QUALITY_BASE:B,QUALITY_PRESETS:P,FATTY_BAR_COLORS:E,FATTY_DISPLAY_KEYS:F,OIL_TIP_RULES:o,UNIT_FACTORS:T,STAGE_CONFIGS:f,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:g,SALT_CATEGORY_SET:i,CITRIC_CATEGORY_SET:h}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d}=e.helpers;function v(G){let C=0,B=0;return G.forEach(P=>{P.iodine>0&&(C+=P.grams,B+=P.iodine*P.grams)}),{iodine:C>0?B/C:0,coverageWeight:C}}function N(G){let C={},B=0;G.forEach(E=>{!E.fattyProfile||typeof E.fattyProfile!="object"||(B+=E.grams,Object.entries(E.fattyProfile).forEach(([F,o])=>{let T=d(o);T>0&&(C[F]=(C[F]||0)+E.grams*(T/100))}))});let P={};return B>0&&Object.entries(C).forEach(([E,F])=>{P[E]=F/B*100}),{percent:P,coveredWeight:B}}function z(G){let C=B=>G[B]||0;return{hardness:C("lauric")+C("myristic")+C("palmitic")+C("stearic"),cleansing:C("lauric")+C("myristic"),conditioning:C("oleic")+C("linoleic")+C("linolenic")+C("ricinoleic"),bubbly:C("lauric")+C("myristic")+C("ricinoleic"),creamy:C("palmitic")+C("stearic")+C("ricinoleic")}}function $(G){if(!G||typeof G!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let C={lauric:d(G.lauric),myristic:d(G.myristic),palmitic:d(G.palmitic),stearic:d(G.stearic),ricinoleic:d(G.ricinoleic),oleic:d(G.oleic),linoleic:d(G.linoleic),linolenic:d(G.linolenic)},B=z(C);return{hardness:(B.hardness||0)/100,cleansing:(B.cleansing||0)/100,conditioning:(B.conditioning||0)/100,bubbly:(B.bubbly||0)/100,creamy:(B.creamy||0)/100}}e.calc={computeIodine:v,computeFattyAcids:N,computeQualities:z,computeOilQualityScores:$},R.SoapCalcService=e.calc})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:N}=e.helpers,{UNIT_FACTORS:z}=e.constants,$=e.state;function G(o){return N(v(o),0)*(z[$.currentUnit]||1)}function C(o){return N(o,0)/(z[$.currentUnit]||1)}function B(o){return!isFinite(o)||o<=0?"--":`${d(C(o),2)} ${$.currentUnit}`}function P(o){return isFinite(o)?`${d(o,1)}%`:"--"}function E(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=$.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=$.currentUnit})}function F(o,T={}){if(!o)return;if(o===$.currentUnit){E();return}let f=$.currentUnit;if($.currentUnit=o,E(),T.skipConvert)return;let a=(z[f]||1)/(z[o]||1);document.querySelectorAll(".oil-grams").forEach(g=>{let i=v(g.value);i>0&&(g.value=d(i*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(g=>{let i=v(g.value);i>0&&(g.value=d(i*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let g=v(n.value);g>0&&(n.value=d(g*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let g=v(r.value);g>0&&(r.value=d(g*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),T.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:G,fromGrams:C,formatWeight:B,formatPercent:P,updateUnitLabels:E,setUnit:F}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state,v={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function N(f){f&&(f.classList.remove("soap-number-pulse"),f.offsetWidth,f.classList.add("soap-number-pulse"))}function z(f){var n;let a=document.getElementById(f);return!a||!((n=R.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function $(){let f=Date.now();if(f-d.lastSaveToastAt<3500)return;d.lastSaveToastAt=f;let a=z("soapAutosaveToast");a&&a.show()}function G(f){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=f||"Oil removed.");let r=z("soapUndoToast");r&&r.show()}function C(){let f=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");f&&f.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function B(f){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let r=(f==null?void 0:f.lyeConcentration)||0,g="";r>40&&(g="High concentration"),r>0&&r<25&&(g="Low concentration"),a.textContent=g,a.classList.toggle("d-none",!g)}if(n){let r=(f==null?void 0:f.waterRatio)||0,g="";r>0&&r<1.8&&(g="Low water"),r>2.7&&(g="High water"),n.textContent=g,n.classList.toggle("d-none",!g)}}function P(){document.querySelectorAll("#soapToolPage .form-text").forEach(f=>{let a=f.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function E(f){if(!f||f.type!=="number")return;let a=f.value;if(a===""){f.classList.remove("is-invalid");return}let n=parseFloat(a),r=f.getAttribute("min"),g=f.getAttribute("max"),i=r!==null&&r!==""&&n<parseFloat(r),h=g!==null&&g!==""&&n>parseFloat(g);f.classList.toggle("is-invalid",!isFinite(n)||i||h)}function F(f){var n;if(!f)return;let a=((n=f.querySelector)==null?void 0:n.call(f,".soap-stage-card"))||f;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function o(f,a,n={}){var h;let r=document.getElementById("soapAlertStack");if(!r)return;let g=v[f]||v.info,i=document.createElement("div");i.className=`alert alert-${f} d-flex align-items-start gap-2`,i.innerHTML=`
      <i class="fas ${g} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((h=i.querySelector('[data-role="dismiss"]'))==null||h.addEventListener("click",()=>i.remove())),r.prepend(i),n.persist||setTimeout(()=>{i.parentNode&&i.remove()},n.timeoutMs||4500)}function T(){let f=document.getElementById("soapAlertStack");f&&f.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:N,getToastInstance:z,showAutosaveToast:$,showUndoToast:G,updateResultsMeta:C,updateResultsWarnings:B,applyHelperVisibility:P,validateNumericField:E,flashStage:F,showSoapAlert:o,clearSoapAlerts:T}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function d(){let N=document.getElementById("soapStagePane"),z=document.getElementById("soapQualityCard");if(!N||!z)return;if(!R.matchMedia("(min-width: 768px)").matches){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}let G=z.offsetHeight;if(!G){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}N.style.setProperty("--soap-stage-height",`${G}px`),N.classList.add("is-height-synced")}let v=()=>{R.requestAnimationFrame(d)};e.layout={syncStageHeight:d,scheduleStageHeightSync:v}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{clamp:d,toNumber:v,round:N}=e.helpers,{toGrams:z,fromGrams:$}=e.units;function G(){let o=E(),T=document.getElementById("oilTotalTarget"),f=document.getElementById("oilTargetHint");T&&o.effectiveCapacity>0&&z(T.value)<=0&&(T.value=o.targetOils>0?N($(o.targetOils),2):""),f&&(o.effectiveCapacity>0?f.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":f.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?n=`Cylinder correction applied (${N(o.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}C()}function C(o=null){var s;let T=document.getElementById("moldWetBatterWarning");if(!T)return;let f=()=>{T.classList.add("d-none"),T.textContent=""},a=E(),n=e.state||{},r=n.lastCalc||null,g=(s=e.oils)!=null&&s.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,i=v(r==null?void 0:r.totalOils),h=v(o);if((!isFinite(h)||h<=0)&&(h=v(r==null?void 0:r.batchYield)),o==null&&i>0&&g>0&&Math.abs(i-g)>.01){f();return}if(!isFinite(h)||h<=0||a.effectiveCapacity<=0){f();return}let c=h-a.effectiveCapacity;if(c<=.01){f();return}let m=n.currentUnit||"g";T.textContent=`Full wet batter is ${N($(h),2)} ${m}, exceeding mold capacity ${N($(a.effectiveCapacity),2)} ${m} by ${N($(c),2)} ${m}. Reduce oils target/% of mold or lower water/additives.`,T.classList.remove("d-none")}function B(){let o=document.getElementById("oilTotalTarget"),T=E();return o&&(T.effectiveCapacity>0&&(o.value=T.targetOils>0?N($(T.targetOils),2):""),G()),T}function P(){let o=document.getElementById("oilTotalTarget"),T=document.getElementById("moldOilPct");if(!o||!T){let n=E();return G(),n}let f=E();if(f.effectiveCapacity>0){let n=z(o.value),r=d(n,0,f.effectiveCapacity);n>f.effectiveCapacity+.01&&(o.value=N($(r),2));let g=r>0?r/f.effectiveCapacity*100:0;T.value=r>0?N(g,2):""}let a=E();return G(),a}function E(){var i,h,c;let o=z(document.getElementById("moldWaterWeight").value),T=d(v(document.getElementById("moldOilPct").value),0,100),f=((i=document.getElementById("moldShape"))==null?void 0:i.value)||"loaf",a=!!((h=document.getElementById("moldCylinderCorrection"))!=null&&h.checked),n=d(v((c=document.getElementById("moldCylinderFactor"))==null?void 0:c.value),.5,1),r=o>0?o*(a?n:1):0,g=r>0?r*(T/100):0;return{waterWeight:o,oilPct:T,shape:f,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:g}}function F(){var f;let o=((f=document.getElementById("moldShape"))==null?void 0:f.value)||"loaf",T=document.getElementById("moldCylinderOptions");T&&T.classList.toggle("d-none",o!=="cylinder"),G()}e.mold={updateMoldSuggested:G,updateWetBatterWarning:C,syncTargetFromMold:B,syncMoldPctFromTarget:P,getMoldSettings:E,updateMoldShapeUI:F}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{toGrams:$,fromGrams:G}=e.units,{OIL_CATEGORY_SET:C,OIL_TIP_RULES:B}=e.constants,{computeQualities:P}=e.calc,E=e.state;function F(u){let I=u.querySelector(".oil-typeahead"),b=u.querySelector(".oil-sap-koh"),L=u.querySelector(".oil-iodine"),O=u.querySelector(".oil-fatty"),x=u.querySelector(".oil-gi-id"),H=u.querySelector(".oil-default-unit"),K=u.querySelector(".oil-category"),Q=u.querySelector('[data-role="suggestions"]');if(!I||!Q||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let j=z();R.attachMergedInventoryGlobalTypeahead({inputEl:I,listEl:Q,mode:"public",giHiddenEl:x,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:j,searchType:"ingredient",resultFilter:(M,J)=>D(M,C,J),requireHidden:!1,onSelection:function(M){b&&(b.value=(M==null?void 0:M.saponification_value)||""),L&&(L.value=(M==null?void 0:M.iodine_value)||""),O&&(O.value=M!=null&&M.fatty_acid_profile?JSON.stringify(M.fatty_acid_profile):""),H&&(H.value=(M==null?void 0:M.default_unit)||""),K&&(K.value=(M==null?void 0:M.ingredient_category_name)||""),t(M),m(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),I.addEventListener("input",function(){this.value.trim()||(b&&(b.value=""),L&&(L.value=""),O&&(O.value=""),x&&(x.value=""),H&&(H.value=""),K&&(K.value=""),_())})}function o(){var b,L;let u=document.getElementById("oilRowTemplate"),I=(L=(b=u==null?void 0:u.content)==null?void 0:b.querySelector(".oil-row"))==null?void 0:L.cloneNode(!0);return I?(I.querySelectorAll("input").forEach(O=>{O.value=""}),I.querySelectorAll(".form-text").forEach(O=>{let x=O.closest('.soap-field-stack, [class*="col-"]');x&&x.classList.add("soap-field")}),F(I),I.querySelectorAll(".unit-suffix").forEach(O=>{O.dataset.suffix=E.currentUnit}),I):document.createElement("div")}function T(){let u=document.getElementById("oilTotalTarget"),I=$(u==null?void 0:u.value);if(I>0)return I;let b=e.mold.getMoldSettings();return b.targetOils>0?b.targetOils:0}function f(u){let I=[];return u.forEach(L=>{var H,K;let O=$((H=L.querySelector(".oil-grams"))==null?void 0:H.value),x=N(v((K=L.querySelector(".oil-percent"))==null?void 0:K.value),0);O>0&&x>0&&I.push(O/(x/100))}),I.length?I.reduce((L,O)=>L+O,0)/I.length:0}function a(u,I){if(!u||!I||I<=0)return{allowedGrams:null,allowedPct:null};let b=Array.from(document.querySelectorAll("#oilRows .oil-row")),L=b.reduce((j,M)=>{var J;return M===u?j:j+$((J=M.querySelector(".oil-grams"))==null?void 0:J.value)},0),O=b.reduce((j,M)=>{var J;return M===u?j:j+N(v((J=M.querySelector(".oil-percent"))==null?void 0:J.value),0)},0),x=Math.max(0,100-O),H=Math.max(0,I-L),K=I*x/100;return{allowedGrams:Math.max(0,Math.min(H,K)),allowedPct:x}}function n(u,I,b){if(!u)return;let L=u.querySelector(`[data-role="oil-${I}-hint"]`);L&&(b?(L.textContent=b,L.classList.add("is-visible")):(L.textContent="",L.classList.remove("is-visible")))}function r(u){u&&(u.classList.remove("oil-input-bounce"),u.offsetWidth,u.classList.add("oil-input-bounce"))}function g(u,I,b={}){let L=T();if(!u||!L||L<=0){n(u,I,"");return}let O=u.querySelector(".oil-grams"),x=u.querySelector(".oil-percent"),H=a(u,L);if(I==="grams"&&O){let K=$(O.value),Q="";if(K>L+.01?Q="Entry exceeds the max oils allowed in stage 2.":H.allowedGrams!==null&&K>H.allowedGrams+.01&&(Q=`Must be under ${d(G(H.allowedGrams),2)} ${E.currentUnit} to stay within the stage 2 oil limit.`),Q){let j=H.allowedGrams!==null?d(G(H.allowedGrams),2):d(G(L),2);O.value=j>0?j:"",n(u,I,Q),O.classList.add("oil-input-warning"),r(O),m()}else O.classList.remove("oil-input-warning"),n(u,I,"")}if(I==="percent"&&x){let K=N(v(x.value),0),Q="";if(K>100.01?Q="Entry exceeds the max oils allowed in stage 2.":H.allowedPct!==null&&K>H.allowedPct+.01&&(Q=`Must be under ${d(H.allowedPct,2)}% to stay within the stage 2 oil limit.`),Q){let j=H.allowedPct!==null?d(H.allowedPct,2):100;x.value=j>0?j:"",n(u,I,Q),x.classList.add("oil-input-warning"),r(x),m()}else x.classList.remove("oil-input-warning"),n(u,I,"")}}function i(u,I={}){let b=Array.from(document.querySelectorAll("#oilRows .oil-row")),L=u!=null?u:T(),O=!!I.force;if(!L||L<=0||!b.length){E.lastOilTarget=L;return}let x=b.reduce((K,Q)=>{var j;return K+N(v((j=Q.querySelector(".oil-percent"))==null?void 0:j.value),0)},0),H=b.reduce((K,Q)=>{var j;return K+$((j=Q.querySelector(".oil-grams"))==null?void 0:j.value)},0);if(x<=0&&H<=0){E.lastOilTarget=L;return}if(!(!O&&E.lastOilTarget&&Math.abs(E.lastOilTarget-L)<.01)){if(x>0)b.forEach(K=>{let Q=K.querySelector(".oil-percent"),j=K.querySelector(".oil-grams"),M=N(v(Q==null?void 0:Q.value),0),J=x>0?M/x:0;j&&(j.value=J>0?d(G(L*J),2):""),Q&&(Q.value=J>0?d(J*100,2):"")});else if(H>0){let K=L/H;b.forEach(Q=>{let j=Q.querySelector(".oil-grams"),M=Q.querySelector(".oil-percent"),J=$(j==null?void 0:j.value);if(j){let Z=J>0?J*K:0;j.value=Z>0?d(G(Z),2):""}if(M){let Z=$(j==null?void 0:j.value);M.value=Z>0?d(Z/L*100,2):""}})}E.lastOilTarget=L,m({skipEnforce:!0})}}function h(u,I){if(!E.lastOilEdit||!E.lastOilEdit.row)return!1;let b=E.lastOilEdit.row,L=u.reduce((K,Q)=>{var j;return Q===b?K:K+$((j=Q.querySelector(".oil-grams"))==null?void 0:j.value)},0),O=Math.max(0,I-L),x=b.querySelector(".oil-grams"),H=b.querySelector(".oil-percent");return!x||!H?!1:(x.value=O>0?d(G(O),2):"",H.value=O>0?d(O/I*100,2):"",E.wasCapped=!0,!0)}function c({totalWeight:u,totalPct:I,target:b,capped:L}){let O=document.getElementById("oilLimitWarning");if(!O)return;let x=[];if(L&&x.push("Oil total hit the mold cap and was adjusted."),b>0&&u>b+.01){let H=u-b;x.push(`Oil weights exceed the target by ${d(G(H),2)} ${E.currentUnit}.`)}I>100.01&&x.push(`Oil percentages are over 100% by ${d(I-100,2)}%.`),x.length?(O.classList.remove("d-none"),O.innerHTML=`${x.join(" ")} Adjust oils or mold % to continue.`):(O.classList.add("d-none"),O.textContent="")}function m(u={}){u.skipEnforce||(E.wasCapped=!1);let I=Array.from(document.querySelectorAll("#oilRows .oil-row")),b=e.mold.getMoldSettings(),L=T();if(!L&&!b.targetOils){let K=f(I);if(K>0){L=K;let Q=document.getElementById("oilTotalTarget");Q&&!Q.value&&(Q.value=d(G(K),2))}}let O=0,x=0;if(I.forEach(K=>{let Q=K.querySelector(".oil-grams"),j=K.querySelector(".oil-percent"),M=$(Q==null?void 0:Q.value),J=N(v(j==null?void 0:j.value),0);L>0&&(E.lastOilEdit&&E.lastOilEdit.row===K&&E.lastOilEdit.field==="percent"?(M=J>0?L*(J/100):0,Q.value=J>0?d(G(M),2):""):M>0?(J=M/L*100,j.value=d(J,2)):J>0&&(M=L*(J/100),Q.value=d(G(M),2)),x+=J),M>0&&(O+=M)}),L<=0&&(O>0?(x=0,I.forEach(K=>{let Q=K.querySelector(".oil-grams"),j=K.querySelector(".oil-percent"),M=$(Q==null?void 0:Q.value);if(M>0){let J=M/O*100;j.value=d(J,2),x+=J}})):x=I.reduce((K,Q)=>{var j;return K+N(v((j=Q.querySelector(".oil-percent"))==null?void 0:j.value),0)},0)),!u.skipEnforce&&b.targetOils>0&&O>b.targetOils+.01&&h(I,b.targetOils))return m({skipEnforce:!0});E.totalOilsGrams=O;let H=document.getElementById("oilTotalComputed");return H&&(H.textContent=O>0?`${d(G(O),2)} ${E.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=d(x,2),c({totalWeight:O,totalPct:x,target:L,capped:E.wasCapped}),e.additives.updateAdditivesOutput(O),e.mold.updateMoldSuggested(),k(),{totalWeight:O,totalPct:x,target:L}}function s(){let u=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!u.length)return;let I=T(),b=u.reduce((L,O)=>{var x;return L+N(v((x=O.querySelector(".oil-percent"))==null?void 0:x.value),0)},0);!b&&I>0&&(b=u.reduce((L,O)=>{var H;let x=$((H=O.querySelector(".oil-grams"))==null?void 0:H.value);return L+(x>0?x/I*100:0)},0)),!(b<=0)&&(u.forEach(L=>{let O=L.querySelector(".oil-percent"),x=L.querySelector(".oil-grams"),K=N(v(O.value),0)/b*100;O.value=d(K,2),I>0&&(x.value=K>0?d(G(I*(K/100)),2):"")}),m())}function A(){let u=[];return document.querySelectorAll("#oilRows .oil-row").forEach(I=>{var J,Z,ne,oe,me,fe,se,ie,ye;let b=(Z=(J=I.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:Z.trim(),L=$((ne=I.querySelector(".oil-grams"))==null?void 0:ne.value),O=v((oe=I.querySelector(".oil-sap-koh"))==null?void 0:oe.value),x=v((me=I.querySelector(".oil-iodine"))==null?void 0:me.value),H=((fe=I.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",K=((se=I.querySelector(".oil-gi-id"))==null?void 0:se.value)||"",Q=((ie=I.querySelector(".oil-default-unit"))==null?void 0:ie.value)||"",j=((ye=I.querySelector(".oil-category"))==null?void 0:ye.value)||"",M=null;if(H)try{M=JSON.parse(H)}catch{M=null}L<=0||u.push({name:b||null,grams:L,sapKoh:O,iodine:x,fattyProfile:M,global_item_id:K?parseInt(K):null,default_unit:Q||null,ingredient_category_name:j||null})}),u}function p({name:u,sapKoh:I,iodine:b,fattyProfile:L}={}){let O=document.getElementById("oilProfileFloat"),x=(Z,ne)=>{let oe=document.getElementById(Z);oe&&(oe.textContent=ne)},H=u||"Pick an oil to preview";x("selectedOilName",H),x("selectedOilModalName",H),O&&O.classList.toggle("d-none",!u);let K=I>0?d(I,1):"--",Q=b>0?d(b,1):"--";x("selectedOilSap",K),x("selectedOilModalSap",K),x("selectedOilIodine",Q),x("selectedOilModalIodine",Q);let j=L?P(L):{},M=(Z,ne)=>{let oe=isFinite(ne)&&ne>0?d(ne,1):"--";x(Z,oe)};M("selectedOilHardness",j.hardness),M("selectedOilModalHardness",j.hardness),M("selectedOilCleansing",j.cleansing),M("selectedOilModalCleansing",j.cleansing),M("selectedOilConditioning",j.conditioning),M("selectedOilModalConditioning",j.conditioning),M("selectedOilBubbly",j.bubbly),M("selectedOilModalBubbly",j.bubbly),M("selectedOilCreamy",j.creamy),M("selectedOilModalCreamy",j.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(Z=>{let ne=`selectedOil${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,oe=`selectedOilModal${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,me=L?v(L[Z]):0,fe=me>0?d(me,1):"--";x(ne,fe),x(oe,fe)})}function t(u){if(!u){_();return}E.selectedOilProfile=u;let I=u.fatty_acid_profile||null;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=null}p({name:u.text||u.display_name||u.name,sapKoh:v(u.saponification_value),iodine:v(u.iodine_value),fattyProfile:I})}function S(u){var H,K,Q,j,M;if(!u)return;let I=(K=(H=u.querySelector(".oil-typeahead"))==null?void 0:H.value)==null?void 0:K.trim(),b=v((Q=u.querySelector(".oil-sap-koh"))==null?void 0:Q.value),L=v((j=u.querySelector(".oil-iodine"))==null?void 0:j.value),O=((M=u.querySelector(".oil-fatty"))==null?void 0:M.value)||"",x=null;if(O)try{x=JSON.parse(O)}catch{x=null}p({name:I,sapKoh:b,iodine:L,fattyProfile:x})}function _(){E.selectedOilProfile=null,E.lastPreviewRow=null,p()}function k(){let u=document.getElementById("oilBlendTips");if(!u)return;let I=A().filter(O=>O.grams>0||O.percent>0);if(!I.length){u.classList.add("d-none"),u.textContent="";return}let b=new Set;I.forEach(O=>{let x=(O.name||"").toLowerCase();if(x&&B.forEach(H=>{H.match.test(x)&&b.add(H.tip)}),O.fattyProfile&&typeof O.fattyProfile=="object"){let H=v(O.fattyProfile.lauric),K=v(O.fattyProfile.myristic),Q=v(O.fattyProfile.palmitic),j=v(O.fattyProfile.stearic),M=v(O.fattyProfile.ricinoleic),J=v(O.fattyProfile.oleic),Z=v(O.fattyProfile.linoleic),ne=v(O.fattyProfile.linolenic);H+K>=30&&b.add(`${O.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),Q+j>=40&&b.add(`${O.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),J>=60&&b.add(`${O.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),Z+ne>=20&&b.add(`${O.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),M>=60&&b.add(`${O.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let L=Array.from(b).slice(0,6);if(!L.length){u.classList.add("d-none"),u.textContent="";return}u.classList.remove("d-none"),u.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${L.map(O=>`<li>${O}</li>`).join("")}</ul>`}function w(){return E.totalOilsGrams||0}function W(u){var I,b,L,O,x,H,K,Q,j;return u?{name:((I=u.querySelector(".oil-typeahead"))==null?void 0:I.value)||"",grams:((b=u.querySelector(".oil-grams"))==null?void 0:b.value)||"",percent:((L=u.querySelector(".oil-percent"))==null?void 0:L.value)||"",sap:((O=u.querySelector(".oil-sap-koh"))==null?void 0:O.value)||"",iodine:((x=u.querySelector(".oil-iodine"))==null?void 0:x.value)||"",fattyRaw:((H=u.querySelector(".oil-fatty"))==null?void 0:H.value)||"",gi:((K=u.querySelector(".oil-gi-id"))==null?void 0:K.value)||"",defaultUnit:((Q=u.querySelector(".oil-default-unit"))==null?void 0:Q.value)||"",categoryName:((j=u.querySelector(".oil-category"))==null?void 0:j.value)||""}:null}function D(u,I,b){let L=U(u);return L?I.has(L):b==="inventory"}function U(u){return!u||typeof u!="object"?null:u.ingredient&&u.ingredient.ingredient_category_name||u.ingredient_category_name||u.ingredient_category&&u.ingredient_category.name||null}e.oils={attachOilTypeahead:F,buildOilRow:o,getOilTargetGrams:T,updateOilTotals:m,normalizeOils:s,collectOilData:A,setSelectedOilProfileFromRow:S,clearSelectedOilProfile:_,updateOilTips:k,getTotalOilsGrams:w,serializeOilRow:W,validateOilEntry:g,scaleOilsToTarget:i}})(window);(function(R){"use strict";var p;let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},{toNumber:v,clamp:N}=e.helpers,z=e.state,$=Array.isArray((p=e.constants)==null?void 0:p.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],G=new Set(["selected_pct","selected_weight_g"]),C=25,B=140,P=260,E={mode:"basics",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function F(){var t,S;(S=(t=e.storage)==null?void 0:t.queueStateSave)==null||S.call(t)}function o(t,S){var _,k;(k=(_=e.ui)==null?void 0:_.showSoapAlert)==null||k.call(_,t,S,{dismissible:!0,timeoutMs:6e3})}function T(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),modeToggle:document.getElementById("bulkOilDisplayAllToggle"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function f(t){return t?t==="name"||G.has(t)?!0:$.includes(t):!1}function a(){(!z.bulkOilModal||typeof z.bulkOilModal!="object")&&(z.bulkOilModal=JSON.parse(JSON.stringify(E)));let t=z.bulkOilModal;return t.mode=t.mode==="all"?"all":"basics",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=f(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let S={},_=t&&typeof t=="object"?t:{};return $.forEach(k=>{let w=v(_[k]);w>0&&(S[k]=w)}),S}function r(t){let S=n(t==null?void 0:t.fatty_profile),_=String((t==null?void 0:t.name)||"").trim(),k=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:v(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${k}:${_.toLowerCase()}`)),name:_,sap_koh:v(t==null?void 0:t.sap_koh),iodine:v(t==null?void 0:t.iodine),fatty_profile:S,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:k,is_basic:!!(t!=null&&t.is_basic)}}function g(){let t=T(),S=a(),_=Object.keys(S.selection||{}).length,k=`Selected: ${_}`;t.summaryEl&&(t.summaryEl.textContent=k),t.stageCountEl&&(t.stageCountEl.textContent=String(_))}function i(t){var _;return((_=a().selection)==null?void 0:_[t])||null}function h(t,S={}){var W,D;let _=a();if(!t||!t.key)return null;let k=_.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:N(v((W=S.selected_pct)!=null?W:k.selected_pct),0,100),selected_weight_g:N(v((D=S.selected_weight_g)!=null?D:k.selected_weight_g),0)};return _.selection[t.key]=w,w}function c(t){var _;let S=a();(_=S.selection)!=null&&_[t]&&delete S.selection[t]}function m(t){var _;return((_=a().recordByKey)==null?void 0:_[t])||null}function s(){let t=a();return{mode:t.mode,view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(S=>({key:S.key,name:S.name,sap_koh:S.sap_koh,iodine:S.iodine,fatty_profile:S.fatty_profile||{},default_unit:S.default_unit,ingredient_category_name:S.ingredient_category_name,global_item_id:S.global_item_id,source:S.source,is_basic:!!S.is_basic,selected_pct:N(v(S.selected_pct),0,100),selected_weight_g:N(v(S.selected_weight_g),0)}))}}function A(t){let S=a();S.mode=(t==null?void 0:t.mode)==="all"?"all":"basics",S.viewSelected=!!(t!=null&&t.view_selected),S.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",S.sortKey=f(t==null?void 0:t.sort_key)?t.sort_key:"name",S.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let _={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let W=String((w==null?void 0:w.key)||"").trim(),D=String((w==null?void 0:w.name)||"").trim();!W||!D||(_[W]={key:W,name:D,sap_koh:v(w==null?void 0:w.sap_koh),iodine:v(w==null?void 0:w.iodine),fatty_profile:n(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:v(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:N(v(w==null?void 0:w.selected_pct),0,100),selected_weight_g:N(v(w==null?void 0:w.selected_weight_g),0)})}),S.selection=_,S.visibleRecords=[],S.offset=0,S.totalCount=0,S.hasMore=!0,S.loading=!1,g()}d.shared={FATTY_KEYS:$,LOCAL_SORT_KEYS:G,PAGE_SIZE:C,SCROLL_FETCH_THRESHOLD:B,SEARCH_DEBOUNCE_MS:P,queueStateSave:F,showAlert:o,getRefs:T,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:g,selectionForRecordKey:i,setSelection:h,removeSelection:c,getRecordByKey:m,serializeSelection:s,restoreState:A}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared;if(!v)return;let{round:N,toNumber:z}=e.helpers,{fromGrams:$}=e.units,{FATTY_KEYS:G,LOCAL_SORT_KEYS:C,getRefs:B,ensureModalState:P,selectionForRecordKey:E,updateSelectionCounters:F}=v;function o(p){let t=B();t.statusEl&&(t.statusEl.textContent=p)}function T(){let p=P(),t=p.mode==="all"?"all oils":"SoapCalc basics";if(p.loading&&!p.visibleRecords.length){o("Loading oils...");return}if(!p.visibleRecords.length){let W=p.query?"No oils match that search.":"No oils available.";o(W);return}let S=p.visibleRecords.length,_=p.totalCount,k=p.hasMore?" \u2022 scroll for more":"",w=p.query?` \u2022 search: "${p.query}"`:"";o(`Loaded ${S}/${_} in ${t}${w}${k}`)}function f(p,t,S){if(typeof p=="string"||typeof t=="string"){let w=String(p||"").toLowerCase(),W=String(t||"").toLowerCase();return w<W?S==="asc"?-1:1:w>W?S==="asc"?1:-1:0}let _=z(p),k=z(t);return _<k?S==="asc"?-1:1:_>k?S==="asc"?1:-1:0}function a(p,t){var S,_;return t==="selected_pct"?((S=E(p.key))==null?void 0:S.selected_pct)||0:t==="selected_weight_g"?((_=E(p.key))==null?void 0:_.selected_weight_g)||0:""}function n(){let p=P();C.has(p.sortKey)&&p.visibleRecords.sort((t,S)=>{let _=f(a(t,p.sortKey),a(S,p.sortKey),p.sortDir);return _!==0?_:f(t.name||"",S.name||"","asc")})}function r(){let p=P();if(!p.viewSelected)return;let t=[],S=[];p.visibleRecords.forEach(_=>{E(_.key)?t.push(_):S.push(_)}),p.visibleRecords=t.concat(S)}function g(){n(),r()}function i(p){let t=String(p||"").trim().toLowerCase();return t==="name"||G.includes(t)?t:"name"}function h(){let p=P();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let S=t.dataset.label||"",_=t.dataset.sortKey||"";p.sortKey===_?t.textContent=`${S} ${p.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=S})}function c(p,t){let S=E(t.key),_=p.querySelector(".bulk-oil-check"),k=p.querySelector(".bulk-oil-pct"),w=p.querySelector(".bulk-oil-weight");_&&(_.checked=!!S),k&&(k.value=S&&S.selected_pct>0?N(S.selected_pct,2):""),w&&(w.value=S&&S.selected_weight_g>0?N($(S.selected_weight_g),2):"")}function m(p){let t=document.createElement("td");t.className="bulk-oil-acid";let S=z(p);return t.textContent=S>0?N(S,1).toString():"--",t}function s(p){let t=document.createElement("tr");t.dataset.recordKey=p.key;let S=document.createElement("td");S.className="text-center";let _=document.createElement("input");_.type="checkbox",_.className="form-check-input bulk-oil-check",S.appendChild(_),t.appendChild(S);let k=document.createElement("td");k.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=p.name;let W=document.createElement("div");W.className="text-muted small";let D=p.ingredient_category_name?` \xB7 ${p.ingredient_category_name}`:"";W.textContent=`${p.source}${D}`,k.appendChild(w),k.appendChild(W),t.appendChild(k),G.forEach(L=>{var O;t.appendChild(m((O=p.fatty_profile)==null?void 0:O[L]))});let U=document.createElement("td"),u=document.createElement("input");u.type="number",u.min="0",u.max="100",u.step="0.1",u.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",U.appendChild(u),t.appendChild(U);let I=document.createElement("td"),b=document.createElement("input");return b.type="number",b.min="0",b.step="0.1",b.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",I.appendChild(b),t.appendChild(I),c(t,p),t}function A(){let p=B(),t=P();if(!p.bodyEl)return;p.bodyEl.innerHTML="";let S=document.createDocumentFragment();t.visibleRecords.forEach(_=>{S.appendChild(s(_))}),p.bodyEl.appendChild(S),h(),F(),T()}d.render={updateStatusText:o,refreshCatalogStatus:T,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:g,normalizeServerSortKey:i,sortButtonsLabel:h,renderVisibleRecords:A}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared,N=d.render;if(!v||!N)return;let{PAGE_SIZE:z,getRefs:$,ensureModalState:G,normalizeCatalogRecord:C}=v,{refreshCatalogStatus:B,normalizeServerSortKey:P,applyClientOrdering:E,renderVisibleRecords:F,updateStatusText:o}=N;function T(){let a=G(),n=$();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function f({reset:a=!1}={}){let n=G();if(!$().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&T();let g=n.requestToken+1;n.requestToken=g,n.loading=!0,B();let i=new URLSearchParams;i.set("mode",n.mode),i.set("offset",String(n.offset)),i.set("limit",String(z)),i.set("q",n.query||""),i.set("sort_key",P(n.sortKey)),i.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let h=await fetch(`/tools/api/soap/oils-catalog?${i.toString()}`);if(!h.ok)throw new Error("Unable to load oils catalog");let c=await h.json();if(!c||c.success!==!0||!c.result||!Array.isArray(c.result.records))throw new Error("Invalid oils catalog response");if(g!==n.requestToken)return;let m=c.result.records.map(C),s=Math.max(0,parseInt(c.result.next_offset,10)||n.offset+m.length),A=Math.max(m.length,parseInt(c.result.count,10)||0),p=!!c.result.has_more;m.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?m.slice():n.visibleRecords.concat(m),n.offset=s,n.totalCount=A,n.hasMore=p,E(),F()}catch(h){throw g===n.requestToken&&o("Unable to load oils catalog."),h}finally{g===n.requestToken&&(n.loading=!1,B())}}d.api={fetchCatalogPage:f}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared,N=d.render,z=d.api;if(!v||!N||!z)return;let{round:$,toNumber:G,clamp:C}=e.helpers,{toGrams:B,fromGrams:P}=e.units,E=e.state,{LOCAL_SORT_KEYS:F,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:T,queueStateSave:f,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:g,setSelection:i,removeSelection:h,getRecordByKey:c,serializeSelection:m,restoreState:s}=v,{applyClientOrdering:A,sortButtonsLabel:p,renderVisibleRecords:t}=N,{fetchCatalogPage:S}=z,_=null,k=null;function w(){var q;let y=n();y.modalEl&&(!_&&((q=R.bootstrap)!=null&&q.Modal)&&(_=R.bootstrap.Modal.getOrCreateInstance(y.modalEl)),_&&_.hide())}function W(){return document.getElementById("oilRows")}function D(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function U(y){return String(y||"").trim().toLowerCase()}function u(y){var q;return U((q=y==null?void 0:y.querySelector(".oil-typeahead"))==null?void 0:q.value)}function I(y){var V;let q=String(((V=y==null?void 0:y.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return q||""}function b(y,q){let V=String(y||"").trim();if(!V)return null;let X=D(),ee=X.find(ce=>String(ce.dataset.bulkOilKey||"")===V);if(ee)return ee;let te=String((q==null?void 0:q.global_item_id)||"").trim();if(te&&(ee=X.find(ce=>I(ce)===te),ee))return ee;let ue=U(q==null?void 0:q.name);return ue&&(ee=X.find(ce=>u(ce)===ue),ee)?ee:null}function L(y,q){if(!y||!q)return;y.dataset.bulkOilKey=q.key||"";let V=y.querySelector(".oil-typeahead"),X=y.querySelector(".oil-sap-koh"),ee=y.querySelector(".oil-iodine"),te=y.querySelector(".oil-fatty"),ue=y.querySelector(".oil-gi-id"),ce=y.querySelector(".oil-default-unit"),le=y.querySelector(".oil-category"),de=y.querySelector(".oil-grams"),pe=y.querySelector(".oil-percent");V&&(V.value=q.name||""),X&&(X.value=q.sap_koh>0?$(q.sap_koh,3):""),ee&&(ee.value=q.iodine>0?$(q.iodine,3):""),te&&(te.value=q.fatty_profile&&Object.keys(q.fatty_profile).length?JSON.stringify(q.fatty_profile):""),ue&&(ue.value=q.global_item_id||""),ce&&(ce.value=q.default_unit||""),le&&(le.value=q.ingredient_category_name||""),pe&&(pe.value=q.selected_pct>0?$(q.selected_pct,2):""),de&&(de.value=q.selected_weight_g>0?$(P(q.selected_weight_g),2):"")}function O(y){if(!y||!y.key)return null;let q=b(y.key,y),V=W();return!q&&V&&(q=e.oils.buildOilRow(),q&&V.appendChild(q)),L(q,y),q}function x(y,q){let V=b(y,q);V&&(E.lastOilEdit&&E.lastOilEdit.row===V&&(E.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function H(){D().forEach(q=>{E.lastOilEdit&&E.lastOilEdit.row===q&&(E.lastOilEdit=null),q.remove()}),e.oils.clearSelectedOilProfile()}function K(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function Q(y,q,V){let X=String(V||"").trim();if(X)return X;let ee=String(q||"").trim();if(ee)return`global:${ee}`;let te=U(y);return te?`soapcalc:${te}`:""}function j(){let y={};return D().forEach(q=>{var Se,Ie,_e,Ce,be,qe,ae,ge,Ee;let V=String(((Se=q.querySelector(".oil-typeahead"))==null?void 0:Se.value)||"").trim(),X=G((Ie=q.querySelector(".oil-sap-koh"))==null?void 0:Ie.value),ee=G((_e=q.querySelector(".oil-iodine"))==null?void 0:_e.value),te=String(((Ce=q.querySelector(".oil-gi-id"))==null?void 0:Ce.value)||"").trim(),ue=String(((be=q.querySelector(".oil-default-unit"))==null?void 0:be.value)||"gram"),ce=String(((qe=q.querySelector(".oil-category"))==null?void 0:qe.value)||""),le=C(G((ae=q.querySelector(".oil-percent"))==null?void 0:ae.value),0,100),de=C(B((ge=q.querySelector(".oil-grams"))==null?void 0:ge.value),0),pe=String(((Ee=q.querySelector(".oil-fatty"))==null?void 0:Ee.value)||""),re={};if(pe)try{let Le=JSON.parse(pe);re=v.normalizeFattyProfile(Le)}catch{re={}}let ve=Q(V,te,q.dataset.bulkOilKey);!ve||!(V||le>0||de>0||X>0||ee>0||Object.keys(re).length>0)||(q.dataset.bulkOilKey=ve,y[ve]={key:ve,name:V||"Unnamed oil",sap_koh:X,iodine:ee,fatty_profile:re,default_unit:ue||"gram",ingredient_category_name:ce,global_item_id:te?parseInt(te,10):null,source:te?"global":"soapcalc",is_basic:!te,selected_pct:le,selected_weight_g:de})}),y}function M(){let y=r();y.selection=j(),g()}function J(){let y=r(),q=Object.values(y.selection||{}),V=new Set(q.map(X=>X.key));D().forEach(X=>{let ee=String(X.dataset.bulkOilKey||"").trim();(!ee||!V.has(ee))&&X.remove()}),q.slice().sort((X,ee)=>String(X.name||"").localeCompare(String(ee.name||""))).forEach(X=>{O(X)}),K()}async function Z(){var V;let y=n(),q=r();if(y.modalEl){M(),!_&&((V=R.bootstrap)!=null&&V.Modal)&&(_=R.bootstrap.Modal.getOrCreateInstance(y.modalEl)),y.searchInput&&(y.searchInput.value=q.query||""),y.modeToggle&&(y.modeToggle.checked=q.mode==="all"),y.viewSelectedToggle&&(y.viewSelectedToggle.checked=!!q.viewSelected),y.unitLabelEl&&(y.unitLabelEl.textContent=E.currentUnit||"g"),_&&_.show(),p(),g();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ne(y){let q=y.target;if(!(q instanceof HTMLElement))return;let V=q.closest("tr[data-record-key]");if(!V)return;let X=V.dataset.recordKey||"",ee=c(X);if(!ee)return;let te=V.querySelector(".bulk-oil-check"),ue=V.querySelector(".bulk-oil-pct"),ce=V.querySelector(".bulk-oil-weight"),le=C(G(ue==null?void 0:ue.value),0,100),de=C(B(ce==null?void 0:ce.value),0),pe=le>0||de>0;if(!!(te!=null&&te.checked)||pe){te&&(te.checked=!0);let Se=i(ee,{selected_pct:le,selected_weight_g:de});O(Se)}else h(X),x(X,ee);let ve=r();F.has(ve.sortKey)||ve.viewSelected?(A(),t()):g(),K(),f()}async function oe(y){let q=r();q.mode=y?"all":"basics",f();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}function me(y){let q=r();q.viewSelected=!!y,A(),t(),f()}async function fe(y){let q=y.target instanceof HTMLElement?y.target.closest(".bulk-oil-sort"):null;if(!q)return;let V=q.getAttribute("data-sort-key")||"name",X=r();if(X.sortKey===V?X.sortDir=X.sortDir==="asc"?"desc":"asc":(X.sortKey=V,X.sortDir=V==="name"?"asc":"desc"),f(),F.has(X.sortKey)){A(),t();return}try{await S({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function se(){let y=r();y.selection={},H(),(F.has(y.sortKey)||y.viewSelected)&&A(),t(),K(),f()}async function ie(){let y=n(),q=r();if(!(!y.scrollEl||q.loading||!q.hasMore||!(y.scrollEl.scrollTop+y.scrollEl.clientHeight>=y.scrollEl.scrollHeight-o)))try{await S({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ye(){k&&R.clearTimeout(k),k=R.setTimeout(async()=>{try{await S({reset:!0})}catch{a("danger","Unable to search oils right now.")}},T)}function he(){J(),f(),w()}function l(){var q;let y=n();y.unitLabelEl&&(y.unitLabelEl.textContent=E.currentUnit||"g"),(q=y.modalEl)!=null&&q.classList.contains("show")&&t()}function Y(){let y=n();y.modalEl&&(y.openBtn&&y.openBtn.addEventListener("click",()=>{Z()}),y.searchInput&&y.searchInput.addEventListener("input",()=>{let q=r();q.query=y.searchInput.value||"",f(),ye()}),y.modeToggle&&y.modeToggle.addEventListener("change",async()=>{await oe(!!y.modeToggle.checked)}),y.viewSelectedToggle&&y.viewSelectedToggle.addEventListener("change",()=>{me(!!y.viewSelectedToggle.checked)}),y.scrollEl&&y.scrollEl.addEventListener("scroll",ie),y.bodyEl&&(y.bodyEl.addEventListener("input",ne),y.bodyEl.addEventListener("change",ne)),y.modalEl.querySelectorAll(".bulk-oil-sort").forEach(q=>{q.addEventListener("click",fe)}),y.importBtn&&y.importBtn.addEventListener("click",()=>{he()}),y.clearBtn&&y.clearBtn.addEventListener("click",()=>{se()}),y.modalEl.addEventListener("shown.bs.modal",()=>{let q=n();q.searchInput&&q.searchInput.focus()}))}Y(),g(),p(),e.bulkOilsModal={openModal:Z,serializeSelection:m,restoreState:s,onUnitChanged:l}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d,round:v,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{formatWeight:$,toGrams:G,fromGrams:C}=e.units,{FRAGRANCE_CATEGORY_SET:B}=e.constants,P=e.state;function E(c,m,s,A,p){var D;let t=document.getElementById(c),S=document.getElementById(m),_=A?document.getElementById(A):null,k=p?document.getElementById(p):null,w=(D=t==null?void 0:t.parentElement)==null?void 0:D.querySelector('[data-role="suggestions"]');if(!t||!w||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let W=z();R.attachMergedInventoryGlobalTypeahead({inputEl:t,listEl:w,mode:"public",giHiddenEl:S,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:W,searchType:"ingredient",resultFilter:(U,u)=>{let I=h(U);return I?s.has(I):u==="inventory"},requireHidden:!1,onSelection:function(U){_&&(_.value=(U==null?void 0:U.default_unit)||""),k&&(k.value=(U==null?void 0:U.ingredient_category_name)||""),e.storage.queueStateSave()}}),t.addEventListener("input",function(){this.value.trim()||(_&&(_.value=""),k&&(k.value=""))})}function F({pctId:c,weightId:m}){var S,_,k;let s=document.getElementById(c),A=s==null?void 0:s.value;if(A!==""&&A!==null&&A!==void 0)return d(A);let p=N(((_=(S=e.oils)==null?void 0:S.getTotalOilsGrams)==null?void 0:_.call(S))||0,0);if(p<=0)return 0;let t=G((k=document.getElementById(m))==null?void 0:k.value);return t<=0?0:t/p*100}function o(){var c,m,s,A,p,t,S,_;return{lactatePct:F({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:F({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:F({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:F({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((m=(c=document.getElementById("additiveLactateName"))==null?void 0:c.value)==null?void 0:m.trim())||"Sodium Lactate",sugarName:((A=(s=document.getElementById("additiveSugarName"))==null?void 0:s.value)==null?void 0:A.trim())||"Sugar",saltName:((t=(p=document.getElementById("additiveSaltName"))==null?void 0:p.value)==null?void 0:t.trim())||"Salt",citricName:((_=(S=document.getElementById("additiveCitricName"))==null?void 0:S.value)==null?void 0:_.trim())||"Citric Acid"}}function T(c){let m=(A,p)=>{let t=document.getElementById(A);t&&(t.tagName==="INPUT"?t.value=p:t.textContent=p)},s=A=>A>0?v(C(A),2):"";m("additiveLactateWeight",s(d(c==null?void 0:c.lactateG))),m("additiveSugarWeight",s(d(c==null?void 0:c.sugarG))),m("additiveSaltWeight",s(d(c==null?void 0:c.saltG))),m("additiveCitricWeight",s(d(c==null?void 0:c.citricG))),m("additiveCitricLyeOut",$(d(c==null?void 0:c.citricLyeG)))}function f(c){var S;let m=N(d(c),0),s=(S=e.state)==null?void 0:S.lastCalc,A=N(d(s==null?void 0:s.totalOils),0),p=Math.abs(A-m)<.01,t=s!=null&&s.additives&&p?s.additives:{lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0};return T(t),t}function a(c){let m=c.querySelector(".fragrance-typeahead"),s=c.querySelector(".fragrance-gi-id"),A=c.querySelector(".fragrance-default-unit"),p=c.querySelector(".fragrance-category"),t=c.querySelector('[data-role="suggestions"]');if(!m||!t||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let S=z();R.attachMergedInventoryGlobalTypeahead({inputEl:m,listEl:t,mode:"public",giHiddenEl:s,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:S,searchType:"ingredient",resultFilter:(_,k)=>{let w=h(_);return w?B.has(w):k==="inventory"},requireHidden:!1,onSelection:function(_){A&&(A.value=(_==null?void 0:_.default_unit)||""),p&&(p.value=(_==null?void 0:_.ingredient_category_name)||""),e.storage.queueStateSave()}}),m.addEventListener("input",function(){this.value.trim()||(A&&(A.value=""),p&&(p.value=""))})}function n(){var s,A;let c=document.getElementById("fragranceRowTemplate"),m=(A=(s=c==null?void 0:c.content)==null?void 0:s.querySelector(".fragrance-row"))==null?void 0:A.cloneNode(!0);return m?(m.querySelectorAll("input").forEach(p=>{p.value=""}),a(m),m.querySelectorAll(".unit-suffix").forEach(p=>{p.dataset.suffix=P.currentUnit}),m):document.createElement("div")}function r(c){let m=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),s=N(c||e.oils.getTotalOilsGrams()||0,0),A=0,p=0;m.forEach(_=>{let k=_.querySelector(".fragrance-grams"),w=_.querySelector(".fragrance-percent"),W=G(k==null?void 0:k.value),D=N(d(w==null?void 0:w.value),0),U=W,u=D;s>0&&(U<=0&&u>0?U=s*(u/100):u<=0&&U>0&&(u=U/s*100)),U>0&&(A+=U),p+=u});let t=document.getElementById("fragrancePercentTotal");t&&(t.textContent=v(p,2));let S=document.getElementById("fragranceTotalComputed");return S&&(S.textContent=A>0?$(A):"--"),{totalGrams:A,totalPct:p}}function g(){let c=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(m=>{var k,w,W,D,U,u,I;let s=((w=(k=m.querySelector(".fragrance-typeahead"))==null?void 0:k.value)==null?void 0:w.trim())||"",A=((W=m.querySelector(".fragrance-grams"))==null?void 0:W.value)||"",p=((D=m.querySelector(".fragrance-percent"))==null?void 0:D.value)||"",t=((U=m.querySelector(".fragrance-gi-id"))==null?void 0:U.value)||"",S=((u=m.querySelector(".fragrance-default-unit"))==null?void 0:u.value)||"",_=((I=m.querySelector(".fragrance-category"))==null?void 0:I.value)||"";!s&&!A&&!p&&!t||c.push({name:s,grams:A,percent:p,gi:t,defaultUnit:S,categoryName:_})}),c}function i(c){let m=document.getElementById("soapVisualGuidanceList");if(!m)return;let s=Array.isArray(c==null?void 0:c.tips)&&c.tips.length?c.tips:["No visual flags detected for this formula."];m.innerHTML=s.map(A=>`<li>${A}</li>`).join("")}function h(c){return!c||typeof c!="object"?null:c.ingredient&&c.ingredient.ingredient_category_name||c.ingredient_category_name||c.ingredient_category&&c.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:E,collectAdditiveSettings:o,applyComputedOutputs:T,updateAdditivesOutput:f,updateVisualGuidance:i},e.fragrances={buildFragranceRow:n,updateFragranceTotals:r,collectFragranceData:g}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d}=e.helpers,{STAGE_CONFIGS:v}=e.constants;function N(C){var E;let B=v[C];if(!B)return;let P=document.getElementById(B.tabId);if(P){if((E=R.bootstrap)!=null&&E.Tab)bootstrap.Tab.getOrCreateInstance(P).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),P.classList.add("active"),P.setAttribute("aria-selected","true");let F=document.getElementById(B.paneId);F&&F.classList.add("show","active")}e.layout.scheduleStageHeightSync(),P.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function z(C){var B,P;if(C===1){let E=document.getElementById("unitGrams");E&&(E.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let F=document.getElementById("moldCylinderCorrection");F&&(F.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(B=e.mold)!=null&&B.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(C===2){let E=document.getElementById("oilRows");E&&(E.innerHTML="",E.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(C===3){let E=document.getElementById("lyeTypeNaoh");E&&(E.checked=!0);let F=document.getElementById("waterMethod");F&&(F.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let T=document.getElementById("lyePurity");T&&(T.value="100");let f=document.getElementById("waterPct");f&&(f.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(C===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(E=>{let F=document.getElementById(E);F&&(F.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(E=>{let F=document.getElementById(E);F&&(F.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),C===5){let E=document.getElementById("fragranceRows");E&&(E.innerHTML="",(P=e.fragrances)!=null&&P.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()));let F=document.getElementById("fragrancePercentTotal");F&&(F.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),G()}function $(C){var B;if(C===1){let P=d(document.getElementById("moldWaterWeight").value),E=d(document.getElementById("oilTotalTarget").value),F=d(document.getElementById("moldOilPct").value),T=!!document.querySelector('input[name="weight_unit"]:checked')&&(P>0||E>0)&&F>0;return{state:T?"complete":"incomplete",label:T?"Sized":"Needs target"}}if(C===2){let E=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(F=>{var a,n,r,g;let o=(n=(a=F.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),T=d((r=F.querySelector(".oil-grams"))==null?void 0:r.value),f=d((g=F.querySelector(".oil-percent"))==null?void 0:g.value);return o&&(T>0||f>0)});return{state:E?"complete":"incomplete",label:E?"Oils added":"Add oils"}}if(C===3){let P=d(document.getElementById("lyeSuperfat").value),E=(B=document.getElementById("waterMethod"))==null?void 0:B.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!E&&P>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return C===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(E=>d(document.getElementById(E).value)>0)?"Added":"Optional"}:C===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(F=>{var a,n,r,g;let o=(n=(a=F.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),T=d((r=F.querySelector(".fragrance-grams"))==null?void 0:r.value),f=d((g=F.querySelector(".fragrance-percent"))==null?void 0:g.value);return o||T>0||f>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function G(){let C=document.getElementById("soapStageTabList");C&&C.querySelectorAll(".soap-stage-status").forEach(P=>P.remove());let B=document.getElementById("soapStageProgress");B&&(B.textContent="")}e.stages={openStageByIndex:N,resetStage:z,updateStageStatuses:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:N}=e.helpers,{computeFattyAcids:z,computeQualities:$,computeOilQualityScores:G}=e.calc,{QUALITY_RANGES:C,QUALITY_HINTS:B,QUALITY_FEEL_HINTS:P,IODINE_RANGE:E,IODINE_SCALE_MAX:F,INS_RANGE:o,INS_SCALE_MAX:T,QUALITY_BASE:f,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:g,showSoapAlert:i}=e.ui;function h({barId:W,fillId:D,value:U,max:u,label:I}){let b=document.getElementById(W),L=document.getElementById(D);if(!b||!L)return null;let O=isFinite(U)?U:0,x=Math.max(0,Math.min(u,O)),H=u>0?x/u*100:0;return L.style.width=`${H}%`,b.setAttribute("aria-valuemin","0"),b.setAttribute("aria-valuemax",String(u)),b.setAttribute("aria-valuenow",x.toFixed(1)),I&&b.setAttribute("aria-label",I),{bar:b,fill:L,value:O}}function c(W,D,U){if(!(!W||!U)){if(W.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(D)){W.classList.add("bg-secondary");return}D<U[0]?W.classList.add("bg-warning"):D>U[1]?W.classList.add("bg-danger"):W.classList.add("bg-success")}}function m(W,D,U,u,I,b){let L=h({barId:W,fillId:D,value:U,max:I,label:b});L&&c(L.fill,U,u)}function s(){let W={hardness:{range:C.hardness,scale:100},cleansing:{range:C.cleansing,scale:100},conditioning:{range:C.conditioning,scale:100},bubbly:{range:C.bubbly,scale:100},creamy:{range:C.creamy,scale:100},iodine:{range:E,scale:F},ins:{range:o,scale:T}};Object.entries(W).forEach(([D,U])=>{let[u,I]=U.range,b=U.scale,L=D.charAt(0).toUpperCase()+D.slice(1),O=D==="iodine"?"iodineBar":D==="ins"?"insBar":`quality${L}Bar`,x=document.getElementById(`quality${L}Safe`);if(x){let j=Math.max(0,Math.min(100,u/b*100)),M=Math.max(0,Math.min(100,(I-u)/b*100));x.style.left=`${j}%`,x.style.width=`${M}%`,x.title=`Safe range ${d(u,0)}-${d(I,0)}`}let H=document.getElementById(O);H&&(H.dataset.safeRange=`${d(u,0)}-${d(I,0)}`);let K=document.getElementById(`quality${L}RangeMin`),Q=document.getElementById(`quality${L}RangeMax`);K&&(K.textContent=d(u,0)),Q&&(Q.textContent=d(I,0))})}function A(W,D){let U=N(W.hardness||0,0,100),u=N(W.bubbly||0,0,100),I=N(W.conditioning||0,0,100),b=N(I+(D||0)*3,0,100),L=document.getElementById("feelHardness"),O=document.getElementById("feelBubbly"),x=document.getElementById("feelConditioning"),H=document.getElementById("feelGreasy");L&&(L.value=d(U,1)),O&&(O.value=d(u,1)),x&&(x.value=d(I,1)),H&&(H.value=d(b,1))}function p(W){r.forEach(D=>{let U=document.getElementById(`fattyBar${D.charAt(0).toUpperCase()}${D.slice(1)}`);if(!U)return;let u=N(v(W[D]),0,100),I=u;U.style.width=`${I}%`,U.style.backgroundColor=n[D]||"var(--color-muted)",U.title=`${D.charAt(0).toUpperCase()}${D.slice(1)}: ${d(u,1)}%`})}function t(){var u;let W=((u=document.getElementById("qualityPreset"))==null?void 0:u.value)||"balanced",D=Array.from(document.querySelectorAll(".quality-focus:checked"));if(W==="none"&&!D.length)return null;let U=W==="none"?{...f}:a[W]?{...a[W]}:{...f};return D.forEach(I=>{let b=I.dataset.attr,L=I.dataset.direction,O=C[b];O&&(U[b]=L==="low"?O[0]:O[1])}),U}function S(){let W=t(),D={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(D).forEach(([U,u])=>{if(!u)return;let I=document.getElementById(`${u.id}Label`);if(!W){u.classList.add("d-none"),I&&(I.textContent="");return}let b=v(W[U]);if(!isFinite(b)){u.classList.add("d-none"),I&&(I.textContent="");return}let L=U==="iodine"?F:U==="ins"?T:100,O=N(b,0,L);u.classList.remove("d-none"),u.style.left=`${O/L*100}%`,u.setAttribute("aria-label",`Apply ${U} target`),u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.title=`Target ${U}: ${d(b,1)}`,I&&(I.textContent=d(b,1))})}function _(){let W=t();if(!W){i("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let U=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(M=>{var oe,me;let J=e.units.toGrams((oe=M.querySelector(".oil-grams"))==null?void 0:oe.value),Z=((me=M.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ne=null;if(Z)try{ne=JSON.parse(Z)}catch{ne=null}return{row:M,grams:J,fattyProfile:ne}}).filter(M=>M.grams>0);if(!U.length){i("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let u=z(U.map(M=>({grams:M.grams,fattyProfile:M.fattyProfile}))),I=$(u.percent),b={hardness:N((W.hardness-I.hardness)/100,-1,1),cleansing:N((W.cleansing-I.cleansing)/100,-1,1),conditioning:N((W.conditioning-I.conditioning)/100,-1,1),bubbly:N((W.bubbly-I.bubbly)/100,-1,1),creamy:N((W.creamy-I.creamy)/100,-1,1)},L=U.reduce((M,J)=>M+J.grams,0),O=[],x=0,H=.8,K=U.filter(M=>!M.fattyProfile||typeof M.fattyProfile!="object").length;if(K===U.length){i("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(K&&i("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),U.forEach(M=>{let J=G(M.fattyProfile),Z=b.hardness*J.hardness+b.cleansing*J.cleansing+b.conditioning*J.conditioning+b.bubbly*J.bubbly+b.creamy*J.creamy,ne=N(1+Z*H,.2,1.8),oe=M.grams*ne;O.push({row:M.row,grams:oe}),x+=oe}),x<=0){i("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let Q=L/x,j=e.oils.getOilTargetGrams()||L;O.forEach(M=>{let J=M.grams*Q,Z=M.row.querySelector(".oil-grams"),ne=M.row.querySelector(".oil-percent");if(Z&&(Z.value=J>0?d(e.units.fromGrams(J),2):""),ne&&j>0){let oe=J/j*100;ne.value=oe>0?d(oe,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),i("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function k(W){let{qualities:D,fattyPercent:U,coveragePct:u,iodine:I,ins:b,sapAvg:L,superfat:O,warnings:x}=W,H=u>0;function K(se,ie){var q,V;let ye=document.getElementById(`quality${se}Value`),he=document.getElementById(`quality${se}Hint`);if(!ye)return;ye.textContent=H&&isFinite(ie)?d(ie,1):"--",g(ye);let l=se.toLowerCase(),Y=C[l],y=h({barId:`quality${se}Bar`,fillId:`quality${se}Fill`,value:H?ie:0,max:100,label:se});y&&Y&&(c(y.fill,ie,Y),H&&isFinite(ie)?y.bar.title=`${se}: ${d(ie,1)} (safe ${Y[0]}-${Y[1]}). ${B[l]||""}`.trim():y.bar.title=`${se}: -- (safe ${Y[0]}-${Y[1]}). ${B[l]||""}`.trim()),he&&Y&&(!H||!isFinite(ie)?he.textContent="":ie<Y[0]?he.textContent=((q=P[l])==null?void 0:q.low)||"":ie>Y[1]?he.textContent=((V=P[l])==null?void 0:V.high)||"":he.textContent="")}K("Hardness",D.hardness),K("Cleansing",D.cleansing),K("Conditioning",D.conditioning),K("Bubbly",D.bubbly),K("Creamy",D.creamy);let Q=document.getElementById("fattyCoverageNote");Q&&(Q.textContent=u>0?`Fatty acid coverage: ${d(u,1)}% of oils`:"Fatty acid coverage: not enough data yet");let j=document.getElementById("iodineValue"),M=document.getElementById("insValue"),J=document.getElementById("sapAvgValue");j&&(j.textContent=I>0?d(I,1):"--",g(j)),M&&(M.textContent=b>0?d(b,1):"--",g(M)),J&&(J.textContent=L>0?d(L,1):"--",g(J)),m("iodineBar","iodineFill",I,E,F,"Iodine"),m("insBar","insFill",b,o,T,"INS");let Z=(U.lauric||0)+(U.myristic||0)+(U.palmitic||0)+(U.stearic||0),ne=(U.ricinoleic||0)+(U.oleic||0)+(U.linoleic||0)+(U.linolenic||0),oe=document.getElementById("fattySatRatioResult");oe&&(oe.textContent=Z+ne>0?`${d(Z,0)}:${d(ne,0)}`:"--",g(oe)),r.forEach(se=>{let ie=`fatty${se.charAt(0).toUpperCase()}${se.slice(1)}`,ye=U[se];document.getElementById(ie).textContent=H&&ye?`${d(ye,1)}%`:"--"}),A(D,O||0),p(U),S();let me=Array.isArray(x)?x.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(se=>`<li>${se}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var W;document.querySelectorAll(".soap-quality-help").forEach(D=>{let U=D.dataset.quality;B[U]&&D.setAttribute("title",B[U])}),(W=R.bootstrap)!=null&&W.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(D=>{bootstrap.Tooltip.getOrCreateInstance(D)})}e.quality={setQualityRangeBars:s,updateQualityTargets:S,applyQualityTargets:_,updateQualitiesDisplay:k,initQualityTooltips:w}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:N}=e.helpers;function z(o){let T=0,f=0;return(o||[]).forEach(a=>{let n=v(a==null?void 0:a.sapKoh),r=v(a==null?void 0:a.grams);n>0&&r>0&&(T+=n*r,f+=r)}),f>0?T/f:0}function $(o){var h,c,m,s,A,p,t,S,_,k,w,W;let T=o.qualityReport||{},f=T.fatty_acids_pct||{},a=T.qualities||{},n=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:v(T.sap_avg_koh)||z(o.oils||[]),r=v(T.iodine),g=v(T.ins)||(n&&r?n-r:0),i=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((h=document.getElementById("qualityPreset"))==null?void 0:h.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(D=>D.id),mold:i,oils:(o.oils||[]).map(D=>({name:D.name||null,grams:d(D.grams||0,2),iodine:D.iodine||null,sap_koh:D.sapKoh||null,fatty_profile:D.fattyProfile||null,global_item_id:D.global_item_id||null,default_unit:D.default_unit||null,ingredient_category_name:D.ingredient_category_name||null})),totals:{total_oils_g:d(o.totalOils||0,2),batch_yield_g:d(o.batchYield||0,2),lye_pure_g:d(o.lyePure||0,2),lye_adjusted_g:d(o.lyeAdjusted||0,2),water_g:d(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((c=o.additives)==null?void 0:c.fragrancePct)||0,lactate_pct:((m=o.additives)==null?void 0:m.lactatePct)||0,sugar_pct:((s=o.additives)==null?void 0:s.sugarPct)||0,salt_pct:((A=o.additives)==null?void 0:A.saltPct)||0,citric_pct:((p=o.additives)==null?void 0:p.citricPct)||0,fragrance_g:d(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:d(((S=o.additives)==null?void 0:S.lactateG)||0,2),sugar_g:d(((_=o.additives)==null?void 0:_.sugarG)||0,2),salt_g:d(((k=o.additives)==null?void 0:k.saltG)||0,2),citric_g:d(((w=o.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:d(((W=o.additives)==null?void 0:W.citricLyeG)||0,2)},qualities:{hardness:d(a.hardness||0,1),cleansing:d(a.cleansing||0,1),conditioning:d(a.conditioning||0,1),bubbly:d(a.bubbly||0,1),creamy:d(a.creamy||0,1),iodine:d(r||0,1),ins:d(g||0,1),sap_avg:d(n||0,1)},fatty_acids:f,updated_at:new Date().toISOString()}}function G(o,T,f,a,n){var c,m,s,A,p;let r=(m=(c=document.getElementById(o))==null?void 0:c.value)==null?void 0:m.trim(),g=((s=document.getElementById(T))==null?void 0:s.value)||"",i=a&&((A=document.getElementById(a))==null?void 0:A.value)||"",h=n&&((p=document.getElementById(n))==null?void 0:p.value)||"";return{name:r||f,globalItemId:g?parseInt(g):void 0,defaultUnit:i||void 0,categoryName:h||void 0}}function C(o){let T=[],f=N(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var A,p,t,S,_,k,w;let n=(p=(A=a.querySelector(".fragrance-typeahead"))==null?void 0:A.value)==null?void 0:p.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",g=((S=a.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",i=((_=a.querySelector(".fragrance-category"))==null?void 0:_.value)||"",h=(k=a.querySelector(".fragrance-grams"))==null?void 0:k.value,c=(w=a.querySelector(".fragrance-percent"))==null?void 0:w.value,m=e.units.toGrams(h),s=N(v(c),0);m<=0&&s>0&&f>0&&(m=f*(s/100)),!(!n&&!r&&m<=0)&&T.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:g||void 0,categoryName:i||void 0,grams:m,pct:s})}),T}function B(o,T){let f=[];return document.querySelectorAll(`#${o} .row`).forEach(function(a){var c,m,s;let n=(m=(c=a.querySelector(".tool-typeahead"))==null?void 0:c.value)==null?void 0:m.trim(),r=((s=a.querySelector(".tool-gi-id"))==null?void 0:s.value)||"",g=a.querySelector(".tool-qty"),i=a.querySelector(".tool-unit"),h=g&&g.value!=="";!n&&!r||(T==="container"?f.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(g.value):1}):f.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(g.value):0,unit:((i==null?void 0:i.value)||"").trim()||"gram"}))}),f}function P(o){let T=e.config.isAuthenticated?"member":"public",f=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:T,mode:f,unitOptionsHtml:e.config.unitOptionsHtml})}function E(o,T){let f=P(o),a=f.querySelector(".tool-typeahead"),n=f.querySelector(".tool-qty");a&&(a.value=T),n&&o==="container"&&(n.value=1),o==="container"?document.getElementById("tool-containers").appendChild(f):o==="consumable"?document.getElementById("tool-consumables").appendChild(f):document.getElementById("tool-ingredients").appendChild(f)}function F(o){var r,g,i,h;let T=$(o),f=(o.oils||[]).map(c=>({name:c.name||void 0,global_item_id:c.global_item_id||void 0,quantity:c.grams,unit:"gram",default_unit:c.default_unit||void 0,ingredient_category_name:c.ingredient_category_name||void 0})),a=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&f.push({name:a,quantity:d(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&f.push({name:"Distilled Water",quantity:d(o.water,2),unit:"gram"}),C(o.totalOils||0).forEach(c=>{c.grams>0&&f.push({name:c.name,global_item_id:c.globalItemId,quantity:d(c.grams,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let c=G("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:d(o.additives.lactateG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((g=o.additives)==null?void 0:g.sugarG)>0){let c=G("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:d(o.additives.sugarG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((i=o.additives)==null?void 0:i.saltG)>0){let c=G("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:d(o.additives.saltG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((h=o.additives)==null?void 0:h.citricG)>0){let c=G("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:d(o.additives.citricG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName}),f.push({name:"Extra Lye for Citric Acid",quantity:d(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:f.concat(B("tool-ingredients","ingredient")),consumables:B("tool-consumables","consumable"),containers:B("tool-containers","container"),notes:JSON.stringify(T)}}e.recipePayload={collectFragranceRows:C,collectDraftLines:B,buildLineRow:P,addStubLine:E,buildSoapRecipePayload:F}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:N}=e.helpers,{formatWeight:z,formatPercent:$}=e.units;function G(){var h;let a=((h=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:h.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,g=v(n==null?void 0:n.value),i=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(g))&&(g=100),{selected:a,lyeType:i,purity:g}}function C(){let a=document.getElementById("lyePurity"),n=G();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function B(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function P(a=null,n=null){var h;let r=document.getElementById("stageWaterOutput"),g=document.getElementById("stageWaterComputedHint"),i=n||(a==null?void 0:a.waterMethod)||((h=document.getElementById("waterMethod"))==null?void 0:h.value)||"percent";if(r){let c=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=c?z(a.waterG):"--"}if(g){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){g.textContent=`Set oils in Stage 2 to calculate water. ${B(i)}`;return}if(i==="concentration"){let c=a.lyeConcentrationInput||a.lyeConcentration||0;g.textContent=`Using ${d(c,1)}% lye concentration from ${z(a.lyeAdjusted||0)} lye.`;return}if(i==="ratio"){let c=a.waterRatioInput||a.waterRatio||0;g.textContent=`Using ${d(c,2)} : 1 water-to-lye ratio from ${z(a.lyeAdjusted||0)} lye.`;return}g.textContent=`Using ${d(a.waterPct||0,1)}% of total oils (${z(a.totalOils)}).`}}function E(a=null,n=null){var k;let r=document.getElementById("lyeWaterPreviewAnchor"),g=document.getElementById("lyePreview"),i=document.getElementById("waterPreview"),h=document.getElementById("concPreview"),c=document.getElementById("ratioPreview");if(!r&&!g&&!i&&!h&&!c)return;let m=(w,W)=>{w&&(w.textContent=W)},s=n||(a==null?void 0:a.waterMethod)||((k=document.getElementById("waterMethod"))==null?void 0:k.value)||"percent",A=v(a==null?void 0:a.totalOils),p=v(a==null?void 0:a.lyeAdjusted),t=v(a==null?void 0:a.waterG);if(A<=0||p<=0){m(r,"Based on -- oils. All values update live as you change inputs."),m(g,"--"),m(i,"--"),m(h,"--"),m(c,"--");return}let S=v(a==null?void 0:a.lyeConcentration)>0?v(a==null?void 0:a.lyeConcentration):p+t>0?p/(p+t)*100:0,_=v(a==null?void 0:a.waterRatio)>0?v(a==null?void 0:a.waterRatio):p>0?t/p:0;if(m(r,`Based on ${z(A)} oils. All values update live as you change inputs.`),m(g,z(p)),m(i,z(t)),m(h,S>0?$(S):"--"),m(c,_>0?`${d(_,2)} : 1`:"--"),s==="concentration"){let w=v(a==null?void 0:a.lyeConcentrationInput);w>0&&m(h,$(w))}if(s==="ratio"){let w=v(a==null?void 0:a.waterRatioInput);w>0&&m(c,`${d(w,2)} : 1`)}}function F(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),P(null,a),E(null,a)}function o(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,g=[],i=e.oils.collectOilData(),h=e.oils.getOilTargetGrams(),m=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(s=>N(v(s.value),0)).some(s=>s>0);return(!i.length||n<=0)&&g.push("Add at least one oil with a weight or percent."),!h&&n<=0&&m&&g.push("Enter a total oils target or weights to convert percentages."),h>0&&r>0&&Math.abs(r-100)>.5&&g.push("Oil percentages should total 100% (use Normalize to fix)."),h>0&&n>h+.01?g.push("Oil weights exceed the mold target."):!h&&r>100.01&&g.push("Oil percentages exceed 100%."),{ok:g.length===0,errors:g,totals:a,oils:i}}function T(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=v(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function f(){var c,m,s,A;let n=G().purity;isFinite(n)||(n=100);let r=((c=document.getElementById("waterMethod"))==null?void 0:c.value)||"percent",g=v((m=document.getElementById("waterPct"))==null?void 0:m.value),i=v((s=document.getElementById("lyeConcentration"))==null?void 0:s.value),h=v((A=document.getElementById("waterRatio"))==null?void 0:A.value);return{purity:n,waterMethod:r,waterPct:g,lyeConcentration:i,waterRatio:h}}e.runnerInputs={getLyeSelection:G,applyLyeSelection:C,setWaterMethod:F,updateStageWaterSummary:P,updateLiveCalculationPreview:E,validateCalculation:o,readSuperfatInput:T,sanitizeLyeInputs:f}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{getStorage:d}=e.helpers;function v(){if(!e.config.calcLimit)return{count:0,date:null};let C=d();if(!C)return{count:0,date:null};try{let B=C.getItem("soap_calc_usage"),P=new Date().toISOString().slice(0,10);if(!B)return{count:0,date:P};let E=JSON.parse(B);return!E||E.date!==P?{count:0,date:P}:{count:Number(E.count)||0,date:P}}catch{return{count:0,date:null}}}function N(C){if(!e.config.calcLimit)return;let B=d();if(!B)return;let P=new Date().toISOString().slice(0,10);try{B.setItem("soap_calc_usage",JSON.stringify({count:C,date:P}))}catch{}}function z(){return e.config.calcLimit&&v().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function $(){if(!e.config.calcLimit)return;let B=v().count+1;N(B);let P=Math.max(0,e.config.calcLimit-B);P<=1&&e.ui.showSoapAlert("info",`You have ${P} calculation${P===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function G(C){if(!e.config.calcLimit||C===null||C>1)return;let B=document.getElementById("soapSignupModal");B&&(R.bootstrap&&R.bootstrap.Modal?R.bootstrap.Modal.getOrCreateInstance(B).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:z,consumeCalcQuota:$,maybeShowSignupModal:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state;function v({oils:z,selection:$,superfat:G,purity:C,waterMethod:B,waterPct:P,lyeConcentration:E,waterRatio:F,totalOils:o}){let T=e.additives.collectAdditiveSettings(),f=e.recipePayload.collectFragranceRows(o||0);return{oils:(z||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:f.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:T.lactatePct||0,sugar_pct:T.sugarPct||0,salt_pct:T.saltPct||0,citric_pct:T.citricPct||0,lactate_name:T.lactateName||"Sodium Lactate",sugar_name:T.sugarName||"Sugar",salt_name:T.saltName||"Salt",citric_name:T.citricName||"Citric Acid"},lye:{selected:($==null?void 0:$.selected)||"NaOH",superfat:G,purity:C},water:{method:B,water_pct:P,lye_concentration:E,water_ratio:F},meta:{unit_display:d.currentUnit||"g"}}}async function N(z){var B;let $=((B=document.querySelector('meta[name="csrf-token"]'))==null?void 0:B.getAttribute("content"))||"",G=new AbortController,C=R.setTimeout(()=>G.abort(),2500);try{let P=await fetch("/tools/api/soap/calculate",{method:"POST",signal:G.signal,headers:{"Content-Type":"application/json",...$?{"X-CSRFToken":$}:{}},body:JSON.stringify(z||{})});if(!P.ok)return null;let E=await P.json();return!E||E.success!==!0||typeof E.result!="object"?null:E.result}catch{return null}finally{R.clearTimeout(C)}}e.runnerService={buildServicePayload:v,calculateWithSoapService:N}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v}=e.helpers,{formatWeight:N,formatPercent:z}=e.units,$=e.state,G={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function C(o){return(o||[]).map(T=>{var f;return{name:T.name||null,grams:v(T.grams),sapKoh:v((f=T.sap_koh)!=null?f:T.sapKoh),iodine:v(T.iodine),fattyProfile:T.fatty_profile||T.fattyProfile||null,global_item_id:T.global_item_id||null,default_unit:T.default_unit||null,ingredient_category_name:T.ingredient_category_name||null}})}function B(o,T){let f=document.getElementById(o);f&&(f.textContent=T)}function P({resultsCard:o,lyeAdjusted:T,waterData:f,batchYield:a,totalOils:n,superfat:r}){let g=document.getElementById("resultsCard");g&&(g.style.display="block");let i=v(o.water_lye_ratio)||f.waterRatio;B("lyeAdjustedOutput",N(v(o.lye_adjusted_g)||T)),B("waterOutput",N(v(o.water_g)||f.waterG)),B("batchYieldOutput",N(a)),B("lyeConcentrationOutput",z(v(o.lye_concentration_pct)||f.lyeConcentration)),B("waterRatioOutput",isFinite(i)&&i>0?d(i,2).toString():"--"),B("totalOilsOutput",N(n)),B("superfatOutput",z(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(h=>e.ui.pulseValue(document.getElementById(h)))}function E({showAlerts:o,lyeTotals:T,purity:f,waterData:a}){if(!o)return;T.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),f<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${d(f,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function F({serviceResult:o,validation:T,selection:f,superfat:a,purity:n,waterMethod:r,waterPct:g,lyeConcentrationInput:i,waterRatioInput:h,showAlerts:c}){var K;let m=o.lye_type||f.lyeType||"NaOH",s=v(o.total_oils_g)||T.totals.totalWeight,A=v(o.superfat_pct),p=isFinite(A)?A:a,t={sapAvg:v(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},S=v(o.lye_pure_g),_=v(o.lye_adjusted_g),k=v(o.lye_purity_pct)||n,w=o.water_method||r,W=v(o.water_pct)||g,D=v(o.lye_concentration_input_pct)||i,U=v(o.water_ratio_input)||h,u={waterG:v(o.water_g),lyeConcentration:v(o.lye_concentration_pct),waterRatio:v(o.water_lye_ratio)},I=o.results_card||{},b=o.quality_report||{},L=C(o.oils||T.oils),O={waterG:u.waterG,lyeAdjusted:_,totalOils:s,waterMethod:w,waterPct:W,lyeConcentrationInput:D,waterRatioInput:U,lyeConcentration:u.lyeConcentration,waterRatio:u.waterRatio};e.runnerInputs.updateStageWaterSummary(O),e.runnerInputs.updateLiveCalculationPreview(O);let x=o.additives||G;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(x);let H=v(I.batch_yield_g)||s+_+u.waterG+x.fragranceG+x.lactateG+x.sugarG+x.saltG+x.citricG;return(K=e.mold)!=null&&K.updateWetBatterWarning&&e.mold.updateWetBatterWarning(H),P({resultsCard:I,lyeAdjusted:_,waterData:u,batchYield:H,totalOils:s,superfat:p}),e.ui.updateResultsWarnings(u),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:b.qualities||{},fattyPercent:b.fatty_acids_pct||{},coveragePct:v(b.coverage_pct),iodine:v(b.iodine),ins:v(b.ins),sapAvg:t.sapAvg,superfat:p,waterData:u,additives:x,oils:L,totalOils:s,warnings:b.warnings||[]}),e.additives.updateVisualGuidance({tips:b.visual_guidance||[]}),e.stages.updateStageStatuses(),E({showAlerts:c,lyeTotals:t,purity:k,waterData:u}),$.lastCalc={totalOils:s,oils:L,lyeType:m,superfat:p,purity:k,lyePure:S,lyeAdjusted:_,water:u.waterG,waterMethod:w,waterPct:W,lyeConcentration:u.lyeConcentration,waterRatio:u.waterRatio,sapAvg:t.sapAvg,usedSapFallback:t.usedFallback,additives:x,batchYield:H,qualityReport:b,export:o.export||null},$.lastCalc}e.runnerRender={applyServiceResult:F}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state,v=e.runnerInputs,N=e.runnerQuota,z=e.runnerService,$=e.runnerRender;async function G(C={}){var P;let B={consumeQuota:!1,showAlerts:!0,...C};try{B.showAlerts&&e.ui.clearSoapAlerts();let E=v.validateCalculation();if(!E.ok)return v.updateStageWaterSummary(null),v.updateLiveCalculationPreview(null),(P=e.mold)!=null&&P.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),B.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${E.errors.map(g=>`<li>${g}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(B.consumeQuota&&!N.canConsumeCalcQuota())return null;let F=v.readSuperfatInput(),o=v.getLyeSelection(),T=v.sanitizeLyeInputs(),f=(d.calcRequestSeq||0)+1;d.calcRequestSeq=f;let a=z.buildServicePayload({oils:E.oils,selection:o,superfat:F,purity:T.purity,waterMethod:T.waterMethod,waterPct:T.waterPct,lyeConcentration:T.lyeConcentration,waterRatio:T.waterRatio,totalOils:E.totals.totalWeight}),n=await z.calculateWithSoapService(a);if(f!==d.calcRequestSeq)return d.lastCalc;if(!n)return B.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=$.applyServiceResult({serviceResult:n,validation:E,selection:o,superfat:F,purity:T.purity,waterMethod:T.waterMethod,waterPct:T.waterPct,lyeConcentrationInput:T.lyeConcentration,waterRatioInput:T.waterRatio,showAlerts:B.showAlerts});return B.consumeQuota&&N.consumeCalcQuota(),r}catch{return B.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...C)=>v.getLyeSelection(...C),applyLyeSelection:(...C)=>v.applyLyeSelection(...C),setWaterMethod:(...C)=>v.setWaterMethod(...C),updateLiveCalculationPreview:(...C)=>v.updateLiveCalculationPreview(...C),calculateAll:G,buildSoapRecipePayload:(...C)=>e.recipePayload.buildSoapRecipePayload(...C),buildLineRow:(...C)=>e.recipePayload.buildLineRow(...C),addStubLine:(...C)=>e.recipePayload.addStubLine(...C),maybeShowSignupModal:(...C)=>N.maybeShowSignupModal(...C)}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{formatTime:d,getStorage:v}=e.helpers,N="soap_tool_state_v2";function z(f,a){let n=[];return document.querySelectorAll(`#${f} .row`).forEach(g=>{var A,p,t;let i=(p=(A=g.querySelector(".tool-typeahead"))==null?void 0:A.value)==null?void 0:p.trim(),h=((t=g.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",c=g.querySelector(".tool-qty"),m=g.querySelector(".tool-unit"),s=c&&c.value!==""?e.helpers.toNumber(c.value):null;!i&&!h||(a==="container"?n.push({name:i||"",global_item_id:h?parseInt(h):null,quantity:s&&s>0?s:1}):n.push({name:i||"",global_item_id:h?parseInt(h):null,quantity:s&&s>=0?s:0,unit:(m==null?void 0:m.value)||"gram"}))}),n}function $(){let f=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var p,t,S,_,k,w,W,D,U,u;let n=((t=(p=a.querySelector(".oil-typeahead"))==null?void 0:p.value)==null?void 0:t.trim())||"",r=((S=a.querySelector(".oil-grams"))==null?void 0:S.value)||"",g=((_=a.querySelector(".oil-percent"))==null?void 0:_.value)||"",i=((k=a.querySelector(".oil-sap-koh"))==null?void 0:k.value)||"",h=((w=a.querySelector(".oil-iodine"))==null?void 0:w.value)||"",c=((W=a.querySelector(".oil-fatty"))==null?void 0:W.value)||"",m=((D=a.querySelector(".oil-gi-id"))==null?void 0:D.value)||"",s=((U=a.querySelector(".oil-default-unit"))==null?void 0:U.value)||"",A=((u=a.querySelector(".oil-category"))==null?void 0:u.value)||"";!n&&!r&&!g&&!m||f.push({name:n,grams:r,percent:g,sap:i,iodine:h,fattyRaw:c,gi:m,defaultUnit:s,categoryName:A})}),f}function G(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let f=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var s,A,p,t,S,_,k;let r=((A=(s=n.querySelector(".fragrance-typeahead"))==null?void 0:s.value)==null?void 0:A.trim())||"",g=((p=n.querySelector(".fragrance-grams"))==null?void 0:p.value)||"",i=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",h=((S=n.querySelector(".fragrance-gi-id"))==null?void 0:S.value)||"",c=((_=n.querySelector(".fragrance-default-unit"))==null?void 0:_.value)||"",m=((k=n.querySelector(".fragrance-category"))==null?void 0:k.value)||"";!r&&!g&&!i&&!h||f.push({name:r,grams:g,percent:i,gi:h,defaultUnit:c,categoryName:m})}),f}function C(f,a){let n=document.getElementById("oilRows");if(!n||!f)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=f.name||"",r.querySelector(".oil-grams").value=f.grams||"",r.querySelector(".oil-percent").value=f.percent||"",r.querySelector(".oil-sap-koh").value=f.sap||"",r.querySelector(".oil-iodine").value=f.iodine||"",r.querySelector(".oil-fatty").value=f.fattyRaw||"",r.querySelector(".oil-gi-id").value=f.gi||"";let g=r.querySelector(".oil-default-unit");g&&(g.value=f.defaultUnit||"");let i=r.querySelector(".oil-category");i&&(i.value=f.categoryName||"");let h=Array.from(n.children);return a>=h.length?n.appendChild(r):n.insertBefore(r,h[a]),r}function B(){var n,r,g,i,h,c,m,s,A,p,t,S,_,k,w,W,D,U,u,I,b,L,O,x,H,K,Q;let f=v();if(!f)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:$(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((g=document.getElementById("lyePurity"))==null?void 0:g.value)||"100",water_method:((i=document.getElementById("waterMethod"))==null?void 0:i.value)||"percent",water_pct:((h=document.getElementById("waterPct"))==null?void 0:h.value)||"",lye_concentration:((c=document.getElementById("lyeConcentration"))==null?void 0:c.value)||"",water_ratio:((m=document.getElementById("waterRatio"))==null?void 0:m.value)||""},additives:{fragrances:G(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((s=document.getElementById("additiveLactateName"))==null?void 0:s.value)||"",lactate_gi:((A=document.getElementById("additiveLactateGi"))==null?void 0:A.value)||"",lactate_unit:((p=document.getElementById("additiveLactateUnit"))==null?void 0:p.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((S=document.getElementById("additiveSugarName"))==null?void 0:S.value)||"",sugar_gi:((_=document.getElementById("additiveSugarGi"))==null?void 0:_.value)||"",sugar_unit:((k=document.getElementById("additiveSugarUnit"))==null?void 0:k.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((W=document.getElementById("additiveSaltName"))==null?void 0:W.value)||"",salt_gi:((D=document.getElementById("additiveSaltGi"))==null?void 0:D.value)||"",salt_unit:((U=document.getElementById("additiveSaltUnit"))==null?void 0:U.value)||"",salt_category:((u=document.getElementById("additiveSaltCategory"))==null?void 0:u.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((I=document.getElementById("additiveCitricName"))==null?void 0:I.value)||"",citric_gi:((b=document.getElementById("additiveCitricGi"))==null?void 0:b.value)||"",citric_unit:((L=document.getElementById("additiveCitricUnit"))==null?void 0:L.value)||"",citric_category:((O=document.getElementById("additiveCitricCategory"))==null?void 0:O.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((x=document.getElementById("moldShape"))==null?void 0:x.value)||"loaf",cylinder_correction:!!((H=document.getElementById("moldCylinderCorrection"))!=null&&H.checked),cylinder_factor:((K=document.getElementById("moldCylinderFactor"))==null?void 0:K.value)||"0.85"},quality:{preset:((Q=document.getElementById("qualityPreset"))==null?void 0:Q.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(j=>j.id)},lines:{ingredients:z("tool-ingredients","ingredient"),consumables:z("tool-consumables","consumable"),containers:z("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"basics",selections:[]},updated_at:Date.now()};try{f.setItem(N,JSON.stringify(a));let j=document.getElementById("soapLastSaved");j&&(j.textContent=d(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function P(){var i,h,c;let f=v();if(!f)return;let a=f.getItem(N);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let m=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);m&&(m.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(s=>{let A=e.oils.buildOilRow();A.querySelector(".oil-typeahead").value=s.name||"",A.querySelector(".oil-grams").value=s.grams||"",A.querySelector(".oil-percent").value=s.percent||"",A.querySelector(".oil-sap-koh").value=s.sap||"",A.querySelector(".oil-iodine").value=s.iodine||"",A.querySelector(".oil-fatty").value=s.fattyRaw||"",A.querySelector(".oil-gi-id").value=s.gi||"";let p=A.querySelector(".oil-default-unit");p&&(p.value=s.defaultUnit||"");let t=A.querySelector(".oil-category");t&&(t.value=s.categoryName||""),r.appendChild(A)})),n.lye_form){let m=document.getElementById("lyeSuperfat");m&&(m.value=n.lye_form.superfat||"5");let s=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);s&&(s.checked=!0);let A=document.getElementById("lyePurity");A&&(A.value=n.lye_form.lye_purity||"100");let p=document.getElementById("waterMethod");p&&(p.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let S=document.getElementById("lyeConcentration");S&&(S.value=n.lye_form.lye_concentration||"");let _=document.getElementById("waterRatio");_&&(_.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let m=document.getElementById("fragranceRows");if(m&&((i=e.fragrances)!=null&&i.buildFragranceRow)){m.innerHTML="";let x=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(x)x.forEach(H=>{let K=e.fragrances.buildFragranceRow();K.querySelector(".fragrance-typeahead").value=H.name||"",K.querySelector(".fragrance-grams").value=H.grams||"",K.querySelector(".fragrance-percent").value=H.percent||"",K.querySelector(".fragrance-gi-id").value=H.gi||"";let Q=K.querySelector(".fragrance-default-unit");Q&&(Q.value=H.defaultUnit||"");let j=K.querySelector(".fragrance-category");j&&(j.value=H.categoryName||""),m.appendChild(K)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let H=e.fragrances.buildFragranceRow();H.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",H.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",H.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",m.appendChild(H)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let s=document.getElementById("additiveLactateName");s&&(s.value=n.additives.lactate_name||"");let A=document.getElementById("additiveLactateGi");A&&(A.value=n.additives.lactate_gi||"");let p=document.getElementById("additiveLactateUnit");p&&(p.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let S=document.getElementById("additiveSugarName");S&&(S.value=n.additives.sugar_name||"");let _=document.getElementById("additiveSugarGi");_&&(_.value=n.additives.sugar_gi||"");let k=document.getElementById("additiveSugarUnit");k&&(k.value=n.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let W=document.getElementById("additiveSaltName");W&&(W.value=n.additives.salt_name||"");let D=document.getElementById("additiveSaltGi");D&&(D.value=n.additives.salt_gi||"");let U=document.getElementById("additiveSaltUnit");U&&(U.value=n.additives.salt_unit||"");let u=document.getElementById("additiveSaltCategory");u&&(u.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let I=document.getElementById("additiveCitricName");I&&(I.value=n.additives.citric_name||"");let b=document.getElementById("additiveCitricGi");b&&(b.value=n.additives.citric_gi||"");let L=document.getElementById("additiveCitricUnit");L&&(L.value=n.additives.citric_unit||"");let O=document.getElementById("additiveCitricCategory");O&&(O.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let m=document.getElementById("moldShape");m&&(m.value=n.mold.shape||"loaf");let s=document.getElementById("moldCylinderCorrection");s&&(s.checked=!!n.mold.cylinder_correction);let A=document.getElementById("moldCylinderFactor");A&&(A.value=n.mold.cylinder_factor||"0.85");let p=document.getElementById("oilTotalTarget");(h=e.mold)!=null&&h.syncMoldPctFromTarget&&((c=e.mold)!=null&&c.syncTargetFromMold)&&(e.units.toGrams(p==null?void 0:p.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let m=document.getElementById("qualityPreset");if(m){let s=n.quality.preset||"balanced",A=Array.from(m.options).find(p=>p.value===s);m.value=A?s:"balanced"}document.querySelectorAll(".quality-focus").forEach(s=>{s.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(s.id)})}function g(m,s,A){let p=document.getElementById(m);p&&(p.innerHTML="",(s||[]).forEach(t=>{let S=e.runner.buildLineRow(A),_=S.querySelector(".tool-typeahead"),k=S.querySelector(".tool-gi-id"),w=S.querySelector(".tool-qty"),W=S.querySelector(".tool-unit");_&&(_.value=t.name||""),k&&(k.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),W&&t.unit&&Array.from(W.options).find(U=>U.value===t.unit)&&(W.value=t.unit),p.appendChild(S)}))}if(n.lines&&(g("tool-ingredients",n.lines.ingredients,"ingredient"),g("tool-consumables",n.lines.consumables,"consumable"),g("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let m=document.getElementById("soapLastSaved");m&&(m.textContent=d(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let E=null;function F(){E&&clearTimeout(E),E=setTimeout(B,350)}let o=null;function T(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:B,restoreState:P,serializeLines:z,serializeOils:$,restoreOilRow:C,queueStateSave:F,queueAutoCalc:T}})(window);(function(R){"use strict";var ye,he;let e=R.SoapTool=R.SoapTool||{},{LACTATE_CATEGORY_SET:d,SUGAR_CATEGORY_SET:v,SALT_CATEGORY_SET:N,CITRIC_CATEGORY_SET:z}=e.constants,{round:$,toNumber:G,clamp:C}=e.helpers,{formatWeight:B,formatPercent:P,toGrams:E}=e.units,F=e.state;async function o(){var Y;let l=F.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return l||((Y=e.ui)!=null&&Y.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function T(l){let Y=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(y=>{var ue,ce,le,de;let q=(ce=(ue=y.querySelector(".fragrance-typeahead"))==null?void 0:ue.value)==null?void 0:ce.trim(),V=(le=y.querySelector(".fragrance-grams"))==null?void 0:le.value,X=(de=y.querySelector(".fragrance-percent"))==null?void 0:de.value,ee=E(V),te=C(G(X),0);ee<=0&&te>0&&l>0&&(ee=l*(te/100)),!(ee<=0&&te<=0&&!q)&&(!te&&ee>0&&l>0&&(te=ee/l*100),Y.push({name:q||"Fragrance/Essential Oils",grams:ee,pct:te}))}),Y}function f(l){var ee,te,ue,ce,le,de,pe,re;let Y=[];if(!l)return Y;let y=((te=(ee=document.getElementById("additiveLactateName"))==null?void 0:ee.value)==null?void 0:te.trim())||"Sodium Lactate",q=((ce=(ue=document.getElementById("additiveSugarName"))==null?void 0:ue.value)==null?void 0:ce.trim())||"Sugar",V=((de=(le=document.getElementById("additiveSaltName"))==null?void 0:le.value)==null?void 0:de.trim())||"Salt",X=((re=(pe=document.getElementById("additiveCitricName"))==null?void 0:pe.value)==null?void 0:re.trim())||"Citric Acid";return l.lactateG>0&&Y.push({name:y,grams:l.lactateG,pct:l.lactatePct}),l.sugarG>0&&Y.push({name:q,grams:l.sugarG,pct:l.sugarPct}),l.saltG>0&&Y.push({name:V,grams:l.saltG,pct:l.saltPct}),l.citricG>0&&Y.push({name:X,grams:l.citricG,pct:l.citricPct}),Y}function a(l){var X,ee;if(Array.isArray((X=l==null?void 0:l.export)==null?void 0:X.csv_rows)&&l.export.csv_rows.length)return l.export.csv_rows;let Y=l.totalOils||0,y=[["section","name","quantity","unit","percent"]];return y.push(["Summary","Lye Type",l.lyeType||"","",""]),y.push(["Summary","Superfat",$(l.superfat||0,2),"%",""]),y.push(["Summary","Lye Purity",$(l.purity||0,1),"%",""]),y.push(["Summary","Water Method",l.waterMethod||"","",""]),y.push(["Summary","Water %",$(l.waterPct||0,1),"%",""]),y.push(["Summary","Lye Concentration",$(l.lyeConcentration||0,1),"%",""]),y.push(["Summary","Water Ratio",$(l.waterRatio||0,2),"",""]),y.push(["Summary","Total Oils",$(Y,2),"gram",""]),y.push(["Summary","Batch Yield",$(l.batchYield||0,2),"gram",""]),(l.oils||[]).forEach(te=>{let ue=Y>0?$(te.grams/Y*100,2):"";y.push(["Oils",te.name||"Oil",$(te.grams||0,2),"gram",ue])}),l.lyeAdjusted>0&&y.push(["Lye",l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",$(l.lyeAdjusted,2),"gram",""]),l.water>0&&y.push(["Water","Distilled Water",$(l.water,2),"gram",""]),T(Y).forEach(te=>{y.push(["Fragrance",te.name,$(te.grams||0,2),"gram",$(te.pct||0,2)])}),f(l.additives).forEach(te=>{y.push(["Additives",te.name,$(te.grams||0,2),"gram",$(te.pct||0,2)])}),((ee=l.additives)==null?void 0:ee.citricLyeG)>0&&y.push(["Additives","Extra Lye for Citric Acid",$(l.additives.citricLyeG,2),"gram",""]),y}function n(l){if(l==null)return"";let Y=String(l);return/[",\n]/.test(Y)?`"${Y.replace(/"/g,'""')}"`:Y}function r(l){return l.map(Y=>Y.map(n).join(",")).join(`
`)}function g(l,Y){let y=new Blob([l],{type:"text/csv;charset=utf-8;"}),q=URL.createObjectURL(y),V=document.createElement("a");V.href=q,V.download=Y,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(q)}function i(l){var de,pe;if(typeof((de=l==null?void 0:l.export)==null?void 0:de.sheet_html)=="string"&&l.export.sheet_html.trim())return l.export.sheet_html;let Y=l.totalOils||0,y=(l.oils||[]).map(re=>({name:re.name||"Oil",grams:re.grams||0,pct:Y>0?re.grams/Y*100:0})),q=T(Y),V=f(l.additives),X=new Date().toLocaleString(),ee=y.length?y.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${B(re.grams)}</td>
            <td class="text-end">${P(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',te=q.length?q.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${B(re.grams)}</td>
            <td class="text-end">${P(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',ue=V.length?V.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${B(re.grams)}</td>
            <td class="text-end">${P(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',ce=l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",le=((pe=l.additives)==null?void 0:pe.citricLyeG)>0?`<tr><td>Extra Lye for Citric Acid</td><td class="text-end">${B(l.additives.citricLyeG)}</td></tr>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${X}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${l.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${P(l.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${P(l.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${B(Y)}</span></div>
      <div class="summary-item"><span>Water</span><span>${B(l.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${B(l.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${l.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${P(l.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ee}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${ce}</td><td class="text-end">${B(l.lyeAdjusted||0)}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${B(l.water||0)}</td></tr>
        ${le}
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${te}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ue}</tbody>
    </table>
  </body>
</html>`}let h=document.getElementById("oilRows"),c=document.getElementById("addOil"),m=document.getElementById("normalizeOils");c&&h&&(c.dataset.bound="direct",c.addEventListener("click",function(){h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),m&&(m.dataset.bound="direct",m.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),h&&h.addEventListener("input",function(l){l.target.classList.contains("oil-grams")&&(F.lastOilEdit={row:l.target.closest(".oil-row"),field:"grams"}),l.target.classList.contains("oil-percent")&&(F.lastOilEdit={row:l.target.closest(".oil-row"),field:"percent"}),(l.target.classList.contains("oil-grams")||l.target.classList.contains("oil-percent")||l.target.classList.contains("oil-typeahead"))&&(l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),h&&h.addEventListener("focusin",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row"))}),h&&h.addEventListener("focusout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),l.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams"),l.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")}),h&&h.addEventListener("keydown",function(l){l.key==="Enter"&&(l.target.classList.contains("oil-grams")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams")),l.target.classList.contains("oil-percent")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")))}),h&&h.addEventListener("mouseover",function(l){if(!l.target.classList.contains("oil-typeahead"))return;let Y=l.target.closest(".oil-row");!Y||Y===F.lastPreviewRow||(F.lastPreviewRow=Y,e.oils.setSelectedOilProfileFromRow(Y))}),h&&h.addEventListener("mouseout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),h&&h.addEventListener("click",function(l){let Y=l.target.closest(".oil-profile-open");if(Y){let q=Y.closest(".oil-row");if(q){e.oils.setSelectedOilProfileFromRow(q);let V=document.getElementById("oilProfileModal");V&&R.bootstrap&&bootstrap.Modal.getOrCreateInstance(V).show()}return}let y=l.target.closest(".remove-oil");if(y){let q=y.closest(".oil-row");q&&(F.lastRemovedOil=e.oils.serializeOilRow(q),F.lastRemovedOilIndex=Array.from(q.parentElement.children).indexOf(q),e.ui.showUndoToast("Oil removed.")),q&&F.lastOilEdit&&F.lastOilEdit.row===q&&(F.lastOilEdit=null,e.oils.clearSelectedOilProfile()),q&&q.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let s=document.getElementById("fragranceRows"),A=document.getElementById("addFragrance");A&&s&&(A.dataset.bound="direct",A.addEventListener("click",function(){s.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),s&&(s.addEventListener("input",function(l){l.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"grams"}),l.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"percent"}),(l.target.classList.contains("fragrance-grams")||l.target.classList.contains("fragrance-percent")||l.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),s.addEventListener("click",function(l){let Y=l.target.closest(".remove-fragrance");if(!Y)return;let y=Y.closest(".fragrance-row");y&&y.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let p=document.getElementById("soapStageTabContent"),t=()=>{if(!p)return null;let l=p.querySelector(".tab-pane.active")||p.querySelector(".tab-pane.show.active");return l?l.querySelector(".soap-stage-body")||l:null},S=()=>{p&&p.addEventListener("wheel",l=>{let Y=l.target;if(!(Y instanceof HTMLElement))return;let y=Y.closest('input[type="number"]');if(!(y instanceof HTMLInputElement))return;let q=t();if(!(q instanceof HTMLElement)||q.scrollHeight<=q.clientHeight+1)return;document.activeElement===y&&typeof y.blur=="function"&&y.blur();let V=q.scrollTop<=0,X=q.scrollTop+q.clientHeight>=q.scrollHeight-1;l.deltaY<0&&V||l.deltaY>0&&X||(q.scrollTop+=l.deltaY,l.preventDefault())},{passive:!1})};p&&(p.addEventListener("click",l=>{let Y=l.target.closest("[data-stage-action]"),y=l.target.closest("[data-soap-action]");if(!Y&&!y)return;if(l.preventDefault(),l.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),y){if(y.dataset.bound==="direct")return;let X=y.dataset.soapAction;X==="add-oil"&&h&&(h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),X==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),X==="add-fragrance"&&s&&(s.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let q=Y.dataset.stageAction,V=Number(Y.dataset.stageIndex);Number.isNaN(V)||(q==="prev"&&e.stages.openStageByIndex(Math.max(0,V-1)),q==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,V+1)),q==="reset"&&e.stages.resetStage(V+1))}),S());let _=document.getElementById("soapStageTabList"),k=()=>{if(!_)return;_.querySelectorAll(".nav-item").forEach(Y=>Y.classList.remove("is-expanded"));let l=_.querySelector(".nav-link.active");l&&l.closest(".nav-item")&&l.closest(".nav-item").classList.add("is-expanded")};_&&(_.addEventListener("shown.bs.tab",()=>{k(),e.layout.scheduleStageHeightSync()}),k());let w=document.getElementById("resultsCardToggle"),W=document.getElementById("resultsCard");w&&W&&w.addEventListener("click",()=>{W.classList.toggle("is-collapsed");let l=W.classList.contains("is-collapsed");w.setAttribute("aria-expanded",(!l).toString());let Y=l?"Expand formula details":"Collapse formula details";w.setAttribute("aria-label",Y),w.setAttribute("title",Y);let y=w.querySelector("i");y&&(y.classList.toggle("fa-chevron-down",l),y.classList.toggle("fa-chevron-up",!l))}),document.querySelectorAll('input[name="weight_unit"]').forEach(l=>{l.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let D=()=>{var l;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(l=e.mold)!=null&&l.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},U=document.getElementById("oilTotalTarget");U&&U.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let u=document.getElementById("waterMethod");u&&u.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(l=>{l.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(l=>{let Y=document.getElementById(l);Y&&["input","change"].forEach(y=>{Y.addEventListener(y,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].forEach(l=>{let Y=document.getElementById(l);Y&&Y.addEventListener("input",()=>{e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),[{weightId:"additiveLactateWeight"},{weightId:"additiveSugarWeight"},{weightId:"additiveSaltWeight"},{weightId:"additiveCitricWeight"}].forEach(({weightId:l})=>{let Y=document.getElementById(l);Y&&Y.addEventListener("input",()=>{let y=e.oils.getTotalOilsGrams();y&&(e.additives.updateAdditivesOutput(y),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}),document.querySelectorAll(".additive-typeahead").forEach(l=>{l.addEventListener("input",()=>{e.storage.queueStateSave()})});let b=document.getElementById("qualityPreset");b&&b.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(l=>{l.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let L=document.getElementById("applyQualityTargets");L&&L.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(l=>{l.addEventListener("click",()=>e.quality.applyQualityTargets()),l.addEventListener("keydown",Y=>{(Y.key==="Enter"||Y.key===" ")&&(Y.preventDefault(),e.quality.applyQualityTargets())})});let O=document.getElementById("moldWaterWeight");O&&O.addEventListener("input",function(){e.mold.syncTargetFromMold(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let x=document.getElementById("moldOilPct");x&&x.addEventListener("input",function(){e.mold.syncTargetFromMold(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let H=document.getElementById("moldShape");H&&H.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let K=document.getElementById("moldCylinderCorrection");K&&K.addEventListener("change",function(){e.mold.syncTargetFromMold(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Q=document.getElementById("moldCylinderFactor");Q&&Q.addEventListener("input",function(){e.mold.syncTargetFromMold(),D(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(l=>{l.addEventListener("click",function(){let Y=this.dataset.stubKind,y=this.dataset.stubName;e.runner.addStubLine(Y,y),e.storage.queueStateSave()})});let j=document.getElementById("soapToolPage");j&&(j.addEventListener("click",function(l){l.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),j.addEventListener("input",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses(),e.ui.flashStage(l.target.closest(".soap-stage-card")))}),j.addEventListener("change",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses())}));let M=document.getElementById("addToolIngredient");M&&M.addEventListener("click",function(){let l=document.getElementById("tool-ingredients");l&&l.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let J=document.getElementById("addToolConsumable");J&&J.addEventListener("click",function(){let l=document.getElementById("tool-consumables");l&&l.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let Z=document.getElementById("addToolContainer");Z&&Z.addEventListener("click",function(){let l=document.getElementById("tool-containers");l&&l.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let ne=document.getElementById("calcLyeBtn");ne&&ne.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let oe=document.getElementById("saveSoapTool");oe&&oe.addEventListener("click",async function(){try{let l=F.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!l)return;let Y=e.runner.buildSoapRecipePayload(l);F.lastRecipePayload=Y;try{let y=e.helpers.getStorage();y&&y.setItem("soap_recipe_payload",JSON.stringify(Y))}catch{}R.SOAP_RECIPE_DTO=Y,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let me=document.getElementById("exportSoapCsv");me&&me.addEventListener("click",async function(){var q;let l=await o();if(!l)return;let Y=a(l),y=typeof((q=l==null?void 0:l.export)==null?void 0:q.csv_text)=="string"&&l.export.csv_text?l.export.csv_text:r(Y);g(y,"soap_formula.csv")});let fe=document.getElementById("printSoapSheet");fe&&fe.addEventListener("click",async function(){var q;let l=await o();if(!l)return;let Y=i(l),y=R.open("","_blank","width=960,height=720");if(!y){(q=e.ui)!=null&&q.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}y.document.open(),y.document.write(Y),y.document.close(),y.focus(),y.onload=()=>{y.print()}});let se=document.getElementById("soapUndoRemove");se&&se.addEventListener("click",()=>{F.lastRemovedOil&&(e.storage.restoreOilRow(F.lastRemovedOil,F.lastRemovedOilIndex||0),F.lastRemovedOil=null,F.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let l=document.getElementById("soapMobileDrawer"),Y=document.getElementById("soapMobileDrawerContent"),y=document.getElementById("soapMobileDrawerTitle"),q=document.getElementById("soapDrawerEmpty"),V=document.getElementById("soapDrawerClose"),X=document.getElementById("soapQualityCard"),ee=document.getElementById("resultsCard");if(!l||!Y||!y||!X||!ee)return;let te=X.parentElement,ue=ee.parentElement,ce=new Map,le=null,de=()=>R.matchMedia("(max-width: 767px)").matches,pe=ae=>ae==="quality"?X:ee,re=ae=>ae==="quality"?te:ue,ve=ae=>ae==="quality"?"Display":"Results",Te=ae=>{let ge=ce.get(ae);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",ce.set(ae,ge)),ge.style.height=`${ae.offsetHeight}px`,ae.parentElement&&ae.parentElement!==Y&&!ge.parentElement&&ae.parentElement.insertBefore(ge,ae)},Se=ae=>{ae&&(Te(ae),Y.appendChild(ae))},Ie=(ae,ge)=>{let Ee=ce.get(ae);Ee&&Ee.parentElement?Ee.replaceWith(ae):ge&&ae.parentElement!==ge&&ge.appendChild(ae)},_e=()=>{if(!q)return;let ae=le==="results",ge=getComputedStyle(ee).display!=="none";q.classList.toggle("d-none",!ae||ge)},Ce=ae=>{de()&&(le&&le!==ae&&Ie(pe(le),re(le)),Se(pe(ae)),y.textContent=ve(ae),le=ae,l.classList.add("is-open"),_e())},be=()=>{le&&(Ie(pe(le),re(le)),le=null,l.classList.remove("is-open"),_e())};l.querySelectorAll("[data-drawer-target]").forEach(ae=>{ae.addEventListener("click",()=>{let ge=ae.dataset.drawerTarget;ge&&(l.classList.contains("is-open")&&le===ge?be():Ce(ge))})}),V&&V.addEventListener("click",be),R.addEventListener("resize",()=>{!de()&&le&&be()}),new MutationObserver(()=>_e()).observe(ee,{attributes:!0,attributeFilter:["style","class"]})})(),R.addEventListener("resize",e.layout.scheduleStageHeightSync),R.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",d,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",v,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",N,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",z,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),h&&!h.querySelector(".oil-row")&&h.appendChild(e.oils.buildOilRow()),s&&!s.querySelector(".fragrance-row")&&(ye=e.fragrances)!=null&&ye.buildFragranceRow&&s.appendChild(e.fragrances.buildFragranceRow()),(he=e.fragrances)!=null&&he.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);})();
//# sourceMappingURL=soap_tool_bundle.min.js.map
