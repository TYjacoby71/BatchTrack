!function(e){"use strict";const t=e.SoapTool=e.SoapTool||{},{round:n,toNumber:o,clamp:a}=t.helpers,{formatWeight:l,formatPercent:i}=t.units;function r(){const e=document.querySelector('input[name="lye_type"]:checked')?.value||"NaOH",t=document.getElementById("lyePurity"),n=t?.value;let a=o(t?.value);const l="NaOH"===e?"NaOH":"KOH";return""!==n&&null!=n&&isFinite(a)||(a=100),{selected:e,lyeType:l,purity:a}}function u(e=null,t=null){const o=document.getElementById("stageWaterOutput"),a=document.getElementById("stageWaterComputedHint"),i=t||e?.waterMethod||document.getElementById("waterMethod")?.value||"percent";if(o){const t=e&&isFinite(e.waterG)&&e.waterG>0;o.textContent=t?l(e.waterG):"--"}if(a)if(!e||!isFinite(e.totalOils)||e.totalOils<=0)a.textContent=`Set oils in Stage 2 to calculate water. ${function(e){return"concentration"===e?"Concentration mode uses lye amount, so superfat and purity change water.":"ratio"===e?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}(i)}`;else{if("concentration"===i){const t=e.lyeConcentrationInput||e.lyeConcentration||0;return void(a.textContent=`Using ${n(t,1)}% lye concentration from ${l(e.lyeAdjusted||0)} lye.`)}if("ratio"===i){const t=e.waterRatioInput||e.waterRatio||0;return void(a.textContent=`Using ${n(t,2)} : 1 water-to-lye ratio from ${l(e.lyeAdjusted||0)} lye.`)}a.textContent=`Using ${n(e.waterPct||0,1)}% of total oils (${l(e.totalOils)}).`}}function c(e=null,t=null){const a=document.getElementById("lyeWaterPreviewAnchor"),r=document.getElementById("lyePreview"),u=document.getElementById("waterPreview"),c=document.getElementById("concPreview"),s=document.getElementById("ratioPreview");if(!(a||r||u||c||s))return;const d=(e,t)=>{e&&(e.textContent=t)},y=t||e?.waterMethod||document.getElementById("waterMethod")?.value||"percent",m=o(e?.totalOils),p=o(e?.lyeAdjusted),g=o(e?.waterG);if(m<=0||p<=0)return d(a,"Based on -- oils. All values update live as you change inputs."),d(r,"--"),d(u,"--"),d(c,"--"),void d(s,"--");const w=o(e?.lyeConcentration)>0?o(e?.lyeConcentration):p+g>0?p/(p+g)*100:0,f=o(e?.waterRatio)>0?o(e?.waterRatio):p>0?g/p:0;if(d(a,`Based on ${l(m)} oils. All values update live as you change inputs.`),d(r,l(p)),d(u,l(g)),d(c,w>0?i(w):"--"),d(s,f>0?`${n(f,2)} : 1`:"--"),"concentration"===y){const t=o(e?.lyeConcentrationInput);t>0&&d(c,i(t))}if("ratio"===y){const t=o(e?.waterRatioInput);t>0&&d(s,`${n(t,2)} : 1`)}}t.runnerInputs={getLyeSelection:r,applyLyeSelection:function(){const e=document.getElementById("lyePurity"),t=r();if(e)if(e.removeAttribute("readonly"),"KOH90"===t.selected){const e=document.getElementById("lyePurityHint");e&&(e.textContent="90% KOH selected. Safe default purity is 90%.")}else{const e=document.getElementById("lyePurityHint");e&&(e.textContent="Safe default is 100%.")}},setWaterMethod:function(){const e=document.getElementById("waterMethod")?.value||"percent";document.querySelectorAll(".water-input").forEach(t=>{t.classList.toggle("d-none",t.dataset.method!==e)}),u(null,e),c(null,e)},updateStageWaterSummary:u,updateLiveCalculationPreview:c,validateCalculation:function(){const e=t.oils.updateOilTotals(),n=e.totalWeight,l=e.totalPct,i=[],r=t.oils.collectOilData(),u=t.oils.getOilTargetGrams(),c=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(e=>a(o(e.value),0)).some(e=>e>0);return(!r.length||n<=0)&&i.push("Add at least one oil with a weight or percent."),!u&&n<=0&&c&&i.push("Enter a total oils target or weights to convert percentages."),u>0&&l>0&&Math.abs(l-100)>.5&&i.push("Oil percentages should total 100% (use Normalize to fix)."),u>0&&n>u+.01?i.push("Oil weights exceed the mold target."):!u&&l>100.01&&i.push("Oil percentages exceed 100%."),{ok:0===i.length,errors:i,totals:e,oils:r}},readSuperfatInput:function(){const e=document.getElementById("lyeSuperfat"),t=e?.value;let n=o(t);return""!==t&&null!=t&&isFinite(n)||(n=5),n},sanitizeLyeInputs:function(){let e=r().purity;return isFinite(e)||(e=100),{purity:e,waterMethod:document.getElementById("waterMethod")?.value||"percent",waterPct:o(document.getElementById("waterPct")?.value),lyeConcentration:o(document.getElementById("lyeConcentration")?.value),waterRatio:o(document.getElementById("waterRatio")?.value)}}}}(window);