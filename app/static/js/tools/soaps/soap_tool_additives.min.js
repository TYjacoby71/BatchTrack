!function(e){"use strict";const t=e.SoapTool=e.SoapTool||{},{toNumber:a,round:n,clamp:r,buildSoapcalcSearchBuilder:i}=t.helpers,{formatWeight:c,toGrams:l,fromGrams:o}=t.units,{FRAGRANCE_CATEGORY_SET:u}=t.constants,d=t.state;function g({pctId:e,weightId:n}){const i=document.getElementById(e),c=i?.value;if(""!==c&&null!=c)return a(c);const o=r(t.oils?.getTotalOilsGrams?.()||0,0);if(o<=0)return 0;const u=l(document.getElementById(n)?.value);return u<=0?0:u/o*100}function s(e){const t=(e,t)=>{const a=document.getElementById(e);a&&("INPUT"===a.tagName?a.value=t:a.textContent=t)},r=e=>e>0?n(o(e),2):"";t("additiveLactateWeight",r(a(e?.lactateG))),t("additiveSugarWeight",r(a(e?.sugarG))),t("additiveSaltWeight",r(a(e?.saltG))),t("additiveCitricWeight",r(a(e?.citricG))),t("additiveCitricLyeOut",c(a(e?.citricLyeG)))}function m(e){return e&&"object"==typeof e&&(e.ingredient&&e.ingredient.ingredient_category_name||e.ingredient_category_name||e.ingredient_category&&e.ingredient_category.name)||null}t.additives={attachAdditiveTypeahead:function(a,n,r,c,l){const o=document.getElementById(a),u=document.getElementById(n),d=c?document.getElementById(c):null,g=l?document.getElementById(l):null,s=o?.parentElement?.querySelector('[data-role="suggestions"]');if(!o||!s||"function"!=typeof e.attachMergedInventoryGlobalTypeahead)return;const y=i();e.attachMergedInventoryGlobalTypeahead({inputEl:o,listEl:s,mode:"public",giHiddenEl:u,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:y,searchType:"ingredient",resultFilter:(e,t)=>{const a=m(e);return a?r.has(a):"inventory"===t},requireHidden:!1,onSelection:function(e){d&&(d.value=e?.default_unit||""),g&&(g.value=e?.ingredient_category_name||""),t.storage.queueStateSave()}}),o.addEventListener("input",function(){this.value.trim()||(d&&(d.value=""),g&&(g.value=""))})},collectAdditiveSettings:function(){return{lactatePct:g({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:g({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:g({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:g({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:document.getElementById("additiveLactateName")?.value?.trim()||"Sodium Lactate",sugarName:document.getElementById("additiveSugarName")?.value?.trim()||"Sugar",saltName:document.getElementById("additiveSaltName")?.value?.trim()||"Salt",citricName:document.getElementById("additiveCitricName")?.value?.trim()||"Citric Acid"}},applyComputedOutputs:s,updateAdditivesOutput:function(e){const n=r(a(e),0),i=t.state?.lastCalc,c=r(a(i?.totalOils),0),l=Math.abs(c-n)<.01,o=i?.additives&&l?i.additives:{lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0};return s(o),o},updateVisualGuidance:function(e){const t=document.getElementById("soapVisualGuidanceList");if(!t)return;const a=Array.isArray(e?.tips)&&e.tips.length?e.tips:["No visual flags detected for this formula."];t.innerHTML=a.map(e=>`<li>${e}</li>`).join("")}},t.fragrances={buildFragranceRow:function(){const a=document.getElementById("fragranceRowTemplate"),n=a?.content?.querySelector(".fragrance-row")?.cloneNode(!0);return n?(n.querySelectorAll("input").forEach(e=>{e.value=""}),function(a){const n=a.querySelector(".fragrance-typeahead"),r=a.querySelector(".fragrance-gi-id"),c=a.querySelector(".fragrance-default-unit"),l=a.querySelector(".fragrance-category"),o=a.querySelector('[data-role="suggestions"]');if(!n||!o||"function"!=typeof e.attachMergedInventoryGlobalTypeahead)return;const d=i();e.attachMergedInventoryGlobalTypeahead({inputEl:n,listEl:o,mode:"public",giHiddenEl:r,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:d,searchType:"ingredient",resultFilter:(e,t)=>{const a=m(e);return a?u.has(a):"inventory"===t},requireHidden:!1,onSelection:function(e){c&&(c.value=e?.default_unit||""),l&&(l.value=e?.ingredient_category_name||""),t.storage.queueStateSave()}}),n.addEventListener("input",function(){this.value.trim()||(c&&(c.value=""),l&&(l.value=""))})}(n),n.querySelectorAll(".unit-suffix").forEach(e=>{e.dataset.suffix=d.currentUnit}),n):document.createElement("div")},updateFragranceTotals:function(e){const i=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),o=r(e||t.oils.getTotalOilsGrams()||0,0);let u=0,d=0;i.forEach(e=>{const t=e.querySelector(".fragrance-grams"),n=e.querySelector(".fragrance-percent");let i=l(t?.value),c=r(a(n?.value),0);o>0&&(i<=0&&c>0?i=o*(c/100):c<=0&&i>0&&(c=i/o*100)),i>0&&(u+=i),d+=c});const g=document.getElementById("fragrancePercentTotal");g&&(g.textContent=n(d,2));const s=document.getElementById("fragranceTotalComputed");return s&&(s.textContent=u>0?c(u):"--"),{totalGrams:u,totalPct:d}},collectFragranceData:function(){const e=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(t=>{const a=t.querySelector(".fragrance-typeahead")?.value?.trim()||"",n=t.querySelector(".fragrance-grams")?.value||"",r=t.querySelector(".fragrance-percent")?.value||"",i=t.querySelector(".fragrance-gi-id")?.value||"",c=t.querySelector(".fragrance-default-unit")?.value||"",l=t.querySelector(".fragrance-category")?.value||"";(a||n||r||i)&&e.push({name:a,grams:n,percent:r,gi:i,defaultUnit:c,categoryName:l})}),e}}}(window);