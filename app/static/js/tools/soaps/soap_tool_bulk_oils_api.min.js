(function(window){'use strict';const SoapTool=window.SoapTool=window.SoapTool||{};const bulk=SoapTool.bulkOils=SoapTool.bulkOils||{};const shared=bulk.shared;const render=bulk.render;if(!shared||!render)return;const{PAGE_SIZE,getRefs,ensureModalState,normalizeCatalogRecord,}=shared;const{refreshCatalogStatus,normalizeServerSortKey,applyLocalSelectionSortIfNeeded,renderVisibleRecords,updateStatusText,}=render;function resetVisibleCatalogForFetch(){const modalState=ensureModalState();const refs=getRefs();modalState.visibleRecords=[];modalState.offset=0;modalState.totalCount=0;modalState.hasMore=true;if(refs.bodyEl)refs.bodyEl.innerHTML='';if(refs.scrollEl)refs.scrollEl.scrollTop=0;}
async function fetchCatalogPage({reset=false}={}){const modalState=ensureModalState();const refs=getRefs();if(!refs.modalEl)return;if(modalState.loading&&!reset)return;if(!modalState.hasMore&&!reset)return;if(reset){resetVisibleCatalogForFetch();}
const requestToken=modalState.requestToken+1;modalState.requestToken=requestToken;modalState.loading=true;refreshCatalogStatus();const params=new URLSearchParams();params.set('mode',modalState.mode);params.set('offset',String(modalState.offset));params.set('limit',String(PAGE_SIZE));params.set('q',modalState.query||'');params.set('sort_key',normalizeServerSortKey(modalState.sortKey));params.set('sort_dir',modalState.sortDir==='desc'?'desc':'asc');try{const response=await fetch(`/tools/api/soap/oils-catalog?${params.toString()}`);if(!response.ok){throw new Error('Unable to load oils catalog');}
const payload=await response.json();if(!payload||payload.success!==true||!payload.result||!Array.isArray(payload.result.records)){throw new Error('Invalid oils catalog response');}
if(requestToken!==modalState.requestToken){return;}
const records=payload.result.records.map(normalizeCatalogRecord);const nextOffset=Math.max(0,parseInt(payload.result.next_offset,10)||(modalState.offset+records.length));const totalCount=Math.max(records.length,parseInt(payload.result.count,10)||0);const hasMore=!!payload.result.has_more;records.forEach(record=>{modalState.recordByKey[record.key]=record;});modalState.visibleRecords=reset?records.slice():modalState.visibleRecords.concat(records);modalState.offset=nextOffset;modalState.totalCount=totalCount;modalState.hasMore=hasMore;applyLocalSelectionSortIfNeeded();renderVisibleRecords();}catch(_){if(requestToken===modalState.requestToken){updateStatusText('Unable to load oils catalog.');}
throw _;}finally{if(requestToken===modalState.requestToken){modalState.loading=false;refreshCatalogStatus();}}}
bulk.api={fetchCatalogPage,};})(window);
