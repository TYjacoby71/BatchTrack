!function(e){"use strict";const t=e.SoapTool=e.SoapTool||{},{LACTATE_CATEGORY_SET:a,SUGAR_CATEGORY_SET:n,SALT_CATEGORY_SET:s,CITRIC_CATEGORY_SET:i}=t.constants,{round:o,toNumber:r,clamp:l}=t.helpers,{formatWeight:d,formatPercent:c,toGrams:u}=t.units,g=t.state;async function m(){const e=g.lastCalc||await t.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return e||(t.ui?.showSoapAlert&&t.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function p(e){const t=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{const n=a.querySelector(".fragrance-typeahead")?.value?.trim(),s=a.querySelector(".fragrance-grams")?.value,i=a.querySelector(".fragrance-percent")?.value;let o=u(s),d=l(r(i),0);o<=0&&d>0&&e>0&&(o=e*(d/100)),o<=0&&d<=0&&!n||(!d&&o>0&&e>0&&(d=o/e*100),t.push({name:n||"Fragrance/Essential Oils",grams:o,pct:d}))}),t}function y(e){const t=[];if(!e)return t;const a=document.getElementById("additiveLactateName")?.value?.trim()||"Sodium Lactate",n=document.getElementById("additiveSugarName")?.value?.trim()||"Sugar",s=document.getElementById("additiveSaltName")?.value?.trim()||"Salt",i=document.getElementById("additiveCitricName")?.value?.trim()||"Citric Acid";return e.lactateG>0&&t.push({name:a,grams:e.lactateG,pct:e.lactatePct}),e.sugarG>0&&t.push({name:n,grams:e.sugarG,pct:e.sugarPct}),e.saltG>0&&t.push({name:s,grams:e.saltG,pct:e.saltPct}),e.citricG>0&&t.push({name:i,grams:e.citricG,pct:e.citricPct}),t}function h(e){if(null==e)return"";const t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}const v=document.getElementById("oilRows"),S=document.getElementById("addOil"),f=document.getElementById("normalizeOils");S&&v&&(S.dataset.bound="direct",S.addEventListener("click",function(){v.appendChild(t.oils.buildOilRow()),t.stages.updateStageStatuses(),t.storage.queueStateSave()})),f&&(f.dataset.bound="direct",f.addEventListener("click",function(){t.oils.normalizeOils(),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc()})),v&&v.addEventListener("input",function(e){e.target.classList.contains("oil-grams")&&(g.lastOilEdit={row:e.target.closest(".oil-row"),field:"grams"}),e.target.classList.contains("oil-percent")&&(g.lastOilEdit={row:e.target.closest(".oil-row"),field:"percent"}),(e.target.classList.contains("oil-grams")||e.target.classList.contains("oil-percent")||e.target.classList.contains("oil-typeahead"))&&(e.target.classList.contains("oil-typeahead")&&t.oils.setSelectedOilProfileFromRow(e.target.closest(".oil-row")),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc())}),v&&v.addEventListener("focusin",function(e){e.target.classList.contains("oil-typeahead")&&t.oils.setSelectedOilProfileFromRow(e.target.closest(".oil-row"))}),v&&v.addEventListener("focusout",function(e){e.target.classList.contains("oil-typeahead")&&t.oils.clearSelectedOilProfile(),e.target.classList.contains("oil-grams")&&t.oils.validateOilEntry(e.target.closest(".oil-row"),"grams"),e.target.classList.contains("oil-percent")&&t.oils.validateOilEntry(e.target.closest(".oil-row"),"percent")}),v&&v.addEventListener("keydown",function(e){"Enter"===e.key&&(e.target.classList.contains("oil-grams")&&(e.preventDefault(),t.oils.validateOilEntry(e.target.closest(".oil-row"),"grams")),e.target.classList.contains("oil-percent")&&(e.preventDefault(),t.oils.validateOilEntry(e.target.closest(".oil-row"),"percent")))}),v&&v.addEventListener("mouseover",function(e){if(!e.target.classList.contains("oil-typeahead"))return;const a=e.target.closest(".oil-row");a&&a!==g.lastPreviewRow&&(g.lastPreviewRow=a,t.oils.setSelectedOilProfileFromRow(a))}),v&&v.addEventListener("mouseout",function(e){e.target.classList.contains("oil-typeahead")&&t.oils.clearSelectedOilProfile()}),v&&v.addEventListener("click",function(a){const n=a.target.closest(".oil-profile-open");if(n){const a=n.closest(".oil-row");if(a){t.oils.setSelectedOilProfileFromRow(a);const n=document.getElementById("oilProfileModal");if(n&&e.bootstrap){bootstrap.Modal.getOrCreateInstance(n).show()}}return}const s=a.target.closest(".remove-oil");if(s){const e=s.closest(".oil-row");e&&(g.lastRemovedOil=t.oils.serializeOilRow(e),g.lastRemovedOilIndex=Array.from(e.parentElement.children).indexOf(e),t.ui.showUndoToast("Oil removed.")),e&&g.lastOilEdit&&g.lastOilEdit.row===e&&(g.lastOilEdit=null,t.oils.clearSelectedOilProfile()),e&&e.remove(),t.oils.updateOilTotals(),t.stages.updateStageStatuses(),t.storage.queueStateSave()}});const E=document.getElementById("fragranceRows"),L=document.getElementById("addFragrance");L&&E&&(L.dataset.bound="direct",L.addEventListener("click",function(){E.appendChild(t.fragrances.buildFragranceRow()),t.fragrances.updateFragranceTotals(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.queueStateSave()})),E&&(E.addEventListener("input",function(e){e.target.classList.contains("fragrance-grams")&&(t.state.lastFragranceEdit={row:e.target.closest(".fragrance-row"),field:"grams"}),e.target.classList.contains("fragrance-percent")&&(t.state.lastFragranceEdit={row:e.target.closest(".fragrance-row"),field:"percent"}),(e.target.classList.contains("fragrance-grams")||e.target.classList.contains("fragrance-percent")||e.target.classList.contains("fragrance-typeahead"))&&(t.fragrances.updateFragranceTotals(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc())}),E.addEventListener("click",function(e){const a=e.target.closest(".remove-fragrance");if(!a)return;const n=a.closest(".fragrance-row");n&&n.remove(),t.fragrances.updateFragranceTotals(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc()}));const w=document.getElementById("soapStageTabContent"),b=()=>{w&&w.addEventListener("wheel",e=>{const t=e.target;if(!(t instanceof HTMLElement))return;const a=t.closest('input[type="number"]');if(!(a instanceof HTMLInputElement))return;const n=(()=>{if(!w)return null;const e=w.querySelector(".tab-pane.active")||w.querySelector(".tab-pane.show.active");return e?e.querySelector(".soap-stage-body")||e:null})();if(!(n instanceof HTMLElement))return;if(n.scrollHeight<=n.clientHeight+1)return;document.activeElement===a&&"function"==typeof a.blur&&a.blur();const s=n.scrollTop<=0,i=n.scrollTop+n.clientHeight>=n.scrollHeight-1;e.deltaY<0&&s||e.deltaY>0&&i||(n.scrollTop+=e.deltaY,e.preventDefault())},{passive:!1})};w&&(w.addEventListener("click",e=>{const a=e.target.closest("[data-stage-action]"),n=e.target.closest("[data-soap-action]");if(!a&&!n)return;if(e.preventDefault(),e.stopPropagation(),document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur(),n){if("direct"===n.dataset.bound)return;const e=n.dataset.soapAction;return"add-oil"===e&&v&&(v.appendChild(t.oils.buildOilRow()),t.stages.updateStageStatuses(),t.storage.queueStateSave()),"normalize-oils"===e&&(t.oils.normalizeOils(),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc()),void("add-fragrance"===e&&E&&(E.appendChild(t.fragrances.buildFragranceRow()),t.fragrances.updateFragranceTotals(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.queueStateSave()))}const s=a.dataset.stageAction,i=Number(a.dataset.stageIndex);Number.isNaN(i)||("prev"===s&&t.stages.openStageByIndex(Math.max(0,i-1)),"next"===s&&t.stages.openStageByIndex(Math.min(t.constants.STAGE_CONFIGS.length-1,i+1)),"reset"===s&&t.stages.resetStage(i+1))}),b());const T=document.getElementById("soapStageTabList"),O=()=>{if(!T)return;T.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("is-expanded"));const e=T.querySelector(".nav-link.active");e&&e.closest(".nav-item")&&e.closest(".nav-item").classList.add("is-expanded")};T&&(T.addEventListener("shown.bs.tab",()=>{O(),t.layout.scheduleStageHeightSync()}),O());const q=document.getElementById("resultsCardToggle"),x=document.getElementById("resultsCard");q&&x&&q.addEventListener("click",()=>{x.classList.toggle("is-collapsed");const e=x.classList.contains("is-collapsed");q.setAttribute("aria-expanded",(!e).toString());const t=e?"Expand formula details":"Collapse formula details";q.setAttribute("aria-label",t),q.setAttribute("title",t);const a=q.querySelector("i");a&&(a.classList.toggle("fa-chevron-down",e),a.classList.toggle("fa-chevron-up",!e))}),document.querySelectorAll('input[name="weight_unit"]').forEach(e=>{e.addEventListener("change",function(){t.units.setUnit(this.value),t.storage.queueStateSave()})});const A=document.getElementById("oilTotalTarget");A&&A.addEventListener("input",function(){t.mold.syncMoldPctFromTarget(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()});const C=document.getElementById("waterMethod");C&&C.addEventListener("change",function(){t.runner.setWaterMethod(),t.storage.queueStateSave(),t.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(e=>{e.addEventListener("change",function(){t.runner.applyLyeSelection(),t.additives.updateAdditivesOutput(t.oils.getTotalOilsGrams()),t.storage.queueStateSave(),t.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(e=>{const a=document.getElementById(e);a&&["input","change"].forEach(e=>{a.addEventListener(e,()=>{t.storage.queueStateSave(),t.storage.queueAutoCalc()})})}),["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].forEach(e=>{const a=document.getElementById(e);a&&a.addEventListener("input",()=>{t.additives.updateAdditivesOutput(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc()})});[{weightId:"additiveLactateWeight"},{weightId:"additiveSugarWeight"},{weightId:"additiveSaltWeight"},{weightId:"additiveCitricWeight"}].forEach(({weightId:e})=>{const a=document.getElementById(e);a&&a.addEventListener("input",()=>{const e=t.oils.getTotalOilsGrams();e&&(t.additives.updateAdditivesOutput(e),t.stages.updateStageStatuses(),t.storage.queueStateSave(),t.storage.queueAutoCalc())})}),document.querySelectorAll(".additive-typeahead").forEach(e=>{e.addEventListener("input",()=>{t.storage.queueStateSave()})});const I=document.getElementById("qualityPreset");I&&I.addEventListener("change",function(){t.quality.updateQualityTargets(),t.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(e=>{e.addEventListener("change",function(){t.quality.updateQualityTargets(),t.storage.queueStateSave()})});const B=document.getElementById("applyQualityTargets");B&&B.addEventListener("click",function(){t.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(e=>{e.addEventListener("click",()=>t.quality.applyQualityTargets()),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.quality.applyQualityTargets())})});const R=document.getElementById("moldWaterWeight");R&&R.addEventListener("input",function(){t.mold.syncTargetFromMold(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()});const P=document.getElementById("moldOilPct");P&&P.addEventListener("input",function(){t.mold.syncTargetFromMold(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()});const F=document.getElementById("moldShape");F&&F.addEventListener("change",function(){t.mold.updateMoldShapeUI(),t.mold.syncTargetFromMold(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()});const G=document.getElementById("moldCylinderCorrection");G&&G.addEventListener("change",function(){t.mold.syncTargetFromMold(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()});const k=document.getElementById("moldCylinderFactor");k&&k.addEventListener("input",function(){t.mold.syncTargetFromMold(),t.oils.scaleOilsToTarget(),t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.stubKind,a=this.dataset.stubName;t.runner.addStubLine(e,a),t.storage.queueStateSave()})});const M=document.getElementById("soapToolPage");M&&(M.addEventListener("click",function(e){e.target.classList.contains("tool-remove")&&t.storage.queueStateSave()}),M.addEventListener("input",function(e){e.target.matches("input, select, textarea")&&(t.storage.queueStateSave(),t.ui.validateNumericField(e.target),t.stages.updateStageStatuses(),t.ui.flashStage(e.target.closest(".soap-stage-card")))}),M.addEventListener("change",function(e){e.target.matches("input, select, textarea")&&(t.storage.queueStateSave(),t.ui.validateNumericField(e.target),t.stages.updateStageStatuses())}));const $=document.getElementById("addToolIngredient");$&&$.addEventListener("click",function(){const e=document.getElementById("tool-ingredients");e&&e.appendChild(t.runner.buildLineRow("ingredient")),t.storage.queueStateSave()});const _=document.getElementById("addToolConsumable");_&&_.addEventListener("click",function(){const e=document.getElementById("tool-consumables");e&&e.appendChild(t.runner.buildLineRow("consumable")),t.storage.queueStateSave()});const N=document.getElementById("addToolContainer");N&&N.addEventListener("click",function(){const e=document.getElementById("tool-containers");e&&e.appendChild(t.runner.buildLineRow("container")),t.storage.queueStateSave()});const H=document.getElementById("calcLyeBtn");H&&H.addEventListener("click",async function(){await t.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),t.storage.queueStateSave()});const W=document.getElementById("saveSoapTool");W&&W.addEventListener("click",async function(){try{const a=g.lastCalc||await t.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!a)return;const n=t.runner.buildSoapRecipePayload(a);g.lastRecipePayload=n;try{const e=t.helpers.getStorage();e&&e.setItem("soap_recipe_payload",JSON.stringify(n))}catch(e){}e.SOAP_RECIPE_DTO=n,t.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch(e){t.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});const U=document.getElementById("exportSoapCsv");U&&U.addEventListener("click",async function(){const e=await m();if(!e)return;const t=function(e){if(Array.isArray(e?.export?.csv_rows)&&e.export.csv_rows.length)return e.export.csv_rows;const t=e.totalOils||0,a=[["section","name","quantity","unit","percent"]];return a.push(["Summary","Lye Type",e.lyeType||"","",""]),a.push(["Summary","Superfat",o(e.superfat||0,2),"%",""]),a.push(["Summary","Lye Purity",o(e.purity||0,1),"%",""]),a.push(["Summary","Water Method",e.waterMethod||"","",""]),a.push(["Summary","Water %",o(e.waterPct||0,1),"%",""]),a.push(["Summary","Lye Concentration",o(e.lyeConcentration||0,1),"%",""]),a.push(["Summary","Water Ratio",o(e.waterRatio||0,2),"",""]),a.push(["Summary","Total Oils",o(t,2),"gram",""]),a.push(["Summary","Batch Yield",o(e.batchYield||0,2),"gram",""]),(e.oils||[]).forEach(e=>{const n=t>0?o(e.grams/t*100,2):"";a.push(["Oils",e.name||"Oil",o(e.grams||0,2),"gram",n])}),e.lyeAdjusted>0&&a.push(["Lye","KOH"===e.lyeType?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",o(e.lyeAdjusted,2),"gram",""]),e.water>0&&a.push(["Water","Distilled Water",o(e.water,2),"gram",""]),p(t).forEach(e=>{a.push(["Fragrance",e.name,o(e.grams||0,2),"gram",o(e.pct||0,2)])}),y(e.additives).forEach(e=>{a.push(["Additives",e.name,o(e.grams||0,2),"gram",o(e.pct||0,2)])}),e.additives?.citricLyeG>0&&a.push(["Additives","Extra Lye for Citric Acid",o(e.additives.citricLyeG,2),"gram",""]),a}(e),a="string"==typeof e?.export?.csv_text&&e.export.csv_text?e.export.csv_text:function(e){return e.map(e=>e.map(h).join(",")).join("\n")}(t);!function(e,t){const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(a),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}(a,"soap_formula.csv")});const D=document.getElementById("printSoapSheet");D&&D.addEventListener("click",async function(){const a=await m();if(!a)return;const n=function(e){if("string"==typeof e?.export?.sheet_html&&e.export.sheet_html.trim())return e.export.sheet_html;const t=e.totalOils||0,a=(e.oils||[]).map(e=>({name:e.name||"Oil",grams:e.grams||0,pct:t>0?e.grams/t*100:0})),n=p(t),s=y(e.additives),i=(new Date).toLocaleString(),o=a.length?a.map(e=>`\n          <tr>\n            <td>${e.name}</td>\n            <td class="text-end">${d(e.grams)}</td>\n            <td class="text-end">${c(e.pct)}</td>\n          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',r=n.length?n.map(e=>`\n          <tr>\n            <td>${e.name}</td>\n            <td class="text-end">${d(e.grams)}</td>\n            <td class="text-end">${c(e.pct)}</td>\n          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',l=s.length?s.map(e=>`\n          <tr>\n            <td>${e.name}</td>\n            <td class="text-end">${d(e.grams)}</td>\n            <td class="text-end">${c(e.pct)}</td>\n          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',u="KOH"===e.lyeType?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",g=e.additives?.citricLyeG>0?`<tr><td>Extra Lye for Citric Acid</td><td class="text-end">${d(e.additives.citricLyeG)}</td></tr>`:"";return`<!doctype html>\n<html>\n  <head>\n    <meta charset="utf-8">\n    <title>Soap Formula Sheet</title>\n    <style>\n      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }\n      h1 { font-size: 20px; margin-bottom: 4px; }\n      h2 { font-size: 16px; margin-top: 20px; }\n      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }\n      table { width: 100%; border-collapse: collapse; margin-top: 8px; }\n      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }\n      th { background: #f3f4f6; text-align: left; }\n      .text-end { text-align: right; }\n      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }\n      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }\n      .text-muted { color: #666; }\n    </style>\n  </head>\n  <body>\n    <h1>Soap Formula Sheet</h1>\n    <div class="meta">Generated ${i}</div>\n    <div class="summary-grid">\n      <div class="summary-item"><span>Lye type</span><span>${e.lyeType||"--"}</span></div>\n      <div class="summary-item"><span>Superfat</span><span>${c(e.superfat||0)}</span></div>\n      <div class="summary-item"><span>Lye purity</span><span>${c(e.purity||0)}</span></div>\n      <div class="summary-item"><span>Total oils</span><span>${d(t)}</span></div>\n      <div class="summary-item"><span>Water</span><span>${d(e.water||0)}</span></div>\n      <div class="summary-item"><span>Batch yield</span><span>${d(e.batchYield||0)}</span></div>\n      <div class="summary-item"><span>Water method</span><span>${e.waterMethod||"--"}</span></div>\n      <div class="summary-item"><span>Lye concentration</span><span>${c(e.lyeConcentration||0)}</span></div>\n    </div>\n\n    <h2>Oils</h2>\n    <table>\n      <thead>\n        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>\n      </thead>\n      <tbody>${o}</tbody>\n    </table>\n\n    <h2>Lye & Water</h2>\n    <table>\n      <thead>\n        <tr><th>Item</th><th class="text-end">Weight</th></tr>\n      </thead>\n      <tbody>\n        <tr><td>${u}</td><td class="text-end">${d(e.lyeAdjusted||0)}</td></tr>\n        <tr><td>Distilled Water</td><td class="text-end">${d(e.water||0)}</td></tr>\n        ${g}\n      </tbody>\n    </table>\n\n    <h2>Fragrance & Essential Oils</h2>\n    <table>\n      <thead>\n        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>\n      </thead>\n      <tbody>${r}</tbody>\n    </table>\n\n    <h2>Additives</h2>\n    <table>\n      <thead>\n        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>\n      </thead>\n      <tbody>${l}</tbody>\n    </table>\n  </body>\n</html>`}(a),s=e.open("","_blank","width=960,height=720");s?(s.document.open(),s.document.write(n),s.document.close(),s.focus(),s.onload=()=>{s.print()}):t.ui?.showSoapAlert&&t.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3})});const Q=document.getElementById("soapUndoRemove");Q&&Q.addEventListener("click",()=>{g.lastRemovedOil&&(t.storage.restoreOilRow(g.lastRemovedOil,g.lastRemovedOilIndex||0),g.lastRemovedOil=null,g.lastRemovedOilIndex=null,t.oils.updateOilTotals(),t.storage.queueStateSave(),t.storage.queueAutoCalc())});(()=>{const t=document.getElementById("soapMobileDrawer"),a=document.getElementById("soapMobileDrawerContent"),n=document.getElementById("soapMobileDrawerTitle"),s=document.getElementById("soapDrawerEmpty"),i=document.getElementById("soapDrawerClose"),o=document.getElementById("soapQualityCard"),r=document.getElementById("resultsCard");if(!(t&&a&&n&&o&&r))return;const l=o.parentElement,d=r.parentElement,c=new Map;let u=null;const g=()=>e.matchMedia("(max-width: 767px)").matches,m=e=>"quality"===e?o:r,p=e=>"quality"===e?l:d,y=e=>{e&&((e=>{let t=c.get(e);t||(t=document.createElement("div"),t.className="soap-card-placeholder",c.set(e,t)),t.style.height=`${e.offsetHeight}px`,e.parentElement&&e.parentElement!==a&&!t.parentElement&&e.parentElement.insertBefore(t,e)})(e),a.appendChild(e))},h=(e,t)=>{const a=c.get(e);a&&a.parentElement?a.replaceWith(e):t&&e.parentElement!==t&&t.appendChild(e)},v=()=>{if(!s)return;const e="results"===u,t="none"!==getComputedStyle(r).display;s.classList.toggle("d-none",!e||t)},S=()=>{u&&(h(m(u),p(u)),u=null,t.classList.remove("is-open"),v())};t.querySelectorAll("[data-drawer-target]").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.drawerTarget;a&&(t.classList.contains("is-open")&&u===a?S():(e=>{g()&&(u&&u!==e&&h(m(u),p(u)),y(m(e)),n.textContent=(e=>"quality"===e?"Display":"Results")(e),u=e,t.classList.add("is-open"),v())})(a))})}),i&&i.addEventListener("click",S),e.addEventListener("resize",()=>{!g()&&u&&S()});new MutationObserver(()=>v()).observe(r,{attributes:!0,attributeFilter:["style","class"]})})(),e.addEventListener("resize",t.layout.scheduleStageHeightSync),e.addEventListener("load",t.layout.scheduleStageHeightSync),t.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",a,"additiveLactateUnit","additiveLactateCategory"),t.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",n,"additiveSugarUnit","additiveSugarCategory"),t.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",s,"additiveSaltUnit","additiveSaltCategory"),t.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",i,"additiveCitricUnit","additiveCitricCategory"),t.ui.applyHelperVisibility(),t.quality.initQualityTooltips(),t.runner.applyLyeSelection(),t.runner.setWaterMethod(),t.mold.updateMoldShapeUI(),t.quality.setQualityRangeBars(),t.units.updateUnitLabels(),t.quality.updateQualityTargets(),t.additives.updateAdditivesOutput(t.oils.getTotalOilsGrams()),t.stages.updateStageStatuses(),t.storage.restoreState(),v&&!v.querySelector(".oil-row")&&v.appendChild(t.oils.buildOilRow()),E&&!E.querySelector(".fragrance-row")&&t.fragrances?.buildFragranceRow&&E.appendChild(t.fragrances.buildFragranceRow()),t.fragrances?.updateFragranceTotals&&t.fragrances.updateFragranceTotals(t.oils.getTotalOilsGrams()),t.layout.scheduleStageHeightSync()}(window);