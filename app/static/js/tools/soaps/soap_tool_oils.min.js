!function(e){"use strict";const t=e.SoapTool=e.SoapTool||{},{round:l,toNumber:o,clamp:i,buildSoapcalcSearchBuilder:a}=t.helpers,{toGrams:r,fromGrams:n}=t.units,{OIL_CATEGORY_SET:c,OIL_TIP_RULES:s}=t.constants,{computeQualities:u}=t.calc,d=t.state;function f(l){const i=l.querySelector(".oil-typeahead"),r=l.querySelector(".oil-sap-koh"),n=l.querySelector(".oil-iodine"),s=l.querySelector(".oil-fatty"),u=l.querySelector(".oil-gi-id"),f=l.querySelector(".oil-default-unit"),y=l.querySelector(".oil-category"),m=l.querySelector('[data-role="suggestions"]');if(!i||!m||"function"!=typeof e.attachMergedInventoryGlobalTypeahead)return;const g=a();e.attachMergedInventoryGlobalTypeahead({inputEl:i,listEl:m,mode:"public",giHiddenEl:u,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:g,searchType:"ingredient",resultFilter:(e,t)=>function(e,t,l){const o=function(e){return e&&"object"==typeof e&&(e.ingredient&&e.ingredient.ingredient_category_name||e.ingredient_category_name||e.ingredient_category&&e.ingredient_category.name)||null}(e);if(!o)return"inventory"===l;return t.has(o)}(e,c,t),requireHidden:!1,onSelection:function(e){r&&(r.value=e?.saponification_value||""),n&&(n.value=e?.iodine_value||""),s&&(s.value=e?.fatty_acid_profile?JSON.stringify(e.fatty_acid_profile):""),f&&(f.value=e?.default_unit||""),y&&(y.value=e?.ingredient_category_name||""),function(e){if(!e)return void S();d.selectedOilProfile=e;let t=e.fatty_acid_profile||null;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t=null}h({name:e.text||e.display_name||e.name,sapKoh:o(e.saponification_value),iodine:o(e.iodine_value),fattyProfile:t})}(e),p(),t.storage.queueStateSave(),t.storage.queueAutoCalc()}}),i.addEventListener("input",function(){this.value.trim()||(r&&(r.value=""),n&&(n.value=""),s&&(s.value=""),u&&(u.value=""),f&&(f.value=""),y&&(y.value=""),S())})}function y(){const e=document.getElementById("oilTotalTarget"),l=r(e?.value);if(l>0)return l;const o=t.mold.getMoldSettings();return o.targetOils>0?o.targetOils:0}function m(e,t,l){if(!e)return;const o=e.querySelector(`[data-role="oil-${t}-hint"]`);o&&(l?(o.textContent=l,o.classList.add("is-visible")):(o.textContent="",o.classList.remove("is-visible")))}function g(e){e&&(e.classList.remove("oil-input-bounce"),e.offsetWidth,e.classList.add("oil-input-bounce"))}function p(e={}){e.skipEnforce||(d.wasCapped=!1);const a=Array.from(document.querySelectorAll("#oilRows .oil-row")),c=t.mold.getMoldSettings();let s=y();if(!s&&!c.targetOils){const e=function(e){const t=[];return e.forEach(e=>{const l=r(e.querySelector(".oil-grams")?.value),a=i(o(e.querySelector(".oil-percent")?.value),0);l>0&&a>0&&t.push(l/(a/100))}),t.length?t.reduce((e,t)=>e+t,0)/t.length:0}(a);if(e>0){s=e;const t=document.getElementById("oilTotalTarget");t&&!t.value&&(t.value=l(n(e),2))}}let u=0,f=0;if(a.forEach(e=>{const t=e.querySelector(".oil-grams"),a=e.querySelector(".oil-percent");let c=r(t?.value),y=i(o(a?.value),0);s>0&&(d.lastOilEdit&&d.lastOilEdit.row===e&&"percent"===d.lastOilEdit.field?(c=y>0?s*(y/100):0,t.value=y>0?l(n(c),2):""):c>0?(y=c/s*100,a.value=l(y,2)):y>0&&(c=s*(y/100),t.value=l(n(c),2)),f+=y),c>0&&(u+=c)}),s<=0&&(u>0?(f=0,a.forEach(e=>{const t=e.querySelector(".oil-grams"),o=e.querySelector(".oil-percent"),i=r(t?.value);if(i>0){const e=i/u*100;o.value=l(e,2),f+=e}})):f=a.reduce((e,t)=>e+i(o(t.querySelector(".oil-percent")?.value),0),0)),!e.skipEnforce&&c.targetOils>0&&u>c.targetOils+.01&&function(e,t){if(!d.lastOilEdit||!d.lastOilEdit.row)return!1;const o=d.lastOilEdit.row,i=e.reduce((e,t)=>t===o?e:e+r(t.querySelector(".oil-grams")?.value),0),a=Math.max(0,t-i),c=o.querySelector(".oil-grams"),s=o.querySelector(".oil-percent");return!(!c||!s||(c.value=a>0?l(n(a),2):"",s.value=a>0?l(a/t*100,2):"",d.wasCapped=!0,0))}(a,c.targetOils))return p({skipEnforce:!0});d.totalOilsGrams=u;const m=document.getElementById("oilTotalComputed");return m&&(m.textContent=u>0?`${l(n(u),2)} ${d.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=l(f,2),function({totalWeight:e,totalPct:t,target:o,capped:i}){const a=document.getElementById("oilLimitWarning");if(!a)return;const r=[];if(i&&r.push("Oil total hit the mold cap and was adjusted."),o>0&&e>o+.01){const t=e-o;r.push(`Oil weights exceed the target by ${l(n(t),2)} ${d.currentUnit}.`)}t>100.01&&r.push(`Oil percentages are over 100% by ${l(t-100,2)}%.`),r.length?(a.classList.remove("d-none"),a.innerHTML=`${r.join(" ")} Adjust oils or mold % to continue.`):(a.classList.add("d-none"),a.textContent="")}({totalWeight:u,totalPct:f,target:s,capped:d.wasCapped}),t.additives.updateAdditivesOutput(u),t.mold.updateMoldSuggested(),q(),{totalWeight:u,totalPct:f,target:s}}function v(){const e=[];return document.querySelectorAll("#oilRows .oil-row").forEach(t=>{const l=t.querySelector(".oil-typeahead")?.value?.trim(),i=r(t.querySelector(".oil-grams")?.value),a=o(t.querySelector(".oil-sap-koh")?.value),n=o(t.querySelector(".oil-iodine")?.value),c=t.querySelector(".oil-fatty")?.value||"",s=t.querySelector(".oil-gi-id")?.value||"",u=t.querySelector(".oil-default-unit")?.value||"",d=t.querySelector(".oil-category")?.value||"";let f=null;if(c)try{f=JSON.parse(c)}catch(e){f=null}i<=0||e.push({name:l||null,grams:i,sapKoh:a,iodine:n,fattyProfile:f,global_item_id:s?parseInt(s):null,default_unit:u||null,ingredient_category_name:d||null})}),e}function h({name:e,sapKoh:t,iodine:i,fattyProfile:a}={}){const r=document.getElementById("oilProfileFloat"),n=(e,t)=>{const l=document.getElementById(e);l&&(l.textContent=t)},c=e||"Pick an oil to preview";n("selectedOilName",c),n("selectedOilModalName",c),r&&r.classList.toggle("d-none",!e);const s=t>0?l(t,1):"--",d=i>0?l(i,1):"--";n("selectedOilSap",s),n("selectedOilModalSap",s),n("selectedOilIodine",d),n("selectedOilModalIodine",d);const f=a?u(a):{},y=(e,t)=>{const o=isFinite(t)&&t>0?l(t,1):"--";n(e,o)};y("selectedOilHardness",f.hardness),y("selectedOilModalHardness",f.hardness),y("selectedOilCleansing",f.cleansing),y("selectedOilModalCleansing",f.cleansing),y("selectedOilConditioning",f.conditioning),y("selectedOilModalConditioning",f.conditioning),y("selectedOilBubbly",f.bubbly),y("selectedOilModalBubbly",f.bubbly),y("selectedOilCreamy",f.creamy),y("selectedOilModalCreamy",f.creamy);["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(e=>{const t=`selectedOil${e.charAt(0).toUpperCase()}${e.slice(1)}`,i=`selectedOilModal${e.charAt(0).toUpperCase()}${e.slice(1)}`,r=a?o(a[e]):0,c=r>0?l(r,1):"--";n(t,c),n(i,c)})}function S(){d.selectedOilProfile=null,d.lastPreviewRow=null,h()}function q(){const e=document.getElementById("oilBlendTips");if(!e)return;const t=v().filter(e=>e.grams>0||e.percent>0);if(!t.length)return e.classList.add("d-none"),void(e.textContent="");const l=new Set;t.forEach(e=>{const t=(e.name||"").toLowerCase();if(t&&s.forEach(e=>{e.match.test(t)&&l.add(e.tip)}),e.fattyProfile&&"object"==typeof e.fattyProfile){const t=o(e.fattyProfile.lauric),i=o(e.fattyProfile.myristic),a=o(e.fattyProfile.palmitic),r=o(e.fattyProfile.stearic),n=o(e.fattyProfile.ricinoleic),c=o(e.fattyProfile.oleic),s=o(e.fattyProfile.linoleic),u=o(e.fattyProfile.linolenic);t+i>=30&&l.add(`${e.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),a+r>=40&&l.add(`${e.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),c>=60&&l.add(`${e.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),s+u>=20&&l.add(`${e.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),n>=60&&l.add(`${e.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});const i=Array.from(l).slice(0,6);if(!i.length)return e.classList.add("d-none"),void(e.textContent="");e.classList.remove("d-none"),e.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${i.map(e=>`<li>${e}</li>`).join("")}</ul>`}t.oils={attachOilTypeahead:f,buildOilRow:function(){const e=document.getElementById("oilRowTemplate"),t=e?.content?.querySelector(".oil-row")?.cloneNode(!0);return t?(t.querySelectorAll("input").forEach(e=>{e.value=""}),t.querySelectorAll(".form-text").forEach(e=>{const t=e.closest('.soap-field-stack, [class*="col-"]');t&&t.classList.add("soap-field")}),f(t),t.querySelectorAll(".unit-suffix").forEach(e=>{e.dataset.suffix=d.currentUnit}),t):document.createElement("div")},getOilTargetGrams:y,updateOilTotals:p,normalizeOils:function(){const e=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!e.length)return;const t=y();let a=e.reduce((e,t)=>e+i(o(t.querySelector(".oil-percent")?.value),0),0);!a&&t>0&&(a=e.reduce((e,l)=>{const o=r(l.querySelector(".oil-grams")?.value);return e+(o>0?o/t*100:0)},0)),a<=0||(e.forEach(e=>{const r=e.querySelector(".oil-percent"),c=e.querySelector(".oil-grams"),s=i(o(r.value),0)/a*100;r.value=l(s,2),t>0&&(c.value=s>0?l(n(t*(s/100)),2):"")}),p())},collectOilData:v,setSelectedOilProfileFromRow:function(e){if(!e)return;const t=e.querySelector(".oil-typeahead")?.value?.trim(),l=o(e.querySelector(".oil-sap-koh")?.value),i=o(e.querySelector(".oil-iodine")?.value),a=e.querySelector(".oil-fatty")?.value||"";let r=null;if(a)try{r=JSON.parse(a)}catch(e){r=null}h({name:t,sapKoh:l,iodine:i,fattyProfile:r})},clearSelectedOilProfile:S,updateOilTips:q,getTotalOilsGrams:function(){return d.totalOilsGrams||0},serializeOilRow:function(e){return e?{name:e.querySelector(".oil-typeahead")?.value||"",grams:e.querySelector(".oil-grams")?.value||"",percent:e.querySelector(".oil-percent")?.value||"",sap:e.querySelector(".oil-sap-koh")?.value||"",iodine:e.querySelector(".oil-iodine")?.value||"",fattyRaw:e.querySelector(".oil-fatty")?.value||"",gi:e.querySelector(".oil-gi-id")?.value||"",defaultUnit:e.querySelector(".oil-default-unit")?.value||"",categoryName:e.querySelector(".oil-category")?.value||""}:null},validateOilEntry:function(e,t,a={}){const c=y();if(!e||!c||c<=0)return void m(e,t,"");const s=e.querySelector(".oil-grams"),u=e.querySelector(".oil-percent"),f=function(e,t){if(!e||!t||t<=0)return{allowedGrams:null,allowedPct:null};const l=Array.from(document.querySelectorAll("#oilRows .oil-row")),a=l.reduce((t,l)=>l===e?t:t+r(l.querySelector(".oil-grams")?.value),0),n=l.reduce((t,l)=>l===e?t:t+i(o(l.querySelector(".oil-percent")?.value),0),0),c=Math.max(0,100-n),s=Math.max(0,t-a),u=t*c/100;return{allowedGrams:Math.max(0,Math.min(s,u)),allowedPct:c}}(e,c);if("grams"===t&&s){const o=r(s.value);let i="";if(o>c+.01?i="Entry exceeds the max oils allowed in stage 2.":null!==f.allowedGrams&&o>f.allowedGrams+.01&&(i=`Must be under ${l(n(f.allowedGrams),2)} ${d.currentUnit} to stay within the stage 2 oil limit.`),i){const o=null!==f.allowedGrams?l(n(f.allowedGrams),2):l(n(c),2);s.value=o>0?o:"",m(e,t,i),s.classList.add("oil-input-warning"),g(s),p()}else s.classList.remove("oil-input-warning"),m(e,t,"")}if("percent"===t&&u){const a=i(o(u.value),0);let r="";if(a>100.01?r="Entry exceeds the max oils allowed in stage 2.":null!==f.allowedPct&&a>f.allowedPct+.01&&(r=`Must be under ${l(f.allowedPct,2)}% to stay within the stage 2 oil limit.`),r){const o=null!==f.allowedPct?l(f.allowedPct,2):100;u.value=o>0?o:"",m(e,t,r),u.classList.add("oil-input-warning"),g(u),p()}else u.classList.remove("oil-input-warning"),m(e,t,"")}},scaleOilsToTarget:function(e,t={}){const a=Array.from(document.querySelectorAll("#oilRows .oil-row")),c=e??y(),s=!!t.force;if(!c||c<=0||!a.length)return void(d.lastOilTarget=c);const u=a.reduce((e,t)=>e+i(o(t.querySelector(".oil-percent")?.value),0),0),f=a.reduce((e,t)=>e+r(t.querySelector(".oil-grams")?.value),0);if(u<=0&&f<=0)d.lastOilTarget=c;else if(!(!s&&d.lastOilTarget&&Math.abs(d.lastOilTarget-c)<.01)){if(u>0)a.forEach(e=>{const t=e.querySelector(".oil-percent"),a=e.querySelector(".oil-grams"),r=i(o(t?.value),0),s=u>0?r/u:0;a&&(a.value=s>0?l(n(c*s),2):""),t&&(t.value=s>0?l(100*s,2):"")});else if(f>0){const e=c/f;a.forEach(t=>{const o=t.querySelector(".oil-grams"),i=t.querySelector(".oil-percent"),a=r(o?.value);if(o){const t=a>0?a*e:0;o.value=t>0?l(n(t),2):""}if(i){const e=r(o?.value);i.value=e>0?l(e/c*100,2):""}})}d.lastOilTarget=c,p({skipEnforce:!0})}}}}(window);