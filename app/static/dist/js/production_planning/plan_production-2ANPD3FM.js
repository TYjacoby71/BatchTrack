var R=class{constructor(e="APP"){this.context=e,this.debugEnabled=this._shouldEnableDebug()}_shouldEnableDebug(){if(new URLSearchParams(window.location.search).get("debug")==="true")return!0;let t=window.BT_STORAGE&&typeof window.BT_STORAGE.key=="function"?window.BT_STORAGE.key("batchtrack_debug"):"batchtrack_debug";return localStorage.getItem(t)==="true"}debug(e,...t){this.debugEnabled&&console.log(`\u{1F50D} ${this.context}: ${e}`,...t)}info(...e){console.info("\u2139\uFE0F",...e)}warn(...e){console.warn("\u26A0\uFE0F",...e)}error(...e){console.error("\u274C",...e)}perf(e,t){let n=performance.now()-t;console.log(`\u23F1\uFE0F ${e}: ${n.toFixed(2)}ms`)}},f=new R("APP");f.debugEnabled&&window.location.hostname.includes("replit.dev")&&console.log("\u{1F527} DEBUG MODE: Frontend debugging enabled");var v=class{constructor(e=3e4){this.cache=new Map,this.defaultTtl=e}get(e){if(this.cache.has(e)){let t=this.cache.get(e);if(Date.now()<t.expiresAt)return t.value;this.cache.delete(e)}return null}set(e,t,n){let s=Date.now()+(n||this.defaultTtl);this.cache.set(e,{value:t,expiresAt:s})}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}clearPrefix(e){for(let t of Array.from(this.cache.keys()))String(t).startsWith(e)&&this.cache.delete(t)}},B=new v,N=new v(3e4);var p={debug:(l,...e)=>f.debug(`CONTAINER_PLAN: ${l}`,...e),info:(l,...e)=>f.info(`CONTAINER_PLAN: ${l}`,...e),warn:(l,...e)=>f.warn(`CONTAINER_PLAN: ${l}`,...e),error:(l,...e)=>f.error(`CONTAINER_PLAN: ${l}`,...e)},k=class{constructor(e){this.container=e,this.fetchingPlan=!1,this.inflightKey=null}async fetchContainerPlan(e={}){var i,r,c,d,u,m,b;p.debug("fetchContainerPlan called");let t=(r=(i=this.container.main)==null?void 0:i.recipe)==null?void 0:r.id,n=((c=this.container.main)==null?void 0:c.scale)||parseFloat((d=document.getElementById("scaleInput"))==null?void 0:d.value)||1,s=(((m=(u=this.container.main)==null?void 0:u.recipe)==null?void 0:m.yield_amount)||1)*n,o=`containerPlan:${t}:${s}:${(b=this.container.main)==null?void 0:b.unit}`,a=B.get(o);if(a)return p.debug("Returning cached container plan"),this.container.containerPlan=a,this.container.displayContainerPlan(),a;if(this.fetchingPlan&&this.inflightKey===o)return p.debug("Fetch already in progress for same key, returning early"),null;if(this.fetchingPlan=!0,!this.container.main.recipe||!this.container.main.recipe.id)return p.error("Recipe data not available"),this.fetchingPlan=!1,null;if(!this.container.main.requiresContainers)return p.debug("Recipe does not require containers"),this.fetchingPlan=!1,null;p.debug("Fetching for recipe",this.container.main.recipe.id,"scale:",n,"yield:",s),this.inflightKey=o;try{let y={scale:n,yield_amount:s,yield_unit:this.container.main.unit,...e||{}},_=`/production-planning/recipe/${this.container.main.recipe.id}/auto-fill-containers`,g=await this.container.main.apiCall(_,y);return p.debug("Raw container plan response:",g),g&&typeof g=="object"?((g.drawer_payload||g.data&&g.data.drawer_payload)&&p.debug("\u{1F50D} FETCHER DEBUG: Received drawer payload in container response:",g),this.container.containerPlan=g,this.container.displayContainerPlan(),this.fetchingPlan=!1,g):(p.error("Invalid container plan format:",g),this.container.displayContainerError("Invalid container plan response"),this.fetchingPlan=!1,null)}catch(y){return p.error("Container plan failed:",y.message||y),this.container.displayContainerError(y.message||"Container plan failed"),this.fetchingPlan=!1,null}}clearCache(){this.fetchingPlan=!1,this.inflightKey=null,B.clearPrefix("containerPlan:")}};var E=class{constructor(e){this.container=e}displayPlan(){var s;let e=document.getElementById("containerResults"),t=(s=document.getElementById("autoFillEnabled"))==null?void 0:s.checked;if(!e){this.clearResults();return}if(!this.container.containerPlan){this.clearResults();return}if(!this.container.containerPlan.success){let o=this.container.containerPlan.error||this.container.containerPlan.message||"Container planning failed";this.displayError(o);return}let{container_selection:n}=this.container.containerPlan;if(!n||n.length===0){e.innerHTML='<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> No suitable containers found</div>';return}t?this.renderAutoFillResults(e,n):e.innerHTML='<p class="text-muted">Switch to auto-fill mode to see container recommendations, or add containers manually below.</p>'}renderAutoFillResults(e,t){let n='<div class="auto-fill-results">';t.length>1&&(n+=`
                <div class="alert alert-info mb-3">
                    <i class="fas fa-puzzle-piece"></i> 
                    <strong>Multi-Container Optimization:</strong> 
                    Using ${t.length} container types for optimal efficiency
                </div>
            `),t.forEach((s,o)=>{n+=this.renderContainerCard(s,o,!0)}),n+="</div>",e.innerHTML=n}renderContainerCard(e,t,n=!1){let s=e.stock_qty||e.available_quantity||e.quantity||0,o=e.container_name||"Unknown Container",a=e.quantity||e.containers_needed||0,i=this.formatCapacityDisplay(e),r=s>=a?"bg-success":"bg-warning";return`
            <div class="row align-items-center mb-3 p-3 border rounded ${n?"bg-success bg-opacity-10":"bg-light"}" data-container-card="${t}">
                <div class="col-md-3">
                    <label class="form-label small">Container Type</label>
                    <div class="form-control form-control-sm bg-light border-0">
                        <strong>${o}</strong>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Quantity Needed</label>
                    <div class="form-control form-control-sm bg-light border-0">
                        <strong>${a}</strong>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Capacity Each</label>
                    <div class="form-control form-control-sm bg-light border-0">
                        ${i}
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Available Stock</label>
                    <div class="badge ${r} fs-6">${s}</div>
                </div>
                <div class="col-md-1">
                    <div class="text-center">
                        <i class="fas fa-check-circle text-success" title="Optimal selection"></i>
                    </div>
                </div>
            </div>
        `}formatCapacityDisplay(e){let t=e.capacity||0,n=e.unit||"ml";return e.capacity_in_yield_unit&&e.yield_unit&&e.conversion_successful?`<strong>${e.capacity_in_yield_unit} ${e.yield_unit}</strong> (${t} ${n})`:e.capacity_in_yield_unit&&e.yield_unit?`<strong>${e.capacity_in_yield_unit} ${e.yield_unit}</strong> (${t} ${n})`:`${t} ${n}`}clearResults(){let e=document.getElementById("containerResults"),t=document.getElementById("containerSelectionRows");e&&(e.innerHTML='<p class="text-muted">Container management disabled</p>'),t&&(t.innerHTML="")}displayError(e){let t=document.getElementById("containerResults");t&&(t.innerHTML=`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> ${e}
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Cannot find suitable containers for this recipe</small>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('requiresContainers').click()">
                            <i class="fas fa-times"></i> Disable Container Requirement
                        </button>
                    </div>
                </div>
            `)}};var w=class{constructor(e){this.containerManager=e}update(){var n,s;if(!((n=this.containerManager.containerPlan)!=null&&n.success)){this.clear();return}let e=(s=document.getElementById("autoFillEnabled"))==null?void 0:s.checked,t;e?t=this.containerManager.containerPlan.containment_percentage||0:t=this.calculateManualContainment(),this.updateProgressBar(t)}calculateManualContainment(){let e=this.containerManager.main.baseYield*this.containerManager.main.scale,t=0;console.log("\u{1F50D} CONTAINMENT: Calculating for yield",e),document.querySelectorAll("[data-container-row]").forEach(s=>{var i,r;let o=s.querySelector(".container-select"),a=s.querySelector(".container-quantity");if(o&&a&&o.value){let c=(r=(i=this.containerManager.containerPlan)==null?void 0:i.container_selection)==null?void 0:r.find(d=>d.container_id==o.value);if(c){let d=parseInt(a.value)||0,m=(c.capacity_in_yield_unit||c.capacity)*d;t+=m,console.log("\u{1F50D} CONTAINMENT: Container",c.container_name,"x",d,"=",m)}}});let n=e>0?t/e*100:t>0?100:0;return console.log("\u{1F50D} CONTAINMENT: Total capacity",t,"vs yield",e,"=",n.toFixed(1),"%"),Math.min(n,100)}calculateLastContainerFillPercentage(){var s;if(!((s=this.containerManager.containerPlan)!=null&&s.container_selection))return 100;let e=this.getSelectedContainersFromDOM();if(e.length===0)return 100;let t=this.containerManager.main.baseYield*this.containerManager.main.scale;console.log("\u{1F50D} FILL CALC: Starting with yield",t,"containers:",e.length);let n=t;for(let o=0;o<e.length;o++){let a=e[o];if(o===e.length-1){let r=(a.quantity-1)*a.capacity;if(n-=r,n>0&&a.capacity>0){let c=n/a.capacity*100;return console.log("\u{1F50D} FILL CALC: Last container fill:",c.toFixed(1),"%"),Math.min(100,Math.max(0,c))}break}else{let i=a.quantity*a.capacity;n-=i}}return console.log("\u{1F50D} FILL CALC: Last container fill:","100.0","%"),100}getSelectedContainersFromDOM(){let e=[];try{document.querySelectorAll("[data-container-row]").forEach(t=>{var o,a;let n=t.querySelector(".container-select"),s=t.querySelector(".container-quantity");if(n&&s&&n.value){let i=(a=(o=this.containerManager.containerPlan)==null?void 0:o.container_selection)==null?void 0:a.find(r=>r.container_id==n.value);if(i){let r=parseInt(s.value)||1;e.push({...i,quantity:r})}}})}catch(t){console.log("\u{1F50D} FILL CALC: Error getting containers from DOM:",t)}return e}updateProgressBar(e){let t=document.getElementById("containmentProgressBar"),n=document.getElementById("containmentPercent"),s=document.getElementById("liveContainmentMessage"),o=Math.min(e,100),a=e;if(t&&(t.style.width=`${o}%`,t.textContent=`${a.toFixed(1)}%`,t.className=`progress-bar ${a>=100?"bg-success":"bg-warning"}`),n&&(n.textContent=`${a.toFixed(1)}%`),s){let i=this.getContainmentMessage(a);s.textContent=i.text,s.className=i.className}}getContainmentMessage(e){let t="",n="form-text mt-1",s="",o="";e>=97?(s="\u2705 Batch fully contained",o="text-success"):(s="\u26A0\uFE0F Partial containment - add more containers",o="text-danger");let a="",i="";if(e>=97){let r=this.calculateLastContainerFillPercentage();r<100&&(r<75?(a=" \u2022 \u26A0\uFE0F Partial fill warning: last container will be filled less than 75% - consider using other containers",i="text-danger"):(a=` \u2022 \u26A0\uFE0F Last container partially filled to ${r.toFixed(1)}%`,i="text-warning"))}return t=s+a,o==="text-danger"||i==="text-danger"?n+=" text-danger":i==="text-warning"?n+=" text-warning":n+=" "+o,e>=97||e>=97&&(t="\u2705 Batch contained within 3% tolerance"),{text:t,className:n}}clear(){let e=document.getElementById("containmentProgressBar"),t=document.getElementById("containmentPercent"),n=document.getElementById("liveContainmentMessage");e&&(e.style.width="0%",e.textContent="0%",e.className="progress-bar bg-warning"),t&&(t.textContent="0%"),n&&(n.textContent="")}};var M=class{constructor(e){this.container=e}activate(){console.log("\u{1F50D} MANUAL MODE: Switching to manual container selection"),this.clearAutoFillResults()}clearAutoFillResults(){let e=document.getElementById("containerResults");e&&(e.innerHTML='<p class="text-muted">Switch to auto-fill mode to see container recommendations, or add containers manually below.</p>')}populateFromAutoFill(){var t;if(!((t=this.container.containerPlan)!=null&&t.container_selection))return;console.log("\u{1F50D} MANUAL MODE: Populating from auto-fill data");let e=document.getElementById("containerSelectionRows");e&&(e.innerHTML="",this.container.containerPlan.container_selection.forEach((n,s)=>{this.addPrefilledRow(n,s)}),console.log("\u{1F50D} MANUAL MODE: Pre-populated",this.container.containerPlan.container_selection.length,"rows"))}addPrefilledRow(e,t){let n=document.getElementById("containerSelectionRows");if(!n)return;let s=this.createContainerRowHTML(t),o=document.createElement("div");o.innerHTML=s;let a=o.firstElementChild;if(a){n.appendChild(a);let i=a.querySelector(".container-select"),r=a.querySelector(".container-quantity");i&&r&&(i.value=e.container_id,r.value=e.quantity||e.containers_needed||1),this.bindContainerRowEvents(t),this.updateContainerRow(t)}}addContainerRow(){var i,r,c;if((i=document.getElementById("autoFillEnabled"))==null?void 0:i.checked){alert("Please uncheck Auto-Fill to add containers manually.");return}if(!((c=(r=this.container.containerPlan)==null?void 0:r.container_selection)!=null&&c.length)){alert("No containers available for this recipe.");return}let t=document.getElementById("containerSelectionRows");if(!t){console.error("\u{1F6A8} MANUAL MODE: Container rows container not found!");return}let n=t.children.length;console.log("\u{1F50D} MANUAL MODE: Adding row",n);let s=this.createContainerRowHTML(n),o=document.createElement("div");o.innerHTML=s;let a=o.firstElementChild;a&&(t.appendChild(a),this.bindContainerRowEvents(n))}createContainerRowHTML(e){var s,o;let t=((s=this.container.containerPlan)==null?void 0:s.container_options)||((o=this.container.containerPlan)==null?void 0:o.container_selection)||[],n='<option value="">Select Container</option>';return t.forEach(a=>{let i=a.container_name||"Unknown Container";n+=`<option value="${a.container_id}">${i}</option>`}),`
            <div class="row align-items-center mb-3 p-3 border rounded bg-light container-row-wrapper" data-container-row="${e}">
                <div class="col-md-3">
                    <label class="form-label small">Container Type</label>
                    <select class="form-select form-select-sm container-select" data-row="${e}">
                        ${n}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Quantity</label>
                    <input type="number" min="1" class="form-control form-control-sm container-quantity" 
                           data-row="${e}" value="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Capacity Each</label>
                    <div class="form-control form-control-sm bg-light border-0 container-capacity" data-row="${e}">-</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Available Stock</label>
                    <div class="badge bg-info fs-6 available-stock" data-row="${e}">-</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-white">Remove</label>
                    <button type="button" class="btn btn-danger btn-sm w-100 remove-container-btn" 
                            data-row="${e}" title="Remove this container">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `}bindContainerRowEvents(e){let t=document.querySelector(`[data-container-row="${e}"]`);if(!t){console.warn("\u{1F50D} MANUAL MODE: Row not found for binding events:",e);return}let n=t.querySelector(".container-select"),s=t.querySelector(".container-quantity"),o=t.querySelector(".remove-container-btn");n&&n.addEventListener("change",()=>this.updateContainerRow(e)),s&&s.addEventListener("input",()=>this.container.progressBar.update()),o?(console.log("\u{1F50D} MANUAL MODE: Binding remove button for row",e),o.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.removeContainerRow(e)})):console.warn("\u{1F50D} MANUAL MODE: Remove button not found for row",e),this.updateContainerRow(e)}updateContainerRow(e){var c,d;let t=document.querySelector(`[data-container-row="${e}"]`);if(!t)return;let n=t.querySelector(".container-select"),s=t.querySelector(".available-stock"),o=t.querySelector(".container-capacity");if(!n||!s)return;let a=n.value;if(!a){s.textContent="-",o&&(o.textContent="-");return}let i=(d=(c=this.container.containerPlan)==null?void 0:c.container_selection)==null?void 0:d.find(u=>u.container_id==a);if(!i){s.textContent="-",o&&(o.textContent="-");return}let r=i.stock_qty||i.quantity||i.available_quantity||0;if(s.textContent=r,o){let u=`${i.capacity||0} ${i.original_unit||i.unit||"ml"}`;i.capacity_in_yield_unit&&i.yield_unit&&i.conversion_successful?u=`<strong>${i.capacity_in_yield_unit} ${i.yield_unit}</strong> (${i.original_capacity||i.capacity} ${i.original_unit||i.unit})`:i.capacity_in_yield_unit&&i.yield_unit&&(u=`<strong>${i.capacity_in_yield_unit} ${i.yield_unit}</strong> (${i.original_capacity||i.capacity} ${i.original_unit||i.unit})`),o.innerHTML=u}this.container.progressBar.update()}removeContainerRow(e){console.log("\u{1F50D} MANUAL MODE: Removing row",e);let t=document.querySelector(`[data-container-row="${e}"]`);t?(t.style.transition="opacity 0.3s ease",t.style.opacity="0",setTimeout(()=>{t.remove(),this.container.progressBar.update(),console.log("\u{1F50D} MANUAL MODE: Row",e,"removed")},300)):console.warn("\u{1F50D} MANUAL MODE: Row",e,"not found for removal")}};var $=class{constructor(e){this.container=e}activate(){f.debug("AUTO-FILL MODE: Activating auto-fill container selection"),this.container.planFetcher.fetchContainerPlan()}},P=class{constructor(e){this.main=e,this.containerPlan=null,this.fetchingPlan=!1,this.lastPlanResult=null,this.planFetcher=new k(this),this.renderer=new E(this),this.progressBar=new w(this),this.manualMode=new M(this),this.autoFillMode=new $(this)}bindEvents(){f.debug("CONTAINER MANAGER DEBUG: Binding events");let e=document.getElementById("addContainerBtn");e&&e.addEventListener("click",()=>this.manualMode.addContainerRow());let t=document.getElementById("autoFillEnabled");t&&t.addEventListener("change",i=>this.handleModeToggle(i.target.checked));let n=document.getElementById("useFillPctToggle"),s=document.getElementById("fillPctInputGroup"),o=document.getElementById("fillPctInfo");n&&s&&n.addEventListener("change",()=>{s.style.display=n.checked?"flex":"none",this.main.requiresContainers&&this.planFetcher.fetchContainerPlan({fill_pct:this.getEffectiveFillPct()})});let a=document.getElementById("fillPctInput");a&&a.addEventListener("input",()=>{let i=parseFloat(a.value||"100");isFinite(i)&&i>0&&this.main.requiresContainers&&this.planFetcher.fetchContainerPlan({fill_pct:this.getEffectiveFillPct()})})}handleModeToggle(e){f.debug("AUTO-FILL TOGGLE:",e),this.toggleContainerSections(e),e&&this.main.requiresContainers?this.autoFillMode.activate():e||this.manualMode.activate()}toggleContainerSections(e){var s;let t=document.getElementById("autoFillResults"),n=document.getElementById("manualContainerSection");t&&(t.style.display=e?"block":"none"),n&&(n.style.display=e?"none":"block"),!e&&((s=this.containerPlan)!=null&&s.success)&&this.containerPlan.container_selection&&this.manualMode.populateFromAutoFill(),this.progressBar.update()}onContainerRequirementChange(){var e,t;if(this.main.requiresContainers){let n=(t=(e=document.getElementById("autoFillEnabled"))==null?void 0:e.checked)!=null?t:!0;this.toggleContainerSections(n),this.planFetcher.fetchContainerPlan({fill_pct:this.getEffectiveFillPct()})}else this.containerPlan=null,this.renderer.clearResults()}getEffectiveFillPct(){var i,r;let e=parseFloat(((r=(i=window.recipeData)==null?void 0:i.category_data)==null?void 0:r.vessel_fill_pct)||"");if(isFinite(e)&&e>0){let c=document.getElementById("fillPctInfo");c&&(c.textContent=`(Recipe fill ${e}%)`);let d=document.getElementById("useFillPctToggle"),u=document.getElementById("fillPctInputGroup");return d&&(d.style.display="none"),u&&(u.style.display="none"),e}let t=document.getElementById("useFillPctToggle"),n=document.getElementById("fillPctInput"),s=!!(t&&t.checked),o=parseFloat((n==null?void 0:n.value)||"100"),a=document.getElementById("fillPctInfo");return a&&(a.textContent=s?`(Fill ${o}%)`:""),s&&isFinite(o)&&o>0?o:null}displayContainerPlan(){this.renderer.displayPlan(),this.progressBar.update()}displayContainerError(e){this.renderer.displayError(e)}clearContainerResults(){this.containerPlan=null,this.renderer.clearResults()}fetchContainerPlan(){return this.planFetcher.fetchContainerPlan()}};var h={debug:(l,...e)=>f.debug(`STOCK_CHECK: ${l}`,...e),info:(l,...e)=>f.info(`STOCK_CHECK: ${l}`,...e),warn:(l,...e)=>f.warn(`STOCK_CHECK: ${l}`,...e),error:(l,...e)=>f.error(`STOCK_CHECK: ${l}`,...e)},x=new Set(["NEEDED","OUT_OF_STOCK","DENSITY_MISSING","ERROR"]),S=class{constructor(e){this.main=e,this.stockCheckResults=null,this.processedResults=null,this.stockCheckTimeout=null}bindEvents(){h.debug("Binding events...");let e=document.getElementById("stockCheckBtn");h.debug("Stock check button found:",!!e),e?(e.addEventListener("click",()=>{h.debug("Button clicked!"),this.performStockCheck()}),h.debug("Event listener added successfully")):h.error("Stock check button not found in DOM")}async performStockCheck(){let e=this.main.recipe?this.main.recipe.id:"N/A",t=this.main.scale||"N/A";if(h.debug(`Performing stock check: recipe=${e}, scale=${t}`),!this.main.recipe){h.warn("No recipe available"),alert("No recipe loaded");return}let n=document.getElementById("stockCheckBtn"),s=n.innerHTML;n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Checking...',n.disabled=!0;try{let o=await fetch("/production-planning/stock/check",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.main.getCSRFToken()},body:JSON.stringify({recipe_id:this.main.recipe.id,scale:this.main.scale})});if(h.debug(`Stock check response status: ${o.status}`),!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);let a=await o.json();this.stockCheckResults=a,this.displayStockResults(this.stockCheckResults),h.debug(`Stock check completed - status: ${o.status}, all_ok: ${a.all_ok}`)}catch(o){h.error("Stock check failed:",o);let a="Stock check failed";o.message.includes("Cannot read properties of undefined")?a="Stock check failed: Missing required components. Please refresh the page.":o.name==="TypeError"?a=`Stock check failed: ${o.message}`:a=`Stock check failed: ${o.message}`,this.displayStockError(a)}finally{n.innerHTML=s,n.disabled=!1}}displayStockResults(){h.debug("Displaying results");let e=document.getElementById("stockCheckResults");if(!e){h.warn("No results element found");return}h.debug("Full results object:",this.stockCheckResults);let t=this.stockCheckResults.stock_check||[],n=[],s=this.stockCheckResults.status==="ok";if(h.debug("Stock data:",t),h.debug("All available:",s),!t||t.length===0){e.innerHTML='<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> There are no ingredients selected in this recipe. Please edit your recipe and add ingredients.</div>',this.main.stockChecked=!0,this.main.stockCheckPassed=!0,this.main.stockIssues=[],this.main.stockOverrideAcknowledged=!1,this.main.updateValidation();return}let o='<div class="table-responsive"><table class="table table-sm table-striped">';o+="<thead><tr><th>Item</th><th>Required</th><th>Available</th><th>Unit</th><th>Status</th></tr></thead><tbody>";let a=!0;t.forEach(i=>{var _,g,L;h.debug("Stock check item:",i.ingredient_name||i.item_name,{needed_quantity:i.needed_quantity,available_quantity:i.available_quantity,raw_stock:i.raw_stock,formatted_available:i.formatted_available,formatted_needed:i.formatted_needed});let r=i.needed_amount||i.needed_quantity||i.quantity_needed||0,c=i.raw_stock!==void 0?i.raw_stock:i.available_quantity||0,d,u,m,b;if(b=i.formatted_needed||`${r.toFixed(2)} ${i.needed_unit||i.unit||""}`,(_=i.conversion_details)!=null&&_.error_code)d="CONVERSION ERROR",u="bg-warning",m=i.formatted_available||"Fix Conversion",a=!1,n.push({name:i.ingredient_name||i.item_name||"Unknown",needed:r,available:c,unit:i.available_unit||i.needed_unit||i.unit||"",status:d}),console.log("\u{1F527} STOCK CHECK DEBUG: Full conversion error result:",JSON.stringify(i,null,2)),(g=i.conversion_details)!=null&&g.drawer_payload?console.log("\u{1F527} STOCK CHECK: Drawer payload found in conversion_details (handled by global interceptor)"):i.drawer_payload?console.log("\u{1F527} STOCK CHECK: Drawer payload found at result level (handled by global interceptor)"):(L=i.conversion_result)!=null&&L.drawer_payload?console.log("\u{1F527} STOCK CHECK: Drawer payload found in conversion_result (handled by global interceptor)"):console.log("\u{1F527} STOCK CHECK DEBUG: No drawer_payload found in any expected location for conversion error");else{let C=i.is_available!==!1&&c>=r;C||(a=!1),d=C?"OK":"NEEDED",u=C?"bg-success":"bg-danger",m=i.formatted_available||`${c.toFixed(2)} ${i.stock_unit||i.available_unit||""}`;let F=(i.status||d||"").toString().toUpperCase();(!C||x.has(F))&&n.push({name:i.ingredient_name||i.item_name||"Unknown",needed:r,available:c,unit:i.available_unit||i.needed_unit||i.unit||"",status:F||(C?"OK":"NEEDED")})}let y=i.available_unit||i.needed_unit||i.unit||"";o+=`<tr>
                <td>${i.ingredient_name||i.item_name||"Unknown"}</td>
                <td>${b}</td>
                <td>${m}</td>
                <td>${y}</td>
                <td><span class="badge ${u}">${d}</span></td>
            </tr>`}),o+="</tbody></table></div>",o+=`
            <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="stockChecker.downloadCSV()">
                    <i class="fas fa-download"></i> Download CSV
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="stockChecker.downloadShoppingList()">
                    <i class="fas fa-shopping-cart"></i> Shopping List
                </button>
            </div>
        `,e.innerHTML=o,this.main.stockChecked=!0,this.main.stockCheckPassed=a&&n.length===0,this.main.stockOverrideAcknowledged=!1,this.main.stockIssues=n,this.main.stockCheckResults=t,this.main.updateValidation(),this.processedResults=t.map(i=>({ingredient:i.ingredient_name||i.item_name||"Unknown",needed:i.needed_amount||i.needed_quantity||i.quantity_needed||0,available:i.available_quantity||0,unit:i.unit||i.needed_unit||i.available_unit||"",status:i.is_available!==!1&&(i.available_quantity||0)>=(i.needed_amount||i.needed_quantity||i.quantity_needed||0)?"OK":"NEEDED"}))}displayStockError(e){h.error("Displaying error:",e);let t=document.getElementById("stockCheckResults");if(!t){h.error("stockCheckResults element not found");return}let n=document.getElementById("stockCheckStatus");if(!n){h.error("stockCheckStatus element not found");return}t.innerHTML=`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> ${e}
            </div>
        `,n.innerHTML=`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> Stock check failed: ${e}
            </div>
        `}downloadCSV(){var s;if(!((s=this.processedResults)!=null&&s.length))return;let e=`Ingredient,Required,Available,Unit,Status
`;this.processedResults.forEach(o=>{e+=`${o.ingredient},${o.needed.toFixed(2)},${o.available.toFixed(2)},${o.unit},${o.status}
`});let t=new Blob([e],{type:"text/csv"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download="stock_check_report.csv",n.click()}downloadShoppingList(){var o;if(!((o=this.processedResults)!=null&&o.length))return;let e=this.processedResults.filter(a=>a.status==="NEEDED");if(!e.length){alert("No items need restocking!");return}let t=`Shopping List
=============

`;e.forEach(a=>{let i=Math.max(0,a.needed-a.available);t+=`${a.ingredient}: ${i.toFixed(2)} ${a.unit}
`});let n=new Blob([t],{type:"text/plain"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download="shopping_list.txt",s.click()}};var T=class{constructor(e){this.main=e}bindEvents(){}updateValidation(){let e=[],t=[];this.main.batchType||e.push("Select batch type"),this.main.stockChecked?this.main.stockCheckPassed||t.push("Stock shortages detected - confirmation required"):e.push("Run stock check"),this.main.requiresContainers&&this.main.containerManager.containerPlan&&(this.main.containerManager.containerPlan.containment_percentage||0)<50&&t.push("Low container coverage");let n=e.length===0;return this.updateValidationUI(n,e,t),n}updateValidationUI(e,t,n){let s=document.getElementById("startBatchBtn");s&&(s.disabled=!e,e?(s.innerHTML='<i class="fas fa-play me-2"></i>Start Batch',s.className="btn btn-primary btn-lg w-100",s.title=n.length>0?"Warnings: "+n.join(", "):""):(s.innerHTML='<i class="fas fa-play me-2"></i>'+t[0],s.className="btn btn-secondary btn-lg w-100",s.title="Issues: "+t.join(", ")));let o=document.getElementById("validationMessage");o&&(e?n.length>0?o.innerHTML=`<div class="alert alert-info"><i class="fas fa-info-circle"></i> ${n.join(", ")}</div>`:o.innerHTML="":o.innerHTML=`<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ${t.join(", ")}</div>`)}};var I=class{constructor(e){this.main=e,this.overrideModal=null}bindEvents(){let e=document.getElementById("startBatchBtn");e&&e.addEventListener("click",()=>this.startBatch());let t=document.getElementById("confirmForceStartBtn");t&&t.addEventListener("click",()=>{this.main.stockOverrideAcknowledged=!0,this.hideOverrideModal(),this.startBatch(!0)})}async startBatch(e=!1){var n;if(!this.main.recipe)return;if(!this.main.stockChecked){this.showErrorMessage("Please run a stock check before starting a batch.");return}let t=e||this.main.stockOverrideAcknowledged;if(!t&&!this.main.stockCheckPassed){this.showInsufficientModal();return}try{let s=this.getFlatPortionFields(),o={recipe_id:this.main.recipe.id,scale:this.main.scale,batch_type:this.main.batchType||"ingredient",notes:((n=document.getElementById("batchNotes"))==null?void 0:n.value)||"",requires_containers:!!this.main.requiresContainers,containers:this.getSelectedContainers(),...s||{},projected_yield:(this.main.baseYield||0)*(this.main.scale||1),projected_yield_unit:this.main.unit,force_start:t},a=await this.main.apiCall("/batches/api/start-batch",o);if(a.requires_override){this.main.stockIssues=a.stock_issues||[],this.main.stockOverrideAcknowledged=!1,this.showInsufficientModal(a.stock_issues||[]);return}a.success?(this.showSuccessMessage(a.message),setTimeout(()=>{window.location.href=`/batches/${a.batch_id}`},2e3)):this.showErrorMessage(a.message)}catch(s){console.error("Start batch error:",s),alert("Error starting batch. Please try again.")}}showInsufficientModal(e=null){var o;let t=document.getElementById("insufficientStockModal");if(!t){alert("Insufficient inventory detected. Please add stock before continuing.");return}let n=document.getElementById("insufficientStockList"),s=(e&&e.length?e:this.main.stockIssues)||[];n&&(s.length?n.innerHTML=s.map(a=>{var u,m;let i=Number(a.needed||a.needed_quantity||a.quantity_needed||0),r=Number((m=(u=a.available)!=null?u:a.available_quantity)!=null?m:0),c=a.unit||a.needed_unit||a.available_unit||"",d=(a.status||"NEEDED").toString().toUpperCase();return`
                        <tr>
                            <td>${a.name||a.item_name||"Unknown"}</td>
                            <td>${i.toFixed(2)} ${c}</td>
                            <td>${r.toFixed(2)} ${c}</td>
                            <td><span class="badge bg-danger">${d}</span></td>
                        </tr>
                    `}).join(""):n.innerHTML=`
                    <tr>
                        <td colspan="4" class="text-muted text-center">
                            <em>No shortages detected.</em>
                        </td>
                    </tr>
                `),!this.overrideModal&&((o=window.bootstrap)!=null&&o.Modal)&&(this.overrideModal=new window.bootstrap.Modal(t)),this.overrideModal?this.overrideModal.show():alert("Insufficient inventory detected. Bootstrap modal is not available.")}hideOverrideModal(){this.overrideModal&&this.overrideModal.hide()}getSelectedContainers(){var s,o;if(!this.main.requiresContainers)return[];let e=document.getElementById("manualContainerSection");if(e&&e.style.display!=="none"){let a=document.querySelectorAll("#manualContainerRows .container-row"),i=[];return a.forEach(r=>{let c=r.querySelector("select"),d=r.querySelector('input[type="number"]'),u=parseInt((c==null?void 0:c.value)||""),m=parseInt((d==null?void 0:d.value)||"0");u&&m>0&&i.push({id:u,quantity:m})}),i}let n=(s=this.main.containerManager)==null?void 0:s.containerPlan;return(o=n==null?void 0:n.container_selection)!=null&&o.length?n.container_selection.map(a=>({id:a.container_id,quantity:a.containers_needed||a.quantity||0})).filter(a=>a.quantity>0):[]}getFlatPortionFields(){var t,n;let e=(n=(t=this.main)==null?void 0:t.recipe)==null?void 0:n.portioning_data;return!e||!e.is_portioned?null:{is_portioned:!0,portion_name:e.portion_name||"",portion_count:e.portion_count||null}}showSuccessMessage(e){let t=document.createElement("div");t.className="alert alert-success",t.innerHTML=`<i class="fas fa-check-circle"></i> ${e}`;let n=document.querySelector(".container-fluid");n.insertBefore(t,n.firstChild)}showErrorMessage(e){let t=document.createElement("div");t.className="alert alert-danger",t.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${e}`;let n=document.querySelector(".container-fluid");n.insertBefore(t,n.firstChild)}};var q=class{constructor(){let e=window.recipeData||{};this.recipe={id:e.id,name:e.name,yield_amount:e.yield_amount,yield_unit:e.yield_unit,portioning_data:e.portioning||null,is_portioned:e.is_portioned===!0||e.is_portioned==="true"},this.baseYield=Number(e.yield_amount||0),this.unit=e.yield_unit||"units",this.scale=this._readScale(),this.batchType="",this.requiresContainers=!1,this.stockChecked=!1,this.stockCheckPassed=!1,this.stockIssues=[],this.stockOverrideAcknowledged=!1,this.containerManager=new P(this),this.stockChecker=new S(this),this.validation=new T(this),this.batchManager=new I(this),window.planProductionApp=this}init(){this._bindCoreEvents(),this._registerGlobalEvents(),this.containerManager.bindEvents(),this.stockChecker.bindEvents(),this.validation.bindEvents(),this.batchManager.bindEvents(),window.stockChecker=this.stockChecker,this._updateProjectedYield(),this._updateProjectedPortions(),this.updateValidation();let e=window.recipeData||{};if(e.is_portioned===!0||e.is_portioned==="true"){let t=document.getElementById("requiresContainers");t&&(t.checked=!1);let n=document.getElementById("containerManagementCard");n&&(n.style.display="none")}}_registerGlobalEvents(){window.addEventListener("recipe.yield.updated",e=>{var n,s;let t=e.detail||{};if(!(!t||t.recipe_id!==this.recipe.id)){if(typeof t.yield_amount!="undefined"&&(this.baseYield=Number(t.yield_amount)||0,window.recipeData.yield_amount=this.baseYield),t.yield_unit&&(this.unit=t.yield_unit,window.recipeData.yield_unit=t.yield_unit),this._updateProjectedYield(),this._updateProjectedPortions(),t.refresh_plan){let o=document.getElementById("requiresContainers"),a=!!(o!=null&&o.checked);if(!this.requiresContainers&&a){this.requiresContainers=!0;let i=document.getElementById("containerManagementCard");i&&(i.style.display="block")}if((s=(n=this.containerManager)==null?void 0:n.planFetcher)!=null&&s.clearCache&&this.containerManager.planFetcher.clearCache(),this.requiresContainers||a){let i=this.containerManager.getEffectiveFillPct();this.containerManager.planFetcher.fetchContainerPlan({fill_pct:i})}this._invalidateStockCheck("the recipe yield changed")}else if(this.requiresContainers){let o=this.containerManager.getEffectiveFillPct();this.containerManager.planFetcher.fetchContainerPlan({fill_pct:o})}}}),window.addEventListener("container.requirements.disable",e=>{let t=e.detail||{};t.recipe_id&&t.recipe_id!==this.recipe.id||this._disableContainersRequirement()})}_disableContainersRequirement(){let e=document.getElementById("requiresContainers");e&&(e.checked=!1),this.requiresContainers=!1;let t=document.getElementById("containerManagementCard");t&&(t.style.display="none"),this.containerManager.clearContainerResults(),this.updateValidation()}_bindCoreEvents(){let e=document.getElementById("batchScale");e&&e.addEventListener("input",()=>{this.scale=this._readScale(),this._invalidateStockCheck("the batch scale changed"),this._updateProjectedYield(),this._updateProjectedPortions(),this.requiresContainers&&this.containerManager.onContainerRequirementChange(),this.updateValidation()});let t=document.getElementById("batchType");t&&t.addEventListener("change",s=>{this.batchType=s.target.value,console.log("Batch type selected:",this.batchType),this.updateValidation()});let n=document.getElementById("requiresContainers");n&&n.addEventListener("change",()=>{var a,i;if(this._invalidateStockCheck("container requirements changed"),(((a=window.recipeData)==null?void 0:a.is_portioned)===!0||((i=window.recipeData)==null?void 0:i.is_portioned)==="true")&&n.checked){let r=document.getElementById("portioningContainerNotice");r&&(r.classList.remove("d-none"),r.classList.remove("bounce"),r.offsetWidth,r.classList.add("bounce")),n.checked=!1;return}this.requiresContainers=!!n.checked;let o=document.getElementById("containerManagementCard");o&&(o.style.display=this.requiresContainers?"block":"none"),this.requiresContainers?this.containerManager.onContainerRequirementChange():this.containerManager.clearContainerResults(),this.updateValidation()})}_invalidateStockCheck(e="a configuration change"){this.stockChecked=!1,this.stockCheckPassed=!1,this.stockOverrideAcknowledged=!1,this.stockIssues=[];let t=document.getElementById("stockCheckStatus");t&&(t.innerHTML=`
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Stock check required because ${e}.
                </div>
            `),this.updateValidation()}_readScale(){var t;let e=parseFloat(((t=document.getElementById("batchScale"))==null?void 0:t.value)||"1");return isNaN(e)||e<=0?1:e}_updateProjectedYield(){let e=document.getElementById("projectedYield");if(e){let t=(this.baseYield||0)*(this.scale||1);e.textContent=`${t} ${this.unit}`}}_updateProjectedPortions(){let e=document.getElementById("projectedPortions");if(e&&this.recipe.portioning_data&&this.recipe.portioning_data.portion_count){let t=parseInt(this.recipe.portioning_data.portion_count)||0,n=Math.round(t*(this.scale||1)),s=this.recipe.portioning_data.portion_name||"units";e.textContent=`${n} ${s}`}}updateValidation(){this.validation.updateValidation()}getCSRFToken(){let e=document.querySelector('input[name="csrf_token"]'),t=document.querySelector('meta[name="csrf-token"]');return(e==null?void 0:e.value)||(t==null?void 0:t.content)||""}async apiCall(e,t={},n={}){let s=await fetch(e,{method:n.method||"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken(),...n.headers||{}},body:n.method==="GET"?void 0:JSON.stringify(t)}),o=(s.headers.get("content-type")||"").toLowerCase(),a=null;try{if(o.includes("application/json"))a=await s.json();else{let i=await s.text();try{a=i?JSON.parse(i):null}catch{a=i?{error:i}:null}}}catch{a=null}if(!s.ok){let i=(a==null?void 0:a.error)||(a==null?void 0:a.message)||`HTTP ${s.status}`;throw new Error(i)}return a||{}}};document.addEventListener("DOMContentLoaded",()=>{new q().init()});
