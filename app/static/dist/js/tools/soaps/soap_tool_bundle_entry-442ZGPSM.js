(function(O){"use strict";let e={inventory:"Inventory",global:"Global Library"},u={inventory:"bg-primary",global:"bg-info text-dark"},m={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function G(r,d){let l;return function(){let b=arguments;clearTimeout(l),l=setTimeout(()=>r.apply(null,b),d)}}function X(r){return(r||"").trim().toLowerCase()}function j(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function A(r){return typeof r=="function"?r():r}function I(r){let d=new Set;return(r||[]).forEach(l=>{let b=l&&(l.global_item_id||l.id);b&&d.add(String(b))}),d}function L(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${u[r]||"bg-secondary"} ms-2">${d}</span>`}function x(r,d,l,b){b=b||{},r.innerHTML="";let S=!1;if(d.forEach(p=>{!p.items||!p.items.length||(S=!0,p.items.forEach(v=>{let E=document.createElement("a");E.href="#",E.className="list-group-item list-group-item-action suggestion-item";let g=b.showSubtitle&&v.subtitle?`<div class="small text-muted mt-1">${v.subtitle}</div>`:"";E.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${v.text||v.display_name||v.name||""}</span>
          ${b.showSourceBadge?L(p.source||v.source):""}
        </div>${g}`,E.addEventListener("click",function(t){t.preventDefault(),l(v,p.source||v.source),r.classList.add("d-none")}),r.appendChild(E)}))}),r.classList.toggle("d-none",!S),!S&&r.dataset.emptyMessage){let p=document.createElement("div");p.className="list-group-item text-muted small",p.textContent=r.dataset.emptyMessage,r.appendChild(p),r.classList.remove("d-none")}}function y(r,d,l){r.innerHTML="";let b=!1;d.forEach(S=>{if(!S.ingredients||!S.ingredients.length)return;b=!0;let p=document.createElement("div");p.className="list-group-item text-muted small fw-semibold",p.textContent=S.title,r.appendChild(p),S.ingredients.forEach(v=>{let E=document.createElement("div");E.className="list-group-item ingredient-result";let g=document.createElement("div");g.className="d-flex justify-content-between align-items-center ingredient-summary",g.setAttribute("role","button"),g.setAttribute("tabindex","0"),g.innerHTML=`<span class="fw-semibold">${v.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${v.forms.length} option${v.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",v.forms.forEach(C=>{let R=document.createElement("button");R.type="button",R.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",R.innerHTML=`<div class="fw-semibold">${C.text||C.display_name||C.name||"Form"}</div>`,R.addEventListener("click",function(){l(C,C.source||S.source),r.classList.add("d-none")}),t.appendChild(R)});function f(C){C.type==="keydown"&&C.key!=="Enter"&&C.key!==" "||(C.preventDefault(),t.classList.toggle("d-none"))}g.addEventListener("click",f),g.addEventListener("keydown",f),E.appendChild(g),E.appendChild(t),r.appendChild(E),v.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!b)}function U(r,d,l){r.innerHTML="";let b=!1;if((d||[]).forEach(S=>{b=!0;let p=document.createElement("a");p.href="#",p.className="list-group-item list-group-item-action suggestion-item";let v=S.inci_name?`<div class="small text-muted">${S.inci_name}</div>`:"";p.innerHTML=`<div class="fw-semibold">${S.text||S.name}</div>${v}`,p.addEventListener("click",function(E){E.preventDefault(),l(S,"definition"),r.classList.add("d-none")}),r.appendChild(p)}),r.classList.toggle("d-none",!b),!b&&r.dataset.emptyMessage){let S=document.createElement("div");S.className="list-group-item text-muted small",S.textContent=r.dataset.emptyMessage,r.appendChild(S),r.classList.remove("d-none")}}function o(r){let d=[];return(r||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let b=l.ingredient&&l.ingredient.name||l.ingredient_name||null,S=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,p=l.category_tags||[];l.forms.forEach(v=>{var t,f,C,R,w,B,M,$,z,Z;let E=v.physical_form||{},g=v.display_name||v.text||v.name||(b&&v.physical_form_name?`${b}, ${v.physical_form_name}`:l.display_name||l.text||l.name||"");d.push({id:v.id,text:g,item_type:v.item_type||l.item_type,default_unit:v.default_unit||v.unit||l.default_unit||l.unit||null,source:"global",global_item_id:v.id,ingredient_id:v.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:v.ingredient_name||b,physical_form_id:v.physical_form_id||E&&E.id||null,physical_form_name:v.physical_form_name||E&&E.name||null,ingredient_category_name:S,category_tags:p,density:v.density||l.density||null,capacity:v.capacity||l.capacity||null,capacity_unit:v.capacity_unit||l.capacity_unit||null,container_material:v.container_material||l.container_material||null,container_type:v.container_type||l.container_type||null,container_style:v.container_style||l.container_style||null,container_color:v.container_color||l.container_color||null,default_is_perishable:(t=v.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(f=v.recommended_shelf_life_days)!=null?f:l.recommended_shelf_life_days,saponification_value:(R=(C=v.saponification_value)!=null?C:l.saponification_value)!=null?R:null,iodine_value:(B=(w=v.iodine_value)!=null?w:l.iodine_value)!=null?B:null,fatty_acid_profile:($=(M=v.fatty_acid_profile)!=null?M:l.fatty_acid_profile)!=null?$:null,melting_point_c:(Z=(z=v.melting_point_c)!=null?z:l.melting_point_c)!=null?Z:null})})}else if(l){let b=l.display_name||l.text||l.name||"",S=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;d.push({id:l.id,text:b,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:S,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),d}function _(r){let d=new Map;return(r||[]).forEach(l=>{let b=l.ingredient_name||l.text||l.name||"",S=l.ingredient_id?`id:${l.ingredient_id}`:`name:${X(b)}`,p=d.get(S)||{ingredient_id:l.ingredient_id||null,name:b,forms:[]};p.forms.push({id:l.id,text:l.text||b,ingredient_name:b,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),d.set(S,p)}),Array.from(d.values())}function s(r,d){let l=[];return(r||[]).forEach(b=>{let S=(b.forms||[]).map(v=>({id:v.id,text:v.name||v.display_name||v.text,ingredient_name:v.ingredient_name||b.name||b.ingredient&&b.ingredient.name||"Ingredient",physical_form_name:v.physical_form_name||null,default_unit:v.default_unit||v.unit||null,source:"global",global_item_id:v.id,density:v.density||null,capacity:v.capacity||null,capacity_unit:v.capacity_unit||null,container_material:v.container_material||null,container_type:v.container_type||null,container_style:v.container_style||null,container_color:v.container_color||null,saponification_value:v.saponification_value||null,iodine_value:v.iodine_value||null,fatty_acid_profile:v.fatty_acid_profile||null,melting_point_c:v.melting_point_c||null})),p=d?S.filter(v=>!v.global_item_id||!d.has(String(v.global_item_id))):S;p.length&&l.push({ingredient_id:b.ingredient_id||b.id||null,name:b.name||b.ingredient&&b.ingredient.name||S[0]&&S[0].ingredient_name||"Ingredient",forms:p})}),l}function i(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function a(r){let d={...m,...r},l=d.inputEl,b=d.invHiddenEl,S=d.giHiddenEl,p=j(d.listEl),v=d.mode||"recipe",E=d.searchType||"ingredient",g=d.includeInventory,t=d.includeGlobal,f=d.ingredientFirst,C=d.displayVariant,R=typeof d.resultFilter=="function"?d.resultFilter:null,w=typeof d.onSelection=="function"?d.onSelection:null,B=d.globalUrlBuilder;if(!l||!b&&v==="recipe"||!S&&d.requireHidden!==!1)return;p&&!p.classList.contains("list-group")&&p.classList.add("list-group"),!p.parentNode&&l.parentNode&&l.parentNode.appendChild(p);function M(H,Q){let h=new URLSearchParams({q:H});return Q&&Q!=="all"&&h.set("type",Q),`/inventory/api/search?${h.toString()}`}function $(H,Q,h){if(typeof B=="function")return B(H,Q,h);let T=new URLSearchParams({q:H});return Q&&Q!=="all"&&T.set("type",Q),Q==="ingredient"&&h&&T.set("group","ingredient"),`${v==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${T.toString()}`}let z=G(function(){let H=(l.value||"").trim();if(!H){p.classList.add("d-none"),p.innerHTML="",b&&(b.value=""),S&&(S.value="");return}let Q=(A(E)||"ingredient").toLowerCase(),h=A(g),T=A(t),N=Q==="ingredient"&&!!A(f),k=C||(N?"grouped":"compact");if(Q==="ingredient_definition"||Q==="definition"){i(H).then(P=>{let V=P&&P.results||[];U(p,V.map(Y=>({id:Y.id,text:Y.name,name:Y.name,inci_name:Y.inci_name,slug:Y.slug,ingredient_category_id:Y.ingredient_category_id,ingredient_category_name:Y.ingredient_category_name})),Z)}).catch(()=>p.classList.add("d-none"));return}let F=h!==!1?fetch(M(H,Q)).then(P=>P.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),W=T!==!1?fetch($(H,Q,N)).then(P=>P.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([F,W]).then(P=>{let V=P[0]&&P[0].results||[],Y=P[1]&&P[1].results||[],K=R?V.filter(oe=>R(oe,"inventory")):V,J=R?Y.filter(oe=>R(oe,"global")):Y,te=I(K),ae=o(J).filter(oe=>!oe.global_item_id||!te.has(String(oe.global_item_id))).filter(oe=>R?R(oe,"global"):!0);if(N){let oe=_(K),ye=s(J,te),he=[];oe.length&&he.push({title:"Your Inventory",source:"inventory",ingredients:oe}),ye.length&&he.push({title:"Global Library",source:"global",ingredients:ye}),y(p,he,Z);return}let ce=[];K.length&&ce.push({title:"Your Inventory",source:"inventory",items:K}),ae.length&&ce.push({title:"Global Library",source:"global",items:ae}),x(p,ce,Z,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:k==="detailed"})}).catch(()=>{p.classList.add("d-none")})},200);function Z(H,Q){l.value=H.text||H.display_name||H.name||"",Q==="inventory"?(b&&(b.value=H.id_numeric||H.id||""),S&&(S.value=H.global_item_id||"")):(S&&(S.value=H.global_item_id||H.id||""),b&&(b.value="")),typeof w=="function"&&w(H,Q)}l.addEventListener("input",function(){b&&(b.value=""),S&&(S.value=""),z()}),document.addEventListener("click",function(H){!p.contains(H.target)&&!l.contains(H.target)&&p.classList.add("d-none")})}O.attachMergedInventoryGlobalTypeahead=a,O.renderInventoryTypeaheadList=x})(window);(function(O){"use strict";function e(u,m){var G=m&&m.context||"public",X=m&&m.unitOptionsHtml||"",j=m&&m.mode||(G==="public"?"public":"recipe"),A=document.createElement("div");A.className="row g-2 align-items-end mb-2",A.innerHTML=['<div class="col-md-6">','  <label class="form-label">',u==="container"?"Container":u==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',u==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',u==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',X,"  </select>","</div>",'<div class="col-md-3 ',u!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var I=A.querySelector(".tool-typeahead"),L=A.querySelector(".tool-gi-id"),x=A.querySelector('[data-role="suggestions"]');if(typeof O.attachMergedInventoryGlobalTypeahead=="function"){let y=u==="container"?"container":u==="consumable"?"consumable":"ingredient",U=G!=="public";O.attachMergedInventoryGlobalTypeahead({inputEl:I,giHiddenEl:L,listEl:x,mode:j,context:G,ingredientFirst:u==="ingredient",searchType:y,includeInventory:U,includeGlobal:!0})}return A.querySelector(".tool-remove").addEventListener("click",function(){A.remove()}),A}O.buildToolLineRow=e})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{};e.config={unitOptionsHtml:O.soapToolConfig&&O.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(O.SOAP_CALC_LIMIT)?O.SOAP_CALC_LIMIT:null,calcTier:O.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(O.soapToolConfig&&O.soapToolConfig.useCsvPrimary),printPolicy:O.soapToolConfig&&O.soapToolConfig.printPolicy||null,isAuthenticated:O.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:u,toNumber:m,clamp:G,formatTime:X,getStorage:j,buildSoapcalcSearchBuilder:A};function u(I,L=3){if(!isFinite(I))return 0;let x=Math.pow(10,L);return Math.round(I*x)/x}function m(I){let L=I;typeof L=="string"&&(L=L.replace(/,/g,"").trim());let x=parseFloat(L);return isFinite(x)?x:0}function G(I,L,x){return!isFinite(I)||I<L?L:x!=null&&I>x?x:I}function X(I){return I?`Saved ${new Date(I).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function j(){try{return O.localStorage}catch{return null}}function A(){let I=(x,y,U)=>{let o=new URLSearchParams({q:x});return y&&y!=="all"&&o.set("type",y),y==="ingredient"&&U&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},L=(x,y,U)=>{let o=new URLSearchParams({q:x});return U&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?L:I}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},m={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},G={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},X=[41,70],j=100,A=[136,170],I=250,L={hardness:(u.hardness[0]+u.hardness[1])/2,cleansing:(u.cleansing[0]+u.cleansing[1])/2,conditioning:(u.conditioning[0]+u.conditioning[1])/2,bubbly:(u.bubbly[0]+u.bubbly[1])/2,creamy:(u.creamy[0]+u.creamy[1])/2},x={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},y={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},U=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],_={g:1,oz:28.3495,lb:453.592},s=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],i=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),a=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),b=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:u,QUALITY_HINTS:m,QUALITY_FEEL_HINTS:G,IODINE_RANGE:X,IODINE_SCALE_MAX:j,INS_RANGE:A,INS_SCALE_MAX:I,QUALITY_BASE:L,QUALITY_PRESETS:x,FATTY_BAR_COLORS:y,FATTY_DISPLAY_KEYS:U,OIL_TIP_RULES:o,UNIT_FACTORS:_,STAGE_CONFIGS:s,OIL_CATEGORY_SET:i,FRAGRANCE_CATEGORY_SET:a,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:b}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{toNumber:u}=e.helpers;function m(A){let I=0,L=0;return A.forEach(x=>{x.iodine>0&&(I+=x.grams,L+=x.iodine*x.grams)}),{iodine:I>0?L/I:0,coverageWeight:I}}function G(A){let I={},L=0;A.forEach(y=>{!y.fattyProfile||typeof y.fattyProfile!="object"||(L+=y.grams,Object.entries(y.fattyProfile).forEach(([U,o])=>{let _=u(o);_>0&&(I[U]=(I[U]||0)+y.grams*(_/100))}))});let x={};return L>0&&Object.entries(I).forEach(([y,U])=>{x[y]=U/L*100}),{percent:x,coveredWeight:L}}function X(A){let I=L=>A[L]||0;return{hardness:I("lauric")+I("myristic")+I("palmitic")+I("stearic"),cleansing:I("lauric")+I("myristic"),conditioning:I("oleic")+I("linoleic")+I("linolenic")+I("ricinoleic"),bubbly:I("lauric")+I("myristic")+I("ricinoleic"),creamy:I("palmitic")+I("stearic")+I("ricinoleic")}}function j(A){if(!A||typeof A!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let I={lauric:u(A.lauric),myristic:u(A.myristic),palmitic:u(A.palmitic),stearic:u(A.stearic),ricinoleic:u(A.ricinoleic),oleic:u(A.oleic),linoleic:u(A.linoleic),linolenic:u(A.linolenic)},L=X(I);return{hardness:(L.hardness||0)/100,cleansing:(L.cleansing||0)/100,conditioning:(L.conditioning||0)/100,bubbly:(L.bubbly||0)/100,creamy:(L.creamy||0)/100}}e.calc={computeIodine:m,computeFattyAcids:G,computeQualities:X,computeOilQualityScores:j},O.SoapCalcService=e.calc})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m,clamp:G}=e.helpers,{UNIT_FACTORS:X}=e.constants,j=e.state;function A(o){return G(m(o),0)*(X[j.currentUnit]||1)}function I(o){return G(o,0)/(X[j.currentUnit]||1)}function L(o){return!isFinite(o)||o<=0?"--":`${u(I(o),2)} ${j.currentUnit}`}function x(o){return isFinite(o)?`${u(o,1)}%`:"--"}function y(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=j.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=j.currentUnit})}function U(o,_={}){if(!o)return;if(o===j.currentUnit){y();return}let s=j.currentUnit;if(j.currentUnit=o,y(),_.skipConvert)return;let i=(X[s]||1)/(X[o]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let l=m(d.value);l>0&&(d.value=u(l*i,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let l=m(d.value);l>0&&(d.value=u(l*i,2))});let a=document.getElementById("oilTotalTarget");if(a&&a.value){let d=m(a.value);d>0&&(a.value=u(d*i,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=m(r.value);d>0&&(r.value=u(d*i,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),_.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:A,fromGrams:I,formatWeight:L,formatPercent:x,updateUnitLabels:y,setUnit:U}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.state,m={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function G(s){s&&(s.classList.remove("soap-number-pulse"),s.offsetWidth,s.classList.add("soap-number-pulse"))}function X(s){var a;let i=document.getElementById(s);return!i||!((a=O.bootstrap)!=null&&a.Toast)?null:bootstrap.Toast.getOrCreateInstance(i)}function j(){let s=Date.now();if(s-u.lastSaveToastAt<3500)return;u.lastSaveToastAt=s;let i=X("soapAutosaveToast");i&&i.show()}function A(s){let i=document.getElementById("soapUndoToast");if(!i)return;let a=i.querySelector(".toast-body");a&&(a.textContent=s||"Oil removed.");let r=X("soapUndoToast");r&&r.show()}function I(){let s=document.getElementById("resultsReadyBadge"),i=document.getElementById("resultsUpdatedAt");s&&s.classList.remove("d-none"),i&&(i.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function L(s){var d,l;let i=document.getElementById("lyeConcentrationWarning"),a=document.getElementById("waterRatioWarning"),r=[];if(i){let b=(s==null?void 0:s.lyeConcentration)||0,S="";b>40&&(S="High concentration"),b>0&&b<25&&(S="Low concentration"),i.textContent=S,i.classList.toggle("d-none",!S),S&&r.push(`Lye concentration: ${S.toLowerCase()}.`)}if(a){let b=(s==null?void 0:s.waterRatio)||0,S="";b>0&&b<1.8&&(S="Low water"),b>2.7&&(S="High water"),a.textContent=S,a.classList.toggle("d-none",!S),S&&r.push(`Water to lye ratio: ${S.toLowerCase()}.`)}r.length?(d=e.guidance)==null||d.setSection("results-water-warnings",{title:"Process warnings",tone:"warning",items:r}):(l=e.guidance)==null||l.clearSection("results-water-warnings")}function x(){document.querySelectorAll("#soapToolPage .form-text").forEach(s=>{let i=s.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");i&&i.classList.add("soap-field")})}function y(s){if(!s||s.type!=="number")return;let i=s.value;if(i===""){s.classList.remove("is-invalid");return}let a=parseFloat(i),r=s.getAttribute("min"),d=s.getAttribute("max"),l=r!==null&&r!==""&&a<parseFloat(r),b=d!==null&&d!==""&&a>parseFloat(d);s.classList.toggle("is-invalid",!isFinite(a)||l||b)}function U(s){var a;if(!s)return;let i=((a=s.querySelector)==null?void 0:a.call(s,".soap-stage-card"))||s;i.classList.add("soap-stage-highlight"),setTimeout(()=>i.classList.remove("soap-stage-highlight"),900)}function o(s,i,a={}){var b;let r=document.getElementById("soapAlertStack");if(!r)return;let d=m[s]||m.info,l=document.createElement("div");l.className=`alert alert-${s} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${i}</div>
      ${a.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,a.dismissible&&((b=l.querySelector('[data-role="dismiss"]'))==null||b.addEventListener("click",()=>l.remove())),r.prepend(l),a.persist||setTimeout(()=>{l.parentNode&&l.remove()},a.timeoutMs||4500)}function _(){let s=document.getElementById("soapAlertStack");s&&s.querySelectorAll(".alert").forEach(i=>i.remove())}e.ui={pulseValue:G,getToastInstance:X,showAutosaveToast:j,showUndoToast:A,updateResultsMeta:I,updateResultsWarnings:L,applyHelperVisibility:x,validateNumericField:y,flashStage:U,showSoapAlert:o,clearSoapAlerts:_}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=new Map,m=!1;function G(_){if(!Array.isArray(_))return[];let s=new Set,i=[];return _.forEach(a=>{let r=String(a||"").trim();!r||s.has(r)||(s.add(r),i.push(r))}),i}function X(){return Array.from(u.values()).filter(_=>!_.persistent&&_.items.length)}function j(){let s=X().reduce((i,a)=>i+a.items.length,0);return s?s===1?{totalItems:s,text:"1 active formula hint from your current configuration."}:{totalItems:s,text:`${s} active formula hints from your current configuration.`}:{totalItems:0,text:"No active formula hints from your current configuration."}}function A(){let _=document.getElementById("soapGuidanceSections"),s=document.getElementById("soapGuidanceSummary"),i=document.getElementById("soapGuidanceCount"),a=document.getElementById("soapGuidanceEmpty");if(!_||!s||!i||!a)return;let r=j();s.textContent=r.text,i.textContent=String(r.totalItems);let d=Array.from(u.values()).filter(l=>l.items.length);_.innerHTML="",d.forEach(l=>{let b=document.createElement("section");b.className=`soap-guidance-section ${l.tone?`is-${l.tone}`:""}`.trim();let S=document.createElement("h6");S.className="soap-guidance-section-title",S.textContent=l.title||"Guidance";let p=document.createElement("ul");p.className="soap-guidance-list",l.items.forEach(v=>{let E=document.createElement("li");E.textContent=v,p.appendChild(E)}),b.appendChild(S),b.appendChild(p),_.appendChild(b)}),a.classList.toggle("d-none",d.length>0)}function I(_,s={}){if(!_)return;let i=G(s.items);if(!i.length){u.delete(_),A();return}u.set(_,{key:_,title:s.title||"Guidance",tone:s.tone||"",persistent:!!s.persistent,items:i}),A()}function L(_){_&&u.has(_)&&(u.delete(_),A())}function x(_){let s=document.getElementById("soapGuidanceDock"),i=document.getElementById("soapGuidanceToggle"),a=document.getElementById("soapGuidanceOverlay");if(!s||!i)return;m=!!_,s.classList.toggle("is-expanded",m),a&&a.setAttribute("aria-hidden",m?"false":"true"),i.setAttribute("aria-expanded",m?"true":"false");let r=m?"Collapse guidance panel":"Expand guidance panel";i.setAttribute("aria-label",r),i.setAttribute("title",r);let d=i.querySelector("i");d&&(d.classList.toggle("fa-caret-up",!m),d.classList.toggle("fa-caret-down",m))}function y(_){if(typeof _=="boolean"){x(_);return}x(!m)}function U(){let _=document.getElementById("soapGuidanceToggle");!_||_.dataset.bound==="true"||(_.dataset.bound="true",_.addEventListener("click",()=>y()))}function o(){U(),x(!1),I("core-safety",{title:"Safety",tone:"warning",persistent:!0,items:["Always add lye to water (never water to lye) and wear protective gear."]})}e.guidance={init:o,render:A,setSection:I,clearSection:L,setExpanded:x,toggleExpanded:y},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o,{once:!0}):o()})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{};function u(){let G=document.getElementById("soapStagePane"),X=document.getElementById("soapQualityCard"),j=document.getElementById("soapStageQualityRow"),A=document.getElementById("soapGuidanceDock");if(j&&A){let x=j.offsetHeight||0,y=Math.max(280,x+96);A.style.setProperty("--soap-guidance-overlay-height",`${y}px`)}if(!G||!X)return;if(!O.matchMedia("(min-width: 768px)").matches){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}let L=X.offsetHeight;if(!L){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}G.style.setProperty("--soap-stage-height",`${L}px`),G.classList.add("is-height-synced")}let m=()=>{O.requestAnimationFrame(u)};e.layout={syncStageHeight:u,scheduleStageHeightSync:m}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{clamp:u,toNumber:m,round:G}=e.helpers,{toGrams:X,fromGrams:j}=e.units;function A(){let o=y(),_=document.getElementById("oilTotalTarget"),s=document.getElementById("oilTargetHint");_&&o.effectiveCapacity>0&&X(_.value)<=0&&(_.value=o.targetOils>0?G(j(o.targetOils),2):""),s&&(o.effectiveCapacity>0?s.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":s.textContent="Auto-fills when mold sizing is set.");let i=document.getElementById("moldSuggestionNote");if(i){let a="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?a=`Cylinder correction applied (${G(o.cylinderFactor*100,0)}% of capacity).`:a="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),i.textContent=a}I()}function I(o=null){var v;let _=document.getElementById("moldWetBatterWarning");if(!_)return;let s=()=>{_.classList.add("d-none"),_.textContent=""},i=y(),a=e.state||{},r=a.lastCalc||null,d=(v=e.oils)!=null&&v.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=m(r==null?void 0:r.totalOils),b=m(o);if((!isFinite(b)||b<=0)&&(b=m(r==null?void 0:r.batchYield)),o==null&&l>0&&d>0&&Math.abs(l-d)>.01){s();return}if(!isFinite(b)||b<=0||i.effectiveCapacity<=0){s();return}let S=b-i.effectiveCapacity;if(S<=.01){s();return}let p=a.currentUnit||"g";_.textContent=`Full wet batter is ${G(j(b),2)} ${p}, exceeding mold capacity ${G(j(i.effectiveCapacity),2)} ${p} by ${G(j(S),2)} ${p}. Reduce oils target/% of mold or lower water/additives.`,_.classList.remove("d-none")}function L(){let o=document.getElementById("oilTotalTarget"),_=y();return o&&(_.effectiveCapacity>0&&(o.value=_.targetOils>0?G(j(_.targetOils),2):""),A()),_}function x(){let o=document.getElementById("oilTotalTarget"),_=document.getElementById("moldOilPct");if(!o||!_){let a=y();return A(),a}let s=y();if(s.effectiveCapacity>0){let a=X(o.value),r=u(a,0,s.effectiveCapacity);a>s.effectiveCapacity+.01&&(o.value=G(j(r),2));let d=r>0?r/s.effectiveCapacity*100:0;_.value=r>0?G(d,2):""}let i=y();return A(),i}function y(){var l,b,S;let o=X(document.getElementById("moldWaterWeight").value),_=u(m(document.getElementById("moldOilPct").value),0,100),s=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",i=!!((b=document.getElementById("moldCylinderCorrection"))!=null&&b.checked),a=u(m((S=document.getElementById("moldCylinderFactor"))==null?void 0:S.value),.5,1),r=o>0?o*(i?a:1):0,d=r>0?r*(_/100):0;return{waterWeight:o,oilPct:_,shape:s,useCylinder:i,cylinderFactor:a,effectiveCapacity:r,targetOils:d}}function U(){var s;let o=((s=document.getElementById("moldShape"))==null?void 0:s.value)||"loaf",_=document.getElementById("moldCylinderOptions");_&&_.classList.toggle("d-none",o!=="cylinder"),A()}e.mold={updateMoldSuggested:A,updateWetBatterWarning:I,syncTargetFromMold:L,syncMoldPctFromTarget:x,getMoldSettings:y,updateMoldShapeUI:U}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m,clamp:G,buildSoapcalcSearchBuilder:X}=e.helpers,{toGrams:j,fromGrams:A}=e.units,{OIL_CATEGORY_SET:I,OIL_TIP_RULES:L}=e.constants,{computeQualities:x}=e.calc,y=e.state,U=new Map;function o(h){return h?(h.dataset.hintKey||(y.nextOilHintId=(y.nextOilHintId||0)+1,h.dataset.hintKey=`oil-row-${y.nextOilHintId}`),h.dataset.hintKey):""}function _(){let h=new Set(Array.from(document.querySelectorAll("#oilRows .oil-row")).map(T=>o(T)));Array.from(U.keys()).forEach(T=>{let N=T.split(":")[0];h.has(N)||U.delete(T)})}function s(){var T,N;let h=Array.from(new Set(Array.from(U.values())));if(!h.length){(T=e.guidance)==null||T.clearSection("oil-entry-limits");return}(N=e.guidance)==null||N.setSection("oil-entry-limits",{title:"Stage 2 limits",tone:"warning",items:h})}function i(h){let T=h.querySelector(".oil-typeahead"),N=h.querySelector(".oil-sap-koh"),k=h.querySelector(".oil-iodine"),F=h.querySelector(".oil-fatty"),W=h.querySelector(".oil-gi-id"),P=h.querySelector(".oil-default-unit"),V=h.querySelector(".oil-category"),Y=h.querySelector('[data-role="suggestions"]');if(!T||!Y||typeof O.attachMergedInventoryGlobalTypeahead!="function")return;let K=X();O.attachMergedInventoryGlobalTypeahead({inputEl:T,listEl:Y,mode:"public",giHiddenEl:W,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:K,searchType:"ingredient",resultFilter:(J,te)=>H(J,I,te),requireHidden:!1,onSelection:function(J){N&&(N.value=(J==null?void 0:J.saponification_value)||""),k&&(k.value=(J==null?void 0:J.iodine_value)||""),F&&(F.value=J!=null&&J.fatty_acid_profile?JSON.stringify(J.fatty_acid_profile):""),P&&(P.value=(J==null?void 0:J.default_unit)||""),V&&(V.value=(J==null?void 0:J.ingredient_category_name)||""),w(J),t(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),T.addEventListener("input",function(){this.value.trim()||(N&&(N.value=""),k&&(k.value=""),F&&(F.value=""),W&&(W.value=""),P&&(P.value=""),V&&(V.value=""),M())})}function a(){var N,k;let h=document.getElementById("oilRowTemplate"),T=(k=(N=h==null?void 0:h.content)==null?void 0:N.querySelector(".oil-row"))==null?void 0:k.cloneNode(!0);return T?(T.querySelectorAll("input").forEach(F=>{F.value=""}),T.querySelectorAll(".form-text").forEach(F=>{let W=F.closest('.soap-field-stack, [class*="col-"]');W&&W.classList.add("soap-field")}),i(T),T.querySelectorAll(".unit-suffix").forEach(F=>{F.dataset.suffix=y.currentUnit}),T):document.createElement("div")}function r(){let h=document.getElementById("oilTotalTarget"),T=j(h==null?void 0:h.value);if(T>0)return T;let N=e.mold.getMoldSettings();return N.targetOils>0?N.targetOils:0}function d(h){let T=[];return h.forEach(k=>{var P,V;let F=j((P=k.querySelector(".oil-grams"))==null?void 0:P.value),W=G(m((V=k.querySelector(".oil-percent"))==null?void 0:V.value),0);F>0&&W>0&&T.push(F/(W/100))}),T.length?T.reduce((k,F)=>k+F,0)/T.length:0}function l(h,T){if(!h||!T||T<=0)return{allowedGrams:null,allowedPct:null};let N=Array.from(document.querySelectorAll("#oilRows .oil-row")),k=N.reduce((K,J)=>{var te;return J===h?K:K+j((te=J.querySelector(".oil-grams"))==null?void 0:te.value)},0),F=N.reduce((K,J)=>{var te;return J===h?K:K+G(m((te=J.querySelector(".oil-percent"))==null?void 0:te.value),0)},0),W=Math.max(0,100-F),P=Math.max(0,T-k),V=T*W/100;return{allowedGrams:Math.max(0,Math.min(P,V)),allowedPct:W}}function b(h,T,N){if(!h)return;let F=`${o(h)}:${T}`;N?U.set(F,N):U.delete(F),s()}function S(h){h&&(h.classList.remove("oil-input-bounce"),h.offsetWidth,h.classList.add("oil-input-bounce"))}function p(h,T,N={}){let k=r();if(!h||!k||k<=0){b(h,T,"");return}let F=h.querySelector(".oil-grams"),W=h.querySelector(".oil-percent"),P=l(h,k);if(T==="grams"&&F){let V=j(F.value),Y="";if(V>k+.01?Y="Entry exceeds the max oils allowed in stage 2.":P.allowedGrams!==null&&V>P.allowedGrams+.01&&(Y=`Must be under ${u(A(P.allowedGrams),2)} ${y.currentUnit} to stay within the stage 2 oil limit.`),Y){let K=P.allowedGrams!==null?u(A(P.allowedGrams),2):u(A(k),2);F.value=K>0?K:"",b(h,T,Y),F.classList.add("oil-input-warning"),S(F),t()}else F.classList.remove("oil-input-warning"),b(h,T,"")}if(T==="percent"&&W){let V=G(m(W.value),0),Y="";if(V>100.01?Y="Entry exceeds the max oils allowed in stage 2.":P.allowedPct!==null&&V>P.allowedPct+.01&&(Y=`Must be under ${u(P.allowedPct,2)}% to stay within the stage 2 oil limit.`),Y){let K=P.allowedPct!==null?u(P.allowedPct,2):100;W.value=K>0?K:"",b(h,T,Y),W.classList.add("oil-input-warning"),S(W),t()}else W.classList.remove("oil-input-warning"),b(h,T,"")}}function v(h,T={}){let N=Array.from(document.querySelectorAll("#oilRows .oil-row")),k=h!=null?h:r(),F=!!T.force;if(!k||k<=0||!N.length){y.lastOilTarget=k;return}let W=N.reduce((V,Y)=>{var K;return V+G(m((K=Y.querySelector(".oil-percent"))==null?void 0:K.value),0)},0),P=N.reduce((V,Y)=>{var K;return V+j((K=Y.querySelector(".oil-grams"))==null?void 0:K.value)},0);if(W<=0&&P<=0){y.lastOilTarget=k;return}if(!(!F&&y.lastOilTarget&&Math.abs(y.lastOilTarget-k)<.01)){if(W>0)N.forEach(V=>{let Y=V.querySelector(".oil-percent"),K=V.querySelector(".oil-grams"),J=G(m(Y==null?void 0:Y.value),0),te=W>0?J/W:0;K&&(K.value=te>0?u(A(k*te),2):""),Y&&(Y.value=te>0?u(te*100,2):"")});else if(P>0){let V=k/P;N.forEach(Y=>{let K=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),te=j(K==null?void 0:K.value);if(K){let ae=te>0?te*V:0;K.value=ae>0?u(A(ae),2):""}if(J){let ae=j(K==null?void 0:K.value);J.value=ae>0?u(ae/k*100,2):""}})}y.lastOilTarget=k,t({skipEnforce:!0})}}function E(h,T){if(!y.lastOilEdit||!y.lastOilEdit.row)return!1;let N=y.lastOilEdit.row,k=h.reduce((V,Y)=>{var K;return Y===N?V:V+j((K=Y.querySelector(".oil-grams"))==null?void 0:K.value)},0),F=Math.max(0,T-k),W=N.querySelector(".oil-grams"),P=N.querySelector(".oil-percent");return!W||!P?!1:(W.value=F>0?u(A(F),2):"",P.value=F>0?u(F/T*100,2):"",y.wasCapped=!0,!0)}function g({totalWeight:h,totalPct:T,target:N,capped:k}){var W,P;let F=[];if(k&&F.push("Oil total hit the mold cap and was adjusted."),N>0&&h>N+.01){let V=h-N;F.push(`Oil weights exceed the target by ${u(A(V),2)} ${y.currentUnit}.`)}if(T>100.01&&F.push(`Oil percentages are over 100% by ${u(T-100,2)}%.`),F.length){(W=e.guidance)==null||W.setSection("oil-cap-warning",{title:"Oil cap warnings",tone:"warning",items:[`${F.join(" ")} Adjust oils or mold % to continue.`]});return}(P=e.guidance)==null||P.clearSection("oil-cap-warning")}function t(h={}){var V;h.skipEnforce||(y.wasCapped=!1),_(),s();let T=Array.from(document.querySelectorAll("#oilRows .oil-row")),N=e.mold.getMoldSettings(),k=r();if(!k&&!N.targetOils){let Y=d(T);if(Y>0){k=Y;let K=document.getElementById("oilTotalTarget");K&&!K.value&&(K.value=u(A(Y),2))}}let F=0,W=0;if(T.forEach(Y=>{let K=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),te=j(K==null?void 0:K.value),ae=G(m(J==null?void 0:J.value),0);k>0&&(y.lastOilEdit&&y.lastOilEdit.row===Y&&y.lastOilEdit.field==="percent"?(te=ae>0?k*(ae/100):0,K.value=ae>0?u(A(te),2):""):te>0?(ae=te/k*100,J.value=u(ae,2)):ae>0&&(te=k*(ae/100),K.value=u(A(te),2)),W+=ae),te>0&&(F+=te)}),k<=0&&(F>0?(W=0,T.forEach(Y=>{let K=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),te=j(K==null?void 0:K.value);if(te>0){let ae=te/F*100;J.value=u(ae,2),W+=ae}})):W=T.reduce((Y,K)=>{var J;return Y+G(m((J=K.querySelector(".oil-percent"))==null?void 0:J.value),0)},0)),!h.skipEnforce&&N.targetOils>0&&F>N.targetOils+.01&&E(T,N.targetOils))return t({skipEnforce:!0});y.totalOilsGrams=F;let P=document.getElementById("oilTotalComputed");return P&&(P.textContent=F>0?`${u(A(F),2)} ${y.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=u(W,2),g({totalWeight:F,totalPct:W,target:k,capped:y.wasCapped}),e.additives.updateAdditivesOutput(F),(V=e.fragrances)!=null&&V.updateFragranceTotals&&e.fragrances.updateFragranceTotals(F),e.mold.updateMoldSuggested(),$(),{totalWeight:F,totalPct:W,target:k}}function f(){let h=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!h.length)return;let T=r(),N=h.reduce((k,F)=>{var W;return k+G(m((W=F.querySelector(".oil-percent"))==null?void 0:W.value),0)},0);!N&&T>0&&(N=h.reduce((k,F)=>{var P;let W=j((P=F.querySelector(".oil-grams"))==null?void 0:P.value);return k+(W>0?W/T*100:0)},0)),!(N<=0)&&(h.forEach(k=>{let F=k.querySelector(".oil-percent"),W=k.querySelector(".oil-grams"),V=G(m(F.value),0)/N*100;F.value=u(V,2),T>0&&(W.value=V>0?u(A(T*(V/100)),2):"")}),t())}function C(){let h=[];return document.querySelectorAll("#oilRows .oil-row").forEach(T=>{var te,ae,ce,oe,ye,he,de,me,n;let N=(ae=(te=T.querySelector(".oil-typeahead"))==null?void 0:te.value)==null?void 0:ae.trim(),k=j((ce=T.querySelector(".oil-grams"))==null?void 0:ce.value),F=m((oe=T.querySelector(".oil-sap-koh"))==null?void 0:oe.value),W=m((ye=T.querySelector(".oil-iodine"))==null?void 0:ye.value),P=((he=T.querySelector(".oil-fatty"))==null?void 0:he.value)||"",V=((de=T.querySelector(".oil-gi-id"))==null?void 0:de.value)||"",Y=((me=T.querySelector(".oil-default-unit"))==null?void 0:me.value)||"",K=((n=T.querySelector(".oil-category"))==null?void 0:n.value)||"",J=null;if(P)try{J=JSON.parse(P)}catch{J=null}k<=0||h.push({name:N||null,grams:k,sapKoh:F,iodine:W,fattyProfile:J,global_item_id:V?parseInt(V):null,default_unit:Y||null,ingredient_category_name:K||null})}),h}function R({name:h,sapKoh:T,iodine:N,fattyProfile:k}={}){let F=document.getElementById("oilProfileFloat"),W=(ae,ce)=>{let oe=document.getElementById(ae);oe&&(oe.textContent=ce)},P=h||"Pick an oil to preview";W("selectedOilName",P),W("selectedOilModalName",P),F&&F.classList.toggle("d-none",!h);let V=T>0?u(T,1):"--",Y=N>0?u(N,1):"--";W("selectedOilSap",V),W("selectedOilModalSap",V),W("selectedOilIodine",Y),W("selectedOilModalIodine",Y);let K=k?x(k):{},J=(ae,ce)=>{let oe=isFinite(ce)&&ce>0?u(ce,1):"--";W(ae,oe)};J("selectedOilHardness",K.hardness),J("selectedOilModalHardness",K.hardness),J("selectedOilCleansing",K.cleansing),J("selectedOilModalCleansing",K.cleansing),J("selectedOilConditioning",K.conditioning),J("selectedOilModalConditioning",K.conditioning),J("selectedOilBubbly",K.bubbly),J("selectedOilModalBubbly",K.bubbly),J("selectedOilCreamy",K.creamy),J("selectedOilModalCreamy",K.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(ae=>{let ce=`selectedOil${ae.charAt(0).toUpperCase()}${ae.slice(1)}`,oe=`selectedOilModal${ae.charAt(0).toUpperCase()}${ae.slice(1)}`,ye=k?m(k[ae]):0,he=ye>0?u(ye,1):"--";W(ce,he),W(oe,he)})}function w(h){if(!h){M();return}y.selectedOilProfile=h;let T=h.fatty_acid_profile||null;if(typeof T=="string")try{T=JSON.parse(T)}catch{T=null}R({name:h.text||h.display_name||h.name,sapKoh:m(h.saponification_value),iodine:m(h.iodine_value),fattyProfile:T})}function B(h){var P,V,Y,K,J;if(!h)return;let T=(V=(P=h.querySelector(".oil-typeahead"))==null?void 0:P.value)==null?void 0:V.trim(),N=m((Y=h.querySelector(".oil-sap-koh"))==null?void 0:Y.value),k=m((K=h.querySelector(".oil-iodine"))==null?void 0:K.value),F=((J=h.querySelector(".oil-fatty"))==null?void 0:J.value)||"",W=null;if(F)try{W=JSON.parse(F)}catch{W=null}R({name:T,sapKoh:N,iodine:k,fattyProfile:W})}function M(){y.selectedOilProfile=null,y.lastPreviewRow=null,R()}function $(){var k,F,W;let h=C().filter(P=>P.grams>0||P.percent>0);if(!h.length){(k=e.guidance)==null||k.clearSection("oil-blend-tips");return}let T=new Set;h.forEach(P=>{let V=(P.name||"").toLowerCase();if(V&&L.forEach(Y=>{Y.match.test(V)&&T.add(Y.tip)}),P.fattyProfile&&typeof P.fattyProfile=="object"){let Y=m(P.fattyProfile.lauric),K=m(P.fattyProfile.myristic),J=m(P.fattyProfile.palmitic),te=m(P.fattyProfile.stearic),ae=m(P.fattyProfile.ricinoleic),ce=m(P.fattyProfile.oleic),oe=m(P.fattyProfile.linoleic),ye=m(P.fattyProfile.linolenic);Y+K>=30&&T.add(`${P.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),J+te>=40&&T.add(`${P.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),ce>=60&&T.add(`${P.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),oe+ye>=20&&T.add(`${P.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),ae>=60&&T.add(`${P.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let N=Array.from(T).slice(0,6);if(!N.length){(F=e.guidance)==null||F.clearSection("oil-blend-tips");return}(W=e.guidance)==null||W.setSection("oil-blend-tips",{title:"Blend behavior tips",tone:"info",items:N})}function z(){return y.totalOilsGrams||0}function Z(h){var T,N,k,F,W,P,V,Y,K;return h?{name:((T=h.querySelector(".oil-typeahead"))==null?void 0:T.value)||"",grams:((N=h.querySelector(".oil-grams"))==null?void 0:N.value)||"",percent:((k=h.querySelector(".oil-percent"))==null?void 0:k.value)||"",sap:((F=h.querySelector(".oil-sap-koh"))==null?void 0:F.value)||"",iodine:((W=h.querySelector(".oil-iodine"))==null?void 0:W.value)||"",fattyRaw:((P=h.querySelector(".oil-fatty"))==null?void 0:P.value)||"",gi:((V=h.querySelector(".oil-gi-id"))==null?void 0:V.value)||"",defaultUnit:((Y=h.querySelector(".oil-default-unit"))==null?void 0:Y.value)||"",categoryName:((K=h.querySelector(".oil-category"))==null?void 0:K.value)||""}:null}function H(h,T,N){let k=Q(h);return k?T.has(k):N==="inventory"}function Q(h){return!h||typeof h!="object"?null:h.ingredient&&h.ingredient.ingredient_category_name||h.ingredient_category_name||h.ingredient_category&&h.ingredient_category.name||null}e.oils={attachOilTypeahead:i,buildOilRow:a,getOilTargetGrams:r,updateOilTotals:t,normalizeOils:f,collectOilData:C,setSelectedOilProfileFromRow:B,clearSelectedOilProfile:M,updateOilTips:$,getTotalOilsGrams:z,serializeOilRow:Z,validateOilEntry:p,scaleOilsToTarget:v}})(window);(function(O){"use strict";var g;let e=O.SoapTool=O.SoapTool||{},u=e.bulkOils=e.bulkOils||{},{toNumber:m,clamp:G}=e.helpers,X=e.state,j=Array.isArray((g=e.constants)==null?void 0:g.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],A=new Set(["selected_pct","selected_weight_g"]),I=25,L=140,x=260,y={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function U(){var t,f;(f=(t=e.storage)==null?void 0:t.queueStateSave)==null||f.call(t)}function o(t,f){var C,R;(R=(C=e.ui)==null?void 0:C.showSoapAlert)==null||R.call(C,t,f,{dismissible:!0,timeoutMs:6e3})}function _(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function s(t){return t?t==="name"||A.has(t)?!0:j.includes(t):!1}function i(){(!X.bulkOilModal||typeof X.bulkOilModal!="object")&&(X.bulkOilModal=JSON.parse(JSON.stringify(y)));let t=X.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=s(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function a(t){let f={},C=t&&typeof t=="object"?t:{};return j.forEach(R=>{let w=m(C[R]);w>0&&(f[R]=w)}),f}function r(t){let f=a(t==null?void 0:t.fatty_profile),C=String((t==null?void 0:t.name)||"").trim(),R=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:m(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${R}:${C.toLowerCase()}`)),name:C,sap_koh:m(t==null?void 0:t.sap_koh),iodine:m(t==null?void 0:t.iodine),fatty_profile:f,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:R,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=_(),f=i(),C=Object.keys(f.selection||{}).length,R=`Selected: ${C}`;t.summaryEl&&(t.summaryEl.textContent=R),t.stageCountEl&&(t.stageCountEl.textContent=String(C))}function l(t){var C;return((C=i().selection)==null?void 0:C[t])||null}function b(t,f={}){var B,M;let C=i();if(!t||!t.key)return null;let R=C.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:G(m((B=f.selected_pct)!=null?B:R.selected_pct),0,100),selected_weight_g:G(m((M=f.selected_weight_g)!=null?M:R.selected_weight_g),0)};return C.selection[t.key]=w,w}function S(t){var C;let f=i();(C=f.selection)!=null&&C[t]&&delete f.selection[t]}function p(t){var C;return((C=i().recordByKey)==null?void 0:C[t])||null}function v(){let t=i();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(f=>({key:f.key,name:f.name,sap_koh:f.sap_koh,iodine:f.iodine,fatty_profile:f.fatty_profile||{},default_unit:f.default_unit,ingredient_category_name:f.ingredient_category_name,global_item_id:f.global_item_id,source:f.source,is_basic:!!f.is_basic,selected_pct:G(m(f.selected_pct),0,100),selected_weight_g:G(m(f.selected_weight_g),0)}))}}function E(t){let f=i();f.mode="all",f.viewSelected=!!(t!=null&&t.view_selected),f.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",f.sortKey=s(t==null?void 0:t.sort_key)?t.sort_key:"name",f.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let C={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let B=String((w==null?void 0:w.key)||"").trim(),M=String((w==null?void 0:w.name)||"").trim();!B||!M||(C[B]={key:B,name:M,sap_koh:m(w==null?void 0:w.sap_koh),iodine:m(w==null?void 0:w.iodine),fatty_profile:a(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:m(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:G(m(w==null?void 0:w.selected_pct),0,100),selected_weight_g:G(m(w==null?void 0:w.selected_weight_g),0)})}),f.selection=C,f.visibleRecords=[],f.offset=0,f.totalCount=0,f.hasMore=!0,f.loading=!1,d()}u.shared={FATTY_KEYS:j,LOCAL_SORT_KEYS:A,PAGE_SIZE:I,SCROLL_FETCH_THRESHOLD:L,SEARCH_DEBOUNCE_MS:x,queueStateSave:U,showAlert:o,getRefs:_,ensureModalState:i,normalizeFattyProfile:a,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:l,setSelection:b,removeSelection:S,getRecordByKey:p,serializeSelection:v,restoreState:E}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.bulkOils=e.bulkOils||{},m=u.shared;if(!m)return;let{round:G,toNumber:X}=e.helpers,{fromGrams:j}=e.units,{FATTY_KEYS:A,LOCAL_SORT_KEYS:I,getRefs:L,ensureModalState:x,selectionForRecordKey:y,updateSelectionCounters:U}=m;function o(g){let t=L();t.statusEl&&(t.statusEl.textContent=g)}function _(){let g=x();if(g.loading&&!g.visibleRecords.length){o("Loading oils...");return}if(!g.visibleRecords.length){let w=g.query?"No oils match that search.":"No oils available.";o(w);return}let t=g.visibleRecords.length,f=g.totalCount,C=g.hasMore?" \u2022 scroll for more":"",R=g.query?` \u2022 search: "${g.query}"`:"";o(`Showing ${t} of ${f} oils${R}${C}`)}function s(g,t,f){if(typeof g=="string"||typeof t=="string"){let w=String(g||"").toLowerCase(),B=String(t||"").toLowerCase();return w<B?f==="asc"?-1:1:w>B?f==="asc"?1:-1:0}let C=X(g),R=X(t);return C<R?f==="asc"?-1:1:C>R?f==="asc"?1:-1:0}function i(g,t){var f,C;return t==="selected_pct"?((f=y(g.key))==null?void 0:f.selected_pct)||0:t==="selected_weight_g"?((C=y(g.key))==null?void 0:C.selected_weight_g)||0:""}function a(){let g=x();I.has(g.sortKey)&&g.visibleRecords.sort((t,f)=>{let C=s(i(t,g.sortKey),i(f,g.sortKey),g.sortDir);return C!==0?C:s(t.name||"",f.name||"","asc")})}function r(){let g=x();if(!g.viewSelected)return;let t=[],f=[];g.visibleRecords.forEach(C=>{y(C.key)?t.push(C):f.push(C)}),g.visibleRecords=t.concat(f)}function d(){a(),r()}function l(g){let t=String(g||"").trim().toLowerCase();return t==="name"||A.includes(t)?t:"name"}function b(){let g=x();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let f=t.dataset.label||"",C=t.dataset.sortKey||"";g.sortKey===C?t.textContent=`${f} ${g.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=f})}function S(g,t){let f=y(t.key),C=g.querySelector(".bulk-oil-check"),R=g.querySelector(".bulk-oil-pct"),w=g.querySelector(".bulk-oil-weight");C&&(C.checked=!!f),R&&(R.value=f&&f.selected_pct>0?G(f.selected_pct,2):""),w&&(w.value=f&&f.selected_weight_g>0?G(j(f.selected_weight_g),2):"")}function p(g){let t=document.createElement("td");t.className="bulk-oil-acid";let f=X(g);return t.textContent=f>0?G(f,1).toString():"--",t}function v(g){let t=document.createElement("tr");t.dataset.recordKey=g.key;let f=document.createElement("td");f.className="text-center";let C=document.createElement("input");C.type="checkbox",C.className="form-check-input bulk-oil-check",f.appendChild(C),t.appendChild(f);let R=document.createElement("td");R.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=g.name;let B=document.createElement("div");B.className="text-muted small";let M=g.ingredient_category_name?` \xB7 ${g.ingredient_category_name}`:"";B.textContent=`${g.source}${M}`,R.appendChild(w),R.appendChild(B),t.appendChild(R),A.forEach(Q=>{var h;t.appendChild(p((h=g.fatty_profile)==null?void 0:h[Q]))});let $=document.createElement("td"),z=document.createElement("input");z.type="number",z.min="0",z.max="100",z.step="0.1",z.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",$.appendChild(z),t.appendChild($);let Z=document.createElement("td"),H=document.createElement("input");return H.type="number",H.min="0",H.step="0.1",H.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",Z.appendChild(H),t.appendChild(Z),S(t,g),t}function E(){let g=L(),t=x();if(!g.bodyEl)return;g.bodyEl.innerHTML="";let f=document.createDocumentFragment();t.visibleRecords.forEach(C=>{f.appendChild(v(C))}),g.bodyEl.appendChild(f),b(),U(),_()}u.render={updateStatusText:o,refreshCatalogStatus:_,applyLocalSelectionSortIfNeeded:a,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:l,sortButtonsLabel:b,renderVisibleRecords:E}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.bulkOils=e.bulkOils||{},m=u.shared,G=u.render;if(!m||!G)return;let{PAGE_SIZE:X,getRefs:j,ensureModalState:A,normalizeCatalogRecord:I}=m,{refreshCatalogStatus:L,normalizeServerSortKey:x,applyClientOrdering:y,renderVisibleRecords:U,updateStatusText:o}=G;function _(){let i=A(),a=j();i.visibleRecords=[],i.offset=0,i.totalCount=0,i.hasMore=!0,a.bodyEl&&(a.bodyEl.innerHTML=""),a.scrollEl&&(a.scrollEl.scrollTop=0)}async function s({reset:i=!1}={}){let a=A();if(!j().modalEl||a.loading&&!i||!a.hasMore&&!i)return;i&&_();let d=a.requestToken+1;a.requestToken=d,a.loading=!0,L();let l=new URLSearchParams;l.set("mode",a.mode),l.set("offset",String(a.offset)),l.set("limit",String(X)),l.set("q",a.query||""),l.set("sort_key",x(a.sortKey)),l.set("sort_dir",a.sortDir==="desc"?"desc":"asc");try{let b=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!b.ok)throw new Error("Unable to load oils catalog");let S=await b.json();if(!S||S.success!==!0||!S.result||!Array.isArray(S.result.records))throw new Error("Invalid oils catalog response");if(d!==a.requestToken)return;let p=S.result.records.map(I),v=Math.max(0,parseInt(S.result.next_offset,10)||a.offset+p.length),E=Math.max(p.length,parseInt(S.result.count,10)||0),g=!!S.result.has_more;p.forEach(t=>{a.recordByKey[t.key]=t}),a.visibleRecords=i?p.slice():a.visibleRecords.concat(p),a.offset=v,a.totalCount=E,a.hasMore=g,y(),U()}catch(b){throw d===a.requestToken&&o("Unable to load oils catalog."),b}finally{d===a.requestToken&&(a.loading=!1,L())}}u.api={fetchCatalogPage:s}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.bulkOils=e.bulkOils||{},m=u.shared,G=u.render,X=u.api;if(!m||!G||!X)return;let{round:j,toNumber:A,clamp:I}=e.helpers,{toGrams:L,fromGrams:x}=e.units,y=e.state,{LOCAL_SORT_KEYS:U,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:_,queueStateSave:s,showAlert:i,getRefs:a,ensureModalState:r,updateSelectionCounters:d,setSelection:l,removeSelection:b,getRecordByKey:S,serializeSelection:p,restoreState:v}=m,{applyClientOrdering:E,sortButtonsLabel:g,renderVisibleRecords:t}=G,{fetchCatalogPage:f}=X,C=null,R=null;function w(){var c;let n=a();n.modalEl&&(!C&&((c=O.bootstrap)!=null&&c.Modal)&&(C=O.bootstrap.Modal.getOrCreateInstance(n.modalEl)),C&&C.hide())}function B(){return document.getElementById("oilRows")}function M(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function $(n){return String(n||"").trim().toLowerCase()}function z(n){var c;return $((c=n==null?void 0:n.querySelector(".oil-typeahead"))==null?void 0:c.value)}function Z(n){var q;let c=String(((q=n==null?void 0:n.querySelector(".oil-gi-id"))==null?void 0:q.value)||"").trim();return c||""}function H(n,c){let q=String(n||"").trim();if(!q)return null;let D=M(),ee=D.find(re=>String(re.dataset.bulkOilKey||"")===q);if(ee)return ee;let ne=String((c==null?void 0:c.global_item_id)||"").trim();if(ne&&(ee=D.find(re=>Z(re)===ne),ee))return ee;let le=$(c==null?void 0:c.name);return le&&(ee=D.find(re=>z(re)===le),ee)?ee:null}function Q(n,c){if(!n||!c)return;n.dataset.bulkOilKey=c.key||"";let q=n.querySelector(".oil-typeahead"),D=n.querySelector(".oil-sap-koh"),ee=n.querySelector(".oil-iodine"),ne=n.querySelector(".oil-fatty"),le=n.querySelector(".oil-gi-id"),re=n.querySelector(".oil-default-unit"),ge=n.querySelector(".oil-category"),se=n.querySelector(".oil-grams"),ue=n.querySelector(".oil-percent");q&&(q.value=c.name||""),D&&(D.value=c.sap_koh>0?j(c.sap_koh,3):""),ee&&(ee.value=c.iodine>0?j(c.iodine,3):""),ne&&(ne.value=c.fatty_profile&&Object.keys(c.fatty_profile).length?JSON.stringify(c.fatty_profile):""),le&&(le.value=c.global_item_id||""),re&&(re.value=c.default_unit||""),ge&&(ge.value=c.ingredient_category_name||""),ue&&(ue.value=c.selected_pct>0?j(c.selected_pct,2):""),se&&(se.value=c.selected_weight_g>0?j(x(c.selected_weight_g),2):"")}function h(n){if(!n||!n.key)return null;let c=H(n.key,n),q=B();return!c&&q&&(c=e.oils.buildOilRow(),c&&q.appendChild(c)),Q(c,n),c}function T(n,c){let q=H(n,c);q&&(y.lastOilEdit&&y.lastOilEdit.row===q&&(y.lastOilEdit=null,e.oils.clearSelectedOilProfile()),q.remove())}function N(){M().forEach(c=>{y.lastOilEdit&&y.lastOilEdit.row===c&&(y.lastOilEdit=null),c.remove()}),e.oils.clearSelectedOilProfile()}function k(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function F(n,c,q){let D=String(q||"").trim();if(D)return D;let ee=String(c||"").trim();if(ee)return`global:${ee}`;let ne=$(n);return ne?`soapcalc:${ne}`:""}function W(){let n={};return M().forEach(c=>{var be,we,Ce,Te,_e,qe,Ee,Se,ie;let q=String(((be=c.querySelector(".oil-typeahead"))==null?void 0:be.value)||"").trim(),D=A((we=c.querySelector(".oil-sap-koh"))==null?void 0:we.value),ee=A((Ce=c.querySelector(".oil-iodine"))==null?void 0:Ce.value),ne=String(((Te=c.querySelector(".oil-gi-id"))==null?void 0:Te.value)||"").trim(),le=String(((_e=c.querySelector(".oil-default-unit"))==null?void 0:_e.value)||"gram"),re=String(((qe=c.querySelector(".oil-category"))==null?void 0:qe.value)||""),ge=I(A((Ee=c.querySelector(".oil-percent"))==null?void 0:Ee.value),0,100),se=I(L((Se=c.querySelector(".oil-grams"))==null?void 0:Se.value),0),ue=String(((ie=c.querySelector(".oil-fatty"))==null?void 0:ie.value)||""),ve={};if(ue)try{let fe=JSON.parse(ue);ve=m.normalizeFattyProfile(fe)}catch{ve={}}let pe=F(q,ne,c.dataset.bulkOilKey);!pe||!(q||ge>0||se>0||D>0||ee>0||Object.keys(ve).length>0)||(c.dataset.bulkOilKey=pe,n[pe]={key:pe,name:q||"Unnamed oil",sap_koh:D,iodine:ee,fatty_profile:ve,default_unit:le||"gram",ingredient_category_name:re,global_item_id:ne?parseInt(ne,10):null,source:ne?"global":"soapcalc",is_basic:!ne,selected_pct:ge,selected_weight_g:se})}),n}function P(){let n=r();n.selection=W(),d()}function V(){let n=r(),c=Object.values(n.selection||{}),q=new Set(c.map(D=>D.key));M().forEach(D=>{let ee=String(D.dataset.bulkOilKey||"").trim();(!ee||!q.has(ee))&&D.remove()}),c.slice().sort((D,ee)=>String(D.name||"").localeCompare(String(ee.name||""))).forEach(D=>{h(D)}),k()}async function Y(){var q;let n=a(),c=r();if(n.modalEl){P(),!C&&((q=O.bootstrap)!=null&&q.Modal)&&(C=O.bootstrap.Modal.getOrCreateInstance(n.modalEl)),n.searchInput&&(n.searchInput.value=c.query||""),n.viewSelectedToggle&&(n.viewSelectedToggle.checked=!!c.viewSelected),n.unitLabelEl&&(n.unitLabelEl.textContent=y.currentUnit||"g"),C&&C.show(),g(),d();try{await f({reset:!0})}catch{i("danger","Unable to load bulk oils catalog right now.")}}}function K(n){let c=n.target;if(!(c instanceof HTMLElement))return;let q=c.closest("tr[data-record-key]");if(!q)return;let D=q.dataset.recordKey||"",ee=S(D);if(!ee)return;let ne=q.querySelector(".bulk-oil-check"),le=q.querySelector(".bulk-oil-pct"),re=q.querySelector(".bulk-oil-weight"),ge=I(A(le==null?void 0:le.value),0,100),se=I(L(re==null?void 0:re.value),0),ue=ge>0||se>0;if(!!(ne!=null&&ne.checked)||ue){ne&&(ne.checked=!0);let be=l(ee,{selected_pct:ge,selected_weight_g:se});h(be)}else b(D),T(D,ee);let pe=r();U.has(pe.sortKey)||pe.viewSelected?(E(),t()):d(),k(),s()}function J(n){let c=r();c.viewSelected=!!n,E(),t(),s()}async function te(n){let c=n.target instanceof HTMLElement?n.target.closest(".bulk-oil-sort"):null;if(!c)return;let q=c.getAttribute("data-sort-key")||"name",D=r();if(D.sortKey===q?D.sortDir=D.sortDir==="asc"?"desc":"asc":(D.sortKey=q,D.sortDir=q==="name"?"asc":"desc"),s(),U.has(D.sortKey)){E(),t();return}try{await f({reset:!0})}catch{i("danger","Unable to load oils in that sort order.")}}function ae(){let n=r();n.selection={},N(),(U.has(n.sortKey)||n.viewSelected)&&E(),t(),k(),s()}async function ce(){let n=a(),c=r();if(!(!n.scrollEl||c.loading||!c.hasMore||!(n.scrollEl.scrollTop+n.scrollEl.clientHeight>=n.scrollEl.scrollHeight-o)))try{await f({reset:!1})}catch{i("danger","Unable to load more oils right now.")}}function oe(){R&&O.clearTimeout(R),R=O.setTimeout(async()=>{try{await f({reset:!0})}catch{i("danger","Unable to search oils right now.")}},_)}function ye(){V(),s(),w()}function he(n,c){if(!(n instanceof HTMLInputElement))return!1;let D=a().bodyEl;if(!(D instanceof HTMLElement))return!1;let ee=n.classList.contains("bulk-oil-pct")?"bulk-oil-pct":n.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!ee)return!1;let ne=Array.from(D.querySelectorAll(`input.${ee}`)),le=ne.indexOf(n);if(le<0)return!1;let re=le+c;if(re<0||re>=ne.length)return!1;let ge=ne[re];return ge instanceof HTMLInputElement?(ge.focus(),typeof ge.select=="function"&&ge.select(),!0):!1}function de(){var c;let n=a();n.unitLabelEl&&(n.unitLabelEl.textContent=y.currentUnit||"g"),(c=n.modalEl)!=null&&c.classList.contains("show")&&t()}function me(){let n=a();n.modalEl&&(n.openBtn&&n.openBtn.addEventListener("click",()=>{Y()}),n.searchInput&&n.searchInput.addEventListener("input",()=>{let c=r();c.query=n.searchInput.value||"",s(),oe()}),n.viewSelectedToggle&&n.viewSelectedToggle.addEventListener("change",()=>{J(!!n.viewSelectedToggle.checked)}),n.scrollEl&&n.scrollEl.addEventListener("scroll",ce),n.bodyEl&&(n.bodyEl.addEventListener("change",K),n.bodyEl.addEventListener("keydown",c=>{let q=c.target;if(!(!(q instanceof HTMLInputElement)||!(q.classList.contains("bulk-oil-pct")||q.classList.contains("bulk-oil-weight")))){if(c.key==="Enter"){c.preventDefault(),q.blur();return}c.key==="Tab"&&he(q,c.shiftKey?-1:1)&&c.preventDefault()}})),n.modalEl.querySelectorAll(".bulk-oil-sort").forEach(c=>{c.addEventListener("click",te)}),n.importBtn&&n.importBtn.addEventListener("click",()=>{ye()}),n.clearBtn&&n.clearBtn.addEventListener("click",()=>{ae()}),n.modalEl.addEventListener("shown.bs.modal",()=>{let c=a();c.searchInput&&c.searchInput.focus()}))}me(),d(),g(),e.bulkOilsModal={openModal:Y,serializeSelection:p,restoreState:v,onUnitChanged:de}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{toNumber:u,round:m,clamp:G,buildSoapcalcSearchBuilder:X}=e.helpers,{formatWeight:j,toGrams:A,fromGrams:I}=e.units,{FRAGRANCE_CATEGORY_SET:L}=e.constants,x=e.state;function y(E,g,t,f,C){var Z;let R=document.getElementById(E),w=document.getElementById(g),B=f?document.getElementById(f):null,M=C?document.getElementById(C):null,$=(Z=R==null?void 0:R.parentElement)==null?void 0:Z.querySelector('[data-role="suggestions"]');if(!R||!$||typeof O.attachMergedInventoryGlobalTypeahead!="function")return;let z=X();O.attachMergedInventoryGlobalTypeahead({inputEl:R,listEl:$,mode:"public",giHiddenEl:w,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:z,searchType:"ingredient",resultFilter:(H,Q)=>{let h=v(H);return h?t.has(h):Q==="inventory"},requireHidden:!1,onSelection:function(H){B&&(B.value=(H==null?void 0:H.default_unit)||""),M&&(M.value=(H==null?void 0:H.ingredient_category_name)||""),e.storage.queueStateSave()}}),R.addEventListener("input",function(){this.value.trim()||(B&&(B.value=""),M&&(M.value=""))})}function U({pctId:E,weightId:g}){var w,B,M;let t=document.getElementById(E),f=t==null?void 0:t.value;if(f!==""&&f!==null&&f!==void 0)return u(f);let C=G(((B=(w=e.oils)==null?void 0:w.getTotalOilsGrams)==null?void 0:B.call(w))||0,0);if(C<=0)return 0;let R=A((M=document.getElementById(g))==null?void 0:M.value);return R<=0?0:R/C*100}function o(){var E,g,t,f,C,R,w,B;return{lactatePct:U({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:U({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:U({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:U({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((g=(E=document.getElementById("additiveLactateName"))==null?void 0:E.value)==null?void 0:g.trim())||"Sodium Lactate",sugarName:((f=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:f.trim())||"Sugar",saltName:((R=(C=document.getElementById("additiveSaltName"))==null?void 0:C.value)==null?void 0:R.trim())||"Salt",citricName:((B=(w=document.getElementById("additiveCitricName"))==null?void 0:w.value)==null?void 0:B.trim())||"Citric Acid"}}function _(){var g;return(((g=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:g.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function s(E){let g=G(u(E),0),t=G(U({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),f=G(U({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),C=G(U({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),R=G(U({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),w=g*(t/100),B=g*(f/100),M=g*(C/100),$=g*(R/100),z=_()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:f,saltPct:C,citricPct:R,lactateG:w,sugarG:B,saltG:M,citricG:$,citricLyeG:$*z}}function i({pctId:E,weightId:g,sourceField:t,totalOils:f}){let C=document.getElementById(E),R=document.getElementById(g);if(!C||!R)return;let w=G(u(f),0);if(w<=0)return;if(t==="weight"){let z=R.value;if(z===""||z===null||z===void 0){C.value="";return}let Z=G(A(z),0),H=Z>0?Z/w*100:0;C.value=H>0?m(H,2):"";return}let B=C.value;if(B===""||B===null||B===void 0){R.value="";return}let M=G(u(B),0),$=w*(M/100);R.value=$>0?m(I($),2):""}function a(E){let g=(f,C)=>{let R=document.getElementById(f);if(R)if(R.tagName==="INPUT"){if(document.activeElement===R)return;R.value=C}else R.textContent=C},t=f=>f>0?m(I(f),2):"";g("additiveLactateWeight",t(u(E==null?void 0:E.lactateG))),g("additiveSugarWeight",t(u(E==null?void 0:E.sugarG))),g("additiveSaltWeight",t(u(E==null?void 0:E.saltG))),g("additiveCitricWeight",t(u(E==null?void 0:E.citricG))),g("additiveCitricLyeOut",j(u(E==null?void 0:E.citricLyeG)))}function r(E){let g=G(u(E),0),t=s(g);return a(t),t}function d(E){let g=E.querySelector(".fragrance-typeahead"),t=E.querySelector(".fragrance-gi-id"),f=E.querySelector(".fragrance-default-unit"),C=E.querySelector(".fragrance-category"),R=E.querySelector('[data-role="suggestions"]');if(!g||!R||typeof O.attachMergedInventoryGlobalTypeahead!="function")return;let w=X();O.attachMergedInventoryGlobalTypeahead({inputEl:g,listEl:R,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:w,searchType:"ingredient",resultFilter:(B,M)=>{let $=v(B);return $?L.has($):M==="inventory"},requireHidden:!1,onSelection:function(B){f&&(f.value=(B==null?void 0:B.default_unit)||""),C&&(C.value=(B==null?void 0:B.ingredient_category_name)||""),e.storage.queueStateSave()}}),g.addEventListener("input",function(){this.value.trim()||(f&&(f.value=""),C&&(C.value=""))})}function l(){var t,f;let E=document.getElementById("fragranceRowTemplate"),g=(f=(t=E==null?void 0:E.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:f.cloneNode(!0);return g?(g.querySelectorAll("input").forEach(C=>{C.value=""}),d(g),g.querySelectorAll(".unit-suffix").forEach(C=>{C.dataset.suffix=x.currentUnit}),g):document.createElement("div")}function b(E){let g=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=G(E||e.oils.getTotalOilsGrams()||0,0),f=0,C=0;g.forEach(B=>{let M=B.querySelector(".fragrance-grams"),$=B.querySelector(".fragrance-percent");if(!M||!$)return;let z=M.value,Z=$.value,H=A(z),Q=G(u(Z),0),h=e.state.lastFragranceEdit,T=h&&h.row===B?h.field:null;t>0&&(T==="percent"?(H=t*(Q/100),M.value=H>0?m(I(H),2):""):T==="grams"?(Q=H/t*100,$.value=Q>0?m(Q,2):""):H>0?(Q=H/t*100,document.activeElement!==$&&($.value=m(Q,2))):Q>0&&(H=t*(Q/100),document.activeElement!==M&&(M.value=m(I(H),2)))),H>0&&(f+=H),C+=Q});let R=document.getElementById("fragrancePercentTotal");R&&(R.textContent=m(C,2));let w=document.getElementById("fragranceTotalComputed");return w&&(w.textContent=f>0?j(f):"--"),{totalGrams:f,totalPct:C}}function S(){let E=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(g=>{var M,$,z,Z,H,Q,h;let t=(($=(M=g.querySelector(".fragrance-typeahead"))==null?void 0:M.value)==null?void 0:$.trim())||"",f=((z=g.querySelector(".fragrance-grams"))==null?void 0:z.value)||"",C=((Z=g.querySelector(".fragrance-percent"))==null?void 0:Z.value)||"",R=((H=g.querySelector(".fragrance-gi-id"))==null?void 0:H.value)||"",w=((Q=g.querySelector(".fragrance-default-unit"))==null?void 0:Q.value)||"",B=((h=g.querySelector(".fragrance-category"))==null?void 0:h.value)||"";!t&&!f&&!C&&!R||E.push({name:t,grams:f,percent:C,gi:R,defaultUnit:w,categoryName:B})}),E}function p(E){var t,f;let g=Array.isArray(E==null?void 0:E.tips)&&E.tips.length?E.tips:[];if(!g.length){(t=e.guidance)==null||t.clearSection("visual-guidance");return}(f=e.guidance)==null||f.setSection("visual-guidance",{title:"Visual guidance",tone:"info",items:g})}function v(E){return!E||typeof E!="object"?null:E.ingredient&&E.ingredient.ingredient_category_name||E.ingredient_category_name||E.ingredient_category&&E.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:y,collectAdditiveSettings:o,syncAdditivePair:i,applyComputedOutputs:a,updateAdditivesOutput:r,updateVisualGuidance:p},e.fragrances={buildFragranceRow:l,updateFragranceTotals:b,collectFragranceData:S}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{toNumber:u}=e.helpers,{STAGE_CONFIGS:m}=e.constants;function G(I){var y;let L=m[I];if(!L)return;let x=document.getElementById(L.tabId);if(x){if((y=O.bootstrap)!=null&&y.Tab)bootstrap.Tab.getOrCreateInstance(x).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),x.classList.add("active"),x.setAttribute("aria-selected","true");let U=document.getElementById(L.paneId);U&&U.classList.add("show","active")}e.layout.scheduleStageHeightSync(),x.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function X(I){var L,x;if(I===1){let y=document.getElementById("unitGrams");y&&(y.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let U=document.getElementById("moldCylinderCorrection");U&&(U.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(L=e.mold)!=null&&L.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(I===2){let y=document.getElementById("oilRows");y&&(y.innerHTML="",y.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(I===3){let y=document.getElementById("lyeTypeNaoh");y&&(y.checked=!0);let U=document.getElementById("waterMethod");U&&(U.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let _=document.getElementById("lyePurity");_&&(_.value="100");let s=document.getElementById("waterPct");s&&(s.value="33");let i=document.getElementById("lyeConcentration");i&&(i.value="33");let a=document.getElementById("waterRatio");a&&(a.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(I===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(y=>{let U=document.getElementById(y);U&&(U.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(y=>{let U=document.getElementById(y);U&&(U.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),I===5){let y=document.getElementById("fragranceRows");y&&(y.innerHTML="",(x=e.fragrances)!=null&&x.buildFragranceRow&&y.appendChild(e.fragrances.buildFragranceRow()));let U=document.getElementById("fragrancePercentTotal");U&&(U.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),A()}function j(I){var L;if(I===1){let x=u(document.getElementById("moldWaterWeight").value),y=u(document.getElementById("oilTotalTarget").value),U=u(document.getElementById("moldOilPct").value),_=!!document.querySelector('input[name="weight_unit"]:checked')&&(x>0||y>0)&&U>0;return{state:_?"complete":"incomplete",label:_?"Sized":"Needs target"}}if(I===2){let y=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(U=>{var i,a,r,d;let o=(a=(i=U.querySelector(".oil-typeahead"))==null?void 0:i.value)==null?void 0:a.trim(),_=u((r=U.querySelector(".oil-grams"))==null?void 0:r.value),s=u((d=U.querySelector(".oil-percent"))==null?void 0:d.value);return o&&(_>0||s>0)});return{state:y?"complete":"incomplete",label:y?"Oils added":"Add oils"}}if(I===3){let x=u(document.getElementById("lyeSuperfat").value),y=(L=document.getElementById("waterMethod"))==null?void 0:L.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!y&&x>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return I===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(y=>u(document.getElementById(y).value)>0)?"Added":"Optional"}:I===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(U=>{var i,a,r,d;let o=(a=(i=U.querySelector(".fragrance-typeahead"))==null?void 0:i.value)==null?void 0:a.trim(),_=u((r=U.querySelector(".fragrance-grams"))==null?void 0:r.value),s=u((d=U.querySelector(".fragrance-percent"))==null?void 0:d.value);return o||_>0||s>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function A(){let I=document.getElementById("soapStageTabList");I&&I.querySelectorAll(".soap-stage-status").forEach(x=>x.remove());let L=document.getElementById("soapStageProgress");L&&(L.textContent="")}e.stages={openStageByIndex:G,resetStage:X,updateStageStatuses:A}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m,clamp:G}=e.helpers,{computeFattyAcids:X,computeQualities:j,computeOilQualityScores:A}=e.calc,{QUALITY_RANGES:I,QUALITY_HINTS:L,QUALITY_FEEL_HINTS:x,IODINE_RANGE:y,IODINE_SCALE_MAX:U,INS_RANGE:o,INS_SCALE_MAX:_,QUALITY_BASE:s,QUALITY_PRESETS:i,FATTY_BAR_COLORS:a,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:l}=e.ui;function b({barId:B,fillId:M,value:$,max:z,label:Z}){let H=document.getElementById(B),Q=document.getElementById(M);if(!H||!Q)return null;let h=isFinite($)?$:0,T=Math.max(0,Math.min(z,h)),N=z>0?T/z*100:0;return Q.style.width=`${N}%`,H.setAttribute("aria-valuemin","0"),H.setAttribute("aria-valuemax",String(z)),H.setAttribute("aria-valuenow",T.toFixed(1)),Z&&H.setAttribute("aria-label",Z),{bar:H,fill:Q,value:h}}function S(B,M,$){if(!(!B||!$)){if(B.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(M)){B.classList.add("bg-secondary");return}M<$[0]?B.classList.add("bg-warning"):M>$[1]?B.classList.add("bg-danger"):B.classList.add("bg-success")}}function p(B,M,$,z,Z,H){let Q=b({barId:B,fillId:M,value:$,max:Z,label:H});Q&&S(Q.fill,$,z)}function v(){let B={hardness:{range:I.hardness,scale:100},cleansing:{range:I.cleansing,scale:100},conditioning:{range:I.conditioning,scale:100},bubbly:{range:I.bubbly,scale:100},creamy:{range:I.creamy,scale:100},iodine:{range:y,scale:U},ins:{range:o,scale:_}};Object.entries(B).forEach(([M,$])=>{let[z,Z]=$.range,H=$.scale,Q=M.charAt(0).toUpperCase()+M.slice(1),h=M==="iodine"?"iodineBar":M==="ins"?"insBar":`quality${Q}Bar`,T=document.getElementById(`quality${Q}Safe`);if(T){let W=Math.max(0,Math.min(100,z/H*100)),P=Math.max(0,Math.min(100,(Z-z)/H*100));T.style.left=`${W}%`,T.style.width=`${P}%`,T.title=`Safe range ${u(z,0)}-${u(Z,0)}`}let N=document.getElementById(h);N&&(N.dataset.safeRange=`${u(z,0)}-${u(Z,0)}`);let k=document.getElementById(`quality${Q}RangeMin`),F=document.getElementById(`quality${Q}RangeMax`);k&&(k.textContent=u(z,0)),F&&(F.textContent=u(Z,0))})}function E(B,M){let $=G(B.hardness||0,0,100),z=G(B.bubbly||0,0,100),Z=G(B.conditioning||0,0,100),H=G(Z+(M||0)*3,0,100),Q=document.getElementById("feelHardness"),h=document.getElementById("feelBubbly"),T=document.getElementById("feelConditioning"),N=document.getElementById("feelGreasy");Q&&(Q.value=u($,1)),h&&(h.value=u(z,1)),T&&(T.value=u(Z,1)),N&&(N.value=u(H,1))}function g(B){r.forEach(M=>{let $=document.getElementById(`fattyBar${M.charAt(0).toUpperCase()}${M.slice(1)}`);if(!$)return;let z=G(m(B[M]),0,100),Z=z;$.style.width=`${Z}%`,$.style.backgroundColor=a[M]||"var(--color-muted)",$.title=`${M.charAt(0).toUpperCase()}${M.slice(1)}: ${u(z,1)}%`})}function t(){var z;let B=((z=document.getElementById("qualityPreset"))==null?void 0:z.value)||"balanced",M=Array.from(document.querySelectorAll(".quality-focus:checked"));if(B==="none"&&!M.length)return null;let $=B==="none"?{...s}:i[B]?{...i[B]}:{...s};return M.forEach(Z=>{let H=Z.dataset.attr,Q=Z.dataset.direction,h=I[H];h&&($[H]=Q==="low"?h[0]:h[1])}),$}function f(){let B=t(),M={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(M).forEach(([$,z])=>{if(!z)return;let Z=document.getElementById(`${z.id}Label`);if(!B){z.classList.add("d-none"),Z&&(Z.textContent="");return}let H=m(B[$]);if(!isFinite(H)){z.classList.add("d-none"),Z&&(Z.textContent="");return}let Q=$==="iodine"?U:$==="ins"?_:100,h=G(H,0,Q);z.classList.remove("d-none"),z.style.left=`${h/Q*100}%`,z.setAttribute("aria-label",`Apply ${$} target`),z.setAttribute("role","button"),z.setAttribute("tabindex","0"),z.title=`Target ${$}: ${u(H,1)}`,Z&&(Z.textContent=u(H,1))})}function C(){let B=t();if(!B){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let $=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(P=>{var J,te;let V=e.units.toGrams((J=P.querySelector(".oil-grams"))==null?void 0:J.value),Y=((te=P.querySelector(".oil-fatty"))==null?void 0:te.value)||"",K=null;if(Y)try{K=JSON.parse(Y)}catch{K=null}return{row:P,grams:V,fattyProfile:K}}).filter(P=>P.grams>0);if(!$.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let z=X($.map(P=>({grams:P.grams,fattyProfile:P.fattyProfile}))),Z=j(z.percent),H={hardness:G((B.hardness-Z.hardness)/100,-1,1),cleansing:G((B.cleansing-Z.cleansing)/100,-1,1),conditioning:G((B.conditioning-Z.conditioning)/100,-1,1),bubbly:G((B.bubbly-Z.bubbly)/100,-1,1),creamy:G((B.creamy-Z.creamy)/100,-1,1)},Q=$.reduce((P,V)=>P+V.grams,0),h=[],T=0,N=.8,k=$.filter(P=>!P.fattyProfile||typeof P.fattyProfile!="object").length;if(k===$.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(k&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),$.forEach(P=>{let V=A(P.fattyProfile),Y=H.hardness*V.hardness+H.cleansing*V.cleansing+H.conditioning*V.conditioning+H.bubbly*V.bubbly+H.creamy*V.creamy,K=G(1+Y*N,.2,1.8),J=P.grams*K;h.push({row:P.row,grams:J}),T+=J}),T<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let F=Q/T,W=e.oils.getOilTargetGrams()||Q;h.forEach(P=>{let V=P.grams*F,Y=P.row.querySelector(".oil-grams"),K=P.row.querySelector(".oil-percent");if(Y&&(Y.value=V>0?u(e.units.fromGrams(V),2):""),K&&W>0){let J=V/W*100;K.value=J>0?u(J,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function R(B){var ce,oe,ye,he;let{qualities:M,fattyPercent:$,coveragePct:z,iodine:Z,ins:H,sapAvg:Q,superfat:h,warnings:T}=B,N=z>0,k=[];function F(de,me){var ee,ne;let n=document.getElementById(`quality${de}Value`);if(!n)return;n.textContent=N&&isFinite(me)?u(me,1):"--",d(n);let c=de.toLowerCase(),q=I[c],D=b({barId:`quality${de}Bar`,fillId:`quality${de}Fill`,value:N?me:0,max:100,label:de});D&&q&&(S(D.fill,me,q),N&&isFinite(me)?D.bar.title=`${de}: ${u(me,1)} (safe ${q[0]}-${q[1]}). ${L[c]||""}`.trim():D.bar.title=`${de}: -- (safe ${q[0]}-${q[1]}). ${L[c]||""}`.trim()),q&&N&&isFinite(me)&&(me<q[0]?k.push(`${de}: ${((ee=x[c])==null?void 0:ee.low)||"Below preferred range."}`):me>q[1]&&k.push(`${de}: ${((ne=x[c])==null?void 0:ne.high)||"Above preferred range."}`))}F("Hardness",M.hardness),F("Cleansing",M.cleansing),F("Conditioning",M.conditioning),F("Bubbly",M.bubbly),F("Creamy",M.creamy);let W=document.getElementById("fattyCoverageNote");W&&(W.textContent=z>0?`Fatty acid coverage: ${u(z,1)}% of oils`:"Fatty acid coverage: not enough data yet");let P=document.getElementById("iodineValue"),V=document.getElementById("insValue"),Y=document.getElementById("sapAvgValue");P&&(P.textContent=Z>0?u(Z,1):"--",d(P)),V&&(V.textContent=H>0?u(H,1):"--",d(V)),Y&&(Y.textContent=Q>0?u(Q,1):"--",d(Y)),p("iodineBar","iodineFill",Z,y,U,"Iodine"),p("insBar","insFill",H,o,_,"INS");let K=($.lauric||0)+($.myristic||0)+($.palmitic||0)+($.stearic||0),J=($.ricinoleic||0)+($.oleic||0)+($.linoleic||0)+($.linolenic||0),te=document.getElementById("fattySatRatioResult");te&&(te.textContent=K+J>0?`${u(K,0)}:${u(J,0)}`:"--",d(te)),r.forEach(de=>{let me=`fatty${de.charAt(0).toUpperCase()}${de.slice(1)}`,n=$[de];document.getElementById(me).textContent=N&&n?`${u(n,1)}%`:"--"}),E(M,h||0),g($),f();let ae=Array.isArray(T)?T.slice():[];k.length?(ce=e.guidance)==null||ce.setSection("quality-feel-hints",{title:"Quality feel hints",tone:"info",items:k}):(oe=e.guidance)==null||oe.clearSection("quality-feel-hints"),ae.length?(ye=e.guidance)==null||ye.setSection("quality-warning-flags",{title:"Quality flags",tone:"warning",items:ae}):(he=e.guidance)==null||he.clearSection("quality-warning-flags"),e.layout.scheduleStageHeightSync()}function w(){var B;document.querySelectorAll(".soap-quality-help").forEach(M=>{let $=M.dataset.quality;L[$]&&M.setAttribute("title",L[$])}),(B=O.bootstrap)!=null&&B.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(M=>{bootstrap.Tooltip.getOrCreateInstance(M)})}e.quality={setQualityRangeBars:v,updateQualityTargets:f,applyQualityTargets:C,updateQualitiesDisplay:R,initQualityTooltips:w}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m,clamp:G}=e.helpers;function X(o){let _=0,s=0;return(o||[]).forEach(i=>{let a=m(i==null?void 0:i.sapKoh),r=m(i==null?void 0:i.grams);a>0&&r>0&&(_+=a*r,s+=r)}),s>0?_/s:0}function j(o){var b,S,p,v,E,g,t,f,C,R,w,B;let _=o.qualityReport||{},s=_.fatty_acids_pct||{},i=_.qualities||{},a=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:m(_.sap_avg_koh)||X(o.oils||[]),r=m(_.iodine),d=m(_.ins)||(a&&r?a-r:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((b=document.getElementById("qualityPreset"))==null?void 0:b.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(M=>M.id),mold:l,oils:(o.oils||[]).map(M=>({name:M.name||null,grams:u(M.grams||0,2),iodine:M.iodine||null,sap_koh:M.sapKoh||null,fatty_profile:M.fattyProfile||null,global_item_id:M.global_item_id||null,default_unit:M.default_unit||null,ingredient_category_name:M.ingredient_category_name||null})),totals:{total_oils_g:u(o.totalOils||0,2),batch_yield_g:u(o.batchYield||0,2),lye_pure_g:u(o.lyePure||0,2),lye_adjusted_g:u(o.lyeAdjusted||0,2),water_g:u(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((S=o.additives)==null?void 0:S.fragrancePct)||0,lactate_pct:((p=o.additives)==null?void 0:p.lactatePct)||0,sugar_pct:((v=o.additives)==null?void 0:v.sugarPct)||0,salt_pct:((E=o.additives)==null?void 0:E.saltPct)||0,citric_pct:((g=o.additives)==null?void 0:g.citricPct)||0,fragrance_g:u(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:u(((f=o.additives)==null?void 0:f.lactateG)||0,2),sugar_g:u(((C=o.additives)==null?void 0:C.sugarG)||0,2),salt_g:u(((R=o.additives)==null?void 0:R.saltG)||0,2),citric_g:u(((w=o.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:u(((B=o.additives)==null?void 0:B.citricLyeG)||0,2)},qualities:{hardness:u(i.hardness||0,1),cleansing:u(i.cleansing||0,1),conditioning:u(i.conditioning||0,1),bubbly:u(i.bubbly||0,1),creamy:u(i.creamy||0,1),iodine:u(r||0,1),ins:u(d||0,1),sap_avg:u(a||0,1)},fatty_acids:s,updated_at:new Date().toISOString()}}function A(o,_,s,i,a){var S,p,v,E,g;let r=(p=(S=document.getElementById(o))==null?void 0:S.value)==null?void 0:p.trim(),d=((v=document.getElementById(_))==null?void 0:v.value)||"",l=i&&((E=document.getElementById(i))==null?void 0:E.value)||"",b=a&&((g=document.getElementById(a))==null?void 0:g.value)||"";return{name:r||s,globalItemId:d?parseInt(d):void 0,defaultUnit:l||void 0,categoryName:b||void 0}}function I(o){let _=[],s=G(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(i=>{var E,g,t,f,C,R,w;let a=(g=(E=i.querySelector(".fragrance-typeahead"))==null?void 0:E.value)==null?void 0:g.trim(),r=((t=i.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((f=i.querySelector(".fragrance-default-unit"))==null?void 0:f.value)||"",l=((C=i.querySelector(".fragrance-category"))==null?void 0:C.value)||"",b=(R=i.querySelector(".fragrance-grams"))==null?void 0:R.value,S=(w=i.querySelector(".fragrance-percent"))==null?void 0:w.value,p=e.units.toGrams(b),v=G(m(S),0);p<=0&&v>0&&s>0&&(p=s*(v/100)),!(!a&&!r&&p<=0)&&_.push({name:a||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:l||void 0,grams:p,pct:v})}),_}function L(o,_){let s=[];return document.querySelectorAll(`#${o} .row`).forEach(function(i){var S,p,v;let a=(p=(S=i.querySelector(".tool-typeahead"))==null?void 0:S.value)==null?void 0:p.trim(),r=((v=i.querySelector(".tool-gi-id"))==null?void 0:v.value)||"",d=i.querySelector(".tool-qty"),l=i.querySelector(".tool-unit"),b=d&&d.value!=="";!a&&!r||(_==="container"?s.push({name:a||void 0,global_item_id:r?parseInt(r):void 0,quantity:b?parseFloat(d.value):1}):s.push({name:a||void 0,global_item_id:r?parseInt(r):void 0,quantity:b?parseFloat(d.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),s}function x(o){let _=e.config.isAuthenticated?"member":"public",s=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:_,mode:s,unitOptionsHtml:e.config.unitOptionsHtml})}function y(o,_){let s=x(o),i=s.querySelector(".tool-typeahead"),a=s.querySelector(".tool-qty");i&&(i.value=_),a&&o==="container"&&(a.value=1),o==="container"?document.getElementById("tool-containers").appendChild(s):o==="consumable"?document.getElementById("tool-consumables").appendChild(s):document.getElementById("tool-ingredients").appendChild(s)}function U(o){var r,d,l,b;let _=j(o),s=(o.oils||[]).map(S=>({name:S.name||void 0,global_item_id:S.global_item_id||void 0,quantity:S.grams,unit:"gram",default_unit:S.default_unit||void 0,ingredient_category_name:S.ingredient_category_name||void 0})),i=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&s.push({name:i,quantity:u(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&s.push({name:"Distilled Water",quantity:u(o.water,2),unit:"gram"}),I(o.totalOils||0).forEach(S=>{S.grams>0&&s.push({name:S.name,global_item_id:S.globalItemId,quantity:u(S.grams,2),unit:"gram",default_unit:S.defaultUnit,ingredient_category_name:S.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let S=A("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");s.push({name:S.name,global_item_id:S.globalItemId,quantity:u(o.additives.lactateG,2),unit:"gram",default_unit:S.defaultUnit,ingredient_category_name:S.categoryName})}if(((d=o.additives)==null?void 0:d.sugarG)>0){let S=A("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");s.push({name:S.name,global_item_id:S.globalItemId,quantity:u(o.additives.sugarG,2),unit:"gram",default_unit:S.defaultUnit,ingredient_category_name:S.categoryName})}if(((l=o.additives)==null?void 0:l.saltG)>0){let S=A("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");s.push({name:S.name,global_item_id:S.globalItemId,quantity:u(o.additives.saltG,2),unit:"gram",default_unit:S.defaultUnit,ingredient_category_name:S.categoryName})}if(((b=o.additives)==null?void 0:b.citricG)>0){let S=A("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");s.push({name:S.name,global_item_id:S.globalItemId,quantity:u(o.additives.citricG,2),unit:"gram",default_unit:S.defaultUnit,ingredient_category_name:S.categoryName}),s.push({name:"Extra Lye for Citric Acid",quantity:u(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:s.concat(L("tool-ingredients","ingredient")),consumables:L("tool-consumables","consumable"),containers:L("tool-containers","container"),notes:JSON.stringify(_)}}e.recipePayload={collectFragranceRows:I,collectDraftLines:L,buildLineRow:x,addStubLine:y,buildSoapRecipePayload:U}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m,clamp:G}=e.helpers,{formatWeight:X,formatPercent:j}=e.units;function A(){var b;let i=((b=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:b.value)||"NaOH",a=document.getElementById("lyePurity"),r=a==null?void 0:a.value,d=m(a==null?void 0:a.value),l=i==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:i,lyeType:l,purity:d}}function I(){var r,d;let i=document.getElementById("lyePurity"),a=A();i&&(i.removeAttribute("readonly"),a.selected==="KOH90"?(r=e.guidance)==null||r.setSection("lye-purity",{title:"Lye setup",tone:"info",items:["90% KOH selected. Safe default purity is 90%."]}):(d=e.guidance)==null||d.clearSection("lye-purity"))}function L(i){return i==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":i==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function x(i=null,a=null){var b,S;let r=document.getElementById("stageWaterOutput"),d=a||(i==null?void 0:i.waterMethod)||((b=document.getElementById("waterMethod"))==null?void 0:b.value)||"percent";if(r){let p=i&&isFinite(i.waterG)&&i.waterG>0;r.textContent=p?X(i.waterG):"--"}let l="";if(!i||!isFinite(i.totalOils)||i.totalOils<=0)l=`Set oils in Stage 2 to calculate water. ${L(d)}`;else if(d==="concentration"){let p=i.lyeConcentrationInput||i.lyeConcentration||0;l=`Using ${u(p,1)}% lye concentration from ${X(i.lyeAdjusted||0)} lye.`}else if(d==="ratio"){let p=i.waterRatioInput||i.waterRatio||0;l=`Using ${u(p,2)} : 1 water-to-lye ratio from ${X(i.lyeAdjusted||0)} lye.`}else l=`Using ${u(i.waterPct||0,1)}% of total oils (${X(i.totalOils)}).`;(S=e.guidance)==null||S.setSection("water-method",{title:"Lye & water hints",tone:"info",items:[l]})}function y(i=null,a=null){var R;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),b=document.getElementById("concPreview"),S=document.getElementById("ratioPreview");if(!r&&!d&&!l&&!b&&!S)return;let p=(w,B)=>{w&&(w.textContent=B)},v=a||(i==null?void 0:i.waterMethod)||((R=document.getElementById("waterMethod"))==null?void 0:R.value)||"percent",E=m(i==null?void 0:i.totalOils),g=m(i==null?void 0:i.lyeAdjusted),t=m(i==null?void 0:i.waterG);if(E<=0||g<=0){p(r,"Based on -- oils. All values update live as you change inputs."),p(d,"--"),p(l,"--"),p(b,"--"),p(S,"--");return}let f=m(i==null?void 0:i.lyeConcentration)>0?m(i==null?void 0:i.lyeConcentration):g+t>0?g/(g+t)*100:0,C=m(i==null?void 0:i.waterRatio)>0?m(i==null?void 0:i.waterRatio):g>0?t/g:0;if(p(r,`Based on ${X(E)} oils. All values update live as you change inputs.`),p(d,X(g)),p(l,X(t)),p(b,f>0?j(f):"--"),p(S,C>0?`${u(C,2)} : 1`:"--"),v==="concentration"){let w=m(i==null?void 0:i.lyeConcentrationInput);w>0&&p(b,j(w))}if(v==="ratio"){let w=m(i==null?void 0:i.waterRatioInput);w>0&&p(S,`${u(w,2)} : 1`)}}function U(){var a;let i=((a=document.getElementById("waterMethod"))==null?void 0:a.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==i)}),x(null,i),y(null,i)}function o(){let i=e.oils.updateOilTotals(),a=i.totalWeight,r=i.totalPct,d=[],l=e.oils.collectOilData(),b=e.oils.getOilTargetGrams(),p=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(v=>G(m(v.value),0)).some(v=>v>0);return(!l.length||a<=0)&&d.push("Add at least one oil with a weight or percent."),!b&&a<=0&&p&&d.push("Enter a total oils target or weights to convert percentages."),b>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),b>0&&a>b+.01?d.push("Oil weights exceed the mold target."):!b&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:i,oils:l}}function _(){let i=document.getElementById("lyeSuperfat"),a=i==null?void 0:i.value,r=m(a);return(a===""||a===null||a===void 0||!isFinite(r))&&(r=5),r}function s(){var S,p,v,E;let a=A().purity;isFinite(a)||(a=100);let r=((S=document.getElementById("waterMethod"))==null?void 0:S.value)||"percent",d=m((p=document.getElementById("waterPct"))==null?void 0:p.value),l=m((v=document.getElementById("lyeConcentration"))==null?void 0:v.value),b=m((E=document.getElementById("waterRatio"))==null?void 0:E.value);return{purity:a,waterMethod:r,waterPct:d,lyeConcentration:l,waterRatio:b}}e.runnerInputs={getLyeSelection:A,applyLyeSelection:I,setWaterMethod:U,updateStageWaterSummary:x,updateLiveCalculationPreview:y,validateCalculation:o,readSuperfatInput:_,sanitizeLyeInputs:s}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{getStorage:u}=e.helpers;function m(){if(!e.config.calcLimit)return{count:0,date:null};let I=u();if(!I)return{count:0,date:null};try{let L=I.getItem("soap_calc_usage"),x=new Date().toISOString().slice(0,10);if(!L)return{count:0,date:x};let y=JSON.parse(L);return!y||y.date!==x?{count:0,date:x}:{count:Number(y.count)||0,date:x}}catch{return{count:0,date:null}}}function G(I){if(!e.config.calcLimit)return;let L=u();if(!L)return;let x=new Date().toISOString().slice(0,10);try{L.setItem("soap_calc_usage",JSON.stringify({count:I,date:x}))}catch{}}function X(){return e.config.calcLimit&&m().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function j(){if(!e.config.calcLimit)return;let L=m().count+1;G(L);let x=Math.max(0,e.config.calcLimit-L);x<=1&&e.ui.showSoapAlert("info",`You have ${x} calculation${x===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function A(I){if(!e.config.calcLimit||I===null||I>1)return;let L=document.getElementById("soapSignupModal");L&&(O.bootstrap&&O.bootstrap.Modal?O.bootstrap.Modal.getOrCreateInstance(L).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:X,consumeCalcQuota:j,maybeShowSignupModal:A}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.state;function m({oils:j,selection:A,superfat:I,purity:L,waterMethod:x,waterPct:y,lyeConcentration:U,waterRatio:o,totalOils:_}){let s=e.additives.collectAdditiveSettings(),i=e.recipePayload.collectFragranceRows(_||0);return{oils:(j||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:i.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:s.lactatePct||0,sugar_pct:s.sugarPct||0,salt_pct:s.saltPct||0,citric_pct:s.citricPct||0,lactate_name:s.lactateName||"Sodium Lactate",sugar_name:s.sugarName||"Sugar",salt_name:s.saltName||"Salt",citric_name:s.citricName||"Citric Acid"},lye:{selected:(A==null?void 0:A.selected)||"NaOH",superfat:I,purity:L},water:{method:x,water_pct:y,lye_concentration:U,water_ratio:o},meta:{unit_display:u.currentUnit||"g"}}}async function G(j){var x;let A=((x=document.querySelector('meta[name="csrf-token"]'))==null?void 0:x.getAttribute("content"))||"",I=new AbortController,L=O.setTimeout(()=>I.abort(),2500);try{let y=await fetch("/tools/api/soap/calculate",{method:"POST",signal:I.signal,headers:{"Content-Type":"application/json",...A?{"X-CSRFToken":A}:{}},body:JSON.stringify(j||{})});if(!y.ok)return null;let U=await y.json();return!U||U.success!==!0||typeof U.result!="object"?null:U.result}catch{return null}finally{O.clearTimeout(L)}}async function X({calc:j,moldCapacityG:A,targetFillPct:I,unitDisplay:L}={}){var o;let x=((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||"",y=new AbortController,U=O.setTimeout(()=>y.abort(),4e3);try{let _=await fetch("/tools/api/soap/print-normalized",{method:"POST",signal:y.signal,headers:{"Content-Type":"application/json",...x?{"X-CSRFToken":x}:{}},body:JSON.stringify({calc:j&&typeof j=="object"?j:{},unit_display:L||u.currentUnit||"g",normalization:{mold_capacity_g:A,target_fill_pct:I}})});if(!_.ok)return null;let s=await _.json();return!s||s.success!==!0||typeof s.result!="object"?null:s.result}catch{return null}finally{O.clearTimeout(U)}}e.runnerService={buildServicePayload:m,calculateWithSoapService:G,requestNormalizedPrintSheet:X}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{round:u,toNumber:m}=e.helpers,{formatWeight:G,formatPercent:X}=e.units,j=e.state,A={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function I(o){return(o||[]).map(_=>{var s;return{name:_.name||null,grams:m(_.grams),sapKoh:m((s=_.sap_koh)!=null?s:_.sapKoh),iodine:m(_.iodine),fattyProfile:_.fatty_profile||_.fattyProfile||null,global_item_id:_.global_item_id||null,default_unit:_.default_unit||null,ingredient_category_name:_.ingredient_category_name||null}})}function L(o,_){let s=document.getElementById(o);s&&(s.textContent=_)}function x({resultsCard:o,lyeAdjusted:_,waterData:s,batchYield:i,totalOils:a,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let l=m(o.water_lye_ratio)||s.waterRatio;L("lyeAdjustedOutput",G(m(o.lye_adjusted_g)||_)),L("waterOutput",G(m(o.water_g)||s.waterG)),L("batchYieldOutput",G(i)),L("lyeConcentrationOutput",X(m(o.lye_concentration_pct)||s.lyeConcentration)),L("waterRatioOutput",isFinite(l)&&l>0?u(l,2).toString():"--"),L("totalOilsOutput",G(a)),L("superfatOutput",X(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(b=>e.ui.pulseValue(document.getElementById(b)))}function y({showAlerts:o,lyeTotals:_,purity:s,waterData:i}){if(!o)return;_.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),s<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${u(s,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(i.lyeConcentration<25||i.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let a=e.mold.getMoldSettings();a.shape==="cylinder"&&a.waterWeight>0&&!a.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function U({serviceResult:o,validation:_,selection:s,superfat:i,purity:a,waterMethod:r,waterPct:d,lyeConcentrationInput:l,waterRatioInput:b,showAlerts:S}){var P;let p=o.lye_type||s.lyeType||"NaOH",v=o.lye_selected||s.selected||null,E=m(o.total_oils_g)||_.totals.totalWeight,g=m(o.superfat_pct),t=isFinite(g)?g:i,f={sapAvg:m(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},C=m(o.lye_pure_g),w=Object.prototype.hasOwnProperty.call(o,"lye_adjusted_base_g")?m(o.lye_adjusted_base_g):null,B=m(o.lye_adjusted_g),M=m(o.lye_purity_pct)||a,$=o.water_method||r,z=m(o.water_pct)||d,Z=m(o.lye_concentration_input_pct)||l,H=m(o.water_ratio_input)||b,Q={waterG:m(o.water_g),lyeConcentration:m(o.lye_concentration_pct),waterRatio:m(o.water_lye_ratio)},h=o.results_card||{},T=o.quality_report||{},N=I(o.oils||_.oils),k={waterG:Q.waterG,lyeAdjusted:B,totalOils:E,waterMethod:$,waterPct:z,lyeConcentrationInput:Z,waterRatioInput:H,lyeConcentration:Q.lyeConcentration,waterRatio:Q.waterRatio};e.runnerInputs.updateStageWaterSummary(k),e.runnerInputs.updateLiveCalculationPreview(k);let F=o.additives||A;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(F);let W=m(h.batch_yield_g)||E+B+Q.waterG+F.fragranceG+F.lactateG+F.sugarG+F.saltG+F.citricG;return(P=e.mold)!=null&&P.updateWetBatterWarning&&e.mold.updateWetBatterWarning(W),x({resultsCard:h,lyeAdjusted:B,waterData:Q,batchYield:W,totalOils:E,superfat:t}),e.ui.updateResultsWarnings(Q),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:T.qualities||{},fattyPercent:T.fatty_acids_pct||{},coveragePct:m(T.coverage_pct),iodine:m(T.iodine),ins:m(T.ins),sapAvg:f.sapAvg,superfat:t,waterData:Q,additives:F,oils:N,totalOils:E,warnings:T.warnings||[]}),e.additives.updateVisualGuidance({tips:T.visual_guidance||[]}),e.stages.updateStageStatuses(),y({showAlerts:S,lyeTotals:f,purity:M,waterData:Q}),j.lastCalc={totalOils:E,oils:N,lyeType:p,lyeSelected:v,superfat:t,purity:M,lyePure:C,lyeAdjustedBase:w,lyeAdjusted:B,water:Q.waterG,waterMethod:$,waterPct:z,lyeConcentration:Q.lyeConcentration,waterRatio:Q.waterRatio,sapAvg:f.sapAvg,usedSapFallback:f.usedFallback,additives:F,batchYield:W,qualityReport:T,export:o.export||null},j.lastCalc}e.runnerRender={applyServiceResult:U}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},u=e.state,m=e.runnerInputs,G=e.runnerQuota,X=e.runnerService,j=e.runnerRender;async function A(I={}){var x;let L={consumeQuota:!1,showAlerts:!0,...I};try{L.showAlerts&&e.ui.clearSoapAlerts();let y=m.validateCalculation();if(!y.ok)return m.updateStageWaterSummary(null),m.updateLiveCalculationPreview(null),(x=e.mold)!=null&&x.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),L.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${y.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(L.consumeQuota&&!G.canConsumeCalcQuota())return null;let U=m.readSuperfatInput(),o=m.getLyeSelection(),_=m.sanitizeLyeInputs(),s=(u.calcRequestSeq||0)+1;u.calcRequestSeq=s;let i=X.buildServicePayload({oils:y.oils,selection:o,superfat:U,purity:_.purity,waterMethod:_.waterMethod,waterPct:_.waterPct,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio,totalOils:y.totals.totalWeight}),a=await X.calculateWithSoapService(i);if(s!==u.calcRequestSeq)return u.lastCalc;if(!a)return L.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=j.applyServiceResult({serviceResult:a,validation:y,selection:o,superfat:U,purity:_.purity,waterMethod:_.waterMethod,waterPct:_.waterPct,lyeConcentrationInput:_.lyeConcentration,waterRatioInput:_.waterRatio,showAlerts:L.showAlerts});return L.consumeQuota&&G.consumeCalcQuota(),r}catch{return L.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...I)=>m.getLyeSelection(...I),applyLyeSelection:(...I)=>m.applyLyeSelection(...I),setWaterMethod:(...I)=>m.setWaterMethod(...I),updateLiveCalculationPreview:(...I)=>m.updateLiveCalculationPreview(...I),calculateAll:A,buildSoapRecipePayload:(...I)=>e.recipePayload.buildSoapRecipePayload(...I),buildLineRow:(...I)=>e.recipePayload.buildLineRow(...I),addStubLine:(...I)=>e.recipePayload.addStubLine(...I),maybeShowSignupModal:(...I)=>G.maybeShowSignupModal(...I)}})(window);(function(O){"use strict";let e=O.SoapTool=O.SoapTool||{},{formatTime:u,getStorage:m}=e.helpers,G="soap_tool_state_v2";function X(s,i){let a=[];return document.querySelectorAll(`#${s} .row`).forEach(d=>{var E,g,t;let l=(g=(E=d.querySelector(".tool-typeahead"))==null?void 0:E.value)==null?void 0:g.trim(),b=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",S=d.querySelector(".tool-qty"),p=d.querySelector(".tool-unit"),v=S&&S.value!==""?e.helpers.toNumber(S.value):null;!l&&!b||(i==="container"?a.push({name:l||"",global_item_id:b?parseInt(b):null,quantity:v&&v>0?v:1}):a.push({name:l||"",global_item_id:b?parseInt(b):null,quantity:v&&v>=0?v:0,unit:(p==null?void 0:p.value)||"gram"}))}),a}function j(){let s=[];return document.querySelectorAll("#oilRows .oil-row").forEach(i=>{var g,t,f,C,R,w,B,M,$,z;let a=((t=(g=i.querySelector(".oil-typeahead"))==null?void 0:g.value)==null?void 0:t.trim())||"",r=((f=i.querySelector(".oil-grams"))==null?void 0:f.value)||"",d=((C=i.querySelector(".oil-percent"))==null?void 0:C.value)||"",l=((R=i.querySelector(".oil-sap-koh"))==null?void 0:R.value)||"",b=((w=i.querySelector(".oil-iodine"))==null?void 0:w.value)||"",S=((B=i.querySelector(".oil-fatty"))==null?void 0:B.value)||"",p=((M=i.querySelector(".oil-gi-id"))==null?void 0:M.value)||"",v=(($=i.querySelector(".oil-default-unit"))==null?void 0:$.value)||"",E=((z=i.querySelector(".oil-category"))==null?void 0:z.value)||"";!a&&!r&&!d&&!p||s.push({name:a,grams:r,percent:d,sap:l,iodine:b,fattyRaw:S,gi:p,defaultUnit:v,categoryName:E})}),s}function A(){var i;if((i=e.fragrances)!=null&&i.collectFragranceData)return e.fragrances.collectFragranceData();let s=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var v,E,g,t,f,C,R;let r=((E=(v=a.querySelector(".fragrance-typeahead"))==null?void 0:v.value)==null?void 0:E.trim())||"",d=((g=a.querySelector(".fragrance-grams"))==null?void 0:g.value)||"",l=((t=a.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",b=((f=a.querySelector(".fragrance-gi-id"))==null?void 0:f.value)||"",S=((C=a.querySelector(".fragrance-default-unit"))==null?void 0:C.value)||"",p=((R=a.querySelector(".fragrance-category"))==null?void 0:R.value)||"";!r&&!d&&!l&&!b||s.push({name:r,grams:d,percent:l,gi:b,defaultUnit:S,categoryName:p})}),s}function I(s,i){let a=document.getElementById("oilRows");if(!a||!s)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=s.name||"",r.querySelector(".oil-grams").value=s.grams||"",r.querySelector(".oil-percent").value=s.percent||"",r.querySelector(".oil-sap-koh").value=s.sap||"",r.querySelector(".oil-iodine").value=s.iodine||"",r.querySelector(".oil-fatty").value=s.fattyRaw||"",r.querySelector(".oil-gi-id").value=s.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=s.defaultUnit||"");let l=r.querySelector(".oil-category");l&&(l.value=s.categoryName||"");let b=Array.from(a.children);return i>=b.length?a.appendChild(r):a.insertBefore(r,b[i]),r}function L(){var a,r,d,l,b,S,p,v,E,g,t,f,C,R,w,B,M,$,z,Z,H,Q,h,T,N,k,F;let s=m();if(!s)return;let i={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:j(),lye_form:{superfat:((a=document.getElementById("lyeSuperfat"))==null?void 0:a.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((b=document.getElementById("waterPct"))==null?void 0:b.value)||"",lye_concentration:((S=document.getElementById("lyeConcentration"))==null?void 0:S.value)||"",water_ratio:((p=document.getElementById("waterRatio"))==null?void 0:p.value)||""},additives:{fragrances:A(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((v=document.getElementById("additiveLactateName"))==null?void 0:v.value)||"",lactate_gi:((E=document.getElementById("additiveLactateGi"))==null?void 0:E.value)||"",lactate_unit:((g=document.getElementById("additiveLactateUnit"))==null?void 0:g.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((f=document.getElementById("additiveSugarName"))==null?void 0:f.value)||"",sugar_gi:((C=document.getElementById("additiveSugarGi"))==null?void 0:C.value)||"",sugar_unit:((R=document.getElementById("additiveSugarUnit"))==null?void 0:R.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((B=document.getElementById("additiveSaltName"))==null?void 0:B.value)||"",salt_gi:((M=document.getElementById("additiveSaltGi"))==null?void 0:M.value)||"",salt_unit:(($=document.getElementById("additiveSaltUnit"))==null?void 0:$.value)||"",salt_category:((z=document.getElementById("additiveSaltCategory"))==null?void 0:z.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((Z=document.getElementById("additiveCitricName"))==null?void 0:Z.value)||"",citric_gi:((H=document.getElementById("additiveCitricGi"))==null?void 0:H.value)||"",citric_unit:((Q=document.getElementById("additiveCitricUnit"))==null?void 0:Q.value)||"",citric_category:((h=document.getElementById("additiveCitricCategory"))==null?void 0:h.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((T=document.getElementById("moldShape"))==null?void 0:T.value)||"loaf",cylinder_correction:!!((N=document.getElementById("moldCylinderCorrection"))!=null&&N.checked),cylinder_factor:((k=document.getElementById("moldCylinderFactor"))==null?void 0:k.value)||"0.85"},quality:{preset:((F=document.getElementById("qualityPreset"))==null?void 0:F.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(W=>W.id)},lines:{ingredients:X("tool-ingredients","ingredient"),consumables:X("tool-consumables","consumable"),containers:X("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{s.setItem(G,JSON.stringify(i));let W=document.getElementById("soapLastSaved");W&&(W.textContent=u(i.updated_at)),e.ui.showAutosaveToast()}catch{}}function x(){var l,b,S;let s=m();if(!s)return;let i=s.getItem(G);if(!i)return;let a=null;try{a=JSON.parse(i)}catch{return}if(!a||typeof a!="object")return;if(a.unit){let p=document.querySelector(`input[name="weight_unit"][value="${a.unit}"]`);p&&(p.checked=!0),e.units.setUnit(a.unit,{skipConvert:!0,skipAutoCalc:!0})}a.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=a.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(a.oils)&&a.oils.length?a.oils:[{}]).forEach(v=>{let E=e.oils.buildOilRow();E.querySelector(".oil-typeahead").value=v.name||"",E.querySelector(".oil-grams").value=v.grams||"",E.querySelector(".oil-percent").value=v.percent||"",E.querySelector(".oil-sap-koh").value=v.sap||"",E.querySelector(".oil-iodine").value=v.iodine||"",E.querySelector(".oil-fatty").value=v.fattyRaw||"",E.querySelector(".oil-gi-id").value=v.gi||"";let g=E.querySelector(".oil-default-unit");g&&(g.value=v.defaultUnit||"");let t=E.querySelector(".oil-category");t&&(t.value=v.categoryName||""),r.appendChild(E)})),a.lye_form){let p=document.getElementById("lyeSuperfat");p&&(p.value=a.lye_form.superfat||"5");let v=document.querySelector(`input[name="lye_type"][value="${a.lye_form.lye_type||"NaOH"}"]`);v&&(v.checked=!0);let E=document.getElementById("lyePurity");E&&(E.value=a.lye_form.lye_purity||"100");let g=document.getElementById("waterMethod");g&&(g.value=a.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=a.lye_form.water_pct||"");let f=document.getElementById("lyeConcentration");f&&(f.value=a.lye_form.lye_concentration||"");let C=document.getElementById("waterRatio");C&&(C.value=a.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(a.additives){let p=document.getElementById("fragranceRows");if(p&&((l=e.fragrances)!=null&&l.buildFragranceRow)){p.innerHTML="";let T=Array.isArray(a.additives.fragrances)&&a.additives.fragrances.length?a.additives.fragrances:null;if(T)T.forEach(N=>{let k=e.fragrances.buildFragranceRow();k.querySelector(".fragrance-typeahead").value=N.name||"",k.querySelector(".fragrance-grams").value=N.grams||"",k.querySelector(".fragrance-percent").value=N.percent||"",k.querySelector(".fragrance-gi-id").value=N.gi||"";let F=k.querySelector(".fragrance-default-unit");F&&(F.value=N.defaultUnit||"");let W=k.querySelector(".fragrance-category");W&&(W.value=N.categoryName||""),p.appendChild(k)});else if(a.additives.fragrance_pct||a.additives.fragrance_name||a.additives.fragrance_gi){let N=e.fragrances.buildFragranceRow();N.querySelector(".fragrance-typeahead").value=a.additives.fragrance_name||"",N.querySelector(".fragrance-percent").value=a.additives.fragrance_pct||"3",N.querySelector(".fragrance-gi-id").value=a.additives.fragrance_gi||"",p.appendChild(N)}}document.getElementById("additiveLactatePct").value=a.additives.lactate_pct||"1";let v=document.getElementById("additiveLactateName");v&&(v.value=a.additives.lactate_name||"");let E=document.getElementById("additiveLactateGi");E&&(E.value=a.additives.lactate_gi||"");let g=document.getElementById("additiveLactateUnit");g&&(g.value=a.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=a.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=a.additives.sugar_pct||"1";let f=document.getElementById("additiveSugarName");f&&(f.value=a.additives.sugar_name||"");let C=document.getElementById("additiveSugarGi");C&&(C.value=a.additives.sugar_gi||"");let R=document.getElementById("additiveSugarUnit");R&&(R.value=a.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=a.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=a.additives.salt_pct||"0.5";let B=document.getElementById("additiveSaltName");B&&(B.value=a.additives.salt_name||"");let M=document.getElementById("additiveSaltGi");M&&(M.value=a.additives.salt_gi||"");let $=document.getElementById("additiveSaltUnit");$&&($.value=a.additives.salt_unit||"");let z=document.getElementById("additiveSaltCategory");z&&(z.value=a.additives.salt_category||""),document.getElementById("additiveCitricPct").value=a.additives.citric_pct||"0";let Z=document.getElementById("additiveCitricName");Z&&(Z.value=a.additives.citric_name||"");let H=document.getElementById("additiveCitricGi");H&&(H.value=a.additives.citric_gi||"");let Q=document.getElementById("additiveCitricUnit");Q&&(Q.value=a.additives.citric_unit||"");let h=document.getElementById("additiveCitricCategory");h&&(h.value=a.additives.citric_category||"")}if(a.mold){document.getElementById("moldWaterWeight").value=a.mold.water_weight||"",document.getElementById("moldOilPct").value=a.mold.oil_pct||"65";let p=document.getElementById("moldShape");p&&(p.value=a.mold.shape||"loaf");let v=document.getElementById("moldCylinderCorrection");v&&(v.checked=!!a.mold.cylinder_correction);let E=document.getElementById("moldCylinderFactor");E&&(E.value=a.mold.cylinder_factor||"0.85");let g=document.getElementById("oilTotalTarget");(b=e.mold)!=null&&b.syncMoldPctFromTarget&&((S=e.mold)!=null&&S.syncTargetFromMold)&&(e.units.toGrams(g==null?void 0:g.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(a.quality){let p=document.getElementById("qualityPreset");if(p){let v=a.quality.preset||"balanced",E=Array.from(p.options).find(g=>g.value===v);p.value=E?v:"balanced"}document.querySelectorAll(".quality-focus").forEach(v=>{v.checked=Array.isArray(a.quality.focus)&&a.quality.focus.includes(v.id)})}function d(p,v,E){let g=document.getElementById(p);g&&(g.innerHTML="",(v||[]).forEach(t=>{let f=e.runner.buildLineRow(E),C=f.querySelector(".tool-typeahead"),R=f.querySelector(".tool-gi-id"),w=f.querySelector(".tool-qty"),B=f.querySelector(".tool-unit");C&&(C.value=t.name||""),R&&(R.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),B&&t.unit&&Array.from(B.options).find($=>$.value===t.unit)&&(B.value=t.unit),g.appendChild(f)}))}if(a.lines&&(d("tool-ingredients",a.lines.ingredients,"ingredient"),d("tool-consumables",a.lines.consumables,"consumable"),d("tool-containers",a.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(a.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),a.updated_at){let p=document.getElementById("soapLastSaved");p&&(p.textContent=u(a.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let y=null;function U(){y&&clearTimeout(y),y=setTimeout(L,350)}let o=null;function _(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:L,restoreState:x,serializeLines:X,serializeOils:j,restoreOilRow:I,queueStateSave:U,queueAutoCalc:_}})(window);(function(O){"use strict";var de,me;let e=O.SoapTool=O.SoapTool||{},{LACTATE_CATEGORY_SET:u,SUGAR_CATEGORY_SET:m,SALT_CATEGORY_SET:G,CITRIC_CATEGORY_SET:X}=e.constants,{round:j,toNumber:A,clamp:I}=e.helpers,{formatWeight:L,fromGrams:x}=e.units,y=e.state;async function U(){var c;let n=y.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return n||((c=e.ui)!=null&&c.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function o(){var q;let n={confirmMinPct:90,confirmMaxPct:120,strongLowPct:80,strongHighPct:130,normalizeMinPct:50,normalizeMaxPct:200,guidance:{strong_low:{toneClass:"text-danger",messageClass:"alert-danger",message:"This recipe is far below mold capacity and may underfill bars."},low:{toneClass:"text-warning",messageClass:"alert-warning",message:"This recipe is below your target range and may leave extra headspace."},high:{toneClass:"text-warning",messageClass:"alert-warning",message:"This recipe is above your target range and may overflow this mold."},strong_high:{toneClass:"text-danger",messageClass:"alert-danger",message:"This recipe is far above mold capacity and has a high overflow risk."},ok:{toneClass:"text-success",messageClass:"alert-success",message:"This recipe is inside your target fill range."}}},c=(q=e.config)==null?void 0:q.printPolicy;return!c||typeof c!="object"?n:{...n,...c,guidance:{...n.guidance,...c.guidance||{}}}}function _(n){var q;let c=(q=n==null?void 0:n.export)==null?void 0:q.csv_text;return typeof c=="string"&&c.trim()?c:""}function s(n,c){let q=new Blob([n],{type:"text/csv;charset=utf-8;"}),D=URL.createObjectURL(q),ee=document.createElement("a");ee.href=D,ee.download=c,document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),URL.revokeObjectURL(D)}function i(n){var ne;let c=(ne=e.mold)!=null&&ne.getMoldSettings?e.mold.getMoldSettings():null,q=A(c==null?void 0:c.effectiveCapacity),D=A(n==null?void 0:n.batchYield);if(q<=0||D<=0)return null;let ee=D/q*100;return{moldCapacityG:q,batchYieldG:D,fillPct:ee,differenceG:D-q}}function a(n){if(!n)return!1;let c=o();return n.fillPct<c.confirmMinPct||n.fillPct>c.confirmMaxPct}function r(n){let c=o(),q=c.guidance||{};return n<c.confirmMinPct?(n<c.strongLowPct?q.strong_low:q.low)||q.low||q.ok:n>c.confirmMaxPct?(n>c.strongHighPct?q.strong_high:q.high)||q.high||q.ok:q.ok||{toneClass:"text-success",messageClass:"alert-success",message:"This recipe is inside your target fill range."}}function d(n){let c=A(n);return!isFinite(c)||Math.abs(c)<.01?`0 ${y.currentUnit||"g"}`:`${c>0?"+":"-"}${j(x(Math.abs(c)),2)} ${y.currentUnit||"g"}`}async function l(n,c,q){var D;return!n||!c||!((D=e.runnerService)!=null&&D.requestNormalizedPrintSheet)?null:e.runnerService.requestNormalizedPrintSheet({calc:n,moldCapacityG:c.moldCapacityG,targetFillPct:q,unitDisplay:y.currentUnit||"g"})}function b(n){return new Promise(c=>{let q=document.getElementById("soapPrintConfirmModal");if(!q||!O.bootstrap){c({action:"print-as-is"});return}let D=O.bootstrap.Modal.getOrCreateInstance(q),ee=document.getElementById("soapPrintConfirmBatchYield"),ne=document.getElementById("soapPrintConfirmMoldCapacity"),le=document.getElementById("soapPrintConfirmFillPct"),re=document.getElementById("soapPrintConfirmDiff"),ge=document.getElementById("soapPrintConfirmMessage"),se=document.getElementById("soapPrintNormalizePct"),ue=document.getElementById("soapPrintAsIsBtn"),ve=document.getElementById("soapNormalizePrintBtn"),pe=o();if(!ue||!ve){c({action:"print-as-is"});return}let Ie=r(n.fillPct);ee&&(ee.textContent=L(n.batchYieldG)),ne&&(ne.textContent=L(n.moldCapacityG)),re&&(re.textContent=d(n.differenceG)),le&&(le.textContent=`${j(n.fillPct,1)}%`,le.classList.remove("text-success","text-warning","text-danger"),le.classList.add(Ie.toneClass)),ge&&(ge.textContent=Ie.message,ge.classList.remove("alert-success","alert-info","alert-warning","alert-danger"),ge.classList.add(Ie.messageClass)),se&&(se.value="100",se.min=String(pe.normalizeMinPct),se.max=String(pe.normalizeMaxPct));let be=!1,we=()=>{ue.removeEventListener("click",Te),ve.removeEventListener("click",_e),se&&se.removeEventListener("keydown",qe),q.removeEventListener("hidden.bs.modal",Ee)},Ce=Se=>{be||(be=!0,we(),c(Se))},Te=()=>{Ce({action:"print-as-is"}),D.hide()},_e=()=>{let Se=A(se==null?void 0:se.value),ie=I(Se>0?Se:100,pe.normalizeMinPct,pe.normalizeMaxPct);se&&(se.value=j(ie,2)),Ce({action:"normalize",targetPct:ie}),D.hide()},qe=Se=>{Se.key==="Enter"&&(Se.preventDefault(),_e())},Ee=()=>{Ce(null)};ue.addEventListener("click",Te),ve.addEventListener("click",_e),se&&se.addEventListener("keydown",qe),q.addEventListener("hidden.bs.modal",Ee),D.show(),se&&O.setTimeout(()=>se.focus(),120)})}function S(n){var q;let c=O.open("","_blank","width=960,height=720");return c?(c.document.open(),c.document.write(n),c.document.close(),c.focus(),c.onload=()=>{c.print()},!0):((q=e.ui)!=null&&q.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3}),!1)}let p=document.getElementById("oilRows"),v=document.getElementById("addOil"),E=document.getElementById("normalizeOils");v&&p&&(v.dataset.bound="direct",v.addEventListener("click",function(){p.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),E&&(E.dataset.bound="direct",E.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),p&&p.addEventListener("input",function(n){n.target.classList.contains("oil-grams")&&(y.lastOilEdit={row:n.target.closest(".oil-row"),field:"grams"}),n.target.classList.contains("oil-percent")&&(y.lastOilEdit={row:n.target.closest(".oil-row"),field:"percent"}),(n.target.classList.contains("oil-grams")||n.target.classList.contains("oil-percent")||n.target.classList.contains("oil-typeahead"))&&(n.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(n.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),p&&p.addEventListener("focusin",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(n.target.closest(".oil-row"))}),p&&p.addEventListener("focusout",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),n.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(n.target.closest(".oil-row"),"grams"),n.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(n.target.closest(".oil-row"),"percent")}),p&&p.addEventListener("keydown",function(n){n.key==="Enter"&&(n.target.classList.contains("oil-grams")&&(n.preventDefault(),e.oils.validateOilEntry(n.target.closest(".oil-row"),"grams")),n.target.classList.contains("oil-percent")&&(n.preventDefault(),e.oils.validateOilEntry(n.target.closest(".oil-row"),"percent")))}),p&&p.addEventListener("mouseover",function(n){if(!n.target.classList.contains("oil-typeahead"))return;let c=n.target.closest(".oil-row");!c||c===y.lastPreviewRow||(y.lastPreviewRow=c,e.oils.setSelectedOilProfileFromRow(c))}),p&&p.addEventListener("mouseout",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),p&&p.addEventListener("click",function(n){let c=n.target.closest(".oil-profile-open");if(c){let D=c.closest(".oil-row");if(D){e.oils.setSelectedOilProfileFromRow(D);let ee=document.getElementById("oilProfileModal");ee&&O.bootstrap&&bootstrap.Modal.getOrCreateInstance(ee).show()}return}let q=n.target.closest(".remove-oil");if(q){let D=q.closest(".oil-row");D&&(y.lastRemovedOil=e.oils.serializeOilRow(D),y.lastRemovedOilIndex=Array.from(D.parentElement.children).indexOf(D),e.ui.showUndoToast("Oil removed.")),D&&y.lastOilEdit&&y.lastOilEdit.row===D&&(y.lastOilEdit=null,e.oils.clearSelectedOilProfile()),D&&D.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let g=document.getElementById("fragranceRows"),t=document.getElementById("addFragrance");t&&g&&(t.dataset.bound="direct",t.addEventListener("click",function(){g.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),g&&(g.addEventListener("input",function(n){n.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:n.target.closest(".fragrance-row"),field:"grams"}),n.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:n.target.closest(".fragrance-row"),field:"percent"}),(n.target.classList.contains("fragrance-grams")||n.target.classList.contains("fragrance-percent")||n.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),g.addEventListener("click",function(n){var D;let c=n.target.closest(".remove-fragrance");if(!c)return;let q=c.closest(".fragrance-row");q&&((D=e.state.lastFragranceEdit)==null?void 0:D.row)===q&&(e.state.lastFragranceEdit=null),q&&q.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let f=document.getElementById("soapStageTabContent"),C=()=>{if(!f)return null;let n=f.querySelector(".tab-pane.active")||f.querySelector(".tab-pane.show.active");return n?n.querySelector(".soap-stage-body")||n:null},R=()=>{f&&f.addEventListener("wheel",n=>{let c=n.target;if(!(c instanceof HTMLElement))return;let q=c.closest('input[type="number"]');if(!(q instanceof HTMLInputElement))return;let D=C();if(!(D instanceof HTMLElement)||D.scrollHeight<=D.clientHeight+1)return;document.activeElement===q&&typeof q.blur=="function"&&q.blur();let ee=D.scrollTop<=0,ne=D.scrollTop+D.clientHeight>=D.scrollHeight-1;n.deltaY<0&&ee||n.deltaY>0&&ne||(D.scrollTop+=n.deltaY,n.preventDefault())},{passive:!1})};f&&(f.addEventListener("click",n=>{let c=n.target.closest("[data-stage-action]"),q=n.target.closest("[data-soap-action]");if(!c&&!q)return;if(n.preventDefault(),n.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),q){if(q.dataset.bound==="direct")return;let ne=q.dataset.soapAction;ne==="add-oil"&&p&&(p.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),ne==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),ne==="add-fragrance"&&g&&(g.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let D=c.dataset.stageAction,ee=Number(c.dataset.stageIndex);Number.isNaN(ee)||(D==="prev"&&e.stages.openStageByIndex(Math.max(0,ee-1)),D==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,ee+1)),D==="reset"&&e.stages.resetStage(ee+1))}),R());let w=document.getElementById("soapStageTabList"),B=()=>{if(!w)return;w.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("is-expanded"));let n=w.querySelector(".nav-link.active");n&&n.closest(".nav-item")&&n.closest(".nav-item").classList.add("is-expanded")};w&&(w.addEventListener("shown.bs.tab",()=>{B(),e.layout.scheduleStageHeightSync()}),B());let M=document.getElementById("resultsCardToggle"),$=document.getElementById("resultsCard");M&&$&&M.addEventListener("click",()=>{$.classList.toggle("is-collapsed");let n=$.classList.contains("is-collapsed");M.setAttribute("aria-expanded",(!n).toString());let c=n?"Expand formula details":"Collapse formula details";M.setAttribute("aria-label",c),M.setAttribute("title",c);let q=M.querySelector("i");q&&(q.classList.toggle("fa-chevron-down",n),q.classList.toggle("fa-chevron-up",!n))}),document.querySelectorAll('input[name="weight_unit"]').forEach(n=>{n.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let z=()=>{var n;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(n=e.mold)!=null&&n.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},Z=document.getElementById("oilTotalTarget");Z&&Z.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let H=document.getElementById("waterMethod");H&&H.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(n=>{n.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(n=>{let c=document.getElementById(n);c&&["input","change"].forEach(q=>{c.addEventListener(q,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:n,weightId:c})=>{let q=document.getElementById(n),D=document.getElementById(c);q&&q.addEventListener("input",()=>{let ee=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:n,weightId:c,sourceField:"pct",totalOils:ee}),e.additives.updateAdditivesOutput(ee),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),D&&D.addEventListener("input",()=>{let ee=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:n,weightId:c,sourceField:"weight",totalOils:ee}),e.additives.updateAdditivesOutput(ee),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(n=>{n.addEventListener("input",()=>{e.storage.queueStateSave()})});let h=document.getElementById("qualityPreset");h&&h.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(n=>{n.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let T=document.getElementById("applyQualityTargets");T&&T.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(n=>{n.addEventListener("click",()=>e.quality.applyQualityTargets()),n.addEventListener("keydown",c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),e.quality.applyQualityTargets())})});let N=document.getElementById("moldWaterWeight");N&&N.addEventListener("input",function(){e.mold.syncTargetFromMold(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let k=document.getElementById("moldOilPct");k&&k.addEventListener("input",function(){e.mold.syncTargetFromMold(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let F=document.getElementById("moldShape");F&&F.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let W=document.getElementById("moldCylinderCorrection");W&&W.addEventListener("change",function(){e.mold.syncTargetFromMold(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let P=document.getElementById("moldCylinderFactor");P&&P.addEventListener("input",function(){e.mold.syncTargetFromMold(),z(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(n=>{n.addEventListener("click",function(){let c=this.dataset.stubKind,q=this.dataset.stubName;e.runner.addStubLine(c,q),e.storage.queueStateSave()})});let V=document.getElementById("soapToolPage");V&&(V.addEventListener("click",function(n){n.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),V.addEventListener("input",function(n){n.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(n.target),e.stages.updateStageStatuses(),e.ui.flashStage(n.target.closest(".soap-stage-card")))}),V.addEventListener("change",function(n){n.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(n.target),e.stages.updateStageStatuses())}));let Y=document.getElementById("addToolIngredient");Y&&Y.addEventListener("click",function(){let n=document.getElementById("tool-ingredients");n&&n.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let K=document.getElementById("addToolConsumable");K&&K.addEventListener("click",function(){let n=document.getElementById("tool-consumables");n&&n.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let J=document.getElementById("addToolContainer");J&&J.addEventListener("click",function(){let n=document.getElementById("tool-containers");n&&n.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let te=document.getElementById("calcLyeBtn");te&&te.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let ae=document.getElementById("saveSoapTool");ae&&ae.addEventListener("click",async function(){try{let n=y.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!n)return;let c=e.runner.buildSoapRecipePayload(n);y.lastRecipePayload=c;try{let q=e.helpers.getStorage();q&&q.setItem("soap_recipe_payload",JSON.stringify(c))}catch{}O.SOAP_RECIPE_DTO=c,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let ce=document.getElementById("exportSoapCsv");ce&&ce.addEventListener("click",async function(){var q;let n=await U();if(!n)return;let c=_(n);if(!c){(q=e.ui)!=null&&q.showSoapAlert&&e.ui.showSoapAlert("warning","No CSV export is available yet. Run a fresh calculation and try again.",{dismissible:!0,timeoutMs:6e3});return}s(c,"soap_formula.csv")});let oe=document.getElementById("printSoapSheet");oe&&oe.addEventListener("click",async function(){var D,ee,ne;let n=await U();if(!n)return;let c=typeof((D=n==null?void 0:n.export)==null?void 0:D.sheet_html)=="string"&&n.export.sheet_html.trim()?n.export.sheet_html:"",q=i(n);if(a(q)){let le=await b(q);if(!le)return;if(le.action==="normalize"){let re=await l(n,q,le.targetPct);re!=null&&re.sheet_html?c=re.sheet_html:(ee=e.ui)!=null&&ee.showSoapAlert&&e.ui.showSoapAlert("warning","Unable to normalize print output right now. Printing the current sheet instead.",{dismissible:!0,timeoutMs:6e3})}}if(!c){(ne=e.ui)!=null&&ne.showSoapAlert&&e.ui.showSoapAlert("warning","No print sheet is available yet. Run a fresh calculation and try again.",{dismissible:!0,timeoutMs:6e3});return}S(c)});let ye=document.getElementById("soapUndoRemove");ye&&ye.addEventListener("click",()=>{y.lastRemovedOil&&(e.storage.restoreOilRow(y.lastRemovedOil,y.lastRemovedOilIndex||0),y.lastRemovedOil=null,y.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let n=document.getElementById("soapMobileDrawer"),c=document.getElementById("soapMobileDrawerContent"),q=document.getElementById("soapMobileDrawerTitle"),D=document.getElementById("soapDrawerEmpty"),ee=document.getElementById("soapDrawerClose"),ne=document.getElementById("soapQualityCard"),le=document.getElementById("resultsCard");if(!n||!c||!q||!ne||!le)return;let re=ne.parentElement,ge=le.parentElement,se=new Map,ue=null,ve=()=>O.matchMedia("(max-width: 767px)").matches,pe=ie=>ie==="quality"?ne:le,Ie=ie=>ie==="quality"?re:ge,be=ie=>ie==="quality"?"Display":"Results",we=ie=>{let fe=se.get(ie);fe||(fe=document.createElement("div"),fe.className="soap-card-placeholder",se.set(ie,fe)),fe.style.height=`${ie.offsetHeight}px`,ie.parentElement&&ie.parentElement!==c&&!fe.parentElement&&ie.parentElement.insertBefore(fe,ie)},Ce=ie=>{ie&&(we(ie),c.appendChild(ie))},Te=(ie,fe)=>{let Le=se.get(ie);Le&&Le.parentElement?Le.replaceWith(ie):fe&&ie.parentElement!==fe&&fe.appendChild(ie)},_e=()=>{if(!D)return;let ie=ue==="results",fe=getComputedStyle(le).display!=="none";D.classList.toggle("d-none",!ie||fe)},qe=ie=>{ve()&&(ue&&ue!==ie&&Te(pe(ue),Ie(ue)),Ce(pe(ie)),q.textContent=be(ie),ue=ie,n.classList.add("is-open"),_e())},Ee=()=>{ue&&(Te(pe(ue),Ie(ue)),ue=null,n.classList.remove("is-open"),_e())};n.querySelectorAll("[data-drawer-target]").forEach(ie=>{ie.addEventListener("click",()=>{let fe=ie.dataset.drawerTarget;fe&&(n.classList.contains("is-open")&&ue===fe?Ee():qe(fe))})}),ee&&ee.addEventListener("click",Ee),O.addEventListener("resize",()=>{!ve()&&ue&&Ee()}),new MutationObserver(()=>_e()).observe(le,{attributes:!0,attributeFilter:["style","class"]})})(),O.addEventListener("resize",e.layout.scheduleStageHeightSync),O.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",u,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",m,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",G,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",X,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),p&&!p.querySelector(".oil-row")&&p.appendChild(e.oils.buildOilRow()),g&&!g.querySelector(".fragrance-row")&&(de=e.fragrances)!=null&&de.buildFragranceRow&&g.appendChild(e.fragrances.buildFragranceRow()),(me=e.fragrances)!=null&&me.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
