(function(B){"use strict";let e={inventory:"Inventory",global:"Global Library"},r={inventory:"bg-primary",global:"bg-info text-dark"},y={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function w(u,a){let l;return function(){let S=arguments;clearTimeout(l),l=setTimeout(()=>u.apply(null,S),a)}}function H(u){return(u||"").trim().toLowerCase()}function $(u){if(u)return u;let a=document.createElement("div");return a.className="list-group position-absolute w-100 d-none inventory-suggestions",a.style.zIndex="1050",a.style.maxHeight="300px",a.style.overflowY="auto",a}function M(u){return typeof u=="function"?u():u}function h(u){let a=new Set;return(u||[]).forEach(l=>{let S=l&&(l.global_item_id||l.id);S&&a.add(String(S))}),a}function q(u){if(!u)return"";let a=e[u]||u;return`<span class="badge ${r[u]||"bg-secondary"} ms-2">${a}</span>`}function O(u,a,l,S){S=S||{},u.innerHTML="";let v=!1;if(a.forEach(I=>{!I.items||!I.items.length||(v=!0,I.items.forEach(p=>{let E=document.createElement("a");E.href="#",E.className="list-group-item list-group-item-action suggestion-item";let c=S.showSubtitle&&p.subtitle?`<div class="small text-muted mt-1">${p.subtitle}</div>`:"";E.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${p.text||p.display_name||p.name||""}</span>
          ${S.showSourceBadge?q(I.source||p.source):""}
        </div>${c}`,E.addEventListener("click",function(t){t.preventDefault(),l(p,I.source||p.source),u.classList.add("d-none")}),u.appendChild(E)}))}),u.classList.toggle("d-none",!v),!v&&u.dataset.emptyMessage){let I=document.createElement("div");I.className="list-group-item text-muted small",I.textContent=u.dataset.emptyMessage,u.appendChild(I),u.classList.remove("d-none")}}function m(u,a,l){u.innerHTML="";let S=!1;a.forEach(v=>{if(!v.ingredients||!v.ingredients.length)return;S=!0;let I=document.createElement("div");I.className="list-group-item text-muted small fw-semibold",I.textContent=v.title,u.appendChild(I),v.ingredients.forEach(p=>{let E=document.createElement("div");E.className="list-group-item ingredient-result";let c=document.createElement("div");c.className="d-flex justify-content-between align-items-center ingredient-summary",c.setAttribute("role","button"),c.setAttribute("tabindex","0"),c.innerHTML=`<span class="fw-semibold">${p.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${p.forms.length} option${p.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",p.forms.forEach(b=>{let R=document.createElement("button");R.type="button",R.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",R.innerHTML=`<div class="fw-semibold">${b.text||b.display_name||b.name||"Form"}</div>`,R.addEventListener("click",function(){l(b,b.source||v.source),u.classList.add("d-none")}),t.appendChild(R)});function g(b){b.type==="keydown"&&b.key!=="Enter"&&b.key!==" "||(b.preventDefault(),t.classList.toggle("d-none"))}c.addEventListener("click",g),c.addEventListener("keydown",g),E.appendChild(c),E.appendChild(t),u.appendChild(E),p.forms.length===1&&t.classList.remove("d-none")})}),u.classList.toggle("d-none",!S)}function P(u,a,l){u.innerHTML="";let S=!1;if((a||[]).forEach(v=>{S=!0;let I=document.createElement("a");I.href="#",I.className="list-group-item list-group-item-action suggestion-item";let p=v.inci_name?`<div class="small text-muted">${v.inci_name}</div>`:"";I.innerHTML=`<div class="fw-semibold">${v.text||v.name}</div>${p}`,I.addEventListener("click",function(E){E.preventDefault(),l(v,"definition"),u.classList.add("d-none")}),u.appendChild(I)}),u.classList.toggle("d-none",!S),!S&&u.dataset.emptyMessage){let v=document.createElement("div");v.className="list-group-item text-muted small",v.textContent=u.dataset.emptyMessage,u.appendChild(v),u.classList.remove("d-none")}}function i(u){let a=[];return(u||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let S=l.ingredient&&l.ingredient.name||l.ingredient_name||null,v=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,I=l.category_tags||[];l.forms.forEach(p=>{var t,g,b,R,A,x,G,U,f,T;let E=p.physical_form||{},c=p.display_name||p.text||p.name||(S&&p.physical_form_name?`${S}, ${p.physical_form_name}`:l.display_name||l.text||l.name||"");a.push({id:p.id,text:c,item_type:p.item_type||l.item_type,default_unit:p.default_unit||p.unit||l.default_unit||l.unit||null,source:"global",global_item_id:p.id,ingredient_id:p.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:p.ingredient_name||S,physical_form_id:p.physical_form_id||E&&E.id||null,physical_form_name:p.physical_form_name||E&&E.name||null,ingredient_category_name:v,category_tags:I,density:p.density||l.density||null,capacity:p.capacity||l.capacity||null,capacity_unit:p.capacity_unit||l.capacity_unit||null,container_material:p.container_material||l.container_material||null,container_type:p.container_type||l.container_type||null,container_style:p.container_style||l.container_style||null,container_color:p.container_color||l.container_color||null,default_is_perishable:(t=p.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(g=p.recommended_shelf_life_days)!=null?g:l.recommended_shelf_life_days,saponification_value:(R=(b=p.saponification_value)!=null?b:l.saponification_value)!=null?R:null,iodine_value:(x=(A=p.iodine_value)!=null?A:l.iodine_value)!=null?x:null,fatty_acid_profile:(U=(G=p.fatty_acid_profile)!=null?G:l.fatty_acid_profile)!=null?U:null,melting_point_c:(T=(f=p.melting_point_c)!=null?f:l.melting_point_c)!=null?T:null})})}else if(l){let S=l.display_name||l.text||l.name||"",v=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;a.push({id:l.id,text:S,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:v,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),a}function d(u){let a=new Map;return(u||[]).forEach(l=>{let S=l.ingredient_name||l.text||l.name||"",v=l.ingredient_id?`id:${l.ingredient_id}`:`name:${H(S)}`,I=a.get(v)||{ingredient_id:l.ingredient_id||null,name:S,forms:[]};I.forms.push({id:l.id,text:l.text||S,ingredient_name:S,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),a.set(v,I)}),Array.from(a.values())}function s(u,a){let l=[];return(u||[]).forEach(S=>{let v=(S.forms||[]).map(p=>({id:p.id,text:p.name||p.display_name||p.text,ingredient_name:p.ingredient_name||S.name||S.ingredient&&S.ingredient.name||"Ingredient",physical_form_name:p.physical_form_name||null,default_unit:p.default_unit||p.unit||null,source:"global",global_item_id:p.id,density:p.density||null,capacity:p.capacity||null,capacity_unit:p.capacity_unit||null,container_material:p.container_material||null,container_type:p.container_type||null,container_style:p.container_style||null,container_color:p.container_color||null,saponification_value:p.saponification_value||null,iodine_value:p.iodine_value||null,fatty_acid_profile:p.fatty_acid_profile||null,melting_point_c:p.melting_point_c||null})),I=a?v.filter(p=>!p.global_item_id||!a.has(String(p.global_item_id))):v;I.length&&l.push({ingredient_id:S.ingredient_id||S.id||null,name:S.name||S.ingredient&&S.ingredient.name||v[0]&&v[0].ingredient_name||"Ingredient",forms:I})}),l}function n(u){let a=new URLSearchParams({q:u});return fetch(`/api/ingredients/definitions/search?${a.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function o(u){let a={...y,...u},l=a.inputEl,S=a.invHiddenEl,v=a.giHiddenEl,I=$(a.listEl),p=a.mode||"recipe",E=a.searchType||"ingredient",c=a.includeInventory,t=a.includeGlobal,g=a.ingredientFirst,b=a.displayVariant,R=typeof a.resultFilter=="function"?a.resultFilter:null,A=typeof a.onSelection=="function"?a.onSelection:null,x=a.globalUrlBuilder;if(!l||!S&&p==="recipe"||!v&&a.requireHidden!==!1)return;I&&!I.classList.contains("list-group")&&I.classList.add("list-group"),!I.parentNode&&l.parentNode&&l.parentNode.appendChild(I);function G(C,_){let L=new URLSearchParams({q:C});return _&&_!=="all"&&L.set("type",_),`/inventory/api/search?${L.toString()}`}function U(C,_,L){if(typeof x=="function")return x(C,_,L);let N=new URLSearchParams({q:C});return _&&_!=="all"&&N.set("type",_),_==="ingredient"&&L&&N.set("group","ingredient"),`${p==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${N.toString()}`}let f=w(function(){let C=(l.value||"").trim();if(!C){I.classList.add("d-none"),I.innerHTML="",S&&(S.value=""),v&&(v.value="");return}let _=(M(E)||"ingredient").toLowerCase(),L=M(c),N=M(t),K=_==="ingredient"&&!!M(g),Y=b||(K?"grouped":"compact");if(_==="ingredient_definition"||_==="definition"){n(C).then(F=>{let Q=F&&F.results||[];P(I,Q.map(z=>({id:z.id,text:z.name,name:z.name,inci_name:z.inci_name,slug:z.slug,ingredient_category_id:z.ingredient_category_id,ingredient_category_name:z.ingredient_category_name})),T)}).catch(()=>I.classList.add("d-none"));return}let D=L!==!1?fetch(G(C,_)).then(F=>F.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),j=N!==!1?fetch(U(C,_,K)).then(F=>F.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([D,j]).then(F=>{let Q=F[0]&&F[0].results||[],z=F[1]&&F[1].results||[],X=R?Q.filter(ee=>R(ee,"inventory")):Q,te=R?z.filter(ee=>R(ee,"global")):z,ie=h(X),le=i(te).filter(ee=>!ee.global_item_id||!ie.has(String(ee.global_item_id))).filter(ee=>R?R(ee,"global"):!0);if(K){let ee=d(X),re=s(te,ie),ue=[];ee.length&&ue.push({title:"Your Inventory",source:"inventory",ingredients:ee}),re.length&&ue.push({title:"Global Library",source:"global",ingredients:re}),m(I,ue,T);return}let ae=[];X.length&&ae.push({title:"Your Inventory",source:"inventory",items:X}),le.length&&ae.push({title:"Global Library",source:"global",items:le}),O(I,ae,T,{showSourceBadge:a.showSourceBadge!==!1,showSubtitle:Y==="detailed"})}).catch(()=>{I.classList.add("d-none")})},200);function T(C,_){l.value=C.text||C.display_name||C.name||"",_==="inventory"?(S&&(S.value=C.id_numeric||C.id||""),v&&(v.value=C.global_item_id||"")):(v&&(v.value=C.global_item_id||C.id||""),S&&(S.value="")),typeof A=="function"&&A(C,_)}l.addEventListener("input",function(){S&&(S.value=""),v&&(v.value=""),f()}),document.addEventListener("click",function(C){!I.contains(C.target)&&!l.contains(C.target)&&I.classList.add("d-none")})}B.attachMergedInventoryGlobalTypeahead=o,B.renderInventoryTypeaheadList=O})(window);(function(B){"use strict";function e(r,y){var w=y&&y.context||"public",H=y&&y.unitOptionsHtml||"",$=y&&y.mode||(w==="public"?"public":"recipe"),M=document.createElement("div");M.className="row g-2 align-items-end mb-2",M.innerHTML=['<div class="col-md-6">','  <label class="form-label">',r==="container"?"Container":r==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',r==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',r==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',H,"  </select>","</div>",'<div class="col-md-3 ',r!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var h=M.querySelector(".tool-typeahead"),q=M.querySelector(".tool-gi-id"),O=M.querySelector('[data-role="suggestions"]');if(typeof B.attachMergedInventoryGlobalTypeahead=="function"){let m=r==="container"?"container":r==="consumable"?"consumable":"ingredient",P=w!=="public";B.attachMergedInventoryGlobalTypeahead({inputEl:h,giHiddenEl:q,listEl:O,mode:$,context:w,ingredientFirst:r==="ingredient",searchType:m,includeInventory:P,includeGlobal:!0})}return M.querySelector(".tool-remove").addEventListener("click",function(){M.remove()}),M}B.buildToolLineRow=e})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};e.config={unitOptionsHtml:B.soapToolConfig&&B.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(B.SOAP_CALC_LIMIT)?B.SOAP_CALC_LIMIT:null,calcTier:B.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(B.soapToolConfig&&B.soapToolConfig.useCsvPrimary),isAuthenticated:B.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:r,toNumber:y,clamp:w,formatTime:H,getStorage:$,buildSoapcalcSearchBuilder:M};function r(h,q=3){if(!isFinite(h))return 0;let O=Math.pow(10,q);return Math.round(h*O)/O}function y(h){let q=h;typeof q=="string"&&(q=q.replace(/,/g,"").trim());let O=parseFloat(q);return isFinite(O)?O:0}function w(h,q,O){return!isFinite(h)||h<q?q:O!=null&&h>O?O:h}function H(h){return h?`Saved ${new Date(h).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function $(){try{return B.localStorage}catch{return null}}function M(){let h=(O,m,P)=>{let i=new URLSearchParams({q:O});return m&&m!=="all"&&i.set("type",m),m==="ingredient"&&P&&i.set("group","ingredient"),`/api/public/global-items/search?${i.toString()}`},q=(O,m,P)=>{let i=new URLSearchParams({q:O});return P&&i.set("group","ingredient"),`/api/public/soapcalc-items/search?${i.toString()}`};return e.config.useCsvPrimary===!0?q:h}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},y={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},w={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},H=[41,70],$=100,M=[136,170],h=250,q={hardness:(r.hardness[0]+r.hardness[1])/2,cleansing:(r.cleansing[0]+r.cleansing[1])/2,conditioning:(r.conditioning[0]+r.conditioning[1])/2,bubbly:(r.bubbly[0]+r.bubbly[1])/2,creamy:(r.creamy[0]+r.creamy[1])/2},O={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},m={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},P=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],i=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],d={g:1,oz:28.3495,lb:453.592},s=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],n=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),o=new Set(["Essential Oils","Fragrance Oils"]),u=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),a=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),S=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:r,QUALITY_HINTS:y,QUALITY_FEEL_HINTS:w,IODINE_RANGE:H,IODINE_SCALE_MAX:$,INS_RANGE:M,INS_SCALE_MAX:h,QUALITY_BASE:q,QUALITY_PRESETS:O,FATTY_BAR_COLORS:m,FATTY_DISPLAY_KEYS:P,OIL_TIP_RULES:i,UNIT_FACTORS:d,STAGE_CONFIGS:s,OIL_CATEGORY_SET:n,FRAGRANCE_CATEGORY_SET:o,LACTATE_CATEGORY_SET:u,SUGAR_CATEGORY_SET:a,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:S}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:r}=e.helpers;function y(M){let h=0,q=0;return M.forEach(O=>{O.iodine>0&&(h+=O.grams,q+=O.iodine*O.grams)}),{iodine:h>0?q/h:0,coverageWeight:h}}function w(M){let h={},q=0;M.forEach(m=>{!m.fattyProfile||typeof m.fattyProfile!="object"||(q+=m.grams,Object.entries(m.fattyProfile).forEach(([P,i])=>{let d=r(i);d>0&&(h[P]=(h[P]||0)+m.grams*(d/100))}))});let O={};return q>0&&Object.entries(h).forEach(([m,P])=>{O[m]=P/q*100}),{percent:O,coveredWeight:q}}function H(M){let h=q=>M[q]||0;return{hardness:h("lauric")+h("myristic")+h("palmitic")+h("stearic"),cleansing:h("lauric")+h("myristic"),conditioning:h("oleic")+h("linoleic")+h("linolenic")+h("ricinoleic"),bubbly:h("lauric")+h("myristic")+h("ricinoleic"),creamy:h("palmitic")+h("stearic")+h("ricinoleic")}}function $(M){if(!M||typeof M!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let h={lauric:r(M.lauric),myristic:r(M.myristic),palmitic:r(M.palmitic),stearic:r(M.stearic),ricinoleic:r(M.ricinoleic),oleic:r(M.oleic),linoleic:r(M.linoleic),linolenic:r(M.linolenic)},q=H(h);return{hardness:(q.hardness||0)/100,cleansing:(q.cleansing||0)/100,conditioning:(q.conditioning||0)/100,bubbly:(q.bubbly||0)/100,creamy:(q.creamy||0)/100}}e.calc={computeIodine:y,computeFattyAcids:w,computeQualities:H,computeOilQualityScores:$},B.SoapCalcService=e.calc})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w}=e.helpers,{UNIT_FACTORS:H}=e.constants,$=e.state;function M(i){return w(y(i),0)*(H[$.currentUnit]||1)}function h(i){return w(i,0)/(H[$.currentUnit]||1)}function q(i){return!isFinite(i)||i<=0?"--":`${r(h(i),2)} ${$.currentUnit}`}function O(i){return isFinite(i)?`${r(i,1)}%`:"--"}function m(){document.querySelectorAll(".unit-label").forEach(i=>{i.textContent=$.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(i=>{i.dataset.suffix=$.currentUnit})}function P(i,d={}){if(!i)return;if(i===$.currentUnit){m();return}let s=$.currentUnit;if($.currentUnit=i,m(),d.skipConvert)return;let n=(H[s]||1)/(H[i]||1);document.querySelectorAll(".oil-grams").forEach(a=>{let l=y(a.value);l>0&&(a.value=r(l*n,2))}),document.querySelectorAll(".fragrance-grams").forEach(a=>{let l=y(a.value);l>0&&(a.value=r(l*n,2))});let o=document.getElementById("oilTotalTarget");if(o&&o.value){let a=y(o.value);a>0&&(o.value=r(a*n,2))}let u=document.getElementById("moldWaterWeight");if(u&&u.value){let a=y(u.value);a>0&&(u.value=r(a*n,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),d.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:M,fromGrams:h,formatWeight:q,formatPercent:O,updateUnitLabels:m,setUnit:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.state,y={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function w(s){s&&(s.classList.remove("soap-number-pulse"),s.offsetWidth,s.classList.add("soap-number-pulse"))}function H(s){var o;let n=document.getElementById(s);return!n||!((o=B.bootstrap)!=null&&o.Toast)?null:bootstrap.Toast.getOrCreateInstance(n)}function $(){let s=Date.now();if(s-r.lastSaveToastAt<3500)return;r.lastSaveToastAt=s;let n=H("soapAutosaveToast");n&&n.show()}function M(s){let n=document.getElementById("soapUndoToast");if(!n)return;let o=n.querySelector(".toast-body");o&&(o.textContent=s||"Oil removed.");let u=H("soapUndoToast");u&&u.show()}function h(){let s=document.getElementById("resultsReadyBadge"),n=document.getElementById("resultsUpdatedAt");s&&s.classList.remove("d-none"),n&&(n.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function q(s){let n=document.getElementById("lyeConcentrationWarning"),o=document.getElementById("waterRatioWarning");if(n){let u=(s==null?void 0:s.lyeConcentration)||0,a="";u>40&&(a="High concentration"),u>0&&u<25&&(a="Low concentration"),n.textContent=a,n.classList.toggle("d-none",!a)}if(o){let u=(s==null?void 0:s.waterRatio)||0,a="";u>0&&u<1.8&&(a="Low water"),u>2.7&&(a="High water"),o.textContent=a,o.classList.toggle("d-none",!a)}}function O(){document.querySelectorAll("#soapToolPage .form-text").forEach(s=>{let n=s.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");n&&n.classList.add("soap-field")})}function m(s){if(!s||s.type!=="number")return;let n=s.value;if(n===""){s.classList.remove("is-invalid");return}let o=parseFloat(n),u=s.getAttribute("min"),a=s.getAttribute("max"),l=u!==null&&u!==""&&o<parseFloat(u),S=a!==null&&a!==""&&o>parseFloat(a);s.classList.toggle("is-invalid",!isFinite(o)||l||S)}function P(s){var o;if(!s)return;let n=((o=s.querySelector)==null?void 0:o.call(s,".soap-stage-card"))||s;n.classList.add("soap-stage-highlight"),setTimeout(()=>n.classList.remove("soap-stage-highlight"),900)}function i(s,n,o={}){var S;let u=document.getElementById("soapAlertStack");if(!u)return;let a=y[s]||y.info,l=document.createElement("div");l.className=`alert alert-${s} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${a} mt-1"></i>
      <div class="flex-grow-1">${n}</div>
      ${o.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,o.dismissible&&((S=l.querySelector('[data-role="dismiss"]'))==null||S.addEventListener("click",()=>l.remove())),u.prepend(l),o.persist||setTimeout(()=>{l.parentNode&&l.remove()},o.timeoutMs||4500)}function d(){let s=document.getElementById("soapAlertStack");s&&s.querySelectorAll(".alert").forEach(n=>n.remove())}e.ui={pulseValue:w,getToastInstance:H,showAutosaveToast:$,showUndoToast:M,updateResultsMeta:h,updateResultsWarnings:q,applyHelperVisibility:O,validateNumericField:m,flashStage:P,showSoapAlert:i,clearSoapAlerts:d}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function r(){let w=document.getElementById("soapStagePane"),H=document.getElementById("soapQualityCard");if(!w||!H)return;if(!B.matchMedia("(min-width: 768px)").matches){w.classList.remove("is-height-synced"),w.style.removeProperty("--soap-stage-height");return}let M=H.offsetHeight;if(!M){w.classList.remove("is-height-synced"),w.style.removeProperty("--soap-stage-height");return}w.style.setProperty("--soap-stage-height",`${M}px`),w.classList.add("is-height-synced")}let y=()=>{B.requestAnimationFrame(r)};e.layout={syncStageHeight:r,scheduleStageHeightSync:y}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{clamp:r,toNumber:y,round:w}=e.helpers,{toGrams:H,fromGrams:$}=e.units;function M(){let i=m(),d=document.getElementById("oilTotalTarget"),s=document.getElementById("oilTargetHint");d&&i.effectiveCapacity>0&&H(d.value)<=0&&(d.value=i.targetOils>0?w($(i.targetOils),2):""),s&&(i.effectiveCapacity>0?s.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":s.textContent="Auto-fills when mold sizing is set.");let n=document.getElementById("moldSuggestionNote");if(n){let o="Target oils are capped to the mold size above.";i.shape==="cylinder"&&i.waterWeight>0&&(i.useCylinder?o=`Cylinder correction applied (${w(i.cylinderFactor*100,0)}% of capacity).`:o="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),n.textContent=o}h()}function h(i=null){var p;let d=document.getElementById("moldWetBatterWarning");if(!d)return;let s=()=>{d.classList.add("d-none"),d.textContent=""},n=m(),o=e.state||{},u=o.lastCalc||null,a=(p=e.oils)!=null&&p.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=y(u==null?void 0:u.totalOils),S=y(i);if((!isFinite(S)||S<=0)&&(S=y(u==null?void 0:u.batchYield)),i==null&&l>0&&a>0&&Math.abs(l-a)>.01){s();return}if(!isFinite(S)||S<=0||n.effectiveCapacity<=0){s();return}let v=S-n.effectiveCapacity;if(v<=.01){s();return}let I=o.currentUnit||"g";d.textContent=`Full wet batter is ${w($(S),2)} ${I}, exceeding mold capacity ${w($(n.effectiveCapacity),2)} ${I} by ${w($(v),2)} ${I}. Reduce oils target/% of mold or lower water/additives.`,d.classList.remove("d-none")}function q(){let i=document.getElementById("oilTotalTarget"),d=m();return i&&(d.effectiveCapacity>0&&(i.value=d.targetOils>0?w($(d.targetOils),2):""),M()),d}function O(){let i=document.getElementById("oilTotalTarget"),d=document.getElementById("moldOilPct");if(!i||!d){let o=m();return M(),o}let s=m();if(s.effectiveCapacity>0){let o=H(i.value),u=r(o,0,s.effectiveCapacity);o>s.effectiveCapacity+.01&&(i.value=w($(u),2));let a=u>0?u/s.effectiveCapacity*100:0;d.value=u>0?w(a,2):""}let n=m();return M(),n}function m(){var l,S,v;let i=H(document.getElementById("moldWaterWeight").value),d=r(y(document.getElementById("moldOilPct").value),0,100),s=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",n=!!((S=document.getElementById("moldCylinderCorrection"))!=null&&S.checked),o=r(y((v=document.getElementById("moldCylinderFactor"))==null?void 0:v.value),.5,1),u=i>0?i*(n?o:1):0,a=u>0?u*(d/100):0;return{waterWeight:i,oilPct:d,shape:s,useCylinder:n,cylinderFactor:o,effectiveCapacity:u,targetOils:a}}function P(){var s;let i=((s=document.getElementById("moldShape"))==null?void 0:s.value)||"loaf",d=document.getElementById("moldCylinderOptions");d&&d.classList.toggle("d-none",i!=="cylinder"),M()}e.mold={updateMoldSuggested:M,updateWetBatterWarning:h,syncTargetFromMold:q,syncMoldPctFromTarget:O,getMoldSettings:m,updateMoldShapeUI:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w,buildSoapcalcSearchBuilder:H}=e.helpers,{toGrams:$,fromGrams:M}=e.units,{OIL_CATEGORY_SET:h,OIL_TIP_RULES:q}=e.constants,{computeQualities:O}=e.calc,m=e.state;function P(f){let T=f.querySelector(".oil-typeahead"),C=f.querySelector(".oil-sap-koh"),_=f.querySelector(".oil-iodine"),L=f.querySelector(".oil-fatty"),N=f.querySelector(".oil-gi-id"),K=f.querySelector(".oil-default-unit"),Y=f.querySelector(".oil-category"),D=f.querySelector('[data-role="suggestions"]');if(!T||!D||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let j=H();B.attachMergedInventoryGlobalTypeahead({inputEl:T,listEl:D,mode:"public",giHiddenEl:N,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:j,searchType:"ingredient",resultFilter:(F,Q)=>G(F,h,Q),requireHidden:!1,onSelection:function(F){C&&(C.value=(F==null?void 0:F.saponification_value)||""),_&&(_.value=(F==null?void 0:F.iodine_value)||""),L&&(L.value=F!=null&&F.fatty_acid_profile?JSON.stringify(F.fatty_acid_profile):""),K&&(K.value=(F==null?void 0:F.default_unit)||""),Y&&(Y.value=(F==null?void 0:F.ingredient_category_name)||""),t(F),I(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),T.addEventListener("input",function(){this.value.trim()||(C&&(C.value=""),_&&(_.value=""),L&&(L.value=""),N&&(N.value=""),K&&(K.value=""),Y&&(Y.value=""),b())})}function i(){var C,_;let f=document.getElementById("oilRowTemplate"),T=(_=(C=f==null?void 0:f.content)==null?void 0:C.querySelector(".oil-row"))==null?void 0:_.cloneNode(!0);return T?(T.querySelectorAll("input").forEach(L=>{L.value=""}),T.querySelectorAll(".form-text").forEach(L=>{let N=L.closest('.soap-field-stack, [class*="col-"]');N&&N.classList.add("soap-field")}),P(T),T.querySelectorAll(".unit-suffix").forEach(L=>{L.dataset.suffix=m.currentUnit}),T):document.createElement("div")}function d(){let f=document.getElementById("oilTotalTarget"),T=$(f==null?void 0:f.value);if(T>0)return T;let C=e.mold.getMoldSettings();return C.targetOils>0?C.targetOils:0}function s(f){let T=[];return f.forEach(_=>{var K,Y;let L=$((K=_.querySelector(".oil-grams"))==null?void 0:K.value),N=w(y((Y=_.querySelector(".oil-percent"))==null?void 0:Y.value),0);L>0&&N>0&&T.push(L/(N/100))}),T.length?T.reduce((_,L)=>_+L,0)/T.length:0}function n(f,T){if(!f||!T||T<=0)return{allowedGrams:null,allowedPct:null};let C=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=C.reduce((j,F)=>{var Q;return F===f?j:j+$((Q=F.querySelector(".oil-grams"))==null?void 0:Q.value)},0),L=C.reduce((j,F)=>{var Q;return F===f?j:j+w(y((Q=F.querySelector(".oil-percent"))==null?void 0:Q.value),0)},0),N=Math.max(0,100-L),K=Math.max(0,T-_),Y=T*N/100;return{allowedGrams:Math.max(0,Math.min(K,Y)),allowedPct:N}}function o(f,T,C){if(!f)return;let _=f.querySelector(`[data-role="oil-${T}-hint"]`);_&&(C?(_.textContent=C,_.classList.add("is-visible")):(_.textContent="",_.classList.remove("is-visible")))}function u(f){f&&(f.classList.remove("oil-input-bounce"),f.offsetWidth,f.classList.add("oil-input-bounce"))}function a(f,T,C={}){let _=d();if(!f||!_||_<=0){o(f,T,"");return}let L=f.querySelector(".oil-grams"),N=f.querySelector(".oil-percent"),K=n(f,_);if(T==="grams"&&L){let Y=$(L.value),D="";if(Y>_+.01?D="Entry exceeds the max oils allowed in stage 2.":K.allowedGrams!==null&&Y>K.allowedGrams+.01&&(D=`Must be under ${r(M(K.allowedGrams),2)} ${m.currentUnit} to stay within the stage 2 oil limit.`),D){let j=K.allowedGrams!==null?r(M(K.allowedGrams),2):r(M(_),2);L.value=j>0?j:"",o(f,T,D),L.classList.add("oil-input-warning"),u(L),I()}else L.classList.remove("oil-input-warning"),o(f,T,"")}if(T==="percent"&&N){let Y=w(y(N.value),0),D="";if(Y>100.01?D="Entry exceeds the max oils allowed in stage 2.":K.allowedPct!==null&&Y>K.allowedPct+.01&&(D=`Must be under ${r(K.allowedPct,2)}% to stay within the stage 2 oil limit.`),D){let j=K.allowedPct!==null?r(K.allowedPct,2):100;N.value=j>0?j:"",o(f,T,D),N.classList.add("oil-input-warning"),u(N),I()}else N.classList.remove("oil-input-warning"),o(f,T,"")}}function l(f,T={}){let C=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=f!=null?f:d(),L=!!T.force;if(!_||_<=0||!C.length){m.lastOilTarget=_;return}let N=C.reduce((Y,D)=>{var j;return Y+w(y((j=D.querySelector(".oil-percent"))==null?void 0:j.value),0)},0),K=C.reduce((Y,D)=>{var j;return Y+$((j=D.querySelector(".oil-grams"))==null?void 0:j.value)},0);if(N<=0&&K<=0){m.lastOilTarget=_;return}if(!(!L&&m.lastOilTarget&&Math.abs(m.lastOilTarget-_)<.01)){if(N>0)C.forEach(Y=>{let D=Y.querySelector(".oil-percent"),j=Y.querySelector(".oil-grams"),F=w(y(D==null?void 0:D.value),0),Q=N>0?F/N:0;j&&(j.value=Q>0?r(M(_*Q),2):""),D&&(D.value=Q>0?r(Q*100,2):"")});else if(K>0){let Y=_/K;C.forEach(D=>{let j=D.querySelector(".oil-grams"),F=D.querySelector(".oil-percent"),Q=$(j==null?void 0:j.value);if(j){let z=Q>0?Q*Y:0;j.value=z>0?r(M(z),2):""}if(F){let z=$(j==null?void 0:j.value);F.value=z>0?r(z/_*100,2):""}})}m.lastOilTarget=_,I({skipEnforce:!0})}}function S(f,T){if(!m.lastOilEdit||!m.lastOilEdit.row)return!1;let C=m.lastOilEdit.row,_=f.reduce((Y,D)=>{var j;return D===C?Y:Y+$((j=D.querySelector(".oil-grams"))==null?void 0:j.value)},0),L=Math.max(0,T-_),N=C.querySelector(".oil-grams"),K=C.querySelector(".oil-percent");return!N||!K?!1:(N.value=L>0?r(M(L),2):"",K.value=L>0?r(L/T*100,2):"",m.wasCapped=!0,!0)}function v({totalWeight:f,totalPct:T,target:C,capped:_}){let L=document.getElementById("oilLimitWarning");if(!L)return;let N=[];if(_&&N.push("Oil total hit the mold cap and was adjusted."),C>0&&f>C+.01){let K=f-C;N.push(`Oil weights exceed the target by ${r(M(K),2)} ${m.currentUnit}.`)}T>100.01&&N.push(`Oil percentages are over 100% by ${r(T-100,2)}%.`),N.length?(L.classList.remove("d-none"),L.innerHTML=`${N.join(" ")} Adjust oils or mold % to continue.`):(L.classList.add("d-none"),L.textContent="")}function I(f={}){var Y;f.skipEnforce||(m.wasCapped=!1);let T=Array.from(document.querySelectorAll("#oilRows .oil-row")),C=e.mold.getMoldSettings(),_=d();if(!_&&!C.targetOils){let D=s(T);if(D>0){_=D;let j=document.getElementById("oilTotalTarget");j&&!j.value&&(j.value=r(M(D),2))}}let L=0,N=0;if(T.forEach(D=>{let j=D.querySelector(".oil-grams"),F=D.querySelector(".oil-percent"),Q=$(j==null?void 0:j.value),z=w(y(F==null?void 0:F.value),0);_>0&&(m.lastOilEdit&&m.lastOilEdit.row===D&&m.lastOilEdit.field==="percent"?(Q=z>0?_*(z/100):0,j.value=z>0?r(M(Q),2):""):Q>0?(z=Q/_*100,F.value=r(z,2)):z>0&&(Q=_*(z/100),j.value=r(M(Q),2)),N+=z),Q>0&&(L+=Q)}),_<=0&&(L>0?(N=0,T.forEach(D=>{let j=D.querySelector(".oil-grams"),F=D.querySelector(".oil-percent"),Q=$(j==null?void 0:j.value);if(Q>0){let z=Q/L*100;F.value=r(z,2),N+=z}})):N=T.reduce((D,j)=>{var F;return D+w(y((F=j.querySelector(".oil-percent"))==null?void 0:F.value),0)},0)),!f.skipEnforce&&C.targetOils>0&&L>C.targetOils+.01&&S(T,C.targetOils))return I({skipEnforce:!0});m.totalOilsGrams=L;let K=document.getElementById("oilTotalComputed");return K&&(K.textContent=L>0?`${r(M(L),2)} ${m.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=r(N,2),v({totalWeight:L,totalPct:N,target:_,capped:m.wasCapped}),e.additives.updateAdditivesOutput(L),(Y=e.fragrances)!=null&&Y.updateFragranceTotals&&e.fragrances.updateFragranceTotals(L),e.mold.updateMoldSuggested(),R(),{totalWeight:L,totalPct:N,target:_}}function p(){let f=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!f.length)return;let T=d(),C=f.reduce((_,L)=>{var N;return _+w(y((N=L.querySelector(".oil-percent"))==null?void 0:N.value),0)},0);!C&&T>0&&(C=f.reduce((_,L)=>{var K;let N=$((K=L.querySelector(".oil-grams"))==null?void 0:K.value);return _+(N>0?N/T*100:0)},0)),!(C<=0)&&(f.forEach(_=>{let L=_.querySelector(".oil-percent"),N=_.querySelector(".oil-grams"),Y=w(y(L.value),0)/C*100;L.value=r(Y,2),T>0&&(N.value=Y>0?r(M(T*(Y/100)),2):"")}),I())}function E(){let f=[];return document.querySelectorAll("#oilRows .oil-row").forEach(T=>{var Q,z,X,te,ie,le,ae,ee,re;let C=(z=(Q=T.querySelector(".oil-typeahead"))==null?void 0:Q.value)==null?void 0:z.trim(),_=$((X=T.querySelector(".oil-grams"))==null?void 0:X.value),L=y((te=T.querySelector(".oil-sap-koh"))==null?void 0:te.value),N=y((ie=T.querySelector(".oil-iodine"))==null?void 0:ie.value),K=((le=T.querySelector(".oil-fatty"))==null?void 0:le.value)||"",Y=((ae=T.querySelector(".oil-gi-id"))==null?void 0:ae.value)||"",D=((ee=T.querySelector(".oil-default-unit"))==null?void 0:ee.value)||"",j=((re=T.querySelector(".oil-category"))==null?void 0:re.value)||"",F=null;if(K)try{F=JSON.parse(K)}catch{F=null}_<=0||f.push({name:C||null,grams:_,sapKoh:L,iodine:N,fattyProfile:F,global_item_id:Y?parseInt(Y):null,default_unit:D||null,ingredient_category_name:j||null})}),f}function c({name:f,sapKoh:T,iodine:C,fattyProfile:_}={}){let L=document.getElementById("oilProfileFloat"),N=(z,X)=>{let te=document.getElementById(z);te&&(te.textContent=X)},K=f||"Pick an oil to preview";N("selectedOilName",K),N("selectedOilModalName",K),L&&L.classList.toggle("d-none",!f);let Y=T>0?r(T,1):"--",D=C>0?r(C,1):"--";N("selectedOilSap",Y),N("selectedOilModalSap",Y),N("selectedOilIodine",D),N("selectedOilModalIodine",D);let j=_?O(_):{},F=(z,X)=>{let te=isFinite(X)&&X>0?r(X,1):"--";N(z,te)};F("selectedOilHardness",j.hardness),F("selectedOilModalHardness",j.hardness),F("selectedOilCleansing",j.cleansing),F("selectedOilModalCleansing",j.cleansing),F("selectedOilConditioning",j.conditioning),F("selectedOilModalConditioning",j.conditioning),F("selectedOilBubbly",j.bubbly),F("selectedOilModalBubbly",j.bubbly),F("selectedOilCreamy",j.creamy),F("selectedOilModalCreamy",j.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(z=>{let X=`selectedOil${z.charAt(0).toUpperCase()}${z.slice(1)}`,te=`selectedOilModal${z.charAt(0).toUpperCase()}${z.slice(1)}`,ie=_?y(_[z]):0,le=ie>0?r(ie,1):"--";N(X,le),N(te,le)})}function t(f){if(!f){b();return}m.selectedOilProfile=f;let T=f.fatty_acid_profile||null;if(typeof T=="string")try{T=JSON.parse(T)}catch{T=null}c({name:f.text||f.display_name||f.name,sapKoh:y(f.saponification_value),iodine:y(f.iodine_value),fattyProfile:T})}function g(f){var K,Y,D,j,F;if(!f)return;let T=(Y=(K=f.querySelector(".oil-typeahead"))==null?void 0:K.value)==null?void 0:Y.trim(),C=y((D=f.querySelector(".oil-sap-koh"))==null?void 0:D.value),_=y((j=f.querySelector(".oil-iodine"))==null?void 0:j.value),L=((F=f.querySelector(".oil-fatty"))==null?void 0:F.value)||"",N=null;if(L)try{N=JSON.parse(L)}catch{N=null}c({name:T,sapKoh:C,iodine:_,fattyProfile:N})}function b(){m.selectedOilProfile=null,m.lastPreviewRow=null,c()}function R(){let f=document.getElementById("oilBlendTips");if(!f)return;let T=E().filter(L=>L.grams>0||L.percent>0);if(!T.length){f.classList.add("d-none"),f.textContent="";return}let C=new Set;T.forEach(L=>{let N=(L.name||"").toLowerCase();if(N&&q.forEach(K=>{K.match.test(N)&&C.add(K.tip)}),L.fattyProfile&&typeof L.fattyProfile=="object"){let K=y(L.fattyProfile.lauric),Y=y(L.fattyProfile.myristic),D=y(L.fattyProfile.palmitic),j=y(L.fattyProfile.stearic),F=y(L.fattyProfile.ricinoleic),Q=y(L.fattyProfile.oleic),z=y(L.fattyProfile.linoleic),X=y(L.fattyProfile.linolenic);K+Y>=30&&C.add(`${L.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),D+j>=40&&C.add(`${L.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),Q>=60&&C.add(`${L.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),z+X>=20&&C.add(`${L.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),F>=60&&C.add(`${L.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let _=Array.from(C).slice(0,6);if(!_.length){f.classList.add("d-none"),f.textContent="";return}f.classList.remove("d-none"),f.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${_.map(L=>`<li>${L}</li>`).join("")}</ul>`}function A(){return m.totalOilsGrams||0}function x(f){var T,C,_,L,N,K,Y,D,j;return f?{name:((T=f.querySelector(".oil-typeahead"))==null?void 0:T.value)||"",grams:((C=f.querySelector(".oil-grams"))==null?void 0:C.value)||"",percent:((_=f.querySelector(".oil-percent"))==null?void 0:_.value)||"",sap:((L=f.querySelector(".oil-sap-koh"))==null?void 0:L.value)||"",iodine:((N=f.querySelector(".oil-iodine"))==null?void 0:N.value)||"",fattyRaw:((K=f.querySelector(".oil-fatty"))==null?void 0:K.value)||"",gi:((Y=f.querySelector(".oil-gi-id"))==null?void 0:Y.value)||"",defaultUnit:((D=f.querySelector(".oil-default-unit"))==null?void 0:D.value)||"",categoryName:((j=f.querySelector(".oil-category"))==null?void 0:j.value)||""}:null}function G(f,T,C){let _=U(f);return _?T.has(_):C==="inventory"}function U(f){return!f||typeof f!="object"?null:f.ingredient&&f.ingredient.ingredient_category_name||f.ingredient_category_name||f.ingredient_category&&f.ingredient_category.name||null}e.oils={attachOilTypeahead:P,buildOilRow:i,getOilTargetGrams:d,updateOilTotals:I,normalizeOils:p,collectOilData:E,setSelectedOilProfileFromRow:g,clearSelectedOilProfile:b,updateOilTips:R,getTotalOilsGrams:A,serializeOilRow:x,validateOilEntry:a,scaleOilsToTarget:l}})(window);(function(B){"use strict";var c;let e=B.SoapTool=B.SoapTool||{},r=e.bulkOils=e.bulkOils||{},{toNumber:y,clamp:w}=e.helpers,H=e.state,$=Array.isArray((c=e.constants)==null?void 0:c.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],M=new Set(["selected_pct","selected_weight_g"]),h=25,q=140,O=260,m={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function P(){var t,g;(g=(t=e.storage)==null?void 0:t.queueStateSave)==null||g.call(t)}function i(t,g){var b,R;(R=(b=e.ui)==null?void 0:b.showSoapAlert)==null||R.call(b,t,g,{dismissible:!0,timeoutMs:6e3})}function d(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function s(t){return t?t==="name"||M.has(t)?!0:$.includes(t):!1}function n(){(!H.bulkOilModal||typeof H.bulkOilModal!="object")&&(H.bulkOilModal=JSON.parse(JSON.stringify(m)));let t=H.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=s(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function o(t){let g={},b=t&&typeof t=="object"?t:{};return $.forEach(R=>{let A=y(b[R]);A>0&&(g[R]=A)}),g}function u(t){let g=o(t==null?void 0:t.fatty_profile),b=String((t==null?void 0:t.name)||"").trim(),R=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",A=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:y(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(A?`global:${A}`:`${R}:${b.toLowerCase()}`)),name:b,sap_koh:y(t==null?void 0:t.sap_koh),iodine:y(t==null?void 0:t.iodine),fatty_profile:g,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:A,source:R,is_basic:!!(t!=null&&t.is_basic)}}function a(){let t=d(),g=n(),b=Object.keys(g.selection||{}).length,R=`Selected: ${b}`;t.summaryEl&&(t.summaryEl.textContent=R),t.stageCountEl&&(t.stageCountEl.textContent=String(b))}function l(t){var b;return((b=n().selection)==null?void 0:b[t])||null}function S(t,g={}){var x,G;let b=n();if(!t||!t.key)return null;let R=b.selection[t.key]||{},A={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:w(y((x=g.selected_pct)!=null?x:R.selected_pct),0,100),selected_weight_g:w(y((G=g.selected_weight_g)!=null?G:R.selected_weight_g),0)};return b.selection[t.key]=A,A}function v(t){var b;let g=n();(b=g.selection)!=null&&b[t]&&delete g.selection[t]}function I(t){var b;return((b=n().recordByKey)==null?void 0:b[t])||null}function p(){let t=n();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(g=>({key:g.key,name:g.name,sap_koh:g.sap_koh,iodine:g.iodine,fatty_profile:g.fatty_profile||{},default_unit:g.default_unit,ingredient_category_name:g.ingredient_category_name,global_item_id:g.global_item_id,source:g.source,is_basic:!!g.is_basic,selected_pct:w(y(g.selected_pct),0,100),selected_weight_g:w(y(g.selected_weight_g),0)}))}}function E(t){let g=n();g.mode="all",g.viewSelected=!!(t!=null&&t.view_selected),g.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",g.sortKey=s(t==null?void 0:t.sort_key)?t.sort_key:"name",g.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let b={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(A=>{let x=String((A==null?void 0:A.key)||"").trim(),G=String((A==null?void 0:A.name)||"").trim();!x||!G||(b[x]={key:x,name:G,sap_koh:y(A==null?void 0:A.sap_koh),iodine:y(A==null?void 0:A.iodine),fatty_profile:o(A==null?void 0:A.fatty_profile),default_unit:String((A==null?void 0:A.default_unit)||"gram"),ingredient_category_name:String((A==null?void 0:A.ingredient_category_name)||""),global_item_id:y(A==null?void 0:A.global_item_id)>0?parseInt(A.global_item_id,10):null,source:String((A==null?void 0:A.source)||"soapcalc"),is_basic:!!(A!=null&&A.is_basic),selected_pct:w(y(A==null?void 0:A.selected_pct),0,100),selected_weight_g:w(y(A==null?void 0:A.selected_weight_g),0)})}),g.selection=b,g.visibleRecords=[],g.offset=0,g.totalCount=0,g.hasMore=!0,g.loading=!1,a()}r.shared={FATTY_KEYS:$,LOCAL_SORT_KEYS:M,PAGE_SIZE:h,SCROLL_FETCH_THRESHOLD:q,SEARCH_DEBOUNCE_MS:O,queueStateSave:P,showAlert:i,getRefs:d,ensureModalState:n,normalizeFattyProfile:o,normalizeCatalogRecord:u,updateSelectionCounters:a,selectionForRecordKey:l,setSelection:S,removeSelection:v,getRecordByKey:I,serializeSelection:p,restoreState:E}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.bulkOils=e.bulkOils||{},y=r.shared;if(!y)return;let{round:w,toNumber:H}=e.helpers,{fromGrams:$}=e.units,{FATTY_KEYS:M,LOCAL_SORT_KEYS:h,getRefs:q,ensureModalState:O,selectionForRecordKey:m,updateSelectionCounters:P}=y;function i(c){let t=q();t.statusEl&&(t.statusEl.textContent=c)}function d(){let c=O();if(c.loading&&!c.visibleRecords.length){i("Loading oils...");return}if(!c.visibleRecords.length){let A=c.query?"No oils match that search.":"No oils available.";i(A);return}let t=c.visibleRecords.length,g=c.totalCount,b=c.hasMore?" \u2022 scroll for more":"",R=c.query?` \u2022 search: "${c.query}"`:"";i(`Showing ${t} of ${g} oils${R}${b}`)}function s(c,t,g){if(typeof c=="string"||typeof t=="string"){let A=String(c||"").toLowerCase(),x=String(t||"").toLowerCase();return A<x?g==="asc"?-1:1:A>x?g==="asc"?1:-1:0}let b=H(c),R=H(t);return b<R?g==="asc"?-1:1:b>R?g==="asc"?1:-1:0}function n(c,t){var g,b;return t==="selected_pct"?((g=m(c.key))==null?void 0:g.selected_pct)||0:t==="selected_weight_g"?((b=m(c.key))==null?void 0:b.selected_weight_g)||0:""}function o(){let c=O();h.has(c.sortKey)&&c.visibleRecords.sort((t,g)=>{let b=s(n(t,c.sortKey),n(g,c.sortKey),c.sortDir);return b!==0?b:s(t.name||"",g.name||"","asc")})}function u(){let c=O();if(!c.viewSelected)return;let t=[],g=[];c.visibleRecords.forEach(b=>{m(b.key)?t.push(b):g.push(b)}),c.visibleRecords=t.concat(g)}function a(){o(),u()}function l(c){let t=String(c||"").trim().toLowerCase();return t==="name"||M.includes(t)?t:"name"}function S(){let c=O();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[▲▼]\s*$/,"").trim());let g=t.dataset.label||"",b=t.dataset.sortKey||"";c.sortKey===b?t.textContent=`${g} ${c.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=g})}function v(c,t){let g=m(t.key),b=c.querySelector(".bulk-oil-check"),R=c.querySelector(".bulk-oil-pct"),A=c.querySelector(".bulk-oil-weight");b&&(b.checked=!!g),R&&(R.value=g&&g.selected_pct>0?w(g.selected_pct,2):""),A&&(A.value=g&&g.selected_weight_g>0?w($(g.selected_weight_g),2):"")}function I(c){let t=document.createElement("td");t.className="bulk-oil-acid";let g=H(c);return t.textContent=g>0?w(g,1).toString():"--",t}function p(c){let t=document.createElement("tr");t.dataset.recordKey=c.key;let g=document.createElement("td");g.className="text-center";let b=document.createElement("input");b.type="checkbox",b.className="form-check-input bulk-oil-check",g.appendChild(b),t.appendChild(g);let R=document.createElement("td");R.className="bulk-oil-name";let A=document.createElement("div");A.className="fw-semibold small",A.textContent=c.name;let x=document.createElement("div");x.className="text-muted small";let G=c.ingredient_category_name?` \xB7 ${c.ingredient_category_name}`:"";x.textContent=`${c.source}${G}`,R.appendChild(A),R.appendChild(x),t.appendChild(R),M.forEach(_=>{var L;t.appendChild(I((L=c.fatty_profile)==null?void 0:L[_]))});let U=document.createElement("td"),f=document.createElement("input");f.type="number",f.min="0",f.max="100",f.step="0.1",f.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",U.appendChild(f),t.appendChild(U);let T=document.createElement("td"),C=document.createElement("input");return C.type="number",C.min="0",C.step="0.1",C.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",T.appendChild(C),t.appendChild(T),v(t,c),t}function E(){let c=q(),t=O();if(!c.bodyEl)return;c.bodyEl.innerHTML="";let g=document.createDocumentFragment();t.visibleRecords.forEach(b=>{g.appendChild(p(b))}),c.bodyEl.appendChild(g),S(),P(),d()}r.render={updateStatusText:i,refreshCatalogStatus:d,applyLocalSelectionSortIfNeeded:o,applyViewSelectedOrderingIfNeeded:u,applyClientOrdering:a,normalizeServerSortKey:l,sortButtonsLabel:S,renderVisibleRecords:E}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.bulkOils=e.bulkOils||{},y=r.shared,w=r.render;if(!y||!w)return;let{PAGE_SIZE:H,getRefs:$,ensureModalState:M,normalizeCatalogRecord:h}=y,{refreshCatalogStatus:q,normalizeServerSortKey:O,applyClientOrdering:m,renderVisibleRecords:P,updateStatusText:i}=w;function d(){let n=M(),o=$();n.visibleRecords=[],n.offset=0,n.totalCount=0,n.hasMore=!0,o.bodyEl&&(o.bodyEl.innerHTML=""),o.scrollEl&&(o.scrollEl.scrollTop=0)}async function s({reset:n=!1}={}){let o=M();if(!$().modalEl||o.loading&&!n||!o.hasMore&&!n)return;n&&d();let a=o.requestToken+1;o.requestToken=a,o.loading=!0,q();let l=new URLSearchParams;l.set("mode",o.mode),l.set("offset",String(o.offset)),l.set("limit",String(H)),l.set("q",o.query||""),l.set("sort_key",O(o.sortKey)),l.set("sort_dir",o.sortDir==="desc"?"desc":"asc");try{let S=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!S.ok)throw new Error("Unable to load oils catalog");let v=await S.json();if(!v||v.success!==!0||!v.result||!Array.isArray(v.result.records))throw new Error("Invalid oils catalog response");if(a!==o.requestToken)return;let I=v.result.records.map(h),p=Math.max(0,parseInt(v.result.next_offset,10)||o.offset+I.length),E=Math.max(I.length,parseInt(v.result.count,10)||0),c=!!v.result.has_more;I.forEach(t=>{o.recordByKey[t.key]=t}),o.visibleRecords=n?I.slice():o.visibleRecords.concat(I),o.offset=p,o.totalCount=E,o.hasMore=c,m(),P()}catch(S){throw a===o.requestToken&&i("Unable to load oils catalog."),S}finally{a===o.requestToken&&(o.loading=!1,q())}}r.api={fetchCatalogPage:s}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.bulkOils=e.bulkOils||{},y=r.shared,w=r.render,H=r.api;if(!y||!w||!H)return;let{round:$,toNumber:M,clamp:h}=e.helpers,{toGrams:q,fromGrams:O}=e.units,m=e.state,{LOCAL_SORT_KEYS:P,SCROLL_FETCH_THRESHOLD:i,SEARCH_DEBOUNCE_MS:d,queueStateSave:s,showAlert:n,getRefs:o,ensureModalState:u,updateSelectionCounters:a,setSelection:l,removeSelection:S,getRecordByKey:v,serializeSelection:I,restoreState:p}=y,{applyClientOrdering:E,sortButtonsLabel:c,renderVisibleRecords:t}=w,{fetchCatalogPage:g}=H,b=null,R=null;function A(){var W;let k=o();k.modalEl&&(!b&&((W=B.bootstrap)!=null&&W.Modal)&&(b=B.bootstrap.Modal.getOrCreateInstance(k.modalEl)),b&&b.hide())}function x(){return document.getElementById("oilRows")}function G(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function U(k){return String(k||"").trim().toLowerCase()}function f(k){var W;return U((W=k==null?void 0:k.querySelector(".oil-typeahead"))==null?void 0:W.value)}function T(k){var V;let W=String(((V=k==null?void 0:k.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return W||""}function C(k,W){let V=String(k||"").trim();if(!V)return null;let J=G(),Z=J.find(oe=>String(oe.dataset.bulkOilKey||"")===V);if(Z)return Z;let ne=String((W==null?void 0:W.global_item_id)||"").trim();if(ne&&(Z=J.find(oe=>T(oe)===ne),Z))return Z;let se=U(W==null?void 0:W.name);return se&&(Z=J.find(oe=>f(oe)===se),Z)?Z:null}function _(k,W){if(!k||!W)return;k.dataset.bulkOilKey=W.key||"";let V=k.querySelector(".oil-typeahead"),J=k.querySelector(".oil-sap-koh"),Z=k.querySelector(".oil-iodine"),ne=k.querySelector(".oil-fatty"),se=k.querySelector(".oil-gi-id"),oe=k.querySelector(".oil-default-unit"),ce=k.querySelector(".oil-category"),ge=k.querySelector(".oil-grams"),fe=k.querySelector(".oil-percent");V&&(V.value=W.name||""),J&&(J.value=W.sap_koh>0?$(W.sap_koh,3):""),Z&&(Z.value=W.iodine>0?$(W.iodine,3):""),ne&&(ne.value=W.fatty_profile&&Object.keys(W.fatty_profile).length?JSON.stringify(W.fatty_profile):""),se&&(se.value=W.global_item_id||""),oe&&(oe.value=W.default_unit||""),ce&&(ce.value=W.ingredient_category_name||""),fe&&(fe.value=W.selected_pct>0?$(W.selected_pct,2):""),ge&&(ge.value=W.selected_weight_g>0?$(O(W.selected_weight_g),2):"")}function L(k){if(!k||!k.key)return null;let W=C(k.key,k),V=x();return!W&&V&&(W=e.oils.buildOilRow(),W&&V.appendChild(W)),_(W,k),W}function N(k,W){let V=C(k,W);V&&(m.lastOilEdit&&m.lastOilEdit.row===V&&(m.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function K(){G().forEach(W=>{m.lastOilEdit&&m.lastOilEdit.row===W&&(m.lastOilEdit=null),W.remove()}),e.oils.clearSelectedOilProfile()}function Y(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function D(k,W,V){let J=String(V||"").trim();if(J)return J;let Z=String(W||"").trim();if(Z)return`global:${Z}`;let ne=U(k);return ne?`soapcalc:${ne}`:""}function j(){let k={};return G().forEach(W=>{var he,ve,Se,be,_e,Ee,Ie,Ce,Te;let V=String(((he=W.querySelector(".oil-typeahead"))==null?void 0:he.value)||"").trim(),J=M((ve=W.querySelector(".oil-sap-koh"))==null?void 0:ve.value),Z=M((Se=W.querySelector(".oil-iodine"))==null?void 0:Se.value),ne=String(((be=W.querySelector(".oil-gi-id"))==null?void 0:be.value)||"").trim(),se=String(((_e=W.querySelector(".oil-default-unit"))==null?void 0:_e.value)||"gram"),oe=String(((Ee=W.querySelector(".oil-category"))==null?void 0:Ee.value)||""),ce=h(M((Ie=W.querySelector(".oil-percent"))==null?void 0:Ie.value),0,100),ge=h(q((Ce=W.querySelector(".oil-grams"))==null?void 0:Ce.value),0),fe=String(((Te=W.querySelector(".oil-fatty"))==null?void 0:Te.value)||""),pe={};if(fe)try{let qe=JSON.parse(fe);pe=y.normalizeFattyProfile(qe)}catch{pe={}}let ye=D(V,ne,W.dataset.bulkOilKey);!ye||!(V||ce>0||ge>0||J>0||Z>0||Object.keys(pe).length>0)||(W.dataset.bulkOilKey=ye,k[ye]={key:ye,name:V||"Unnamed oil",sap_koh:J,iodine:Z,fatty_profile:pe,default_unit:se||"gram",ingredient_category_name:oe,global_item_id:ne?parseInt(ne,10):null,source:ne?"global":"soapcalc",is_basic:!ne,selected_pct:ce,selected_weight_g:ge})}),k}function F(){let k=u();k.selection=j(),a()}function Q(){let k=u(),W=Object.values(k.selection||{}),V=new Set(W.map(J=>J.key));G().forEach(J=>{let Z=String(J.dataset.bulkOilKey||"").trim();(!Z||!V.has(Z))&&J.remove()}),W.slice().sort((J,Z)=>String(J.name||"").localeCompare(String(Z.name||""))).forEach(J=>{L(J)}),Y()}async function z(){var V;let k=o(),W=u();if(k.modalEl){F(),!b&&((V=B.bootstrap)!=null&&V.Modal)&&(b=B.bootstrap.Modal.getOrCreateInstance(k.modalEl)),k.searchInput&&(k.searchInput.value=W.query||""),k.viewSelectedToggle&&(k.viewSelectedToggle.checked=!!W.viewSelected),k.unitLabelEl&&(k.unitLabelEl.textContent=m.currentUnit||"g"),b&&b.show(),c(),a();try{await g({reset:!0})}catch{n("danger","Unable to load bulk oils catalog right now.")}}}function X(k){let W=k.target;if(!(W instanceof HTMLElement))return;let V=W.closest("tr[data-record-key]");if(!V)return;let J=V.dataset.recordKey||"",Z=v(J);if(!Z)return;let ne=V.querySelector(".bulk-oil-check"),se=V.querySelector(".bulk-oil-pct"),oe=V.querySelector(".bulk-oil-weight"),ce=h(M(se==null?void 0:se.value),0,100),ge=h(q(oe==null?void 0:oe.value),0),fe=ce>0||ge>0;if(!!(ne!=null&&ne.checked)||fe){ne&&(ne.checked=!0);let he=l(Z,{selected_pct:ce,selected_weight_g:ge});L(he)}else S(J),N(J,Z);let ye=u();P.has(ye.sortKey)||ye.viewSelected?(E(),t()):a(),Y(),s()}function te(k){let W=u();W.viewSelected=!!k,E(),t(),s()}async function ie(k){let W=k.target instanceof HTMLElement?k.target.closest(".bulk-oil-sort"):null;if(!W)return;let V=W.getAttribute("data-sort-key")||"name",J=u();if(J.sortKey===V?J.sortDir=J.sortDir==="asc"?"desc":"asc":(J.sortKey=V,J.sortDir=V==="name"?"asc":"desc"),s(),P.has(J.sortKey)){E(),t();return}try{await g({reset:!0})}catch{n("danger","Unable to load oils in that sort order.")}}function le(){let k=u();k.selection={},K(),(P.has(k.sortKey)||k.viewSelected)&&E(),t(),Y(),s()}async function ae(){let k=o(),W=u();if(!(!k.scrollEl||W.loading||!W.hasMore||!(k.scrollEl.scrollTop+k.scrollEl.clientHeight>=k.scrollEl.scrollHeight-i)))try{await g({reset:!1})}catch{n("danger","Unable to load more oils right now.")}}function ee(){R&&B.clearTimeout(R),R=B.setTimeout(async()=>{try{await g({reset:!0})}catch{n("danger","Unable to search oils right now.")}},d)}function re(){Q(),s(),A()}function ue(k,W){if(!(k instanceof HTMLInputElement))return!1;let J=o().bodyEl;if(!(J instanceof HTMLElement))return!1;let Z=k.classList.contains("bulk-oil-pct")?"bulk-oil-pct":k.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!Z)return!1;let ne=Array.from(J.querySelectorAll(`input.${Z}`)),se=ne.indexOf(k);if(se<0)return!1;let oe=se+W;if(oe<0||oe>=ne.length)return!1;let ce=ne[oe];return ce instanceof HTMLInputElement?(ce.focus(),typeof ce.select=="function"&&ce.select(),!0):!1}function me(){var W;let k=o();k.unitLabelEl&&(k.unitLabelEl.textContent=m.currentUnit||"g"),(W=k.modalEl)!=null&&W.classList.contains("show")&&t()}function de(){let k=o();k.modalEl&&(k.openBtn&&k.openBtn.addEventListener("click",()=>{z()}),k.searchInput&&k.searchInput.addEventListener("input",()=>{let W=u();W.query=k.searchInput.value||"",s(),ee()}),k.viewSelectedToggle&&k.viewSelectedToggle.addEventListener("change",()=>{te(!!k.viewSelectedToggle.checked)}),k.scrollEl&&k.scrollEl.addEventListener("scroll",ae),k.bodyEl&&(k.bodyEl.addEventListener("change",X),k.bodyEl.addEventListener("keydown",W=>{let V=W.target;if(!(!(V instanceof HTMLInputElement)||!(V.classList.contains("bulk-oil-pct")||V.classList.contains("bulk-oil-weight")))){if(W.key==="Enter"){W.preventDefault(),V.blur();return}W.key==="Tab"&&ue(V,W.shiftKey?-1:1)&&W.preventDefault()}})),k.modalEl.querySelectorAll(".bulk-oil-sort").forEach(W=>{W.addEventListener("click",ie)}),k.importBtn&&k.importBtn.addEventListener("click",()=>{re()}),k.clearBtn&&k.clearBtn.addEventListener("click",()=>{le()}),k.modalEl.addEventListener("shown.bs.modal",()=>{let W=o();W.searchInput&&W.searchInput.focus()}))}de(),a(),c(),e.bulkOilsModal={openModal:z,serializeSelection:I,restoreState:p,onUnitChanged:me}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:r,round:y,clamp:w,buildSoapcalcSearchBuilder:H}=e.helpers,{formatWeight:$,toGrams:M,fromGrams:h}=e.units,{FRAGRANCE_CATEGORY_SET:q}=e.constants,O=e.state;function m(E,c,t,g,b){var T;let R=document.getElementById(E),A=document.getElementById(c),x=g?document.getElementById(g):null,G=b?document.getElementById(b):null,U=(T=R==null?void 0:R.parentElement)==null?void 0:T.querySelector('[data-role="suggestions"]');if(!R||!U||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let f=H();B.attachMergedInventoryGlobalTypeahead({inputEl:R,listEl:U,mode:"public",giHiddenEl:A,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:f,searchType:"ingredient",resultFilter:(C,_)=>{let L=p(C);return L?t.has(L):_==="inventory"},requireHidden:!1,onSelection:function(C){x&&(x.value=(C==null?void 0:C.default_unit)||""),G&&(G.value=(C==null?void 0:C.ingredient_category_name)||""),e.storage.queueStateSave()}}),R.addEventListener("input",function(){this.value.trim()||(x&&(x.value=""),G&&(G.value=""))})}function P({pctId:E,weightId:c}){var A,x,G;let t=document.getElementById(E),g=t==null?void 0:t.value;if(g!==""&&g!==null&&g!==void 0)return r(g);let b=w(((x=(A=e.oils)==null?void 0:A.getTotalOilsGrams)==null?void 0:x.call(A))||0,0);if(b<=0)return 0;let R=M((G=document.getElementById(c))==null?void 0:G.value);return R<=0?0:R/b*100}function i(){var E,c,t,g,b,R,A,x;return{lactatePct:P({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:P({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:P({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:P({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((c=(E=document.getElementById("additiveLactateName"))==null?void 0:E.value)==null?void 0:c.trim())||"Sodium Lactate",sugarName:((g=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:g.trim())||"Sugar",saltName:((R=(b=document.getElementById("additiveSaltName"))==null?void 0:b.value)==null?void 0:R.trim())||"Salt",citricName:((x=(A=document.getElementById("additiveCitricName"))==null?void 0:A.value)==null?void 0:x.trim())||"Citric Acid"}}function d(){var c;return(((c=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:c.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function s(E){let c=w(r(E),0),t=w(P({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),g=w(P({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),b=w(P({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),R=w(P({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),A=c*(t/100),x=c*(g/100),G=c*(b/100),U=c*(R/100),f=d()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:g,saltPct:b,citricPct:R,lactateG:A,sugarG:x,saltG:G,citricG:U,citricLyeG:U*f}}function n({pctId:E,weightId:c,sourceField:t,totalOils:g}){let b=document.getElementById(E),R=document.getElementById(c);if(!b||!R)return;let A=w(r(g),0);if(A<=0)return;if(t==="weight"){let f=R.value;if(f===""||f===null||f===void 0){b.value="";return}let T=w(M(f),0),C=T>0?T/A*100:0;b.value=C>0?y(C,2):"";return}let x=b.value;if(x===""||x===null||x===void 0){R.value="";return}let G=w(r(x),0),U=A*(G/100);R.value=U>0?y(h(U),2):""}function o(E){let c=(g,b)=>{let R=document.getElementById(g);if(R)if(R.tagName==="INPUT"){if(document.activeElement===R)return;R.value=b}else R.textContent=b},t=g=>g>0?y(h(g),2):"";c("additiveLactateWeight",t(r(E==null?void 0:E.lactateG))),c("additiveSugarWeight",t(r(E==null?void 0:E.sugarG))),c("additiveSaltWeight",t(r(E==null?void 0:E.saltG))),c("additiveCitricWeight",t(r(E==null?void 0:E.citricG))),c("additiveCitricLyeOut",$(r(E==null?void 0:E.citricLyeG)))}function u(E){let c=w(r(E),0),t=s(c);return o(t),t}function a(E){let c=E.querySelector(".fragrance-typeahead"),t=E.querySelector(".fragrance-gi-id"),g=E.querySelector(".fragrance-default-unit"),b=E.querySelector(".fragrance-category"),R=E.querySelector('[data-role="suggestions"]');if(!c||!R||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let A=H();B.attachMergedInventoryGlobalTypeahead({inputEl:c,listEl:R,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:A,searchType:"ingredient",resultFilter:(x,G)=>{let U=p(x);return U?q.has(U):G==="inventory"},requireHidden:!1,onSelection:function(x){g&&(g.value=(x==null?void 0:x.default_unit)||""),b&&(b.value=(x==null?void 0:x.ingredient_category_name)||""),e.storage.queueStateSave()}}),c.addEventListener("input",function(){this.value.trim()||(g&&(g.value=""),b&&(b.value=""))})}function l(){var t,g;let E=document.getElementById("fragranceRowTemplate"),c=(g=(t=E==null?void 0:E.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:g.cloneNode(!0);return c?(c.querySelectorAll("input").forEach(b=>{b.value=""}),a(c),c.querySelectorAll(".unit-suffix").forEach(b=>{b.dataset.suffix=O.currentUnit}),c):document.createElement("div")}function S(E){let c=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=w(E||e.oils.getTotalOilsGrams()||0,0),g=0,b=0;c.forEach(x=>{let G=x.querySelector(".fragrance-grams"),U=x.querySelector(".fragrance-percent");if(!G||!U)return;let f=G.value,T=U.value,C=M(f),_=w(r(T),0),L=e.state.lastFragranceEdit,N=L&&L.row===x?L.field:null;t>0&&(N==="percent"?(C=t*(_/100),G.value=C>0?y(h(C),2):""):N==="grams"?(_=C/t*100,U.value=_>0?y(_,2):""):C>0?(_=C/t*100,document.activeElement!==U&&(U.value=y(_,2))):_>0&&(C=t*(_/100),document.activeElement!==G&&(G.value=y(h(C),2)))),C>0&&(g+=C),b+=_});let R=document.getElementById("fragrancePercentTotal");R&&(R.textContent=y(b,2));let A=document.getElementById("fragranceTotalComputed");return A&&(A.textContent=g>0?$(g):"--"),{totalGrams:g,totalPct:b}}function v(){let E=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(c=>{var G,U,f,T,C,_,L;let t=((U=(G=c.querySelector(".fragrance-typeahead"))==null?void 0:G.value)==null?void 0:U.trim())||"",g=((f=c.querySelector(".fragrance-grams"))==null?void 0:f.value)||"",b=((T=c.querySelector(".fragrance-percent"))==null?void 0:T.value)||"",R=((C=c.querySelector(".fragrance-gi-id"))==null?void 0:C.value)||"",A=((_=c.querySelector(".fragrance-default-unit"))==null?void 0:_.value)||"",x=((L=c.querySelector(".fragrance-category"))==null?void 0:L.value)||"";!t&&!g&&!b&&!R||E.push({name:t,grams:g,percent:b,gi:R,defaultUnit:A,categoryName:x})}),E}function I(E){let c=document.getElementById("soapVisualGuidanceList");if(!c)return;let t=Array.isArray(E==null?void 0:E.tips)&&E.tips.length?E.tips:["No visual flags detected for this formula."];c.innerHTML=t.map(g=>`<li>${g}</li>`).join("")}function p(E){return!E||typeof E!="object"?null:E.ingredient&&E.ingredient.ingredient_category_name||E.ingredient_category_name||E.ingredient_category&&E.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:m,collectAdditiveSettings:i,syncAdditivePair:n,applyComputedOutputs:o,updateAdditivesOutput:u,updateVisualGuidance:I},e.fragrances={buildFragranceRow:l,updateFragranceTotals:S,collectFragranceData:v}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:r}=e.helpers,{STAGE_CONFIGS:y}=e.constants;function w(h){var m;let q=y[h];if(!q)return;let O=document.getElementById(q.tabId);if(O){if((m=B.bootstrap)!=null&&m.Tab)bootstrap.Tab.getOrCreateInstance(O).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(i=>{i.classList.remove("show","active")}),O.classList.add("active"),O.setAttribute("aria-selected","true");let P=document.getElementById(q.paneId);P&&P.classList.add("show","active")}e.layout.scheduleStageHeightSync(),O.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function H(h){var q,O;if(h===1){let m=document.getElementById("unitGrams");m&&(m.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let P=document.getElementById("moldCylinderCorrection");P&&(P.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(q=e.mold)!=null&&q.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(h===2){let m=document.getElementById("oilRows");m&&(m.innerHTML="",m.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(h===3){let m=document.getElementById("lyeTypeNaoh");m&&(m.checked=!0);let P=document.getElementById("waterMethod");P&&(P.value="percent");let i=document.getElementById("lyeSuperfat");i&&(i.value="5");let d=document.getElementById("lyePurity");d&&(d.value="100");let s=document.getElementById("waterPct");s&&(s.value="33");let n=document.getElementById("lyeConcentration");n&&(n.value="33");let o=document.getElementById("waterRatio");o&&(o.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(h===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(m=>{let P=document.getElementById(m);P&&(P.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(m=>{let P=document.getElementById(m);P&&(P.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),h===5){let m=document.getElementById("fragranceRows");m&&(m.innerHTML="",(O=e.fragrances)!=null&&O.buildFragranceRow&&m.appendChild(e.fragrances.buildFragranceRow()));let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent="0");let i=document.getElementById("fragranceTotalComputed");i&&(i.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),M()}function $(h){var q;if(h===1){let O=r(document.getElementById("moldWaterWeight").value),m=r(document.getElementById("oilTotalTarget").value),P=r(document.getElementById("moldOilPct").value),d=!!document.querySelector('input[name="weight_unit"]:checked')&&(O>0||m>0)&&P>0;return{state:d?"complete":"incomplete",label:d?"Sized":"Needs target"}}if(h===2){let m=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(P=>{var n,o,u,a;let i=(o=(n=P.querySelector(".oil-typeahead"))==null?void 0:n.value)==null?void 0:o.trim(),d=r((u=P.querySelector(".oil-grams"))==null?void 0:u.value),s=r((a=P.querySelector(".oil-percent"))==null?void 0:a.value);return i&&(d>0||s>0)});return{state:m?"complete":"incomplete",label:m?"Oils added":"Add oils"}}if(h===3){let O=r(document.getElementById("lyeSuperfat").value),m=(q=document.getElementById("waterMethod"))==null?void 0:q.value,i=!!document.querySelector('input[name="lye_type"]:checked')&&!!m&&O>=0;return{state:i?"complete":"incomplete",label:i?"Configured":"Set lye"}}return h===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(m=>r(document.getElementById(m).value)>0)?"Added":"Optional"}:h===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(P=>{var n,o,u,a;let i=(o=(n=P.querySelector(".fragrance-typeahead"))==null?void 0:n.value)==null?void 0:o.trim(),d=r((u=P.querySelector(".fragrance-grams"))==null?void 0:u.value),s=r((a=P.querySelector(".fragrance-percent"))==null?void 0:a.value);return i||d>0||s>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function M(){let h=document.getElementById("soapStageTabList");h&&h.querySelectorAll(".soap-stage-status").forEach(O=>O.remove());let q=document.getElementById("soapStageProgress");q&&(q.textContent="")}e.stages={openStageByIndex:w,resetStage:H,updateStageStatuses:M}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w}=e.helpers,{computeFattyAcids:H,computeQualities:$,computeOilQualityScores:M}=e.calc,{QUALITY_RANGES:h,QUALITY_HINTS:q,QUALITY_FEEL_HINTS:O,IODINE_RANGE:m,IODINE_SCALE_MAX:P,INS_RANGE:i,INS_SCALE_MAX:d,QUALITY_BASE:s,QUALITY_PRESETS:n,FATTY_BAR_COLORS:o,FATTY_DISPLAY_KEYS:u}=e.constants,{pulseValue:a,showSoapAlert:l}=e.ui;function S({barId:x,fillId:G,value:U,max:f,label:T}){let C=document.getElementById(x),_=document.getElementById(G);if(!C||!_)return null;let L=isFinite(U)?U:0,N=Math.max(0,Math.min(f,L)),K=f>0?N/f*100:0;return _.style.width=`${K}%`,C.setAttribute("aria-valuemin","0"),C.setAttribute("aria-valuemax",String(f)),C.setAttribute("aria-valuenow",N.toFixed(1)),T&&C.setAttribute("aria-label",T),{bar:C,fill:_,value:L}}function v(x,G,U){if(!(!x||!U)){if(x.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(G)){x.classList.add("bg-secondary");return}G<U[0]?x.classList.add("bg-warning"):G>U[1]?x.classList.add("bg-danger"):x.classList.add("bg-success")}}function I(x,G,U,f,T,C){let _=S({barId:x,fillId:G,value:U,max:T,label:C});_&&v(_.fill,U,f)}function p(){let x={hardness:{range:h.hardness,scale:100},cleansing:{range:h.cleansing,scale:100},conditioning:{range:h.conditioning,scale:100},bubbly:{range:h.bubbly,scale:100},creamy:{range:h.creamy,scale:100},iodine:{range:m,scale:P},ins:{range:i,scale:d}};Object.entries(x).forEach(([G,U])=>{let[f,T]=U.range,C=U.scale,_=G.charAt(0).toUpperCase()+G.slice(1),L=G==="iodine"?"iodineBar":G==="ins"?"insBar":`quality${_}Bar`,N=document.getElementById(`quality${_}Safe`);if(N){let j=Math.max(0,Math.min(100,f/C*100)),F=Math.max(0,Math.min(100,(T-f)/C*100));N.style.left=`${j}%`,N.style.width=`${F}%`,N.title=`Safe range ${r(f,0)}-${r(T,0)}`}let K=document.getElementById(L);K&&(K.dataset.safeRange=`${r(f,0)}-${r(T,0)}`);let Y=document.getElementById(`quality${_}RangeMin`),D=document.getElementById(`quality${_}RangeMax`);Y&&(Y.textContent=r(f,0)),D&&(D.textContent=r(T,0))})}function E(x,G){let U=w(x.hardness||0,0,100),f=w(x.bubbly||0,0,100),T=w(x.conditioning||0,0,100),C=w(T+(G||0)*3,0,100),_=document.getElementById("feelHardness"),L=document.getElementById("feelBubbly"),N=document.getElementById("feelConditioning"),K=document.getElementById("feelGreasy");_&&(_.value=r(U,1)),L&&(L.value=r(f,1)),N&&(N.value=r(T,1)),K&&(K.value=r(C,1))}function c(x){u.forEach(G=>{let U=document.getElementById(`fattyBar${G.charAt(0).toUpperCase()}${G.slice(1)}`);if(!U)return;let f=w(y(x[G]),0,100),T=f;U.style.width=`${T}%`,U.style.backgroundColor=o[G]||"var(--color-muted)",U.title=`${G.charAt(0).toUpperCase()}${G.slice(1)}: ${r(f,1)}%`})}function t(){var f;let x=((f=document.getElementById("qualityPreset"))==null?void 0:f.value)||"balanced",G=Array.from(document.querySelectorAll(".quality-focus:checked"));if(x==="none"&&!G.length)return null;let U=x==="none"?{...s}:n[x]?{...n[x]}:{...s};return G.forEach(T=>{let C=T.dataset.attr,_=T.dataset.direction,L=h[C];L&&(U[C]=_==="low"?L[0]:L[1])}),U}function g(){let x=t(),G={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(G).forEach(([U,f])=>{if(!f)return;let T=document.getElementById(`${f.id}Label`);if(!x){f.classList.add("d-none"),T&&(T.textContent="");return}let C=y(x[U]);if(!isFinite(C)){f.classList.add("d-none"),T&&(T.textContent="");return}let _=U==="iodine"?P:U==="ins"?d:100,L=w(C,0,_);f.classList.remove("d-none"),f.style.left=`${L/_*100}%`,f.setAttribute("aria-label",`Apply ${U} target`),f.setAttribute("role","button"),f.setAttribute("tabindex","0"),f.title=`Target ${U}: ${r(C,1)}`,T&&(T.textContent=r(C,1))})}function b(){let x=t();if(!x){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let U=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(F=>{var te,ie;let Q=e.units.toGrams((te=F.querySelector(".oil-grams"))==null?void 0:te.value),z=((ie=F.querySelector(".oil-fatty"))==null?void 0:ie.value)||"",X=null;if(z)try{X=JSON.parse(z)}catch{X=null}return{row:F,grams:Q,fattyProfile:X}}).filter(F=>F.grams>0);if(!U.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let f=H(U.map(F=>({grams:F.grams,fattyProfile:F.fattyProfile}))),T=$(f.percent),C={hardness:w((x.hardness-T.hardness)/100,-1,1),cleansing:w((x.cleansing-T.cleansing)/100,-1,1),conditioning:w((x.conditioning-T.conditioning)/100,-1,1),bubbly:w((x.bubbly-T.bubbly)/100,-1,1),creamy:w((x.creamy-T.creamy)/100,-1,1)},_=U.reduce((F,Q)=>F+Q.grams,0),L=[],N=0,K=.8,Y=U.filter(F=>!F.fattyProfile||typeof F.fattyProfile!="object").length;if(Y===U.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(Y&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),U.forEach(F=>{let Q=M(F.fattyProfile),z=C.hardness*Q.hardness+C.cleansing*Q.cleansing+C.conditioning*Q.conditioning+C.bubbly*Q.bubbly+C.creamy*Q.creamy,X=w(1+z*K,.2,1.8),te=F.grams*X;L.push({row:F.row,grams:te}),N+=te}),N<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let D=_/N,j=e.oils.getOilTargetGrams()||_;L.forEach(F=>{let Q=F.grams*D,z=F.row.querySelector(".oil-grams"),X=F.row.querySelector(".oil-percent");if(z&&(z.value=Q>0?r(e.units.fromGrams(Q),2):""),X&&j>0){let te=Q/j*100;X.value=te>0?r(te,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function R(x){let{qualities:G,fattyPercent:U,coveragePct:f,iodine:T,ins:C,sapAvg:_,superfat:L,warnings:N}=x,K=f>0;function Y(ae,ee){var W,V;let re=document.getElementById(`quality${ae}Value`),ue=document.getElementById(`quality${ae}Hint`);if(!re)return;re.textContent=K&&isFinite(ee)?r(ee,1):"--",a(re);let me=ae.toLowerCase(),de=h[me],k=S({barId:`quality${ae}Bar`,fillId:`quality${ae}Fill`,value:K?ee:0,max:100,label:ae});k&&de&&(v(k.fill,ee,de),K&&isFinite(ee)?k.bar.title=`${ae}: ${r(ee,1)} (safe ${de[0]}-${de[1]}). ${q[me]||""}`.trim():k.bar.title=`${ae}: -- (safe ${de[0]}-${de[1]}). ${q[me]||""}`.trim()),ue&&de&&(!K||!isFinite(ee)?ue.textContent="":ee<de[0]?ue.textContent=((W=O[me])==null?void 0:W.low)||"":ee>de[1]?ue.textContent=((V=O[me])==null?void 0:V.high)||"":ue.textContent="")}Y("Hardness",G.hardness),Y("Cleansing",G.cleansing),Y("Conditioning",G.conditioning),Y("Bubbly",G.bubbly),Y("Creamy",G.creamy);let D=document.getElementById("fattyCoverageNote");D&&(D.textContent=f>0?`Fatty acid coverage: ${r(f,1)}% of oils`:"Fatty acid coverage: not enough data yet");let j=document.getElementById("iodineValue"),F=document.getElementById("insValue"),Q=document.getElementById("sapAvgValue");j&&(j.textContent=T>0?r(T,1):"--",a(j)),F&&(F.textContent=C>0?r(C,1):"--",a(F)),Q&&(Q.textContent=_>0?r(_,1):"--",a(Q)),I("iodineBar","iodineFill",T,m,P,"Iodine"),I("insBar","insFill",C,i,d,"INS");let z=(U.lauric||0)+(U.myristic||0)+(U.palmitic||0)+(U.stearic||0),X=(U.ricinoleic||0)+(U.oleic||0)+(U.linoleic||0)+(U.linolenic||0),te=document.getElementById("fattySatRatioResult");te&&(te.textContent=z+X>0?`${r(z,0)}:${r(X,0)}`:"--",a(te)),u.forEach(ae=>{let ee=`fatty${ae.charAt(0).toUpperCase()}${ae.slice(1)}`,re=U[ae];document.getElementById(ee).textContent=K&&re?`${r(re,1)}%`:"--"}),E(G,L||0),c(U),g();let ie=Array.isArray(N)?N.slice():[],le=document.getElementById("soapQualityWarnings");ie.length?(le.classList.remove("d-none"),le.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${ie.map(ae=>`<li>${ae}</li>`).join("")}</ul>`):(le.classList.add("d-none"),le.textContent=""),e.layout.scheduleStageHeightSync()}function A(){var x;document.querySelectorAll(".soap-quality-help").forEach(G=>{let U=G.dataset.quality;q[U]&&G.setAttribute("title",q[U])}),(x=B.bootstrap)!=null&&x.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(G=>{bootstrap.Tooltip.getOrCreateInstance(G)})}e.quality={setQualityRangeBars:p,updateQualityTargets:g,applyQualityTargets:b,updateQualitiesDisplay:R,initQualityTooltips:A}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w}=e.helpers;function H(i){let d=0,s=0;return(i||[]).forEach(n=>{let o=y(n==null?void 0:n.sapKoh),u=y(n==null?void 0:n.grams);o>0&&u>0&&(d+=o*u,s+=u)}),s>0?d/s:0}function $(i){var S,v,I,p,E,c,t,g,b,R,A,x;let d=i.qualityReport||{},s=d.fatty_acids_pct||{},n=d.qualities||{},o=isFinite(i.sapAvg)&&i.sapAvg>0?i.sapAvg:y(d.sap_avg_koh)||H(i.oils||[]),u=y(d.iodine),a=y(d.ins)||(o&&u?o-u:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((S=document.getElementById("qualityPreset"))==null?void 0:S.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(G=>G.id),mold:l,oils:(i.oils||[]).map(G=>({name:G.name||null,grams:r(G.grams||0,2),iodine:G.iodine||null,sap_koh:G.sapKoh||null,fatty_profile:G.fattyProfile||null,global_item_id:G.global_item_id||null,default_unit:G.default_unit||null,ingredient_category_name:G.ingredient_category_name||null})),totals:{total_oils_g:r(i.totalOils||0,2),batch_yield_g:r(i.batchYield||0,2),lye_pure_g:r(i.lyePure||0,2),lye_adjusted_g:r(i.lyeAdjusted||0,2),water_g:r(i.water||0,2)},lye:{lye_type:i.lyeType,superfat:i.superfat,purity:i.purity,water_method:i.waterMethod,water_pct:i.waterPct,lye_concentration:i.lyeConcentration,water_ratio:i.waterRatio},additives:{fragrance_pct:((v=i.additives)==null?void 0:v.fragrancePct)||0,lactate_pct:((I=i.additives)==null?void 0:I.lactatePct)||0,sugar_pct:((p=i.additives)==null?void 0:p.sugarPct)||0,salt_pct:((E=i.additives)==null?void 0:E.saltPct)||0,citric_pct:((c=i.additives)==null?void 0:c.citricPct)||0,fragrance_g:r(((t=i.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:r(((g=i.additives)==null?void 0:g.lactateG)||0,2),sugar_g:r(((b=i.additives)==null?void 0:b.sugarG)||0,2),salt_g:r(((R=i.additives)==null?void 0:R.saltG)||0,2),citric_g:r(((A=i.additives)==null?void 0:A.citricG)||0,2),citric_lye_g:r(((x=i.additives)==null?void 0:x.citricLyeG)||0,2)},qualities:{hardness:r(n.hardness||0,1),cleansing:r(n.cleansing||0,1),conditioning:r(n.conditioning||0,1),bubbly:r(n.bubbly||0,1),creamy:r(n.creamy||0,1),iodine:r(u||0,1),ins:r(a||0,1),sap_avg:r(o||0,1)},fatty_acids:s,updated_at:new Date().toISOString()}}function M(i,d,s,n,o){var v,I,p,E,c;let u=(I=(v=document.getElementById(i))==null?void 0:v.value)==null?void 0:I.trim(),a=((p=document.getElementById(d))==null?void 0:p.value)||"",l=n&&((E=document.getElementById(n))==null?void 0:E.value)||"",S=o&&((c=document.getElementById(o))==null?void 0:c.value)||"";return{name:u||s,globalItemId:a?parseInt(a):void 0,defaultUnit:l||void 0,categoryName:S||void 0}}function h(i){let d=[],s=w(i||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var E,c,t,g,b,R,A;let o=(c=(E=n.querySelector(".fragrance-typeahead"))==null?void 0:E.value)==null?void 0:c.trim(),u=((t=n.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",a=((g=n.querySelector(".fragrance-default-unit"))==null?void 0:g.value)||"",l=((b=n.querySelector(".fragrance-category"))==null?void 0:b.value)||"",S=(R=n.querySelector(".fragrance-grams"))==null?void 0:R.value,v=(A=n.querySelector(".fragrance-percent"))==null?void 0:A.value,I=e.units.toGrams(S),p=w(y(v),0);I<=0&&p>0&&s>0&&(I=s*(p/100)),!(!o&&!u&&I<=0)&&d.push({name:o||"Fragrance/Essential Oils",globalItemId:u?parseInt(u):void 0,defaultUnit:a||void 0,categoryName:l||void 0,grams:I,pct:p})}),d}function q(i,d){let s=[];return document.querySelectorAll(`#${i} .row`).forEach(function(n){var v,I,p;let o=(I=(v=n.querySelector(".tool-typeahead"))==null?void 0:v.value)==null?void 0:I.trim(),u=((p=n.querySelector(".tool-gi-id"))==null?void 0:p.value)||"",a=n.querySelector(".tool-qty"),l=n.querySelector(".tool-unit"),S=a&&a.value!=="";!o&&!u||(d==="container"?s.push({name:o||void 0,global_item_id:u?parseInt(u):void 0,quantity:S?parseFloat(a.value):1}):s.push({name:o||void 0,global_item_id:u?parseInt(u):void 0,quantity:S?parseFloat(a.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),s}function O(i){let d=e.config.isAuthenticated?"member":"public",s=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(i,{context:d,mode:s,unitOptionsHtml:e.config.unitOptionsHtml})}function m(i,d){let s=O(i),n=s.querySelector(".tool-typeahead"),o=s.querySelector(".tool-qty");n&&(n.value=d),o&&i==="container"&&(o.value=1),i==="container"?document.getElementById("tool-containers").appendChild(s):i==="consumable"?document.getElementById("tool-consumables").appendChild(s):document.getElementById("tool-ingredients").appendChild(s)}function P(i){var u,a,l,S;let d=$(i),s=(i.oils||[]).map(v=>({name:v.name||void 0,global_item_id:v.global_item_id||void 0,quantity:v.grams,unit:"gram",default_unit:v.default_unit||void 0,ingredient_category_name:v.ingredient_category_name||void 0})),n=i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(i.lyeAdjusted>0&&s.push({name:n,quantity:r(i.lyeAdjusted,2),unit:"gram"}),i.water>0&&s.push({name:"Distilled Water",quantity:r(i.water,2),unit:"gram"}),h(i.totalOils||0).forEach(v=>{v.grams>0&&s.push({name:v.name,global_item_id:v.globalItemId,quantity:r(v.grams,2),unit:"gram",default_unit:v.defaultUnit,ingredient_category_name:v.categoryName})}),((u=i.additives)==null?void 0:u.lactateG)>0){let v=M("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");s.push({name:v.name,global_item_id:v.globalItemId,quantity:r(i.additives.lactateG,2),unit:"gram",default_unit:v.defaultUnit,ingredient_category_name:v.categoryName})}if(((a=i.additives)==null?void 0:a.sugarG)>0){let v=M("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");s.push({name:v.name,global_item_id:v.globalItemId,quantity:r(i.additives.sugarG,2),unit:"gram",default_unit:v.defaultUnit,ingredient_category_name:v.categoryName})}if(((l=i.additives)==null?void 0:l.saltG)>0){let v=M("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");s.push({name:v.name,global_item_id:v.globalItemId,quantity:r(i.additives.saltG,2),unit:"gram",default_unit:v.defaultUnit,ingredient_category_name:v.categoryName})}if(((S=i.additives)==null?void 0:S.citricG)>0){let v=M("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");s.push({name:v.name,global_item_id:v.globalItemId,quantity:r(i.additives.citricG,2),unit:"gram",default_unit:v.defaultUnit,ingredient_category_name:v.categoryName}),s.push({name:"Extra Lye for Citric Acid",quantity:r(i.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((i.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:i.superfat,soap_lye_type:i.lyeType,soap_lye_purity:i.purity,soap_water_method:i.waterMethod,soap_water_pct:i.waterPct,soap_lye_concentration:i.lyeConcentration,soap_water_ratio:i.waterRatio,soap_oils_total_g:i.totalOils,soap_lye_g:i.lyeAdjusted,soap_water_g:i.water},ingredients:s.concat(q("tool-ingredients","ingredient")),consumables:q("tool-consumables","consumable"),containers:q("tool-containers","container"),notes:JSON.stringify(d)}}e.recipePayload={collectFragranceRows:h,collectDraftLines:q,buildLineRow:O,addStubLine:m,buildSoapRecipePayload:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w}=e.helpers,{formatWeight:H,formatPercent:$}=e.units;function M(){var S;let n=((S=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:S.value)||"NaOH",o=document.getElementById("lyePurity"),u=o==null?void 0:o.value,a=y(o==null?void 0:o.value),l=n==="NaOH"?"NaOH":"KOH";return(u===""||u===null||u===void 0||!isFinite(a))&&(a=100),{selected:n,lyeType:l,purity:a}}function h(){let n=document.getElementById("lyePurity"),o=M();if(n)if(n.removeAttribute("readonly"),o.selected==="KOH90"){let u=document.getElementById("lyePurityHint");u&&(u.textContent="90% KOH selected. Safe default purity is 90%.")}else{let u=document.getElementById("lyePurityHint");u&&(u.textContent="Safe default is 100%.")}}function q(n){return n==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":n==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function O(n=null,o=null){var S;let u=document.getElementById("stageWaterOutput"),a=document.getElementById("stageWaterComputedHint"),l=o||(n==null?void 0:n.waterMethod)||((S=document.getElementById("waterMethod"))==null?void 0:S.value)||"percent";if(u){let v=n&&isFinite(n.waterG)&&n.waterG>0;u.textContent=v?H(n.waterG):"--"}if(a){if(!n||!isFinite(n.totalOils)||n.totalOils<=0){a.textContent=`Set oils in Stage 2 to calculate water. ${q(l)}`;return}if(l==="concentration"){let v=n.lyeConcentrationInput||n.lyeConcentration||0;a.textContent=`Using ${r(v,1)}% lye concentration from ${H(n.lyeAdjusted||0)} lye.`;return}if(l==="ratio"){let v=n.waterRatioInput||n.waterRatio||0;a.textContent=`Using ${r(v,2)} : 1 water-to-lye ratio from ${H(n.lyeAdjusted||0)} lye.`;return}a.textContent=`Using ${r(n.waterPct||0,1)}% of total oils (${H(n.totalOils)}).`}}function m(n=null,o=null){var R;let u=document.getElementById("lyeWaterPreviewAnchor"),a=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),S=document.getElementById("concPreview"),v=document.getElementById("ratioPreview");if(!u&&!a&&!l&&!S&&!v)return;let I=(A,x)=>{A&&(A.textContent=x)},p=o||(n==null?void 0:n.waterMethod)||((R=document.getElementById("waterMethod"))==null?void 0:R.value)||"percent",E=y(n==null?void 0:n.totalOils),c=y(n==null?void 0:n.lyeAdjusted),t=y(n==null?void 0:n.waterG);if(E<=0||c<=0){I(u,"Based on -- oils. All values update live as you change inputs."),I(a,"--"),I(l,"--"),I(S,"--"),I(v,"--");return}let g=y(n==null?void 0:n.lyeConcentration)>0?y(n==null?void 0:n.lyeConcentration):c+t>0?c/(c+t)*100:0,b=y(n==null?void 0:n.waterRatio)>0?y(n==null?void 0:n.waterRatio):c>0?t/c:0;if(I(u,`Based on ${H(E)} oils. All values update live as you change inputs.`),I(a,H(c)),I(l,H(t)),I(S,g>0?$(g):"--"),I(v,b>0?`${r(b,2)} : 1`:"--"),p==="concentration"){let A=y(n==null?void 0:n.lyeConcentrationInput);A>0&&I(S,$(A))}if(p==="ratio"){let A=y(n==null?void 0:n.waterRatioInput);A>0&&I(v,`${r(A,2)} : 1`)}}function P(){var o;let n=((o=document.getElementById("waterMethod"))==null?void 0:o.value)||"percent";document.querySelectorAll(".water-input").forEach(u=>{u.classList.toggle("d-none",u.dataset.method!==n)}),O(null,n),m(null,n)}function i(){let n=e.oils.updateOilTotals(),o=n.totalWeight,u=n.totalPct,a=[],l=e.oils.collectOilData(),S=e.oils.getOilTargetGrams(),I=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(p=>w(y(p.value),0)).some(p=>p>0);return(!l.length||o<=0)&&a.push("Add at least one oil with a weight or percent."),!S&&o<=0&&I&&a.push("Enter a total oils target or weights to convert percentages."),S>0&&u>0&&Math.abs(u-100)>.5&&a.push("Oil percentages should total 100% (use Normalize to fix)."),S>0&&o>S+.01?a.push("Oil weights exceed the mold target."):!S&&u>100.01&&a.push("Oil percentages exceed 100%."),{ok:a.length===0,errors:a,totals:n,oils:l}}function d(){let n=document.getElementById("lyeSuperfat"),o=n==null?void 0:n.value,u=y(o);return(o===""||o===null||o===void 0||!isFinite(u))&&(u=5),u}function s(){var v,I,p,E;let o=M().purity;isFinite(o)||(o=100);let u=((v=document.getElementById("waterMethod"))==null?void 0:v.value)||"percent",a=y((I=document.getElementById("waterPct"))==null?void 0:I.value),l=y((p=document.getElementById("lyeConcentration"))==null?void 0:p.value),S=y((E=document.getElementById("waterRatio"))==null?void 0:E.value);return{purity:o,waterMethod:u,waterPct:a,lyeConcentration:l,waterRatio:S}}e.runnerInputs={getLyeSelection:M,applyLyeSelection:h,setWaterMethod:P,updateStageWaterSummary:O,updateLiveCalculationPreview:m,validateCalculation:i,readSuperfatInput:d,sanitizeLyeInputs:s}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{getStorage:r}=e.helpers;function y(){if(!e.config.calcLimit)return{count:0,date:null};let h=r();if(!h)return{count:0,date:null};try{let q=h.getItem("soap_calc_usage"),O=new Date().toISOString().slice(0,10);if(!q)return{count:0,date:O};let m=JSON.parse(q);return!m||m.date!==O?{count:0,date:O}:{count:Number(m.count)||0,date:O}}catch{return{count:0,date:null}}}function w(h){if(!e.config.calcLimit)return;let q=r();if(!q)return;let O=new Date().toISOString().slice(0,10);try{q.setItem("soap_calc_usage",JSON.stringify({count:h,date:O}))}catch{}}function H(){return e.config.calcLimit&&y().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function $(){if(!e.config.calcLimit)return;let q=y().count+1;w(q);let O=Math.max(0,e.config.calcLimit-q);O<=1&&e.ui.showSoapAlert("info",`You have ${O} calculation${O===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function M(h){if(!e.config.calcLimit||h===null||h>1)return;let q=document.getElementById("soapSignupModal");q&&(B.bootstrap&&B.bootstrap.Modal?B.bootstrap.Modal.getOrCreateInstance(q).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:H,consumeCalcQuota:$,maybeShowSignupModal:M}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.state;function y({oils:H,selection:$,superfat:M,purity:h,waterMethod:q,waterPct:O,lyeConcentration:m,waterRatio:P,totalOils:i}){let d=e.additives.collectAdditiveSettings(),s=e.recipePayload.collectFragranceRows(i||0);return{oils:(H||[]).map(n=>({name:n.name||null,grams:n.grams||0,sap_koh:n.sapKoh||0,iodine:n.iodine||0,fatty_profile:n.fattyProfile||null,global_item_id:n.global_item_id||null,default_unit:n.default_unit||null,ingredient_category_name:n.ingredient_category_name||null})),fragrances:s.map(n=>({name:n.name||"Fragrance/Essential Oils",grams:n.grams||0,pct:n.pct||0})),additives:{lactate_pct:d.lactatePct||0,sugar_pct:d.sugarPct||0,salt_pct:d.saltPct||0,citric_pct:d.citricPct||0,lactate_name:d.lactateName||"Sodium Lactate",sugar_name:d.sugarName||"Sugar",salt_name:d.saltName||"Salt",citric_name:d.citricName||"Citric Acid"},lye:{selected:($==null?void 0:$.selected)||"NaOH",superfat:M,purity:h},water:{method:q,water_pct:O,lye_concentration:m,water_ratio:P},meta:{unit_display:r.currentUnit||"g"}}}async function w(H){var q;let $=((q=document.querySelector('meta[name="csrf-token"]'))==null?void 0:q.getAttribute("content"))||"",M=new AbortController,h=B.setTimeout(()=>M.abort(),2500);try{let O=await fetch("/tools/api/soap/calculate",{method:"POST",signal:M.signal,headers:{"Content-Type":"application/json",...$?{"X-CSRFToken":$}:{}},body:JSON.stringify(H||{})});if(!O.ok)return null;let m=await O.json();return!m||m.success!==!0||typeof m.result!="object"?null:m.result}catch{return null}finally{B.clearTimeout(h)}}e.runnerService={buildServicePayload:y,calculateWithSoapService:w}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y}=e.helpers,{formatWeight:w,formatPercent:H}=e.units,$=e.state,M={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function h(i){return(i||[]).map(d=>{var s;return{name:d.name||null,grams:y(d.grams),sapKoh:y((s=d.sap_koh)!=null?s:d.sapKoh),iodine:y(d.iodine),fattyProfile:d.fatty_profile||d.fattyProfile||null,global_item_id:d.global_item_id||null,default_unit:d.default_unit||null,ingredient_category_name:d.ingredient_category_name||null}})}function q(i,d){let s=document.getElementById(i);s&&(s.textContent=d)}function O({resultsCard:i,lyeAdjusted:d,waterData:s,batchYield:n,totalOils:o,superfat:u}){let a=document.getElementById("resultsCard");a&&(a.style.display="block");let l=y(i.water_lye_ratio)||s.waterRatio;q("lyeAdjustedOutput",w(y(i.lye_adjusted_g)||d)),q("waterOutput",w(y(i.water_g)||s.waterG)),q("batchYieldOutput",w(n)),q("lyeConcentrationOutput",H(y(i.lye_concentration_pct)||s.lyeConcentration)),q("waterRatioOutput",isFinite(l)&&l>0?r(l,2).toString():"--"),q("totalOilsOutput",w(o)),q("superfatOutput",H(u)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(S=>e.ui.pulseValue(document.getElementById(S)))}function m({showAlerts:i,lyeTotals:d,purity:s,waterData:n}){if(!i)return;d.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),s<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${r(s,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(n.lyeConcentration<25||n.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let o=e.mold.getMoldSettings();o.shape==="cylinder"&&o.waterWeight>0&&!o.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function P({serviceResult:i,validation:d,selection:s,superfat:n,purity:o,waterMethod:u,waterPct:a,lyeConcentrationInput:l,waterRatioInput:S,showAlerts:v}){var F;let I=i.lye_type||s.lyeType||"NaOH",p=i.lye_selected||s.selected||null,E=y(i.total_oils_g)||d.totals.totalWeight,c=y(i.superfat_pct),t=isFinite(c)?c:n,g={sapAvg:y(i.sap_avg_koh),usedFallback:!!i.used_sap_fallback},b=y(i.lye_pure_g),A=Object.prototype.hasOwnProperty.call(i,"lye_adjusted_base_g")?y(i.lye_adjusted_base_g):null,x=y(i.lye_adjusted_g),G=y(i.lye_purity_pct)||o,U=i.water_method||u,f=y(i.water_pct)||a,T=y(i.lye_concentration_input_pct)||l,C=y(i.water_ratio_input)||S,_={waterG:y(i.water_g),lyeConcentration:y(i.lye_concentration_pct),waterRatio:y(i.water_lye_ratio)},L=i.results_card||{},N=i.quality_report||{},K=h(i.oils||d.oils),Y={waterG:_.waterG,lyeAdjusted:x,totalOils:E,waterMethod:U,waterPct:f,lyeConcentrationInput:T,waterRatioInput:C,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio};e.runnerInputs.updateStageWaterSummary(Y),e.runnerInputs.updateLiveCalculationPreview(Y);let D=i.additives||M;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(D);let j=y(L.batch_yield_g)||E+x+_.waterG+D.fragranceG+D.lactateG+D.sugarG+D.saltG+D.citricG;return(F=e.mold)!=null&&F.updateWetBatterWarning&&e.mold.updateWetBatterWarning(j),O({resultsCard:L,lyeAdjusted:x,waterData:_,batchYield:j,totalOils:E,superfat:t}),e.ui.updateResultsWarnings(_),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:N.qualities||{},fattyPercent:N.fatty_acids_pct||{},coveragePct:y(N.coverage_pct),iodine:y(N.iodine),ins:y(N.ins),sapAvg:g.sapAvg,superfat:t,waterData:_,additives:D,oils:K,totalOils:E,warnings:N.warnings||[]}),e.additives.updateVisualGuidance({tips:N.visual_guidance||[]}),e.stages.updateStageStatuses(),m({showAlerts:v,lyeTotals:g,purity:G,waterData:_}),$.lastCalc={totalOils:E,oils:K,lyeType:I,lyeSelected:p,superfat:t,purity:G,lyePure:b,lyeAdjustedBase:A,lyeAdjusted:x,water:_.waterG,waterMethod:U,waterPct:f,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio,sapAvg:g.sapAvg,usedSapFallback:g.usedFallback,additives:D,batchYield:j,qualityReport:N,export:i.export||null},$.lastCalc}e.runnerRender={applyServiceResult:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.state,y=e.runnerInputs,w=e.runnerQuota,H=e.runnerService,$=e.runnerRender;async function M(h={}){var O;let q={consumeQuota:!1,showAlerts:!0,...h};try{q.showAlerts&&e.ui.clearSoapAlerts();let m=y.validateCalculation();if(!m.ok)return y.updateStageWaterSummary(null),y.updateLiveCalculationPreview(null),(O=e.mold)!=null&&O.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),q.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${m.errors.map(a=>`<li>${a}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(q.consumeQuota&&!w.canConsumeCalcQuota())return null;let P=y.readSuperfatInput(),i=y.getLyeSelection(),d=y.sanitizeLyeInputs(),s=(r.calcRequestSeq||0)+1;r.calcRequestSeq=s;let n=H.buildServicePayload({oils:m.oils,selection:i,superfat:P,purity:d.purity,waterMethod:d.waterMethod,waterPct:d.waterPct,lyeConcentration:d.lyeConcentration,waterRatio:d.waterRatio,totalOils:m.totals.totalWeight}),o=await H.calculateWithSoapService(n);if(s!==r.calcRequestSeq)return r.lastCalc;if(!o)return q.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let u=$.applyServiceResult({serviceResult:o,validation:m,selection:i,superfat:P,purity:d.purity,waterMethod:d.waterMethod,waterPct:d.waterPct,lyeConcentrationInput:d.lyeConcentration,waterRatioInput:d.waterRatio,showAlerts:q.showAlerts});return q.consumeQuota&&w.consumeCalcQuota(),u}catch{return q.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...h)=>y.getLyeSelection(...h),applyLyeSelection:(...h)=>y.applyLyeSelection(...h),setWaterMethod:(...h)=>y.setWaterMethod(...h),updateLiveCalculationPreview:(...h)=>y.updateLiveCalculationPreview(...h),calculateAll:M,buildSoapRecipePayload:(...h)=>e.recipePayload.buildSoapRecipePayload(...h),buildLineRow:(...h)=>e.recipePayload.buildLineRow(...h),addStubLine:(...h)=>e.recipePayload.addStubLine(...h),maybeShowSignupModal:(...h)=>w.maybeShowSignupModal(...h)}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{formatTime:r,getStorage:y}=e.helpers,w="soap_tool_state_v2";function H(s,n){let o=[];return document.querySelectorAll(`#${s} .row`).forEach(a=>{var E,c,t;let l=(c=(E=a.querySelector(".tool-typeahead"))==null?void 0:E.value)==null?void 0:c.trim(),S=((t=a.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",v=a.querySelector(".tool-qty"),I=a.querySelector(".tool-unit"),p=v&&v.value!==""?e.helpers.toNumber(v.value):null;!l&&!S||(n==="container"?o.push({name:l||"",global_item_id:S?parseInt(S):null,quantity:p&&p>0?p:1}):o.push({name:l||"",global_item_id:S?parseInt(S):null,quantity:p&&p>=0?p:0,unit:(I==null?void 0:I.value)||"gram"}))}),o}function $(){let s=[];return document.querySelectorAll("#oilRows .oil-row").forEach(n=>{var c,t,g,b,R,A,x,G,U,f;let o=((t=(c=n.querySelector(".oil-typeahead"))==null?void 0:c.value)==null?void 0:t.trim())||"",u=((g=n.querySelector(".oil-grams"))==null?void 0:g.value)||"",a=((b=n.querySelector(".oil-percent"))==null?void 0:b.value)||"",l=((R=n.querySelector(".oil-sap-koh"))==null?void 0:R.value)||"",S=((A=n.querySelector(".oil-iodine"))==null?void 0:A.value)||"",v=((x=n.querySelector(".oil-fatty"))==null?void 0:x.value)||"",I=((G=n.querySelector(".oil-gi-id"))==null?void 0:G.value)||"",p=((U=n.querySelector(".oil-default-unit"))==null?void 0:U.value)||"",E=((f=n.querySelector(".oil-category"))==null?void 0:f.value)||"";!o&&!u&&!a&&!I||s.push({name:o,grams:u,percent:a,sap:l,iodine:S,fattyRaw:v,gi:I,defaultUnit:p,categoryName:E})}),s}function M(){var n;if((n=e.fragrances)!=null&&n.collectFragranceData)return e.fragrances.collectFragranceData();let s=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(o=>{var p,E,c,t,g,b,R;let u=((E=(p=o.querySelector(".fragrance-typeahead"))==null?void 0:p.value)==null?void 0:E.trim())||"",a=((c=o.querySelector(".fragrance-grams"))==null?void 0:c.value)||"",l=((t=o.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",S=((g=o.querySelector(".fragrance-gi-id"))==null?void 0:g.value)||"",v=((b=o.querySelector(".fragrance-default-unit"))==null?void 0:b.value)||"",I=((R=o.querySelector(".fragrance-category"))==null?void 0:R.value)||"";!u&&!a&&!l&&!S||s.push({name:u,grams:a,percent:l,gi:S,defaultUnit:v,categoryName:I})}),s}function h(s,n){let o=document.getElementById("oilRows");if(!o||!s)return;let u=e.oils.buildOilRow();u.querySelector(".oil-typeahead").value=s.name||"",u.querySelector(".oil-grams").value=s.grams||"",u.querySelector(".oil-percent").value=s.percent||"",u.querySelector(".oil-sap-koh").value=s.sap||"",u.querySelector(".oil-iodine").value=s.iodine||"",u.querySelector(".oil-fatty").value=s.fattyRaw||"",u.querySelector(".oil-gi-id").value=s.gi||"";let a=u.querySelector(".oil-default-unit");a&&(a.value=s.defaultUnit||"");let l=u.querySelector(".oil-category");l&&(l.value=s.categoryName||"");let S=Array.from(o.children);return n>=S.length?o.appendChild(u):o.insertBefore(u,S[n]),u}function q(){var o,u,a,l,S,v,I,p,E,c,t,g,b,R,A,x,G,U,f,T,C,_,L,N,K,Y,D;let s=y();if(!s)return;let n={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:$(),lye_form:{superfat:((o=document.getElementById("lyeSuperfat"))==null?void 0:o.value)||"5",lye_type:((u=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:u.value)||"NaOH",lye_purity:((a=document.getElementById("lyePurity"))==null?void 0:a.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((S=document.getElementById("waterPct"))==null?void 0:S.value)||"",lye_concentration:((v=document.getElementById("lyeConcentration"))==null?void 0:v.value)||"",water_ratio:((I=document.getElementById("waterRatio"))==null?void 0:I.value)||""},additives:{fragrances:M(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((p=document.getElementById("additiveLactateName"))==null?void 0:p.value)||"",lactate_gi:((E=document.getElementById("additiveLactateGi"))==null?void 0:E.value)||"",lactate_unit:((c=document.getElementById("additiveLactateUnit"))==null?void 0:c.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((g=document.getElementById("additiveSugarName"))==null?void 0:g.value)||"",sugar_gi:((b=document.getElementById("additiveSugarGi"))==null?void 0:b.value)||"",sugar_unit:((R=document.getElementById("additiveSugarUnit"))==null?void 0:R.value)||"",sugar_category:((A=document.getElementById("additiveSugarCategory"))==null?void 0:A.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((x=document.getElementById("additiveSaltName"))==null?void 0:x.value)||"",salt_gi:((G=document.getElementById("additiveSaltGi"))==null?void 0:G.value)||"",salt_unit:((U=document.getElementById("additiveSaltUnit"))==null?void 0:U.value)||"",salt_category:((f=document.getElementById("additiveSaltCategory"))==null?void 0:f.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((T=document.getElementById("additiveCitricName"))==null?void 0:T.value)||"",citric_gi:((C=document.getElementById("additiveCitricGi"))==null?void 0:C.value)||"",citric_unit:((_=document.getElementById("additiveCitricUnit"))==null?void 0:_.value)||"",citric_category:((L=document.getElementById("additiveCitricCategory"))==null?void 0:L.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((N=document.getElementById("moldShape"))==null?void 0:N.value)||"loaf",cylinder_correction:!!((K=document.getElementById("moldCylinderCorrection"))!=null&&K.checked),cylinder_factor:((Y=document.getElementById("moldCylinderFactor"))==null?void 0:Y.value)||"0.85"},quality:{preset:((D=document.getElementById("qualityPreset"))==null?void 0:D.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(j=>j.id)},lines:{ingredients:H("tool-ingredients","ingredient"),consumables:H("tool-consumables","consumable"),containers:H("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{s.setItem(w,JSON.stringify(n));let j=document.getElementById("soapLastSaved");j&&(j.textContent=r(n.updated_at)),e.ui.showAutosaveToast()}catch{}}function O(){var l,S,v;let s=y();if(!s)return;let n=s.getItem(w);if(!n)return;let o=null;try{o=JSON.parse(n)}catch{return}if(!o||typeof o!="object")return;if(o.unit){let I=document.querySelector(`input[name="weight_unit"][value="${o.unit}"]`);I&&(I.checked=!0),e.units.setUnit(o.unit,{skipConvert:!0,skipAutoCalc:!0})}o.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=o.oil_total_target);let u=document.getElementById("oilRows");if(u&&(u.innerHTML="",(Array.isArray(o.oils)&&o.oils.length?o.oils:[{}]).forEach(p=>{let E=e.oils.buildOilRow();E.querySelector(".oil-typeahead").value=p.name||"",E.querySelector(".oil-grams").value=p.grams||"",E.querySelector(".oil-percent").value=p.percent||"",E.querySelector(".oil-sap-koh").value=p.sap||"",E.querySelector(".oil-iodine").value=p.iodine||"",E.querySelector(".oil-fatty").value=p.fattyRaw||"",E.querySelector(".oil-gi-id").value=p.gi||"";let c=E.querySelector(".oil-default-unit");c&&(c.value=p.defaultUnit||"");let t=E.querySelector(".oil-category");t&&(t.value=p.categoryName||""),u.appendChild(E)})),o.lye_form){let I=document.getElementById("lyeSuperfat");I&&(I.value=o.lye_form.superfat||"5");let p=document.querySelector(`input[name="lye_type"][value="${o.lye_form.lye_type||"NaOH"}"]`);p&&(p.checked=!0);let E=document.getElementById("lyePurity");E&&(E.value=o.lye_form.lye_purity||"100");let c=document.getElementById("waterMethod");c&&(c.value=o.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=o.lye_form.water_pct||"");let g=document.getElementById("lyeConcentration");g&&(g.value=o.lye_form.lye_concentration||"");let b=document.getElementById("waterRatio");b&&(b.value=o.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(o.additives){let I=document.getElementById("fragranceRows");if(I&&((l=e.fragrances)!=null&&l.buildFragranceRow)){I.innerHTML="";let N=Array.isArray(o.additives.fragrances)&&o.additives.fragrances.length?o.additives.fragrances:null;if(N)N.forEach(K=>{let Y=e.fragrances.buildFragranceRow();Y.querySelector(".fragrance-typeahead").value=K.name||"",Y.querySelector(".fragrance-grams").value=K.grams||"",Y.querySelector(".fragrance-percent").value=K.percent||"",Y.querySelector(".fragrance-gi-id").value=K.gi||"";let D=Y.querySelector(".fragrance-default-unit");D&&(D.value=K.defaultUnit||"");let j=Y.querySelector(".fragrance-category");j&&(j.value=K.categoryName||""),I.appendChild(Y)});else if(o.additives.fragrance_pct||o.additives.fragrance_name||o.additives.fragrance_gi){let K=e.fragrances.buildFragranceRow();K.querySelector(".fragrance-typeahead").value=o.additives.fragrance_name||"",K.querySelector(".fragrance-percent").value=o.additives.fragrance_pct||"3",K.querySelector(".fragrance-gi-id").value=o.additives.fragrance_gi||"",I.appendChild(K)}}document.getElementById("additiveLactatePct").value=o.additives.lactate_pct||"1";let p=document.getElementById("additiveLactateName");p&&(p.value=o.additives.lactate_name||"");let E=document.getElementById("additiveLactateGi");E&&(E.value=o.additives.lactate_gi||"");let c=document.getElementById("additiveLactateUnit");c&&(c.value=o.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=o.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=o.additives.sugar_pct||"1";let g=document.getElementById("additiveSugarName");g&&(g.value=o.additives.sugar_name||"");let b=document.getElementById("additiveSugarGi");b&&(b.value=o.additives.sugar_gi||"");let R=document.getElementById("additiveSugarUnit");R&&(R.value=o.additives.sugar_unit||"");let A=document.getElementById("additiveSugarCategory");A&&(A.value=o.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=o.additives.salt_pct||"0.5";let x=document.getElementById("additiveSaltName");x&&(x.value=o.additives.salt_name||"");let G=document.getElementById("additiveSaltGi");G&&(G.value=o.additives.salt_gi||"");let U=document.getElementById("additiveSaltUnit");U&&(U.value=o.additives.salt_unit||"");let f=document.getElementById("additiveSaltCategory");f&&(f.value=o.additives.salt_category||""),document.getElementById("additiveCitricPct").value=o.additives.citric_pct||"0";let T=document.getElementById("additiveCitricName");T&&(T.value=o.additives.citric_name||"");let C=document.getElementById("additiveCitricGi");C&&(C.value=o.additives.citric_gi||"");let _=document.getElementById("additiveCitricUnit");_&&(_.value=o.additives.citric_unit||"");let L=document.getElementById("additiveCitricCategory");L&&(L.value=o.additives.citric_category||"")}if(o.mold){document.getElementById("moldWaterWeight").value=o.mold.water_weight||"",document.getElementById("moldOilPct").value=o.mold.oil_pct||"65";let I=document.getElementById("moldShape");I&&(I.value=o.mold.shape||"loaf");let p=document.getElementById("moldCylinderCorrection");p&&(p.checked=!!o.mold.cylinder_correction);let E=document.getElementById("moldCylinderFactor");E&&(E.value=o.mold.cylinder_factor||"0.85");let c=document.getElementById("oilTotalTarget");(S=e.mold)!=null&&S.syncMoldPctFromTarget&&((v=e.mold)!=null&&v.syncTargetFromMold)&&(e.units.toGrams(c==null?void 0:c.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(o.quality){let I=document.getElementById("qualityPreset");if(I){let p=o.quality.preset||"balanced",E=Array.from(I.options).find(c=>c.value===p);I.value=E?p:"balanced"}document.querySelectorAll(".quality-focus").forEach(p=>{p.checked=Array.isArray(o.quality.focus)&&o.quality.focus.includes(p.id)})}function a(I,p,E){let c=document.getElementById(I);c&&(c.innerHTML="",(p||[]).forEach(t=>{let g=e.runner.buildLineRow(E),b=g.querySelector(".tool-typeahead"),R=g.querySelector(".tool-gi-id"),A=g.querySelector(".tool-qty"),x=g.querySelector(".tool-unit");b&&(b.value=t.name||""),R&&(R.value=t.global_item_id||""),A&&t.quantity!==void 0&&t.quantity!==null&&(A.value=t.quantity),x&&t.unit&&Array.from(x.options).find(U=>U.value===t.unit)&&(x.value=t.unit),c.appendChild(g)}))}if(o.lines&&(a("tool-ingredients",o.lines.ingredients,"ingredient"),a("tool-consumables",o.lines.consumables,"consumable"),a("tool-containers",o.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(o.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),o.updated_at){let I=document.getElementById("soapLastSaved");I&&(I.textContent=r(o.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let m=null;function P(){m&&clearTimeout(m),m=setTimeout(q,350)}let i=null;function d(){i&&clearTimeout(i),i=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:q,restoreState:O,serializeLines:H,serializeOils:$,restoreOilRow:h,queueStateSave:P,queueAutoCalc:d}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:r,toNumber:y,clamp:w}=e.helpers,{formatWeight:H,formatPercent:$,toGrams:M}=e.units,h=e.state;async function q(){var l;let a=h.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return a||((l=e.ui)!=null&&l.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function O(a){let l=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(S=>{var t,g,b,R;let v=(g=(t=S.querySelector(".fragrance-typeahead"))==null?void 0:t.value)==null?void 0:g.trim(),I=(b=S.querySelector(".fragrance-grams"))==null?void 0:b.value,p=(R=S.querySelector(".fragrance-percent"))==null?void 0:R.value,E=M(I),c=w(y(p),0);E<=0&&c>0&&a>0&&(E=a*(c/100)),!(E<=0&&c<=0&&!v)&&(!c&&E>0&&a>0&&(c=E/a*100),l.push({name:v||"Fragrance/Essential Oils",grams:E,pct:c}))}),l}function m(a){var E,c,t,g,b,R,A,x;let l=[];if(!a)return l;let S=((c=(E=document.getElementById("additiveLactateName"))==null?void 0:E.value)==null?void 0:c.trim())||"Sodium Lactate",v=((g=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:g.trim())||"Sugar",I=((R=(b=document.getElementById("additiveSaltName"))==null?void 0:b.value)==null?void 0:R.trim())||"Salt",p=((x=(A=document.getElementById("additiveCitricName"))==null?void 0:A.value)==null?void 0:x.trim())||"Citric Acid";return a.lactateG>0&&l.push({name:S,grams:a.lactateG,pct:a.lactatePct}),a.sugarG>0&&l.push({name:v,grams:a.sugarG,pct:a.sugarPct}),a.saltG>0&&l.push({name:I,grams:a.saltG,pct:a.saltPct}),a.citricG>0&&l.push({name:p,grams:a.citricG,pct:a.citricPct}),l}function P(a){var c,t;let l=[],S=y((c=a.additives)==null?void 0:c.citricLyeG),v=y((t=a.additives)==null?void 0:t.citricG),I=String(a.lyeType||"NaOH").toUpperCase();return S>0&&v>0&&(I==="KOH"?l.push("Citric-acid lye adjustment used 0.71 x citric acid because KOH was selected."):l.push("Citric-acid lye adjustment used 0.624 x citric acid because NaOH was selected."),l.push(`${H(S)} lye added extra to accommodate the extra citrus.`)),a.usedSapFallback&&l.push("Average SAP fallback was used for oils missing SAP values."),String(a.lyeSelected||"").toUpperCase()==="KOH90"&&l.push("KOH90 selection assumes 90% lye purity."),(Array.isArray(a.oils)?a.oils:[]).some(g=>{let b=y(g==null?void 0:g.sapKoh);return b>0&&b<=1})&&l.push("SAP values at or below 1.0 were treated as decimal SAP and converted to mg KOH/g."),l}function i(a){var t,g;if(Array.isArray((t=a==null?void 0:a.export)==null?void 0:t.csv_rows)&&a.export.csv_rows.length)return a.export.csv_rows;let l=a.totalOils||0,S=[["section","name","quantity","unit","percent"]];S.push(["Summary","Lye Type",a.lyeType||"","",""]),S.push(["Summary","Superfat",r(a.superfat||0,2),"%",""]),S.push(["Summary","Lye Purity",r(a.purity||0,1),"%",""]),S.push(["Summary","Water Method",a.waterMethod||"","",""]),S.push(["Summary","Water %",r(a.waterPct||0,1),"%",""]),S.push(["Summary","Lye Concentration",r(a.lyeConcentration||0,1),"%",""]),S.push(["Summary","Water Ratio",r(a.waterRatio||0,2),"",""]),S.push(["Summary","Total Oils",r(l,2),"gram",""]),S.push(["Summary","Batch Yield",r(a.batchYield||0,2),"gram",""]),(a.oils||[]).forEach(b=>{let R=l>0?r(b.grams/l*100,2):"";S.push(["Oils",b.name||"Oil",r(b.grams||0,2),"gram",R])});let v=y((g=a.additives)==null?void 0:g.citricLyeG),p=a.lyeAdjustedBase!==null&&a.lyeAdjustedBase!==void 0&&a.lyeAdjustedBase!==""?y(a.lyeAdjustedBase)+v:y(a.lyeAdjusted);if(p>0){let b=a.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";v>0&&(b+="*"),S.push(["Lye",b,r(p,2),"gram",""])}return a.water>0&&S.push(["Water","Distilled Water",r(a.water,2),"gram",""]),O(l).forEach(b=>{S.push(["Fragrance",b.name,r(b.grams||0,2),"gram",r(b.pct||0,2)])}),m(a.additives).forEach(b=>{S.push(["Additives",b.name,r(b.grams||0,2),"gram",r(b.pct||0,2)])}),P(a).forEach(b=>{S.push(["Notes",`* ${b}`,"","",""])}),S}function d(a){if(a==null)return"";let l=String(a);return/[",\n]/.test(l)?`"${l.replace(/"/g,'""')}"`:l}function s(a){return a.map(l=>l.map(d).join(",")).join(`
`)}function n(a,l){let S=new Blob([a],{type:"text/csv;charset=utf-8;"}),v=URL.createObjectURL(S),I=document.createElement("a");I.href=v,I.download=l,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(v)}function o(a){var T,C;if(typeof((T=a==null?void 0:a.export)==null?void 0:T.sheet_html)=="string"&&a.export.sheet_html.trim())return a.export.sheet_html;let l=a.totalOils||0,S=(a.oils||[]).map(_=>({name:_.name||"Oil",grams:_.grams||0,pct:l>0?_.grams/l*100:0})),v=O(l),I=m(a.additives),p=new Date().toLocaleString(),E=S.length?S.map(_=>`
          <tr>
            <td>${_.name}</td>
            <td class="text-end">${H(_.grams)}</td>
            <td class="text-end">${$(_.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',c=v.length?v.map(_=>`
          <tr>
            <td>${_.name}</td>
            <td class="text-end">${H(_.grams)}</td>
            <td class="text-end">${$(_.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',t=I.length?I.map(_=>`
          <tr>
            <td>${_.name}</td>
            <td class="text-end">${H(_.grams)}</td>
            <td class="text-end">${$(_.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',g=y((C=a.additives)==null?void 0:C.citricLyeG),R=a.lyeAdjustedBase!==null&&a.lyeAdjustedBase!==void 0&&a.lyeAdjustedBase!==""?y(a.lyeAdjustedBase)+g:y(a.lyeAdjusted),A=`${a.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${g>0?"*":""}`,x=`${H(R)}${g>0?"*":""}`,G=P(a),U=G.map(_=>`<div class="footnote">* ${_}</div>`).join(""),f=G.length?`<div class="footnotes"><h2 class="footnotes-heading">Assumptions</h2>${U}</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnotes { margin-top: 10px; }
      .footnotes-heading { font-size: 14px; margin: 12px 0 4px; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${p}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${a.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${$(a.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${$(a.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${H(l)}</span></div>
      <div class="summary-item"><span>Water</span><span>${H(a.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${H(a.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${a.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${$(a.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${E}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${A}</td><td class="text-end">${x}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${H(a.water||0)}</td></tr>
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${c}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${t}</tbody>
    </table>
    ${f}
  </body>
</html>`}function u(){let a=document.getElementById("saveSoapTool");a&&a.addEventListener("click",async function(){try{let v=h.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!v)return;let I=e.runner.buildSoapRecipePayload(v);h.lastRecipePayload=I;try{let p=e.helpers.getStorage();p&&p.setItem("soap_recipe_payload",JSON.stringify(I))}catch{}B.SOAP_RECIPE_DTO=I,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let l=document.getElementById("exportSoapCsv");l&&l.addEventListener("click",async function(){var E;let v=await q();if(!v)return;let I=i(v),p=typeof((E=v==null?void 0:v.export)==null?void 0:E.csv_text)=="string"&&v.export.csv_text?v.export.csv_text:s(I);n(p,"soap_formula.csv")});let S=document.getElementById("printSoapSheet");S&&S.addEventListener("click",async function(){var E;let v=await q();if(!v)return;let I=o(v),p=B.open("","_blank","width=960,height=720");if(!p){(E=e.ui)!=null&&E.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}p.document.open(),p.document.write(I),p.document.close(),p.focus(),p.onload=()=>{p.print()}})}e.eventsExports={bind:u}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},r=e.state;function y(h){if(!h)return;let q=document.getElementById("addOil"),O=document.getElementById("normalizeOils");q&&(q.dataset.bound="direct",q.addEventListener("click",function(){h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),O&&(O.dataset.bound="direct",O.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),h.addEventListener("input",function(m){m.target.classList.contains("oil-grams")&&(r.lastOilEdit={row:m.target.closest(".oil-row"),field:"grams"}),m.target.classList.contains("oil-percent")&&(r.lastOilEdit={row:m.target.closest(".oil-row"),field:"percent"}),(m.target.classList.contains("oil-grams")||m.target.classList.contains("oil-percent")||m.target.classList.contains("oil-typeahead"))&&(m.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(m.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),h.addEventListener("focusin",function(m){m.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(m.target.closest(".oil-row"))}),h.addEventListener("focusout",function(m){m.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),m.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(m.target.closest(".oil-row"),"grams"),m.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(m.target.closest(".oil-row"),"percent")}),h.addEventListener("keydown",function(m){m.key==="Enter"&&(m.target.classList.contains("oil-grams")&&(m.preventDefault(),e.oils.validateOilEntry(m.target.closest(".oil-row"),"grams")),m.target.classList.contains("oil-percent")&&(m.preventDefault(),e.oils.validateOilEntry(m.target.closest(".oil-row"),"percent")))}),h.addEventListener("mouseover",function(m){if(!m.target.classList.contains("oil-typeahead"))return;let P=m.target.closest(".oil-row");!P||P===r.lastPreviewRow||(r.lastPreviewRow=P,e.oils.setSelectedOilProfileFromRow(P))}),h.addEventListener("mouseout",function(m){m.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),h.addEventListener("click",function(m){let P=m.target.closest(".oil-profile-open");if(P){let d=P.closest(".oil-row");if(d){e.oils.setSelectedOilProfileFromRow(d);let s=document.getElementById("oilProfileModal");s&&B.bootstrap&&B.bootstrap.Modal.getOrCreateInstance(s).show()}return}let i=m.target.closest(".remove-oil");if(i){let d=i.closest(".oil-row");d&&(r.lastRemovedOil=e.oils.serializeOilRow(d),r.lastRemovedOilIndex=Array.from(d.parentElement.children).indexOf(d),e.ui.showUndoToast("Oil removed.")),d&&r.lastOilEdit&&r.lastOilEdit.row===d&&(r.lastOilEdit=null,e.oils.clearSelectedOilProfile()),d&&d.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}})}function w(h){if(!h)return;let q=document.getElementById("addFragrance");q&&(q.dataset.bound="direct",q.addEventListener("click",function(){h.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),h.addEventListener("input",function(O){O.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:O.target.closest(".fragrance-row"),field:"grams"}),O.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:O.target.closest(".fragrance-row"),field:"percent"}),(O.target.classList.contains("fragrance-grams")||O.target.classList.contains("fragrance-percent")||O.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),h.addEventListener("click",function(O){var i;let m=O.target.closest(".remove-fragrance");if(!m)return;let P=m.closest(".fragrance-row");P&&((i=e.state.lastFragranceEdit)==null?void 0:i.row)===P&&(e.state.lastFragranceEdit=null),P&&P.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function H({oilRows:h,fragranceRows:q}){let O=document.getElementById("soapStageTabContent");if(!O)return;let m=()=>{let P=O.querySelector(".tab-pane.active")||O.querySelector(".tab-pane.show.active");return P?P.querySelector(".soap-stage-body")||P:null};O.addEventListener("wheel",P=>{let i=P.target;if(!(i instanceof HTMLElement))return;let d=i.closest('input[type="number"]');if(!(d instanceof HTMLInputElement))return;let s=m();if(!(s instanceof HTMLElement)||s.scrollHeight<=s.clientHeight+1)return;document.activeElement===d&&typeof d.blur=="function"&&d.blur();let n=s.scrollTop<=0,o=s.scrollTop+s.clientHeight>=s.scrollHeight-1;P.deltaY<0&&n||P.deltaY>0&&o||(s.scrollTop+=P.deltaY,P.preventDefault())},{passive:!1}),O.addEventListener("click",P=>{let i=P.target.closest("[data-stage-action]"),d=P.target.closest("[data-soap-action]");if(!i&&!d)return;if(P.preventDefault(),P.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),d){if(d.dataset.bound==="direct")return;let o=d.dataset.soapAction;o==="add-oil"&&h&&(h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),o==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),o==="add-fragrance"&&q&&(q.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let s=i.dataset.stageAction,n=Number(i.dataset.stageIndex);Number.isNaN(n)||(s==="prev"&&e.stages.openStageByIndex(Math.max(0,n-1)),s==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,n+1)),s==="reset"&&e.stages.resetStage(n+1))})}function $(){let h=document.getElementById("soapUndoRemove");h&&h.addEventListener("click",()=>{r.lastRemovedOil&&(e.storage.restoreOilRow(r.lastRemovedOil,r.lastRemovedOilIndex||0),r.lastRemovedOil=null,r.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}function M(){let h=document.getElementById("oilRows"),q=document.getElementById("fragranceRows");return y(h),w(q),H({oilRows:h,fragranceRows:q}),$(),{oilRows:h,fragranceRows:q}}e.eventsRows={bind:M}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function r(){let i=document.getElementById("soapStageTabList");if(!i)return;let d=()=>{i.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("is-expanded"));let s=i.querySelector(".nav-link.active");s&&s.closest(".nav-item")&&s.closest(".nav-item").classList.add("is-expanded")};i.addEventListener("shown.bs.tab",()=>{d(),e.layout.scheduleStageHeightSync()}),d()}function y(){let i=document.getElementById("resultsCardToggle"),d=document.getElementById("resultsCard");!i||!d||i.addEventListener("click",()=>{d.classList.toggle("is-collapsed");let s=d.classList.contains("is-collapsed");i.setAttribute("aria-expanded",(!s).toString());let n=s?"Expand formula details":"Collapse formula details";i.setAttribute("aria-label",n),i.setAttribute("title",n);let o=i.querySelector("i");o&&(o.classList.toggle("fa-chevron-down",s),o.classList.toggle("fa-chevron-up",!s))})}function w(){document.querySelectorAll('input[name="weight_unit"]').forEach(i=>{i.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})})}function H(){let i=()=>{var l;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(l=e.mold)!=null&&l.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},d=document.getElementById("oilTotalTarget");d&&d.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let s=document.getElementById("moldWaterWeight");s&&s.addEventListener("input",function(){e.mold.syncTargetFromMold(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let n=document.getElementById("moldOilPct");n&&n.addEventListener("input",function(){e.mold.syncTargetFromMold(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let o=document.getElementById("moldShape");o&&o.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let u=document.getElementById("moldCylinderCorrection");u&&u.addEventListener("change",function(){e.mold.syncTargetFromMold(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let a=document.getElementById("moldCylinderFactor");a&&a.addEventListener("input",function(){e.mold.syncTargetFromMold(),i(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function $(){let i=document.getElementById("waterMethod");i&&i.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(d=>{d.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(d=>{let s=document.getElementById(d);s&&["input","change"].forEach(n=>{s.addEventListener(n,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})})}function M(){[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:d,weightId:s})=>{let n=document.getElementById(d),o=document.getElementById(s);n&&n.addEventListener("input",()=>{let u=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:d,weightId:s,sourceField:"pct",totalOils:u}),e.additives.updateAdditivesOutput(u),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),o&&o.addEventListener("input",()=>{let u=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:d,weightId:s,sourceField:"weight",totalOils:u}),e.additives.updateAdditivesOutput(u),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(d=>{d.addEventListener("input",()=>{e.storage.queueStateSave()})})}function h(){let i=document.getElementById("qualityPreset");i&&i.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(s=>{s.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let d=document.getElementById("applyQualityTargets");d&&d.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(s=>{s.addEventListener("click",()=>e.quality.applyQualityTargets()),s.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.quality.applyQualityTargets())})})}function q(){document.querySelectorAll(".stub-btn").forEach(d=>{d.addEventListener("click",function(){let s=this.dataset.stubKind,n=this.dataset.stubName;e.runner.addStubLine(s,n),e.storage.queueStateSave()})});let i=document.getElementById("soapToolPage");i&&(i.addEventListener("click",function(d){d.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),i.addEventListener("input",function(d){d.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(d.target),e.stages.updateStageStatuses(),e.ui.flashStage(d.target.closest(".soap-stage-card")))}),i.addEventListener("change",function(d){d.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(d.target),e.stages.updateStageStatuses())}))}function O(){let i=document.getElementById("addToolIngredient");i&&i.addEventListener("click",function(){let n=document.getElementById("tool-ingredients");n&&n.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let d=document.getElementById("addToolConsumable");d&&d.addEventListener("click",function(){let n=document.getElementById("tool-consumables");n&&n.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let s=document.getElementById("addToolContainer");s&&s.addEventListener("click",function(){let n=document.getElementById("tool-containers");n&&n.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()})}function m(){let i=document.getElementById("calcLyeBtn");i&&i.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()})}function P(){r(),y(),w(),H(),$(),M(),h(),q(),O(),m()}e.eventsForms={bind:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function r(){let w=document.getElementById("soapMobileDrawer"),H=document.getElementById("soapMobileDrawerContent"),$=document.getElementById("soapMobileDrawerTitle"),M=document.getElementById("soapDrawerEmpty"),h=document.getElementById("soapDrawerClose"),q=document.getElementById("soapQualityCard"),O=document.getElementById("resultsCard");if(!w||!H||!$||!q||!O)return;let m=q.parentElement,P=O.parentElement,i=new Map,d=null,s=()=>B.matchMedia("(max-width: 767px)").matches,n=c=>c==="quality"?q:O,o=c=>c==="quality"?m:P,u=c=>c==="quality"?"Display":"Results",a=c=>{let t=i.get(c);t||(t=document.createElement("div"),t.className="soap-card-placeholder",i.set(c,t)),t.style.height=`${c.offsetHeight}px`,c.parentElement&&c.parentElement!==H&&!t.parentElement&&c.parentElement.insertBefore(t,c)},l=c=>{c&&(a(c),H.appendChild(c))},S=(c,t)=>{let g=i.get(c);g&&g.parentElement?g.replaceWith(c):t&&c.parentElement!==t&&t.appendChild(c)},v=()=>{if(!M)return;let c=d==="results",t=getComputedStyle(O).display!=="none";M.classList.toggle("d-none",!c||t)},I=c=>{s()&&(d&&d!==c&&S(n(d),o(d)),l(n(c)),$.textContent=u(c),d=c,w.classList.add("is-open"),v())},p=()=>{d&&(S(n(d),o(d)),d=null,w.classList.remove("is-open"),v())};w.querySelectorAll("[data-drawer-target]").forEach(c=>{c.addEventListener("click",()=>{let t=c.dataset.drawerTarget;t&&(w.classList.contains("is-open")&&d===t?p():I(t))})}),h&&h.addEventListener("click",p),B.addEventListener("resize",()=>{!s()&&d&&p()}),new MutationObserver(()=>v()).observe(O,{attributes:!0,attributeFilter:["style","class"]})}function y(){r(),B.addEventListener("resize",e.layout.scheduleStageHeightSync),B.addEventListener("load",e.layout.scheduleStageHeightSync)}e.eventsMobile={bind:y}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:y,SALT_CATEGORY_SET:w,CITRIC_CATEGORY_SET:H}=e.constants;function $({oilRows:M,fragranceRows:h}={}){var q,O;e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",r,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",y,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",w,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",H,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),M&&!M.querySelector(".oil-row")&&M.appendChild(e.oils.buildOilRow()),h&&!h.querySelector(".fragrance-row")&&(q=e.fragrances)!=null&&q.buildFragranceRow&&h.appendChild(e.fragrances.buildFragranceRow()),(O=e.fragrances)!=null&&O.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()}e.eventsInit={bind:$}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function r(){var w,H,$,M,h;let y=(w=e.eventsRows)!=null&&w.bind?e.eventsRows.bind():{oilRows:null,fragranceRows:null};(H=e.eventsForms)!=null&&H.bind&&e.eventsForms.bind(y),($=e.eventsExports)!=null&&$.bind&&e.eventsExports.bind(y),(M=e.eventsMobile)!=null&&M.bind&&e.eventsMobile.bind(y),(h=e.eventsInit)!=null&&h.bind&&e.eventsInit.bind(y)}r()})(window);
