(function(N){"use strict";let e={inventory:"Inventory",global:"Global Library"},c={inventory:"bg-primary",global:"bg-info text-dark"},h={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function G(r,d){let l;return function(){let O=arguments;clearTimeout(l),l=setTimeout(()=>r.apply(null,O),d)}}function z(r){return(r||"").trim().toLowerCase()}function K(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function M(r){return typeof r=="function"?r():r}function q(r){let d=new Set;return(r||[]).forEach(l=>{let O=l&&(l.global_item_id||l.id);O&&d.add(String(O))}),d}function A(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${c[r]||"bg-secondary"} ms-2">${d}</span>`}function F(r,d,l,O){O=O||{},r.innerHTML="";let p=!1;if(d.forEach(C=>{!C.items||!C.items.length||(p=!0,C.items.forEach(S=>{let _=document.createElement("a");_.href="#",_.className="list-group-item list-group-item-action suggestion-item";let g=O.showSubtitle&&S.subtitle?`<div class="small text-muted mt-1">${S.subtitle}</div>`:"";_.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${S.text||S.display_name||S.name||""}</span>
          ${O.showSourceBadge?A(C.source||S.source):""}
        </div>${g}`,_.addEventListener("click",function(t){t.preventDefault(),l(S,C.source||S.source),r.classList.add("d-none")}),r.appendChild(_)}))}),r.classList.toggle("d-none",!p),!p&&r.dataset.emptyMessage){let C=document.createElement("div");C.className="list-group-item text-muted small",C.textContent=r.dataset.emptyMessage,r.appendChild(C),r.classList.remove("d-none")}}function L(r,d,l){r.innerHTML="";let O=!1;d.forEach(p=>{if(!p.ingredients||!p.ingredients.length)return;O=!0;let C=document.createElement("div");C.className="list-group-item text-muted small fw-semibold",C.textContent=p.title,r.appendChild(C),p.ingredients.forEach(S=>{let _=document.createElement("div");_.className="list-group-item ingredient-result";let g=document.createElement("div");g.className="d-flex justify-content-between align-items-center ingredient-summary",g.setAttribute("role","button"),g.setAttribute("tabindex","0"),g.innerHTML=`<span class="fw-semibold">${S.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${S.forms.length} option${S.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",S.forms.forEach(E=>{let P=document.createElement("button");P.type="button",P.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",P.innerHTML=`<div class="fw-semibold">${E.text||E.display_name||E.name||"Form"}</div>`,P.addEventListener("click",function(){l(E,E.source||p.source),r.classList.add("d-none")}),t.appendChild(P)});function f(E){E.type==="keydown"&&E.key!=="Enter"&&E.key!==" "||(E.preventDefault(),t.classList.toggle("d-none"))}g.addEventListener("click",f),g.addEventListener("keydown",f),_.appendChild(g),_.appendChild(t),r.appendChild(_),S.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!O)}function U(r,d,l){r.innerHTML="";let O=!1;if((d||[]).forEach(p=>{O=!0;let C=document.createElement("a");C.href="#",C.className="list-group-item list-group-item-action suggestion-item";let S=p.inci_name?`<div class="small text-muted">${p.inci_name}</div>`:"";C.innerHTML=`<div class="fw-semibold">${p.text||p.name}</div>${S}`,C.addEventListener("click",function(_){_.preventDefault(),l(p,"definition"),r.classList.add("d-none")}),r.appendChild(C)}),r.classList.toggle("d-none",!O),!O&&r.dataset.emptyMessage){let p=document.createElement("div");p.className="list-group-item text-muted small",p.textContent=r.dataset.emptyMessage,r.appendChild(p),r.classList.remove("d-none")}}function i(r){let d=[];return(r||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let O=l.ingredient&&l.ingredient.name||l.ingredient_name||null,p=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,C=l.category_tags||[];l.forms.forEach(S=>{var t,f,E,P,w,x,k,H,u,I;let _=S.physical_form||{},g=S.display_name||S.text||S.name||(O&&S.physical_form_name?`${O}, ${S.physical_form_name}`:l.display_name||l.text||l.name||"");d.push({id:S.id,text:g,item_type:S.item_type||l.item_type,default_unit:S.default_unit||S.unit||l.default_unit||l.unit||null,source:"global",global_item_id:S.id,ingredient_id:S.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:S.ingredient_name||O,physical_form_id:S.physical_form_id||_&&_.id||null,physical_form_name:S.physical_form_name||_&&_.name||null,ingredient_category_name:p,category_tags:C,density:S.density||l.density||null,capacity:S.capacity||l.capacity||null,capacity_unit:S.capacity_unit||l.capacity_unit||null,container_material:S.container_material||l.container_material||null,container_type:S.container_type||l.container_type||null,container_style:S.container_style||l.container_style||null,container_color:S.container_color||l.container_color||null,default_is_perishable:(t=S.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(f=S.recommended_shelf_life_days)!=null?f:l.recommended_shelf_life_days,saponification_value:(P=(E=S.saponification_value)!=null?E:l.saponification_value)!=null?P:null,iodine_value:(x=(w=S.iodine_value)!=null?w:l.iodine_value)!=null?x:null,fatty_acid_profile:(H=(k=S.fatty_acid_profile)!=null?k:l.fatty_acid_profile)!=null?H:null,melting_point_c:(I=(u=S.melting_point_c)!=null?u:l.melting_point_c)!=null?I:null})})}else if(l){let O=l.display_name||l.text||l.name||"",p=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;d.push({id:l.id,text:O,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:p,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),d}function B(r){let d=new Map;return(r||[]).forEach(l=>{let O=l.ingredient_name||l.text||l.name||"",p=l.ingredient_id?`id:${l.ingredient_id}`:`name:${z(O)}`,C=d.get(p)||{ingredient_id:l.ingredient_id||null,name:O,forms:[]};C.forms.push({id:l.id,text:l.text||O,ingredient_name:O,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),d.set(p,C)}),Array.from(d.values())}function m(r,d){let l=[];return(r||[]).forEach(O=>{let p=(O.forms||[]).map(S=>({id:S.id,text:S.name||S.display_name||S.text,ingredient_name:S.ingredient_name||O.name||O.ingredient&&O.ingredient.name||"Ingredient",physical_form_name:S.physical_form_name||null,default_unit:S.default_unit||S.unit||null,source:"global",global_item_id:S.id,density:S.density||null,capacity:S.capacity||null,capacity_unit:S.capacity_unit||null,container_material:S.container_material||null,container_type:S.container_type||null,container_style:S.container_style||null,container_color:S.container_color||null,saponification_value:S.saponification_value||null,iodine_value:S.iodine_value||null,fatty_acid_profile:S.fatty_acid_profile||null,melting_point_c:S.melting_point_c||null})),C=d?p.filter(S=>!S.global_item_id||!d.has(String(S.global_item_id))):p;C.length&&l.push({ingredient_id:O.ingredient_id||O.id||null,name:O.name||O.ingredient&&O.ingredient.name||p[0]&&p[0].ingredient_name||"Ingredient",forms:C})}),l}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function n(r){let d={...h,...r},l=d.inputEl,O=d.invHiddenEl,p=d.giHiddenEl,C=K(d.listEl),S=d.mode||"recipe",_=d.searchType||"ingredient",g=d.includeInventory,t=d.includeGlobal,f=d.ingredientFirst,E=d.displayVariant,P=typeof d.resultFilter=="function"?d.resultFilter:null,w=typeof d.onSelection=="function"?d.onSelection:null,x=d.globalUrlBuilder;if(!l||!O&&S==="recipe"||!p&&d.requireHidden!==!1)return;C&&!C.classList.contains("list-group")&&C.classList.add("list-group"),!C.parentNode&&l.parentNode&&l.parentNode.appendChild(C);function k(v,b){let T=new URLSearchParams({q:v});return b&&b!=="all"&&T.set("type",b),`/inventory/api/search?${T.toString()}`}function H(v,b,T){if(typeof x=="function")return x(v,b,T);let R=new URLSearchParams({q:v});return b&&b!=="all"&&R.set("type",b),b==="ingredient"&&T&&R.set("group","ingredient"),`${S==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${R.toString()}`}let u=G(function(){let v=(l.value||"").trim();if(!v){C.classList.add("d-none"),C.innerHTML="",O&&(O.value=""),p&&(p.value="");return}let b=(M(_)||"ingredient").toLowerCase(),T=M(g),R=M(t),D=b==="ingredient"&&!!M(f),Q=E||(D?"grouped":"compact");if(b==="ingredient_definition"||b==="definition"){a(v).then($=>{let J=$&&$.results||[];U(C,J.map(X=>({id:X.id,text:X.name,name:X.name,inci_name:X.inci_name,slug:X.slug,ingredient_category_id:X.ingredient_category_id,ingredient_category_name:X.ingredient_category_name})),I)}).catch(()=>C.classList.add("d-none"));return}let Y=T!==!1?fetch(k(v,b)).then($=>$.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),j=R!==!1?fetch(H(v,b,D)).then($=>$.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([Y,j]).then($=>{let J=$[0]&&$[0].results||[],X=$[1]&&$[1].results||[],ae=P?J.filter(re=>P(re,"inventory")):J,se=P?X.filter(re=>P(re,"global")):X,me=q(ae),fe=i(se).filter(re=>!re.global_item_id||!me.has(String(re.global_item_id))).filter(re=>P?P(re,"global"):!0);if(D){let re=B(ae),ye=m(se,me),pe=[];re.length&&pe.push({title:"Your Inventory",source:"inventory",ingredients:re}),ye.length&&pe.push({title:"Global Library",source:"global",ingredients:ye}),L(C,pe,I);return}let ce=[];ae.length&&ce.push({title:"Your Inventory",source:"inventory",items:ae}),fe.length&&ce.push({title:"Global Library",source:"global",items:fe}),F(C,ce,I,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:Q==="detailed"})}).catch(()=>{C.classList.add("d-none")})},200);function I(v,b){l.value=v.text||v.display_name||v.name||"",b==="inventory"?(O&&(O.value=v.id_numeric||v.id||""),p&&(p.value=v.global_item_id||"")):(p&&(p.value=v.global_item_id||v.id||""),O&&(O.value="")),typeof w=="function"&&w(v,b)}l.addEventListener("input",function(){O&&(O.value=""),p&&(p.value=""),u()}),document.addEventListener("click",function(v){!C.contains(v.target)&&!l.contains(v.target)&&C.classList.add("d-none")})}N.attachMergedInventoryGlobalTypeahead=n,N.renderInventoryTypeaheadList=F})(window);(function(N){"use strict";function e(c,h){var G=h&&h.context||"public",z=h&&h.unitOptionsHtml||"",K=h&&h.mode||(G==="public"?"public":"recipe"),M=document.createElement("div");M.className="row g-2 align-items-end mb-2",M.innerHTML=['<div class="col-md-6">','  <label class="form-label">',c==="container"?"Container":c==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',z,"  </select>","</div>",'<div class="col-md-3 ',c!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var q=M.querySelector(".tool-typeahead"),A=M.querySelector(".tool-gi-id"),F=M.querySelector('[data-role="suggestions"]');if(typeof N.attachMergedInventoryGlobalTypeahead=="function"){let L=c==="container"?"container":c==="consumable"?"consumable":"ingredient",U=G!=="public";N.attachMergedInventoryGlobalTypeahead({inputEl:q,giHiddenEl:A,listEl:F,mode:K,context:G,ingredientFirst:c==="ingredient",searchType:L,includeInventory:U,includeGlobal:!0})}return M.querySelector(".tool-remove").addEventListener("click",function(){M.remove()}),M}N.buildToolLineRow=e})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{};e.config={unitOptionsHtml:N.soapToolConfig&&N.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(N.SOAP_CALC_LIMIT)?N.SOAP_CALC_LIMIT:null,calcTier:N.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(N.soapToolConfig&&N.soapToolConfig.useCsvPrimary),isAuthenticated:N.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:c,toNumber:h,clamp:G,formatTime:z,getStorage:K,buildSoapcalcSearchBuilder:M};function c(q,A=3){if(!isFinite(q))return 0;let F=Math.pow(10,A);return Math.round(q*F)/F}function h(q){let A=q;typeof A=="string"&&(A=A.replace(/,/g,"").trim());let F=parseFloat(A);return isFinite(F)?F:0}function G(q,A,F){return!isFinite(q)||q<A?A:F!=null&&q>F?F:q}function z(q){return q?`Saved ${new Date(q).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function K(){try{return N.localStorage}catch{return null}}function M(){let q=(F,L,U)=>{let i=new URLSearchParams({q:F});return L&&L!=="all"&&i.set("type",L),L==="ingredient"&&U&&i.set("group","ingredient"),`/api/public/global-items/search?${i.toString()}`},A=(F,L,U)=>{let i=new URLSearchParams({q:F});return U&&i.set("group","ingredient"),`/api/public/soapcalc-items/search?${i.toString()}`};return e.config.useCsvPrimary===!0?A:q}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},h={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},G={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},z=[41,70],K=100,M=[136,170],q=250,A={hardness:(c.hardness[0]+c.hardness[1])/2,cleansing:(c.cleansing[0]+c.cleansing[1])/2,conditioning:(c.conditioning[0]+c.conditioning[1])/2,bubbly:(c.bubbly[0]+c.bubbly[1])/2,creamy:(c.creamy[0]+c.creamy[1])/2},F={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},L={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},U=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],i=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],B={g:1,oz:28.3495,lb:453.592},m=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),O=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:c,QUALITY_HINTS:h,QUALITY_FEEL_HINTS:G,IODINE_RANGE:z,IODINE_SCALE_MAX:K,INS_RANGE:M,INS_SCALE_MAX:q,QUALITY_BASE:A,QUALITY_PRESETS:F,FATTY_BAR_COLORS:L,FATTY_DISPLAY_KEYS:U,OIL_TIP_RULES:i,UNIT_FACTORS:B,STAGE_CONFIGS:m,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:O}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{toNumber:c}=e.helpers;function h(M){let q=0,A=0;return M.forEach(F=>{F.iodine>0&&(q+=F.grams,A+=F.iodine*F.grams)}),{iodine:q>0?A/q:0,coverageWeight:q}}function G(M){let q={},A=0;M.forEach(L=>{!L.fattyProfile||typeof L.fattyProfile!="object"||(A+=L.grams,Object.entries(L.fattyProfile).forEach(([U,i])=>{let B=c(i);B>0&&(q[U]=(q[U]||0)+L.grams*(B/100))}))});let F={};return A>0&&Object.entries(q).forEach(([L,U])=>{F[L]=U/A*100}),{percent:F,coveredWeight:A}}function z(M){let q=A=>M[A]||0;return{hardness:q("lauric")+q("myristic")+q("palmitic")+q("stearic"),cleansing:q("lauric")+q("myristic"),conditioning:q("oleic")+q("linoleic")+q("linolenic")+q("ricinoleic"),bubbly:q("lauric")+q("myristic")+q("ricinoleic"),creamy:q("palmitic")+q("stearic")+q("ricinoleic")}}function K(M){if(!M||typeof M!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let q={lauric:c(M.lauric),myristic:c(M.myristic),palmitic:c(M.palmitic),stearic:c(M.stearic),ricinoleic:c(M.ricinoleic),oleic:c(M.oleic),linoleic:c(M.linoleic),linolenic:c(M.linolenic)},A=z(q);return{hardness:(A.hardness||0)/100,cleansing:(A.cleansing||0)/100,conditioning:(A.conditioning||0)/100,bubbly:(A.bubbly||0)/100,creamy:(A.creamy||0)/100}}e.calc={computeIodine:h,computeFattyAcids:G,computeQualities:z,computeOilQualityScores:K},N.SoapCalcService=e.calc})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h,clamp:G}=e.helpers,{UNIT_FACTORS:z}=e.constants,K=e.state;function M(i){return G(h(i),0)*(z[K.currentUnit]||1)}function q(i){return G(i,0)/(z[K.currentUnit]||1)}function A(i){return!isFinite(i)||i<=0?"--":`${c(q(i),2)} ${K.currentUnit}`}function F(i){return isFinite(i)?`${c(i,1)}%`:"--"}function L(){document.querySelectorAll(".unit-label").forEach(i=>{i.textContent=K.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(i=>{i.dataset.suffix=K.currentUnit})}function U(i,B={}){if(!i)return;if(i===K.currentUnit){L();return}let m=K.currentUnit;if(K.currentUnit=i,L(),B.skipConvert)return;let a=(z[m]||1)/(z[i]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let l=h(d.value);l>0&&(d.value=c(l*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let l=h(d.value);l>0&&(d.value=c(l*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let d=h(n.value);d>0&&(n.value=c(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=h(r.value);d>0&&(r.value=c(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),B.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:M,fromGrams:q,formatWeight:A,formatPercent:F,updateUnitLabels:L,setUnit:U}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.state,h={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function G(m){m&&(m.classList.remove("soap-number-pulse"),m.offsetWidth,m.classList.add("soap-number-pulse"))}function z(m){var n;let a=document.getElementById(m);return!a||!((n=N.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function K(){let m=Date.now();if(m-c.lastSaveToastAt<3500)return;c.lastSaveToastAt=m;let a=z("soapAutosaveToast");a&&a.show()}function M(m){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=m||"Oil removed.");let r=z("soapUndoToast");r&&r.show()}function q(){let m=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");m&&m.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function A(m){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let r=(m==null?void 0:m.lyeConcentration)||0,d="";r>40&&(d="High concentration"),r>0&&r<25&&(d="Low concentration"),a.textContent=d,a.classList.toggle("d-none",!d)}if(n){let r=(m==null?void 0:m.waterRatio)||0,d="";r>0&&r<1.8&&(d="Low water"),r>2.7&&(d="High water"),n.textContent=d,n.classList.toggle("d-none",!d)}}function F(){document.querySelectorAll("#soapToolPage .form-text").forEach(m=>{let a=m.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function L(m){if(!m||m.type!=="number")return;let a=m.value;if(a===""){m.classList.remove("is-invalid");return}let n=parseFloat(a),r=m.getAttribute("min"),d=m.getAttribute("max"),l=r!==null&&r!==""&&n<parseFloat(r),O=d!==null&&d!==""&&n>parseFloat(d);m.classList.toggle("is-invalid",!isFinite(n)||l||O)}function U(m){var n;if(!m)return;let a=((n=m.querySelector)==null?void 0:n.call(m,".soap-stage-card"))||m;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function i(m,a,n={}){var O;let r=document.getElementById("soapAlertStack");if(!r)return;let d=h[m]||h.info,l=document.createElement("div");l.className=`alert alert-${m} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((O=l.querySelector('[data-role="dismiss"]'))==null||O.addEventListener("click",()=>l.remove())),r.prepend(l),n.persist||setTimeout(()=>{l.parentNode&&l.remove()},n.timeoutMs||4500)}function B(){let m=document.getElementById("soapAlertStack");m&&m.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:G,getToastInstance:z,showAutosaveToast:K,showUndoToast:M,updateResultsMeta:q,updateResultsWarnings:A,applyHelperVisibility:F,validateNumericField:L,flashStage:U,showSoapAlert:i,clearSoapAlerts:B}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{};function c(){let G=document.getElementById("soapStagePane"),z=document.getElementById("soapQualityCard");if(!G||!z)return;if(!N.matchMedia("(min-width: 768px)").matches){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}let M=z.offsetHeight;if(!M){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}G.style.setProperty("--soap-stage-height",`${M}px`),G.classList.add("is-height-synced")}let h=()=>{N.requestAnimationFrame(c)};e.layout={syncStageHeight:c,scheduleStageHeightSync:h}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{clamp:c,toNumber:h,round:G}=e.helpers,{toGrams:z,fromGrams:K}=e.units;function M(){let i=L(),B=document.getElementById("oilTotalTarget"),m=document.getElementById("oilTargetHint");B&&i.effectiveCapacity>0&&z(B.value)<=0&&(B.value=i.targetOils>0?G(K(i.targetOils),2):""),m&&(i.effectiveCapacity>0?m.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":m.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";i.shape==="cylinder"&&i.waterWeight>0&&(i.useCylinder?n=`Cylinder correction applied (${G(i.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}q()}function q(i=null){var S;let B=document.getElementById("moldWetBatterWarning");if(!B)return;let m=()=>{B.classList.add("d-none"),B.textContent=""},a=L(),n=e.state||{},r=n.lastCalc||null,d=(S=e.oils)!=null&&S.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=h(r==null?void 0:r.totalOils),O=h(i);if((!isFinite(O)||O<=0)&&(O=h(r==null?void 0:r.batchYield)),i==null&&l>0&&d>0&&Math.abs(l-d)>.01){m();return}if(!isFinite(O)||O<=0||a.effectiveCapacity<=0){m();return}let p=O-a.effectiveCapacity;if(p<=.01){m();return}let C=n.currentUnit||"g";B.textContent=`Full wet batter is ${G(K(O),2)} ${C}, exceeding mold capacity ${G(K(a.effectiveCapacity),2)} ${C} by ${G(K(p),2)} ${C}. Reduce oils target/% of mold or lower water/additives.`,B.classList.remove("d-none")}function A(){let i=document.getElementById("oilTotalTarget"),B=L();return i&&(B.effectiveCapacity>0&&(i.value=B.targetOils>0?G(K(B.targetOils),2):""),M()),B}function F(){let i=document.getElementById("oilTotalTarget"),B=document.getElementById("moldOilPct");if(!i||!B){let n=L();return M(),n}let m=L();if(m.effectiveCapacity>0){let n=z(i.value),r=c(n,0,m.effectiveCapacity);n>m.effectiveCapacity+.01&&(i.value=G(K(r),2));let d=r>0?r/m.effectiveCapacity*100:0;B.value=r>0?G(d,2):""}let a=L();return M(),a}function L(){var l,O,p;let i=z(document.getElementById("moldWaterWeight").value),B=c(h(document.getElementById("moldOilPct").value),0,100),m=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",a=!!((O=document.getElementById("moldCylinderCorrection"))!=null&&O.checked),n=c(h((p=document.getElementById("moldCylinderFactor"))==null?void 0:p.value),.5,1),r=i>0?i*(a?n:1):0,d=r>0?r*(B/100):0;return{waterWeight:i,oilPct:B,shape:m,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:d}}function U(){var m;let i=((m=document.getElementById("moldShape"))==null?void 0:m.value)||"loaf",B=document.getElementById("moldCylinderOptions");B&&B.classList.toggle("d-none",i!=="cylinder"),M()}e.mold={updateMoldSuggested:M,updateWetBatterWarning:q,syncTargetFromMold:A,syncMoldPctFromTarget:F,getMoldSettings:L,updateMoldShapeUI:U}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h,clamp:G,buildSoapcalcSearchBuilder:z}=e.helpers,{toGrams:K,fromGrams:M}=e.units,{OIL_CATEGORY_SET:q,OIL_TIP_RULES:A}=e.constants,{computeQualities:F}=e.calc,L=e.state;function U(u){let I=u.querySelector(".oil-typeahead"),v=u.querySelector(".oil-sap-koh"),b=u.querySelector(".oil-iodine"),T=u.querySelector(".oil-fatty"),R=u.querySelector(".oil-gi-id"),D=u.querySelector(".oil-default-unit"),Q=u.querySelector(".oil-category"),Y=u.querySelector('[data-role="suggestions"]');if(!I||!Y||typeof N.attachMergedInventoryGlobalTypeahead!="function")return;let j=z();N.attachMergedInventoryGlobalTypeahead({inputEl:I,listEl:Y,mode:"public",giHiddenEl:R,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:j,searchType:"ingredient",resultFilter:($,J)=>k($,q,J),requireHidden:!1,onSelection:function($){v&&(v.value=($==null?void 0:$.saponification_value)||""),b&&(b.value=($==null?void 0:$.iodine_value)||""),T&&(T.value=$!=null&&$.fatty_acid_profile?JSON.stringify($.fatty_acid_profile):""),D&&(D.value=($==null?void 0:$.default_unit)||""),Q&&(Q.value=($==null?void 0:$.ingredient_category_name)||""),t($),C(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),I.addEventListener("input",function(){this.value.trim()||(v&&(v.value=""),b&&(b.value=""),T&&(T.value=""),R&&(R.value=""),D&&(D.value=""),Q&&(Q.value=""),E())})}function i(){var v,b;let u=document.getElementById("oilRowTemplate"),I=(b=(v=u==null?void 0:u.content)==null?void 0:v.querySelector(".oil-row"))==null?void 0:b.cloneNode(!0);return I?(I.querySelectorAll("input").forEach(T=>{T.value=""}),I.querySelectorAll(".form-text").forEach(T=>{let R=T.closest('.soap-field-stack, [class*="col-"]');R&&R.classList.add("soap-field")}),U(I),I.querySelectorAll(".unit-suffix").forEach(T=>{T.dataset.suffix=L.currentUnit}),I):document.createElement("div")}function B(){let u=document.getElementById("oilTotalTarget"),I=K(u==null?void 0:u.value);if(I>0)return I;let v=e.mold.getMoldSettings();return v.targetOils>0?v.targetOils:0}function m(u){let I=[];return u.forEach(b=>{var D,Q;let T=K((D=b.querySelector(".oil-grams"))==null?void 0:D.value),R=G(h((Q=b.querySelector(".oil-percent"))==null?void 0:Q.value),0);T>0&&R>0&&I.push(T/(R/100))}),I.length?I.reduce((b,T)=>b+T,0)/I.length:0}function a(u,I){if(!u||!I||I<=0)return{allowedGrams:null,allowedPct:null};let v=Array.from(document.querySelectorAll("#oilRows .oil-row")),b=v.reduce((j,$)=>{var J;return $===u?j:j+K((J=$.querySelector(".oil-grams"))==null?void 0:J.value)},0),T=v.reduce((j,$)=>{var J;return $===u?j:j+G(h((J=$.querySelector(".oil-percent"))==null?void 0:J.value),0)},0),R=Math.max(0,100-T),D=Math.max(0,I-b),Q=I*R/100;return{allowedGrams:Math.max(0,Math.min(D,Q)),allowedPct:R}}function n(u,I,v){if(!u)return;let b=u.querySelector(`[data-role="oil-${I}-hint"]`);b&&(v?(b.textContent=v,b.classList.add("is-visible")):(b.textContent="",b.classList.remove("is-visible")))}function r(u){u&&(u.classList.remove("oil-input-bounce"),u.offsetWidth,u.classList.add("oil-input-bounce"))}function d(u,I,v={}){let b=B();if(!u||!b||b<=0){n(u,I,"");return}let T=u.querySelector(".oil-grams"),R=u.querySelector(".oil-percent"),D=a(u,b);if(I==="grams"&&T){let Q=K(T.value),Y="";if(Q>b+.01?Y="Entry exceeds the max oils allowed in stage 2.":D.allowedGrams!==null&&Q>D.allowedGrams+.01&&(Y=`Must be under ${c(M(D.allowedGrams),2)} ${L.currentUnit} to stay within the stage 2 oil limit.`),Y){let j=D.allowedGrams!==null?c(M(D.allowedGrams),2):c(M(b),2);T.value=j>0?j:"",n(u,I,Y),T.classList.add("oil-input-warning"),r(T),C()}else T.classList.remove("oil-input-warning"),n(u,I,"")}if(I==="percent"&&R){let Q=G(h(R.value),0),Y="";if(Q>100.01?Y="Entry exceeds the max oils allowed in stage 2.":D.allowedPct!==null&&Q>D.allowedPct+.01&&(Y=`Must be under ${c(D.allowedPct,2)}% to stay within the stage 2 oil limit.`),Y){let j=D.allowedPct!==null?c(D.allowedPct,2):100;R.value=j>0?j:"",n(u,I,Y),R.classList.add("oil-input-warning"),r(R),C()}else R.classList.remove("oil-input-warning"),n(u,I,"")}}function l(u,I={}){let v=Array.from(document.querySelectorAll("#oilRows .oil-row")),b=u!=null?u:B(),T=!!I.force;if(!b||b<=0||!v.length){L.lastOilTarget=b;return}let R=v.reduce((Q,Y)=>{var j;return Q+G(h((j=Y.querySelector(".oil-percent"))==null?void 0:j.value),0)},0),D=v.reduce((Q,Y)=>{var j;return Q+K((j=Y.querySelector(".oil-grams"))==null?void 0:j.value)},0);if(R<=0&&D<=0){L.lastOilTarget=b;return}if(!(!T&&L.lastOilTarget&&Math.abs(L.lastOilTarget-b)<.01)){if(R>0)v.forEach(Q=>{let Y=Q.querySelector(".oil-percent"),j=Q.querySelector(".oil-grams"),$=G(h(Y==null?void 0:Y.value),0),J=R>0?$/R:0;j&&(j.value=J>0?c(M(b*J),2):""),Y&&(Y.value=J>0?c(J*100,2):"")});else if(D>0){let Q=b/D;v.forEach(Y=>{let j=Y.querySelector(".oil-grams"),$=Y.querySelector(".oil-percent"),J=K(j==null?void 0:j.value);if(j){let X=J>0?J*Q:0;j.value=X>0?c(M(X),2):""}if($){let X=K(j==null?void 0:j.value);$.value=X>0?c(X/b*100,2):""}})}L.lastOilTarget=b,C({skipEnforce:!0})}}function O(u,I){if(!L.lastOilEdit||!L.lastOilEdit.row)return!1;let v=L.lastOilEdit.row,b=u.reduce((Q,Y)=>{var j;return Y===v?Q:Q+K((j=Y.querySelector(".oil-grams"))==null?void 0:j.value)},0),T=Math.max(0,I-b),R=v.querySelector(".oil-grams"),D=v.querySelector(".oil-percent");return!R||!D?!1:(R.value=T>0?c(M(T),2):"",D.value=T>0?c(T/I*100,2):"",L.wasCapped=!0,!0)}function p({totalWeight:u,totalPct:I,target:v,capped:b}){let T=document.getElementById("oilLimitWarning");if(!T)return;let R=[];if(b&&R.push("Oil total hit the mold cap and was adjusted."),v>0&&u>v+.01){let D=u-v;R.push(`Oil weights exceed the target by ${c(M(D),2)} ${L.currentUnit}.`)}I>100.01&&R.push(`Oil percentages are over 100% by ${c(I-100,2)}%.`),R.length?(T.classList.remove("d-none"),T.innerHTML=`${R.join(" ")} Adjust oils or mold % to continue.`):(T.classList.add("d-none"),T.textContent="")}function C(u={}){var Q;u.skipEnforce||(L.wasCapped=!1);let I=Array.from(document.querySelectorAll("#oilRows .oil-row")),v=e.mold.getMoldSettings(),b=B();if(!b&&!v.targetOils){let Y=m(I);if(Y>0){b=Y;let j=document.getElementById("oilTotalTarget");j&&!j.value&&(j.value=c(M(Y),2))}}let T=0,R=0;if(I.forEach(Y=>{let j=Y.querySelector(".oil-grams"),$=Y.querySelector(".oil-percent"),J=K(j==null?void 0:j.value),X=G(h($==null?void 0:$.value),0);b>0&&(L.lastOilEdit&&L.lastOilEdit.row===Y&&L.lastOilEdit.field==="percent"?(J=X>0?b*(X/100):0,j.value=X>0?c(M(J),2):""):J>0?(X=J/b*100,$.value=c(X,2)):X>0&&(J=b*(X/100),j.value=c(M(J),2)),R+=X),J>0&&(T+=J)}),b<=0&&(T>0?(R=0,I.forEach(Y=>{let j=Y.querySelector(".oil-grams"),$=Y.querySelector(".oil-percent"),J=K(j==null?void 0:j.value);if(J>0){let X=J/T*100;$.value=c(X,2),R+=X}})):R=I.reduce((Y,j)=>{var $;return Y+G(h(($=j.querySelector(".oil-percent"))==null?void 0:$.value),0)},0)),!u.skipEnforce&&v.targetOils>0&&T>v.targetOils+.01&&O(I,v.targetOils))return C({skipEnforce:!0});L.totalOilsGrams=T;let D=document.getElementById("oilTotalComputed");return D&&(D.textContent=T>0?`${c(M(T),2)} ${L.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=c(R,2),p({totalWeight:T,totalPct:R,target:b,capped:L.wasCapped}),e.additives.updateAdditivesOutput(T),(Q=e.fragrances)!=null&&Q.updateFragranceTotals&&e.fragrances.updateFragranceTotals(T),e.mold.updateMoldSuggested(),P(),{totalWeight:T,totalPct:R,target:b}}function S(){let u=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!u.length)return;let I=B(),v=u.reduce((b,T)=>{var R;return b+G(h((R=T.querySelector(".oil-percent"))==null?void 0:R.value),0)},0);!v&&I>0&&(v=u.reduce((b,T)=>{var D;let R=K((D=T.querySelector(".oil-grams"))==null?void 0:D.value);return b+(R>0?R/I*100:0)},0)),!(v<=0)&&(u.forEach(b=>{let T=b.querySelector(".oil-percent"),R=b.querySelector(".oil-grams"),Q=G(h(T.value),0)/v*100;T.value=c(Q,2),I>0&&(R.value=Q>0?c(M(I*(Q/100)),2):"")}),C())}function _(){let u=[];return document.querySelectorAll("#oilRows .oil-row").forEach(I=>{var J,X,ae,se,me,fe,ce,re,ye;let v=(X=(J=I.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:X.trim(),b=K((ae=I.querySelector(".oil-grams"))==null?void 0:ae.value),T=h((se=I.querySelector(".oil-sap-koh"))==null?void 0:se.value),R=h((me=I.querySelector(".oil-iodine"))==null?void 0:me.value),D=((fe=I.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",Q=((ce=I.querySelector(".oil-gi-id"))==null?void 0:ce.value)||"",Y=((re=I.querySelector(".oil-default-unit"))==null?void 0:re.value)||"",j=((ye=I.querySelector(".oil-category"))==null?void 0:ye.value)||"",$=null;if(D)try{$=JSON.parse(D)}catch{$=null}b<=0||u.push({name:v||null,grams:b,sapKoh:T,iodine:R,fattyProfile:$,global_item_id:Q?parseInt(Q):null,default_unit:Y||null,ingredient_category_name:j||null})}),u}function g({name:u,sapKoh:I,iodine:v,fattyProfile:b}={}){let T=document.getElementById("oilProfileFloat"),R=(X,ae)=>{let se=document.getElementById(X);se&&(se.textContent=ae)},D=u||"Pick an oil to preview";R("selectedOilName",D),R("selectedOilModalName",D),T&&T.classList.toggle("d-none",!u);let Q=I>0?c(I,1):"--",Y=v>0?c(v,1):"--";R("selectedOilSap",Q),R("selectedOilModalSap",Q),R("selectedOilIodine",Y),R("selectedOilModalIodine",Y);let j=b?F(b):{},$=(X,ae)=>{let se=isFinite(ae)&&ae>0?c(ae,1):"--";R(X,se)};$("selectedOilHardness",j.hardness),$("selectedOilModalHardness",j.hardness),$("selectedOilCleansing",j.cleansing),$("selectedOilModalCleansing",j.cleansing),$("selectedOilConditioning",j.conditioning),$("selectedOilModalConditioning",j.conditioning),$("selectedOilBubbly",j.bubbly),$("selectedOilModalBubbly",j.bubbly),$("selectedOilCreamy",j.creamy),$("selectedOilModalCreamy",j.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(X=>{let ae=`selectedOil${X.charAt(0).toUpperCase()}${X.slice(1)}`,se=`selectedOilModal${X.charAt(0).toUpperCase()}${X.slice(1)}`,me=b?h(b[X]):0,fe=me>0?c(me,1):"--";R(ae,fe),R(se,fe)})}function t(u){if(!u){E();return}L.selectedOilProfile=u;let I=u.fatty_acid_profile||null;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=null}g({name:u.text||u.display_name||u.name,sapKoh:h(u.saponification_value),iodine:h(u.iodine_value),fattyProfile:I})}function f(u){var D,Q,Y,j,$;if(!u)return;let I=(Q=(D=u.querySelector(".oil-typeahead"))==null?void 0:D.value)==null?void 0:Q.trim(),v=h((Y=u.querySelector(".oil-sap-koh"))==null?void 0:Y.value),b=h((j=u.querySelector(".oil-iodine"))==null?void 0:j.value),T=(($=u.querySelector(".oil-fatty"))==null?void 0:$.value)||"",R=null;if(T)try{R=JSON.parse(T)}catch{R=null}g({name:I,sapKoh:v,iodine:b,fattyProfile:R})}function E(){L.selectedOilProfile=null,L.lastPreviewRow=null,g()}function P(){let u=document.getElementById("oilBlendTips");if(!u)return;let I=_().filter(T=>T.grams>0||T.percent>0);if(!I.length){u.classList.add("d-none"),u.textContent="";return}let v=new Set;I.forEach(T=>{let R=(T.name||"").toLowerCase();if(R&&A.forEach(D=>{D.match.test(R)&&v.add(D.tip)}),T.fattyProfile&&typeof T.fattyProfile=="object"){let D=h(T.fattyProfile.lauric),Q=h(T.fattyProfile.myristic),Y=h(T.fattyProfile.palmitic),j=h(T.fattyProfile.stearic),$=h(T.fattyProfile.ricinoleic),J=h(T.fattyProfile.oleic),X=h(T.fattyProfile.linoleic),ae=h(T.fattyProfile.linolenic);D+Q>=30&&v.add(`${T.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),Y+j>=40&&v.add(`${T.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),J>=60&&v.add(`${T.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),X+ae>=20&&v.add(`${T.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),$>=60&&v.add(`${T.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let b=Array.from(v).slice(0,6);if(!b.length){u.classList.add("d-none"),u.textContent="";return}u.classList.remove("d-none"),u.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${b.map(T=>`<li>${T}</li>`).join("")}</ul>`}function w(){return L.totalOilsGrams||0}function x(u){var I,v,b,T,R,D,Q,Y,j;return u?{name:((I=u.querySelector(".oil-typeahead"))==null?void 0:I.value)||"",grams:((v=u.querySelector(".oil-grams"))==null?void 0:v.value)||"",percent:((b=u.querySelector(".oil-percent"))==null?void 0:b.value)||"",sap:((T=u.querySelector(".oil-sap-koh"))==null?void 0:T.value)||"",iodine:((R=u.querySelector(".oil-iodine"))==null?void 0:R.value)||"",fattyRaw:((D=u.querySelector(".oil-fatty"))==null?void 0:D.value)||"",gi:((Q=u.querySelector(".oil-gi-id"))==null?void 0:Q.value)||"",defaultUnit:((Y=u.querySelector(".oil-default-unit"))==null?void 0:Y.value)||"",categoryName:((j=u.querySelector(".oil-category"))==null?void 0:j.value)||""}:null}function k(u,I,v){let b=H(u);return b?I.has(b):v==="inventory"}function H(u){return!u||typeof u!="object"?null:u.ingredient&&u.ingredient.ingredient_category_name||u.ingredient_category_name||u.ingredient_category&&u.ingredient_category.name||null}e.oils={attachOilTypeahead:U,buildOilRow:i,getOilTargetGrams:B,updateOilTotals:C,normalizeOils:S,collectOilData:_,setSelectedOilProfileFromRow:f,clearSelectedOilProfile:E,updateOilTips:P,getTotalOilsGrams:w,serializeOilRow:x,validateOilEntry:d,scaleOilsToTarget:l}})(window);(function(N){"use strict";var g;let e=N.SoapTool=N.SoapTool||{},c=e.bulkOils=e.bulkOils||{},{toNumber:h,clamp:G}=e.helpers,z=e.state,K=Array.isArray((g=e.constants)==null?void 0:g.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],M=new Set(["selected_pct","selected_weight_g"]),q=25,A=140,F=260,L={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function U(){var t,f;(f=(t=e.storage)==null?void 0:t.queueStateSave)==null||f.call(t)}function i(t,f){var E,P;(P=(E=e.ui)==null?void 0:E.showSoapAlert)==null||P.call(E,t,f,{dismissible:!0,timeoutMs:6e3})}function B(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function m(t){return t?t==="name"||M.has(t)?!0:K.includes(t):!1}function a(){(!z.bulkOilModal||typeof z.bulkOilModal!="object")&&(z.bulkOilModal=JSON.parse(JSON.stringify(L)));let t=z.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=m(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let f={},E=t&&typeof t=="object"?t:{};return K.forEach(P=>{let w=h(E[P]);w>0&&(f[P]=w)}),f}function r(t){let f=n(t==null?void 0:t.fatty_profile),E=String((t==null?void 0:t.name)||"").trim(),P=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:h(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${P}:${E.toLowerCase()}`)),name:E,sap_koh:h(t==null?void 0:t.sap_koh),iodine:h(t==null?void 0:t.iodine),fatty_profile:f,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:P,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=B(),f=a(),E=Object.keys(f.selection||{}).length,P=`Selected: ${E}`;t.summaryEl&&(t.summaryEl.textContent=P),t.stageCountEl&&(t.stageCountEl.textContent=String(E))}function l(t){var E;return((E=a().selection)==null?void 0:E[t])||null}function O(t,f={}){var x,k;let E=a();if(!t||!t.key)return null;let P=E.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:G(h((x=f.selected_pct)!=null?x:P.selected_pct),0,100),selected_weight_g:G(h((k=f.selected_weight_g)!=null?k:P.selected_weight_g),0)};return E.selection[t.key]=w,w}function p(t){var E;let f=a();(E=f.selection)!=null&&E[t]&&delete f.selection[t]}function C(t){var E;return((E=a().recordByKey)==null?void 0:E[t])||null}function S(){let t=a();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(f=>({key:f.key,name:f.name,sap_koh:f.sap_koh,iodine:f.iodine,fatty_profile:f.fatty_profile||{},default_unit:f.default_unit,ingredient_category_name:f.ingredient_category_name,global_item_id:f.global_item_id,source:f.source,is_basic:!!f.is_basic,selected_pct:G(h(f.selected_pct),0,100),selected_weight_g:G(h(f.selected_weight_g),0)}))}}function _(t){let f=a();f.mode="all",f.viewSelected=!!(t!=null&&t.view_selected),f.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",f.sortKey=m(t==null?void 0:t.sort_key)?t.sort_key:"name",f.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let E={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let x=String((w==null?void 0:w.key)||"").trim(),k=String((w==null?void 0:w.name)||"").trim();!x||!k||(E[x]={key:x,name:k,sap_koh:h(w==null?void 0:w.sap_koh),iodine:h(w==null?void 0:w.iodine),fatty_profile:n(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:h(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:G(h(w==null?void 0:w.selected_pct),0,100),selected_weight_g:G(h(w==null?void 0:w.selected_weight_g),0)})}),f.selection=E,f.visibleRecords=[],f.offset=0,f.totalCount=0,f.hasMore=!0,f.loading=!1,d()}c.shared={FATTY_KEYS:K,LOCAL_SORT_KEYS:M,PAGE_SIZE:q,SCROLL_FETCH_THRESHOLD:A,SEARCH_DEBOUNCE_MS:F,queueStateSave:U,showAlert:i,getRefs:B,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:l,setSelection:O,removeSelection:p,getRecordByKey:C,serializeSelection:S,restoreState:_}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared;if(!h)return;let{round:G,toNumber:z}=e.helpers,{fromGrams:K}=e.units,{FATTY_KEYS:M,LOCAL_SORT_KEYS:q,getRefs:A,ensureModalState:F,selectionForRecordKey:L,updateSelectionCounters:U}=h;function i(g){let t=A();t.statusEl&&(t.statusEl.textContent=g)}function B(){let g=F();if(g.loading&&!g.visibleRecords.length){i("Loading oils...");return}if(!g.visibleRecords.length){let w=g.query?"No oils match that search.":"No oils available.";i(w);return}let t=g.visibleRecords.length,f=g.totalCount,E=g.hasMore?" \u2022 scroll for more":"",P=g.query?` \u2022 search: "${g.query}"`:"";i(`Loaded ${t}/${f}${P}${E}`)}function m(g,t,f){if(typeof g=="string"||typeof t=="string"){let w=String(g||"").toLowerCase(),x=String(t||"").toLowerCase();return w<x?f==="asc"?-1:1:w>x?f==="asc"?1:-1:0}let E=z(g),P=z(t);return E<P?f==="asc"?-1:1:E>P?f==="asc"?1:-1:0}function a(g,t){var f,E;return t==="selected_pct"?((f=L(g.key))==null?void 0:f.selected_pct)||0:t==="selected_weight_g"?((E=L(g.key))==null?void 0:E.selected_weight_g)||0:""}function n(){let g=F();q.has(g.sortKey)&&g.visibleRecords.sort((t,f)=>{let E=m(a(t,g.sortKey),a(f,g.sortKey),g.sortDir);return E!==0?E:m(t.name||"",f.name||"","asc")})}function r(){let g=F();if(!g.viewSelected)return;let t=[],f=[];g.visibleRecords.forEach(E=>{L(E.key)?t.push(E):f.push(E)}),g.visibleRecords=t.concat(f)}function d(){n(),r()}function l(g){let t=String(g||"").trim().toLowerCase();return t==="name"||M.includes(t)?t:"name"}function O(){let g=F();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[▲▼]\s*$/,"").trim());let f=t.dataset.label||"",E=t.dataset.sortKey||"";g.sortKey===E?t.textContent=`${f} ${g.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=f})}function p(g,t){let f=L(t.key),E=g.querySelector(".bulk-oil-check"),P=g.querySelector(".bulk-oil-pct"),w=g.querySelector(".bulk-oil-weight");E&&(E.checked=!!f),P&&(P.value=f&&f.selected_pct>0?G(f.selected_pct,2):""),w&&(w.value=f&&f.selected_weight_g>0?G(K(f.selected_weight_g),2):"")}function C(g){let t=document.createElement("td");t.className="bulk-oil-acid";let f=z(g);return t.textContent=f>0?G(f,1).toString():"--",t}function S(g){let t=document.createElement("tr");t.dataset.recordKey=g.key;let f=document.createElement("td");f.className="text-center";let E=document.createElement("input");E.type="checkbox",E.className="form-check-input bulk-oil-check",f.appendChild(E),t.appendChild(f);let P=document.createElement("td");P.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=g.name;let x=document.createElement("div");x.className="text-muted small";let k=g.ingredient_category_name?` \xB7 ${g.ingredient_category_name}`:"";x.textContent=`${g.source}${k}`,P.appendChild(w),P.appendChild(x),t.appendChild(P),M.forEach(b=>{var T;t.appendChild(C((T=g.fatty_profile)==null?void 0:T[b]))});let H=document.createElement("td"),u=document.createElement("input");u.type="number",u.min="0",u.max="100",u.step="0.1",u.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",H.appendChild(u),t.appendChild(H);let I=document.createElement("td"),v=document.createElement("input");return v.type="number",v.min="0",v.step="0.1",v.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",I.appendChild(v),t.appendChild(I),p(t,g),t}function _(){let g=A(),t=F();if(!g.bodyEl)return;g.bodyEl.innerHTML="";let f=document.createDocumentFragment();t.visibleRecords.forEach(E=>{f.appendChild(S(E))}),g.bodyEl.appendChild(f),O(),U(),B()}c.render={updateStatusText:i,refreshCatalogStatus:B,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:l,sortButtonsLabel:O,renderVisibleRecords:_}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared,G=c.render;if(!h||!G)return;let{PAGE_SIZE:z,getRefs:K,ensureModalState:M,normalizeCatalogRecord:q}=h,{refreshCatalogStatus:A,normalizeServerSortKey:F,applyClientOrdering:L,renderVisibleRecords:U,updateStatusText:i}=G;function B(){let a=M(),n=K();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function m({reset:a=!1}={}){let n=M();if(!K().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&B();let d=n.requestToken+1;n.requestToken=d,n.loading=!0,A();let l=new URLSearchParams;l.set("mode",n.mode),l.set("offset",String(n.offset)),l.set("limit",String(z)),l.set("q",n.query||""),l.set("sort_key",F(n.sortKey)),l.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let O=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!O.ok)throw new Error("Unable to load oils catalog");let p=await O.json();if(!p||p.success!==!0||!p.result||!Array.isArray(p.result.records))throw new Error("Invalid oils catalog response");if(d!==n.requestToken)return;let C=p.result.records.map(q),S=Math.max(0,parseInt(p.result.next_offset,10)||n.offset+C.length),_=Math.max(C.length,parseInt(p.result.count,10)||0),g=!!p.result.has_more;C.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?C.slice():n.visibleRecords.concat(C),n.offset=S,n.totalCount=_,n.hasMore=g,L(),U()}catch(O){throw d===n.requestToken&&i("Unable to load oils catalog."),O}finally{d===n.requestToken&&(n.loading=!1,A())}}c.api={fetchCatalogPage:m}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared,G=c.render,z=c.api;if(!h||!G||!z)return;let{round:K,toNumber:M,clamp:q}=e.helpers,{toGrams:A,fromGrams:F}=e.units,L=e.state,{LOCAL_SORT_KEYS:U,SCROLL_FETCH_THRESHOLD:i,SEARCH_DEBOUNCE_MS:B,queueStateSave:m,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:d,setSelection:l,removeSelection:O,getRecordByKey:p,serializeSelection:C,restoreState:S}=h,{applyClientOrdering:_,sortButtonsLabel:g,renderVisibleRecords:t}=G,{fetchCatalogPage:f}=z,E=null,P=null;function w(){var y;let s=n();s.modalEl&&(!E&&((y=N.bootstrap)!=null&&y.Modal)&&(E=N.bootstrap.Modal.getOrCreateInstance(s.modalEl)),E&&E.hide())}function x(){return document.getElementById("oilRows")}function k(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function H(s){return String(s||"").trim().toLowerCase()}function u(s){var y;return H((y=s==null?void 0:s.querySelector(".oil-typeahead"))==null?void 0:y.value)}function I(s){var W;let y=String(((W=s==null?void 0:s.querySelector(".oil-gi-id"))==null?void 0:W.value)||"").trim();return y||""}function v(s,y){let W=String(s||"").trim();if(!W)return null;let V=k(),Z=V.find(oe=>String(oe.dataset.bulkOilKey||"")===W);if(Z)return Z;let te=String((y==null?void 0:y.global_item_id)||"").trim();if(te&&(Z=V.find(oe=>I(oe)===te),Z))return Z;let le=H(y==null?void 0:y.name);return le&&(Z=V.find(oe=>u(oe)===le),Z)?Z:null}function b(s,y){if(!s||!y)return;s.dataset.bulkOilKey=y.key||"";let W=s.querySelector(".oil-typeahead"),V=s.querySelector(".oil-sap-koh"),Z=s.querySelector(".oil-iodine"),te=s.querySelector(".oil-fatty"),le=s.querySelector(".oil-gi-id"),oe=s.querySelector(".oil-default-unit"),ie=s.querySelector(".oil-category"),ee=s.querySelector(".oil-grams"),de=s.querySelector(".oil-percent");W&&(W.value=y.name||""),V&&(V.value=y.sap_koh>0?K(y.sap_koh,3):""),Z&&(Z.value=y.iodine>0?K(y.iodine,3):""),te&&(te.value=y.fatty_profile&&Object.keys(y.fatty_profile).length?JSON.stringify(y.fatty_profile):""),le&&(le.value=y.global_item_id||""),oe&&(oe.value=y.default_unit||""),ie&&(ie.value=y.ingredient_category_name||""),de&&(de.value=y.selected_pct>0?K(y.selected_pct,2):""),ee&&(ee.value=y.selected_weight_g>0?K(F(y.selected_weight_g),2):"")}function T(s){if(!s||!s.key)return null;let y=v(s.key,s),W=x();return!y&&W&&(y=e.oils.buildOilRow(),y&&W.appendChild(y)),b(y,s),y}function R(s,y){let W=v(s,y);W&&(L.lastOilEdit&&L.lastOilEdit.row===W&&(L.lastOilEdit=null,e.oils.clearSelectedOilProfile()),W.remove())}function D(){k().forEach(y=>{L.lastOilEdit&&L.lastOilEdit.row===y&&(L.lastOilEdit=null),y.remove()}),e.oils.clearSelectedOilProfile()}function Q(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function Y(s,y,W){let V=String(W||"").trim();if(V)return V;let Z=String(y||"").trim();if(Z)return`global:${Z}`;let te=H(s);return te?`soapcalc:${te}`:""}function j(){let s={};return k().forEach(y=>{var be,Ce,Ee,_e,ue,Te,Le,ne,ge;let W=String(((be=y.querySelector(".oil-typeahead"))==null?void 0:be.value)||"").trim(),V=M((Ce=y.querySelector(".oil-sap-koh"))==null?void 0:Ce.value),Z=M((Ee=y.querySelector(".oil-iodine"))==null?void 0:Ee.value),te=String(((_e=y.querySelector(".oil-gi-id"))==null?void 0:_e.value)||"").trim(),le=String(((ue=y.querySelector(".oil-default-unit"))==null?void 0:ue.value)||"gram"),oe=String(((Te=y.querySelector(".oil-category"))==null?void 0:Te.value)||""),ie=q(M((Le=y.querySelector(".oil-percent"))==null?void 0:Le.value),0,100),ee=q(A((ne=y.querySelector(".oil-grams"))==null?void 0:ne.value),0),de=String(((ge=y.querySelector(".oil-fatty"))==null?void 0:ge.value)||""),ve={};if(de)try{let qe=JSON.parse(de);ve=h.normalizeFattyProfile(qe)}catch{ve={}}let he=Y(W,te,y.dataset.bulkOilKey);!he||!(W||ie>0||ee>0||V>0||Z>0||Object.keys(ve).length>0)||(y.dataset.bulkOilKey=he,s[he]={key:he,name:W||"Unnamed oil",sap_koh:V,iodine:Z,fatty_profile:ve,default_unit:le||"gram",ingredient_category_name:oe,global_item_id:te?parseInt(te,10):null,source:te?"global":"soapcalc",is_basic:!te,selected_pct:ie,selected_weight_g:ee})}),s}function $(){let s=r();s.selection=j(),d()}function J(){let s=r(),y=Object.values(s.selection||{}),W=new Set(y.map(V=>V.key));k().forEach(V=>{let Z=String(V.dataset.bulkOilKey||"").trim();(!Z||!W.has(Z))&&V.remove()}),y.slice().sort((V,Z)=>String(V.name||"").localeCompare(String(Z.name||""))).forEach(V=>{T(V)}),Q()}async function X(){var W;let s=n(),y=r();if(s.modalEl){$(),!E&&((W=N.bootstrap)!=null&&W.Modal)&&(E=N.bootstrap.Modal.getOrCreateInstance(s.modalEl)),s.searchInput&&(s.searchInput.value=y.query||""),s.viewSelectedToggle&&(s.viewSelectedToggle.checked=!!y.viewSelected),s.unitLabelEl&&(s.unitLabelEl.textContent=L.currentUnit||"g"),E&&E.show(),g(),d();try{await f({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ae(s){let y=s.target;if(!(y instanceof HTMLElement))return;let W=y.closest("tr[data-record-key]");if(!W)return;let V=W.dataset.recordKey||"",Z=p(V);if(!Z)return;let te=W.querySelector(".bulk-oil-check"),le=W.querySelector(".bulk-oil-pct"),oe=W.querySelector(".bulk-oil-weight"),ie=q(M(le==null?void 0:le.value),0,100),ee=q(A(oe==null?void 0:oe.value),0),de=ie>0||ee>0;if(!!(te!=null&&te.checked)||de){te&&(te.checked=!0);let be=l(Z,{selected_pct:ie,selected_weight_g:ee});T(be)}else O(V),R(V,Z);let he=r();U.has(he.sortKey)||he.viewSelected?(_(),t()):d(),Q(),m()}function se(s){let y=r();y.viewSelected=!!s,_(),t(),m()}async function me(s){let y=s.target instanceof HTMLElement?s.target.closest(".bulk-oil-sort"):null;if(!y)return;let W=y.getAttribute("data-sort-key")||"name",V=r();if(V.sortKey===W?V.sortDir=V.sortDir==="asc"?"desc":"asc":(V.sortKey=W,V.sortDir=W==="name"?"asc":"desc"),m(),U.has(V.sortKey)){_(),t();return}try{await f({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function fe(){let s=r();s.selection={},D(),(U.has(s.sortKey)||s.viewSelected)&&_(),t(),Q(),m()}async function ce(){let s=n(),y=r();if(!(!s.scrollEl||y.loading||!y.hasMore||!(s.scrollEl.scrollTop+s.scrollEl.clientHeight>=s.scrollEl.scrollHeight-i)))try{await f({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function re(){P&&N.clearTimeout(P),P=N.setTimeout(async()=>{try{await f({reset:!0})}catch{a("danger","Unable to search oils right now.")}},B)}function ye(){J(),m(),w()}function pe(s,y){if(!(s instanceof HTMLInputElement))return!1;let V=n().bodyEl;if(!(V instanceof HTMLElement))return!1;let Z=s.classList.contains("bulk-oil-pct")?"bulk-oil-pct":s.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!Z)return!1;let te=Array.from(V.querySelectorAll(`input.${Z}`)),le=te.indexOf(s);if(le<0)return!1;let oe=le+y;if(oe<0||oe>=te.length)return!1;let ie=te[oe];return ie instanceof HTMLInputElement?(ie.focus(),typeof ie.select=="function"&&ie.select(),!0):!1}function Se(){var y;let s=n();s.unitLabelEl&&(s.unitLabelEl.textContent=L.currentUnit||"g"),(y=s.modalEl)!=null&&y.classList.contains("show")&&t()}function o(){let s=n();s.modalEl&&(s.openBtn&&s.openBtn.addEventListener("click",()=>{X()}),s.searchInput&&s.searchInput.addEventListener("input",()=>{let y=r();y.query=s.searchInput.value||"",m(),re()}),s.viewSelectedToggle&&s.viewSelectedToggle.addEventListener("change",()=>{se(!!s.viewSelectedToggle.checked)}),s.scrollEl&&s.scrollEl.addEventListener("scroll",ce),s.bodyEl&&(s.bodyEl.addEventListener("change",ae),s.bodyEl.addEventListener("keydown",y=>{let W=y.target;if(!(!(W instanceof HTMLInputElement)||!(W.classList.contains("bulk-oil-pct")||W.classList.contains("bulk-oil-weight")))){if(y.key==="Enter"){y.preventDefault(),W.blur();return}y.key==="Tab"&&pe(W,y.shiftKey?-1:1)&&y.preventDefault()}})),s.modalEl.querySelectorAll(".bulk-oil-sort").forEach(y=>{y.addEventListener("click",me)}),s.importBtn&&s.importBtn.addEventListener("click",()=>{ye()}),s.clearBtn&&s.clearBtn.addEventListener("click",()=>{fe()}),s.modalEl.addEventListener("shown.bs.modal",()=>{let y=n();y.searchInput&&y.searchInput.focus()}))}o(),d(),g(),e.bulkOilsModal={openModal:X,serializeSelection:C,restoreState:S,onUnitChanged:Se}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{toNumber:c,round:h,clamp:G,buildSoapcalcSearchBuilder:z}=e.helpers,{formatWeight:K,toGrams:M,fromGrams:q}=e.units,{FRAGRANCE_CATEGORY_SET:A}=e.constants,F=e.state;function L(_,g,t,f,E){var I;let P=document.getElementById(_),w=document.getElementById(g),x=f?document.getElementById(f):null,k=E?document.getElementById(E):null,H=(I=P==null?void 0:P.parentElement)==null?void 0:I.querySelector('[data-role="suggestions"]');if(!P||!H||typeof N.attachMergedInventoryGlobalTypeahead!="function")return;let u=z();N.attachMergedInventoryGlobalTypeahead({inputEl:P,listEl:H,mode:"public",giHiddenEl:w,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:u,searchType:"ingredient",resultFilter:(v,b)=>{let T=S(v);return T?t.has(T):b==="inventory"},requireHidden:!1,onSelection:function(v){x&&(x.value=(v==null?void 0:v.default_unit)||""),k&&(k.value=(v==null?void 0:v.ingredient_category_name)||""),e.storage.queueStateSave()}}),P.addEventListener("input",function(){this.value.trim()||(x&&(x.value=""),k&&(k.value=""))})}function U({pctId:_,weightId:g}){var w,x,k;let t=document.getElementById(_),f=t==null?void 0:t.value;if(f!==""&&f!==null&&f!==void 0)return c(f);let E=G(((x=(w=e.oils)==null?void 0:w.getTotalOilsGrams)==null?void 0:x.call(w))||0,0);if(E<=0)return 0;let P=M((k=document.getElementById(g))==null?void 0:k.value);return P<=0?0:P/E*100}function i(){var _,g,t,f,E,P,w,x;return{lactatePct:U({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:U({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:U({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:U({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((g=(_=document.getElementById("additiveLactateName"))==null?void 0:_.value)==null?void 0:g.trim())||"Sodium Lactate",sugarName:((f=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:f.trim())||"Sugar",saltName:((P=(E=document.getElementById("additiveSaltName"))==null?void 0:E.value)==null?void 0:P.trim())||"Salt",citricName:((x=(w=document.getElementById("additiveCitricName"))==null?void 0:w.value)==null?void 0:x.trim())||"Citric Acid"}}function B(){var g;return(((g=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:g.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function m(_){let g=G(c(_),0),t=G(U({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),f=G(U({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),E=G(U({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),P=G(U({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),w=g*(t/100),x=g*(f/100),k=g*(E/100),H=g*(P/100),u=B()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:f,saltPct:E,citricPct:P,lactateG:w,sugarG:x,saltG:k,citricG:H,citricLyeG:H*u}}function a({pctId:_,weightId:g,sourceField:t,totalOils:f}){let E=document.getElementById(_),P=document.getElementById(g);if(!E||!P)return;let w=G(c(f),0);if(w<=0)return;if(t==="weight"){let u=P.value;if(u===""||u===null||u===void 0){E.value="";return}let I=G(M(u),0),v=I>0?I/w*100:0;E.value=v>0?h(v,2):"";return}let x=E.value;if(x===""||x===null||x===void 0){P.value="";return}let k=G(c(x),0),H=w*(k/100);P.value=H>0?h(q(H),2):""}function n(_){let g=(f,E)=>{let P=document.getElementById(f);if(P)if(P.tagName==="INPUT"){if(document.activeElement===P)return;P.value=E}else P.textContent=E},t=f=>f>0?h(q(f),2):"";g("additiveLactateWeight",t(c(_==null?void 0:_.lactateG))),g("additiveSugarWeight",t(c(_==null?void 0:_.sugarG))),g("additiveSaltWeight",t(c(_==null?void 0:_.saltG))),g("additiveCitricWeight",t(c(_==null?void 0:_.citricG))),g("additiveCitricLyeOut",K(c(_==null?void 0:_.citricLyeG)))}function r(_){let g=G(c(_),0),t=m(g);return n(t),t}function d(_){let g=_.querySelector(".fragrance-typeahead"),t=_.querySelector(".fragrance-gi-id"),f=_.querySelector(".fragrance-default-unit"),E=_.querySelector(".fragrance-category"),P=_.querySelector('[data-role="suggestions"]');if(!g||!P||typeof N.attachMergedInventoryGlobalTypeahead!="function")return;let w=z();N.attachMergedInventoryGlobalTypeahead({inputEl:g,listEl:P,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:w,searchType:"ingredient",resultFilter:(x,k)=>{let H=S(x);return H?A.has(H):k==="inventory"},requireHidden:!1,onSelection:function(x){f&&(f.value=(x==null?void 0:x.default_unit)||""),E&&(E.value=(x==null?void 0:x.ingredient_category_name)||""),e.storage.queueStateSave()}}),g.addEventListener("input",function(){this.value.trim()||(f&&(f.value=""),E&&(E.value=""))})}function l(){var t,f;let _=document.getElementById("fragranceRowTemplate"),g=(f=(t=_==null?void 0:_.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:f.cloneNode(!0);return g?(g.querySelectorAll("input").forEach(E=>{E.value=""}),d(g),g.querySelectorAll(".unit-suffix").forEach(E=>{E.dataset.suffix=F.currentUnit}),g):document.createElement("div")}function O(_){let g=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=G(_||e.oils.getTotalOilsGrams()||0,0),f=0,E=0;g.forEach(x=>{let k=x.querySelector(".fragrance-grams"),H=x.querySelector(".fragrance-percent");if(!k||!H)return;let u=k.value,I=H.value,v=M(u),b=G(c(I),0),T=e.state.lastFragranceEdit,R=T&&T.row===x?T.field:null;t>0&&(R==="percent"?(v=t*(b/100),k.value=v>0?h(q(v),2):""):R==="grams"?(b=v/t*100,H.value=b>0?h(b,2):""):v>0?(b=v/t*100,document.activeElement!==H&&(H.value=h(b,2))):b>0&&(v=t*(b/100),document.activeElement!==k&&(k.value=h(q(v),2)))),v>0&&(f+=v),E+=b});let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent=h(E,2));let w=document.getElementById("fragranceTotalComputed");return w&&(w.textContent=f>0?K(f):"--"),{totalGrams:f,totalPct:E}}function p(){let _=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(g=>{var k,H,u,I,v,b,T;let t=((H=(k=g.querySelector(".fragrance-typeahead"))==null?void 0:k.value)==null?void 0:H.trim())||"",f=((u=g.querySelector(".fragrance-grams"))==null?void 0:u.value)||"",E=((I=g.querySelector(".fragrance-percent"))==null?void 0:I.value)||"",P=((v=g.querySelector(".fragrance-gi-id"))==null?void 0:v.value)||"",w=((b=g.querySelector(".fragrance-default-unit"))==null?void 0:b.value)||"",x=((T=g.querySelector(".fragrance-category"))==null?void 0:T.value)||"";!t&&!f&&!E&&!P||_.push({name:t,grams:f,percent:E,gi:P,defaultUnit:w,categoryName:x})}),_}function C(_){let g=document.getElementById("soapVisualGuidanceList");if(!g)return;let t=Array.isArray(_==null?void 0:_.tips)&&_.tips.length?_.tips:["No visual flags detected for this formula."];g.innerHTML=t.map(f=>`<li>${f}</li>`).join("")}function S(_){return!_||typeof _!="object"?null:_.ingredient&&_.ingredient.ingredient_category_name||_.ingredient_category_name||_.ingredient_category&&_.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:L,collectAdditiveSettings:i,syncAdditivePair:a,applyComputedOutputs:n,updateAdditivesOutput:r,updateVisualGuidance:C},e.fragrances={buildFragranceRow:l,updateFragranceTotals:O,collectFragranceData:p}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{toNumber:c}=e.helpers,{STAGE_CONFIGS:h}=e.constants;function G(q){var L;let A=h[q];if(!A)return;let F=document.getElementById(A.tabId);if(F){if((L=N.bootstrap)!=null&&L.Tab)bootstrap.Tab.getOrCreateInstance(F).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(i=>{i.classList.remove("show","active")}),F.classList.add("active"),F.setAttribute("aria-selected","true");let U=document.getElementById(A.paneId);U&&U.classList.add("show","active")}e.layout.scheduleStageHeightSync(),F.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function z(q){var A,F;if(q===1){let L=document.getElementById("unitGrams");L&&(L.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let U=document.getElementById("moldCylinderCorrection");U&&(U.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(A=e.mold)!=null&&A.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(q===2){let L=document.getElementById("oilRows");L&&(L.innerHTML="",L.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(q===3){let L=document.getElementById("lyeTypeNaoh");L&&(L.checked=!0);let U=document.getElementById("waterMethod");U&&(U.value="percent");let i=document.getElementById("lyeSuperfat");i&&(i.value="5");let B=document.getElementById("lyePurity");B&&(B.value="100");let m=document.getElementById("waterPct");m&&(m.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(q===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(L=>{let U=document.getElementById(L);U&&(U.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(L=>{let U=document.getElementById(L);U&&(U.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),q===5){let L=document.getElementById("fragranceRows");L&&(L.innerHTML="",(F=e.fragrances)!=null&&F.buildFragranceRow&&L.appendChild(e.fragrances.buildFragranceRow()));let U=document.getElementById("fragrancePercentTotal");U&&(U.textContent="0");let i=document.getElementById("fragranceTotalComputed");i&&(i.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),M()}function K(q){var A;if(q===1){let F=c(document.getElementById("moldWaterWeight").value),L=c(document.getElementById("oilTotalTarget").value),U=c(document.getElementById("moldOilPct").value),B=!!document.querySelector('input[name="weight_unit"]:checked')&&(F>0||L>0)&&U>0;return{state:B?"complete":"incomplete",label:B?"Sized":"Needs target"}}if(q===2){let L=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(U=>{var a,n,r,d;let i=(n=(a=U.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),B=c((r=U.querySelector(".oil-grams"))==null?void 0:r.value),m=c((d=U.querySelector(".oil-percent"))==null?void 0:d.value);return i&&(B>0||m>0)});return{state:L?"complete":"incomplete",label:L?"Oils added":"Add oils"}}if(q===3){let F=c(document.getElementById("lyeSuperfat").value),L=(A=document.getElementById("waterMethod"))==null?void 0:A.value,i=!!document.querySelector('input[name="lye_type"]:checked')&&!!L&&F>=0;return{state:i?"complete":"incomplete",label:i?"Configured":"Set lye"}}return q===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(L=>c(document.getElementById(L).value)>0)?"Added":"Optional"}:q===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(U=>{var a,n,r,d;let i=(n=(a=U.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),B=c((r=U.querySelector(".fragrance-grams"))==null?void 0:r.value),m=c((d=U.querySelector(".fragrance-percent"))==null?void 0:d.value);return i||B>0||m>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function M(){let q=document.getElementById("soapStageTabList");q&&q.querySelectorAll(".soap-stage-status").forEach(F=>F.remove());let A=document.getElementById("soapStageProgress");A&&(A.textContent="")}e.stages={openStageByIndex:G,resetStage:z,updateStageStatuses:M}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h,clamp:G}=e.helpers,{computeFattyAcids:z,computeQualities:K,computeOilQualityScores:M}=e.calc,{QUALITY_RANGES:q,QUALITY_HINTS:A,QUALITY_FEEL_HINTS:F,IODINE_RANGE:L,IODINE_SCALE_MAX:U,INS_RANGE:i,INS_SCALE_MAX:B,QUALITY_BASE:m,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:l}=e.ui;function O({barId:x,fillId:k,value:H,max:u,label:I}){let v=document.getElementById(x),b=document.getElementById(k);if(!v||!b)return null;let T=isFinite(H)?H:0,R=Math.max(0,Math.min(u,T)),D=u>0?R/u*100:0;return b.style.width=`${D}%`,v.setAttribute("aria-valuemin","0"),v.setAttribute("aria-valuemax",String(u)),v.setAttribute("aria-valuenow",R.toFixed(1)),I&&v.setAttribute("aria-label",I),{bar:v,fill:b,value:T}}function p(x,k,H){if(!(!x||!H)){if(x.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(k)){x.classList.add("bg-secondary");return}k<H[0]?x.classList.add("bg-warning"):k>H[1]?x.classList.add("bg-danger"):x.classList.add("bg-success")}}function C(x,k,H,u,I,v){let b=O({barId:x,fillId:k,value:H,max:I,label:v});b&&p(b.fill,H,u)}function S(){let x={hardness:{range:q.hardness,scale:100},cleansing:{range:q.cleansing,scale:100},conditioning:{range:q.conditioning,scale:100},bubbly:{range:q.bubbly,scale:100},creamy:{range:q.creamy,scale:100},iodine:{range:L,scale:U},ins:{range:i,scale:B}};Object.entries(x).forEach(([k,H])=>{let[u,I]=H.range,v=H.scale,b=k.charAt(0).toUpperCase()+k.slice(1),T=k==="iodine"?"iodineBar":k==="ins"?"insBar":`quality${b}Bar`,R=document.getElementById(`quality${b}Safe`);if(R){let j=Math.max(0,Math.min(100,u/v*100)),$=Math.max(0,Math.min(100,(I-u)/v*100));R.style.left=`${j}%`,R.style.width=`${$}%`,R.title=`Safe range ${c(u,0)}-${c(I,0)}`}let D=document.getElementById(T);D&&(D.dataset.safeRange=`${c(u,0)}-${c(I,0)}`);let Q=document.getElementById(`quality${b}RangeMin`),Y=document.getElementById(`quality${b}RangeMax`);Q&&(Q.textContent=c(u,0)),Y&&(Y.textContent=c(I,0))})}function _(x,k){let H=G(x.hardness||0,0,100),u=G(x.bubbly||0,0,100),I=G(x.conditioning||0,0,100),v=G(I+(k||0)*3,0,100),b=document.getElementById("feelHardness"),T=document.getElementById("feelBubbly"),R=document.getElementById("feelConditioning"),D=document.getElementById("feelGreasy");b&&(b.value=c(H,1)),T&&(T.value=c(u,1)),R&&(R.value=c(I,1)),D&&(D.value=c(v,1))}function g(x){r.forEach(k=>{let H=document.getElementById(`fattyBar${k.charAt(0).toUpperCase()}${k.slice(1)}`);if(!H)return;let u=G(h(x[k]),0,100),I=u;H.style.width=`${I}%`,H.style.backgroundColor=n[k]||"var(--color-muted)",H.title=`${k.charAt(0).toUpperCase()}${k.slice(1)}: ${c(u,1)}%`})}function t(){var u;let x=((u=document.getElementById("qualityPreset"))==null?void 0:u.value)||"balanced",k=Array.from(document.querySelectorAll(".quality-focus:checked"));if(x==="none"&&!k.length)return null;let H=x==="none"?{...m}:a[x]?{...a[x]}:{...m};return k.forEach(I=>{let v=I.dataset.attr,b=I.dataset.direction,T=q[v];T&&(H[v]=b==="low"?T[0]:T[1])}),H}function f(){let x=t(),k={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(k).forEach(([H,u])=>{if(!u)return;let I=document.getElementById(`${u.id}Label`);if(!x){u.classList.add("d-none"),I&&(I.textContent="");return}let v=h(x[H]);if(!isFinite(v)){u.classList.add("d-none"),I&&(I.textContent="");return}let b=H==="iodine"?U:H==="ins"?B:100,T=G(v,0,b);u.classList.remove("d-none"),u.style.left=`${T/b*100}%`,u.setAttribute("aria-label",`Apply ${H} target`),u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.title=`Target ${H}: ${c(v,1)}`,I&&(I.textContent=c(v,1))})}function E(){let x=t();if(!x){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let H=Array.from(document.querySelectorAll("#oilRows .oil-row")).map($=>{var se,me;let J=e.units.toGrams((se=$.querySelector(".oil-grams"))==null?void 0:se.value),X=((me=$.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ae=null;if(X)try{ae=JSON.parse(X)}catch{ae=null}return{row:$,grams:J,fattyProfile:ae}}).filter($=>$.grams>0);if(!H.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let u=z(H.map($=>({grams:$.grams,fattyProfile:$.fattyProfile}))),I=K(u.percent),v={hardness:G((x.hardness-I.hardness)/100,-1,1),cleansing:G((x.cleansing-I.cleansing)/100,-1,1),conditioning:G((x.conditioning-I.conditioning)/100,-1,1),bubbly:G((x.bubbly-I.bubbly)/100,-1,1),creamy:G((x.creamy-I.creamy)/100,-1,1)},b=H.reduce(($,J)=>$+J.grams,0),T=[],R=0,D=.8,Q=H.filter($=>!$.fattyProfile||typeof $.fattyProfile!="object").length;if(Q===H.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(Q&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),H.forEach($=>{let J=M($.fattyProfile),X=v.hardness*J.hardness+v.cleansing*J.cleansing+v.conditioning*J.conditioning+v.bubbly*J.bubbly+v.creamy*J.creamy,ae=G(1+X*D,.2,1.8),se=$.grams*ae;T.push({row:$.row,grams:se}),R+=se}),R<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let Y=b/R,j=e.oils.getOilTargetGrams()||b;T.forEach($=>{let J=$.grams*Y,X=$.row.querySelector(".oil-grams"),ae=$.row.querySelector(".oil-percent");if(X&&(X.value=J>0?c(e.units.fromGrams(J),2):""),ae&&j>0){let se=J/j*100;ae.value=se>0?c(se,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function P(x){let{qualities:k,fattyPercent:H,coveragePct:u,iodine:I,ins:v,sapAvg:b,superfat:T,warnings:R}=x,D=u>0;function Q(ce,re){var y,W;let ye=document.getElementById(`quality${ce}Value`),pe=document.getElementById(`quality${ce}Hint`);if(!ye)return;ye.textContent=D&&isFinite(re)?c(re,1):"--",d(ye);let Se=ce.toLowerCase(),o=q[Se],s=O({barId:`quality${ce}Bar`,fillId:`quality${ce}Fill`,value:D?re:0,max:100,label:ce});s&&o&&(p(s.fill,re,o),D&&isFinite(re)?s.bar.title=`${ce}: ${c(re,1)} (safe ${o[0]}-${o[1]}). ${A[Se]||""}`.trim():s.bar.title=`${ce}: -- (safe ${o[0]}-${o[1]}). ${A[Se]||""}`.trim()),pe&&o&&(!D||!isFinite(re)?pe.textContent="":re<o[0]?pe.textContent=((y=F[Se])==null?void 0:y.low)||"":re>o[1]?pe.textContent=((W=F[Se])==null?void 0:W.high)||"":pe.textContent="")}Q("Hardness",k.hardness),Q("Cleansing",k.cleansing),Q("Conditioning",k.conditioning),Q("Bubbly",k.bubbly),Q("Creamy",k.creamy);let Y=document.getElementById("fattyCoverageNote");Y&&(Y.textContent=u>0?`Fatty acid coverage: ${c(u,1)}% of oils`:"Fatty acid coverage: not enough data yet");let j=document.getElementById("iodineValue"),$=document.getElementById("insValue"),J=document.getElementById("sapAvgValue");j&&(j.textContent=I>0?c(I,1):"--",d(j)),$&&($.textContent=v>0?c(v,1):"--",d($)),J&&(J.textContent=b>0?c(b,1):"--",d(J)),C("iodineBar","iodineFill",I,L,U,"Iodine"),C("insBar","insFill",v,i,B,"INS");let X=(H.lauric||0)+(H.myristic||0)+(H.palmitic||0)+(H.stearic||0),ae=(H.ricinoleic||0)+(H.oleic||0)+(H.linoleic||0)+(H.linolenic||0),se=document.getElementById("fattySatRatioResult");se&&(se.textContent=X+ae>0?`${c(X,0)}:${c(ae,0)}`:"--",d(se)),r.forEach(ce=>{let re=`fatty${ce.charAt(0).toUpperCase()}${ce.slice(1)}`,ye=H[ce];document.getElementById(re).textContent=D&&ye?`${c(ye,1)}%`:"--"}),_(k,T||0),g(H),f();let me=Array.isArray(R)?R.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(ce=>`<li>${ce}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var x;document.querySelectorAll(".soap-quality-help").forEach(k=>{let H=k.dataset.quality;A[H]&&k.setAttribute("title",A[H])}),(x=N.bootstrap)!=null&&x.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(k=>{bootstrap.Tooltip.getOrCreateInstance(k)})}e.quality={setQualityRangeBars:S,updateQualityTargets:f,applyQualityTargets:E,updateQualitiesDisplay:P,initQualityTooltips:w}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h,clamp:G}=e.helpers;function z(i){let B=0,m=0;return(i||[]).forEach(a=>{let n=h(a==null?void 0:a.sapKoh),r=h(a==null?void 0:a.grams);n>0&&r>0&&(B+=n*r,m+=r)}),m>0?B/m:0}function K(i){var O,p,C,S,_,g,t,f,E,P,w,x;let B=i.qualityReport||{},m=B.fatty_acids_pct||{},a=B.qualities||{},n=isFinite(i.sapAvg)&&i.sapAvg>0?i.sapAvg:h(B.sap_avg_koh)||z(i.oils||[]),r=h(B.iodine),d=h(B.ins)||(n&&r?n-r:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((O=document.getElementById("qualityPreset"))==null?void 0:O.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(k=>k.id),mold:l,oils:(i.oils||[]).map(k=>({name:k.name||null,grams:c(k.grams||0,2),iodine:k.iodine||null,sap_koh:k.sapKoh||null,fatty_profile:k.fattyProfile||null,global_item_id:k.global_item_id||null,default_unit:k.default_unit||null,ingredient_category_name:k.ingredient_category_name||null})),totals:{total_oils_g:c(i.totalOils||0,2),batch_yield_g:c(i.batchYield||0,2),lye_pure_g:c(i.lyePure||0,2),lye_adjusted_g:c(i.lyeAdjusted||0,2),water_g:c(i.water||0,2)},lye:{lye_type:i.lyeType,superfat:i.superfat,purity:i.purity,water_method:i.waterMethod,water_pct:i.waterPct,lye_concentration:i.lyeConcentration,water_ratio:i.waterRatio},additives:{fragrance_pct:((p=i.additives)==null?void 0:p.fragrancePct)||0,lactate_pct:((C=i.additives)==null?void 0:C.lactatePct)||0,sugar_pct:((S=i.additives)==null?void 0:S.sugarPct)||0,salt_pct:((_=i.additives)==null?void 0:_.saltPct)||0,citric_pct:((g=i.additives)==null?void 0:g.citricPct)||0,fragrance_g:c(((t=i.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:c(((f=i.additives)==null?void 0:f.lactateG)||0,2),sugar_g:c(((E=i.additives)==null?void 0:E.sugarG)||0,2),salt_g:c(((P=i.additives)==null?void 0:P.saltG)||0,2),citric_g:c(((w=i.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:c(((x=i.additives)==null?void 0:x.citricLyeG)||0,2)},qualities:{hardness:c(a.hardness||0,1),cleansing:c(a.cleansing||0,1),conditioning:c(a.conditioning||0,1),bubbly:c(a.bubbly||0,1),creamy:c(a.creamy||0,1),iodine:c(r||0,1),ins:c(d||0,1),sap_avg:c(n||0,1)},fatty_acids:m,updated_at:new Date().toISOString()}}function M(i,B,m,a,n){var p,C,S,_,g;let r=(C=(p=document.getElementById(i))==null?void 0:p.value)==null?void 0:C.trim(),d=((S=document.getElementById(B))==null?void 0:S.value)||"",l=a&&((_=document.getElementById(a))==null?void 0:_.value)||"",O=n&&((g=document.getElementById(n))==null?void 0:g.value)||"";return{name:r||m,globalItemId:d?parseInt(d):void 0,defaultUnit:l||void 0,categoryName:O||void 0}}function q(i){let B=[],m=G(i||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var _,g,t,f,E,P,w;let n=(g=(_=a.querySelector(".fragrance-typeahead"))==null?void 0:_.value)==null?void 0:g.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((f=a.querySelector(".fragrance-default-unit"))==null?void 0:f.value)||"",l=((E=a.querySelector(".fragrance-category"))==null?void 0:E.value)||"",O=(P=a.querySelector(".fragrance-grams"))==null?void 0:P.value,p=(w=a.querySelector(".fragrance-percent"))==null?void 0:w.value,C=e.units.toGrams(O),S=G(h(p),0);C<=0&&S>0&&m>0&&(C=m*(S/100)),!(!n&&!r&&C<=0)&&B.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:l||void 0,grams:C,pct:S})}),B}function A(i,B){let m=[];return document.querySelectorAll(`#${i} .row`).forEach(function(a){var p,C,S;let n=(C=(p=a.querySelector(".tool-typeahead"))==null?void 0:p.value)==null?void 0:C.trim(),r=((S=a.querySelector(".tool-gi-id"))==null?void 0:S.value)||"",d=a.querySelector(".tool-qty"),l=a.querySelector(".tool-unit"),O=d&&d.value!=="";!n&&!r||(B==="container"?m.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:O?parseFloat(d.value):1}):m.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:O?parseFloat(d.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),m}function F(i){let B=e.config.isAuthenticated?"member":"public",m=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(i,{context:B,mode:m,unitOptionsHtml:e.config.unitOptionsHtml})}function L(i,B){let m=F(i),a=m.querySelector(".tool-typeahead"),n=m.querySelector(".tool-qty");a&&(a.value=B),n&&i==="container"&&(n.value=1),i==="container"?document.getElementById("tool-containers").appendChild(m):i==="consumable"?document.getElementById("tool-consumables").appendChild(m):document.getElementById("tool-ingredients").appendChild(m)}function U(i){var r,d,l,O;let B=K(i),m=(i.oils||[]).map(p=>({name:p.name||void 0,global_item_id:p.global_item_id||void 0,quantity:p.grams,unit:"gram",default_unit:p.default_unit||void 0,ingredient_category_name:p.ingredient_category_name||void 0})),a=i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(i.lyeAdjusted>0&&m.push({name:a,quantity:c(i.lyeAdjusted,2),unit:"gram"}),i.water>0&&m.push({name:"Distilled Water",quantity:c(i.water,2),unit:"gram"}),q(i.totalOils||0).forEach(p=>{p.grams>0&&m.push({name:p.name,global_item_id:p.globalItemId,quantity:c(p.grams,2),unit:"gram",default_unit:p.defaultUnit,ingredient_category_name:p.categoryName})}),((r=i.additives)==null?void 0:r.lactateG)>0){let p=M("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");m.push({name:p.name,global_item_id:p.globalItemId,quantity:c(i.additives.lactateG,2),unit:"gram",default_unit:p.defaultUnit,ingredient_category_name:p.categoryName})}if(((d=i.additives)==null?void 0:d.sugarG)>0){let p=M("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");m.push({name:p.name,global_item_id:p.globalItemId,quantity:c(i.additives.sugarG,2),unit:"gram",default_unit:p.defaultUnit,ingredient_category_name:p.categoryName})}if(((l=i.additives)==null?void 0:l.saltG)>0){let p=M("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");m.push({name:p.name,global_item_id:p.globalItemId,quantity:c(i.additives.saltG,2),unit:"gram",default_unit:p.defaultUnit,ingredient_category_name:p.categoryName})}if(((O=i.additives)==null?void 0:O.citricG)>0){let p=M("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");m.push({name:p.name,global_item_id:p.globalItemId,quantity:c(i.additives.citricG,2),unit:"gram",default_unit:p.defaultUnit,ingredient_category_name:p.categoryName}),m.push({name:"Extra Lye for Citric Acid",quantity:c(i.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((i.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:i.superfat,soap_lye_type:i.lyeType,soap_lye_purity:i.purity,soap_water_method:i.waterMethod,soap_water_pct:i.waterPct,soap_lye_concentration:i.lyeConcentration,soap_water_ratio:i.waterRatio,soap_oils_total_g:i.totalOils,soap_lye_g:i.lyeAdjusted,soap_water_g:i.water},ingredients:m.concat(A("tool-ingredients","ingredient")),consumables:A("tool-consumables","consumable"),containers:A("tool-containers","container"),notes:JSON.stringify(B)}}e.recipePayload={collectFragranceRows:q,collectDraftLines:A,buildLineRow:F,addStubLine:L,buildSoapRecipePayload:U}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h,clamp:G}=e.helpers,{formatWeight:z,formatPercent:K}=e.units;function M(){var O;let a=((O=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:O.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,d=h(n==null?void 0:n.value),l=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:l,purity:d}}function q(){let a=document.getElementById("lyePurity"),n=M();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function A(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function F(a=null,n=null){var O;let r=document.getElementById("stageWaterOutput"),d=document.getElementById("stageWaterComputedHint"),l=n||(a==null?void 0:a.waterMethod)||((O=document.getElementById("waterMethod"))==null?void 0:O.value)||"percent";if(r){let p=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=p?z(a.waterG):"--"}if(d){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){d.textContent=`Set oils in Stage 2 to calculate water. ${A(l)}`;return}if(l==="concentration"){let p=a.lyeConcentrationInput||a.lyeConcentration||0;d.textContent=`Using ${c(p,1)}% lye concentration from ${z(a.lyeAdjusted||0)} lye.`;return}if(l==="ratio"){let p=a.waterRatioInput||a.waterRatio||0;d.textContent=`Using ${c(p,2)} : 1 water-to-lye ratio from ${z(a.lyeAdjusted||0)} lye.`;return}d.textContent=`Using ${c(a.waterPct||0,1)}% of total oils (${z(a.totalOils)}).`}}function L(a=null,n=null){var P;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),O=document.getElementById("concPreview"),p=document.getElementById("ratioPreview");if(!r&&!d&&!l&&!O&&!p)return;let C=(w,x)=>{w&&(w.textContent=x)},S=n||(a==null?void 0:a.waterMethod)||((P=document.getElementById("waterMethod"))==null?void 0:P.value)||"percent",_=h(a==null?void 0:a.totalOils),g=h(a==null?void 0:a.lyeAdjusted),t=h(a==null?void 0:a.waterG);if(_<=0||g<=0){C(r,"Based on -- oils. All values update live as you change inputs."),C(d,"--"),C(l,"--"),C(O,"--"),C(p,"--");return}let f=h(a==null?void 0:a.lyeConcentration)>0?h(a==null?void 0:a.lyeConcentration):g+t>0?g/(g+t)*100:0,E=h(a==null?void 0:a.waterRatio)>0?h(a==null?void 0:a.waterRatio):g>0?t/g:0;if(C(r,`Based on ${z(_)} oils. All values update live as you change inputs.`),C(d,z(g)),C(l,z(t)),C(O,f>0?K(f):"--"),C(p,E>0?`${c(E,2)} : 1`:"--"),S==="concentration"){let w=h(a==null?void 0:a.lyeConcentrationInput);w>0&&C(O,K(w))}if(S==="ratio"){let w=h(a==null?void 0:a.waterRatioInput);w>0&&C(p,`${c(w,2)} : 1`)}}function U(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),F(null,a),L(null,a)}function i(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,d=[],l=e.oils.collectOilData(),O=e.oils.getOilTargetGrams(),C=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(S=>G(h(S.value),0)).some(S=>S>0);return(!l.length||n<=0)&&d.push("Add at least one oil with a weight or percent."),!O&&n<=0&&C&&d.push("Enter a total oils target or weights to convert percentages."),O>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),O>0&&n>O+.01?d.push("Oil weights exceed the mold target."):!O&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:l}}function B(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=h(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function m(){var p,C,S,_;let n=M().purity;isFinite(n)||(n=100);let r=((p=document.getElementById("waterMethod"))==null?void 0:p.value)||"percent",d=h((C=document.getElementById("waterPct"))==null?void 0:C.value),l=h((S=document.getElementById("lyeConcentration"))==null?void 0:S.value),O=h((_=document.getElementById("waterRatio"))==null?void 0:_.value);return{purity:n,waterMethod:r,waterPct:d,lyeConcentration:l,waterRatio:O}}e.runnerInputs={getLyeSelection:M,applyLyeSelection:q,setWaterMethod:U,updateStageWaterSummary:F,updateLiveCalculationPreview:L,validateCalculation:i,readSuperfatInput:B,sanitizeLyeInputs:m}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{getStorage:c}=e.helpers;function h(){if(!e.config.calcLimit)return{count:0,date:null};let q=c();if(!q)return{count:0,date:null};try{let A=q.getItem("soap_calc_usage"),F=new Date().toISOString().slice(0,10);if(!A)return{count:0,date:F};let L=JSON.parse(A);return!L||L.date!==F?{count:0,date:F}:{count:Number(L.count)||0,date:F}}catch{return{count:0,date:null}}}function G(q){if(!e.config.calcLimit)return;let A=c();if(!A)return;let F=new Date().toISOString().slice(0,10);try{A.setItem("soap_calc_usage",JSON.stringify({count:q,date:F}))}catch{}}function z(){return e.config.calcLimit&&h().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function K(){if(!e.config.calcLimit)return;let A=h().count+1;G(A);let F=Math.max(0,e.config.calcLimit-A);F<=1&&e.ui.showSoapAlert("info",`You have ${F} calculation${F===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function M(q){if(!e.config.calcLimit||q===null||q>1)return;let A=document.getElementById("soapSignupModal");A&&(N.bootstrap&&N.bootstrap.Modal?N.bootstrap.Modal.getOrCreateInstance(A).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:z,consumeCalcQuota:K,maybeShowSignupModal:M}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.state;function h({oils:z,selection:K,superfat:M,purity:q,waterMethod:A,waterPct:F,lyeConcentration:L,waterRatio:U,totalOils:i}){let B=e.additives.collectAdditiveSettings(),m=e.recipePayload.collectFragranceRows(i||0);return{oils:(z||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:m.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:B.lactatePct||0,sugar_pct:B.sugarPct||0,salt_pct:B.saltPct||0,citric_pct:B.citricPct||0,lactate_name:B.lactateName||"Sodium Lactate",sugar_name:B.sugarName||"Sugar",salt_name:B.saltName||"Salt",citric_name:B.citricName||"Citric Acid"},lye:{selected:(K==null?void 0:K.selected)||"NaOH",superfat:M,purity:q},water:{method:A,water_pct:F,lye_concentration:L,water_ratio:U},meta:{unit_display:c.currentUnit||"g"}}}async function G(z){var A;let K=((A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"))||"",M=new AbortController,q=N.setTimeout(()=>M.abort(),2500);try{let F=await fetch("/tools/api/soap/calculate",{method:"POST",signal:M.signal,headers:{"Content-Type":"application/json",...K?{"X-CSRFToken":K}:{}},body:JSON.stringify(z||{})});if(!F.ok)return null;let L=await F.json();return!L||L.success!==!0||typeof L.result!="object"?null:L.result}catch{return null}finally{N.clearTimeout(q)}}e.runnerService={buildServicePayload:h,calculateWithSoapService:G}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{round:c,toNumber:h}=e.helpers,{formatWeight:G,formatPercent:z}=e.units,K=e.state,M={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function q(i){return(i||[]).map(B=>{var m;return{name:B.name||null,grams:h(B.grams),sapKoh:h((m=B.sap_koh)!=null?m:B.sapKoh),iodine:h(B.iodine),fattyProfile:B.fatty_profile||B.fattyProfile||null,global_item_id:B.global_item_id||null,default_unit:B.default_unit||null,ingredient_category_name:B.ingredient_category_name||null}})}function A(i,B){let m=document.getElementById(i);m&&(m.textContent=B)}function F({resultsCard:i,lyeAdjusted:B,waterData:m,batchYield:a,totalOils:n,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let l=h(i.water_lye_ratio)||m.waterRatio;A("lyeAdjustedOutput",G(h(i.lye_adjusted_g)||B)),A("waterOutput",G(h(i.water_g)||m.waterG)),A("batchYieldOutput",G(a)),A("lyeConcentrationOutput",z(h(i.lye_concentration_pct)||m.lyeConcentration)),A("waterRatioOutput",isFinite(l)&&l>0?c(l,2).toString():"--"),A("totalOilsOutput",G(n)),A("superfatOutput",z(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(O=>e.ui.pulseValue(document.getElementById(O)))}function L({showAlerts:i,lyeTotals:B,purity:m,waterData:a}){if(!i)return;B.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),m<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${c(m,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function U({serviceResult:i,validation:B,selection:m,superfat:a,purity:n,waterMethod:r,waterPct:d,lyeConcentrationInput:l,waterRatioInput:O,showAlerts:p}){var $;let C=i.lye_type||m.lyeType||"NaOH",S=i.lye_selected||m.selected||null,_=h(i.total_oils_g)||B.totals.totalWeight,g=h(i.superfat_pct),t=isFinite(g)?g:a,f={sapAvg:h(i.sap_avg_koh),usedFallback:!!i.used_sap_fallback},E=h(i.lye_pure_g),w=Object.prototype.hasOwnProperty.call(i,"lye_adjusted_base_g")?h(i.lye_adjusted_base_g):null,x=h(i.lye_adjusted_g),k=h(i.lye_purity_pct)||n,H=i.water_method||r,u=h(i.water_pct)||d,I=h(i.lye_concentration_input_pct)||l,v=h(i.water_ratio_input)||O,b={waterG:h(i.water_g),lyeConcentration:h(i.lye_concentration_pct),waterRatio:h(i.water_lye_ratio)},T=i.results_card||{},R=i.quality_report||{},D=q(i.oils||B.oils),Q={waterG:b.waterG,lyeAdjusted:x,totalOils:_,waterMethod:H,waterPct:u,lyeConcentrationInput:I,waterRatioInput:v,lyeConcentration:b.lyeConcentration,waterRatio:b.waterRatio};e.runnerInputs.updateStageWaterSummary(Q),e.runnerInputs.updateLiveCalculationPreview(Q);let Y=i.additives||M;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(Y);let j=h(T.batch_yield_g)||_+x+b.waterG+Y.fragranceG+Y.lactateG+Y.sugarG+Y.saltG+Y.citricG;return($=e.mold)!=null&&$.updateWetBatterWarning&&e.mold.updateWetBatterWarning(j),F({resultsCard:T,lyeAdjusted:x,waterData:b,batchYield:j,totalOils:_,superfat:t}),e.ui.updateResultsWarnings(b),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:R.qualities||{},fattyPercent:R.fatty_acids_pct||{},coveragePct:h(R.coverage_pct),iodine:h(R.iodine),ins:h(R.ins),sapAvg:f.sapAvg,superfat:t,waterData:b,additives:Y,oils:D,totalOils:_,warnings:R.warnings||[]}),e.additives.updateVisualGuidance({tips:R.visual_guidance||[]}),e.stages.updateStageStatuses(),L({showAlerts:p,lyeTotals:f,purity:k,waterData:b}),K.lastCalc={totalOils:_,oils:D,lyeType:C,lyeSelected:S,superfat:t,purity:k,lyePure:E,lyeAdjustedBase:w,lyeAdjusted:x,water:b.waterG,waterMethod:H,waterPct:u,lyeConcentration:b.lyeConcentration,waterRatio:b.waterRatio,sapAvg:f.sapAvg,usedSapFallback:f.usedFallback,additives:Y,batchYield:j,qualityReport:R,export:i.export||null},K.lastCalc}e.runnerRender={applyServiceResult:U}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},c=e.state,h=e.runnerInputs,G=e.runnerQuota,z=e.runnerService,K=e.runnerRender;async function M(q={}){var F;let A={consumeQuota:!1,showAlerts:!0,...q};try{A.showAlerts&&e.ui.clearSoapAlerts();let L=h.validateCalculation();if(!L.ok)return h.updateStageWaterSummary(null),h.updateLiveCalculationPreview(null),(F=e.mold)!=null&&F.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),A.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${L.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(A.consumeQuota&&!G.canConsumeCalcQuota())return null;let U=h.readSuperfatInput(),i=h.getLyeSelection(),B=h.sanitizeLyeInputs(),m=(c.calcRequestSeq||0)+1;c.calcRequestSeq=m;let a=z.buildServicePayload({oils:L.oils,selection:i,superfat:U,purity:B.purity,waterMethod:B.waterMethod,waterPct:B.waterPct,lyeConcentration:B.lyeConcentration,waterRatio:B.waterRatio,totalOils:L.totals.totalWeight}),n=await z.calculateWithSoapService(a);if(m!==c.calcRequestSeq)return c.lastCalc;if(!n)return A.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=K.applyServiceResult({serviceResult:n,validation:L,selection:i,superfat:U,purity:B.purity,waterMethod:B.waterMethod,waterPct:B.waterPct,lyeConcentrationInput:B.lyeConcentration,waterRatioInput:B.waterRatio,showAlerts:A.showAlerts});return A.consumeQuota&&G.consumeCalcQuota(),r}catch{return A.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...q)=>h.getLyeSelection(...q),applyLyeSelection:(...q)=>h.applyLyeSelection(...q),setWaterMethod:(...q)=>h.setWaterMethod(...q),updateLiveCalculationPreview:(...q)=>h.updateLiveCalculationPreview(...q),calculateAll:M,buildSoapRecipePayload:(...q)=>e.recipePayload.buildSoapRecipePayload(...q),buildLineRow:(...q)=>e.recipePayload.buildLineRow(...q),addStubLine:(...q)=>e.recipePayload.addStubLine(...q),maybeShowSignupModal:(...q)=>G.maybeShowSignupModal(...q)}})(window);(function(N){"use strict";let e=N.SoapTool=N.SoapTool||{},{formatTime:c,getStorage:h}=e.helpers,G="soap_tool_state_v2";function z(m,a){let n=[];return document.querySelectorAll(`#${m} .row`).forEach(d=>{var _,g,t;let l=(g=(_=d.querySelector(".tool-typeahead"))==null?void 0:_.value)==null?void 0:g.trim(),O=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",p=d.querySelector(".tool-qty"),C=d.querySelector(".tool-unit"),S=p&&p.value!==""?e.helpers.toNumber(p.value):null;!l&&!O||(a==="container"?n.push({name:l||"",global_item_id:O?parseInt(O):null,quantity:S&&S>0?S:1}):n.push({name:l||"",global_item_id:O?parseInt(O):null,quantity:S&&S>=0?S:0,unit:(C==null?void 0:C.value)||"gram"}))}),n}function K(){let m=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var g,t,f,E,P,w,x,k,H,u;let n=((t=(g=a.querySelector(".oil-typeahead"))==null?void 0:g.value)==null?void 0:t.trim())||"",r=((f=a.querySelector(".oil-grams"))==null?void 0:f.value)||"",d=((E=a.querySelector(".oil-percent"))==null?void 0:E.value)||"",l=((P=a.querySelector(".oil-sap-koh"))==null?void 0:P.value)||"",O=((w=a.querySelector(".oil-iodine"))==null?void 0:w.value)||"",p=((x=a.querySelector(".oil-fatty"))==null?void 0:x.value)||"",C=((k=a.querySelector(".oil-gi-id"))==null?void 0:k.value)||"",S=((H=a.querySelector(".oil-default-unit"))==null?void 0:H.value)||"",_=((u=a.querySelector(".oil-category"))==null?void 0:u.value)||"";!n&&!r&&!d&&!C||m.push({name:n,grams:r,percent:d,sap:l,iodine:O,fattyRaw:p,gi:C,defaultUnit:S,categoryName:_})}),m}function M(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let m=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var S,_,g,t,f,E,P;let r=((_=(S=n.querySelector(".fragrance-typeahead"))==null?void 0:S.value)==null?void 0:_.trim())||"",d=((g=n.querySelector(".fragrance-grams"))==null?void 0:g.value)||"",l=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",O=((f=n.querySelector(".fragrance-gi-id"))==null?void 0:f.value)||"",p=((E=n.querySelector(".fragrance-default-unit"))==null?void 0:E.value)||"",C=((P=n.querySelector(".fragrance-category"))==null?void 0:P.value)||"";!r&&!d&&!l&&!O||m.push({name:r,grams:d,percent:l,gi:O,defaultUnit:p,categoryName:C})}),m}function q(m,a){let n=document.getElementById("oilRows");if(!n||!m)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=m.name||"",r.querySelector(".oil-grams").value=m.grams||"",r.querySelector(".oil-percent").value=m.percent||"",r.querySelector(".oil-sap-koh").value=m.sap||"",r.querySelector(".oil-iodine").value=m.iodine||"",r.querySelector(".oil-fatty").value=m.fattyRaw||"",r.querySelector(".oil-gi-id").value=m.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=m.defaultUnit||"");let l=r.querySelector(".oil-category");l&&(l.value=m.categoryName||"");let O=Array.from(n.children);return a>=O.length?n.appendChild(r):n.insertBefore(r,O[a]),r}function A(){var n,r,d,l,O,p,C,S,_,g,t,f,E,P,w,x,k,H,u,I,v,b,T,R,D,Q,Y;let m=h();if(!m)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:K(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((O=document.getElementById("waterPct"))==null?void 0:O.value)||"",lye_concentration:((p=document.getElementById("lyeConcentration"))==null?void 0:p.value)||"",water_ratio:((C=document.getElementById("waterRatio"))==null?void 0:C.value)||""},additives:{fragrances:M(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((S=document.getElementById("additiveLactateName"))==null?void 0:S.value)||"",lactate_gi:((_=document.getElementById("additiveLactateGi"))==null?void 0:_.value)||"",lactate_unit:((g=document.getElementById("additiveLactateUnit"))==null?void 0:g.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((f=document.getElementById("additiveSugarName"))==null?void 0:f.value)||"",sugar_gi:((E=document.getElementById("additiveSugarGi"))==null?void 0:E.value)||"",sugar_unit:((P=document.getElementById("additiveSugarUnit"))==null?void 0:P.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((x=document.getElementById("additiveSaltName"))==null?void 0:x.value)||"",salt_gi:((k=document.getElementById("additiveSaltGi"))==null?void 0:k.value)||"",salt_unit:((H=document.getElementById("additiveSaltUnit"))==null?void 0:H.value)||"",salt_category:((u=document.getElementById("additiveSaltCategory"))==null?void 0:u.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((I=document.getElementById("additiveCitricName"))==null?void 0:I.value)||"",citric_gi:((v=document.getElementById("additiveCitricGi"))==null?void 0:v.value)||"",citric_unit:((b=document.getElementById("additiveCitricUnit"))==null?void 0:b.value)||"",citric_category:((T=document.getElementById("additiveCitricCategory"))==null?void 0:T.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((R=document.getElementById("moldShape"))==null?void 0:R.value)||"loaf",cylinder_correction:!!((D=document.getElementById("moldCylinderCorrection"))!=null&&D.checked),cylinder_factor:((Q=document.getElementById("moldCylinderFactor"))==null?void 0:Q.value)||"0.85"},quality:{preset:((Y=document.getElementById("qualityPreset"))==null?void 0:Y.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(j=>j.id)},lines:{ingredients:z("tool-ingredients","ingredient"),consumables:z("tool-consumables","consumable"),containers:z("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{m.setItem(G,JSON.stringify(a));let j=document.getElementById("soapLastSaved");j&&(j.textContent=c(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function F(){var l,O,p;let m=h();if(!m)return;let a=m.getItem(G);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let C=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);C&&(C.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(S=>{let _=e.oils.buildOilRow();_.querySelector(".oil-typeahead").value=S.name||"",_.querySelector(".oil-grams").value=S.grams||"",_.querySelector(".oil-percent").value=S.percent||"",_.querySelector(".oil-sap-koh").value=S.sap||"",_.querySelector(".oil-iodine").value=S.iodine||"",_.querySelector(".oil-fatty").value=S.fattyRaw||"",_.querySelector(".oil-gi-id").value=S.gi||"";let g=_.querySelector(".oil-default-unit");g&&(g.value=S.defaultUnit||"");let t=_.querySelector(".oil-category");t&&(t.value=S.categoryName||""),r.appendChild(_)})),n.lye_form){let C=document.getElementById("lyeSuperfat");C&&(C.value=n.lye_form.superfat||"5");let S=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);S&&(S.checked=!0);let _=document.getElementById("lyePurity");_&&(_.value=n.lye_form.lye_purity||"100");let g=document.getElementById("waterMethod");g&&(g.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let f=document.getElementById("lyeConcentration");f&&(f.value=n.lye_form.lye_concentration||"");let E=document.getElementById("waterRatio");E&&(E.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let C=document.getElementById("fragranceRows");if(C&&((l=e.fragrances)!=null&&l.buildFragranceRow)){C.innerHTML="";let R=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(R)R.forEach(D=>{let Q=e.fragrances.buildFragranceRow();Q.querySelector(".fragrance-typeahead").value=D.name||"",Q.querySelector(".fragrance-grams").value=D.grams||"",Q.querySelector(".fragrance-percent").value=D.percent||"",Q.querySelector(".fragrance-gi-id").value=D.gi||"";let Y=Q.querySelector(".fragrance-default-unit");Y&&(Y.value=D.defaultUnit||"");let j=Q.querySelector(".fragrance-category");j&&(j.value=D.categoryName||""),C.appendChild(Q)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",D.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",D.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",C.appendChild(D)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let S=document.getElementById("additiveLactateName");S&&(S.value=n.additives.lactate_name||"");let _=document.getElementById("additiveLactateGi");_&&(_.value=n.additives.lactate_gi||"");let g=document.getElementById("additiveLactateUnit");g&&(g.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let f=document.getElementById("additiveSugarName");f&&(f.value=n.additives.sugar_name||"");let E=document.getElementById("additiveSugarGi");E&&(E.value=n.additives.sugar_gi||"");let P=document.getElementById("additiveSugarUnit");P&&(P.value=n.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let x=document.getElementById("additiveSaltName");x&&(x.value=n.additives.salt_name||"");let k=document.getElementById("additiveSaltGi");k&&(k.value=n.additives.salt_gi||"");let H=document.getElementById("additiveSaltUnit");H&&(H.value=n.additives.salt_unit||"");let u=document.getElementById("additiveSaltCategory");u&&(u.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let I=document.getElementById("additiveCitricName");I&&(I.value=n.additives.citric_name||"");let v=document.getElementById("additiveCitricGi");v&&(v.value=n.additives.citric_gi||"");let b=document.getElementById("additiveCitricUnit");b&&(b.value=n.additives.citric_unit||"");let T=document.getElementById("additiveCitricCategory");T&&(T.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let C=document.getElementById("moldShape");C&&(C.value=n.mold.shape||"loaf");let S=document.getElementById("moldCylinderCorrection");S&&(S.checked=!!n.mold.cylinder_correction);let _=document.getElementById("moldCylinderFactor");_&&(_.value=n.mold.cylinder_factor||"0.85");let g=document.getElementById("oilTotalTarget");(O=e.mold)!=null&&O.syncMoldPctFromTarget&&((p=e.mold)!=null&&p.syncTargetFromMold)&&(e.units.toGrams(g==null?void 0:g.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let C=document.getElementById("qualityPreset");if(C){let S=n.quality.preset||"balanced",_=Array.from(C.options).find(g=>g.value===S);C.value=_?S:"balanced"}document.querySelectorAll(".quality-focus").forEach(S=>{S.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(S.id)})}function d(C,S,_){let g=document.getElementById(C);g&&(g.innerHTML="",(S||[]).forEach(t=>{let f=e.runner.buildLineRow(_),E=f.querySelector(".tool-typeahead"),P=f.querySelector(".tool-gi-id"),w=f.querySelector(".tool-qty"),x=f.querySelector(".tool-unit");E&&(E.value=t.name||""),P&&(P.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),x&&t.unit&&Array.from(x.options).find(H=>H.value===t.unit)&&(x.value=t.unit),g.appendChild(f)}))}if(n.lines&&(d("tool-ingredients",n.lines.ingredients,"ingredient"),d("tool-consumables",n.lines.consumables,"consumable"),d("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let C=document.getElementById("soapLastSaved");C&&(C.textContent=c(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let L=null;function U(){L&&clearTimeout(L),L=setTimeout(A,350)}let i=null;function B(){i&&clearTimeout(i),i=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:A,restoreState:F,serializeLines:z,serializeOils:K,restoreOilRow:q,queueStateSave:U,queueAutoCalc:B}})(window);(function(N){"use strict";var pe,Se;let e=N.SoapTool=N.SoapTool||{},{LACTATE_CATEGORY_SET:c,SUGAR_CATEGORY_SET:h,SALT_CATEGORY_SET:G,CITRIC_CATEGORY_SET:z}=e.constants,{round:K,toNumber:M,clamp:q}=e.helpers,{formatWeight:A,formatPercent:F,toGrams:L}=e.units,U=e.state;async function i(){var s;let o=U.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return o||((s=e.ui)!=null&&s.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function B(o){let s=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(y=>{var oe,ie,ee,de;let W=(ie=(oe=y.querySelector(".fragrance-typeahead"))==null?void 0:oe.value)==null?void 0:ie.trim(),V=(ee=y.querySelector(".fragrance-grams"))==null?void 0:ee.value,Z=(de=y.querySelector(".fragrance-percent"))==null?void 0:de.value,te=L(V),le=q(M(Z),0);te<=0&&le>0&&o>0&&(te=o*(le/100)),!(te<=0&&le<=0&&!W)&&(!le&&te>0&&o>0&&(le=te/o*100),s.push({name:W||"Fragrance/Essential Oils",grams:te,pct:le}))}),s}function m(o){var te,le,oe,ie,ee,de,ve,he;let s=[];if(!o)return s;let y=((le=(te=document.getElementById("additiveLactateName"))==null?void 0:te.value)==null?void 0:le.trim())||"Sodium Lactate",W=((ie=(oe=document.getElementById("additiveSugarName"))==null?void 0:oe.value)==null?void 0:ie.trim())||"Sugar",V=((de=(ee=document.getElementById("additiveSaltName"))==null?void 0:ee.value)==null?void 0:de.trim())||"Salt",Z=((he=(ve=document.getElementById("additiveCitricName"))==null?void 0:ve.value)==null?void 0:he.trim())||"Citric Acid";return o.lactateG>0&&s.push({name:y,grams:o.lactateG,pct:o.lactatePct}),o.sugarG>0&&s.push({name:W,grams:o.sugarG,pct:o.sugarPct}),o.saltG>0&&s.push({name:V,grams:o.saltG,pct:o.saltPct}),o.citricG>0&&s.push({name:Z,grams:o.citricG,pct:o.citricPct}),s}function a(o){var le,oe;let s=[],y=M((le=o.additives)==null?void 0:le.citricLyeG),W=M((oe=o.additives)==null?void 0:oe.citricG),V=String(o.lyeType||"NaOH").toUpperCase();return y>0&&W>0&&(V==="KOH"?s.push("Citric-acid lye adjustment used 0.71 x citric acid because KOH was selected."):s.push("Citric-acid lye adjustment used 0.624 x citric acid because NaOH was selected."),s.push(`${A(y)} lye added extra to accommodate the extra citrus.`)),o.usedSapFallback&&s.push("Average SAP fallback was used for oils missing SAP values."),String(o.lyeSelected||"").toUpperCase()==="KOH90"&&s.push("KOH90 selection assumes 90% lye purity."),(Array.isArray(o.oils)?o.oils:[]).some(ie=>{let ee=M(ie==null?void 0:ie.sapKoh);return ee>0&&ee<=1})&&s.push("SAP values at or below 1.0 were treated as decimal SAP and converted to mg KOH/g."),s}function n(o){var oe,ie;if(Array.isArray((oe=o==null?void 0:o.export)==null?void 0:oe.csv_rows)&&o.export.csv_rows.length)return o.export.csv_rows;let s=o.totalOils||0,y=[["section","name","quantity","unit","percent"]];y.push(["Summary","Lye Type",o.lyeType||"","",""]),y.push(["Summary","Superfat",K(o.superfat||0,2),"%",""]),y.push(["Summary","Lye Purity",K(o.purity||0,1),"%",""]),y.push(["Summary","Water Method",o.waterMethod||"","",""]),y.push(["Summary","Water %",K(o.waterPct||0,1),"%",""]),y.push(["Summary","Lye Concentration",K(o.lyeConcentration||0,1),"%",""]),y.push(["Summary","Water Ratio",K(o.waterRatio||0,2),"",""]),y.push(["Summary","Total Oils",K(s,2),"gram",""]),y.push(["Summary","Batch Yield",K(o.batchYield||0,2),"gram",""]),(o.oils||[]).forEach(ee=>{let de=s>0?K(ee.grams/s*100,2):"";y.push(["Oils",ee.name||"Oil",K(ee.grams||0,2),"gram",de])});let W=M((ie=o.additives)==null?void 0:ie.citricLyeG),Z=o.lyeAdjustedBase!==null&&o.lyeAdjustedBase!==void 0&&o.lyeAdjustedBase!==""?M(o.lyeAdjustedBase)+W:M(o.lyeAdjusted);if(Z>0){let ee=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";W>0&&(ee+="*"),y.push(["Lye",ee,K(Z,2),"gram",""])}return o.water>0&&y.push(["Water","Distilled Water",K(o.water,2),"gram",""]),B(s).forEach(ee=>{y.push(["Fragrance",ee.name,K(ee.grams||0,2),"gram",K(ee.pct||0,2)])}),m(o.additives).forEach(ee=>{y.push(["Additives",ee.name,K(ee.grams||0,2),"gram",K(ee.pct||0,2)])}),a(o).forEach(ee=>{y.push(["Notes",`* ${ee}`,"","",""])}),y}function r(o){if(o==null)return"";let s=String(o);return/[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}function d(o){return o.map(s=>s.map(r).join(",")).join(`
`)}function l(o,s){let y=new Blob([o],{type:"text/csv;charset=utf-8;"}),W=URL.createObjectURL(y),V=document.createElement("a");V.href=W,V.download=s,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(W)}function O(o){var Ee,_e;if(typeof((Ee=o==null?void 0:o.export)==null?void 0:Ee.sheet_html)=="string"&&o.export.sheet_html.trim())return o.export.sheet_html;let s=o.totalOils||0,y=(o.oils||[]).map(ue=>({name:ue.name||"Oil",grams:ue.grams||0,pct:s>0?ue.grams/s*100:0})),W=B(s),V=m(o.additives),Z=new Date().toLocaleString(),te=y.length?y.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${F(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',le=W.length?W.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${F(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',oe=V.length?V.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${F(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',ie=M((_e=o.additives)==null?void 0:_e.citricLyeG),de=o.lyeAdjustedBase!==null&&o.lyeAdjustedBase!==void 0&&o.lyeAdjustedBase!==""?M(o.lyeAdjustedBase)+ie:M(o.lyeAdjusted),ve=`${o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${ie>0?"*":""}`,he=`${A(de)}${ie>0?"*":""}`,Ie=a(o),be=Ie.map(ue=>`<div class="footnote">* ${ue}</div>`).join(""),Ce=Ie.length?`<div class="footnotes"><h2 class="footnotes-heading">Assumptions</h2>${be}</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnotes { margin-top: 10px; }
      .footnotes-heading { font-size: 14px; margin: 12px 0 4px; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${Z}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${o.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${F(o.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${F(o.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${A(s)}</span></div>
      <div class="summary-item"><span>Water</span><span>${A(o.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${A(o.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${o.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${F(o.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${te}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${ve}</td><td class="text-end">${he}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${A(o.water||0)}</td></tr>
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${le}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${oe}</tbody>
    </table>
    ${Ce}
  </body>
</html>`}let p=document.getElementById("oilRows"),C=document.getElementById("addOil"),S=document.getElementById("normalizeOils");C&&p&&(C.dataset.bound="direct",C.addEventListener("click",function(){p.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),S&&(S.dataset.bound="direct",S.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),p&&p.addEventListener("input",function(o){o.target.classList.contains("oil-grams")&&(U.lastOilEdit={row:o.target.closest(".oil-row"),field:"grams"}),o.target.classList.contains("oil-percent")&&(U.lastOilEdit={row:o.target.closest(".oil-row"),field:"percent"}),(o.target.classList.contains("oil-grams")||o.target.classList.contains("oil-percent")||o.target.classList.contains("oil-typeahead"))&&(o.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(o.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),p&&p.addEventListener("focusin",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(o.target.closest(".oil-row"))}),p&&p.addEventListener("focusout",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),o.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(o.target.closest(".oil-row"),"grams"),o.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(o.target.closest(".oil-row"),"percent")}),p&&p.addEventListener("keydown",function(o){o.key==="Enter"&&(o.target.classList.contains("oil-grams")&&(o.preventDefault(),e.oils.validateOilEntry(o.target.closest(".oil-row"),"grams")),o.target.classList.contains("oil-percent")&&(o.preventDefault(),e.oils.validateOilEntry(o.target.closest(".oil-row"),"percent")))}),p&&p.addEventListener("mouseover",function(o){if(!o.target.classList.contains("oil-typeahead"))return;let s=o.target.closest(".oil-row");!s||s===U.lastPreviewRow||(U.lastPreviewRow=s,e.oils.setSelectedOilProfileFromRow(s))}),p&&p.addEventListener("mouseout",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),p&&p.addEventListener("click",function(o){let s=o.target.closest(".oil-profile-open");if(s){let W=s.closest(".oil-row");if(W){e.oils.setSelectedOilProfileFromRow(W);let V=document.getElementById("oilProfileModal");V&&N.bootstrap&&bootstrap.Modal.getOrCreateInstance(V).show()}return}let y=o.target.closest(".remove-oil");if(y){let W=y.closest(".oil-row");W&&(U.lastRemovedOil=e.oils.serializeOilRow(W),U.lastRemovedOilIndex=Array.from(W.parentElement.children).indexOf(W),e.ui.showUndoToast("Oil removed.")),W&&U.lastOilEdit&&U.lastOilEdit.row===W&&(U.lastOilEdit=null,e.oils.clearSelectedOilProfile()),W&&W.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let _=document.getElementById("fragranceRows"),g=document.getElementById("addFragrance");g&&_&&(g.dataset.bound="direct",g.addEventListener("click",function(){_.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),_&&(_.addEventListener("input",function(o){o.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:o.target.closest(".fragrance-row"),field:"grams"}),o.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:o.target.closest(".fragrance-row"),field:"percent"}),(o.target.classList.contains("fragrance-grams")||o.target.classList.contains("fragrance-percent")||o.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),_.addEventListener("click",function(o){var W;let s=o.target.closest(".remove-fragrance");if(!s)return;let y=s.closest(".fragrance-row");y&&((W=e.state.lastFragranceEdit)==null?void 0:W.row)===y&&(e.state.lastFragranceEdit=null),y&&y.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let t=document.getElementById("soapStageTabContent"),f=()=>{if(!t)return null;let o=t.querySelector(".tab-pane.active")||t.querySelector(".tab-pane.show.active");return o?o.querySelector(".soap-stage-body")||o:null},E=()=>{t&&t.addEventListener("wheel",o=>{let s=o.target;if(!(s instanceof HTMLElement))return;let y=s.closest('input[type="number"]');if(!(y instanceof HTMLInputElement))return;let W=f();if(!(W instanceof HTMLElement)||W.scrollHeight<=W.clientHeight+1)return;document.activeElement===y&&typeof y.blur=="function"&&y.blur();let V=W.scrollTop<=0,Z=W.scrollTop+W.clientHeight>=W.scrollHeight-1;o.deltaY<0&&V||o.deltaY>0&&Z||(W.scrollTop+=o.deltaY,o.preventDefault())},{passive:!1})};t&&(t.addEventListener("click",o=>{let s=o.target.closest("[data-stage-action]"),y=o.target.closest("[data-soap-action]");if(!s&&!y)return;if(o.preventDefault(),o.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),y){if(y.dataset.bound==="direct")return;let Z=y.dataset.soapAction;Z==="add-oil"&&p&&(p.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),Z==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),Z==="add-fragrance"&&_&&(_.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let W=s.dataset.stageAction,V=Number(s.dataset.stageIndex);Number.isNaN(V)||(W==="prev"&&e.stages.openStageByIndex(Math.max(0,V-1)),W==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,V+1)),W==="reset"&&e.stages.resetStage(V+1))}),E());let P=document.getElementById("soapStageTabList"),w=()=>{if(!P)return;P.querySelectorAll(".nav-item").forEach(s=>s.classList.remove("is-expanded"));let o=P.querySelector(".nav-link.active");o&&o.closest(".nav-item")&&o.closest(".nav-item").classList.add("is-expanded")};P&&(P.addEventListener("shown.bs.tab",()=>{w(),e.layout.scheduleStageHeightSync()}),w());let x=document.getElementById("resultsCardToggle"),k=document.getElementById("resultsCard");x&&k&&x.addEventListener("click",()=>{k.classList.toggle("is-collapsed");let o=k.classList.contains("is-collapsed");x.setAttribute("aria-expanded",(!o).toString());let s=o?"Expand formula details":"Collapse formula details";x.setAttribute("aria-label",s),x.setAttribute("title",s);let y=x.querySelector("i");y&&(y.classList.toggle("fa-chevron-down",o),y.classList.toggle("fa-chevron-up",!o))}),document.querySelectorAll('input[name="weight_unit"]').forEach(o=>{o.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let H=()=>{var o;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(o=e.mold)!=null&&o.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},u=document.getElementById("oilTotalTarget");u&&u.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let I=document.getElementById("waterMethod");I&&I.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(o=>{o.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(o=>{let s=document.getElementById(o);s&&["input","change"].forEach(y=>{s.addEventListener(y,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:o,weightId:s})=>{let y=document.getElementById(o),W=document.getElementById(s);y&&y.addEventListener("input",()=>{let V=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:o,weightId:s,sourceField:"pct",totalOils:V}),e.additives.updateAdditivesOutput(V),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),W&&W.addEventListener("input",()=>{let V=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:o,weightId:s,sourceField:"weight",totalOils:V}),e.additives.updateAdditivesOutput(V),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(o=>{o.addEventListener("input",()=>{e.storage.queueStateSave()})});let b=document.getElementById("qualityPreset");b&&b.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(o=>{o.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let T=document.getElementById("applyQualityTargets");T&&T.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(o=>{o.addEventListener("click",()=>e.quality.applyQualityTargets()),o.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),e.quality.applyQualityTargets())})});let R=document.getElementById("moldWaterWeight");R&&R.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldOilPct");D&&D.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Q=document.getElementById("moldShape");Q&&Q.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Y=document.getElementById("moldCylinderCorrection");Y&&Y.addEventListener("change",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let j=document.getElementById("moldCylinderFactor");j&&j.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(o=>{o.addEventListener("click",function(){let s=this.dataset.stubKind,y=this.dataset.stubName;e.runner.addStubLine(s,y),e.storage.queueStateSave()})});let $=document.getElementById("soapToolPage");$&&($.addEventListener("click",function(o){o.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),$.addEventListener("input",function(o){o.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(o.target),e.stages.updateStageStatuses(),e.ui.flashStage(o.target.closest(".soap-stage-card")))}),$.addEventListener("change",function(o){o.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(o.target),e.stages.updateStageStatuses())}));let J=document.getElementById("addToolIngredient");J&&J.addEventListener("click",function(){let o=document.getElementById("tool-ingredients");o&&o.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let X=document.getElementById("addToolConsumable");X&&X.addEventListener("click",function(){let o=document.getElementById("tool-consumables");o&&o.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let ae=document.getElementById("addToolContainer");ae&&ae.addEventListener("click",function(){let o=document.getElementById("tool-containers");o&&o.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let se=document.getElementById("calcLyeBtn");se&&se.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let me=document.getElementById("saveSoapTool");me&&me.addEventListener("click",async function(){try{let o=U.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!o)return;let s=e.runner.buildSoapRecipePayload(o);U.lastRecipePayload=s;try{let y=e.helpers.getStorage();y&&y.setItem("soap_recipe_payload",JSON.stringify(s))}catch{}N.SOAP_RECIPE_DTO=s,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let fe=document.getElementById("exportSoapCsv");fe&&fe.addEventListener("click",async function(){var W;let o=await i();if(!o)return;let s=n(o),y=typeof((W=o==null?void 0:o.export)==null?void 0:W.csv_text)=="string"&&o.export.csv_text?o.export.csv_text:d(s);l(y,"soap_formula.csv")});let ce=document.getElementById("printSoapSheet");ce&&ce.addEventListener("click",async function(){var W;let o=await i();if(!o)return;let s=O(o),y=N.open("","_blank","width=960,height=720");if(!y){(W=e.ui)!=null&&W.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}y.document.open(),y.document.write(s),y.document.close(),y.focus(),y.onload=()=>{y.print()}});let re=document.getElementById("soapUndoRemove");re&&re.addEventListener("click",()=>{U.lastRemovedOil&&(e.storage.restoreOilRow(U.lastRemovedOil,U.lastRemovedOilIndex||0),U.lastRemovedOil=null,U.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let o=document.getElementById("soapMobileDrawer"),s=document.getElementById("soapMobileDrawerContent"),y=document.getElementById("soapMobileDrawerTitle"),W=document.getElementById("soapDrawerEmpty"),V=document.getElementById("soapDrawerClose"),Z=document.getElementById("soapQualityCard"),te=document.getElementById("resultsCard");if(!o||!s||!y||!Z||!te)return;let le=Z.parentElement,oe=te.parentElement,ie=new Map,ee=null,de=()=>N.matchMedia("(max-width: 767px)").matches,ve=ne=>ne==="quality"?Z:te,he=ne=>ne==="quality"?le:oe,Ie=ne=>ne==="quality"?"Display":"Results",be=ne=>{let ge=ie.get(ne);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",ie.set(ne,ge)),ge.style.height=`${ne.offsetHeight}px`,ne.parentElement&&ne.parentElement!==s&&!ge.parentElement&&ne.parentElement.insertBefore(ge,ne)},Ce=ne=>{ne&&(be(ne),s.appendChild(ne))},Ee=(ne,ge)=>{let qe=ie.get(ne);qe&&qe.parentElement?qe.replaceWith(ne):ge&&ne.parentElement!==ge&&ge.appendChild(ne)},_e=()=>{if(!W)return;let ne=ee==="results",ge=getComputedStyle(te).display!=="none";W.classList.toggle("d-none",!ne||ge)},ue=ne=>{de()&&(ee&&ee!==ne&&Ee(ve(ee),he(ee)),Ce(ve(ne)),y.textContent=Ie(ne),ee=ne,o.classList.add("is-open"),_e())},Te=()=>{ee&&(Ee(ve(ee),he(ee)),ee=null,o.classList.remove("is-open"),_e())};o.querySelectorAll("[data-drawer-target]").forEach(ne=>{ne.addEventListener("click",()=>{let ge=ne.dataset.drawerTarget;ge&&(o.classList.contains("is-open")&&ee===ge?Te():ue(ge))})}),V&&V.addEventListener("click",Te),N.addEventListener("resize",()=>{!de()&&ee&&Te()}),new MutationObserver(()=>_e()).observe(te,{attributes:!0,attributeFilter:["style","class"]})})(),N.addEventListener("resize",e.layout.scheduleStageHeightSync),N.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",c,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",h,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",G,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",z,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),p&&!p.querySelector(".oil-row")&&p.appendChild(e.oils.buildOilRow()),_&&!_.querySelector(".fragrance-row")&&(pe=e.fragrances)!=null&&pe.buildFragranceRow&&_.appendChild(e.fragrances.buildFragranceRow()),(Se=e.fragrances)!=null&&Se.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
