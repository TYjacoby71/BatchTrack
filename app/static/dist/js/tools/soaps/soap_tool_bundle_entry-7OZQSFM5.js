(function(R){"use strict";let e={inventory:"Inventory",global:"Global Library"},d={inventory:"bg-primary",global:"bg-info text-dark"},v={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function G(s,g){let r;return function(){let I=arguments;clearTimeout(r),r=setTimeout(()=>s.apply(null,I),g)}}function z(s){return(s||"").trim().toLowerCase()}function H(s){if(s)return s;let g=document.createElement("div");return g.className="list-group position-absolute w-100 d-none inventory-suggestions",g.style.zIndex="1050",g.style.maxHeight="300px",g.style.overflowY="auto",g}function x(s){return typeof s=="function"?s():s}function C(s){let g=new Set;return(s||[]).forEach(r=>{let I=r&&(r.global_item_id||r.id);I&&g.add(String(I))}),g}function A(s){if(!s)return"";let g=e[s]||s;return`<span class="badge ${d[s]||"bg-secondary"} ms-2">${g}</span>`}function N(s,g,r,I){I=I||{},s.innerHTML="";let l=!1;if(g.forEach(y=>{!y.items||!y.items.length||(l=!0,y.items.forEach(u=>{let L=document.createElement("a");L.href="#",L.className="list-group-item list-group-item-action suggestion-item";let h=I.showSubtitle&&u.subtitle?`<div class="small text-muted mt-1">${u.subtitle}</div>`:"";L.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${u.text||u.display_name||u.name||""}</span>
          ${I.showSourceBadge?A(y.source||u.source):""}
        </div>${h}`,L.addEventListener("click",function(t){t.preventDefault(),r(u,y.source||u.source),s.classList.add("d-none")}),s.appendChild(L)}))}),s.classList.toggle("d-none",!l),!l&&s.dataset.emptyMessage){let y=document.createElement("div");y.className="list-group-item text-muted small",y.textContent=s.dataset.emptyMessage,s.appendChild(y),s.classList.remove("d-none")}}function E(s,g,r){s.innerHTML="";let I=!1;g.forEach(l=>{if(!l.ingredients||!l.ingredients.length)return;I=!0;let y=document.createElement("div");y.className="list-group-item text-muted small fw-semibold",y.textContent=l.title,s.appendChild(y),l.ingredients.forEach(u=>{let L=document.createElement("div");L.className="list-group-item ingredient-result";let h=document.createElement("div");h.className="d-flex justify-content-between align-items-center ingredient-summary",h.setAttribute("role","button"),h.setAttribute("tabindex","0"),h.innerHTML=`<span class="fw-semibold">${u.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${u.forms.length} option${u.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",u.forms.forEach(T=>{let U=document.createElement("button");U.type="button",U.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",U.innerHTML=`<div class="fw-semibold">${T.text||T.display_name||T.name||"Form"}</div>`,U.addEventListener("click",function(){r(T,T.source||l.source),s.classList.add("d-none")}),t.appendChild(U)});function S(T){T.type==="keydown"&&T.key!=="Enter"&&T.key!==" "||(T.preventDefault(),t.classList.toggle("d-none"))}h.addEventListener("click",S),h.addEventListener("keydown",S),L.appendChild(h),L.appendChild(t),s.appendChild(L),u.forms.length===1&&t.classList.remove("d-none")})}),s.classList.toggle("d-none",!I)}function $(s,g,r){s.innerHTML="";let I=!1;if((g||[]).forEach(l=>{I=!0;let y=document.createElement("a");y.href="#",y.className="list-group-item list-group-item-action suggestion-item";let u=l.inci_name?`<div class="small text-muted">${l.inci_name}</div>`:"";y.innerHTML=`<div class="fw-semibold">${l.text||l.name}</div>${u}`,y.addEventListener("click",function(L){L.preventDefault(),r(l,"definition"),s.classList.add("d-none")}),s.appendChild(y)}),s.classList.toggle("d-none",!I),!I&&s.dataset.emptyMessage){let l=document.createElement("div");l.className="list-group-item text-muted small",l.textContent=s.dataset.emptyMessage,s.appendChild(l),s.classList.remove("d-none")}}function i(s){let g=[];return(s||[]).forEach(r=>{if(r&&Array.isArray(r.forms)&&r.forms.length){let I=r.ingredient&&r.ingredient.name||r.ingredient_name||null,l=r.ingredient&&r.ingredient.ingredient_category_name||r.ingredient_category_name||r.ingredient_category&&r.ingredient_category.name||null,y=r.category_tags||[];r.forms.forEach(u=>{var t,S,T,U,w,k,j,F,m,b;let L=u.physical_form||{},h=u.display_name||u.text||u.name||(I&&u.physical_form_name?`${I}, ${u.physical_form_name}`:r.display_name||r.text||r.name||"");g.push({id:u.id,text:h,item_type:u.item_type||r.item_type,default_unit:u.default_unit||u.unit||r.default_unit||r.unit||null,source:"global",global_item_id:u.id,ingredient_id:u.ingredient_id||r.ingredient&&r.ingredient.id||r.ingredient_id||null,ingredient_name:u.ingredient_name||I,physical_form_id:u.physical_form_id||L&&L.id||null,physical_form_name:u.physical_form_name||L&&L.name||null,ingredient_category_name:l,category_tags:y,density:u.density||r.density||null,capacity:u.capacity||r.capacity||null,capacity_unit:u.capacity_unit||r.capacity_unit||null,container_material:u.container_material||r.container_material||null,container_type:u.container_type||r.container_type||null,container_style:u.container_style||r.container_style||null,container_color:u.container_color||r.container_color||null,default_is_perishable:(t=u.default_is_perishable)!=null?t:r.default_is_perishable,recommended_shelf_life_days:(S=u.recommended_shelf_life_days)!=null?S:r.recommended_shelf_life_days,saponification_value:(U=(T=u.saponification_value)!=null?T:r.saponification_value)!=null?U:null,iodine_value:(k=(w=u.iodine_value)!=null?w:r.iodine_value)!=null?k:null,fatty_acid_profile:(F=(j=u.fatty_acid_profile)!=null?j:r.fatty_acid_profile)!=null?F:null,melting_point_c:(b=(m=u.melting_point_c)!=null?m:r.melting_point_c)!=null?b:null})})}else if(r){let I=r.display_name||r.text||r.name||"",l=r.ingredient&&r.ingredient.ingredient_category_name||r.ingredient_category_name||r.ingredient_category&&r.ingredient_category.name||null;g.push({id:r.id,text:I,source:"global",item_type:r.item_type,global_item_id:r.id,ingredient_name:r.ingredient&&r.ingredient.name||r.ingredient_name||r.name,ingredient_category_name:l,category_tags:r.category_tags||[],physical_form_name:r.physical_form&&r.physical_form.name||r.physical_form_name||null,default_unit:r.default_unit||r.unit||null,density:r.density||null,capacity:r.capacity||null,capacity_unit:r.capacity_unit||null,container_material:r.container_material||null,container_type:r.container_type||null,container_style:r.container_style||null,container_color:r.container_color||null,default_is_perishable:r.default_is_perishable,recommended_shelf_life_days:r.recommended_shelf_life_days,saponification_value:r.saponification_value||null,iodine_value:r.iodine_value||null,fatty_acid_profile:r.fatty_acid_profile||null,melting_point_c:r.melting_point_c||null})}}),g}function q(s){let g=new Map;return(s||[]).forEach(r=>{let I=r.ingredient_name||r.text||r.name||"",l=r.ingredient_id?`id:${r.ingredient_id}`:`name:${z(I)}`,y=g.get(l)||{ingredient_id:r.ingredient_id||null,name:I,forms:[]};y.forms.push({id:r.id,text:r.text||I,ingredient_name:I,physical_form_name:r.physical_form_name||null,default_unit:r.default_unit||r.unit||null,source:"inventory",global_item_id:r.global_item_id||null}),g.set(l,y)}),Array.from(g.values())}function f(s,g){let r=[];return(s||[]).forEach(I=>{let l=(I.forms||[]).map(u=>({id:u.id,text:u.name||u.display_name||u.text,ingredient_name:u.ingredient_name||I.name||I.ingredient&&I.ingredient.name||"Ingredient",physical_form_name:u.physical_form_name||null,default_unit:u.default_unit||u.unit||null,source:"global",global_item_id:u.id,density:u.density||null,capacity:u.capacity||null,capacity_unit:u.capacity_unit||null,container_material:u.container_material||null,container_type:u.container_type||null,container_style:u.container_style||null,container_color:u.container_color||null,saponification_value:u.saponification_value||null,iodine_value:u.iodine_value||null,fatty_acid_profile:u.fatty_acid_profile||null,melting_point_c:u.melting_point_c||null})),y=g?l.filter(u=>!u.global_item_id||!g.has(String(u.global_item_id))):l;y.length&&r.push({ingredient_id:I.ingredient_id||I.id||null,name:I.name||I.ingredient&&I.ingredient.name||l[0]&&l[0].ingredient_name||"Ingredient",forms:y})}),r}function a(s){let g=new URLSearchParams({q:s});return fetch(`/api/ingredients/definitions/search?${g.toString()}`).then(r=>r.json()).catch(()=>({results:[]}))}function n(s){let g={...v,...s},r=g.inputEl,I=g.invHiddenEl,l=g.giHiddenEl,y=H(g.listEl),u=g.mode||"recipe",L=g.searchType||"ingredient",h=g.includeInventory,t=g.includeGlobal,S=g.ingredientFirst,T=g.displayVariant,U=typeof g.resultFilter=="function"?g.resultFilter:null,w=typeof g.onSelection=="function"?g.onSelection:null,k=g.globalUrlBuilder;if(!r||!I&&u==="recipe"||!l&&g.requireHidden!==!1)return;y&&!y.classList.contains("list-group")&&y.classList.add("list-group"),!y.parentNode&&r.parentNode&&r.parentNode.appendChild(y);function j(O,_){let B=new URLSearchParams({q:O});return _&&_!=="all"&&B.set("type",_),`/inventory/api/search?${B.toString()}`}function F(O,_,B){if(typeof k=="function")return k(O,_,B);let P=new URLSearchParams({q:O});return _&&_!=="all"&&P.set("type",_),_==="ingredient"&&B&&P.set("group","ingredient"),`${u==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${P.toString()}`}let m=G(function(){let O=(r.value||"").trim();if(!O){y.classList.add("d-none"),y.innerHTML="",I&&(I.value=""),l&&(l.value="");return}let _=(x(L)||"ingredient").toLowerCase(),B=x(h),P=x(t),W=_==="ingredient"&&!!x(S),D=T||(W?"grouped":"compact");if(_==="ingredient_definition"||_==="definition"){a(O).then(M=>{let J=M&&M.results||[];$(y,J.map(X=>({id:X.id,text:X.name,name:X.name,inci_name:X.inci_name,slug:X.slug,ingredient_category_id:X.ingredient_category_id,ingredient_category_name:X.ingredient_category_name})),b)}).catch(()=>y.classList.add("d-none"));return}let Q=B!==!1?fetch(j(O,_)).then(M=>M.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),K=P!==!1?fetch(F(O,_,W)).then(M=>M.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([Q,K]).then(M=>{let J=M[0]&&M[0].results||[],X=M[1]&&M[1].results||[],ne=U?J.filter(oe=>U(oe,"inventory")):J,ie=U?X.filter(oe=>U(oe,"global")):X,me=C(ne),fe=i(ie).filter(oe=>!oe.global_item_id||!me.has(String(oe.global_item_id))).filter(oe=>U?U(oe,"global"):!0);if(W){let oe=q(ne),ye=f(ie,me),pe=[];oe.length&&pe.push({title:"Your Inventory",source:"inventory",ingredients:oe}),ye.length&&pe.push({title:"Global Library",source:"global",ingredients:ye}),E(y,pe,b);return}let ce=[];ne.length&&ce.push({title:"Your Inventory",source:"inventory",items:ne}),fe.length&&ce.push({title:"Global Library",source:"global",items:fe}),N(y,ce,b,{showSourceBadge:g.showSourceBadge!==!1,showSubtitle:D==="detailed"})}).catch(()=>{y.classList.add("d-none")})},200);function b(O,_){r.value=O.text||O.display_name||O.name||"",_==="inventory"?(I&&(I.value=O.id_numeric||O.id||""),l&&(l.value=O.global_item_id||"")):(l&&(l.value=O.global_item_id||O.id||""),I&&(I.value="")),typeof w=="function"&&w(O,_)}r.addEventListener("input",function(){I&&(I.value=""),l&&(l.value=""),m()}),document.addEventListener("click",function(O){!y.contains(O.target)&&!r.contains(O.target)&&y.classList.add("d-none")})}R.attachMergedInventoryGlobalTypeahead=n,R.renderInventoryTypeaheadList=N})(window);(function(R){"use strict";function e(d,v){var G=v&&v.context||"public",z=v&&v.unitOptionsHtml||"",H=v&&v.mode||(G==="public"?"public":"recipe"),x=document.createElement("div");x.className="row g-2 align-items-end mb-2",x.innerHTML=['<div class="col-md-6">','  <label class="form-label">',d==="container"?"Container":d==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',d==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',d==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',z,"  </select>","</div>",'<div class="col-md-3 ',d!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var C=x.querySelector(".tool-typeahead"),A=x.querySelector(".tool-gi-id"),N=x.querySelector('[data-role="suggestions"]');if(typeof R.attachMergedInventoryGlobalTypeahead=="function"){let E=d==="container"?"container":d==="consumable"?"consumable":"ingredient",$=G!=="public";R.attachMergedInventoryGlobalTypeahead({inputEl:C,giHiddenEl:A,listEl:N,mode:H,context:G,ingredientFirst:d==="ingredient",searchType:E,includeInventory:$,includeGlobal:!0})}return x.querySelector(".tool-remove").addEventListener("click",function(){x.remove()}),x}R.buildToolLineRow=e})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};e.config={unitOptionsHtml:R.soapToolConfig&&R.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(R.SOAP_CALC_LIMIT)?R.SOAP_CALC_LIMIT:null,calcTier:R.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(R.soapToolConfig&&R.soapToolConfig.useCsvPrimary),isAuthenticated:R.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:d,toNumber:v,clamp:G,formatTime:z,getStorage:H,buildSoapcalcSearchBuilder:x};function d(C,A=3){if(!isFinite(C))return 0;let N=Math.pow(10,A);return Math.round(C*N)/N}function v(C){let A=C;typeof A=="string"&&(A=A.replace(/,/g,"").trim());let N=parseFloat(A);return isFinite(N)?N:0}function G(C,A,N){return!isFinite(C)||C<A?A:N!=null&&C>N?N:C}function z(C){return C?`Saved ${new Date(C).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function H(){try{return R.localStorage}catch{return null}}function x(){let C=(N,E,$)=>{let i=new URLSearchParams({q:N});return E&&E!=="all"&&i.set("type",E),E==="ingredient"&&$&&i.set("group","ingredient"),`/api/public/global-items/search?${i.toString()}`},A=(N,E,$)=>{let i=new URLSearchParams({q:N});return $&&i.set("group","ingredient"),`/api/public/soapcalc-items/search?${i.toString()}`};return e.config.useCsvPrimary===!0?A:C}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},v={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},G={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},z=[41,70],H=100,x=[136,170],C=250,A={hardness:(d.hardness[0]+d.hardness[1])/2,cleansing:(d.cleansing[0]+d.cleansing[1])/2,conditioning:(d.conditioning[0]+d.conditioning[1])/2,bubbly:(d.bubbly[0]+d.bubbly[1])/2,creamy:(d.creamy[0]+d.creamy[1])/2},N={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},E={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},$=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],i=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],q={g:1,oz:28.3495,lb:453.592},f=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),s=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),g=new Set(["Sugars & Syrups"]),r=new Set(["Salts & Minerals"]),I=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:d,QUALITY_HINTS:v,QUALITY_FEEL_HINTS:G,IODINE_RANGE:z,IODINE_SCALE_MAX:H,INS_RANGE:x,INS_SCALE_MAX:C,QUALITY_BASE:A,QUALITY_PRESETS:N,FATTY_BAR_COLORS:E,FATTY_DISPLAY_KEYS:$,OIL_TIP_RULES:i,UNIT_FACTORS:q,STAGE_CONFIGS:f,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:s,SUGAR_CATEGORY_SET:g,SALT_CATEGORY_SET:r,CITRIC_CATEGORY_SET:I}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d}=e.helpers;function v(x){let C=0,A=0;return x.forEach(N=>{N.iodine>0&&(C+=N.grams,A+=N.iodine*N.grams)}),{iodine:C>0?A/C:0,coverageWeight:C}}function G(x){let C={},A=0;x.forEach(E=>{!E.fattyProfile||typeof E.fattyProfile!="object"||(A+=E.grams,Object.entries(E.fattyProfile).forEach(([$,i])=>{let q=d(i);q>0&&(C[$]=(C[$]||0)+E.grams*(q/100))}))});let N={};return A>0&&Object.entries(C).forEach(([E,$])=>{N[E]=$/A*100}),{percent:N,coveredWeight:A}}function z(x){let C=A=>x[A]||0;return{hardness:C("lauric")+C("myristic")+C("palmitic")+C("stearic"),cleansing:C("lauric")+C("myristic"),conditioning:C("oleic")+C("linoleic")+C("linolenic")+C("ricinoleic"),bubbly:C("lauric")+C("myristic")+C("ricinoleic"),creamy:C("palmitic")+C("stearic")+C("ricinoleic")}}function H(x){if(!x||typeof x!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let C={lauric:d(x.lauric),myristic:d(x.myristic),palmitic:d(x.palmitic),stearic:d(x.stearic),ricinoleic:d(x.ricinoleic),oleic:d(x.oleic),linoleic:d(x.linoleic),linolenic:d(x.linolenic)},A=z(C);return{hardness:(A.hardness||0)/100,cleansing:(A.cleansing||0)/100,conditioning:(A.conditioning||0)/100,bubbly:(A.bubbly||0)/100,creamy:(A.creamy||0)/100}}e.calc={computeIodine:v,computeFattyAcids:G,computeQualities:z,computeOilQualityScores:H},R.SoapCalcService=e.calc})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:G}=e.helpers,{UNIT_FACTORS:z}=e.constants,H=e.state;function x(i){return G(v(i),0)*(z[H.currentUnit]||1)}function C(i){return G(i,0)/(z[H.currentUnit]||1)}function A(i){return!isFinite(i)||i<=0?"--":`${d(C(i),2)} ${H.currentUnit}`}function N(i){return isFinite(i)?`${d(i,1)}%`:"--"}function E(){document.querySelectorAll(".unit-label").forEach(i=>{i.textContent=H.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(i=>{i.dataset.suffix=H.currentUnit})}function $(i,q={}){if(!i)return;if(i===H.currentUnit){E();return}let f=H.currentUnit;if(H.currentUnit=i,E(),q.skipConvert)return;let a=(z[f]||1)/(z[i]||1);document.querySelectorAll(".oil-grams").forEach(g=>{let r=v(g.value);r>0&&(g.value=d(r*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(g=>{let r=v(g.value);r>0&&(g.value=d(r*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let g=v(n.value);g>0&&(n.value=d(g*a,2))}let s=document.getElementById("moldWaterWeight");if(s&&s.value){let g=v(s.value);g>0&&(s.value=d(g*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),q.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:x,fromGrams:C,formatWeight:A,formatPercent:N,updateUnitLabels:E,setUnit:$}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state,v={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function G(f){f&&(f.classList.remove("soap-number-pulse"),f.offsetWidth,f.classList.add("soap-number-pulse"))}function z(f){var n;let a=document.getElementById(f);return!a||!((n=R.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function H(){let f=Date.now();if(f-d.lastSaveToastAt<3500)return;d.lastSaveToastAt=f;let a=z("soapAutosaveToast");a&&a.show()}function x(f){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=f||"Oil removed.");let s=z("soapUndoToast");s&&s.show()}function C(){let f=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");f&&f.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function A(f){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let s=(f==null?void 0:f.lyeConcentration)||0,g="";s>40&&(g="High concentration"),s>0&&s<25&&(g="Low concentration"),a.textContent=g,a.classList.toggle("d-none",!g)}if(n){let s=(f==null?void 0:f.waterRatio)||0,g="";s>0&&s<1.8&&(g="Low water"),s>2.7&&(g="High water"),n.textContent=g,n.classList.toggle("d-none",!g)}}function N(){document.querySelectorAll("#soapToolPage .form-text").forEach(f=>{let a=f.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function E(f){if(!f||f.type!=="number")return;let a=f.value;if(a===""){f.classList.remove("is-invalid");return}let n=parseFloat(a),s=f.getAttribute("min"),g=f.getAttribute("max"),r=s!==null&&s!==""&&n<parseFloat(s),I=g!==null&&g!==""&&n>parseFloat(g);f.classList.toggle("is-invalid",!isFinite(n)||r||I)}function $(f){var n;if(!f)return;let a=((n=f.querySelector)==null?void 0:n.call(f,".soap-stage-card"))||f;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function i(f,a,n={}){var I;let s=document.getElementById("soapAlertStack");if(!s)return;let g=v[f]||v.info,r=document.createElement("div");r.className=`alert alert-${f} d-flex align-items-start gap-2`,r.innerHTML=`
      <i class="fas ${g} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((I=r.querySelector('[data-role="dismiss"]'))==null||I.addEventListener("click",()=>r.remove())),s.prepend(r),n.persist||setTimeout(()=>{r.parentNode&&r.remove()},n.timeoutMs||4500)}function q(){let f=document.getElementById("soapAlertStack");f&&f.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:G,getToastInstance:z,showAutosaveToast:H,showUndoToast:x,updateResultsMeta:C,updateResultsWarnings:A,applyHelperVisibility:N,validateNumericField:E,flashStage:$,showSoapAlert:i,clearSoapAlerts:q}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function d(){let G=document.getElementById("soapStagePane"),z=document.getElementById("soapQualityCard");if(!G||!z)return;if(!R.matchMedia("(min-width: 768px)").matches){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}let x=z.offsetHeight;if(!x){G.classList.remove("is-height-synced"),G.style.removeProperty("--soap-stage-height");return}G.style.setProperty("--soap-stage-height",`${x}px`),G.classList.add("is-height-synced")}let v=()=>{R.requestAnimationFrame(d)};e.layout={syncStageHeight:d,scheduleStageHeightSync:v}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{clamp:d,toNumber:v,round:G}=e.helpers,{toGrams:z,fromGrams:H}=e.units;function x(){let i=E(),q=document.getElementById("oilTotalTarget"),f=document.getElementById("oilTargetHint");q&&i.effectiveCapacity>0&&z(q.value)<=0&&(q.value=i.targetOils>0?G(H(i.targetOils),2):""),f&&(i.effectiveCapacity>0?f.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":f.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";i.shape==="cylinder"&&i.waterWeight>0&&(i.useCylinder?n=`Cylinder correction applied (${G(i.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}C()}function C(i=null){var u;let q=document.getElementById("moldWetBatterWarning");if(!q)return;let f=()=>{q.classList.add("d-none"),q.textContent=""},a=E(),n=e.state||{},s=n.lastCalc||null,g=(u=e.oils)!=null&&u.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,r=v(s==null?void 0:s.totalOils),I=v(i);if((!isFinite(I)||I<=0)&&(I=v(s==null?void 0:s.batchYield)),i==null&&r>0&&g>0&&Math.abs(r-g)>.01){f();return}if(!isFinite(I)||I<=0||a.effectiveCapacity<=0){f();return}let l=I-a.effectiveCapacity;if(l<=.01){f();return}let y=n.currentUnit||"g";q.textContent=`Full wet batter is ${G(H(I),2)} ${y}, exceeding mold capacity ${G(H(a.effectiveCapacity),2)} ${y} by ${G(H(l),2)} ${y}. Reduce oils target/% of mold or lower water/additives.`,q.classList.remove("d-none")}function A(){let i=document.getElementById("oilTotalTarget"),q=E();return i&&(q.effectiveCapacity>0&&(i.value=q.targetOils>0?G(H(q.targetOils),2):""),x()),q}function N(){let i=document.getElementById("oilTotalTarget"),q=document.getElementById("moldOilPct");if(!i||!q){let n=E();return x(),n}let f=E();if(f.effectiveCapacity>0){let n=z(i.value),s=d(n,0,f.effectiveCapacity);n>f.effectiveCapacity+.01&&(i.value=G(H(s),2));let g=s>0?s/f.effectiveCapacity*100:0;q.value=s>0?G(g,2):""}let a=E();return x(),a}function E(){var r,I,l;let i=z(document.getElementById("moldWaterWeight").value),q=d(v(document.getElementById("moldOilPct").value),0,100),f=((r=document.getElementById("moldShape"))==null?void 0:r.value)||"loaf",a=!!((I=document.getElementById("moldCylinderCorrection"))!=null&&I.checked),n=d(v((l=document.getElementById("moldCylinderFactor"))==null?void 0:l.value),.5,1),s=i>0?i*(a?n:1):0,g=s>0?s*(q/100):0;return{waterWeight:i,oilPct:q,shape:f,useCylinder:a,cylinderFactor:n,effectiveCapacity:s,targetOils:g}}function $(){var f;let i=((f=document.getElementById("moldShape"))==null?void 0:f.value)||"loaf",q=document.getElementById("moldCylinderOptions");q&&q.classList.toggle("d-none",i!=="cylinder"),x()}e.mold={updateMoldSuggested:x,updateWetBatterWarning:C,syncTargetFromMold:A,syncMoldPctFromTarget:N,getMoldSettings:E,updateMoldShapeUI:$}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:G,buildSoapcalcSearchBuilder:z}=e.helpers,{toGrams:H,fromGrams:x}=e.units,{OIL_CATEGORY_SET:C,OIL_TIP_RULES:A}=e.constants,{computeQualities:N}=e.calc,E=e.state;function $(m){let b=m.querySelector(".oil-typeahead"),O=m.querySelector(".oil-sap-koh"),_=m.querySelector(".oil-iodine"),B=m.querySelector(".oil-fatty"),P=m.querySelector(".oil-gi-id"),W=m.querySelector(".oil-default-unit"),D=m.querySelector(".oil-category"),Q=m.querySelector('[data-role="suggestions"]');if(!b||!Q||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let K=z();R.attachMergedInventoryGlobalTypeahead({inputEl:b,listEl:Q,mode:"public",giHiddenEl:P,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:K,searchType:"ingredient",resultFilter:(M,J)=>j(M,C,J),requireHidden:!1,onSelection:function(M){O&&(O.value=(M==null?void 0:M.saponification_value)||""),_&&(_.value=(M==null?void 0:M.iodine_value)||""),B&&(B.value=M!=null&&M.fatty_acid_profile?JSON.stringify(M.fatty_acid_profile):""),W&&(W.value=(M==null?void 0:M.default_unit)||""),D&&(D.value=(M==null?void 0:M.ingredient_category_name)||""),t(M),y(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),b.addEventListener("input",function(){this.value.trim()||(O&&(O.value=""),_&&(_.value=""),B&&(B.value=""),P&&(P.value=""),W&&(W.value=""),D&&(D.value=""),T())})}function i(){var O,_;let m=document.getElementById("oilRowTemplate"),b=(_=(O=m==null?void 0:m.content)==null?void 0:O.querySelector(".oil-row"))==null?void 0:_.cloneNode(!0);return b?(b.querySelectorAll("input").forEach(B=>{B.value=""}),b.querySelectorAll(".form-text").forEach(B=>{let P=B.closest('.soap-field-stack, [class*="col-"]');P&&P.classList.add("soap-field")}),$(b),b.querySelectorAll(".unit-suffix").forEach(B=>{B.dataset.suffix=E.currentUnit}),b):document.createElement("div")}function q(){let m=document.getElementById("oilTotalTarget"),b=H(m==null?void 0:m.value);if(b>0)return b;let O=e.mold.getMoldSettings();return O.targetOils>0?O.targetOils:0}function f(m){let b=[];return m.forEach(_=>{var W,D;let B=H((W=_.querySelector(".oil-grams"))==null?void 0:W.value),P=G(v((D=_.querySelector(".oil-percent"))==null?void 0:D.value),0);B>0&&P>0&&b.push(B/(P/100))}),b.length?b.reduce((_,B)=>_+B,0)/b.length:0}function a(m,b){if(!m||!b||b<=0)return{allowedGrams:null,allowedPct:null};let O=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=O.reduce((K,M)=>{var J;return M===m?K:K+H((J=M.querySelector(".oil-grams"))==null?void 0:J.value)},0),B=O.reduce((K,M)=>{var J;return M===m?K:K+G(v((J=M.querySelector(".oil-percent"))==null?void 0:J.value),0)},0),P=Math.max(0,100-B),W=Math.max(0,b-_),D=b*P/100;return{allowedGrams:Math.max(0,Math.min(W,D)),allowedPct:P}}function n(m,b,O){if(!m)return;let _=m.querySelector(`[data-role="oil-${b}-hint"]`);_&&(O?(_.textContent=O,_.classList.add("is-visible")):(_.textContent="",_.classList.remove("is-visible")))}function s(m){m&&(m.classList.remove("oil-input-bounce"),m.offsetWidth,m.classList.add("oil-input-bounce"))}function g(m,b,O={}){let _=q();if(!m||!_||_<=0){n(m,b,"");return}let B=m.querySelector(".oil-grams"),P=m.querySelector(".oil-percent"),W=a(m,_);if(b==="grams"&&B){let D=H(B.value),Q="";if(D>_+.01?Q="Entry exceeds the max oils allowed in stage 2.":W.allowedGrams!==null&&D>W.allowedGrams+.01&&(Q=`Must be under ${d(x(W.allowedGrams),2)} ${E.currentUnit} to stay within the stage 2 oil limit.`),Q){let K=W.allowedGrams!==null?d(x(W.allowedGrams),2):d(x(_),2);B.value=K>0?K:"",n(m,b,Q),B.classList.add("oil-input-warning"),s(B),y()}else B.classList.remove("oil-input-warning"),n(m,b,"")}if(b==="percent"&&P){let D=G(v(P.value),0),Q="";if(D>100.01?Q="Entry exceeds the max oils allowed in stage 2.":W.allowedPct!==null&&D>W.allowedPct+.01&&(Q=`Must be under ${d(W.allowedPct,2)}% to stay within the stage 2 oil limit.`),Q){let K=W.allowedPct!==null?d(W.allowedPct,2):100;P.value=K>0?K:"",n(m,b,Q),P.classList.add("oil-input-warning"),s(P),y()}else P.classList.remove("oil-input-warning"),n(m,b,"")}}function r(m,b={}){let O=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=m!=null?m:q(),B=!!b.force;if(!_||_<=0||!O.length){E.lastOilTarget=_;return}let P=O.reduce((D,Q)=>{var K;return D+G(v((K=Q.querySelector(".oil-percent"))==null?void 0:K.value),0)},0),W=O.reduce((D,Q)=>{var K;return D+H((K=Q.querySelector(".oil-grams"))==null?void 0:K.value)},0);if(P<=0&&W<=0){E.lastOilTarget=_;return}if(!(!B&&E.lastOilTarget&&Math.abs(E.lastOilTarget-_)<.01)){if(P>0)O.forEach(D=>{let Q=D.querySelector(".oil-percent"),K=D.querySelector(".oil-grams"),M=G(v(Q==null?void 0:Q.value),0),J=P>0?M/P:0;K&&(K.value=J>0?d(x(_*J),2):""),Q&&(Q.value=J>0?d(J*100,2):"")});else if(W>0){let D=_/W;O.forEach(Q=>{let K=Q.querySelector(".oil-grams"),M=Q.querySelector(".oil-percent"),J=H(K==null?void 0:K.value);if(K){let X=J>0?J*D:0;K.value=X>0?d(x(X),2):""}if(M){let X=H(K==null?void 0:K.value);M.value=X>0?d(X/_*100,2):""}})}E.lastOilTarget=_,y({skipEnforce:!0})}}function I(m,b){if(!E.lastOilEdit||!E.lastOilEdit.row)return!1;let O=E.lastOilEdit.row,_=m.reduce((D,Q)=>{var K;return Q===O?D:D+H((K=Q.querySelector(".oil-grams"))==null?void 0:K.value)},0),B=Math.max(0,b-_),P=O.querySelector(".oil-grams"),W=O.querySelector(".oil-percent");return!P||!W?!1:(P.value=B>0?d(x(B),2):"",W.value=B>0?d(B/b*100,2):"",E.wasCapped=!0,!0)}function l({totalWeight:m,totalPct:b,target:O,capped:_}){let B=document.getElementById("oilLimitWarning");if(!B)return;let P=[];if(_&&P.push("Oil total hit the mold cap and was adjusted."),O>0&&m>O+.01){let W=m-O;P.push(`Oil weights exceed the target by ${d(x(W),2)} ${E.currentUnit}.`)}b>100.01&&P.push(`Oil percentages are over 100% by ${d(b-100,2)}%.`),P.length?(B.classList.remove("d-none"),B.innerHTML=`${P.join(" ")} Adjust oils or mold % to continue.`):(B.classList.add("d-none"),B.textContent="")}function y(m={}){m.skipEnforce||(E.wasCapped=!1);let b=Array.from(document.querySelectorAll("#oilRows .oil-row")),O=e.mold.getMoldSettings(),_=q();if(!_&&!O.targetOils){let D=f(b);if(D>0){_=D;let Q=document.getElementById("oilTotalTarget");Q&&!Q.value&&(Q.value=d(x(D),2))}}let B=0,P=0;if(b.forEach(D=>{let Q=D.querySelector(".oil-grams"),K=D.querySelector(".oil-percent"),M=H(Q==null?void 0:Q.value),J=G(v(K==null?void 0:K.value),0);_>0&&(E.lastOilEdit&&E.lastOilEdit.row===D&&E.lastOilEdit.field==="percent"?(M=J>0?_*(J/100):0,Q.value=J>0?d(x(M),2):""):M>0?(J=M/_*100,K.value=d(J,2)):J>0&&(M=_*(J/100),Q.value=d(x(M),2)),P+=J),M>0&&(B+=M)}),_<=0&&(B>0?(P=0,b.forEach(D=>{let Q=D.querySelector(".oil-grams"),K=D.querySelector(".oil-percent"),M=H(Q==null?void 0:Q.value);if(M>0){let J=M/B*100;K.value=d(J,2),P+=J}})):P=b.reduce((D,Q)=>{var K;return D+G(v((K=Q.querySelector(".oil-percent"))==null?void 0:K.value),0)},0)),!m.skipEnforce&&O.targetOils>0&&B>O.targetOils+.01&&I(b,O.targetOils))return y({skipEnforce:!0});E.totalOilsGrams=B;let W=document.getElementById("oilTotalComputed");return W&&(W.textContent=B>0?`${d(x(B),2)} ${E.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=d(P,2),l({totalWeight:B,totalPct:P,target:_,capped:E.wasCapped}),e.additives.updateAdditivesOutput(B),e.mold.updateMoldSuggested(),U(),{totalWeight:B,totalPct:P,target:_}}function u(){let m=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!m.length)return;let b=q(),O=m.reduce((_,B)=>{var P;return _+G(v((P=B.querySelector(".oil-percent"))==null?void 0:P.value),0)},0);!O&&b>0&&(O=m.reduce((_,B)=>{var W;let P=H((W=B.querySelector(".oil-grams"))==null?void 0:W.value);return _+(P>0?P/b*100:0)},0)),!(O<=0)&&(m.forEach(_=>{let B=_.querySelector(".oil-percent"),P=_.querySelector(".oil-grams"),D=G(v(B.value),0)/O*100;B.value=d(D,2),b>0&&(P.value=D>0?d(x(b*(D/100)),2):"")}),y())}function L(){let m=[];return document.querySelectorAll("#oilRows .oil-row").forEach(b=>{var J,X,ne,ie,me,fe,ce,oe,ye;let O=(X=(J=b.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:X.trim(),_=H((ne=b.querySelector(".oil-grams"))==null?void 0:ne.value),B=v((ie=b.querySelector(".oil-sap-koh"))==null?void 0:ie.value),P=v((me=b.querySelector(".oil-iodine"))==null?void 0:me.value),W=((fe=b.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",D=((ce=b.querySelector(".oil-gi-id"))==null?void 0:ce.value)||"",Q=((oe=b.querySelector(".oil-default-unit"))==null?void 0:oe.value)||"",K=((ye=b.querySelector(".oil-category"))==null?void 0:ye.value)||"",M=null;if(W)try{M=JSON.parse(W)}catch{M=null}_<=0||m.push({name:O||null,grams:_,sapKoh:B,iodine:P,fattyProfile:M,global_item_id:D?parseInt(D):null,default_unit:Q||null,ingredient_category_name:K||null})}),m}function h({name:m,sapKoh:b,iodine:O,fattyProfile:_}={}){let B=document.getElementById("oilProfileFloat"),P=(X,ne)=>{let ie=document.getElementById(X);ie&&(ie.textContent=ne)},W=m||"Pick an oil to preview";P("selectedOilName",W),P("selectedOilModalName",W),B&&B.classList.toggle("d-none",!m);let D=b>0?d(b,1):"--",Q=O>0?d(O,1):"--";P("selectedOilSap",D),P("selectedOilModalSap",D),P("selectedOilIodine",Q),P("selectedOilModalIodine",Q);let K=_?N(_):{},M=(X,ne)=>{let ie=isFinite(ne)&&ne>0?d(ne,1):"--";P(X,ie)};M("selectedOilHardness",K.hardness),M("selectedOilModalHardness",K.hardness),M("selectedOilCleansing",K.cleansing),M("selectedOilModalCleansing",K.cleansing),M("selectedOilConditioning",K.conditioning),M("selectedOilModalConditioning",K.conditioning),M("selectedOilBubbly",K.bubbly),M("selectedOilModalBubbly",K.bubbly),M("selectedOilCreamy",K.creamy),M("selectedOilModalCreamy",K.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(X=>{let ne=`selectedOil${X.charAt(0).toUpperCase()}${X.slice(1)}`,ie=`selectedOilModal${X.charAt(0).toUpperCase()}${X.slice(1)}`,me=_?v(_[X]):0,fe=me>0?d(me,1):"--";P(ne,fe),P(ie,fe)})}function t(m){if(!m){T();return}E.selectedOilProfile=m;let b=m.fatty_acid_profile||null;if(typeof b=="string")try{b=JSON.parse(b)}catch{b=null}h({name:m.text||m.display_name||m.name,sapKoh:v(m.saponification_value),iodine:v(m.iodine_value),fattyProfile:b})}function S(m){var W,D,Q,K,M;if(!m)return;let b=(D=(W=m.querySelector(".oil-typeahead"))==null?void 0:W.value)==null?void 0:D.trim(),O=v((Q=m.querySelector(".oil-sap-koh"))==null?void 0:Q.value),_=v((K=m.querySelector(".oil-iodine"))==null?void 0:K.value),B=((M=m.querySelector(".oil-fatty"))==null?void 0:M.value)||"",P=null;if(B)try{P=JSON.parse(B)}catch{P=null}h({name:b,sapKoh:O,iodine:_,fattyProfile:P})}function T(){E.selectedOilProfile=null,E.lastPreviewRow=null,h()}function U(){let m=document.getElementById("oilBlendTips");if(!m)return;let b=L().filter(B=>B.grams>0||B.percent>0);if(!b.length){m.classList.add("d-none"),m.textContent="";return}let O=new Set;b.forEach(B=>{let P=(B.name||"").toLowerCase();if(P&&A.forEach(W=>{W.match.test(P)&&O.add(W.tip)}),B.fattyProfile&&typeof B.fattyProfile=="object"){let W=v(B.fattyProfile.lauric),D=v(B.fattyProfile.myristic),Q=v(B.fattyProfile.palmitic),K=v(B.fattyProfile.stearic),M=v(B.fattyProfile.ricinoleic),J=v(B.fattyProfile.oleic),X=v(B.fattyProfile.linoleic),ne=v(B.fattyProfile.linolenic);W+D>=30&&O.add(`${B.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),Q+K>=40&&O.add(`${B.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),J>=60&&O.add(`${B.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),X+ne>=20&&O.add(`${B.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),M>=60&&O.add(`${B.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let _=Array.from(O).slice(0,6);if(!_.length){m.classList.add("d-none"),m.textContent="";return}m.classList.remove("d-none"),m.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${_.map(B=>`<li>${B}</li>`).join("")}</ul>`}function w(){return E.totalOilsGrams||0}function k(m){var b,O,_,B,P,W,D,Q,K;return m?{name:((b=m.querySelector(".oil-typeahead"))==null?void 0:b.value)||"",grams:((O=m.querySelector(".oil-grams"))==null?void 0:O.value)||"",percent:((_=m.querySelector(".oil-percent"))==null?void 0:_.value)||"",sap:((B=m.querySelector(".oil-sap-koh"))==null?void 0:B.value)||"",iodine:((P=m.querySelector(".oil-iodine"))==null?void 0:P.value)||"",fattyRaw:((W=m.querySelector(".oil-fatty"))==null?void 0:W.value)||"",gi:((D=m.querySelector(".oil-gi-id"))==null?void 0:D.value)||"",defaultUnit:((Q=m.querySelector(".oil-default-unit"))==null?void 0:Q.value)||"",categoryName:((K=m.querySelector(".oil-category"))==null?void 0:K.value)||""}:null}function j(m,b,O){let _=F(m);return _?b.has(_):O==="inventory"}function F(m){return!m||typeof m!="object"?null:m.ingredient&&m.ingredient.ingredient_category_name||m.ingredient_category_name||m.ingredient_category&&m.ingredient_category.name||null}e.oils={attachOilTypeahead:$,buildOilRow:i,getOilTargetGrams:q,updateOilTotals:y,normalizeOils:u,collectOilData:L,setSelectedOilProfileFromRow:S,clearSelectedOilProfile:T,updateOilTips:U,getTotalOilsGrams:w,serializeOilRow:k,validateOilEntry:g,scaleOilsToTarget:r}})(window);(function(R){"use strict";var h;let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},{toNumber:v,clamp:G}=e.helpers,z=e.state,H=Array.isArray((h=e.constants)==null?void 0:h.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],x=new Set(["selected_pct","selected_weight_g"]),C=25,A=140,N=260,E={mode:"basics",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function $(){var t,S;(S=(t=e.storage)==null?void 0:t.queueStateSave)==null||S.call(t)}function i(t,S){var T,U;(U=(T=e.ui)==null?void 0:T.showSoapAlert)==null||U.call(T,t,S,{dismissible:!0,timeoutMs:6e3})}function q(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),modeToggle:document.getElementById("bulkOilDisplayAllToggle"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function f(t){return t?t==="name"||x.has(t)?!0:H.includes(t):!1}function a(){(!z.bulkOilModal||typeof z.bulkOilModal!="object")&&(z.bulkOilModal=JSON.parse(JSON.stringify(E)));let t=z.bulkOilModal;return t.mode=t.mode==="all"?"all":"basics",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=f(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let S={},T=t&&typeof t=="object"?t:{};return H.forEach(U=>{let w=v(T[U]);w>0&&(S[U]=w)}),S}function s(t){let S=n(t==null?void 0:t.fatty_profile),T=String((t==null?void 0:t.name)||"").trim(),U=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:v(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${U}:${T.toLowerCase()}`)),name:T,sap_koh:v(t==null?void 0:t.sap_koh),iodine:v(t==null?void 0:t.iodine),fatty_profile:S,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:U,is_basic:!!(t!=null&&t.is_basic)}}function g(){let t=q(),S=a(),T=Object.keys(S.selection||{}).length,U=`Selected: ${T}`;t.summaryEl&&(t.summaryEl.textContent=U),t.stageCountEl&&(t.stageCountEl.textContent=String(T))}function r(t){var T;return((T=a().selection)==null?void 0:T[t])||null}function I(t,S={}){var k,j;let T=a();if(!t||!t.key)return null;let U=T.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:G(v((k=S.selected_pct)!=null?k:U.selected_pct),0,100),selected_weight_g:G(v((j=S.selected_weight_g)!=null?j:U.selected_weight_g),0)};return T.selection[t.key]=w,w}function l(t){var T;let S=a();(T=S.selection)!=null&&T[t]&&delete S.selection[t]}function y(t){var T;return((T=a().recordByKey)==null?void 0:T[t])||null}function u(){let t=a();return{mode:t.mode,view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(S=>({key:S.key,name:S.name,sap_koh:S.sap_koh,iodine:S.iodine,fatty_profile:S.fatty_profile||{},default_unit:S.default_unit,ingredient_category_name:S.ingredient_category_name,global_item_id:S.global_item_id,source:S.source,is_basic:!!S.is_basic,selected_pct:G(v(S.selected_pct),0,100),selected_weight_g:G(v(S.selected_weight_g),0)}))}}function L(t){let S=a();S.mode=(t==null?void 0:t.mode)==="all"?"all":"basics",S.viewSelected=!!(t!=null&&t.view_selected),S.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",S.sortKey=f(t==null?void 0:t.sort_key)?t.sort_key:"name",S.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let T={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let k=String((w==null?void 0:w.key)||"").trim(),j=String((w==null?void 0:w.name)||"").trim();!k||!j||(T[k]={key:k,name:j,sap_koh:v(w==null?void 0:w.sap_koh),iodine:v(w==null?void 0:w.iodine),fatty_profile:n(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:v(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:G(v(w==null?void 0:w.selected_pct),0,100),selected_weight_g:G(v(w==null?void 0:w.selected_weight_g),0)})}),S.selection=T,S.visibleRecords=[],S.offset=0,S.totalCount=0,S.hasMore=!0,S.loading=!1,g()}d.shared={FATTY_KEYS:H,LOCAL_SORT_KEYS:x,PAGE_SIZE:C,SCROLL_FETCH_THRESHOLD:A,SEARCH_DEBOUNCE_MS:N,queueStateSave:$,showAlert:i,getRefs:q,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:s,updateSelectionCounters:g,selectionForRecordKey:r,setSelection:I,removeSelection:l,getRecordByKey:y,serializeSelection:u,restoreState:L}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared;if(!v)return;let{round:G,toNumber:z}=e.helpers,{fromGrams:H}=e.units,{FATTY_KEYS:x,LOCAL_SORT_KEYS:C,getRefs:A,ensureModalState:N,selectionForRecordKey:E,updateSelectionCounters:$}=v;function i(h){let t=A();t.statusEl&&(t.statusEl.textContent=h)}function q(){let h=N(),t=h.mode==="all"?"all oils":"SoapCalc basics";if(h.loading&&!h.visibleRecords.length){i("Loading oils...");return}if(!h.visibleRecords.length){let k=h.query?"No oils match that search.":"No oils available.";i(k);return}let S=h.visibleRecords.length,T=h.totalCount,U=h.hasMore?" \u2022 scroll for more":"",w=h.query?` \u2022 search: "${h.query}"`:"";i(`Loaded ${S}/${T} in ${t}${w}${U}`)}function f(h,t,S){if(typeof h=="string"||typeof t=="string"){let w=String(h||"").toLowerCase(),k=String(t||"").toLowerCase();return w<k?S==="asc"?-1:1:w>k?S==="asc"?1:-1:0}let T=z(h),U=z(t);return T<U?S==="asc"?-1:1:T>U?S==="asc"?1:-1:0}function a(h,t){var S,T;return t==="selected_pct"?((S=E(h.key))==null?void 0:S.selected_pct)||0:t==="selected_weight_g"?((T=E(h.key))==null?void 0:T.selected_weight_g)||0:""}function n(){let h=N();C.has(h.sortKey)&&h.visibleRecords.sort((t,S)=>{let T=f(a(t,h.sortKey),a(S,h.sortKey),h.sortDir);return T!==0?T:f(t.name||"",S.name||"","asc")})}function s(){let h=N();if(!h.viewSelected)return;let t=[],S=[];h.visibleRecords.forEach(T=>{E(T.key)?t.push(T):S.push(T)}),h.visibleRecords=t.concat(S)}function g(){n(),s()}function r(h){let t=String(h||"").trim().toLowerCase();return t==="name"||x.includes(t)?t:"name"}function I(){let h=N();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let S=t.dataset.label||"",T=t.dataset.sortKey||"";h.sortKey===T?t.textContent=`${S} ${h.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=S})}function l(h,t){let S=E(t.key),T=h.querySelector(".bulk-oil-check"),U=h.querySelector(".bulk-oil-pct"),w=h.querySelector(".bulk-oil-weight");T&&(T.checked=!!S),U&&(U.value=S&&S.selected_pct>0?G(S.selected_pct,2):""),w&&(w.value=S&&S.selected_weight_g>0?G(H(S.selected_weight_g),2):"")}function y(h){let t=document.createElement("td");t.className="bulk-oil-acid";let S=z(h);return t.textContent=S>0?G(S,1).toString():"--",t}function u(h){let t=document.createElement("tr");t.dataset.recordKey=h.key;let S=document.createElement("td");S.className="text-center";let T=document.createElement("input");T.type="checkbox",T.className="form-check-input bulk-oil-check",S.appendChild(T),t.appendChild(S);let U=document.createElement("td");U.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=h.name;let k=document.createElement("div");k.className="text-muted small";let j=h.ingredient_category_name?` \xB7 ${h.ingredient_category_name}`:"";k.textContent=`${h.source}${j}`,U.appendChild(w),U.appendChild(k),t.appendChild(U),x.forEach(_=>{var B;t.appendChild(y((B=h.fatty_profile)==null?void 0:B[_]))});let F=document.createElement("td"),m=document.createElement("input");m.type="number",m.min="0",m.max="100",m.step="0.1",m.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",F.appendChild(m),t.appendChild(F);let b=document.createElement("td"),O=document.createElement("input");return O.type="number",O.min="0",O.step="0.1",O.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",b.appendChild(O),t.appendChild(b),l(t,h),t}function L(){let h=A(),t=N();if(!h.bodyEl)return;h.bodyEl.innerHTML="";let S=document.createDocumentFragment();t.visibleRecords.forEach(T=>{S.appendChild(u(T))}),h.bodyEl.appendChild(S),I(),$(),q()}d.render={updateStatusText:i,refreshCatalogStatus:q,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:s,applyClientOrdering:g,normalizeServerSortKey:r,sortButtonsLabel:I,renderVisibleRecords:L}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared,G=d.render;if(!v||!G)return;let{PAGE_SIZE:z,getRefs:H,ensureModalState:x,normalizeCatalogRecord:C}=v,{refreshCatalogStatus:A,normalizeServerSortKey:N,applyClientOrdering:E,renderVisibleRecords:$,updateStatusText:i}=G;function q(){let a=x(),n=H();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function f({reset:a=!1}={}){let n=x();if(!H().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&q();let g=n.requestToken+1;n.requestToken=g,n.loading=!0,A();let r=new URLSearchParams;r.set("mode",n.mode),r.set("offset",String(n.offset)),r.set("limit",String(z)),r.set("q",n.query||""),r.set("sort_key",N(n.sortKey)),r.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let I=await fetch(`/tools/api/soap/oils-catalog?${r.toString()}`);if(!I.ok)throw new Error("Unable to load oils catalog");let l=await I.json();if(!l||l.success!==!0||!l.result||!Array.isArray(l.result.records))throw new Error("Invalid oils catalog response");if(g!==n.requestToken)return;let y=l.result.records.map(C),u=Math.max(0,parseInt(l.result.next_offset,10)||n.offset+y.length),L=Math.max(y.length,parseInt(l.result.count,10)||0),h=!!l.result.has_more;y.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?y.slice():n.visibleRecords.concat(y),n.offset=u,n.totalCount=L,n.hasMore=h,E(),$()}catch(I){throw g===n.requestToken&&i("Unable to load oils catalog."),I}finally{g===n.requestToken&&(n.loading=!1,A())}}d.api={fetchCatalogPage:f}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.bulkOils=e.bulkOils||{},v=d.shared,G=d.render,z=d.api;if(!v||!G||!z)return;let{round:H,toNumber:x,clamp:C}=e.helpers,{toGrams:A,fromGrams:N}=e.units,E=e.state,{LOCAL_SORT_KEYS:$,SCROLL_FETCH_THRESHOLD:i,SEARCH_DEBOUNCE_MS:q,queueStateSave:f,showAlert:a,getRefs:n,ensureModalState:s,updateSelectionCounters:g,setSelection:r,removeSelection:I,getRecordByKey:l,serializeSelection:y,restoreState:u}=v,{applyClientOrdering:L,sortButtonsLabel:h,renderVisibleRecords:t}=G,{fetchCatalogPage:S}=z,T=null,U=null;function w(){var p;let c=n();c.modalEl&&(!T&&((p=R.bootstrap)!=null&&p.Modal)&&(T=R.bootstrap.Modal.getOrCreateInstance(c.modalEl)),T&&T.hide())}function k(){return document.getElementById("oilRows")}function j(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function F(c){return String(c||"").trim().toLowerCase()}function m(c){var p;return F((p=c==null?void 0:c.querySelector(".oil-typeahead"))==null?void 0:p.value)}function b(c){var Y;let p=String(((Y=c==null?void 0:c.querySelector(".oil-gi-id"))==null?void 0:Y.value)||"").trim();return p||""}function O(c,p){let Y=String(c||"").trim();if(!Y)return null;let V=j(),Z=V.find(le=>String(le.dataset.bulkOilKey||"")===Y);if(Z)return Z;let te=String((p==null?void 0:p.global_item_id)||"").trim();if(te&&(Z=V.find(le=>b(le)===te),Z))return Z;let re=F(p==null?void 0:p.name);return re&&(Z=V.find(le=>m(le)===re),Z)?Z:null}function _(c,p){if(!c||!p)return;c.dataset.bulkOilKey=p.key||"";let Y=c.querySelector(".oil-typeahead"),V=c.querySelector(".oil-sap-koh"),Z=c.querySelector(".oil-iodine"),te=c.querySelector(".oil-fatty"),re=c.querySelector(".oil-gi-id"),le=c.querySelector(".oil-default-unit"),se=c.querySelector(".oil-category"),ee=c.querySelector(".oil-grams"),de=c.querySelector(".oil-percent");Y&&(Y.value=p.name||""),V&&(V.value=p.sap_koh>0?H(p.sap_koh,3):""),Z&&(Z.value=p.iodine>0?H(p.iodine,3):""),te&&(te.value=p.fatty_profile&&Object.keys(p.fatty_profile).length?JSON.stringify(p.fatty_profile):""),re&&(re.value=p.global_item_id||""),le&&(le.value=p.default_unit||""),se&&(se.value=p.ingredient_category_name||""),de&&(de.value=p.selected_pct>0?H(p.selected_pct,2):""),ee&&(ee.value=p.selected_weight_g>0?H(N(p.selected_weight_g),2):"")}function B(c){if(!c||!c.key)return null;let p=O(c.key,c),Y=k();return!p&&Y&&(p=e.oils.buildOilRow(),p&&Y.appendChild(p)),_(p,c),p}function P(c,p){let Y=O(c,p);Y&&(E.lastOilEdit&&E.lastOilEdit.row===Y&&(E.lastOilEdit=null,e.oils.clearSelectedOilProfile()),Y.remove())}function W(){j().forEach(p=>{E.lastOilEdit&&E.lastOilEdit.row===p&&(E.lastOilEdit=null),p.remove()}),e.oils.clearSelectedOilProfile()}function D(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function Q(c,p,Y){let V=String(Y||"").trim();if(V)return V;let Z=String(p||"").trim();if(Z)return`global:${Z}`;let te=F(c);return te?`soapcalc:${te}`:""}function K(){let c={};return j().forEach(p=>{var be,Ce,Ee,_e,ue,Te,Le,ae,ge;let Y=String(((be=p.querySelector(".oil-typeahead"))==null?void 0:be.value)||"").trim(),V=x((Ce=p.querySelector(".oil-sap-koh"))==null?void 0:Ce.value),Z=x((Ee=p.querySelector(".oil-iodine"))==null?void 0:Ee.value),te=String(((_e=p.querySelector(".oil-gi-id"))==null?void 0:_e.value)||"").trim(),re=String(((ue=p.querySelector(".oil-default-unit"))==null?void 0:ue.value)||"gram"),le=String(((Te=p.querySelector(".oil-category"))==null?void 0:Te.value)||""),se=C(x((Le=p.querySelector(".oil-percent"))==null?void 0:Le.value),0,100),ee=C(A((ae=p.querySelector(".oil-grams"))==null?void 0:ae.value),0),de=String(((ge=p.querySelector(".oil-fatty"))==null?void 0:ge.value)||""),ve={};if(de)try{let qe=JSON.parse(de);ve=v.normalizeFattyProfile(qe)}catch{ve={}}let he=Q(Y,te,p.dataset.bulkOilKey);!he||!(Y||se>0||ee>0||V>0||Z>0||Object.keys(ve).length>0)||(p.dataset.bulkOilKey=he,c[he]={key:he,name:Y||"Unnamed oil",sap_koh:V,iodine:Z,fatty_profile:ve,default_unit:re||"gram",ingredient_category_name:le,global_item_id:te?parseInt(te,10):null,source:te?"global":"soapcalc",is_basic:!te,selected_pct:se,selected_weight_g:ee})}),c}function M(){let c=s();c.selection=K(),g()}function J(){let c=s(),p=Object.values(c.selection||{}),Y=new Set(p.map(V=>V.key));j().forEach(V=>{let Z=String(V.dataset.bulkOilKey||"").trim();(!Z||!Y.has(Z))&&V.remove()}),p.slice().sort((V,Z)=>String(V.name||"").localeCompare(String(Z.name||""))).forEach(V=>{B(V)}),D()}async function X(){var Y;let c=n(),p=s();if(c.modalEl){M(),!T&&((Y=R.bootstrap)!=null&&Y.Modal)&&(T=R.bootstrap.Modal.getOrCreateInstance(c.modalEl)),c.searchInput&&(c.searchInput.value=p.query||""),c.modeToggle&&(c.modeToggle.checked=p.mode==="all"),c.viewSelectedToggle&&(c.viewSelectedToggle.checked=!!p.viewSelected),c.unitLabelEl&&(c.unitLabelEl.textContent=E.currentUnit||"g"),T&&T.show(),h(),g();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ne(c){let p=c.target;if(!(p instanceof HTMLElement))return;let Y=p.closest("tr[data-record-key]");if(!Y)return;let V=Y.dataset.recordKey||"",Z=l(V);if(!Z)return;let te=Y.querySelector(".bulk-oil-check"),re=Y.querySelector(".bulk-oil-pct"),le=Y.querySelector(".bulk-oil-weight"),se=C(x(re==null?void 0:re.value),0,100),ee=C(A(le==null?void 0:le.value),0),de=se>0||ee>0;if(!!(te!=null&&te.checked)||de){te&&(te.checked=!0);let be=r(Z,{selected_pct:se,selected_weight_g:ee});B(be)}else I(V),P(V,Z);let he=s();$.has(he.sortKey)||he.viewSelected?(L(),t()):g(),D(),f()}async function ie(c){let p=s();p.mode=c?"all":"basics",f();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}function me(c){let p=s();p.viewSelected=!!c,L(),t(),f()}async function fe(c){let p=c.target instanceof HTMLElement?c.target.closest(".bulk-oil-sort"):null;if(!p)return;let Y=p.getAttribute("data-sort-key")||"name",V=s();if(V.sortKey===Y?V.sortDir=V.sortDir==="asc"?"desc":"asc":(V.sortKey=Y,V.sortDir=Y==="name"?"asc":"desc"),f(),$.has(V.sortKey)){L(),t();return}try{await S({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function ce(){let c=s();c.selection={},W(),($.has(c.sortKey)||c.viewSelected)&&L(),t(),D(),f()}async function oe(){let c=n(),p=s();if(!(!c.scrollEl||p.loading||!p.hasMore||!(c.scrollEl.scrollTop+c.scrollEl.clientHeight>=c.scrollEl.scrollHeight-i)))try{await S({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ye(){U&&R.clearTimeout(U),U=R.setTimeout(async()=>{try{await S({reset:!0})}catch{a("danger","Unable to search oils right now.")}},q)}function pe(){J(),f(),w()}function Se(){var p;let c=n();c.unitLabelEl&&(c.unitLabelEl.textContent=E.currentUnit||"g"),(p=c.modalEl)!=null&&p.classList.contains("show")&&t()}function o(){let c=n();c.modalEl&&(c.openBtn&&c.openBtn.addEventListener("click",()=>{X()}),c.searchInput&&c.searchInput.addEventListener("input",()=>{let p=s();p.query=c.searchInput.value||"",f(),ye()}),c.modeToggle&&c.modeToggle.addEventListener("change",async()=>{await ie(!!c.modeToggle.checked)}),c.viewSelectedToggle&&c.viewSelectedToggle.addEventListener("change",()=>{me(!!c.viewSelectedToggle.checked)}),c.scrollEl&&c.scrollEl.addEventListener("scroll",oe),c.bodyEl&&(c.bodyEl.addEventListener("input",ne),c.bodyEl.addEventListener("change",ne)),c.modalEl.querySelectorAll(".bulk-oil-sort").forEach(p=>{p.addEventListener("click",fe)}),c.importBtn&&c.importBtn.addEventListener("click",()=>{pe()}),c.clearBtn&&c.clearBtn.addEventListener("click",()=>{ce()}),c.modalEl.addEventListener("shown.bs.modal",()=>{let p=n();p.searchInput&&p.searchInput.focus()}))}o(),g(),h(),e.bulkOilsModal={openModal:X,serializeSelection:y,restoreState:u,onUnitChanged:Se}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d,round:v,clamp:G,buildSoapcalcSearchBuilder:z}=e.helpers,{formatWeight:H,toGrams:x,fromGrams:C}=e.units,{FRAGRANCE_CATEGORY_SET:A}=e.constants,N=e.state;function E(l,y,u,L,h){var j;let t=document.getElementById(l),S=document.getElementById(y),T=L?document.getElementById(L):null,U=h?document.getElementById(h):null,w=(j=t==null?void 0:t.parentElement)==null?void 0:j.querySelector('[data-role="suggestions"]');if(!t||!w||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let k=z();R.attachMergedInventoryGlobalTypeahead({inputEl:t,listEl:w,mode:"public",giHiddenEl:S,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:k,searchType:"ingredient",resultFilter:(F,m)=>{let b=I(F);return b?u.has(b):m==="inventory"},requireHidden:!1,onSelection:function(F){T&&(T.value=(F==null?void 0:F.default_unit)||""),U&&(U.value=(F==null?void 0:F.ingredient_category_name)||""),e.storage.queueStateSave()}}),t.addEventListener("input",function(){this.value.trim()||(T&&(T.value=""),U&&(U.value=""))})}function $({pctId:l,weightId:y}){var S,T,U;let u=document.getElementById(l),L=u==null?void 0:u.value;if(L!==""&&L!==null&&L!==void 0)return d(L);let h=G(((T=(S=e.oils)==null?void 0:S.getTotalOilsGrams)==null?void 0:T.call(S))||0,0);if(h<=0)return 0;let t=x((U=document.getElementById(y))==null?void 0:U.value);return t<=0?0:t/h*100}function i(){var l,y,u,L,h,t,S,T;return{lactatePct:$({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:$({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:$({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:$({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((y=(l=document.getElementById("additiveLactateName"))==null?void 0:l.value)==null?void 0:y.trim())||"Sodium Lactate",sugarName:((L=(u=document.getElementById("additiveSugarName"))==null?void 0:u.value)==null?void 0:L.trim())||"Sugar",saltName:((t=(h=document.getElementById("additiveSaltName"))==null?void 0:h.value)==null?void 0:t.trim())||"Salt",citricName:((T=(S=document.getElementById("additiveCitricName"))==null?void 0:S.value)==null?void 0:T.trim())||"Citric Acid"}}function q(l){let y=(L,h)=>{let t=document.getElementById(L);t&&(t.tagName==="INPUT"?t.value=h:t.textContent=h)},u=L=>L>0?v(C(L),2):"";y("additiveLactateWeight",u(d(l==null?void 0:l.lactateG))),y("additiveSugarWeight",u(d(l==null?void 0:l.sugarG))),y("additiveSaltWeight",u(d(l==null?void 0:l.saltG))),y("additiveCitricWeight",u(d(l==null?void 0:l.citricG))),y("additiveCitricLyeOut",H(d(l==null?void 0:l.citricLyeG)))}function f(l){var S;let y=G(d(l),0),u=(S=e.state)==null?void 0:S.lastCalc,L=G(d(u==null?void 0:u.totalOils),0),h=Math.abs(L-y)<.01,t=u!=null&&u.additives&&h?u.additives:{lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0};return q(t),t}function a(l){let y=l.querySelector(".fragrance-typeahead"),u=l.querySelector(".fragrance-gi-id"),L=l.querySelector(".fragrance-default-unit"),h=l.querySelector(".fragrance-category"),t=l.querySelector('[data-role="suggestions"]');if(!y||!t||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let S=z();R.attachMergedInventoryGlobalTypeahead({inputEl:y,listEl:t,mode:"public",giHiddenEl:u,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:S,searchType:"ingredient",resultFilter:(T,U)=>{let w=I(T);return w?A.has(w):U==="inventory"},requireHidden:!1,onSelection:function(T){L&&(L.value=(T==null?void 0:T.default_unit)||""),h&&(h.value=(T==null?void 0:T.ingredient_category_name)||""),e.storage.queueStateSave()}}),y.addEventListener("input",function(){this.value.trim()||(L&&(L.value=""),h&&(h.value=""))})}function n(){var u,L;let l=document.getElementById("fragranceRowTemplate"),y=(L=(u=l==null?void 0:l.content)==null?void 0:u.querySelector(".fragrance-row"))==null?void 0:L.cloneNode(!0);return y?(y.querySelectorAll("input").forEach(h=>{h.value=""}),a(y),y.querySelectorAll(".unit-suffix").forEach(h=>{h.dataset.suffix=N.currentUnit}),y):document.createElement("div")}function s(l){let y=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),u=G(l||e.oils.getTotalOilsGrams()||0,0),L=0,h=0;y.forEach(T=>{let U=T.querySelector(".fragrance-grams"),w=T.querySelector(".fragrance-percent"),k=x(U==null?void 0:U.value),j=G(d(w==null?void 0:w.value),0),F=k,m=j;u>0&&(F<=0&&m>0?F=u*(m/100):m<=0&&F>0&&(m=F/u*100)),F>0&&(L+=F),h+=m});let t=document.getElementById("fragrancePercentTotal");t&&(t.textContent=v(h,2));let S=document.getElementById("fragranceTotalComputed");return S&&(S.textContent=L>0?H(L):"--"),{totalGrams:L,totalPct:h}}function g(){let l=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(y=>{var U,w,k,j,F,m,b;let u=((w=(U=y.querySelector(".fragrance-typeahead"))==null?void 0:U.value)==null?void 0:w.trim())||"",L=((k=y.querySelector(".fragrance-grams"))==null?void 0:k.value)||"",h=((j=y.querySelector(".fragrance-percent"))==null?void 0:j.value)||"",t=((F=y.querySelector(".fragrance-gi-id"))==null?void 0:F.value)||"",S=((m=y.querySelector(".fragrance-default-unit"))==null?void 0:m.value)||"",T=((b=y.querySelector(".fragrance-category"))==null?void 0:b.value)||"";!u&&!L&&!h&&!t||l.push({name:u,grams:L,percent:h,gi:t,defaultUnit:S,categoryName:T})}),l}function r(l){let y=document.getElementById("soapVisualGuidanceList");if(!y)return;let u=Array.isArray(l==null?void 0:l.tips)&&l.tips.length?l.tips:["No visual flags detected for this formula."];y.innerHTML=u.map(L=>`<li>${L}</li>`).join("")}function I(l){return!l||typeof l!="object"?null:l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:E,collectAdditiveSettings:i,applyComputedOutputs:q,updateAdditivesOutput:f,updateVisualGuidance:r},e.fragrances={buildFragranceRow:n,updateFragranceTotals:s,collectFragranceData:g}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:d}=e.helpers,{STAGE_CONFIGS:v}=e.constants;function G(C){var E;let A=v[C];if(!A)return;let N=document.getElementById(A.tabId);if(N){if((E=R.bootstrap)!=null&&E.Tab)bootstrap.Tab.getOrCreateInstance(N).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(i=>{i.classList.remove("show","active")}),N.classList.add("active"),N.setAttribute("aria-selected","true");let $=document.getElementById(A.paneId);$&&$.classList.add("show","active")}e.layout.scheduleStageHeightSync(),N.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function z(C){var A,N;if(C===1){let E=document.getElementById("unitGrams");E&&(E.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let $=document.getElementById("moldCylinderCorrection");$&&($.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(A=e.mold)!=null&&A.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(C===2){let E=document.getElementById("oilRows");E&&(E.innerHTML="",E.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(C===3){let E=document.getElementById("lyeTypeNaoh");E&&(E.checked=!0);let $=document.getElementById("waterMethod");$&&($.value="percent");let i=document.getElementById("lyeSuperfat");i&&(i.value="5");let q=document.getElementById("lyePurity");q&&(q.value="100");let f=document.getElementById("waterPct");f&&(f.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(C===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(E=>{let $=document.getElementById(E);$&&($.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(E=>{let $=document.getElementById(E);$&&($.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),C===5){let E=document.getElementById("fragranceRows");E&&(E.innerHTML="",(N=e.fragrances)!=null&&N.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()));let $=document.getElementById("fragrancePercentTotal");$&&($.textContent="0");let i=document.getElementById("fragranceTotalComputed");i&&(i.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),x()}function H(C){var A;if(C===1){let N=d(document.getElementById("moldWaterWeight").value),E=d(document.getElementById("oilTotalTarget").value),$=d(document.getElementById("moldOilPct").value),q=!!document.querySelector('input[name="weight_unit"]:checked')&&(N>0||E>0)&&$>0;return{state:q?"complete":"incomplete",label:q?"Sized":"Needs target"}}if(C===2){let E=Array.from(document.querySelectorAll("#oilRows .oil-row")).some($=>{var a,n,s,g;let i=(n=(a=$.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),q=d((s=$.querySelector(".oil-grams"))==null?void 0:s.value),f=d((g=$.querySelector(".oil-percent"))==null?void 0:g.value);return i&&(q>0||f>0)});return{state:E?"complete":"incomplete",label:E?"Oils added":"Add oils"}}if(C===3){let N=d(document.getElementById("lyeSuperfat").value),E=(A=document.getElementById("waterMethod"))==null?void 0:A.value,i=!!document.querySelector('input[name="lye_type"]:checked')&&!!E&&N>=0;return{state:i?"complete":"incomplete",label:i?"Configured":"Set lye"}}return C===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(E=>d(document.getElementById(E).value)>0)?"Added":"Optional"}:C===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some($=>{var a,n,s,g;let i=(n=(a=$.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),q=d((s=$.querySelector(".fragrance-grams"))==null?void 0:s.value),f=d((g=$.querySelector(".fragrance-percent"))==null?void 0:g.value);return i||q>0||f>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function x(){let C=document.getElementById("soapStageTabList");C&&C.querySelectorAll(".soap-stage-status").forEach(N=>N.remove());let A=document.getElementById("soapStageProgress");A&&(A.textContent="")}e.stages={openStageByIndex:G,resetStage:z,updateStageStatuses:x}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:G}=e.helpers,{computeFattyAcids:z,computeQualities:H,computeOilQualityScores:x}=e.calc,{QUALITY_RANGES:C,QUALITY_HINTS:A,QUALITY_FEEL_HINTS:N,IODINE_RANGE:E,IODINE_SCALE_MAX:$,INS_RANGE:i,INS_SCALE_MAX:q,QUALITY_BASE:f,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:s}=e.constants,{pulseValue:g,showSoapAlert:r}=e.ui;function I({barId:k,fillId:j,value:F,max:m,label:b}){let O=document.getElementById(k),_=document.getElementById(j);if(!O||!_)return null;let B=isFinite(F)?F:0,P=Math.max(0,Math.min(m,B)),W=m>0?P/m*100:0;return _.style.width=`${W}%`,O.setAttribute("aria-valuemin","0"),O.setAttribute("aria-valuemax",String(m)),O.setAttribute("aria-valuenow",P.toFixed(1)),b&&O.setAttribute("aria-label",b),{bar:O,fill:_,value:B}}function l(k,j,F){if(!(!k||!F)){if(k.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(j)){k.classList.add("bg-secondary");return}j<F[0]?k.classList.add("bg-warning"):j>F[1]?k.classList.add("bg-danger"):k.classList.add("bg-success")}}function y(k,j,F,m,b,O){let _=I({barId:k,fillId:j,value:F,max:b,label:O});_&&l(_.fill,F,m)}function u(){let k={hardness:{range:C.hardness,scale:100},cleansing:{range:C.cleansing,scale:100},conditioning:{range:C.conditioning,scale:100},bubbly:{range:C.bubbly,scale:100},creamy:{range:C.creamy,scale:100},iodine:{range:E,scale:$},ins:{range:i,scale:q}};Object.entries(k).forEach(([j,F])=>{let[m,b]=F.range,O=F.scale,_=j.charAt(0).toUpperCase()+j.slice(1),B=j==="iodine"?"iodineBar":j==="ins"?"insBar":`quality${_}Bar`,P=document.getElementById(`quality${_}Safe`);if(P){let K=Math.max(0,Math.min(100,m/O*100)),M=Math.max(0,Math.min(100,(b-m)/O*100));P.style.left=`${K}%`,P.style.width=`${M}%`,P.title=`Safe range ${d(m,0)}-${d(b,0)}`}let W=document.getElementById(B);W&&(W.dataset.safeRange=`${d(m,0)}-${d(b,0)}`);let D=document.getElementById(`quality${_}RangeMin`),Q=document.getElementById(`quality${_}RangeMax`);D&&(D.textContent=d(m,0)),Q&&(Q.textContent=d(b,0))})}function L(k,j){let F=G(k.hardness||0,0,100),m=G(k.bubbly||0,0,100),b=G(k.conditioning||0,0,100),O=G(b+(j||0)*3,0,100),_=document.getElementById("feelHardness"),B=document.getElementById("feelBubbly"),P=document.getElementById("feelConditioning"),W=document.getElementById("feelGreasy");_&&(_.value=d(F,1)),B&&(B.value=d(m,1)),P&&(P.value=d(b,1)),W&&(W.value=d(O,1))}function h(k){s.forEach(j=>{let F=document.getElementById(`fattyBar${j.charAt(0).toUpperCase()}${j.slice(1)}`);if(!F)return;let m=G(v(k[j]),0,100),b=m;F.style.width=`${b}%`,F.style.backgroundColor=n[j]||"var(--color-muted)",F.title=`${j.charAt(0).toUpperCase()}${j.slice(1)}: ${d(m,1)}%`})}function t(){var m;let k=((m=document.getElementById("qualityPreset"))==null?void 0:m.value)||"balanced",j=Array.from(document.querySelectorAll(".quality-focus:checked"));if(k==="none"&&!j.length)return null;let F=k==="none"?{...f}:a[k]?{...a[k]}:{...f};return j.forEach(b=>{let O=b.dataset.attr,_=b.dataset.direction,B=C[O];B&&(F[O]=_==="low"?B[0]:B[1])}),F}function S(){let k=t(),j={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(j).forEach(([F,m])=>{if(!m)return;let b=document.getElementById(`${m.id}Label`);if(!k){m.classList.add("d-none"),b&&(b.textContent="");return}let O=v(k[F]);if(!isFinite(O)){m.classList.add("d-none"),b&&(b.textContent="");return}let _=F==="iodine"?$:F==="ins"?q:100,B=G(O,0,_);m.classList.remove("d-none"),m.style.left=`${B/_*100}%`,m.setAttribute("aria-label",`Apply ${F} target`),m.setAttribute("role","button"),m.setAttribute("tabindex","0"),m.title=`Target ${F}: ${d(O,1)}`,b&&(b.textContent=d(O,1))})}function T(){let k=t();if(!k){r("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let F=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(M=>{var ie,me;let J=e.units.toGrams((ie=M.querySelector(".oil-grams"))==null?void 0:ie.value),X=((me=M.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ne=null;if(X)try{ne=JSON.parse(X)}catch{ne=null}return{row:M,grams:J,fattyProfile:ne}}).filter(M=>M.grams>0);if(!F.length){r("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let m=z(F.map(M=>({grams:M.grams,fattyProfile:M.fattyProfile}))),b=H(m.percent),O={hardness:G((k.hardness-b.hardness)/100,-1,1),cleansing:G((k.cleansing-b.cleansing)/100,-1,1),conditioning:G((k.conditioning-b.conditioning)/100,-1,1),bubbly:G((k.bubbly-b.bubbly)/100,-1,1),creamy:G((k.creamy-b.creamy)/100,-1,1)},_=F.reduce((M,J)=>M+J.grams,0),B=[],P=0,W=.8,D=F.filter(M=>!M.fattyProfile||typeof M.fattyProfile!="object").length;if(D===F.length){r("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(D&&r("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),F.forEach(M=>{let J=x(M.fattyProfile),X=O.hardness*J.hardness+O.cleansing*J.cleansing+O.conditioning*J.conditioning+O.bubbly*J.bubbly+O.creamy*J.creamy,ne=G(1+X*W,.2,1.8),ie=M.grams*ne;B.push({row:M.row,grams:ie}),P+=ie}),P<=0){r("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let Q=_/P,K=e.oils.getOilTargetGrams()||_;B.forEach(M=>{let J=M.grams*Q,X=M.row.querySelector(".oil-grams"),ne=M.row.querySelector(".oil-percent");if(X&&(X.value=J>0?d(e.units.fromGrams(J),2):""),ne&&K>0){let ie=J/K*100;ne.value=ie>0?d(ie,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),r("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function U(k){let{qualities:j,fattyPercent:F,coveragePct:m,iodine:b,ins:O,sapAvg:_,superfat:B,warnings:P}=k,W=m>0;function D(ce,oe){var p,Y;let ye=document.getElementById(`quality${ce}Value`),pe=document.getElementById(`quality${ce}Hint`);if(!ye)return;ye.textContent=W&&isFinite(oe)?d(oe,1):"--",g(ye);let Se=ce.toLowerCase(),o=C[Se],c=I({barId:`quality${ce}Bar`,fillId:`quality${ce}Fill`,value:W?oe:0,max:100,label:ce});c&&o&&(l(c.fill,oe,o),W&&isFinite(oe)?c.bar.title=`${ce}: ${d(oe,1)} (safe ${o[0]}-${o[1]}). ${A[Se]||""}`.trim():c.bar.title=`${ce}: -- (safe ${o[0]}-${o[1]}). ${A[Se]||""}`.trim()),pe&&o&&(!W||!isFinite(oe)?pe.textContent="":oe<o[0]?pe.textContent=((p=N[Se])==null?void 0:p.low)||"":oe>o[1]?pe.textContent=((Y=N[Se])==null?void 0:Y.high)||"":pe.textContent="")}D("Hardness",j.hardness),D("Cleansing",j.cleansing),D("Conditioning",j.conditioning),D("Bubbly",j.bubbly),D("Creamy",j.creamy);let Q=document.getElementById("fattyCoverageNote");Q&&(Q.textContent=m>0?`Fatty acid coverage: ${d(m,1)}% of oils`:"Fatty acid coverage: not enough data yet");let K=document.getElementById("iodineValue"),M=document.getElementById("insValue"),J=document.getElementById("sapAvgValue");K&&(K.textContent=b>0?d(b,1):"--",g(K)),M&&(M.textContent=O>0?d(O,1):"--",g(M)),J&&(J.textContent=_>0?d(_,1):"--",g(J)),y("iodineBar","iodineFill",b,E,$,"Iodine"),y("insBar","insFill",O,i,q,"INS");let X=(F.lauric||0)+(F.myristic||0)+(F.palmitic||0)+(F.stearic||0),ne=(F.ricinoleic||0)+(F.oleic||0)+(F.linoleic||0)+(F.linolenic||0),ie=document.getElementById("fattySatRatioResult");ie&&(ie.textContent=X+ne>0?`${d(X,0)}:${d(ne,0)}`:"--",g(ie)),s.forEach(ce=>{let oe=`fatty${ce.charAt(0).toUpperCase()}${ce.slice(1)}`,ye=F[ce];document.getElementById(oe).textContent=W&&ye?`${d(ye,1)}%`:"--"}),L(j,B||0),h(F),S();let me=Array.isArray(P)?P.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(ce=>`<li>${ce}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var k;document.querySelectorAll(".soap-quality-help").forEach(j=>{let F=j.dataset.quality;A[F]&&j.setAttribute("title",A[F])}),(k=R.bootstrap)!=null&&k.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(j=>{bootstrap.Tooltip.getOrCreateInstance(j)})}e.quality={setQualityRangeBars:u,updateQualityTargets:S,applyQualityTargets:T,updateQualitiesDisplay:U,initQualityTooltips:w}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:G}=e.helpers;function z(i){let q=0,f=0;return(i||[]).forEach(a=>{let n=v(a==null?void 0:a.sapKoh),s=v(a==null?void 0:a.grams);n>0&&s>0&&(q+=n*s,f+=s)}),f>0?q/f:0}function H(i){var I,l,y,u,L,h,t,S,T,U,w,k;let q=i.qualityReport||{},f=q.fatty_acids_pct||{},a=q.qualities||{},n=isFinite(i.sapAvg)&&i.sapAvg>0?i.sapAvg:v(q.sap_avg_koh)||z(i.oils||[]),s=v(q.iodine),g=v(q.ins)||(n&&s?n-s:0),r=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((I=document.getElementById("qualityPreset"))==null?void 0:I.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(j=>j.id),mold:r,oils:(i.oils||[]).map(j=>({name:j.name||null,grams:d(j.grams||0,2),iodine:j.iodine||null,sap_koh:j.sapKoh||null,fatty_profile:j.fattyProfile||null,global_item_id:j.global_item_id||null,default_unit:j.default_unit||null,ingredient_category_name:j.ingredient_category_name||null})),totals:{total_oils_g:d(i.totalOils||0,2),batch_yield_g:d(i.batchYield||0,2),lye_pure_g:d(i.lyePure||0,2),lye_adjusted_g:d(i.lyeAdjusted||0,2),water_g:d(i.water||0,2)},lye:{lye_type:i.lyeType,superfat:i.superfat,purity:i.purity,water_method:i.waterMethod,water_pct:i.waterPct,lye_concentration:i.lyeConcentration,water_ratio:i.waterRatio},additives:{fragrance_pct:((l=i.additives)==null?void 0:l.fragrancePct)||0,lactate_pct:((y=i.additives)==null?void 0:y.lactatePct)||0,sugar_pct:((u=i.additives)==null?void 0:u.sugarPct)||0,salt_pct:((L=i.additives)==null?void 0:L.saltPct)||0,citric_pct:((h=i.additives)==null?void 0:h.citricPct)||0,fragrance_g:d(((t=i.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:d(((S=i.additives)==null?void 0:S.lactateG)||0,2),sugar_g:d(((T=i.additives)==null?void 0:T.sugarG)||0,2),salt_g:d(((U=i.additives)==null?void 0:U.saltG)||0,2),citric_g:d(((w=i.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:d(((k=i.additives)==null?void 0:k.citricLyeG)||0,2)},qualities:{hardness:d(a.hardness||0,1),cleansing:d(a.cleansing||0,1),conditioning:d(a.conditioning||0,1),bubbly:d(a.bubbly||0,1),creamy:d(a.creamy||0,1),iodine:d(s||0,1),ins:d(g||0,1),sap_avg:d(n||0,1)},fatty_acids:f,updated_at:new Date().toISOString()}}function x(i,q,f,a,n){var l,y,u,L,h;let s=(y=(l=document.getElementById(i))==null?void 0:l.value)==null?void 0:y.trim(),g=((u=document.getElementById(q))==null?void 0:u.value)||"",r=a&&((L=document.getElementById(a))==null?void 0:L.value)||"",I=n&&((h=document.getElementById(n))==null?void 0:h.value)||"";return{name:s||f,globalItemId:g?parseInt(g):void 0,defaultUnit:r||void 0,categoryName:I||void 0}}function C(i){let q=[],f=G(i||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var L,h,t,S,T,U,w;let n=(h=(L=a.querySelector(".fragrance-typeahead"))==null?void 0:L.value)==null?void 0:h.trim(),s=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",g=((S=a.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",r=((T=a.querySelector(".fragrance-category"))==null?void 0:T.value)||"",I=(U=a.querySelector(".fragrance-grams"))==null?void 0:U.value,l=(w=a.querySelector(".fragrance-percent"))==null?void 0:w.value,y=e.units.toGrams(I),u=G(v(l),0);y<=0&&u>0&&f>0&&(y=f*(u/100)),!(!n&&!s&&y<=0)&&q.push({name:n||"Fragrance/Essential Oils",globalItemId:s?parseInt(s):void 0,defaultUnit:g||void 0,categoryName:r||void 0,grams:y,pct:u})}),q}function A(i,q){let f=[];return document.querySelectorAll(`#${i} .row`).forEach(function(a){var l,y,u;let n=(y=(l=a.querySelector(".tool-typeahead"))==null?void 0:l.value)==null?void 0:y.trim(),s=((u=a.querySelector(".tool-gi-id"))==null?void 0:u.value)||"",g=a.querySelector(".tool-qty"),r=a.querySelector(".tool-unit"),I=g&&g.value!=="";!n&&!s||(q==="container"?f.push({name:n||void 0,global_item_id:s?parseInt(s):void 0,quantity:I?parseFloat(g.value):1}):f.push({name:n||void 0,global_item_id:s?parseInt(s):void 0,quantity:I?parseFloat(g.value):0,unit:((r==null?void 0:r.value)||"").trim()||"gram"}))}),f}function N(i){let q=e.config.isAuthenticated?"member":"public",f=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(i,{context:q,mode:f,unitOptionsHtml:e.config.unitOptionsHtml})}function E(i,q){let f=N(i),a=f.querySelector(".tool-typeahead"),n=f.querySelector(".tool-qty");a&&(a.value=q),n&&i==="container"&&(n.value=1),i==="container"?document.getElementById("tool-containers").appendChild(f):i==="consumable"?document.getElementById("tool-consumables").appendChild(f):document.getElementById("tool-ingredients").appendChild(f)}function $(i){var s,g,r,I;let q=H(i),f=(i.oils||[]).map(l=>({name:l.name||void 0,global_item_id:l.global_item_id||void 0,quantity:l.grams,unit:"gram",default_unit:l.default_unit||void 0,ingredient_category_name:l.ingredient_category_name||void 0})),a=i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(i.lyeAdjusted>0&&f.push({name:a,quantity:d(i.lyeAdjusted,2),unit:"gram"}),i.water>0&&f.push({name:"Distilled Water",quantity:d(i.water,2),unit:"gram"}),C(i.totalOils||0).forEach(l=>{l.grams>0&&f.push({name:l.name,global_item_id:l.globalItemId,quantity:d(l.grams,2),unit:"gram",default_unit:l.defaultUnit,ingredient_category_name:l.categoryName})}),((s=i.additives)==null?void 0:s.lactateG)>0){let l=x("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");f.push({name:l.name,global_item_id:l.globalItemId,quantity:d(i.additives.lactateG,2),unit:"gram",default_unit:l.defaultUnit,ingredient_category_name:l.categoryName})}if(((g=i.additives)==null?void 0:g.sugarG)>0){let l=x("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");f.push({name:l.name,global_item_id:l.globalItemId,quantity:d(i.additives.sugarG,2),unit:"gram",default_unit:l.defaultUnit,ingredient_category_name:l.categoryName})}if(((r=i.additives)==null?void 0:r.saltG)>0){let l=x("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");f.push({name:l.name,global_item_id:l.globalItemId,quantity:d(i.additives.saltG,2),unit:"gram",default_unit:l.defaultUnit,ingredient_category_name:l.categoryName})}if(((I=i.additives)==null?void 0:I.citricG)>0){let l=x("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");f.push({name:l.name,global_item_id:l.globalItemId,quantity:d(i.additives.citricG,2),unit:"gram",default_unit:l.defaultUnit,ingredient_category_name:l.categoryName}),f.push({name:"Extra Lye for Citric Acid",quantity:d(i.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((i.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:i.superfat,soap_lye_type:i.lyeType,soap_lye_purity:i.purity,soap_water_method:i.waterMethod,soap_water_pct:i.waterPct,soap_lye_concentration:i.lyeConcentration,soap_water_ratio:i.waterRatio,soap_oils_total_g:i.totalOils,soap_lye_g:i.lyeAdjusted,soap_water_g:i.water},ingredients:f.concat(A("tool-ingredients","ingredient")),consumables:A("tool-consumables","consumable"),containers:A("tool-containers","container"),notes:JSON.stringify(q)}}e.recipePayload={collectFragranceRows:C,collectDraftLines:A,buildLineRow:N,addStubLine:E,buildSoapRecipePayload:$}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v,clamp:G}=e.helpers,{formatWeight:z,formatPercent:H}=e.units;function x(){var I;let a=((I=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:I.value)||"NaOH",n=document.getElementById("lyePurity"),s=n==null?void 0:n.value,g=v(n==null?void 0:n.value),r=a==="NaOH"?"NaOH":"KOH";return(s===""||s===null||s===void 0||!isFinite(g))&&(g=100),{selected:a,lyeType:r,purity:g}}function C(){let a=document.getElementById("lyePurity"),n=x();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let s=document.getElementById("lyePurityHint");s&&(s.textContent="90% KOH selected. Safe default purity is 90%.")}else{let s=document.getElementById("lyePurityHint");s&&(s.textContent="Safe default is 100%.")}}function A(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function N(a=null,n=null){var I;let s=document.getElementById("stageWaterOutput"),g=document.getElementById("stageWaterComputedHint"),r=n||(a==null?void 0:a.waterMethod)||((I=document.getElementById("waterMethod"))==null?void 0:I.value)||"percent";if(s){let l=a&&isFinite(a.waterG)&&a.waterG>0;s.textContent=l?z(a.waterG):"--"}if(g){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){g.textContent=`Set oils in Stage 2 to calculate water. ${A(r)}`;return}if(r==="concentration"){let l=a.lyeConcentrationInput||a.lyeConcentration||0;g.textContent=`Using ${d(l,1)}% lye concentration from ${z(a.lyeAdjusted||0)} lye.`;return}if(r==="ratio"){let l=a.waterRatioInput||a.waterRatio||0;g.textContent=`Using ${d(l,2)} : 1 water-to-lye ratio from ${z(a.lyeAdjusted||0)} lye.`;return}g.textContent=`Using ${d(a.waterPct||0,1)}% of total oils (${z(a.totalOils)}).`}}function E(a=null,n=null){var U;let s=document.getElementById("lyeWaterPreviewAnchor"),g=document.getElementById("lyePreview"),r=document.getElementById("waterPreview"),I=document.getElementById("concPreview"),l=document.getElementById("ratioPreview");if(!s&&!g&&!r&&!I&&!l)return;let y=(w,k)=>{w&&(w.textContent=k)},u=n||(a==null?void 0:a.waterMethod)||((U=document.getElementById("waterMethod"))==null?void 0:U.value)||"percent",L=v(a==null?void 0:a.totalOils),h=v(a==null?void 0:a.lyeAdjusted),t=v(a==null?void 0:a.waterG);if(L<=0||h<=0){y(s,"Based on -- oils. All values update live as you change inputs."),y(g,"--"),y(r,"--"),y(I,"--"),y(l,"--");return}let S=v(a==null?void 0:a.lyeConcentration)>0?v(a==null?void 0:a.lyeConcentration):h+t>0?h/(h+t)*100:0,T=v(a==null?void 0:a.waterRatio)>0?v(a==null?void 0:a.waterRatio):h>0?t/h:0;if(y(s,`Based on ${z(L)} oils. All values update live as you change inputs.`),y(g,z(h)),y(r,z(t)),y(I,S>0?H(S):"--"),y(l,T>0?`${d(T,2)} : 1`:"--"),u==="concentration"){let w=v(a==null?void 0:a.lyeConcentrationInput);w>0&&y(I,H(w))}if(u==="ratio"){let w=v(a==null?void 0:a.waterRatioInput);w>0&&y(l,`${d(w,2)} : 1`)}}function $(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(s=>{s.classList.toggle("d-none",s.dataset.method!==a)}),N(null,a),E(null,a)}function i(){let a=e.oils.updateOilTotals(),n=a.totalWeight,s=a.totalPct,g=[],r=e.oils.collectOilData(),I=e.oils.getOilTargetGrams(),y=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(u=>G(v(u.value),0)).some(u=>u>0);return(!r.length||n<=0)&&g.push("Add at least one oil with a weight or percent."),!I&&n<=0&&y&&g.push("Enter a total oils target or weights to convert percentages."),I>0&&s>0&&Math.abs(s-100)>.5&&g.push("Oil percentages should total 100% (use Normalize to fix)."),I>0&&n>I+.01?g.push("Oil weights exceed the mold target."):!I&&s>100.01&&g.push("Oil percentages exceed 100%."),{ok:g.length===0,errors:g,totals:a,oils:r}}function q(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,s=v(n);return(n===""||n===null||n===void 0||!isFinite(s))&&(s=5),s}function f(){var l,y,u,L;let n=x().purity;isFinite(n)||(n=100);let s=((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",g=v((y=document.getElementById("waterPct"))==null?void 0:y.value),r=v((u=document.getElementById("lyeConcentration"))==null?void 0:u.value),I=v((L=document.getElementById("waterRatio"))==null?void 0:L.value);return{purity:n,waterMethod:s,waterPct:g,lyeConcentration:r,waterRatio:I}}e.runnerInputs={getLyeSelection:x,applyLyeSelection:C,setWaterMethod:$,updateStageWaterSummary:N,updateLiveCalculationPreview:E,validateCalculation:i,readSuperfatInput:q,sanitizeLyeInputs:f}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{getStorage:d}=e.helpers;function v(){if(!e.config.calcLimit)return{count:0,date:null};let C=d();if(!C)return{count:0,date:null};try{let A=C.getItem("soap_calc_usage"),N=new Date().toISOString().slice(0,10);if(!A)return{count:0,date:N};let E=JSON.parse(A);return!E||E.date!==N?{count:0,date:N}:{count:Number(E.count)||0,date:N}}catch{return{count:0,date:null}}}function G(C){if(!e.config.calcLimit)return;let A=d();if(!A)return;let N=new Date().toISOString().slice(0,10);try{A.setItem("soap_calc_usage",JSON.stringify({count:C,date:N}))}catch{}}function z(){return e.config.calcLimit&&v().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function H(){if(!e.config.calcLimit)return;let A=v().count+1;G(A);let N=Math.max(0,e.config.calcLimit-A);N<=1&&e.ui.showSoapAlert("info",`You have ${N} calculation${N===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function x(C){if(!e.config.calcLimit||C===null||C>1)return;let A=document.getElementById("soapSignupModal");A&&(R.bootstrap&&R.bootstrap.Modal?R.bootstrap.Modal.getOrCreateInstance(A).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:z,consumeCalcQuota:H,maybeShowSignupModal:x}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state;function v({oils:z,selection:H,superfat:x,purity:C,waterMethod:A,waterPct:N,lyeConcentration:E,waterRatio:$,totalOils:i}){let q=e.additives.collectAdditiveSettings(),f=e.recipePayload.collectFragranceRows(i||0);return{oils:(z||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:f.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:q.lactatePct||0,sugar_pct:q.sugarPct||0,salt_pct:q.saltPct||0,citric_pct:q.citricPct||0,lactate_name:q.lactateName||"Sodium Lactate",sugar_name:q.sugarName||"Sugar",salt_name:q.saltName||"Salt",citric_name:q.citricName||"Citric Acid"},lye:{selected:(H==null?void 0:H.selected)||"NaOH",superfat:x,purity:C},water:{method:A,water_pct:N,lye_concentration:E,water_ratio:$},meta:{unit_display:d.currentUnit||"g"}}}async function G(z){var A;let H=((A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"))||"",x=new AbortController,C=R.setTimeout(()=>x.abort(),2500);try{let N=await fetch("/tools/api/soap/calculate",{method:"POST",signal:x.signal,headers:{"Content-Type":"application/json",...H?{"X-CSRFToken":H}:{}},body:JSON.stringify(z||{})});if(!N.ok)return null;let E=await N.json();return!E||E.success!==!0||typeof E.result!="object"?null:E.result}catch{return null}finally{R.clearTimeout(C)}}e.runnerService={buildServicePayload:v,calculateWithSoapService:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:d,toNumber:v}=e.helpers,{formatWeight:G,formatPercent:z}=e.units,H=e.state,x={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function C(i){return(i||[]).map(q=>{var f;return{name:q.name||null,grams:v(q.grams),sapKoh:v((f=q.sap_koh)!=null?f:q.sapKoh),iodine:v(q.iodine),fattyProfile:q.fatty_profile||q.fattyProfile||null,global_item_id:q.global_item_id||null,default_unit:q.default_unit||null,ingredient_category_name:q.ingredient_category_name||null}})}function A(i,q){let f=document.getElementById(i);f&&(f.textContent=q)}function N({resultsCard:i,lyeAdjusted:q,waterData:f,batchYield:a,totalOils:n,superfat:s}){let g=document.getElementById("resultsCard");g&&(g.style.display="block");let r=v(i.water_lye_ratio)||f.waterRatio;A("lyeAdjustedOutput",G(v(i.lye_adjusted_g)||q)),A("waterOutput",G(v(i.water_g)||f.waterG)),A("batchYieldOutput",G(a)),A("lyeConcentrationOutput",z(v(i.lye_concentration_pct)||f.lyeConcentration)),A("waterRatioOutput",isFinite(r)&&r>0?d(r,2).toString():"--"),A("totalOilsOutput",G(n)),A("superfatOutput",z(s)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(I=>e.ui.pulseValue(document.getElementById(I)))}function E({showAlerts:i,lyeTotals:q,purity:f,waterData:a}){if(!i)return;q.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),f<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${d(f,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function $({serviceResult:i,validation:q,selection:f,superfat:a,purity:n,waterMethod:s,waterPct:g,lyeConcentrationInput:r,waterRatioInput:I,showAlerts:l}){var M;let y=i.lye_type||f.lyeType||"NaOH",u=i.lye_selected||f.selected||null,L=v(i.total_oils_g)||q.totals.totalWeight,h=v(i.superfat_pct),t=isFinite(h)?h:a,S={sapAvg:v(i.sap_avg_koh),usedFallback:!!i.used_sap_fallback},T=v(i.lye_pure_g),w=Object.prototype.hasOwnProperty.call(i,"lye_adjusted_base_g")?v(i.lye_adjusted_base_g):null,k=v(i.lye_adjusted_g),j=v(i.lye_purity_pct)||n,F=i.water_method||s,m=v(i.water_pct)||g,b=v(i.lye_concentration_input_pct)||r,O=v(i.water_ratio_input)||I,_={waterG:v(i.water_g),lyeConcentration:v(i.lye_concentration_pct),waterRatio:v(i.water_lye_ratio)},B=i.results_card||{},P=i.quality_report||{},W=C(i.oils||q.oils),D={waterG:_.waterG,lyeAdjusted:k,totalOils:L,waterMethod:F,waterPct:m,lyeConcentrationInput:b,waterRatioInput:O,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio};e.runnerInputs.updateStageWaterSummary(D),e.runnerInputs.updateLiveCalculationPreview(D);let Q=i.additives||x;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(Q);let K=v(B.batch_yield_g)||L+k+_.waterG+Q.fragranceG+Q.lactateG+Q.sugarG+Q.saltG+Q.citricG;return(M=e.mold)!=null&&M.updateWetBatterWarning&&e.mold.updateWetBatterWarning(K),N({resultsCard:B,lyeAdjusted:k,waterData:_,batchYield:K,totalOils:L,superfat:t}),e.ui.updateResultsWarnings(_),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:P.qualities||{},fattyPercent:P.fatty_acids_pct||{},coveragePct:v(P.coverage_pct),iodine:v(P.iodine),ins:v(P.ins),sapAvg:S.sapAvg,superfat:t,waterData:_,additives:Q,oils:W,totalOils:L,warnings:P.warnings||[]}),e.additives.updateVisualGuidance({tips:P.visual_guidance||[]}),e.stages.updateStageStatuses(),E({showAlerts:l,lyeTotals:S,purity:j,waterData:_}),H.lastCalc={totalOils:L,oils:W,lyeType:y,lyeSelected:u,superfat:t,purity:j,lyePure:T,lyeAdjustedBase:w,lyeAdjusted:k,water:_.waterG,waterMethod:F,waterPct:m,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio,sapAvg:S.sapAvg,usedSapFallback:S.usedFallback,additives:Q,batchYield:K,qualityReport:P,export:i.export||null},H.lastCalc}e.runnerRender={applyServiceResult:$}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},d=e.state,v=e.runnerInputs,G=e.runnerQuota,z=e.runnerService,H=e.runnerRender;async function x(C={}){var N;let A={consumeQuota:!1,showAlerts:!0,...C};try{A.showAlerts&&e.ui.clearSoapAlerts();let E=v.validateCalculation();if(!E.ok)return v.updateStageWaterSummary(null),v.updateLiveCalculationPreview(null),(N=e.mold)!=null&&N.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),A.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${E.errors.map(g=>`<li>${g}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(A.consumeQuota&&!G.canConsumeCalcQuota())return null;let $=v.readSuperfatInput(),i=v.getLyeSelection(),q=v.sanitizeLyeInputs(),f=(d.calcRequestSeq||0)+1;d.calcRequestSeq=f;let a=z.buildServicePayload({oils:E.oils,selection:i,superfat:$,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentration:q.lyeConcentration,waterRatio:q.waterRatio,totalOils:E.totals.totalWeight}),n=await z.calculateWithSoapService(a);if(f!==d.calcRequestSeq)return d.lastCalc;if(!n)return A.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let s=H.applyServiceResult({serviceResult:n,validation:E,selection:i,superfat:$,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentrationInput:q.lyeConcentration,waterRatioInput:q.waterRatio,showAlerts:A.showAlerts});return A.consumeQuota&&G.consumeCalcQuota(),s}catch{return A.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...C)=>v.getLyeSelection(...C),applyLyeSelection:(...C)=>v.applyLyeSelection(...C),setWaterMethod:(...C)=>v.setWaterMethod(...C),updateLiveCalculationPreview:(...C)=>v.updateLiveCalculationPreview(...C),calculateAll:x,buildSoapRecipePayload:(...C)=>e.recipePayload.buildSoapRecipePayload(...C),buildLineRow:(...C)=>e.recipePayload.buildLineRow(...C),addStubLine:(...C)=>e.recipePayload.addStubLine(...C),maybeShowSignupModal:(...C)=>G.maybeShowSignupModal(...C)}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{formatTime:d,getStorage:v}=e.helpers,G="soap_tool_state_v2";function z(f,a){let n=[];return document.querySelectorAll(`#${f} .row`).forEach(g=>{var L,h,t;let r=(h=(L=g.querySelector(".tool-typeahead"))==null?void 0:L.value)==null?void 0:h.trim(),I=((t=g.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",l=g.querySelector(".tool-qty"),y=g.querySelector(".tool-unit"),u=l&&l.value!==""?e.helpers.toNumber(l.value):null;!r&&!I||(a==="container"?n.push({name:r||"",global_item_id:I?parseInt(I):null,quantity:u&&u>0?u:1}):n.push({name:r||"",global_item_id:I?parseInt(I):null,quantity:u&&u>=0?u:0,unit:(y==null?void 0:y.value)||"gram"}))}),n}function H(){let f=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var h,t,S,T,U,w,k,j,F,m;let n=((t=(h=a.querySelector(".oil-typeahead"))==null?void 0:h.value)==null?void 0:t.trim())||"",s=((S=a.querySelector(".oil-grams"))==null?void 0:S.value)||"",g=((T=a.querySelector(".oil-percent"))==null?void 0:T.value)||"",r=((U=a.querySelector(".oil-sap-koh"))==null?void 0:U.value)||"",I=((w=a.querySelector(".oil-iodine"))==null?void 0:w.value)||"",l=((k=a.querySelector(".oil-fatty"))==null?void 0:k.value)||"",y=((j=a.querySelector(".oil-gi-id"))==null?void 0:j.value)||"",u=((F=a.querySelector(".oil-default-unit"))==null?void 0:F.value)||"",L=((m=a.querySelector(".oil-category"))==null?void 0:m.value)||"";!n&&!s&&!g&&!y||f.push({name:n,grams:s,percent:g,sap:r,iodine:I,fattyRaw:l,gi:y,defaultUnit:u,categoryName:L})}),f}function x(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let f=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var u,L,h,t,S,T,U;let s=((L=(u=n.querySelector(".fragrance-typeahead"))==null?void 0:u.value)==null?void 0:L.trim())||"",g=((h=n.querySelector(".fragrance-grams"))==null?void 0:h.value)||"",r=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",I=((S=n.querySelector(".fragrance-gi-id"))==null?void 0:S.value)||"",l=((T=n.querySelector(".fragrance-default-unit"))==null?void 0:T.value)||"",y=((U=n.querySelector(".fragrance-category"))==null?void 0:U.value)||"";!s&&!g&&!r&&!I||f.push({name:s,grams:g,percent:r,gi:I,defaultUnit:l,categoryName:y})}),f}function C(f,a){let n=document.getElementById("oilRows");if(!n||!f)return;let s=e.oils.buildOilRow();s.querySelector(".oil-typeahead").value=f.name||"",s.querySelector(".oil-grams").value=f.grams||"",s.querySelector(".oil-percent").value=f.percent||"",s.querySelector(".oil-sap-koh").value=f.sap||"",s.querySelector(".oil-iodine").value=f.iodine||"",s.querySelector(".oil-fatty").value=f.fattyRaw||"",s.querySelector(".oil-gi-id").value=f.gi||"";let g=s.querySelector(".oil-default-unit");g&&(g.value=f.defaultUnit||"");let r=s.querySelector(".oil-category");r&&(r.value=f.categoryName||"");let I=Array.from(n.children);return a>=I.length?n.appendChild(s):n.insertBefore(s,I[a]),s}function A(){var n,s,g,r,I,l,y,u,L,h,t,S,T,U,w,k,j,F,m,b,O,_,B,P,W,D,Q;let f=v();if(!f)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:H(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((s=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:s.value)||"NaOH",lye_purity:((g=document.getElementById("lyePurity"))==null?void 0:g.value)||"100",water_method:((r=document.getElementById("waterMethod"))==null?void 0:r.value)||"percent",water_pct:((I=document.getElementById("waterPct"))==null?void 0:I.value)||"",lye_concentration:((l=document.getElementById("lyeConcentration"))==null?void 0:l.value)||"",water_ratio:((y=document.getElementById("waterRatio"))==null?void 0:y.value)||""},additives:{fragrances:x(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((u=document.getElementById("additiveLactateName"))==null?void 0:u.value)||"",lactate_gi:((L=document.getElementById("additiveLactateGi"))==null?void 0:L.value)||"",lactate_unit:((h=document.getElementById("additiveLactateUnit"))==null?void 0:h.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((S=document.getElementById("additiveSugarName"))==null?void 0:S.value)||"",sugar_gi:((T=document.getElementById("additiveSugarGi"))==null?void 0:T.value)||"",sugar_unit:((U=document.getElementById("additiveSugarUnit"))==null?void 0:U.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((k=document.getElementById("additiveSaltName"))==null?void 0:k.value)||"",salt_gi:((j=document.getElementById("additiveSaltGi"))==null?void 0:j.value)||"",salt_unit:((F=document.getElementById("additiveSaltUnit"))==null?void 0:F.value)||"",salt_category:((m=document.getElementById("additiveSaltCategory"))==null?void 0:m.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((b=document.getElementById("additiveCitricName"))==null?void 0:b.value)||"",citric_gi:((O=document.getElementById("additiveCitricGi"))==null?void 0:O.value)||"",citric_unit:((_=document.getElementById("additiveCitricUnit"))==null?void 0:_.value)||"",citric_category:((B=document.getElementById("additiveCitricCategory"))==null?void 0:B.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((P=document.getElementById("moldShape"))==null?void 0:P.value)||"loaf",cylinder_correction:!!((W=document.getElementById("moldCylinderCorrection"))!=null&&W.checked),cylinder_factor:((D=document.getElementById("moldCylinderFactor"))==null?void 0:D.value)||"0.85"},quality:{preset:((Q=document.getElementById("qualityPreset"))==null?void 0:Q.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(K=>K.id)},lines:{ingredients:z("tool-ingredients","ingredient"),consumables:z("tool-consumables","consumable"),containers:z("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"basics",selections:[]},updated_at:Date.now()};try{f.setItem(G,JSON.stringify(a));let K=document.getElementById("soapLastSaved");K&&(K.textContent=d(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function N(){var r,I,l;let f=v();if(!f)return;let a=f.getItem(G);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let y=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);y&&(y.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let s=document.getElementById("oilRows");if(s&&(s.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(u=>{let L=e.oils.buildOilRow();L.querySelector(".oil-typeahead").value=u.name||"",L.querySelector(".oil-grams").value=u.grams||"",L.querySelector(".oil-percent").value=u.percent||"",L.querySelector(".oil-sap-koh").value=u.sap||"",L.querySelector(".oil-iodine").value=u.iodine||"",L.querySelector(".oil-fatty").value=u.fattyRaw||"",L.querySelector(".oil-gi-id").value=u.gi||"";let h=L.querySelector(".oil-default-unit");h&&(h.value=u.defaultUnit||"");let t=L.querySelector(".oil-category");t&&(t.value=u.categoryName||""),s.appendChild(L)})),n.lye_form){let y=document.getElementById("lyeSuperfat");y&&(y.value=n.lye_form.superfat||"5");let u=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);u&&(u.checked=!0);let L=document.getElementById("lyePurity");L&&(L.value=n.lye_form.lye_purity||"100");let h=document.getElementById("waterMethod");h&&(h.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let S=document.getElementById("lyeConcentration");S&&(S.value=n.lye_form.lye_concentration||"");let T=document.getElementById("waterRatio");T&&(T.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let y=document.getElementById("fragranceRows");if(y&&((r=e.fragrances)!=null&&r.buildFragranceRow)){y.innerHTML="";let P=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(P)P.forEach(W=>{let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=W.name||"",D.querySelector(".fragrance-grams").value=W.grams||"",D.querySelector(".fragrance-percent").value=W.percent||"",D.querySelector(".fragrance-gi-id").value=W.gi||"";let Q=D.querySelector(".fragrance-default-unit");Q&&(Q.value=W.defaultUnit||"");let K=D.querySelector(".fragrance-category");K&&(K.value=W.categoryName||""),y.appendChild(D)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let W=e.fragrances.buildFragranceRow();W.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",W.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",W.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",y.appendChild(W)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let u=document.getElementById("additiveLactateName");u&&(u.value=n.additives.lactate_name||"");let L=document.getElementById("additiveLactateGi");L&&(L.value=n.additives.lactate_gi||"");let h=document.getElementById("additiveLactateUnit");h&&(h.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let S=document.getElementById("additiveSugarName");S&&(S.value=n.additives.sugar_name||"");let T=document.getElementById("additiveSugarGi");T&&(T.value=n.additives.sugar_gi||"");let U=document.getElementById("additiveSugarUnit");U&&(U.value=n.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let k=document.getElementById("additiveSaltName");k&&(k.value=n.additives.salt_name||"");let j=document.getElementById("additiveSaltGi");j&&(j.value=n.additives.salt_gi||"");let F=document.getElementById("additiveSaltUnit");F&&(F.value=n.additives.salt_unit||"");let m=document.getElementById("additiveSaltCategory");m&&(m.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let b=document.getElementById("additiveCitricName");b&&(b.value=n.additives.citric_name||"");let O=document.getElementById("additiveCitricGi");O&&(O.value=n.additives.citric_gi||"");let _=document.getElementById("additiveCitricUnit");_&&(_.value=n.additives.citric_unit||"");let B=document.getElementById("additiveCitricCategory");B&&(B.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let y=document.getElementById("moldShape");y&&(y.value=n.mold.shape||"loaf");let u=document.getElementById("moldCylinderCorrection");u&&(u.checked=!!n.mold.cylinder_correction);let L=document.getElementById("moldCylinderFactor");L&&(L.value=n.mold.cylinder_factor||"0.85");let h=document.getElementById("oilTotalTarget");(I=e.mold)!=null&&I.syncMoldPctFromTarget&&((l=e.mold)!=null&&l.syncTargetFromMold)&&(e.units.toGrams(h==null?void 0:h.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let y=document.getElementById("qualityPreset");if(y){let u=n.quality.preset||"balanced",L=Array.from(y.options).find(h=>h.value===u);y.value=L?u:"balanced"}document.querySelectorAll(".quality-focus").forEach(u=>{u.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(u.id)})}function g(y,u,L){let h=document.getElementById(y);h&&(h.innerHTML="",(u||[]).forEach(t=>{let S=e.runner.buildLineRow(L),T=S.querySelector(".tool-typeahead"),U=S.querySelector(".tool-gi-id"),w=S.querySelector(".tool-qty"),k=S.querySelector(".tool-unit");T&&(T.value=t.name||""),U&&(U.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),k&&t.unit&&Array.from(k.options).find(F=>F.value===t.unit)&&(k.value=t.unit),h.appendChild(S)}))}if(n.lines&&(g("tool-ingredients",n.lines.ingredients,"ingredient"),g("tool-consumables",n.lines.consumables,"consumable"),g("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let y=document.getElementById("soapLastSaved");y&&(y.textContent=d(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let E=null;function $(){E&&clearTimeout(E),E=setTimeout(A,350)}let i=null;function q(){i&&clearTimeout(i),i=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:A,restoreState:N,serializeLines:z,serializeOils:H,restoreOilRow:C,queueStateSave:$,queueAutoCalc:q}})(window);(function(R){"use strict";var pe,Se;let e=R.SoapTool=R.SoapTool||{},{LACTATE_CATEGORY_SET:d,SUGAR_CATEGORY_SET:v,SALT_CATEGORY_SET:G,CITRIC_CATEGORY_SET:z}=e.constants,{round:H,toNumber:x,clamp:C}=e.helpers,{formatWeight:A,formatPercent:N,toGrams:E}=e.units,$=e.state;async function i(){var c;let o=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return o||((c=e.ui)!=null&&c.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function q(o){let c=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(p=>{var le,se,ee,de;let Y=(se=(le=p.querySelector(".fragrance-typeahead"))==null?void 0:le.value)==null?void 0:se.trim(),V=(ee=p.querySelector(".fragrance-grams"))==null?void 0:ee.value,Z=(de=p.querySelector(".fragrance-percent"))==null?void 0:de.value,te=E(V),re=C(x(Z),0);te<=0&&re>0&&o>0&&(te=o*(re/100)),!(te<=0&&re<=0&&!Y)&&(!re&&te>0&&o>0&&(re=te/o*100),c.push({name:Y||"Fragrance/Essential Oils",grams:te,pct:re}))}),c}function f(o){var te,re,le,se,ee,de,ve,he;let c=[];if(!o)return c;let p=((re=(te=document.getElementById("additiveLactateName"))==null?void 0:te.value)==null?void 0:re.trim())||"Sodium Lactate",Y=((se=(le=document.getElementById("additiveSugarName"))==null?void 0:le.value)==null?void 0:se.trim())||"Sugar",V=((de=(ee=document.getElementById("additiveSaltName"))==null?void 0:ee.value)==null?void 0:de.trim())||"Salt",Z=((he=(ve=document.getElementById("additiveCitricName"))==null?void 0:ve.value)==null?void 0:he.trim())||"Citric Acid";return o.lactateG>0&&c.push({name:p,grams:o.lactateG,pct:o.lactatePct}),o.sugarG>0&&c.push({name:Y,grams:o.sugarG,pct:o.sugarPct}),o.saltG>0&&c.push({name:V,grams:o.saltG,pct:o.saltPct}),o.citricG>0&&c.push({name:Z,grams:o.citricG,pct:o.citricPct}),c}function a(o){var re,le;let c=[],p=x((re=o.additives)==null?void 0:re.citricLyeG),Y=x((le=o.additives)==null?void 0:le.citricG),V=String(o.lyeType||"NaOH").toUpperCase();return p>0&&Y>0&&(V==="KOH"?c.push("Citric-acid lye adjustment used 0.71 x citric acid because KOH was selected."):c.push("Citric-acid lye adjustment used 0.624 x citric acid because NaOH was selected."),c.push(`${A(p)} lye added extra to accommodate the extra citrus.`)),o.usedSapFallback&&c.push("Average SAP fallback was used for oils missing SAP values."),String(o.lyeSelected||"").toUpperCase()==="KOH90"&&c.push("KOH90 selection assumes 90% lye purity."),(Array.isArray(o.oils)?o.oils:[]).some(se=>{let ee=x(se==null?void 0:se.sapKoh);return ee>0&&ee<=1})&&c.push("SAP values at or below 1.0 were treated as decimal SAP and converted to mg KOH/g."),c}function n(o){var le,se;if(Array.isArray((le=o==null?void 0:o.export)==null?void 0:le.csv_rows)&&o.export.csv_rows.length)return o.export.csv_rows;let c=o.totalOils||0,p=[["section","name","quantity","unit","percent"]];p.push(["Summary","Lye Type",o.lyeType||"","",""]),p.push(["Summary","Superfat",H(o.superfat||0,2),"%",""]),p.push(["Summary","Lye Purity",H(o.purity||0,1),"%",""]),p.push(["Summary","Water Method",o.waterMethod||"","",""]),p.push(["Summary","Water %",H(o.waterPct||0,1),"%",""]),p.push(["Summary","Lye Concentration",H(o.lyeConcentration||0,1),"%",""]),p.push(["Summary","Water Ratio",H(o.waterRatio||0,2),"",""]),p.push(["Summary","Total Oils",H(c,2),"gram",""]),p.push(["Summary","Batch Yield",H(o.batchYield||0,2),"gram",""]),(o.oils||[]).forEach(ee=>{let de=c>0?H(ee.grams/c*100,2):"";p.push(["Oils",ee.name||"Oil",H(ee.grams||0,2),"gram",de])});let Y=x((se=o.additives)==null?void 0:se.citricLyeG),Z=o.lyeAdjustedBase!==null&&o.lyeAdjustedBase!==void 0&&o.lyeAdjustedBase!==""?x(o.lyeAdjustedBase)+Y:x(o.lyeAdjusted);if(Z>0){let ee=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";Y>0&&(ee+="*"),p.push(["Lye",ee,H(Z,2),"gram",""])}return o.water>0&&p.push(["Water","Distilled Water",H(o.water,2),"gram",""]),q(c).forEach(ee=>{p.push(["Fragrance",ee.name,H(ee.grams||0,2),"gram",H(ee.pct||0,2)])}),f(o.additives).forEach(ee=>{p.push(["Additives",ee.name,H(ee.grams||0,2),"gram",H(ee.pct||0,2)])}),a(o).forEach(ee=>{p.push(["Notes",`* ${ee}`,"","",""])}),p}function s(o){if(o==null)return"";let c=String(o);return/[",\n]/.test(c)?`"${c.replace(/"/g,'""')}"`:c}function g(o){return o.map(c=>c.map(s).join(",")).join(`
`)}function r(o,c){let p=new Blob([o],{type:"text/csv;charset=utf-8;"}),Y=URL.createObjectURL(p),V=document.createElement("a");V.href=Y,V.download=c,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(Y)}function I(o){var Ee,_e;if(typeof((Ee=o==null?void 0:o.export)==null?void 0:Ee.sheet_html)=="string"&&o.export.sheet_html.trim())return o.export.sheet_html;let c=o.totalOils||0,p=(o.oils||[]).map(ue=>({name:ue.name||"Oil",grams:ue.grams||0,pct:c>0?ue.grams/c*100:0})),Y=q(c),V=f(o.additives),Z=new Date().toLocaleString(),te=p.length?p.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${N(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',re=Y.length?Y.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${N(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',le=V.length?V.map(ue=>`
          <tr>
            <td>${ue.name}</td>
            <td class="text-end">${A(ue.grams)}</td>
            <td class="text-end">${N(ue.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',se=x((_e=o.additives)==null?void 0:_e.citricLyeG),de=o.lyeAdjustedBase!==null&&o.lyeAdjustedBase!==void 0&&o.lyeAdjustedBase!==""?x(o.lyeAdjustedBase)+se:x(o.lyeAdjusted),ve=`${o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${se>0?"*":""}`,he=`${A(de)}${se>0?"*":""}`,Ie=a(o),be=Ie.map(ue=>`<div class="footnote">* ${ue}</div>`).join(""),Ce=Ie.length?`<div class="footnotes"><h2 class="footnotes-heading">Assumptions</h2>${be}</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnotes { margin-top: 10px; }
      .footnotes-heading { font-size: 14px; margin: 12px 0 4px; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${Z}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${o.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${N(o.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${N(o.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${A(c)}</span></div>
      <div class="summary-item"><span>Water</span><span>${A(o.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${A(o.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${o.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${N(o.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${te}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${ve}</td><td class="text-end">${he}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${A(o.water||0)}</td></tr>
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${re}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${le}</tbody>
    </table>
    ${Ce}
  </body>
</html>`}let l=document.getElementById("oilRows"),y=document.getElementById("addOil"),u=document.getElementById("normalizeOils");y&&l&&(y.dataset.bound="direct",y.addEventListener("click",function(){l.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),u&&(u.dataset.bound="direct",u.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),l&&l.addEventListener("input",function(o){o.target.classList.contains("oil-grams")&&($.lastOilEdit={row:o.target.closest(".oil-row"),field:"grams"}),o.target.classList.contains("oil-percent")&&($.lastOilEdit={row:o.target.closest(".oil-row"),field:"percent"}),(o.target.classList.contains("oil-grams")||o.target.classList.contains("oil-percent")||o.target.classList.contains("oil-typeahead"))&&(o.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(o.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),l&&l.addEventListener("focusin",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(o.target.closest(".oil-row"))}),l&&l.addEventListener("focusout",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),o.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(o.target.closest(".oil-row"),"grams"),o.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(o.target.closest(".oil-row"),"percent")}),l&&l.addEventListener("keydown",function(o){o.key==="Enter"&&(o.target.classList.contains("oil-grams")&&(o.preventDefault(),e.oils.validateOilEntry(o.target.closest(".oil-row"),"grams")),o.target.classList.contains("oil-percent")&&(o.preventDefault(),e.oils.validateOilEntry(o.target.closest(".oil-row"),"percent")))}),l&&l.addEventListener("mouseover",function(o){if(!o.target.classList.contains("oil-typeahead"))return;let c=o.target.closest(".oil-row");!c||c===$.lastPreviewRow||($.lastPreviewRow=c,e.oils.setSelectedOilProfileFromRow(c))}),l&&l.addEventListener("mouseout",function(o){o.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),l&&l.addEventListener("click",function(o){let c=o.target.closest(".oil-profile-open");if(c){let Y=c.closest(".oil-row");if(Y){e.oils.setSelectedOilProfileFromRow(Y);let V=document.getElementById("oilProfileModal");V&&R.bootstrap&&bootstrap.Modal.getOrCreateInstance(V).show()}return}let p=o.target.closest(".remove-oil");if(p){let Y=p.closest(".oil-row");Y&&($.lastRemovedOil=e.oils.serializeOilRow(Y),$.lastRemovedOilIndex=Array.from(Y.parentElement.children).indexOf(Y),e.ui.showUndoToast("Oil removed.")),Y&&$.lastOilEdit&&$.lastOilEdit.row===Y&&($.lastOilEdit=null,e.oils.clearSelectedOilProfile()),Y&&Y.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let L=document.getElementById("fragranceRows"),h=document.getElementById("addFragrance");h&&L&&(h.dataset.bound="direct",h.addEventListener("click",function(){L.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),L&&(L.addEventListener("input",function(o){o.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:o.target.closest(".fragrance-row"),field:"grams"}),o.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:o.target.closest(".fragrance-row"),field:"percent"}),(o.target.classList.contains("fragrance-grams")||o.target.classList.contains("fragrance-percent")||o.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),L.addEventListener("click",function(o){let c=o.target.closest(".remove-fragrance");if(!c)return;let p=c.closest(".fragrance-row");p&&p.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let t=document.getElementById("soapStageTabContent"),S=()=>{if(!t)return null;let o=t.querySelector(".tab-pane.active")||t.querySelector(".tab-pane.show.active");return o?o.querySelector(".soap-stage-body")||o:null},T=()=>{t&&t.addEventListener("wheel",o=>{let c=o.target;if(!(c instanceof HTMLElement))return;let p=c.closest('input[type="number"]');if(!(p instanceof HTMLInputElement))return;let Y=S();if(!(Y instanceof HTMLElement)||Y.scrollHeight<=Y.clientHeight+1)return;document.activeElement===p&&typeof p.blur=="function"&&p.blur();let V=Y.scrollTop<=0,Z=Y.scrollTop+Y.clientHeight>=Y.scrollHeight-1;o.deltaY<0&&V||o.deltaY>0&&Z||(Y.scrollTop+=o.deltaY,o.preventDefault())},{passive:!1})};t&&(t.addEventListener("click",o=>{let c=o.target.closest("[data-stage-action]"),p=o.target.closest("[data-soap-action]");if(!c&&!p)return;if(o.preventDefault(),o.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),p){if(p.dataset.bound==="direct")return;let Z=p.dataset.soapAction;Z==="add-oil"&&l&&(l.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),Z==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),Z==="add-fragrance"&&L&&(L.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let Y=c.dataset.stageAction,V=Number(c.dataset.stageIndex);Number.isNaN(V)||(Y==="prev"&&e.stages.openStageByIndex(Math.max(0,V-1)),Y==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,V+1)),Y==="reset"&&e.stages.resetStage(V+1))}),T());let U=document.getElementById("soapStageTabList"),w=()=>{if(!U)return;U.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("is-expanded"));let o=U.querySelector(".nav-link.active");o&&o.closest(".nav-item")&&o.closest(".nav-item").classList.add("is-expanded")};U&&(U.addEventListener("shown.bs.tab",()=>{w(),e.layout.scheduleStageHeightSync()}),w());let k=document.getElementById("resultsCardToggle"),j=document.getElementById("resultsCard");k&&j&&k.addEventListener("click",()=>{j.classList.toggle("is-collapsed");let o=j.classList.contains("is-collapsed");k.setAttribute("aria-expanded",(!o).toString());let c=o?"Expand formula details":"Collapse formula details";k.setAttribute("aria-label",c),k.setAttribute("title",c);let p=k.querySelector("i");p&&(p.classList.toggle("fa-chevron-down",o),p.classList.toggle("fa-chevron-up",!o))}),document.querySelectorAll('input[name="weight_unit"]').forEach(o=>{o.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let F=()=>{var o;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(o=e.mold)!=null&&o.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},m=document.getElementById("oilTotalTarget");m&&m.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let b=document.getElementById("waterMethod");b&&b.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(o=>{o.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(o=>{let c=document.getElementById(o);c&&["input","change"].forEach(p=>{c.addEventListener(p,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].forEach(o=>{let c=document.getElementById(o);c&&c.addEventListener("input",()=>{e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),[{weightId:"additiveLactateWeight"},{weightId:"additiveSugarWeight"},{weightId:"additiveSaltWeight"},{weightId:"additiveCitricWeight"}].forEach(({weightId:o})=>{let c=document.getElementById(o);c&&c.addEventListener("input",()=>{let p=e.oils.getTotalOilsGrams();p&&(e.additives.updateAdditivesOutput(p),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}),document.querySelectorAll(".additive-typeahead").forEach(o=>{o.addEventListener("input",()=>{e.storage.queueStateSave()})});let _=document.getElementById("qualityPreset");_&&_.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(o=>{o.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let B=document.getElementById("applyQualityTargets");B&&B.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(o=>{o.addEventListener("click",()=>e.quality.applyQualityTargets()),o.addEventListener("keydown",c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),e.quality.applyQualityTargets())})});let P=document.getElementById("moldWaterWeight");P&&P.addEventListener("input",function(){e.mold.syncTargetFromMold(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let W=document.getElementById("moldOilPct");W&&W.addEventListener("input",function(){e.mold.syncTargetFromMold(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldShape");D&&D.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Q=document.getElementById("moldCylinderCorrection");Q&&Q.addEventListener("change",function(){e.mold.syncTargetFromMold(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let K=document.getElementById("moldCylinderFactor");K&&K.addEventListener("input",function(){e.mold.syncTargetFromMold(),F(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(o=>{o.addEventListener("click",function(){let c=this.dataset.stubKind,p=this.dataset.stubName;e.runner.addStubLine(c,p),e.storage.queueStateSave()})});let M=document.getElementById("soapToolPage");M&&(M.addEventListener("click",function(o){o.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),M.addEventListener("input",function(o){o.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(o.target),e.stages.updateStageStatuses(),e.ui.flashStage(o.target.closest(".soap-stage-card")))}),M.addEventListener("change",function(o){o.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(o.target),e.stages.updateStageStatuses())}));let J=document.getElementById("addToolIngredient");J&&J.addEventListener("click",function(){let o=document.getElementById("tool-ingredients");o&&o.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let X=document.getElementById("addToolConsumable");X&&X.addEventListener("click",function(){let o=document.getElementById("tool-consumables");o&&o.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let ne=document.getElementById("addToolContainer");ne&&ne.addEventListener("click",function(){let o=document.getElementById("tool-containers");o&&o.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let ie=document.getElementById("calcLyeBtn");ie&&ie.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let me=document.getElementById("saveSoapTool");me&&me.addEventListener("click",async function(){try{let o=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!o)return;let c=e.runner.buildSoapRecipePayload(o);$.lastRecipePayload=c;try{let p=e.helpers.getStorage();p&&p.setItem("soap_recipe_payload",JSON.stringify(c))}catch{}R.SOAP_RECIPE_DTO=c,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let fe=document.getElementById("exportSoapCsv");fe&&fe.addEventListener("click",async function(){var Y;let o=await i();if(!o)return;let c=n(o),p=typeof((Y=o==null?void 0:o.export)==null?void 0:Y.csv_text)=="string"&&o.export.csv_text?o.export.csv_text:g(c);r(p,"soap_formula.csv")});let ce=document.getElementById("printSoapSheet");ce&&ce.addEventListener("click",async function(){var Y;let o=await i();if(!o)return;let c=I(o),p=R.open("","_blank","width=960,height=720");if(!p){(Y=e.ui)!=null&&Y.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}p.document.open(),p.document.write(c),p.document.close(),p.focus(),p.onload=()=>{p.print()}});let oe=document.getElementById("soapUndoRemove");oe&&oe.addEventListener("click",()=>{$.lastRemovedOil&&(e.storage.restoreOilRow($.lastRemovedOil,$.lastRemovedOilIndex||0),$.lastRemovedOil=null,$.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let o=document.getElementById("soapMobileDrawer"),c=document.getElementById("soapMobileDrawerContent"),p=document.getElementById("soapMobileDrawerTitle"),Y=document.getElementById("soapDrawerEmpty"),V=document.getElementById("soapDrawerClose"),Z=document.getElementById("soapQualityCard"),te=document.getElementById("resultsCard");if(!o||!c||!p||!Z||!te)return;let re=Z.parentElement,le=te.parentElement,se=new Map,ee=null,de=()=>R.matchMedia("(max-width: 767px)").matches,ve=ae=>ae==="quality"?Z:te,he=ae=>ae==="quality"?re:le,Ie=ae=>ae==="quality"?"Display":"Results",be=ae=>{let ge=se.get(ae);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",se.set(ae,ge)),ge.style.height=`${ae.offsetHeight}px`,ae.parentElement&&ae.parentElement!==c&&!ge.parentElement&&ae.parentElement.insertBefore(ge,ae)},Ce=ae=>{ae&&(be(ae),c.appendChild(ae))},Ee=(ae,ge)=>{let qe=se.get(ae);qe&&qe.parentElement?qe.replaceWith(ae):ge&&ae.parentElement!==ge&&ge.appendChild(ae)},_e=()=>{if(!Y)return;let ae=ee==="results",ge=getComputedStyle(te).display!=="none";Y.classList.toggle("d-none",!ae||ge)},ue=ae=>{de()&&(ee&&ee!==ae&&Ee(ve(ee),he(ee)),Ce(ve(ae)),p.textContent=Ie(ae),ee=ae,o.classList.add("is-open"),_e())},Te=()=>{ee&&(Ee(ve(ee),he(ee)),ee=null,o.classList.remove("is-open"),_e())};o.querySelectorAll("[data-drawer-target]").forEach(ae=>{ae.addEventListener("click",()=>{let ge=ae.dataset.drawerTarget;ge&&(o.classList.contains("is-open")&&ee===ge?Te():ue(ge))})}),V&&V.addEventListener("click",Te),R.addEventListener("resize",()=>{!de()&&ee&&Te()}),new MutationObserver(()=>_e()).observe(te,{attributes:!0,attributeFilter:["style","class"]})})(),R.addEventListener("resize",e.layout.scheduleStageHeightSync),R.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",d,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",v,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",G,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",z,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),l&&!l.querySelector(".oil-row")&&l.appendChild(e.oils.buildOilRow()),L&&!L.querySelector(".fragrance-row")&&(pe=e.fragrances)!=null&&pe.buildFragranceRow&&L.appendChild(e.fragrances.buildFragranceRow()),(Se=e.fragrances)!=null&&Se.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
