(function(M){"use strict";let e={inventory:"Inventory",global:"Global Library"},c={inventory:"bg-primary",global:"bg-info text-dark"},p={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function N(r,d){let i;return function(){let h=arguments;clearTimeout(i),i=setTimeout(()=>r.apply(null,h),d)}}function z(r){return(r||"").trim().toLowerCase()}function H(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function k(r){return typeof r=="function"?r():r}function q(r){let d=new Set;return(r||[]).forEach(i=>{let h=i&&(i.global_item_id||i.id);h&&d.add(String(h))}),d}function w(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${c[r]||"bg-secondary"} ms-2">${d}</span>`}function F(r,d,i,h){h=h||{},r.innerHTML="";let E=!1;if(d.forEach(C=>{!C.items||!C.items.length||(E=!0,C.items.forEach(f=>{let _=document.createElement("a");_.href="#",_.className="list-group-item list-group-item-action suggestion-item";let u=h.showSubtitle&&f.subtitle?`<div class="small text-muted mt-1">${f.subtitle}</div>`:"";_.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${f.text||f.display_name||f.name||""}</span>
          ${h.showSourceBadge?w(C.source||f.source):""}
        </div>${u}`,_.addEventListener("click",function(t){t.preventDefault(),i(f,C.source||f.source),r.classList.add("d-none")}),r.appendChild(_)}))}),r.classList.toggle("d-none",!E),!E&&r.dataset.emptyMessage){let C=document.createElement("div");C.className="list-group-item text-muted small",C.textContent=r.dataset.emptyMessage,r.appendChild(C),r.classList.remove("d-none")}}function L(r,d,i){r.innerHTML="";let h=!1;d.forEach(E=>{if(!E.ingredients||!E.ingredients.length)return;h=!0;let C=document.createElement("div");C.className="list-group-item text-muted small fw-semibold",C.textContent=E.title,r.appendChild(C),E.ingredients.forEach(f=>{let _=document.createElement("div");_.className="list-group-item ingredient-result";let u=document.createElement("div");u.className="d-flex justify-content-between align-items-center ingredient-summary",u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.innerHTML=`<span class="fw-semibold">${f.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${f.forms.length} option${f.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",f.forms.forEach(S=>{let P=document.createElement("button");P.type="button",P.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",P.innerHTML=`<div class="fw-semibold">${S.text||S.display_name||S.name||"Form"}</div>`,P.addEventListener("click",function(){i(S,S.source||E.source),r.classList.add("d-none")}),t.appendChild(P)});function m(S){S.type==="keydown"&&S.key!=="Enter"&&S.key!==" "||(S.preventDefault(),t.classList.toggle("d-none"))}u.addEventListener("click",m),u.addEventListener("keydown",m),_.appendChild(u),_.appendChild(t),r.appendChild(_),f.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!h)}function $(r,d,i){r.innerHTML="";let h=!1;if((d||[]).forEach(E=>{h=!0;let C=document.createElement("a");C.href="#",C.className="list-group-item list-group-item-action suggestion-item";let f=E.inci_name?`<div class="small text-muted">${E.inci_name}</div>`:"";C.innerHTML=`<div class="fw-semibold">${E.text||E.name}</div>${f}`,C.addEventListener("click",function(_){_.preventDefault(),i(E,"definition"),r.classList.add("d-none")}),r.appendChild(C)}),r.classList.toggle("d-none",!h),!h&&r.dataset.emptyMessage){let E=document.createElement("div");E.className="list-group-item text-muted small",E.textContent=r.dataset.emptyMessage,r.appendChild(E),r.classList.remove("d-none")}}function o(r){let d=[];return(r||[]).forEach(i=>{if(i&&Array.isArray(i.forms)&&i.forms.length){let h=i.ingredient&&i.ingredient.name||i.ingredient_name||null,E=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null,C=i.category_tags||[];i.forms.forEach(f=>{var t,m,S,P,A,x,G,W,s,I;let _=f.physical_form||{},u=f.display_name||f.text||f.name||(h&&f.physical_form_name?`${h}, ${f.physical_form_name}`:i.display_name||i.text||i.name||"");d.push({id:f.id,text:u,item_type:f.item_type||i.item_type,default_unit:f.default_unit||f.unit||i.default_unit||i.unit||null,source:"global",global_item_id:f.id,ingredient_id:f.ingredient_id||i.ingredient&&i.ingredient.id||i.ingredient_id||null,ingredient_name:f.ingredient_name||h,physical_form_id:f.physical_form_id||_&&_.id||null,physical_form_name:f.physical_form_name||_&&_.name||null,ingredient_category_name:E,category_tags:C,density:f.density||i.density||null,capacity:f.capacity||i.capacity||null,capacity_unit:f.capacity_unit||i.capacity_unit||null,container_material:f.container_material||i.container_material||null,container_type:f.container_type||i.container_type||null,container_style:f.container_style||i.container_style||null,container_color:f.container_color||i.container_color||null,default_is_perishable:(t=f.default_is_perishable)!=null?t:i.default_is_perishable,recommended_shelf_life_days:(m=f.recommended_shelf_life_days)!=null?m:i.recommended_shelf_life_days,saponification_value:(P=(S=f.saponification_value)!=null?S:i.saponification_value)!=null?P:null,iodine_value:(x=(A=f.iodine_value)!=null?A:i.iodine_value)!=null?x:null,fatty_acid_profile:(W=(G=f.fatty_acid_profile)!=null?G:i.fatty_acid_profile)!=null?W:null,melting_point_c:(I=(s=f.melting_point_c)!=null?s:i.melting_point_c)!=null?I:null})})}else if(i){let h=i.display_name||i.text||i.name||"",E=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null;d.push({id:i.id,text:h,source:"global",item_type:i.item_type,global_item_id:i.id,ingredient_name:i.ingredient&&i.ingredient.name||i.ingredient_name||i.name,ingredient_category_name:E,category_tags:i.category_tags||[],physical_form_name:i.physical_form&&i.physical_form.name||i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,density:i.density||null,capacity:i.capacity||null,capacity_unit:i.capacity_unit||null,container_material:i.container_material||null,container_type:i.container_type||null,container_style:i.container_style||null,container_color:i.container_color||null,default_is_perishable:i.default_is_perishable,recommended_shelf_life_days:i.recommended_shelf_life_days,saponification_value:i.saponification_value||null,iodine_value:i.iodine_value||null,fatty_acid_profile:i.fatty_acid_profile||null,melting_point_c:i.melting_point_c||null})}}),d}function O(r){let d=new Map;return(r||[]).forEach(i=>{let h=i.ingredient_name||i.text||i.name||"",E=i.ingredient_id?`id:${i.ingredient_id}`:`name:${z(h)}`,C=d.get(E)||{ingredient_id:i.ingredient_id||null,name:h,forms:[]};C.forms.push({id:i.id,text:i.text||h,ingredient_name:h,physical_form_name:i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,source:"inventory",global_item_id:i.global_item_id||null}),d.set(E,C)}),Array.from(d.values())}function g(r,d){let i=[];return(r||[]).forEach(h=>{let E=(h.forms||[]).map(f=>({id:f.id,text:f.name||f.display_name||f.text,ingredient_name:f.ingredient_name||h.name||h.ingredient&&h.ingredient.name||"Ingredient",physical_form_name:f.physical_form_name||null,default_unit:f.default_unit||f.unit||null,source:"global",global_item_id:f.id,density:f.density||null,capacity:f.capacity||null,capacity_unit:f.capacity_unit||null,container_material:f.container_material||null,container_type:f.container_type||null,container_style:f.container_style||null,container_color:f.container_color||null,saponification_value:f.saponification_value||null,iodine_value:f.iodine_value||null,fatty_acid_profile:f.fatty_acid_profile||null,melting_point_c:f.melting_point_c||null})),C=d?E.filter(f=>!f.global_item_id||!d.has(String(f.global_item_id))):E;C.length&&i.push({ingredient_id:h.ingredient_id||h.id||null,name:h.name||h.ingredient&&h.ingredient.name||E[0]&&E[0].ingredient_name||"Ingredient",forms:C})}),i}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(i=>i.json()).catch(()=>({results:[]}))}function n(r){let d={...p,...r},i=d.inputEl,h=d.invHiddenEl,E=d.giHiddenEl,C=H(d.listEl),f=d.mode||"recipe",_=d.searchType||"ingredient",u=d.includeInventory,t=d.includeGlobal,m=d.ingredientFirst,S=d.displayVariant,P=typeof d.resultFilter=="function"?d.resultFilter:null,A=typeof d.onSelection=="function"?d.onSelection:null,x=d.globalUrlBuilder;if(!i||!h&&f==="recipe"||!E&&d.requireHidden!==!1)return;C&&!C.classList.contains("list-group")&&C.classList.add("list-group"),!C.parentNode&&i.parentNode&&i.parentNode.appendChild(C);function G(y,b){let T=new URLSearchParams({q:y});return b&&b!=="all"&&T.set("type",b),`/inventory/api/search?${T.toString()}`}function W(y,b,T){if(typeof x=="function")return x(y,b,T);let R=new URLSearchParams({q:y});return b&&b!=="all"&&R.set("type",b),b==="ingredient"&&T&&R.set("group","ingredient"),`${f==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${R.toString()}`}let s=N(function(){let y=(i.value||"").trim();if(!y){C.classList.add("d-none"),C.innerHTML="",h&&(h.value=""),E&&(E.value="");return}let b=(k(_)||"ingredient").toLowerCase(),T=k(u),R=k(t),D=b==="ingredient"&&!!k(m),Y=S||(D?"grouped":"compact");if(b==="ingredient_definition"||b==="definition"){a(y).then(U=>{let X=U&&U.results||[];$(C,X.map(Z=>({id:Z.id,text:Z.name,name:Z.name,inci_name:Z.inci_name,slug:Z.slug,ingredient_category_id:Z.ingredient_category_id,ingredient_category_name:Z.ingredient_category_name})),I)}).catch(()=>C.classList.add("d-none"));return}let V=T!==!1?fetch(G(y,b)).then(U=>U.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),K=R!==!1?fetch(W(y,b,D)).then(U=>U.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([V,K]).then(U=>{let X=U[0]&&U[0].results||[],Z=U[1]&&U[1].results||[],ie=P?X.filter(re=>P(re,"inventory")):X,le=P?Z.filter(re=>P(re,"global")):Z,me=q(ie),fe=o(le).filter(re=>!re.global_item_id||!me.has(String(re.global_item_id))).filter(re=>P?P(re,"global"):!0);if(D){let re=O(ie),pe=g(le,me),he=[];re.length&&he.push({title:"Your Inventory",source:"inventory",ingredients:re}),pe.length&&he.push({title:"Global Library",source:"global",ingredients:pe}),L(C,he,I);return}let ce=[];ie.length&&ce.push({title:"Your Inventory",source:"inventory",items:ie}),fe.length&&ce.push({title:"Global Library",source:"global",items:fe}),F(C,ce,I,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:Y==="detailed"})}).catch(()=>{C.classList.add("d-none")})},200);function I(y,b){i.value=y.text||y.display_name||y.name||"",b==="inventory"?(h&&(h.value=y.id_numeric||y.id||""),E&&(E.value=y.global_item_id||"")):(E&&(E.value=y.global_item_id||y.id||""),h&&(h.value="")),typeof A=="function"&&A(y,b)}i.addEventListener("input",function(){h&&(h.value=""),E&&(E.value=""),s()}),document.addEventListener("click",function(y){!C.contains(y.target)&&!i.contains(y.target)&&C.classList.add("d-none")})}M.attachMergedInventoryGlobalTypeahead=n,M.renderInventoryTypeaheadList=F})(window);(function(M){"use strict";function e(c,p){var N=p&&p.context||"public",z=p&&p.unitOptionsHtml||"",H=p&&p.mode||(N==="public"?"public":"recipe"),k=document.createElement("div");k.className="row g-2 align-items-end mb-2",k.innerHTML=['<div class="col-md-6">','  <label class="form-label">',c==="container"?"Container":c==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',z,"  </select>","</div>",'<div class="col-md-3 ',c!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var q=k.querySelector(".tool-typeahead"),w=k.querySelector(".tool-gi-id"),F=k.querySelector('[data-role="suggestions"]');if(typeof M.attachMergedInventoryGlobalTypeahead=="function"){let L=c==="container"?"container":c==="consumable"?"consumable":"ingredient",$=N!=="public";M.attachMergedInventoryGlobalTypeahead({inputEl:q,giHiddenEl:w,listEl:F,mode:H,context:N,ingredientFirst:c==="ingredient",searchType:L,includeInventory:$,includeGlobal:!0})}return k.querySelector(".tool-remove").addEventListener("click",function(){k.remove()}),k}M.buildToolLineRow=e})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{};e.config={unitOptionsHtml:M.soapToolConfig&&M.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(M.SOAP_CALC_LIMIT)?M.SOAP_CALC_LIMIT:null,calcTier:M.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(M.soapToolConfig&&M.soapToolConfig.useCsvPrimary),isAuthenticated:M.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:c,toNumber:p,clamp:N,formatTime:z,getStorage:H,buildSoapcalcSearchBuilder:k};function c(q,w=3){if(!isFinite(q))return 0;let F=Math.pow(10,w);return Math.round(q*F)/F}function p(q){let w=q;typeof w=="string"&&(w=w.replace(/,/g,"").trim());let F=parseFloat(w);return isFinite(F)?F:0}function N(q,w,F){return!isFinite(q)||q<w?w:F!=null&&q>F?F:q}function z(q){return q?`Saved ${new Date(q).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function H(){try{return M.localStorage}catch{return null}}function k(){let q=(F,L,$)=>{let o=new URLSearchParams({q:F});return L&&L!=="all"&&o.set("type",L),L==="ingredient"&&$&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},w=(F,L,$)=>{let o=new URLSearchParams({q:F});return $&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?w:q}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},p={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},N={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},z=[41,70],H=100,k=[136,170],q=250,w={hardness:(c.hardness[0]+c.hardness[1])/2,cleansing:(c.cleansing[0]+c.cleansing[1])/2,conditioning:(c.conditioning[0]+c.conditioning[1])/2,bubbly:(c.bubbly[0]+c.bubbly[1])/2,creamy:(c.creamy[0]+c.creamy[1])/2},F={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},L={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},$=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],O={g:1,oz:28.3495,lb:453.592},g=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),i=new Set(["Salts & Minerals"]),h=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:c,QUALITY_HINTS:p,QUALITY_FEEL_HINTS:N,IODINE_RANGE:z,IODINE_SCALE_MAX:H,INS_RANGE:k,INS_SCALE_MAX:q,QUALITY_BASE:w,QUALITY_PRESETS:F,FATTY_BAR_COLORS:L,FATTY_DISPLAY_KEYS:$,OIL_TIP_RULES:o,UNIT_FACTORS:O,STAGE_CONFIGS:g,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:i,CITRIC_CATEGORY_SET:h}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c}=e.helpers;function p(k){let q=0,w=0;return k.forEach(F=>{F.iodine>0&&(q+=F.grams,w+=F.iodine*F.grams)}),{iodine:q>0?w/q:0,coverageWeight:q}}function N(k){let q={},w=0;k.forEach(L=>{!L.fattyProfile||typeof L.fattyProfile!="object"||(w+=L.grams,Object.entries(L.fattyProfile).forEach(([$,o])=>{let O=c(o);O>0&&(q[$]=(q[$]||0)+L.grams*(O/100))}))});let F={};return w>0&&Object.entries(q).forEach(([L,$])=>{F[L]=$/w*100}),{percent:F,coveredWeight:w}}function z(k){let q=w=>k[w]||0;return{hardness:q("lauric")+q("myristic")+q("palmitic")+q("stearic"),cleansing:q("lauric")+q("myristic"),conditioning:q("oleic")+q("linoleic")+q("linolenic")+q("ricinoleic"),bubbly:q("lauric")+q("myristic")+q("ricinoleic"),creamy:q("palmitic")+q("stearic")+q("ricinoleic")}}function H(k){if(!k||typeof k!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let q={lauric:c(k.lauric),myristic:c(k.myristic),palmitic:c(k.palmitic),stearic:c(k.stearic),ricinoleic:c(k.ricinoleic),oleic:c(k.oleic),linoleic:c(k.linoleic),linolenic:c(k.linolenic)},w=z(q);return{hardness:(w.hardness||0)/100,cleansing:(w.cleansing||0)/100,conditioning:(w.conditioning||0)/100,bubbly:(w.bubbly||0)/100,creamy:(w.creamy||0)/100}}e.calc={computeIodine:p,computeFattyAcids:N,computeQualities:z,computeOilQualityScores:H},M.SoapCalcService=e.calc})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p,clamp:N}=e.helpers,{UNIT_FACTORS:z}=e.constants,H=e.state;function k(o){return N(p(o),0)*(z[H.currentUnit]||1)}function q(o){return N(o,0)/(z[H.currentUnit]||1)}function w(o){return!isFinite(o)||o<=0?"--":`${c(q(o),2)} ${H.currentUnit}`}function F(o){return isFinite(o)?`${c(o,1)}%`:"--"}function L(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=H.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=H.currentUnit})}function $(o,O={}){if(!o)return;if(o===H.currentUnit){L();return}let g=H.currentUnit;if(H.currentUnit=o,L(),O.skipConvert)return;let a=(z[g]||1)/(z[o]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let i=p(d.value);i>0&&(d.value=c(i*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let i=p(d.value);i>0&&(d.value=c(i*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let d=p(n.value);d>0&&(n.value=c(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=p(r.value);d>0&&(r.value=c(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),O.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:k,fromGrams:q,formatWeight:w,formatPercent:F,updateUnitLabels:L,setUnit:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state,p={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function N(g){g&&(g.classList.remove("soap-number-pulse"),g.offsetWidth,g.classList.add("soap-number-pulse"))}function z(g){var n;let a=document.getElementById(g);return!a||!((n=M.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function H(){let g=Date.now();if(g-c.lastSaveToastAt<3500)return;c.lastSaveToastAt=g;let a=z("soapAutosaveToast");a&&a.show()}function k(g){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=g||"Oil removed.");let r=z("soapUndoToast");r&&r.show()}function q(){let g=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");g&&g.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function w(g){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let r=(g==null?void 0:g.lyeConcentration)||0,d="";r>40&&(d="High concentration"),r>0&&r<25&&(d="Low concentration"),a.textContent=d,a.classList.toggle("d-none",!d)}if(n){let r=(g==null?void 0:g.waterRatio)||0,d="";r>0&&r<1.8&&(d="Low water"),r>2.7&&(d="High water"),n.textContent=d,n.classList.toggle("d-none",!d)}}function F(){document.querySelectorAll("#soapToolPage .form-text").forEach(g=>{let a=g.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function L(g){if(!g||g.type!=="number")return;let a=g.value;if(a===""){g.classList.remove("is-invalid");return}let n=parseFloat(a),r=g.getAttribute("min"),d=g.getAttribute("max"),i=r!==null&&r!==""&&n<parseFloat(r),h=d!==null&&d!==""&&n>parseFloat(d);g.classList.toggle("is-invalid",!isFinite(n)||i||h)}function $(g){var n;if(!g)return;let a=((n=g.querySelector)==null?void 0:n.call(g,".soap-stage-card"))||g;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function o(g,a,n={}){var h;let r=document.getElementById("soapAlertStack");if(!r)return;let d=p[g]||p.info,i=document.createElement("div");i.className=`alert alert-${g} d-flex align-items-start gap-2`,i.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((h=i.querySelector('[data-role="dismiss"]'))==null||h.addEventListener("click",()=>i.remove())),r.prepend(i),n.persist||setTimeout(()=>{i.parentNode&&i.remove()},n.timeoutMs||4500)}function O(){let g=document.getElementById("soapAlertStack");g&&g.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:N,getToastInstance:z,showAutosaveToast:H,showUndoToast:k,updateResultsMeta:q,updateResultsWarnings:w,applyHelperVisibility:F,validateNumericField:L,flashStage:$,showSoapAlert:o,clearSoapAlerts:O}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{};function c(){let N=document.getElementById("soapStagePane"),z=document.getElementById("soapQualityCard");if(!N||!z)return;if(!M.matchMedia("(min-width: 768px)").matches){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}let k=z.offsetHeight;if(!k){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}N.style.setProperty("--soap-stage-height",`${k}px`),N.classList.add("is-height-synced")}let p=()=>{M.requestAnimationFrame(c)};e.layout={syncStageHeight:c,scheduleStageHeightSync:p}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{clamp:c,toNumber:p,round:N}=e.helpers,{toGrams:z,fromGrams:H}=e.units;function k(){let o=L(),O=document.getElementById("oilTotalTarget"),g=document.getElementById("oilTargetHint");O&&o.effectiveCapacity>0&&z(O.value)<=0&&(O.value=o.targetOils>0?N(H(o.targetOils),2):""),g&&(o.effectiveCapacity>0?g.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":g.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?n=`Cylinder correction applied (${N(o.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}q()}function q(o=null){var f;let O=document.getElementById("moldWetBatterWarning");if(!O)return;let g=()=>{O.classList.add("d-none"),O.textContent=""},a=L(),n=e.state||{},r=n.lastCalc||null,d=(f=e.oils)!=null&&f.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,i=p(r==null?void 0:r.totalOils),h=p(o);if((!isFinite(h)||h<=0)&&(h=p(r==null?void 0:r.batchYield)),o==null&&i>0&&d>0&&Math.abs(i-d)>.01){g();return}if(!isFinite(h)||h<=0||a.effectiveCapacity<=0){g();return}let E=h-a.effectiveCapacity;if(E<=.01){g();return}let C=n.currentUnit||"g";O.textContent=`Full wet batter is ${N(H(h),2)} ${C}, exceeding mold capacity ${N(H(a.effectiveCapacity),2)} ${C} by ${N(H(E),2)} ${C}. Reduce oils target/% of mold or lower water/additives.`,O.classList.remove("d-none")}function w(){let o=document.getElementById("oilTotalTarget"),O=L();return o&&(O.effectiveCapacity>0&&(o.value=O.targetOils>0?N(H(O.targetOils),2):""),k()),O}function F(){let o=document.getElementById("oilTotalTarget"),O=document.getElementById("moldOilPct");if(!o||!O){let n=L();return k(),n}let g=L();if(g.effectiveCapacity>0){let n=z(o.value),r=c(n,0,g.effectiveCapacity);n>g.effectiveCapacity+.01&&(o.value=N(H(r),2));let d=r>0?r/g.effectiveCapacity*100:0;O.value=r>0?N(d,2):""}let a=L();return k(),a}function L(){var i,h,E;let o=z(document.getElementById("moldWaterWeight").value),O=c(p(document.getElementById("moldOilPct").value),0,100),g=((i=document.getElementById("moldShape"))==null?void 0:i.value)||"loaf",a=!!((h=document.getElementById("moldCylinderCorrection"))!=null&&h.checked),n=c(p((E=document.getElementById("moldCylinderFactor"))==null?void 0:E.value),.5,1),r=o>0?o*(a?n:1):0,d=r>0?r*(O/100):0;return{waterWeight:o,oilPct:O,shape:g,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:d}}function $(){var g;let o=((g=document.getElementById("moldShape"))==null?void 0:g.value)||"loaf",O=document.getElementById("moldCylinderOptions");O&&O.classList.toggle("d-none",o!=="cylinder"),k()}e.mold={updateMoldSuggested:k,updateWetBatterWarning:q,syncTargetFromMold:w,syncMoldPctFromTarget:F,getMoldSettings:L,updateMoldShapeUI:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{toGrams:H,fromGrams:k}=e.units,{OIL_CATEGORY_SET:q,OIL_TIP_RULES:w}=e.constants,{computeQualities:F}=e.calc,L=e.state;function $(s){let I=s.querySelector(".oil-typeahead"),y=s.querySelector(".oil-sap-koh"),b=s.querySelector(".oil-iodine"),T=s.querySelector(".oil-fatty"),R=s.querySelector(".oil-gi-id"),D=s.querySelector(".oil-default-unit"),Y=s.querySelector(".oil-category"),V=s.querySelector('[data-role="suggestions"]');if(!I||!V||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let K=z();M.attachMergedInventoryGlobalTypeahead({inputEl:I,listEl:V,mode:"public",giHiddenEl:R,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:K,searchType:"ingredient",resultFilter:(U,X)=>G(U,q,X),requireHidden:!1,onSelection:function(U){y&&(y.value=(U==null?void 0:U.saponification_value)||""),b&&(b.value=(U==null?void 0:U.iodine_value)||""),T&&(T.value=U!=null&&U.fatty_acid_profile?JSON.stringify(U.fatty_acid_profile):""),D&&(D.value=(U==null?void 0:U.default_unit)||""),Y&&(Y.value=(U==null?void 0:U.ingredient_category_name)||""),t(U),C(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),I.addEventListener("input",function(){this.value.trim()||(y&&(y.value=""),b&&(b.value=""),T&&(T.value=""),R&&(R.value=""),D&&(D.value=""),Y&&(Y.value=""),S())})}function o(){var y,b;let s=document.getElementById("oilRowTemplate"),I=(b=(y=s==null?void 0:s.content)==null?void 0:y.querySelector(".oil-row"))==null?void 0:b.cloneNode(!0);return I?(I.querySelectorAll("input").forEach(T=>{T.value=""}),I.querySelectorAll(".form-text").forEach(T=>{let R=T.closest('.soap-field-stack, [class*="col-"]');R&&R.classList.add("soap-field")}),$(I),I.querySelectorAll(".unit-suffix").forEach(T=>{T.dataset.suffix=L.currentUnit}),I):document.createElement("div")}function O(){let s=document.getElementById("oilTotalTarget"),I=H(s==null?void 0:s.value);if(I>0)return I;let y=e.mold.getMoldSettings();return y.targetOils>0?y.targetOils:0}function g(s){let I=[];return s.forEach(b=>{var D,Y;let T=H((D=b.querySelector(".oil-grams"))==null?void 0:D.value),R=N(p((Y=b.querySelector(".oil-percent"))==null?void 0:Y.value),0);T>0&&R>0&&I.push(T/(R/100))}),I.length?I.reduce((b,T)=>b+T,0)/I.length:0}function a(s,I){if(!s||!I||I<=0)return{allowedGrams:null,allowedPct:null};let y=Array.from(document.querySelectorAll("#oilRows .oil-row")),b=y.reduce((K,U)=>{var X;return U===s?K:K+H((X=U.querySelector(".oil-grams"))==null?void 0:X.value)},0),T=y.reduce((K,U)=>{var X;return U===s?K:K+N(p((X=U.querySelector(".oil-percent"))==null?void 0:X.value),0)},0),R=Math.max(0,100-T),D=Math.max(0,I-b),Y=I*R/100;return{allowedGrams:Math.max(0,Math.min(D,Y)),allowedPct:R}}function n(s,I,y){if(!s)return;let b=s.querySelector(`[data-role="oil-${I}-hint"]`);b&&(y?(b.textContent=y,b.classList.add("is-visible")):(b.textContent="",b.classList.remove("is-visible")))}function r(s){s&&(s.classList.remove("oil-input-bounce"),s.offsetWidth,s.classList.add("oil-input-bounce"))}function d(s,I,y={}){let b=O();if(!s||!b||b<=0){n(s,I,"");return}let T=s.querySelector(".oil-grams"),R=s.querySelector(".oil-percent"),D=a(s,b);if(I==="grams"&&T){let Y=H(T.value),V="";if(Y>b+.01?V="Entry exceeds the max oils allowed in stage 2.":D.allowedGrams!==null&&Y>D.allowedGrams+.01&&(V=`Must be under ${c(k(D.allowedGrams),2)} ${L.currentUnit} to stay within the stage 2 oil limit.`),V){let K=D.allowedGrams!==null?c(k(D.allowedGrams),2):c(k(b),2);T.value=K>0?K:"",n(s,I,V),T.classList.add("oil-input-warning"),r(T),C()}else T.classList.remove("oil-input-warning"),n(s,I,"")}if(I==="percent"&&R){let Y=N(p(R.value),0),V="";if(Y>100.01?V="Entry exceeds the max oils allowed in stage 2.":D.allowedPct!==null&&Y>D.allowedPct+.01&&(V=`Must be under ${c(D.allowedPct,2)}% to stay within the stage 2 oil limit.`),V){let K=D.allowedPct!==null?c(D.allowedPct,2):100;R.value=K>0?K:"",n(s,I,V),R.classList.add("oil-input-warning"),r(R),C()}else R.classList.remove("oil-input-warning"),n(s,I,"")}}function i(s,I={}){let y=Array.from(document.querySelectorAll("#oilRows .oil-row")),b=s!=null?s:O(),T=!!I.force;if(!b||b<=0||!y.length){L.lastOilTarget=b;return}let R=y.reduce((Y,V)=>{var K;return Y+N(p((K=V.querySelector(".oil-percent"))==null?void 0:K.value),0)},0),D=y.reduce((Y,V)=>{var K;return Y+H((K=V.querySelector(".oil-grams"))==null?void 0:K.value)},0);if(R<=0&&D<=0){L.lastOilTarget=b;return}if(!(!T&&L.lastOilTarget&&Math.abs(L.lastOilTarget-b)<.01)){if(R>0)y.forEach(Y=>{let V=Y.querySelector(".oil-percent"),K=Y.querySelector(".oil-grams"),U=N(p(V==null?void 0:V.value),0),X=R>0?U/R:0;K&&(K.value=X>0?c(k(b*X),2):""),V&&(V.value=X>0?c(X*100,2):"")});else if(D>0){let Y=b/D;y.forEach(V=>{let K=V.querySelector(".oil-grams"),U=V.querySelector(".oil-percent"),X=H(K==null?void 0:K.value);if(K){let Z=X>0?X*Y:0;K.value=Z>0?c(k(Z),2):""}if(U){let Z=H(K==null?void 0:K.value);U.value=Z>0?c(Z/b*100,2):""}})}L.lastOilTarget=b,C({skipEnforce:!0})}}function h(s,I){if(!L.lastOilEdit||!L.lastOilEdit.row)return!1;let y=L.lastOilEdit.row,b=s.reduce((Y,V)=>{var K;return V===y?Y:Y+H((K=V.querySelector(".oil-grams"))==null?void 0:K.value)},0),T=Math.max(0,I-b),R=y.querySelector(".oil-grams"),D=y.querySelector(".oil-percent");return!R||!D?!1:(R.value=T>0?c(k(T),2):"",D.value=T>0?c(T/I*100,2):"",L.wasCapped=!0,!0)}function E({totalWeight:s,totalPct:I,target:y,capped:b}){let T=document.getElementById("oilLimitWarning");if(!T)return;let R=[];if(b&&R.push("Oil total hit the mold cap and was adjusted."),y>0&&s>y+.01){let D=s-y;R.push(`Oil weights exceed the target by ${c(k(D),2)} ${L.currentUnit}.`)}I>100.01&&R.push(`Oil percentages are over 100% by ${c(I-100,2)}%.`),R.length?(T.classList.remove("d-none"),T.innerHTML=`${R.join(" ")} Adjust oils or mold % to continue.`):(T.classList.add("d-none"),T.textContent="")}function C(s={}){var Y;s.skipEnforce||(L.wasCapped=!1);let I=Array.from(document.querySelectorAll("#oilRows .oil-row")),y=e.mold.getMoldSettings(),b=O();if(!b&&!y.targetOils){let V=g(I);if(V>0){b=V;let K=document.getElementById("oilTotalTarget");K&&!K.value&&(K.value=c(k(V),2))}}let T=0,R=0;if(I.forEach(V=>{let K=V.querySelector(".oil-grams"),U=V.querySelector(".oil-percent"),X=H(K==null?void 0:K.value),Z=N(p(U==null?void 0:U.value),0);b>0&&(L.lastOilEdit&&L.lastOilEdit.row===V&&L.lastOilEdit.field==="percent"?(X=Z>0?b*(Z/100):0,K.value=Z>0?c(k(X),2):""):X>0?(Z=X/b*100,U.value=c(Z,2)):Z>0&&(X=b*(Z/100),K.value=c(k(X),2)),R+=Z),X>0&&(T+=X)}),b<=0&&(T>0?(R=0,I.forEach(V=>{let K=V.querySelector(".oil-grams"),U=V.querySelector(".oil-percent"),X=H(K==null?void 0:K.value);if(X>0){let Z=X/T*100;U.value=c(Z,2),R+=Z}})):R=I.reduce((V,K)=>{var U;return V+N(p((U=K.querySelector(".oil-percent"))==null?void 0:U.value),0)},0)),!s.skipEnforce&&y.targetOils>0&&T>y.targetOils+.01&&h(I,y.targetOils))return C({skipEnforce:!0});L.totalOilsGrams=T;let D=document.getElementById("oilTotalComputed");return D&&(D.textContent=T>0?`${c(k(T),2)} ${L.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=c(R,2),E({totalWeight:T,totalPct:R,target:b,capped:L.wasCapped}),e.additives.updateAdditivesOutput(T),(Y=e.fragrances)!=null&&Y.updateFragranceTotals&&e.fragrances.updateFragranceTotals(T),e.mold.updateMoldSuggested(),P(),{totalWeight:T,totalPct:R,target:b}}function f(){let s=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!s.length)return;let I=O(),y=s.reduce((b,T)=>{var R;return b+N(p((R=T.querySelector(".oil-percent"))==null?void 0:R.value),0)},0);!y&&I>0&&(y=s.reduce((b,T)=>{var D;let R=H((D=T.querySelector(".oil-grams"))==null?void 0:D.value);return b+(R>0?R/I*100:0)},0)),!(y<=0)&&(s.forEach(b=>{let T=b.querySelector(".oil-percent"),R=b.querySelector(".oil-grams"),Y=N(p(T.value),0)/y*100;T.value=c(Y,2),I>0&&(R.value=Y>0?c(k(I*(Y/100)),2):"")}),C())}function _(){let s=[];return document.querySelectorAll("#oilRows .oil-row").forEach(I=>{var X,Z,ie,le,me,fe,ce,re,pe;let y=(Z=(X=I.querySelector(".oil-typeahead"))==null?void 0:X.value)==null?void 0:Z.trim(),b=H((ie=I.querySelector(".oil-grams"))==null?void 0:ie.value),T=p((le=I.querySelector(".oil-sap-koh"))==null?void 0:le.value),R=p((me=I.querySelector(".oil-iodine"))==null?void 0:me.value),D=((fe=I.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",Y=((ce=I.querySelector(".oil-gi-id"))==null?void 0:ce.value)||"",V=((re=I.querySelector(".oil-default-unit"))==null?void 0:re.value)||"",K=((pe=I.querySelector(".oil-category"))==null?void 0:pe.value)||"",U=null;if(D)try{U=JSON.parse(D)}catch{U=null}b<=0||s.push({name:y||null,grams:b,sapKoh:T,iodine:R,fattyProfile:U,global_item_id:Y?parseInt(Y):null,default_unit:V||null,ingredient_category_name:K||null})}),s}function u({name:s,sapKoh:I,iodine:y,fattyProfile:b}={}){let T=document.getElementById("oilProfileFloat"),R=(Z,ie)=>{let le=document.getElementById(Z);le&&(le.textContent=ie)},D=s||"Pick an oil to preview";R("selectedOilName",D),R("selectedOilModalName",D),T&&T.classList.toggle("d-none",!s);let Y=I>0?c(I,1):"--",V=y>0?c(y,1):"--";R("selectedOilSap",Y),R("selectedOilModalSap",Y),R("selectedOilIodine",V),R("selectedOilModalIodine",V);let K=b?F(b):{},U=(Z,ie)=>{let le=isFinite(ie)&&ie>0?c(ie,1):"--";R(Z,le)};U("selectedOilHardness",K.hardness),U("selectedOilModalHardness",K.hardness),U("selectedOilCleansing",K.cleansing),U("selectedOilModalCleansing",K.cleansing),U("selectedOilConditioning",K.conditioning),U("selectedOilModalConditioning",K.conditioning),U("selectedOilBubbly",K.bubbly),U("selectedOilModalBubbly",K.bubbly),U("selectedOilCreamy",K.creamy),U("selectedOilModalCreamy",K.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(Z=>{let ie=`selectedOil${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,le=`selectedOilModal${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,me=b?p(b[Z]):0,fe=me>0?c(me,1):"--";R(ie,fe),R(le,fe)})}function t(s){if(!s){S();return}L.selectedOilProfile=s;let I=s.fatty_acid_profile||null;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=null}u({name:s.text||s.display_name||s.name,sapKoh:p(s.saponification_value),iodine:p(s.iodine_value),fattyProfile:I})}function m(s){var D,Y,V,K,U;if(!s)return;let I=(Y=(D=s.querySelector(".oil-typeahead"))==null?void 0:D.value)==null?void 0:Y.trim(),y=p((V=s.querySelector(".oil-sap-koh"))==null?void 0:V.value),b=p((K=s.querySelector(".oil-iodine"))==null?void 0:K.value),T=((U=s.querySelector(".oil-fatty"))==null?void 0:U.value)||"",R=null;if(T)try{R=JSON.parse(T)}catch{R=null}u({name:I,sapKoh:y,iodine:b,fattyProfile:R})}function S(){L.selectedOilProfile=null,L.lastPreviewRow=null,u()}function P(){let s=document.getElementById("oilBlendTips");if(!s)return;let I=_().filter(T=>T.grams>0||T.percent>0);if(!I.length){s.classList.add("d-none"),s.textContent="";return}let y=new Set;I.forEach(T=>{let R=(T.name||"").toLowerCase();if(R&&w.forEach(D=>{D.match.test(R)&&y.add(D.tip)}),T.fattyProfile&&typeof T.fattyProfile=="object"){let D=p(T.fattyProfile.lauric),Y=p(T.fattyProfile.myristic),V=p(T.fattyProfile.palmitic),K=p(T.fattyProfile.stearic),U=p(T.fattyProfile.ricinoleic),X=p(T.fattyProfile.oleic),Z=p(T.fattyProfile.linoleic),ie=p(T.fattyProfile.linolenic);D+Y>=30&&y.add(`${T.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),V+K>=40&&y.add(`${T.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),X>=60&&y.add(`${T.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),Z+ie>=20&&y.add(`${T.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),U>=60&&y.add(`${T.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let b=Array.from(y).slice(0,6);if(!b.length){s.classList.add("d-none"),s.textContent="";return}s.classList.remove("d-none"),s.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${b.map(T=>`<li>${T}</li>`).join("")}</ul>`}function A(){return L.totalOilsGrams||0}function x(s){var I,y,b,T,R,D,Y,V,K;return s?{name:((I=s.querySelector(".oil-typeahead"))==null?void 0:I.value)||"",grams:((y=s.querySelector(".oil-grams"))==null?void 0:y.value)||"",percent:((b=s.querySelector(".oil-percent"))==null?void 0:b.value)||"",sap:((T=s.querySelector(".oil-sap-koh"))==null?void 0:T.value)||"",iodine:((R=s.querySelector(".oil-iodine"))==null?void 0:R.value)||"",fattyRaw:((D=s.querySelector(".oil-fatty"))==null?void 0:D.value)||"",gi:((Y=s.querySelector(".oil-gi-id"))==null?void 0:Y.value)||"",defaultUnit:((V=s.querySelector(".oil-default-unit"))==null?void 0:V.value)||"",categoryName:((K=s.querySelector(".oil-category"))==null?void 0:K.value)||""}:null}function G(s,I,y){let b=W(s);return b?I.has(b):y==="inventory"}function W(s){return!s||typeof s!="object"?null:s.ingredient&&s.ingredient.ingredient_category_name||s.ingredient_category_name||s.ingredient_category&&s.ingredient_category.name||null}e.oils={attachOilTypeahead:$,buildOilRow:o,getOilTargetGrams:O,updateOilTotals:C,normalizeOils:f,collectOilData:_,setSelectedOilProfileFromRow:m,clearSelectedOilProfile:S,updateOilTips:P,getTotalOilsGrams:A,serializeOilRow:x,validateOilEntry:d,scaleOilsToTarget:i}})(window);(function(M){"use strict";var u;let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},{toNumber:p,clamp:N}=e.helpers,z=e.state,H=Array.isArray((u=e.constants)==null?void 0:u.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],k=new Set(["selected_pct","selected_weight_g"]),q=25,w=140,F=260,L={mode:"basics",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function $(){var t,m;(m=(t=e.storage)==null?void 0:t.queueStateSave)==null||m.call(t)}function o(t,m){var S,P;(P=(S=e.ui)==null?void 0:S.showSoapAlert)==null||P.call(S,t,m,{dismissible:!0,timeoutMs:6e3})}function O(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),modeToggle:document.getElementById("bulkOilDisplayAllToggle"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function g(t){return t?t==="name"||k.has(t)?!0:H.includes(t):!1}function a(){(!z.bulkOilModal||typeof z.bulkOilModal!="object")&&(z.bulkOilModal=JSON.parse(JSON.stringify(L)));let t=z.bulkOilModal;return t.mode=t.mode==="all"?"all":"basics",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=g(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let m={},S=t&&typeof t=="object"?t:{};return H.forEach(P=>{let A=p(S[P]);A>0&&(m[P]=A)}),m}function r(t){let m=n(t==null?void 0:t.fatty_profile),S=String((t==null?void 0:t.name)||"").trim(),P=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",A=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:p(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(A?`global:${A}`:`${P}:${S.toLowerCase()}`)),name:S,sap_koh:p(t==null?void 0:t.sap_koh),iodine:p(t==null?void 0:t.iodine),fatty_profile:m,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:A,source:P,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=O(),m=a(),S=Object.keys(m.selection||{}).length,P=`Selected: ${S}`;t.summaryEl&&(t.summaryEl.textContent=P),t.stageCountEl&&(t.stageCountEl.textContent=String(S))}function i(t){var S;return((S=a().selection)==null?void 0:S[t])||null}function h(t,m={}){var x,G;let S=a();if(!t||!t.key)return null;let P=S.selection[t.key]||{},A={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:N(p((x=m.selected_pct)!=null?x:P.selected_pct),0,100),selected_weight_g:N(p((G=m.selected_weight_g)!=null?G:P.selected_weight_g),0)};return S.selection[t.key]=A,A}function E(t){var S;let m=a();(S=m.selection)!=null&&S[t]&&delete m.selection[t]}function C(t){var S;return((S=a().recordByKey)==null?void 0:S[t])||null}function f(){let t=a();return{mode:t.mode,view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(m=>({key:m.key,name:m.name,sap_koh:m.sap_koh,iodine:m.iodine,fatty_profile:m.fatty_profile||{},default_unit:m.default_unit,ingredient_category_name:m.ingredient_category_name,global_item_id:m.global_item_id,source:m.source,is_basic:!!m.is_basic,selected_pct:N(p(m.selected_pct),0,100),selected_weight_g:N(p(m.selected_weight_g),0)}))}}function _(t){let m=a();m.mode=(t==null?void 0:t.mode)==="all"?"all":"basics",m.viewSelected=!!(t!=null&&t.view_selected),m.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",m.sortKey=g(t==null?void 0:t.sort_key)?t.sort_key:"name",m.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let S={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(A=>{let x=String((A==null?void 0:A.key)||"").trim(),G=String((A==null?void 0:A.name)||"").trim();!x||!G||(S[x]={key:x,name:G,sap_koh:p(A==null?void 0:A.sap_koh),iodine:p(A==null?void 0:A.iodine),fatty_profile:n(A==null?void 0:A.fatty_profile),default_unit:String((A==null?void 0:A.default_unit)||"gram"),ingredient_category_name:String((A==null?void 0:A.ingredient_category_name)||""),global_item_id:p(A==null?void 0:A.global_item_id)>0?parseInt(A.global_item_id,10):null,source:String((A==null?void 0:A.source)||"soapcalc"),is_basic:!!(A!=null&&A.is_basic),selected_pct:N(p(A==null?void 0:A.selected_pct),0,100),selected_weight_g:N(p(A==null?void 0:A.selected_weight_g),0)})}),m.selection=S,m.visibleRecords=[],m.offset=0,m.totalCount=0,m.hasMore=!0,m.loading=!1,d()}c.shared={FATTY_KEYS:H,LOCAL_SORT_KEYS:k,PAGE_SIZE:q,SCROLL_FETCH_THRESHOLD:w,SEARCH_DEBOUNCE_MS:F,queueStateSave:$,showAlert:o,getRefs:O,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:i,setSelection:h,removeSelection:E,getRecordByKey:C,serializeSelection:f,restoreState:_}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared;if(!p)return;let{round:N,toNumber:z}=e.helpers,{fromGrams:H}=e.units,{FATTY_KEYS:k,LOCAL_SORT_KEYS:q,getRefs:w,ensureModalState:F,selectionForRecordKey:L,updateSelectionCounters:$}=p;function o(u){let t=w();t.statusEl&&(t.statusEl.textContent=u)}function O(){let u=F(),t=u.mode==="all"?"all oils":"SoapCalc basics";if(u.loading&&!u.visibleRecords.length){o("Loading oils...");return}if(!u.visibleRecords.length){let x=u.query?"No oils match that search.":"No oils available.";o(x);return}let m=u.visibleRecords.length,S=u.totalCount,P=u.hasMore?" \u2022 scroll for more":"",A=u.query?` \u2022 search: "${u.query}"`:"";o(`Loaded ${m}/${S} in ${t}${A}${P}`)}function g(u,t,m){if(typeof u=="string"||typeof t=="string"){let A=String(u||"").toLowerCase(),x=String(t||"").toLowerCase();return A<x?m==="asc"?-1:1:A>x?m==="asc"?1:-1:0}let S=z(u),P=z(t);return S<P?m==="asc"?-1:1:S>P?m==="asc"?1:-1:0}function a(u,t){var m,S;return t==="selected_pct"?((m=L(u.key))==null?void 0:m.selected_pct)||0:t==="selected_weight_g"?((S=L(u.key))==null?void 0:S.selected_weight_g)||0:""}function n(){let u=F();q.has(u.sortKey)&&u.visibleRecords.sort((t,m)=>{let S=g(a(t,u.sortKey),a(m,u.sortKey),u.sortDir);return S!==0?S:g(t.name||"",m.name||"","asc")})}function r(){let u=F();if(!u.viewSelected)return;let t=[],m=[];u.visibleRecords.forEach(S=>{L(S.key)?t.push(S):m.push(S)}),u.visibleRecords=t.concat(m)}function d(){n(),r()}function i(u){let t=String(u||"").trim().toLowerCase();return t==="name"||k.includes(t)?t:"name"}function h(){let u=F();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let m=t.dataset.label||"",S=t.dataset.sortKey||"";u.sortKey===S?t.textContent=`${m} ${u.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=m})}function E(u,t){let m=L(t.key),S=u.querySelector(".bulk-oil-check"),P=u.querySelector(".bulk-oil-pct"),A=u.querySelector(".bulk-oil-weight");S&&(S.checked=!!m),P&&(P.value=m&&m.selected_pct>0?N(m.selected_pct,2):""),A&&(A.value=m&&m.selected_weight_g>0?N(H(m.selected_weight_g),2):"")}function C(u){let t=document.createElement("td");t.className="bulk-oil-acid";let m=z(u);return t.textContent=m>0?N(m,1).toString():"--",t}function f(u){let t=document.createElement("tr");t.dataset.recordKey=u.key;let m=document.createElement("td");m.className="text-center";let S=document.createElement("input");S.type="checkbox",S.className="form-check-input bulk-oil-check",m.appendChild(S),t.appendChild(m);let P=document.createElement("td");P.className="bulk-oil-name";let A=document.createElement("div");A.className="fw-semibold small",A.textContent=u.name;let x=document.createElement("div");x.className="text-muted small";let G=u.ingredient_category_name?` \xB7 ${u.ingredient_category_name}`:"";x.textContent=`${u.source}${G}`,P.appendChild(A),P.appendChild(x),t.appendChild(P),k.forEach(b=>{var T;t.appendChild(C((T=u.fatty_profile)==null?void 0:T[b]))});let W=document.createElement("td"),s=document.createElement("input");s.type="number",s.min="0",s.max="100",s.step="0.1",s.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",W.appendChild(s),t.appendChild(W);let I=document.createElement("td"),y=document.createElement("input");return y.type="number",y.min="0",y.step="0.1",y.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",I.appendChild(y),t.appendChild(I),E(t,u),t}function _(){let u=w(),t=F();if(!u.bodyEl)return;u.bodyEl.innerHTML="";let m=document.createDocumentFragment();t.visibleRecords.forEach(S=>{m.appendChild(f(S))}),u.bodyEl.appendChild(m),h(),$(),O()}c.render={updateStatusText:o,refreshCatalogStatus:O,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:i,sortButtonsLabel:h,renderVisibleRecords:_}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared,N=c.render;if(!p||!N)return;let{PAGE_SIZE:z,getRefs:H,ensureModalState:k,normalizeCatalogRecord:q}=p,{refreshCatalogStatus:w,normalizeServerSortKey:F,applyClientOrdering:L,renderVisibleRecords:$,updateStatusText:o}=N;function O(){let a=k(),n=H();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function g({reset:a=!1}={}){let n=k();if(!H().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&O();let d=n.requestToken+1;n.requestToken=d,n.loading=!0,w();let i=new URLSearchParams;i.set("mode",n.mode),i.set("offset",String(n.offset)),i.set("limit",String(z)),i.set("q",n.query||""),i.set("sort_key",F(n.sortKey)),i.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let h=await fetch(`/tools/api/soap/oils-catalog?${i.toString()}`);if(!h.ok)throw new Error("Unable to load oils catalog");let E=await h.json();if(!E||E.success!==!0||!E.result||!Array.isArray(E.result.records))throw new Error("Invalid oils catalog response");if(d!==n.requestToken)return;let C=E.result.records.map(q),f=Math.max(0,parseInt(E.result.next_offset,10)||n.offset+C.length),_=Math.max(C.length,parseInt(E.result.count,10)||0),u=!!E.result.has_more;C.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?C.slice():n.visibleRecords.concat(C),n.offset=f,n.totalCount=_,n.hasMore=u,L(),$()}catch(h){throw d===n.requestToken&&o("Unable to load oils catalog."),h}finally{d===n.requestToken&&(n.loading=!1,w())}}c.api={fetchCatalogPage:g}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared,N=c.render,z=c.api;if(!p||!N||!z)return;let{round:H,toNumber:k,clamp:q}=e.helpers,{toGrams:w,fromGrams:F}=e.units,L=e.state,{LOCAL_SORT_KEYS:$,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:O,queueStateSave:g,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:d,setSelection:i,removeSelection:h,getRecordByKey:E,serializeSelection:C,restoreState:f}=p,{applyClientOrdering:_,sortButtonsLabel:u,renderVisibleRecords:t}=N,{fetchCatalogPage:m}=z,S=null,P=null;function A(){var B;let v=n();v.modalEl&&(!S&&((B=M.bootstrap)!=null&&B.Modal)&&(S=M.bootstrap.Modal.getOrCreateInstance(v.modalEl)),S&&S.hide())}function x(){return document.getElementById("oilRows")}function G(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function W(v){return String(v||"").trim().toLowerCase()}function s(v){var B;return W((B=v==null?void 0:v.querySelector(".oil-typeahead"))==null?void 0:B.value)}function I(v){var J;let B=String(((J=v==null?void 0:v.querySelector(".oil-gi-id"))==null?void 0:J.value)||"").trim();return B||""}function y(v,B){let J=String(v||"").trim();if(!J)return null;let ee=G(),te=ee.find(ne=>String(ne.dataset.bulkOilKey||"")===J);if(te)return te;let ae=String((B==null?void 0:B.global_item_id)||"").trim();if(ae&&(te=ee.find(ne=>I(ne)===ae),te))return te;let ue=W(B==null?void 0:B.name);return ue&&(te=ee.find(ne=>s(ne)===ue),te)?te:null}function b(v,B){if(!v||!B)return;v.dataset.bulkOilKey=B.key||"";let J=v.querySelector(".oil-typeahead"),ee=v.querySelector(".oil-sap-koh"),te=v.querySelector(".oil-iodine"),ae=v.querySelector(".oil-fatty"),ue=v.querySelector(".oil-gi-id"),ne=v.querySelector(".oil-default-unit"),de=v.querySelector(".oil-category"),ye=v.querySelector(".oil-grams"),se=v.querySelector(".oil-percent");J&&(J.value=B.name||""),ee&&(ee.value=B.sap_koh>0?H(B.sap_koh,3):""),te&&(te.value=B.iodine>0?H(B.iodine,3):""),ae&&(ae.value=B.fatty_profile&&Object.keys(B.fatty_profile).length?JSON.stringify(B.fatty_profile):""),ue&&(ue.value=B.global_item_id||""),ne&&(ne.value=B.default_unit||""),de&&(de.value=B.ingredient_category_name||""),se&&(se.value=B.selected_pct>0?H(B.selected_pct,2):""),ye&&(ye.value=B.selected_weight_g>0?H(F(B.selected_weight_g),2):"")}function T(v){if(!v||!v.key)return null;let B=y(v.key,v),J=x();return!B&&J&&(B=e.oils.buildOilRow(),B&&J.appendChild(B)),b(B,v),B}function R(v,B){let J=y(v,B);J&&(L.lastOilEdit&&L.lastOilEdit.row===J&&(L.lastOilEdit=null,e.oils.clearSelectedOilProfile()),J.remove())}function D(){G().forEach(B=>{L.lastOilEdit&&L.lastOilEdit.row===B&&(L.lastOilEdit=null),B.remove()}),e.oils.clearSelectedOilProfile()}function Y(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function V(v,B,J){let ee=String(J||"").trim();if(ee)return ee;let te=String(B||"").trim();if(te)return`global:${te}`;let ae=W(v);return ae?`soapcalc:${ae}`:""}function K(){let v={};return G().forEach(B=>{var be,_e,Ce,Ee,qe,oe,ge,Ie,Le;let J=String(((be=B.querySelector(".oil-typeahead"))==null?void 0:be.value)||"").trim(),ee=k((_e=B.querySelector(".oil-sap-koh"))==null?void 0:_e.value),te=k((Ce=B.querySelector(".oil-iodine"))==null?void 0:Ce.value),ae=String(((Ee=B.querySelector(".oil-gi-id"))==null?void 0:Ee.value)||"").trim(),ue=String(((qe=B.querySelector(".oil-default-unit"))==null?void 0:qe.value)||"gram"),ne=String(((oe=B.querySelector(".oil-category"))==null?void 0:oe.value)||""),de=q(k((ge=B.querySelector(".oil-percent"))==null?void 0:ge.value),0,100),ye=q(w((Ie=B.querySelector(".oil-grams"))==null?void 0:Ie.value),0),se=String(((Le=B.querySelector(".oil-fatty"))==null?void 0:Le.value)||""),Se={};if(se)try{let Oe=JSON.parse(se);Se=p.normalizeFattyProfile(Oe)}catch{Se={}}let ve=V(J,ae,B.dataset.bulkOilKey);!ve||!(J||de>0||ye>0||ee>0||te>0||Object.keys(Se).length>0)||(B.dataset.bulkOilKey=ve,v[ve]={key:ve,name:J||"Unnamed oil",sap_koh:ee,iodine:te,fatty_profile:Se,default_unit:ue||"gram",ingredient_category_name:ne,global_item_id:ae?parseInt(ae,10):null,source:ae?"global":"soapcalc",is_basic:!ae,selected_pct:de,selected_weight_g:ye})}),v}function U(){let v=r();v.selection=K(),d()}function X(){let v=r(),B=Object.values(v.selection||{}),J=new Set(B.map(ee=>ee.key));G().forEach(ee=>{let te=String(ee.dataset.bulkOilKey||"").trim();(!te||!J.has(te))&&ee.remove()}),B.slice().sort((ee,te)=>String(ee.name||"").localeCompare(String(te.name||""))).forEach(ee=>{T(ee)}),Y()}async function Z(){var J;let v=n(),B=r();if(v.modalEl){U(),!S&&((J=M.bootstrap)!=null&&J.Modal)&&(S=M.bootstrap.Modal.getOrCreateInstance(v.modalEl)),v.searchInput&&(v.searchInput.value=B.query||""),v.modeToggle&&(v.modeToggle.checked=B.mode==="all"),v.viewSelectedToggle&&(v.viewSelectedToggle.checked=!!B.viewSelected),v.unitLabelEl&&(v.unitLabelEl.textContent=L.currentUnit||"g"),S&&S.show(),u(),d();try{await m({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ie(v){let B=v.target;if(!(B instanceof HTMLElement))return;let J=B.closest("tr[data-record-key]");if(!J)return;let ee=J.dataset.recordKey||"",te=E(ee);if(!te)return;let ae=J.querySelector(".bulk-oil-check"),ue=J.querySelector(".bulk-oil-pct"),ne=J.querySelector(".bulk-oil-weight"),de=q(k(ue==null?void 0:ue.value),0,100),ye=q(w(ne==null?void 0:ne.value),0),se=de>0||ye>0;if(!!(ae!=null&&ae.checked)||se){ae&&(ae.checked=!0);let be=i(te,{selected_pct:de,selected_weight_g:ye});T(be)}else h(ee),R(ee,te);let ve=r();$.has(ve.sortKey)||ve.viewSelected?(_(),t()):d(),Y(),g()}async function le(v){let B=r();B.mode=v?"all":"basics",g();try{await m({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}function me(v){let B=r();B.viewSelected=!!v,_(),t(),g()}async function fe(v){let B=v.target instanceof HTMLElement?v.target.closest(".bulk-oil-sort"):null;if(!B)return;let J=B.getAttribute("data-sort-key")||"name",ee=r();if(ee.sortKey===J?ee.sortDir=ee.sortDir==="asc"?"desc":"asc":(ee.sortKey=J,ee.sortDir=J==="name"?"asc":"desc"),g(),$.has(ee.sortKey)){_(),t();return}try{await m({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function ce(){let v=r();v.selection={},D(),($.has(v.sortKey)||v.viewSelected)&&_(),t(),Y(),g()}async function re(){let v=n(),B=r();if(!(!v.scrollEl||B.loading||!B.hasMore||!(v.scrollEl.scrollTop+v.scrollEl.clientHeight>=v.scrollEl.scrollHeight-o)))try{await m({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function pe(){P&&M.clearTimeout(P),P=M.setTimeout(async()=>{try{await m({reset:!0})}catch{a("danger","Unable to search oils right now.")}},O)}function he(){X(),g(),A()}function l(v,B){if(!(v instanceof HTMLInputElement))return!1;let ee=n().bodyEl;if(!(ee instanceof HTMLElement))return!1;let te=v.classList.contains("bulk-oil-pct")?"bulk-oil-pct":v.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!te)return!1;let ae=Array.from(ee.querySelectorAll(`input.${te}`)),ue=ae.indexOf(v);if(ue<0)return!1;let ne=ue+B;if(ne<0||ne>=ae.length)return!1;let de=ae[ne];return de instanceof HTMLInputElement?(de.focus(),typeof de.select=="function"&&de.select(),!0):!1}function j(){var B;let v=n();v.unitLabelEl&&(v.unitLabelEl.textContent=L.currentUnit||"g"),(B=v.modalEl)!=null&&B.classList.contains("show")&&t()}function Q(){let v=n();v.modalEl&&(v.openBtn&&v.openBtn.addEventListener("click",()=>{Z()}),v.searchInput&&v.searchInput.addEventListener("input",()=>{let B=r();B.query=v.searchInput.value||"",g(),pe()}),v.modeToggle&&v.modeToggle.addEventListener("change",async()=>{await le(!!v.modeToggle.checked)}),v.viewSelectedToggle&&v.viewSelectedToggle.addEventListener("change",()=>{me(!!v.viewSelectedToggle.checked)}),v.scrollEl&&v.scrollEl.addEventListener("scroll",re),v.bodyEl&&(v.bodyEl.addEventListener("change",ie),v.bodyEl.addEventListener("keydown",B=>{let J=B.target;if(!(!(J instanceof HTMLInputElement)||!(J.classList.contains("bulk-oil-pct")||J.classList.contains("bulk-oil-weight")))){if(B.key==="Enter"){B.preventDefault(),J.blur();return}B.key==="Tab"&&l(J,B.shiftKey?-1:1)&&B.preventDefault()}})),v.modalEl.querySelectorAll(".bulk-oil-sort").forEach(B=>{B.addEventListener("click",fe)}),v.importBtn&&v.importBtn.addEventListener("click",()=>{he()}),v.clearBtn&&v.clearBtn.addEventListener("click",()=>{ce()}),v.modalEl.addEventListener("shown.bs.modal",()=>{let B=n();B.searchInput&&B.searchInput.focus()}))}Q(),d(),u(),e.bulkOilsModal={openModal:Z,serializeSelection:C,restoreState:f,onUnitChanged:j}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c,round:p,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{formatWeight:H,toGrams:k,fromGrams:q}=e.units,{FRAGRANCE_CATEGORY_SET:w}=e.constants,F=e.state;function L(_,u,t,m,S){var I;let P=document.getElementById(_),A=document.getElementById(u),x=m?document.getElementById(m):null,G=S?document.getElementById(S):null,W=(I=P==null?void 0:P.parentElement)==null?void 0:I.querySelector('[data-role="suggestions"]');if(!P||!W||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let s=z();M.attachMergedInventoryGlobalTypeahead({inputEl:P,listEl:W,mode:"public",giHiddenEl:A,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:s,searchType:"ingredient",resultFilter:(y,b)=>{let T=f(y);return T?t.has(T):b==="inventory"},requireHidden:!1,onSelection:function(y){x&&(x.value=(y==null?void 0:y.default_unit)||""),G&&(G.value=(y==null?void 0:y.ingredient_category_name)||""),e.storage.queueStateSave()}}),P.addEventListener("input",function(){this.value.trim()||(x&&(x.value=""),G&&(G.value=""))})}function $({pctId:_,weightId:u}){var A,x,G;let t=document.getElementById(_),m=t==null?void 0:t.value;if(m!==""&&m!==null&&m!==void 0)return c(m);let S=N(((x=(A=e.oils)==null?void 0:A.getTotalOilsGrams)==null?void 0:x.call(A))||0,0);if(S<=0)return 0;let P=k((G=document.getElementById(u))==null?void 0:G.value);return P<=0?0:P/S*100}function o(){var _,u,t,m,S,P,A,x;return{lactatePct:$({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:$({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:$({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:$({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((u=(_=document.getElementById("additiveLactateName"))==null?void 0:_.value)==null?void 0:u.trim())||"Sodium Lactate",sugarName:((m=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:m.trim())||"Sugar",saltName:((P=(S=document.getElementById("additiveSaltName"))==null?void 0:S.value)==null?void 0:P.trim())||"Salt",citricName:((x=(A=document.getElementById("additiveCitricName"))==null?void 0:A.value)==null?void 0:x.trim())||"Citric Acid"}}function O(){var u;return(((u=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:u.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function g(_){let u=N(c(_),0),t=N($({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),m=N($({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),S=N($({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),P=N($({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),A=u*(t/100),x=u*(m/100),G=u*(S/100),W=u*(P/100),s=O()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:m,saltPct:S,citricPct:P,lactateG:A,sugarG:x,saltG:G,citricG:W,citricLyeG:W*s}}function a({pctId:_,weightId:u,sourceField:t,totalOils:m}){let S=document.getElementById(_),P=document.getElementById(u);if(!S||!P)return;let A=N(c(m),0);if(A<=0)return;if(t==="weight"){let s=P.value;if(s===""||s===null||s===void 0){S.value="";return}let I=N(k(s),0),y=I>0?I/A*100:0;S.value=y>0?p(y,2):"";return}let x=S.value;if(x===""||x===null||x===void 0){P.value="";return}let G=N(c(x),0),W=A*(G/100);P.value=W>0?p(q(W),2):""}function n(_){let u=(m,S)=>{let P=document.getElementById(m);if(P)if(P.tagName==="INPUT"){if(document.activeElement===P)return;P.value=S}else P.textContent=S},t=m=>m>0?p(q(m),2):"";u("additiveLactateWeight",t(c(_==null?void 0:_.lactateG))),u("additiveSugarWeight",t(c(_==null?void 0:_.sugarG))),u("additiveSaltWeight",t(c(_==null?void 0:_.saltG))),u("additiveCitricWeight",t(c(_==null?void 0:_.citricG))),u("additiveCitricLyeOut",H(c(_==null?void 0:_.citricLyeG)))}function r(_){let u=N(c(_),0),t=g(u);return n(t),t}function d(_){let u=_.querySelector(".fragrance-typeahead"),t=_.querySelector(".fragrance-gi-id"),m=_.querySelector(".fragrance-default-unit"),S=_.querySelector(".fragrance-category"),P=_.querySelector('[data-role="suggestions"]');if(!u||!P||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let A=z();M.attachMergedInventoryGlobalTypeahead({inputEl:u,listEl:P,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:A,searchType:"ingredient",resultFilter:(x,G)=>{let W=f(x);return W?w.has(W):G==="inventory"},requireHidden:!1,onSelection:function(x){m&&(m.value=(x==null?void 0:x.default_unit)||""),S&&(S.value=(x==null?void 0:x.ingredient_category_name)||""),e.storage.queueStateSave()}}),u.addEventListener("input",function(){this.value.trim()||(m&&(m.value=""),S&&(S.value=""))})}function i(){var t,m;let _=document.getElementById("fragranceRowTemplate"),u=(m=(t=_==null?void 0:_.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:m.cloneNode(!0);return u?(u.querySelectorAll("input").forEach(S=>{S.value=""}),d(u),u.querySelectorAll(".unit-suffix").forEach(S=>{S.dataset.suffix=F.currentUnit}),u):document.createElement("div")}function h(_){let u=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=N(_||e.oils.getTotalOilsGrams()||0,0),m=0,S=0;u.forEach(x=>{let G=x.querySelector(".fragrance-grams"),W=x.querySelector(".fragrance-percent");if(!G||!W)return;let s=G.value,I=W.value,y=k(s),b=N(c(I),0),T=e.state.lastFragranceEdit,R=T&&T.row===x?T.field:null;t>0&&(R==="percent"?(y=t*(b/100),G.value=y>0?p(q(y),2):""):R==="grams"?(b=y/t*100,W.value=b>0?p(b,2):""):y>0?(b=y/t*100,document.activeElement!==W&&(W.value=p(b,2))):b>0&&(y=t*(b/100),document.activeElement!==G&&(G.value=p(q(y),2)))),y>0&&(m+=y),S+=b});let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent=p(S,2));let A=document.getElementById("fragranceTotalComputed");return A&&(A.textContent=m>0?H(m):"--"),{totalGrams:m,totalPct:S}}function E(){let _=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(u=>{var G,W,s,I,y,b,T;let t=((W=(G=u.querySelector(".fragrance-typeahead"))==null?void 0:G.value)==null?void 0:W.trim())||"",m=((s=u.querySelector(".fragrance-grams"))==null?void 0:s.value)||"",S=((I=u.querySelector(".fragrance-percent"))==null?void 0:I.value)||"",P=((y=u.querySelector(".fragrance-gi-id"))==null?void 0:y.value)||"",A=((b=u.querySelector(".fragrance-default-unit"))==null?void 0:b.value)||"",x=((T=u.querySelector(".fragrance-category"))==null?void 0:T.value)||"";!t&&!m&&!S&&!P||_.push({name:t,grams:m,percent:S,gi:P,defaultUnit:A,categoryName:x})}),_}function C(_){let u=document.getElementById("soapVisualGuidanceList");if(!u)return;let t=Array.isArray(_==null?void 0:_.tips)&&_.tips.length?_.tips:["No visual flags detected for this formula."];u.innerHTML=t.map(m=>`<li>${m}</li>`).join("")}function f(_){return!_||typeof _!="object"?null:_.ingredient&&_.ingredient.ingredient_category_name||_.ingredient_category_name||_.ingredient_category&&_.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:L,collectAdditiveSettings:o,syncAdditivePair:a,applyComputedOutputs:n,updateAdditivesOutput:r,updateVisualGuidance:C},e.fragrances={buildFragranceRow:i,updateFragranceTotals:h,collectFragranceData:E}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c}=e.helpers,{STAGE_CONFIGS:p}=e.constants;function N(q){var L;let w=p[q];if(!w)return;let F=document.getElementById(w.tabId);if(F){if((L=M.bootstrap)!=null&&L.Tab)bootstrap.Tab.getOrCreateInstance(F).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),F.classList.add("active"),F.setAttribute("aria-selected","true");let $=document.getElementById(w.paneId);$&&$.classList.add("show","active")}e.layout.scheduleStageHeightSync(),F.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function z(q){var w,F;if(q===1){let L=document.getElementById("unitGrams");L&&(L.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let $=document.getElementById("moldCylinderCorrection");$&&($.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(w=e.mold)!=null&&w.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(q===2){let L=document.getElementById("oilRows");L&&(L.innerHTML="",L.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(q===3){let L=document.getElementById("lyeTypeNaoh");L&&(L.checked=!0);let $=document.getElementById("waterMethod");$&&($.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let O=document.getElementById("lyePurity");O&&(O.value="100");let g=document.getElementById("waterPct");g&&(g.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(q===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(L=>{let $=document.getElementById(L);$&&($.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(L=>{let $=document.getElementById(L);$&&($.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),q===5){let L=document.getElementById("fragranceRows");L&&(L.innerHTML="",(F=e.fragrances)!=null&&F.buildFragranceRow&&L.appendChild(e.fragrances.buildFragranceRow()));let $=document.getElementById("fragrancePercentTotal");$&&($.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),k()}function H(q){var w;if(q===1){let F=c(document.getElementById("moldWaterWeight").value),L=c(document.getElementById("oilTotalTarget").value),$=c(document.getElementById("moldOilPct").value),O=!!document.querySelector('input[name="weight_unit"]:checked')&&(F>0||L>0)&&$>0;return{state:O?"complete":"incomplete",label:O?"Sized":"Needs target"}}if(q===2){let L=Array.from(document.querySelectorAll("#oilRows .oil-row")).some($=>{var a,n,r,d;let o=(n=(a=$.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),O=c((r=$.querySelector(".oil-grams"))==null?void 0:r.value),g=c((d=$.querySelector(".oil-percent"))==null?void 0:d.value);return o&&(O>0||g>0)});return{state:L?"complete":"incomplete",label:L?"Oils added":"Add oils"}}if(q===3){let F=c(document.getElementById("lyeSuperfat").value),L=(w=document.getElementById("waterMethod"))==null?void 0:w.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!L&&F>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return q===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(L=>c(document.getElementById(L).value)>0)?"Added":"Optional"}:q===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some($=>{var a,n,r,d;let o=(n=(a=$.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),O=c((r=$.querySelector(".fragrance-grams"))==null?void 0:r.value),g=c((d=$.querySelector(".fragrance-percent"))==null?void 0:d.value);return o||O>0||g>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function k(){let q=document.getElementById("soapStageTabList");q&&q.querySelectorAll(".soap-stage-status").forEach(F=>F.remove());let w=document.getElementById("soapStageProgress");w&&(w.textContent="")}e.stages={openStageByIndex:N,resetStage:z,updateStageStatuses:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p,clamp:N}=e.helpers,{computeFattyAcids:z,computeQualities:H,computeOilQualityScores:k}=e.calc,{QUALITY_RANGES:q,QUALITY_HINTS:w,QUALITY_FEEL_HINTS:F,IODINE_RANGE:L,IODINE_SCALE_MAX:$,INS_RANGE:o,INS_SCALE_MAX:O,QUALITY_BASE:g,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:i}=e.ui;function h({barId:x,fillId:G,value:W,max:s,label:I}){let y=document.getElementById(x),b=document.getElementById(G);if(!y||!b)return null;let T=isFinite(W)?W:0,R=Math.max(0,Math.min(s,T)),D=s>0?R/s*100:0;return b.style.width=`${D}%`,y.setAttribute("aria-valuemin","0"),y.setAttribute("aria-valuemax",String(s)),y.setAttribute("aria-valuenow",R.toFixed(1)),I&&y.setAttribute("aria-label",I),{bar:y,fill:b,value:T}}function E(x,G,W){if(!(!x||!W)){if(x.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(G)){x.classList.add("bg-secondary");return}G<W[0]?x.classList.add("bg-warning"):G>W[1]?x.classList.add("bg-danger"):x.classList.add("bg-success")}}function C(x,G,W,s,I,y){let b=h({barId:x,fillId:G,value:W,max:I,label:y});b&&E(b.fill,W,s)}function f(){let x={hardness:{range:q.hardness,scale:100},cleansing:{range:q.cleansing,scale:100},conditioning:{range:q.conditioning,scale:100},bubbly:{range:q.bubbly,scale:100},creamy:{range:q.creamy,scale:100},iodine:{range:L,scale:$},ins:{range:o,scale:O}};Object.entries(x).forEach(([G,W])=>{let[s,I]=W.range,y=W.scale,b=G.charAt(0).toUpperCase()+G.slice(1),T=G==="iodine"?"iodineBar":G==="ins"?"insBar":`quality${b}Bar`,R=document.getElementById(`quality${b}Safe`);if(R){let K=Math.max(0,Math.min(100,s/y*100)),U=Math.max(0,Math.min(100,(I-s)/y*100));R.style.left=`${K}%`,R.style.width=`${U}%`,R.title=`Safe range ${c(s,0)}-${c(I,0)}`}let D=document.getElementById(T);D&&(D.dataset.safeRange=`${c(s,0)}-${c(I,0)}`);let Y=document.getElementById(`quality${b}RangeMin`),V=document.getElementById(`quality${b}RangeMax`);Y&&(Y.textContent=c(s,0)),V&&(V.textContent=c(I,0))})}function _(x,G){let W=N(x.hardness||0,0,100),s=N(x.bubbly||0,0,100),I=N(x.conditioning||0,0,100),y=N(I+(G||0)*3,0,100),b=document.getElementById("feelHardness"),T=document.getElementById("feelBubbly"),R=document.getElementById("feelConditioning"),D=document.getElementById("feelGreasy");b&&(b.value=c(W,1)),T&&(T.value=c(s,1)),R&&(R.value=c(I,1)),D&&(D.value=c(y,1))}function u(x){r.forEach(G=>{let W=document.getElementById(`fattyBar${G.charAt(0).toUpperCase()}${G.slice(1)}`);if(!W)return;let s=N(p(x[G]),0,100),I=s;W.style.width=`${I}%`,W.style.backgroundColor=n[G]||"var(--color-muted)",W.title=`${G.charAt(0).toUpperCase()}${G.slice(1)}: ${c(s,1)}%`})}function t(){var s;let x=((s=document.getElementById("qualityPreset"))==null?void 0:s.value)||"balanced",G=Array.from(document.querySelectorAll(".quality-focus:checked"));if(x==="none"&&!G.length)return null;let W=x==="none"?{...g}:a[x]?{...a[x]}:{...g};return G.forEach(I=>{let y=I.dataset.attr,b=I.dataset.direction,T=q[y];T&&(W[y]=b==="low"?T[0]:T[1])}),W}function m(){let x=t(),G={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(G).forEach(([W,s])=>{if(!s)return;let I=document.getElementById(`${s.id}Label`);if(!x){s.classList.add("d-none"),I&&(I.textContent="");return}let y=p(x[W]);if(!isFinite(y)){s.classList.add("d-none"),I&&(I.textContent="");return}let b=W==="iodine"?$:W==="ins"?O:100,T=N(y,0,b);s.classList.remove("d-none"),s.style.left=`${T/b*100}%`,s.setAttribute("aria-label",`Apply ${W} target`),s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.title=`Target ${W}: ${c(y,1)}`,I&&(I.textContent=c(y,1))})}function S(){let x=t();if(!x){i("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let W=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(U=>{var le,me;let X=e.units.toGrams((le=U.querySelector(".oil-grams"))==null?void 0:le.value),Z=((me=U.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ie=null;if(Z)try{ie=JSON.parse(Z)}catch{ie=null}return{row:U,grams:X,fattyProfile:ie}}).filter(U=>U.grams>0);if(!W.length){i("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let s=z(W.map(U=>({grams:U.grams,fattyProfile:U.fattyProfile}))),I=H(s.percent),y={hardness:N((x.hardness-I.hardness)/100,-1,1),cleansing:N((x.cleansing-I.cleansing)/100,-1,1),conditioning:N((x.conditioning-I.conditioning)/100,-1,1),bubbly:N((x.bubbly-I.bubbly)/100,-1,1),creamy:N((x.creamy-I.creamy)/100,-1,1)},b=W.reduce((U,X)=>U+X.grams,0),T=[],R=0,D=.8,Y=W.filter(U=>!U.fattyProfile||typeof U.fattyProfile!="object").length;if(Y===W.length){i("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(Y&&i("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),W.forEach(U=>{let X=k(U.fattyProfile),Z=y.hardness*X.hardness+y.cleansing*X.cleansing+y.conditioning*X.conditioning+y.bubbly*X.bubbly+y.creamy*X.creamy,ie=N(1+Z*D,.2,1.8),le=U.grams*ie;T.push({row:U.row,grams:le}),R+=le}),R<=0){i("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let V=b/R,K=e.oils.getOilTargetGrams()||b;T.forEach(U=>{let X=U.grams*V,Z=U.row.querySelector(".oil-grams"),ie=U.row.querySelector(".oil-percent");if(Z&&(Z.value=X>0?c(e.units.fromGrams(X),2):""),ie&&K>0){let le=X/K*100;ie.value=le>0?c(le,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),i("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function P(x){let{qualities:G,fattyPercent:W,coveragePct:s,iodine:I,ins:y,sapAvg:b,superfat:T,warnings:R}=x,D=s>0;function Y(ce,re){var v,B;let pe=document.getElementById(`quality${ce}Value`),he=document.getElementById(`quality${ce}Hint`);if(!pe)return;pe.textContent=D&&isFinite(re)?c(re,1):"--",d(pe);let l=ce.toLowerCase(),j=q[l],Q=h({barId:`quality${ce}Bar`,fillId:`quality${ce}Fill`,value:D?re:0,max:100,label:ce});Q&&j&&(E(Q.fill,re,j),D&&isFinite(re)?Q.bar.title=`${ce}: ${c(re,1)} (safe ${j[0]}-${j[1]}). ${w[l]||""}`.trim():Q.bar.title=`${ce}: -- (safe ${j[0]}-${j[1]}). ${w[l]||""}`.trim()),he&&j&&(!D||!isFinite(re)?he.textContent="":re<j[0]?he.textContent=((v=F[l])==null?void 0:v.low)||"":re>j[1]?he.textContent=((B=F[l])==null?void 0:B.high)||"":he.textContent="")}Y("Hardness",G.hardness),Y("Cleansing",G.cleansing),Y("Conditioning",G.conditioning),Y("Bubbly",G.bubbly),Y("Creamy",G.creamy);let V=document.getElementById("fattyCoverageNote");V&&(V.textContent=s>0?`Fatty acid coverage: ${c(s,1)}% of oils`:"Fatty acid coverage: not enough data yet");let K=document.getElementById("iodineValue"),U=document.getElementById("insValue"),X=document.getElementById("sapAvgValue");K&&(K.textContent=I>0?c(I,1):"--",d(K)),U&&(U.textContent=y>0?c(y,1):"--",d(U)),X&&(X.textContent=b>0?c(b,1):"--",d(X)),C("iodineBar","iodineFill",I,L,$,"Iodine"),C("insBar","insFill",y,o,O,"INS");let Z=(W.lauric||0)+(W.myristic||0)+(W.palmitic||0)+(W.stearic||0),ie=(W.ricinoleic||0)+(W.oleic||0)+(W.linoleic||0)+(W.linolenic||0),le=document.getElementById("fattySatRatioResult");le&&(le.textContent=Z+ie>0?`${c(Z,0)}:${c(ie,0)}`:"--",d(le)),r.forEach(ce=>{let re=`fatty${ce.charAt(0).toUpperCase()}${ce.slice(1)}`,pe=W[ce];document.getElementById(re).textContent=D&&pe?`${c(pe,1)}%`:"--"}),_(G,T||0),u(W),m();let me=Array.isArray(R)?R.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(ce=>`<li>${ce}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function A(){var x;document.querySelectorAll(".soap-quality-help").forEach(G=>{let W=G.dataset.quality;w[W]&&G.setAttribute("title",w[W])}),(x=M.bootstrap)!=null&&x.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(G=>{bootstrap.Tooltip.getOrCreateInstance(G)})}e.quality={setQualityRangeBars:f,updateQualityTargets:m,applyQualityTargets:S,updateQualitiesDisplay:P,initQualityTooltips:A}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p,clamp:N}=e.helpers;function z(o){let O=0,g=0;return(o||[]).forEach(a=>{let n=p(a==null?void 0:a.sapKoh),r=p(a==null?void 0:a.grams);n>0&&r>0&&(O+=n*r,g+=r)}),g>0?O/g:0}function H(o){var h,E,C,f,_,u,t,m,S,P,A,x;let O=o.qualityReport||{},g=O.fatty_acids_pct||{},a=O.qualities||{},n=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:p(O.sap_avg_koh)||z(o.oils||[]),r=p(O.iodine),d=p(O.ins)||(n&&r?n-r:0),i=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((h=document.getElementById("qualityPreset"))==null?void 0:h.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(G=>G.id),mold:i,oils:(o.oils||[]).map(G=>({name:G.name||null,grams:c(G.grams||0,2),iodine:G.iodine||null,sap_koh:G.sapKoh||null,fatty_profile:G.fattyProfile||null,global_item_id:G.global_item_id||null,default_unit:G.default_unit||null,ingredient_category_name:G.ingredient_category_name||null})),totals:{total_oils_g:c(o.totalOils||0,2),batch_yield_g:c(o.batchYield||0,2),lye_pure_g:c(o.lyePure||0,2),lye_adjusted_g:c(o.lyeAdjusted||0,2),water_g:c(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((E=o.additives)==null?void 0:E.fragrancePct)||0,lactate_pct:((C=o.additives)==null?void 0:C.lactatePct)||0,sugar_pct:((f=o.additives)==null?void 0:f.sugarPct)||0,salt_pct:((_=o.additives)==null?void 0:_.saltPct)||0,citric_pct:((u=o.additives)==null?void 0:u.citricPct)||0,fragrance_g:c(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:c(((m=o.additives)==null?void 0:m.lactateG)||0,2),sugar_g:c(((S=o.additives)==null?void 0:S.sugarG)||0,2),salt_g:c(((P=o.additives)==null?void 0:P.saltG)||0,2),citric_g:c(((A=o.additives)==null?void 0:A.citricG)||0,2),citric_lye_g:c(((x=o.additives)==null?void 0:x.citricLyeG)||0,2)},qualities:{hardness:c(a.hardness||0,1),cleansing:c(a.cleansing||0,1),conditioning:c(a.conditioning||0,1),bubbly:c(a.bubbly||0,1),creamy:c(a.creamy||0,1),iodine:c(r||0,1),ins:c(d||0,1),sap_avg:c(n||0,1)},fatty_acids:g,updated_at:new Date().toISOString()}}function k(o,O,g,a,n){var E,C,f,_,u;let r=(C=(E=document.getElementById(o))==null?void 0:E.value)==null?void 0:C.trim(),d=((f=document.getElementById(O))==null?void 0:f.value)||"",i=a&&((_=document.getElementById(a))==null?void 0:_.value)||"",h=n&&((u=document.getElementById(n))==null?void 0:u.value)||"";return{name:r||g,globalItemId:d?parseInt(d):void 0,defaultUnit:i||void 0,categoryName:h||void 0}}function q(o){let O=[],g=N(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var _,u,t,m,S,P,A;let n=(u=(_=a.querySelector(".fragrance-typeahead"))==null?void 0:_.value)==null?void 0:u.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((m=a.querySelector(".fragrance-default-unit"))==null?void 0:m.value)||"",i=((S=a.querySelector(".fragrance-category"))==null?void 0:S.value)||"",h=(P=a.querySelector(".fragrance-grams"))==null?void 0:P.value,E=(A=a.querySelector(".fragrance-percent"))==null?void 0:A.value,C=e.units.toGrams(h),f=N(p(E),0);C<=0&&f>0&&g>0&&(C=g*(f/100)),!(!n&&!r&&C<=0)&&O.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:i||void 0,grams:C,pct:f})}),O}function w(o,O){let g=[];return document.querySelectorAll(`#${o} .row`).forEach(function(a){var E,C,f;let n=(C=(E=a.querySelector(".tool-typeahead"))==null?void 0:E.value)==null?void 0:C.trim(),r=((f=a.querySelector(".tool-gi-id"))==null?void 0:f.value)||"",d=a.querySelector(".tool-qty"),i=a.querySelector(".tool-unit"),h=d&&d.value!=="";!n&&!r||(O==="container"?g.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(d.value):1}):g.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(d.value):0,unit:((i==null?void 0:i.value)||"").trim()||"gram"}))}),g}function F(o){let O=e.config.isAuthenticated?"member":"public",g=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:O,mode:g,unitOptionsHtml:e.config.unitOptionsHtml})}function L(o,O){let g=F(o),a=g.querySelector(".tool-typeahead"),n=g.querySelector(".tool-qty");a&&(a.value=O),n&&o==="container"&&(n.value=1),o==="container"?document.getElementById("tool-containers").appendChild(g):o==="consumable"?document.getElementById("tool-consumables").appendChild(g):document.getElementById("tool-ingredients").appendChild(g)}function $(o){var r,d,i,h;let O=H(o),g=(o.oils||[]).map(E=>({name:E.name||void 0,global_item_id:E.global_item_id||void 0,quantity:E.grams,unit:"gram",default_unit:E.default_unit||void 0,ingredient_category_name:E.ingredient_category_name||void 0})),a=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&g.push({name:a,quantity:c(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&g.push({name:"Distilled Water",quantity:c(o.water,2),unit:"gram"}),q(o.totalOils||0).forEach(E=>{E.grams>0&&g.push({name:E.name,global_item_id:E.globalItemId,quantity:c(E.grams,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let E=k("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");g.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.lactateG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((d=o.additives)==null?void 0:d.sugarG)>0){let E=k("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");g.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.sugarG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((i=o.additives)==null?void 0:i.saltG)>0){let E=k("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");g.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.saltG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((h=o.additives)==null?void 0:h.citricG)>0){let E=k("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");g.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.citricG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName}),g.push({name:"Extra Lye for Citric Acid",quantity:c(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:g.concat(w("tool-ingredients","ingredient")),consumables:w("tool-consumables","consumable"),containers:w("tool-containers","container"),notes:JSON.stringify(O)}}e.recipePayload={collectFragranceRows:q,collectDraftLines:w,buildLineRow:F,addStubLine:L,buildSoapRecipePayload:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p,clamp:N}=e.helpers,{formatWeight:z,formatPercent:H}=e.units;function k(){var h;let a=((h=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:h.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,d=p(n==null?void 0:n.value),i=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:i,purity:d}}function q(){let a=document.getElementById("lyePurity"),n=k();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function w(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function F(a=null,n=null){var h;let r=document.getElementById("stageWaterOutput"),d=document.getElementById("stageWaterComputedHint"),i=n||(a==null?void 0:a.waterMethod)||((h=document.getElementById("waterMethod"))==null?void 0:h.value)||"percent";if(r){let E=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=E?z(a.waterG):"--"}if(d){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){d.textContent=`Set oils in Stage 2 to calculate water. ${w(i)}`;return}if(i==="concentration"){let E=a.lyeConcentrationInput||a.lyeConcentration||0;d.textContent=`Using ${c(E,1)}% lye concentration from ${z(a.lyeAdjusted||0)} lye.`;return}if(i==="ratio"){let E=a.waterRatioInput||a.waterRatio||0;d.textContent=`Using ${c(E,2)} : 1 water-to-lye ratio from ${z(a.lyeAdjusted||0)} lye.`;return}d.textContent=`Using ${c(a.waterPct||0,1)}% of total oils (${z(a.totalOils)}).`}}function L(a=null,n=null){var P;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),i=document.getElementById("waterPreview"),h=document.getElementById("concPreview"),E=document.getElementById("ratioPreview");if(!r&&!d&&!i&&!h&&!E)return;let C=(A,x)=>{A&&(A.textContent=x)},f=n||(a==null?void 0:a.waterMethod)||((P=document.getElementById("waterMethod"))==null?void 0:P.value)||"percent",_=p(a==null?void 0:a.totalOils),u=p(a==null?void 0:a.lyeAdjusted),t=p(a==null?void 0:a.waterG);if(_<=0||u<=0){C(r,"Based on -- oils. All values update live as you change inputs."),C(d,"--"),C(i,"--"),C(h,"--"),C(E,"--");return}let m=p(a==null?void 0:a.lyeConcentration)>0?p(a==null?void 0:a.lyeConcentration):u+t>0?u/(u+t)*100:0,S=p(a==null?void 0:a.waterRatio)>0?p(a==null?void 0:a.waterRatio):u>0?t/u:0;if(C(r,`Based on ${z(_)} oils. All values update live as you change inputs.`),C(d,z(u)),C(i,z(t)),C(h,m>0?H(m):"--"),C(E,S>0?`${c(S,2)} : 1`:"--"),f==="concentration"){let A=p(a==null?void 0:a.lyeConcentrationInput);A>0&&C(h,H(A))}if(f==="ratio"){let A=p(a==null?void 0:a.waterRatioInput);A>0&&C(E,`${c(A,2)} : 1`)}}function $(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),F(null,a),L(null,a)}function o(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,d=[],i=e.oils.collectOilData(),h=e.oils.getOilTargetGrams(),C=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(f=>N(p(f.value),0)).some(f=>f>0);return(!i.length||n<=0)&&d.push("Add at least one oil with a weight or percent."),!h&&n<=0&&C&&d.push("Enter a total oils target or weights to convert percentages."),h>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),h>0&&n>h+.01?d.push("Oil weights exceed the mold target."):!h&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:i}}function O(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=p(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function g(){var E,C,f,_;let n=k().purity;isFinite(n)||(n=100);let r=((E=document.getElementById("waterMethod"))==null?void 0:E.value)||"percent",d=p((C=document.getElementById("waterPct"))==null?void 0:C.value),i=p((f=document.getElementById("lyeConcentration"))==null?void 0:f.value),h=p((_=document.getElementById("waterRatio"))==null?void 0:_.value);return{purity:n,waterMethod:r,waterPct:d,lyeConcentration:i,waterRatio:h}}e.runnerInputs={getLyeSelection:k,applyLyeSelection:q,setWaterMethod:$,updateStageWaterSummary:F,updateLiveCalculationPreview:L,validateCalculation:o,readSuperfatInput:O,sanitizeLyeInputs:g}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{getStorage:c}=e.helpers;function p(){if(!e.config.calcLimit)return{count:0,date:null};let q=c();if(!q)return{count:0,date:null};try{let w=q.getItem("soap_calc_usage"),F=new Date().toISOString().slice(0,10);if(!w)return{count:0,date:F};let L=JSON.parse(w);return!L||L.date!==F?{count:0,date:F}:{count:Number(L.count)||0,date:F}}catch{return{count:0,date:null}}}function N(q){if(!e.config.calcLimit)return;let w=c();if(!w)return;let F=new Date().toISOString().slice(0,10);try{w.setItem("soap_calc_usage",JSON.stringify({count:q,date:F}))}catch{}}function z(){return e.config.calcLimit&&p().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function H(){if(!e.config.calcLimit)return;let w=p().count+1;N(w);let F=Math.max(0,e.config.calcLimit-w);F<=1&&e.ui.showSoapAlert("info",`You have ${F} calculation${F===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function k(q){if(!e.config.calcLimit||q===null||q>1)return;let w=document.getElementById("soapSignupModal");w&&(M.bootstrap&&M.bootstrap.Modal?M.bootstrap.Modal.getOrCreateInstance(w).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:z,consumeCalcQuota:H,maybeShowSignupModal:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state;function p({oils:z,selection:H,superfat:k,purity:q,waterMethod:w,waterPct:F,lyeConcentration:L,waterRatio:$,totalOils:o}){let O=e.additives.collectAdditiveSettings(),g=e.recipePayload.collectFragranceRows(o||0);return{oils:(z||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:g.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:O.lactatePct||0,sugar_pct:O.sugarPct||0,salt_pct:O.saltPct||0,citric_pct:O.citricPct||0,lactate_name:O.lactateName||"Sodium Lactate",sugar_name:O.sugarName||"Sugar",salt_name:O.saltName||"Salt",citric_name:O.citricName||"Citric Acid"},lye:{selected:(H==null?void 0:H.selected)||"NaOH",superfat:k,purity:q},water:{method:w,water_pct:F,lye_concentration:L,water_ratio:$},meta:{unit_display:c.currentUnit||"g"}}}async function N(z){var w;let H=((w=document.querySelector('meta[name="csrf-token"]'))==null?void 0:w.getAttribute("content"))||"",k=new AbortController,q=M.setTimeout(()=>k.abort(),2500);try{let F=await fetch("/tools/api/soap/calculate",{method:"POST",signal:k.signal,headers:{"Content-Type":"application/json",...H?{"X-CSRFToken":H}:{}},body:JSON.stringify(z||{})});if(!F.ok)return null;let L=await F.json();return!L||L.success!==!0||typeof L.result!="object"?null:L.result}catch{return null}finally{M.clearTimeout(q)}}e.runnerService={buildServicePayload:p,calculateWithSoapService:N}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:p}=e.helpers,{formatWeight:N,formatPercent:z}=e.units,H=e.state,k={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function q(o){return(o||[]).map(O=>{var g;return{name:O.name||null,grams:p(O.grams),sapKoh:p((g=O.sap_koh)!=null?g:O.sapKoh),iodine:p(O.iodine),fattyProfile:O.fatty_profile||O.fattyProfile||null,global_item_id:O.global_item_id||null,default_unit:O.default_unit||null,ingredient_category_name:O.ingredient_category_name||null}})}function w(o,O){let g=document.getElementById(o);g&&(g.textContent=O)}function F({resultsCard:o,lyeAdjusted:O,waterData:g,batchYield:a,totalOils:n,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let i=p(o.water_lye_ratio)||g.waterRatio;w("lyeAdjustedOutput",N(p(o.lye_adjusted_g)||O)),w("waterOutput",N(p(o.water_g)||g.waterG)),w("batchYieldOutput",N(a)),w("lyeConcentrationOutput",z(p(o.lye_concentration_pct)||g.lyeConcentration)),w("waterRatioOutput",isFinite(i)&&i>0?c(i,2).toString():"--"),w("totalOilsOutput",N(n)),w("superfatOutput",z(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(h=>e.ui.pulseValue(document.getElementById(h)))}function L({showAlerts:o,lyeTotals:O,purity:g,waterData:a}){if(!o)return;O.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),g<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${c(g,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function $({serviceResult:o,validation:O,selection:g,superfat:a,purity:n,waterMethod:r,waterPct:d,lyeConcentrationInput:i,waterRatioInput:h,showAlerts:E}){var Y;let C=o.lye_type||g.lyeType||"NaOH",f=p(o.total_oils_g)||O.totals.totalWeight,_=p(o.superfat_pct),u=isFinite(_)?_:a,t={sapAvg:p(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},m=p(o.lye_pure_g),S=p(o.lye_adjusted_g),P=p(o.lye_purity_pct)||n,A=o.water_method||r,x=p(o.water_pct)||d,G=p(o.lye_concentration_input_pct)||i,W=p(o.water_ratio_input)||h,s={waterG:p(o.water_g),lyeConcentration:p(o.lye_concentration_pct),waterRatio:p(o.water_lye_ratio)},I=o.results_card||{},y=o.quality_report||{},b=q(o.oils||O.oils),T={waterG:s.waterG,lyeAdjusted:S,totalOils:f,waterMethod:A,waterPct:x,lyeConcentrationInput:G,waterRatioInput:W,lyeConcentration:s.lyeConcentration,waterRatio:s.waterRatio};e.runnerInputs.updateStageWaterSummary(T),e.runnerInputs.updateLiveCalculationPreview(T);let R=o.additives||k;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(R);let D=p(I.batch_yield_g)||f+S+s.waterG+R.fragranceG+R.lactateG+R.sugarG+R.saltG+R.citricG;return(Y=e.mold)!=null&&Y.updateWetBatterWarning&&e.mold.updateWetBatterWarning(D),F({resultsCard:I,lyeAdjusted:S,waterData:s,batchYield:D,totalOils:f,superfat:u}),e.ui.updateResultsWarnings(s),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:y.qualities||{},fattyPercent:y.fatty_acids_pct||{},coveragePct:p(y.coverage_pct),iodine:p(y.iodine),ins:p(y.ins),sapAvg:t.sapAvg,superfat:u,waterData:s,additives:R,oils:b,totalOils:f,warnings:y.warnings||[]}),e.additives.updateVisualGuidance({tips:y.visual_guidance||[]}),e.stages.updateStageStatuses(),L({showAlerts:E,lyeTotals:t,purity:P,waterData:s}),H.lastCalc={totalOils:f,oils:b,lyeType:C,superfat:u,purity:P,lyePure:m,lyeAdjusted:S,water:s.waterG,waterMethod:A,waterPct:x,lyeConcentration:s.lyeConcentration,waterRatio:s.waterRatio,sapAvg:t.sapAvg,usedSapFallback:t.usedFallback,additives:R,batchYield:D,qualityReport:y,export:o.export||null},H.lastCalc}e.runnerRender={applyServiceResult:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state,p=e.runnerInputs,N=e.runnerQuota,z=e.runnerService,H=e.runnerRender;async function k(q={}){var F;let w={consumeQuota:!1,showAlerts:!0,...q};try{w.showAlerts&&e.ui.clearSoapAlerts();let L=p.validateCalculation();if(!L.ok)return p.updateStageWaterSummary(null),p.updateLiveCalculationPreview(null),(F=e.mold)!=null&&F.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),w.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${L.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(w.consumeQuota&&!N.canConsumeCalcQuota())return null;let $=p.readSuperfatInput(),o=p.getLyeSelection(),O=p.sanitizeLyeInputs(),g=(c.calcRequestSeq||0)+1;c.calcRequestSeq=g;let a=z.buildServicePayload({oils:L.oils,selection:o,superfat:$,purity:O.purity,waterMethod:O.waterMethod,waterPct:O.waterPct,lyeConcentration:O.lyeConcentration,waterRatio:O.waterRatio,totalOils:L.totals.totalWeight}),n=await z.calculateWithSoapService(a);if(g!==c.calcRequestSeq)return c.lastCalc;if(!n)return w.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=H.applyServiceResult({serviceResult:n,validation:L,selection:o,superfat:$,purity:O.purity,waterMethod:O.waterMethod,waterPct:O.waterPct,lyeConcentrationInput:O.lyeConcentration,waterRatioInput:O.waterRatio,showAlerts:w.showAlerts});return w.consumeQuota&&N.consumeCalcQuota(),r}catch{return w.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...q)=>p.getLyeSelection(...q),applyLyeSelection:(...q)=>p.applyLyeSelection(...q),setWaterMethod:(...q)=>p.setWaterMethod(...q),updateLiveCalculationPreview:(...q)=>p.updateLiveCalculationPreview(...q),calculateAll:k,buildSoapRecipePayload:(...q)=>e.recipePayload.buildSoapRecipePayload(...q),buildLineRow:(...q)=>e.recipePayload.buildLineRow(...q),addStubLine:(...q)=>e.recipePayload.addStubLine(...q),maybeShowSignupModal:(...q)=>N.maybeShowSignupModal(...q)}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{formatTime:c,getStorage:p}=e.helpers,N="soap_tool_state_v2";function z(g,a){let n=[];return document.querySelectorAll(`#${g} .row`).forEach(d=>{var _,u,t;let i=(u=(_=d.querySelector(".tool-typeahead"))==null?void 0:_.value)==null?void 0:u.trim(),h=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",E=d.querySelector(".tool-qty"),C=d.querySelector(".tool-unit"),f=E&&E.value!==""?e.helpers.toNumber(E.value):null;!i&&!h||(a==="container"?n.push({name:i||"",global_item_id:h?parseInt(h):null,quantity:f&&f>0?f:1}):n.push({name:i||"",global_item_id:h?parseInt(h):null,quantity:f&&f>=0?f:0,unit:(C==null?void 0:C.value)||"gram"}))}),n}function H(){let g=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var u,t,m,S,P,A,x,G,W,s;let n=((t=(u=a.querySelector(".oil-typeahead"))==null?void 0:u.value)==null?void 0:t.trim())||"",r=((m=a.querySelector(".oil-grams"))==null?void 0:m.value)||"",d=((S=a.querySelector(".oil-percent"))==null?void 0:S.value)||"",i=((P=a.querySelector(".oil-sap-koh"))==null?void 0:P.value)||"",h=((A=a.querySelector(".oil-iodine"))==null?void 0:A.value)||"",E=((x=a.querySelector(".oil-fatty"))==null?void 0:x.value)||"",C=((G=a.querySelector(".oil-gi-id"))==null?void 0:G.value)||"",f=((W=a.querySelector(".oil-default-unit"))==null?void 0:W.value)||"",_=((s=a.querySelector(".oil-category"))==null?void 0:s.value)||"";!n&&!r&&!d&&!C||g.push({name:n,grams:r,percent:d,sap:i,iodine:h,fattyRaw:E,gi:C,defaultUnit:f,categoryName:_})}),g}function k(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let g=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var f,_,u,t,m,S,P;let r=((_=(f=n.querySelector(".fragrance-typeahead"))==null?void 0:f.value)==null?void 0:_.trim())||"",d=((u=n.querySelector(".fragrance-grams"))==null?void 0:u.value)||"",i=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",h=((m=n.querySelector(".fragrance-gi-id"))==null?void 0:m.value)||"",E=((S=n.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",C=((P=n.querySelector(".fragrance-category"))==null?void 0:P.value)||"";!r&&!d&&!i&&!h||g.push({name:r,grams:d,percent:i,gi:h,defaultUnit:E,categoryName:C})}),g}function q(g,a){let n=document.getElementById("oilRows");if(!n||!g)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=g.name||"",r.querySelector(".oil-grams").value=g.grams||"",r.querySelector(".oil-percent").value=g.percent||"",r.querySelector(".oil-sap-koh").value=g.sap||"",r.querySelector(".oil-iodine").value=g.iodine||"",r.querySelector(".oil-fatty").value=g.fattyRaw||"",r.querySelector(".oil-gi-id").value=g.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=g.defaultUnit||"");let i=r.querySelector(".oil-category");i&&(i.value=g.categoryName||"");let h=Array.from(n.children);return a>=h.length?n.appendChild(r):n.insertBefore(r,h[a]),r}function w(){var n,r,d,i,h,E,C,f,_,u,t,m,S,P,A,x,G,W,s,I,y,b,T,R,D,Y,V;let g=p();if(!g)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:H(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((i=document.getElementById("waterMethod"))==null?void 0:i.value)||"percent",water_pct:((h=document.getElementById("waterPct"))==null?void 0:h.value)||"",lye_concentration:((E=document.getElementById("lyeConcentration"))==null?void 0:E.value)||"",water_ratio:((C=document.getElementById("waterRatio"))==null?void 0:C.value)||""},additives:{fragrances:k(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((f=document.getElementById("additiveLactateName"))==null?void 0:f.value)||"",lactate_gi:((_=document.getElementById("additiveLactateGi"))==null?void 0:_.value)||"",lactate_unit:((u=document.getElementById("additiveLactateUnit"))==null?void 0:u.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((m=document.getElementById("additiveSugarName"))==null?void 0:m.value)||"",sugar_gi:((S=document.getElementById("additiveSugarGi"))==null?void 0:S.value)||"",sugar_unit:((P=document.getElementById("additiveSugarUnit"))==null?void 0:P.value)||"",sugar_category:((A=document.getElementById("additiveSugarCategory"))==null?void 0:A.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((x=document.getElementById("additiveSaltName"))==null?void 0:x.value)||"",salt_gi:((G=document.getElementById("additiveSaltGi"))==null?void 0:G.value)||"",salt_unit:((W=document.getElementById("additiveSaltUnit"))==null?void 0:W.value)||"",salt_category:((s=document.getElementById("additiveSaltCategory"))==null?void 0:s.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((I=document.getElementById("additiveCitricName"))==null?void 0:I.value)||"",citric_gi:((y=document.getElementById("additiveCitricGi"))==null?void 0:y.value)||"",citric_unit:((b=document.getElementById("additiveCitricUnit"))==null?void 0:b.value)||"",citric_category:((T=document.getElementById("additiveCitricCategory"))==null?void 0:T.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((R=document.getElementById("moldShape"))==null?void 0:R.value)||"loaf",cylinder_correction:!!((D=document.getElementById("moldCylinderCorrection"))!=null&&D.checked),cylinder_factor:((Y=document.getElementById("moldCylinderFactor"))==null?void 0:Y.value)||"0.85"},quality:{preset:((V=document.getElementById("qualityPreset"))==null?void 0:V.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(K=>K.id)},lines:{ingredients:z("tool-ingredients","ingredient"),consumables:z("tool-consumables","consumable"),containers:z("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"basics",selections:[]},updated_at:Date.now()};try{g.setItem(N,JSON.stringify(a));let K=document.getElementById("soapLastSaved");K&&(K.textContent=c(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function F(){var i,h,E;let g=p();if(!g)return;let a=g.getItem(N);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let C=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);C&&(C.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(f=>{let _=e.oils.buildOilRow();_.querySelector(".oil-typeahead").value=f.name||"",_.querySelector(".oil-grams").value=f.grams||"",_.querySelector(".oil-percent").value=f.percent||"",_.querySelector(".oil-sap-koh").value=f.sap||"",_.querySelector(".oil-iodine").value=f.iodine||"",_.querySelector(".oil-fatty").value=f.fattyRaw||"",_.querySelector(".oil-gi-id").value=f.gi||"";let u=_.querySelector(".oil-default-unit");u&&(u.value=f.defaultUnit||"");let t=_.querySelector(".oil-category");t&&(t.value=f.categoryName||""),r.appendChild(_)})),n.lye_form){let C=document.getElementById("lyeSuperfat");C&&(C.value=n.lye_form.superfat||"5");let f=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);f&&(f.checked=!0);let _=document.getElementById("lyePurity");_&&(_.value=n.lye_form.lye_purity||"100");let u=document.getElementById("waterMethod");u&&(u.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let m=document.getElementById("lyeConcentration");m&&(m.value=n.lye_form.lye_concentration||"");let S=document.getElementById("waterRatio");S&&(S.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let C=document.getElementById("fragranceRows");if(C&&((i=e.fragrances)!=null&&i.buildFragranceRow)){C.innerHTML="";let R=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(R)R.forEach(D=>{let Y=e.fragrances.buildFragranceRow();Y.querySelector(".fragrance-typeahead").value=D.name||"",Y.querySelector(".fragrance-grams").value=D.grams||"",Y.querySelector(".fragrance-percent").value=D.percent||"",Y.querySelector(".fragrance-gi-id").value=D.gi||"";let V=Y.querySelector(".fragrance-default-unit");V&&(V.value=D.defaultUnit||"");let K=Y.querySelector(".fragrance-category");K&&(K.value=D.categoryName||""),C.appendChild(Y)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",D.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",D.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",C.appendChild(D)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let f=document.getElementById("additiveLactateName");f&&(f.value=n.additives.lactate_name||"");let _=document.getElementById("additiveLactateGi");_&&(_.value=n.additives.lactate_gi||"");let u=document.getElementById("additiveLactateUnit");u&&(u.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let m=document.getElementById("additiveSugarName");m&&(m.value=n.additives.sugar_name||"");let S=document.getElementById("additiveSugarGi");S&&(S.value=n.additives.sugar_gi||"");let P=document.getElementById("additiveSugarUnit");P&&(P.value=n.additives.sugar_unit||"");let A=document.getElementById("additiveSugarCategory");A&&(A.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let x=document.getElementById("additiveSaltName");x&&(x.value=n.additives.salt_name||"");let G=document.getElementById("additiveSaltGi");G&&(G.value=n.additives.salt_gi||"");let W=document.getElementById("additiveSaltUnit");W&&(W.value=n.additives.salt_unit||"");let s=document.getElementById("additiveSaltCategory");s&&(s.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let I=document.getElementById("additiveCitricName");I&&(I.value=n.additives.citric_name||"");let y=document.getElementById("additiveCitricGi");y&&(y.value=n.additives.citric_gi||"");let b=document.getElementById("additiveCitricUnit");b&&(b.value=n.additives.citric_unit||"");let T=document.getElementById("additiveCitricCategory");T&&(T.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let C=document.getElementById("moldShape");C&&(C.value=n.mold.shape||"loaf");let f=document.getElementById("moldCylinderCorrection");f&&(f.checked=!!n.mold.cylinder_correction);let _=document.getElementById("moldCylinderFactor");_&&(_.value=n.mold.cylinder_factor||"0.85");let u=document.getElementById("oilTotalTarget");(h=e.mold)!=null&&h.syncMoldPctFromTarget&&((E=e.mold)!=null&&E.syncTargetFromMold)&&(e.units.toGrams(u==null?void 0:u.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let C=document.getElementById("qualityPreset");if(C){let f=n.quality.preset||"balanced",_=Array.from(C.options).find(u=>u.value===f);C.value=_?f:"balanced"}document.querySelectorAll(".quality-focus").forEach(f=>{f.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(f.id)})}function d(C,f,_){let u=document.getElementById(C);u&&(u.innerHTML="",(f||[]).forEach(t=>{let m=e.runner.buildLineRow(_),S=m.querySelector(".tool-typeahead"),P=m.querySelector(".tool-gi-id"),A=m.querySelector(".tool-qty"),x=m.querySelector(".tool-unit");S&&(S.value=t.name||""),P&&(P.value=t.global_item_id||""),A&&t.quantity!==void 0&&t.quantity!==null&&(A.value=t.quantity),x&&t.unit&&Array.from(x.options).find(W=>W.value===t.unit)&&(x.value=t.unit),u.appendChild(m)}))}if(n.lines&&(d("tool-ingredients",n.lines.ingredients,"ingredient"),d("tool-consumables",n.lines.consumables,"consumable"),d("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let C=document.getElementById("soapLastSaved");C&&(C.textContent=c(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let L=null;function $(){L&&clearTimeout(L),L=setTimeout(w,350)}let o=null;function O(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:w,restoreState:F,serializeLines:z,serializeOils:H,restoreOilRow:q,queueStateSave:$,queueAutoCalc:O}})(window);(function(M){"use strict";var pe,he;let e=M.SoapTool=M.SoapTool||{},{LACTATE_CATEGORY_SET:c,SUGAR_CATEGORY_SET:p,SALT_CATEGORY_SET:N,CITRIC_CATEGORY_SET:z}=e.constants,{round:H,toNumber:k,clamp:q}=e.helpers,{formatWeight:w,formatPercent:F,toGrams:L}=e.units,$=e.state;async function o(){var j;let l=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return l||((j=e.ui)!=null&&j.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function O(l){let j=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(Q=>{var ae,ue,ne,de;let v=(ue=(ae=Q.querySelector(".fragrance-typeahead"))==null?void 0:ae.value)==null?void 0:ue.trim(),B=(ne=Q.querySelector(".fragrance-grams"))==null?void 0:ne.value,J=(de=Q.querySelector(".fragrance-percent"))==null?void 0:de.value,ee=L(B),te=q(k(J),0);ee<=0&&te>0&&l>0&&(ee=l*(te/100)),!(ee<=0&&te<=0&&!v)&&(!te&&ee>0&&l>0&&(te=ee/l*100),j.push({name:v||"Fragrance/Essential Oils",grams:ee,pct:te}))}),j}function g(l){var ee,te,ae,ue,ne,de,ye,se;let j=[];if(!l)return j;let Q=((te=(ee=document.getElementById("additiveLactateName"))==null?void 0:ee.value)==null?void 0:te.trim())||"Sodium Lactate",v=((ue=(ae=document.getElementById("additiveSugarName"))==null?void 0:ae.value)==null?void 0:ue.trim())||"Sugar",B=((de=(ne=document.getElementById("additiveSaltName"))==null?void 0:ne.value)==null?void 0:de.trim())||"Salt",J=((se=(ye=document.getElementById("additiveCitricName"))==null?void 0:ye.value)==null?void 0:se.trim())||"Citric Acid";return l.lactateG>0&&j.push({name:Q,grams:l.lactateG,pct:l.lactatePct}),l.sugarG>0&&j.push({name:v,grams:l.sugarG,pct:l.sugarPct}),l.saltG>0&&j.push({name:B,grams:l.saltG,pct:l.saltPct}),l.citricG>0&&j.push({name:J,grams:l.citricG,pct:l.citricPct}),j}function a(l){var J,ee;if(Array.isArray((J=l==null?void 0:l.export)==null?void 0:J.csv_rows)&&l.export.csv_rows.length)return l.export.csv_rows;let j=l.totalOils||0,Q=[["section","name","quantity","unit","percent"]];return Q.push(["Summary","Lye Type",l.lyeType||"","",""]),Q.push(["Summary","Superfat",H(l.superfat||0,2),"%",""]),Q.push(["Summary","Lye Purity",H(l.purity||0,1),"%",""]),Q.push(["Summary","Water Method",l.waterMethod||"","",""]),Q.push(["Summary","Water %",H(l.waterPct||0,1),"%",""]),Q.push(["Summary","Lye Concentration",H(l.lyeConcentration||0,1),"%",""]),Q.push(["Summary","Water Ratio",H(l.waterRatio||0,2),"",""]),Q.push(["Summary","Total Oils",H(j,2),"gram",""]),Q.push(["Summary","Batch Yield",H(l.batchYield||0,2),"gram",""]),(l.oils||[]).forEach(te=>{let ae=j>0?H(te.grams/j*100,2):"";Q.push(["Oils",te.name||"Oil",H(te.grams||0,2),"gram",ae])}),l.lyeAdjusted>0&&Q.push(["Lye",l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",H(l.lyeAdjusted,2),"gram",""]),l.water>0&&Q.push(["Water","Distilled Water",H(l.water,2),"gram",""]),O(j).forEach(te=>{Q.push(["Fragrance",te.name,H(te.grams||0,2),"gram",H(te.pct||0,2)])}),g(l.additives).forEach(te=>{Q.push(["Additives",te.name,H(te.grams||0,2),"gram",H(te.pct||0,2)])}),((ee=l.additives)==null?void 0:ee.citricLyeG)>0&&Q.push(["Additives","Extra Lye for Citric Acid",H(l.additives.citricLyeG,2),"gram",""]),Q}function n(l){if(l==null)return"";let j=String(l);return/[",\n]/.test(j)?`"${j.replace(/"/g,'""')}"`:j}function r(l){return l.map(j=>j.map(n).join(",")).join(`
`)}function d(l,j){let Q=new Blob([l],{type:"text/csv;charset=utf-8;"}),v=URL.createObjectURL(Q),B=document.createElement("a");B.href=v,B.download=j,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(v)}function i(l){var de,ye;if(typeof((de=l==null?void 0:l.export)==null?void 0:de.sheet_html)=="string"&&l.export.sheet_html.trim())return l.export.sheet_html;let j=l.totalOils||0,Q=(l.oils||[]).map(se=>({name:se.name||"Oil",grams:se.grams||0,pct:j>0?se.grams/j*100:0})),v=O(j),B=g(l.additives),J=new Date().toLocaleString(),ee=Q.length?Q.map(se=>`
          <tr>
            <td>${se.name}</td>
            <td class="text-end">${w(se.grams)}</td>
            <td class="text-end">${F(se.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',te=v.length?v.map(se=>`
          <tr>
            <td>${se.name}</td>
            <td class="text-end">${w(se.grams)}</td>
            <td class="text-end">${F(se.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',ae=B.length?B.map(se=>`
          <tr>
            <td>${se.name}</td>
            <td class="text-end">${w(se.grams)}</td>
            <td class="text-end">${F(se.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',ue=l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",ne=((ye=l.additives)==null?void 0:ye.citricLyeG)>0?`<tr><td>Extra Lye for Citric Acid</td><td class="text-end">${w(l.additives.citricLyeG)}</td></tr>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${J}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${l.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${F(l.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${F(l.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${w(j)}</span></div>
      <div class="summary-item"><span>Water</span><span>${w(l.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${w(l.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${l.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${F(l.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ee}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${ue}</td><td class="text-end">${w(l.lyeAdjusted||0)}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${w(l.water||0)}</td></tr>
        ${ne}
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${te}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ae}</tbody>
    </table>
  </body>
</html>`}let h=document.getElementById("oilRows"),E=document.getElementById("addOil"),C=document.getElementById("normalizeOils");E&&h&&(E.dataset.bound="direct",E.addEventListener("click",function(){h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),C&&(C.dataset.bound="direct",C.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),h&&h.addEventListener("input",function(l){l.target.classList.contains("oil-grams")&&($.lastOilEdit={row:l.target.closest(".oil-row"),field:"grams"}),l.target.classList.contains("oil-percent")&&($.lastOilEdit={row:l.target.closest(".oil-row"),field:"percent"}),(l.target.classList.contains("oil-grams")||l.target.classList.contains("oil-percent")||l.target.classList.contains("oil-typeahead"))&&(l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),h&&h.addEventListener("focusin",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row"))}),h&&h.addEventListener("focusout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),l.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams"),l.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")}),h&&h.addEventListener("keydown",function(l){l.key==="Enter"&&(l.target.classList.contains("oil-grams")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams")),l.target.classList.contains("oil-percent")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")))}),h&&h.addEventListener("mouseover",function(l){if(!l.target.classList.contains("oil-typeahead"))return;let j=l.target.closest(".oil-row");!j||j===$.lastPreviewRow||($.lastPreviewRow=j,e.oils.setSelectedOilProfileFromRow(j))}),h&&h.addEventListener("mouseout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),h&&h.addEventListener("click",function(l){let j=l.target.closest(".oil-profile-open");if(j){let v=j.closest(".oil-row");if(v){e.oils.setSelectedOilProfileFromRow(v);let B=document.getElementById("oilProfileModal");B&&M.bootstrap&&bootstrap.Modal.getOrCreateInstance(B).show()}return}let Q=l.target.closest(".remove-oil");if(Q){let v=Q.closest(".oil-row");v&&($.lastRemovedOil=e.oils.serializeOilRow(v),$.lastRemovedOilIndex=Array.from(v.parentElement.children).indexOf(v),e.ui.showUndoToast("Oil removed.")),v&&$.lastOilEdit&&$.lastOilEdit.row===v&&($.lastOilEdit=null,e.oils.clearSelectedOilProfile()),v&&v.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let f=document.getElementById("fragranceRows"),_=document.getElementById("addFragrance");_&&f&&(_.dataset.bound="direct",_.addEventListener("click",function(){f.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),f&&(f.addEventListener("input",function(l){l.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"grams"}),l.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"percent"}),(l.target.classList.contains("fragrance-grams")||l.target.classList.contains("fragrance-percent")||l.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),f.addEventListener("click",function(l){var v;let j=l.target.closest(".remove-fragrance");if(!j)return;let Q=j.closest(".fragrance-row");Q&&((v=e.state.lastFragranceEdit)==null?void 0:v.row)===Q&&(e.state.lastFragranceEdit=null),Q&&Q.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let u=document.getElementById("soapStageTabContent"),t=()=>{if(!u)return null;let l=u.querySelector(".tab-pane.active")||u.querySelector(".tab-pane.show.active");return l?l.querySelector(".soap-stage-body")||l:null},m=()=>{u&&u.addEventListener("wheel",l=>{let j=l.target;if(!(j instanceof HTMLElement))return;let Q=j.closest('input[type="number"]');if(!(Q instanceof HTMLInputElement))return;let v=t();if(!(v instanceof HTMLElement)||v.scrollHeight<=v.clientHeight+1)return;document.activeElement===Q&&typeof Q.blur=="function"&&Q.blur();let B=v.scrollTop<=0,J=v.scrollTop+v.clientHeight>=v.scrollHeight-1;l.deltaY<0&&B||l.deltaY>0&&J||(v.scrollTop+=l.deltaY,l.preventDefault())},{passive:!1})};u&&(u.addEventListener("click",l=>{let j=l.target.closest("[data-stage-action]"),Q=l.target.closest("[data-soap-action]");if(!j&&!Q)return;if(l.preventDefault(),l.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),Q){if(Q.dataset.bound==="direct")return;let J=Q.dataset.soapAction;J==="add-oil"&&h&&(h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),J==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),J==="add-fragrance"&&f&&(f.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let v=j.dataset.stageAction,B=Number(j.dataset.stageIndex);Number.isNaN(B)||(v==="prev"&&e.stages.openStageByIndex(Math.max(0,B-1)),v==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,B+1)),v==="reset"&&e.stages.resetStage(B+1))}),m());let S=document.getElementById("soapStageTabList"),P=()=>{if(!S)return;S.querySelectorAll(".nav-item").forEach(j=>j.classList.remove("is-expanded"));let l=S.querySelector(".nav-link.active");l&&l.closest(".nav-item")&&l.closest(".nav-item").classList.add("is-expanded")};S&&(S.addEventListener("shown.bs.tab",()=>{P(),e.layout.scheduleStageHeightSync()}),P());let A=document.getElementById("resultsCardToggle"),x=document.getElementById("resultsCard");A&&x&&A.addEventListener("click",()=>{x.classList.toggle("is-collapsed");let l=x.classList.contains("is-collapsed");A.setAttribute("aria-expanded",(!l).toString());let j=l?"Expand formula details":"Collapse formula details";A.setAttribute("aria-label",j),A.setAttribute("title",j);let Q=A.querySelector("i");Q&&(Q.classList.toggle("fa-chevron-down",l),Q.classList.toggle("fa-chevron-up",!l))}),document.querySelectorAll('input[name="weight_unit"]').forEach(l=>{l.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let G=()=>{var l;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(l=e.mold)!=null&&l.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},W=document.getElementById("oilTotalTarget");W&&W.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let s=document.getElementById("waterMethod");s&&s.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(l=>{l.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(l=>{let j=document.getElementById(l);j&&["input","change"].forEach(Q=>{j.addEventListener(Q,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:l,weightId:j})=>{let Q=document.getElementById(l),v=document.getElementById(j);Q&&Q.addEventListener("input",()=>{let B=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:j,sourceField:"pct",totalOils:B}),e.additives.updateAdditivesOutput(B),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),v&&v.addEventListener("input",()=>{let B=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:j,sourceField:"weight",totalOils:B}),e.additives.updateAdditivesOutput(B),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(l=>{l.addEventListener("input",()=>{e.storage.queueStateSave()})});let y=document.getElementById("qualityPreset");y&&y.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(l=>{l.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let b=document.getElementById("applyQualityTargets");b&&b.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(l=>{l.addEventListener("click",()=>e.quality.applyQualityTargets()),l.addEventListener("keydown",j=>{(j.key==="Enter"||j.key===" ")&&(j.preventDefault(),e.quality.applyQualityTargets())})});let T=document.getElementById("moldWaterWeight");T&&T.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let R=document.getElementById("moldOilPct");R&&R.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldShape");D&&D.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Y=document.getElementById("moldCylinderCorrection");Y&&Y.addEventListener("change",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let V=document.getElementById("moldCylinderFactor");V&&V.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(l=>{l.addEventListener("click",function(){let j=this.dataset.stubKind,Q=this.dataset.stubName;e.runner.addStubLine(j,Q),e.storage.queueStateSave()})});let K=document.getElementById("soapToolPage");K&&(K.addEventListener("click",function(l){l.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),K.addEventListener("input",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses(),e.ui.flashStage(l.target.closest(".soap-stage-card")))}),K.addEventListener("change",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses())}));let U=document.getElementById("addToolIngredient");U&&U.addEventListener("click",function(){let l=document.getElementById("tool-ingredients");l&&l.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let X=document.getElementById("addToolConsumable");X&&X.addEventListener("click",function(){let l=document.getElementById("tool-consumables");l&&l.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let Z=document.getElementById("addToolContainer");Z&&Z.addEventListener("click",function(){let l=document.getElementById("tool-containers");l&&l.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let ie=document.getElementById("calcLyeBtn");ie&&ie.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let le=document.getElementById("saveSoapTool");le&&le.addEventListener("click",async function(){try{let l=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!l)return;let j=e.runner.buildSoapRecipePayload(l);$.lastRecipePayload=j;try{let Q=e.helpers.getStorage();Q&&Q.setItem("soap_recipe_payload",JSON.stringify(j))}catch{}M.SOAP_RECIPE_DTO=j,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let me=document.getElementById("exportSoapCsv");me&&me.addEventListener("click",async function(){var v;let l=await o();if(!l)return;let j=a(l),Q=typeof((v=l==null?void 0:l.export)==null?void 0:v.csv_text)=="string"&&l.export.csv_text?l.export.csv_text:r(j);d(Q,"soap_formula.csv")});let fe=document.getElementById("printSoapSheet");fe&&fe.addEventListener("click",async function(){var v;let l=await o();if(!l)return;let j=i(l),Q=M.open("","_blank","width=960,height=720");if(!Q){(v=e.ui)!=null&&v.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}Q.document.open(),Q.document.write(j),Q.document.close(),Q.focus(),Q.onload=()=>{Q.print()}});let ce=document.getElementById("soapUndoRemove");ce&&ce.addEventListener("click",()=>{$.lastRemovedOil&&(e.storage.restoreOilRow($.lastRemovedOil,$.lastRemovedOilIndex||0),$.lastRemovedOil=null,$.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let l=document.getElementById("soapMobileDrawer"),j=document.getElementById("soapMobileDrawerContent"),Q=document.getElementById("soapMobileDrawerTitle"),v=document.getElementById("soapDrawerEmpty"),B=document.getElementById("soapDrawerClose"),J=document.getElementById("soapQualityCard"),ee=document.getElementById("resultsCard");if(!l||!j||!Q||!J||!ee)return;let te=J.parentElement,ae=ee.parentElement,ue=new Map,ne=null,de=()=>M.matchMedia("(max-width: 767px)").matches,ye=oe=>oe==="quality"?J:ee,se=oe=>oe==="quality"?te:ae,Se=oe=>oe==="quality"?"Display":"Results",ve=oe=>{let ge=ue.get(oe);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",ue.set(oe,ge)),ge.style.height=`${oe.offsetHeight}px`,oe.parentElement&&oe.parentElement!==j&&!ge.parentElement&&oe.parentElement.insertBefore(ge,oe)},Te=oe=>{oe&&(ve(oe),j.appendChild(oe))},be=(oe,ge)=>{let Ie=ue.get(oe);Ie&&Ie.parentElement?Ie.replaceWith(oe):ge&&oe.parentElement!==ge&&ge.appendChild(oe)},_e=()=>{if(!v)return;let oe=ne==="results",ge=getComputedStyle(ee).display!=="none";v.classList.toggle("d-none",!oe||ge)},Ce=oe=>{de()&&(ne&&ne!==oe&&be(ye(ne),se(ne)),Te(ye(oe)),Q.textContent=Se(oe),ne=oe,l.classList.add("is-open"),_e())},Ee=()=>{ne&&(be(ye(ne),se(ne)),ne=null,l.classList.remove("is-open"),_e())};l.querySelectorAll("[data-drawer-target]").forEach(oe=>{oe.addEventListener("click",()=>{let ge=oe.dataset.drawerTarget;ge&&(l.classList.contains("is-open")&&ne===ge?Ee():Ce(ge))})}),B&&B.addEventListener("click",Ee),M.addEventListener("resize",()=>{!de()&&ne&&Ee()}),new MutationObserver(()=>_e()).observe(ee,{attributes:!0,attributeFilter:["style","class"]})})(),M.addEventListener("resize",e.layout.scheduleStageHeightSync),M.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",c,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",p,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",N,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",z,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),h&&!h.querySelector(".oil-row")&&h.appendChild(e.oils.buildOilRow()),f&&!f.querySelector(".fragrance-row")&&(pe=e.fragrances)!=null&&pe.buildFragranceRow&&f.appendChild(e.fragrances.buildFragranceRow()),(he=e.fragrances)!=null&&he.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
