(function(x){"use strict";let e={inventory:"Inventory",global:"Global Library"},u={inventory:"bg-primary",global:"bg-info text-dark"},v={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function N(r,d){let l;return function(){let h=arguments;clearTimeout(l),l=setTimeout(()=>r.apply(null,h),d)}}function z(r){return(r||"").trim().toLowerCase()}function U(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function R(r){return typeof r=="function"?r():r}function T(r){let d=new Set;return(r||[]).forEach(l=>{let h=l&&(l.global_item_id||l.id);h&&d.add(String(h))}),d}function O(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${u[r]||"bg-secondary"} ms-2">${d}</span>`}function P(r,d,l,h){h=h||{},r.innerHTML="";let c=!1;if(d.forEach(m=>{!m.items||!m.items.length||(c=!0,m.items.forEach(s=>{let A=document.createElement("a");A.href="#",A.className="list-group-item list-group-item-action suggestion-item";let p=h.showSubtitle&&s.subtitle?`<div class="small text-muted mt-1">${s.subtitle}</div>`:"";A.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${s.text||s.display_name||s.name||""}</span>
          ${h.showSourceBadge?O(m.source||s.source):""}
        </div>${p}`,A.addEventListener("click",function(t){t.preventDefault(),l(s,m.source||s.source),r.classList.add("d-none")}),r.appendChild(A)}))}),r.classList.toggle("d-none",!c),!c&&r.dataset.emptyMessage){let m=document.createElement("div");m.className="list-group-item text-muted small",m.textContent=r.dataset.emptyMessage,r.appendChild(m),r.classList.remove("d-none")}}function E(r,d,l){r.innerHTML="";let h=!1;d.forEach(c=>{if(!c.ingredients||!c.ingredients.length)return;h=!0;let m=document.createElement("div");m.className="list-group-item text-muted small fw-semibold",m.textContent=c.title,r.appendChild(m),c.ingredients.forEach(s=>{let A=document.createElement("div");A.className="list-group-item ingredient-result";let p=document.createElement("div");p.className="d-flex justify-content-between align-items-center ingredient-summary",p.setAttribute("role","button"),p.setAttribute("tabindex","0"),p.innerHTML=`<span class="fw-semibold">${s.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${s.forms.length} option${s.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",s.forms.forEach(b=>{let k=document.createElement("button");k.type="button",k.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",k.innerHTML=`<div class="fw-semibold">${b.text||b.display_name||b.name||"Form"}</div>`,k.addEventListener("click",function(){l(b,b.source||c.source),r.classList.add("d-none")}),t.appendChild(k)});function S(b){b.type==="keydown"&&b.key!=="Enter"&&b.key!==" "||(b.preventDefault(),t.classList.toggle("d-none"))}p.addEventListener("click",S),p.addEventListener("keydown",S),A.appendChild(p),A.appendChild(t),r.appendChild(A),s.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!h)}function $(r,d,l){r.innerHTML="";let h=!1;if((d||[]).forEach(c=>{h=!0;let m=document.createElement("a");m.href="#",m.className="list-group-item list-group-item-action suggestion-item";let s=c.inci_name?`<div class="small text-muted">${c.inci_name}</div>`:"";m.innerHTML=`<div class="fw-semibold">${c.text||c.name}</div>${s}`,m.addEventListener("click",function(A){A.preventDefault(),l(c,"definition"),r.classList.add("d-none")}),r.appendChild(m)}),r.classList.toggle("d-none",!h),!h&&r.dataset.emptyMessage){let c=document.createElement("div");c.className="list-group-item text-muted small",c.textContent=r.dataset.emptyMessage,r.appendChild(c),r.classList.remove("d-none")}}function o(r){let d=[];return(r||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let h=l.ingredient&&l.ingredient.name||l.ingredient_name||null,c=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,m=l.category_tags||[];l.forms.forEach(s=>{var t,S,b,k,w,j,H,W,g,_;let A=s.physical_form||{},p=s.display_name||s.text||s.name||(h&&s.physical_form_name?`${h}, ${s.physical_form_name}`:l.display_name||l.text||l.name||"");d.push({id:s.id,text:p,item_type:s.item_type||l.item_type,default_unit:s.default_unit||s.unit||l.default_unit||l.unit||null,source:"global",global_item_id:s.id,ingredient_id:s.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:s.ingredient_name||h,physical_form_id:s.physical_form_id||A&&A.id||null,physical_form_name:s.physical_form_name||A&&A.name||null,ingredient_category_name:c,category_tags:m,density:s.density||l.density||null,capacity:s.capacity||l.capacity||null,capacity_unit:s.capacity_unit||l.capacity_unit||null,container_material:s.container_material||l.container_material||null,container_type:s.container_type||l.container_type||null,container_style:s.container_style||l.container_style||null,container_color:s.container_color||l.container_color||null,default_is_perishable:(t=s.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(S=s.recommended_shelf_life_days)!=null?S:l.recommended_shelf_life_days,saponification_value:(k=(b=s.saponification_value)!=null?b:l.saponification_value)!=null?k:null,iodine_value:(j=(w=s.iodine_value)!=null?w:l.iodine_value)!=null?j:null,fatty_acid_profile:(W=(H=s.fatty_acid_profile)!=null?H:l.fatty_acid_profile)!=null?W:null,melting_point_c:(_=(g=s.melting_point_c)!=null?g:l.melting_point_c)!=null?_:null})})}else if(l){let h=l.display_name||l.text||l.name||"",c=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;d.push({id:l.id,text:h,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:c,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),d}function q(r){let d=new Map;return(r||[]).forEach(l=>{let h=l.ingredient_name||l.text||l.name||"",c=l.ingredient_id?`id:${l.ingredient_id}`:`name:${z(h)}`,m=d.get(c)||{ingredient_id:l.ingredient_id||null,name:h,forms:[]};m.forms.push({id:l.id,text:l.text||h,ingredient_name:h,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),d.set(c,m)}),Array.from(d.values())}function f(r,d){let l=[];return(r||[]).forEach(h=>{let c=(h.forms||[]).map(s=>({id:s.id,text:s.name||s.display_name||s.text,ingredient_name:s.ingredient_name||h.name||h.ingredient&&h.ingredient.name||"Ingredient",physical_form_name:s.physical_form_name||null,default_unit:s.default_unit||s.unit||null,source:"global",global_item_id:s.id,density:s.density||null,capacity:s.capacity||null,capacity_unit:s.capacity_unit||null,container_material:s.container_material||null,container_type:s.container_type||null,container_style:s.container_style||null,container_color:s.container_color||null,saponification_value:s.saponification_value||null,iodine_value:s.iodine_value||null,fatty_acid_profile:s.fatty_acid_profile||null,melting_point_c:s.melting_point_c||null})),m=d?c.filter(s=>!s.global_item_id||!d.has(String(s.global_item_id))):c;m.length&&l.push({ingredient_id:h.ingredient_id||h.id||null,name:h.name||h.ingredient&&h.ingredient.name||c[0]&&c[0].ingredient_name||"Ingredient",forms:m})}),l}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function n(r){let d={...v,...r},l=d.inputEl,h=d.invHiddenEl,c=d.giHiddenEl,m=U(d.listEl),s=d.mode||"recipe",A=d.searchType||"ingredient",p=d.includeInventory,t=d.includeGlobal,S=d.ingredientFirst,b=d.displayVariant,k=typeof d.resultFilter=="function"?d.resultFilter:null,w=typeof d.onSelection=="function"?d.onSelection:null,j=d.globalUrlBuilder;if(!l||!h&&s==="recipe"||!c&&d.requireHidden!==!1)return;m&&!m.classList.contains("list-group")&&m.classList.add("list-group"),!m.parentNode&&l.parentNode&&l.parentNode.appendChild(m);function H(L,I){let B=new URLSearchParams({q:L});return I&&I!=="all"&&B.set("type",I),`/inventory/api/search?${B.toString()}`}function W(L,I,B){if(typeof j=="function")return j(L,I,B);let M=new URLSearchParams({q:L});return I&&I!=="all"&&M.set("type",I),I==="ingredient"&&B&&M.set("group","ingredient"),`${s==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${M.toString()}`}let g=N(function(){let L=(l.value||"").trim();if(!L){m.classList.add("d-none"),m.innerHTML="",h&&(h.value=""),c&&(c.value="");return}let I=(R(A)||"ingredient").toLowerCase(),B=R(p),M=R(t),F=I==="ingredient"&&!!R(S),D=b||(F?"grouped":"compact");if(I==="ingredient_definition"||I==="definition"){a(L).then(G=>{let J=G&&G.results||[];$(m,J.map(Z=>({id:Z.id,text:Z.name,name:Z.name,inci_name:Z.inci_name,slug:Z.slug,ingredient_category_id:Z.ingredient_category_id,ingredient_category_name:Z.ingredient_category_name})),_)}).catch(()=>m.classList.add("d-none"));return}let Q=B!==!1?fetch(H(L,I)).then(G=>G.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),K=M!==!1?fetch(W(L,I,F)).then(G=>G.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([Q,K]).then(G=>{let J=G[0]&&G[0].results||[],Z=G[1]&&G[1].results||[],ne=k?J.filter(re=>k(re,"inventory")):J,le=k?Z.filter(re=>k(re,"global")):Z,me=T(ne),fe=o(le).filter(re=>!re.global_item_id||!me.has(String(re.global_item_id))).filter(re=>k?k(re,"global"):!0);if(F){let re=q(ne),ye=f(le,me),he=[];re.length&&he.push({title:"Your Inventory",source:"inventory",ingredients:re}),ye.length&&he.push({title:"Global Library",source:"global",ingredients:ye}),E(m,he,_);return}let se=[];ne.length&&se.push({title:"Your Inventory",source:"inventory",items:ne}),fe.length&&se.push({title:"Global Library",source:"global",items:fe}),P(m,se,_,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:D==="detailed"})}).catch(()=>{m.classList.add("d-none")})},200);function _(L,I){l.value=L.text||L.display_name||L.name||"",I==="inventory"?(h&&(h.value=L.id_numeric||L.id||""),c&&(c.value=L.global_item_id||"")):(c&&(c.value=L.global_item_id||L.id||""),h&&(h.value="")),typeof w=="function"&&w(L,I)}l.addEventListener("input",function(){h&&(h.value=""),c&&(c.value=""),g()}),document.addEventListener("click",function(L){!m.contains(L.target)&&!l.contains(L.target)&&m.classList.add("d-none")})}x.attachMergedInventoryGlobalTypeahead=n,x.renderInventoryTypeaheadList=P})(window);(function(x){"use strict";function e(u,v){var N=v&&v.context||"public",z=v&&v.unitOptionsHtml||"",U=v&&v.mode||(N==="public"?"public":"recipe"),R=document.createElement("div");R.className="row g-2 align-items-end mb-2",R.innerHTML=['<div class="col-md-6">','  <label class="form-label">',u==="container"?"Container":u==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',u==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',u==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',z,"  </select>","</div>",'<div class="col-md-3 ',u!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var T=R.querySelector(".tool-typeahead"),O=R.querySelector(".tool-gi-id"),P=R.querySelector('[data-role="suggestions"]');if(typeof x.attachMergedInventoryGlobalTypeahead=="function"){let E=u==="container"?"container":u==="consumable"?"consumable":"ingredient",$=N!=="public";x.attachMergedInventoryGlobalTypeahead({inputEl:T,giHiddenEl:O,listEl:P,mode:U,context:N,ingredientFirst:u==="ingredient",searchType:E,includeInventory:$,includeGlobal:!0})}return R.querySelector(".tool-remove").addEventListener("click",function(){R.remove()}),R}x.buildToolLineRow=e})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{};e.config={unitOptionsHtml:x.soapToolConfig&&x.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(x.SOAP_CALC_LIMIT)?x.SOAP_CALC_LIMIT:null,calcTier:x.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(x.soapToolConfig&&x.soapToolConfig.useCsvPrimary),isAuthenticated:x.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:u,toNumber:v,clamp:N,formatTime:z,getStorage:U,buildSoapcalcSearchBuilder:R};function u(T,O=3){if(!isFinite(T))return 0;let P=Math.pow(10,O);return Math.round(T*P)/P}function v(T){let O=T;typeof O=="string"&&(O=O.replace(/,/g,"").trim());let P=parseFloat(O);return isFinite(P)?P:0}function N(T,O,P){return!isFinite(T)||T<O?O:P!=null&&T>P?P:T}function z(T){return T?`Saved ${new Date(T).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function U(){try{return x.localStorage}catch{return null}}function R(){let T=(P,E,$)=>{let o=new URLSearchParams({q:P});return E&&E!=="all"&&o.set("type",E),E==="ingredient"&&$&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},O=(P,E,$)=>{let o=new URLSearchParams({q:P});return $&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?O:T}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},v={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},N={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},z=[41,70],U=100,R=[136,170],T=250,O={hardness:(u.hardness[0]+u.hardness[1])/2,cleansing:(u.cleansing[0]+u.cleansing[1])/2,conditioning:(u.conditioning[0]+u.conditioning[1])/2,bubbly:(u.bubbly[0]+u.bubbly[1])/2,creamy:(u.creamy[0]+u.creamy[1])/2},P={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},E={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},$=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],q={g:1,oz:28.3495,lb:453.592},f=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),h=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:u,QUALITY_HINTS:v,QUALITY_FEEL_HINTS:N,IODINE_RANGE:z,IODINE_SCALE_MAX:U,INS_RANGE:R,INS_SCALE_MAX:T,QUALITY_BASE:O,QUALITY_PRESETS:P,FATTY_BAR_COLORS:E,FATTY_DISPLAY_KEYS:$,OIL_TIP_RULES:o,UNIT_FACTORS:q,STAGE_CONFIGS:f,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:h}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{toNumber:u}=e.helpers;function v(R){let T=0,O=0;return R.forEach(P=>{P.iodine>0&&(T+=P.grams,O+=P.iodine*P.grams)}),{iodine:T>0?O/T:0,coverageWeight:T}}function N(R){let T={},O=0;R.forEach(E=>{!E.fattyProfile||typeof E.fattyProfile!="object"||(O+=E.grams,Object.entries(E.fattyProfile).forEach(([$,o])=>{let q=u(o);q>0&&(T[$]=(T[$]||0)+E.grams*(q/100))}))});let P={};return O>0&&Object.entries(T).forEach(([E,$])=>{P[E]=$/O*100}),{percent:P,coveredWeight:O}}function z(R){let T=O=>R[O]||0;return{hardness:T("lauric")+T("myristic")+T("palmitic")+T("stearic"),cleansing:T("lauric")+T("myristic"),conditioning:T("oleic")+T("linoleic")+T("linolenic")+T("ricinoleic"),bubbly:T("lauric")+T("myristic")+T("ricinoleic"),creamy:T("palmitic")+T("stearic")+T("ricinoleic")}}function U(R){if(!R||typeof R!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let T={lauric:u(R.lauric),myristic:u(R.myristic),palmitic:u(R.palmitic),stearic:u(R.stearic),ricinoleic:u(R.ricinoleic),oleic:u(R.oleic),linoleic:u(R.linoleic),linolenic:u(R.linolenic)},O=z(T);return{hardness:(O.hardness||0)/100,cleansing:(O.cleansing||0)/100,conditioning:(O.conditioning||0)/100,bubbly:(O.bubbly||0)/100,creamy:(O.creamy||0)/100}}e.calc={computeIodine:v,computeFattyAcids:N,computeQualities:z,computeOilQualityScores:U},x.SoapCalcService=e.calc})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v,clamp:N}=e.helpers,{UNIT_FACTORS:z}=e.constants,U=e.state;function R(o){return N(v(o),0)*(z[U.currentUnit]||1)}function T(o){return N(o,0)/(z[U.currentUnit]||1)}function O(o){return!isFinite(o)||o<=0?"--":`${u(T(o),2)} ${U.currentUnit}`}function P(o){return isFinite(o)?`${u(o,1)}%`:"--"}function E(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=U.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=U.currentUnit})}function $(o,q={}){if(!o)return;if(o===U.currentUnit){E();return}let f=U.currentUnit;if(U.currentUnit=o,E(),q.skipConvert)return;let a=(z[f]||1)/(z[o]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let l=v(d.value);l>0&&(d.value=u(l*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let l=v(d.value);l>0&&(d.value=u(l*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let d=v(n.value);d>0&&(n.value=u(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=v(r.value);d>0&&(r.value=u(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),q.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:R,fromGrams:T,formatWeight:O,formatPercent:P,updateUnitLabels:E,setUnit:$}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.state,v={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function N(f){f&&(f.classList.remove("soap-number-pulse"),f.offsetWidth,f.classList.add("soap-number-pulse"))}function z(f){var n;let a=document.getElementById(f);return!a||!((n=x.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function U(){let f=Date.now();if(f-u.lastSaveToastAt<3500)return;u.lastSaveToastAt=f;let a=z("soapAutosaveToast");a&&a.show()}function R(f){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=f||"Oil removed.");let r=z("soapUndoToast");r&&r.show()}function T(){let f=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");f&&f.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function O(f){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let r=(f==null?void 0:f.lyeConcentration)||0,d="";r>40&&(d="High concentration"),r>0&&r<25&&(d="Low concentration"),a.textContent=d,a.classList.toggle("d-none",!d)}if(n){let r=(f==null?void 0:f.waterRatio)||0,d="";r>0&&r<1.8&&(d="Low water"),r>2.7&&(d="High water"),n.textContent=d,n.classList.toggle("d-none",!d)}}function P(){document.querySelectorAll("#soapToolPage .form-text").forEach(f=>{let a=f.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function E(f){if(!f||f.type!=="number")return;let a=f.value;if(a===""){f.classList.remove("is-invalid");return}let n=parseFloat(a),r=f.getAttribute("min"),d=f.getAttribute("max"),l=r!==null&&r!==""&&n<parseFloat(r),h=d!==null&&d!==""&&n>parseFloat(d);f.classList.toggle("is-invalid",!isFinite(n)||l||h)}function $(f){var n;if(!f)return;let a=((n=f.querySelector)==null?void 0:n.call(f,".soap-stage-card"))||f;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function o(f,a,n={}){var h;let r=document.getElementById("soapAlertStack");if(!r)return;let d=v[f]||v.info,l=document.createElement("div");l.className=`alert alert-${f} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((h=l.querySelector('[data-role="dismiss"]'))==null||h.addEventListener("click",()=>l.remove())),r.prepend(l),n.persist||setTimeout(()=>{l.parentNode&&l.remove()},n.timeoutMs||4500)}function q(){let f=document.getElementById("soapAlertStack");f&&f.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:N,getToastInstance:z,showAutosaveToast:U,showUndoToast:R,updateResultsMeta:T,updateResultsWarnings:O,applyHelperVisibility:P,validateNumericField:E,flashStage:$,showSoapAlert:o,clearSoapAlerts:q}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{};function u(){let N=document.getElementById("soapStagePane"),z=document.getElementById("soapQualityCard");if(!N||!z)return;if(!x.matchMedia("(min-width: 768px)").matches){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}let R=z.offsetHeight;if(!R){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}N.style.setProperty("--soap-stage-height",`${R}px`),N.classList.add("is-height-synced")}let v=()=>{x.requestAnimationFrame(u)};e.layout={syncStageHeight:u,scheduleStageHeightSync:v}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{clamp:u,toNumber:v,round:N}=e.helpers,{toGrams:z,fromGrams:U}=e.units;function R(){let o=E(),q=document.getElementById("oilTotalTarget"),f=document.getElementById("oilTargetHint");q&&o.effectiveCapacity>0&&z(q.value)<=0&&(q.value=o.targetOils>0?N(U(o.targetOils),2):""),f&&(o.effectiveCapacity>0?f.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":f.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?n=`Cylinder correction applied (${N(o.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}T()}function T(o=null){var s;let q=document.getElementById("moldWetBatterWarning");if(!q)return;let f=()=>{q.classList.add("d-none"),q.textContent=""},a=E(),n=e.state||{},r=n.lastCalc||null,d=(s=e.oils)!=null&&s.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=v(r==null?void 0:r.totalOils),h=v(o);if((!isFinite(h)||h<=0)&&(h=v(r==null?void 0:r.batchYield)),o==null&&l>0&&d>0&&Math.abs(l-d)>.01){f();return}if(!isFinite(h)||h<=0||a.effectiveCapacity<=0){f();return}let c=h-a.effectiveCapacity;if(c<=.01){f();return}let m=n.currentUnit||"g";q.textContent=`Full wet batter is ${N(U(h),2)} ${m}, exceeding mold capacity ${N(U(a.effectiveCapacity),2)} ${m} by ${N(U(c),2)} ${m}. Reduce oils target/% of mold or lower water/additives.`,q.classList.remove("d-none")}function O(){let o=document.getElementById("oilTotalTarget"),q=E();return o&&(q.effectiveCapacity>0&&(o.value=q.targetOils>0?N(U(q.targetOils),2):""),R()),q}function P(){let o=document.getElementById("oilTotalTarget"),q=document.getElementById("moldOilPct");if(!o||!q){let n=E();return R(),n}let f=E();if(f.effectiveCapacity>0){let n=z(o.value),r=u(n,0,f.effectiveCapacity);n>f.effectiveCapacity+.01&&(o.value=N(U(r),2));let d=r>0?r/f.effectiveCapacity*100:0;q.value=r>0?N(d,2):""}let a=E();return R(),a}function E(){var l,h,c;let o=z(document.getElementById("moldWaterWeight").value),q=u(v(document.getElementById("moldOilPct").value),0,100),f=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",a=!!((h=document.getElementById("moldCylinderCorrection"))!=null&&h.checked),n=u(v((c=document.getElementById("moldCylinderFactor"))==null?void 0:c.value),.5,1),r=o>0?o*(a?n:1):0,d=r>0?r*(q/100):0;return{waterWeight:o,oilPct:q,shape:f,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:d}}function $(){var f;let o=((f=document.getElementById("moldShape"))==null?void 0:f.value)||"loaf",q=document.getElementById("moldCylinderOptions");q&&q.classList.toggle("d-none",o!=="cylinder"),R()}e.mold={updateMoldSuggested:R,updateWetBatterWarning:T,syncTargetFromMold:O,syncMoldPctFromTarget:P,getMoldSettings:E,updateMoldShapeUI:$}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{toGrams:U,fromGrams:R}=e.units,{OIL_CATEGORY_SET:T,OIL_TIP_RULES:O}=e.constants,{computeQualities:P}=e.calc,E=e.state;function $(g){let _=g.querySelector(".oil-typeahead"),L=g.querySelector(".oil-sap-koh"),I=g.querySelector(".oil-iodine"),B=g.querySelector(".oil-fatty"),M=g.querySelector(".oil-gi-id"),F=g.querySelector(".oil-default-unit"),D=g.querySelector(".oil-category"),Q=g.querySelector('[data-role="suggestions"]');if(!_||!Q||typeof x.attachMergedInventoryGlobalTypeahead!="function")return;let K=z();x.attachMergedInventoryGlobalTypeahead({inputEl:_,listEl:Q,mode:"public",giHiddenEl:M,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:K,searchType:"ingredient",resultFilter:(G,J)=>H(G,T,J),requireHidden:!1,onSelection:function(G){L&&(L.value=(G==null?void 0:G.saponification_value)||""),I&&(I.value=(G==null?void 0:G.iodine_value)||""),B&&(B.value=G!=null&&G.fatty_acid_profile?JSON.stringify(G.fatty_acid_profile):""),F&&(F.value=(G==null?void 0:G.default_unit)||""),D&&(D.value=(G==null?void 0:G.ingredient_category_name)||""),t(G),m(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),_.addEventListener("input",function(){this.value.trim()||(L&&(L.value=""),I&&(I.value=""),B&&(B.value=""),M&&(M.value=""),F&&(F.value=""),D&&(D.value=""),b())})}function o(){var L,I;let g=document.getElementById("oilRowTemplate"),_=(I=(L=g==null?void 0:g.content)==null?void 0:L.querySelector(".oil-row"))==null?void 0:I.cloneNode(!0);return _?(_.querySelectorAll("input").forEach(B=>{B.value=""}),_.querySelectorAll(".form-text").forEach(B=>{let M=B.closest('.soap-field-stack, [class*="col-"]');M&&M.classList.add("soap-field")}),$(_),_.querySelectorAll(".unit-suffix").forEach(B=>{B.dataset.suffix=E.currentUnit}),_):document.createElement("div")}function q(){let g=document.getElementById("oilTotalTarget"),_=U(g==null?void 0:g.value);if(_>0)return _;let L=e.mold.getMoldSettings();return L.targetOils>0?L.targetOils:0}function f(g){let _=[];return g.forEach(I=>{var F,D;let B=U((F=I.querySelector(".oil-grams"))==null?void 0:F.value),M=N(v((D=I.querySelector(".oil-percent"))==null?void 0:D.value),0);B>0&&M>0&&_.push(B/(M/100))}),_.length?_.reduce((I,B)=>I+B,0)/_.length:0}function a(g,_){if(!g||!_||_<=0)return{allowedGrams:null,allowedPct:null};let L=Array.from(document.querySelectorAll("#oilRows .oil-row")),I=L.reduce((K,G)=>{var J;return G===g?K:K+U((J=G.querySelector(".oil-grams"))==null?void 0:J.value)},0),B=L.reduce((K,G)=>{var J;return G===g?K:K+N(v((J=G.querySelector(".oil-percent"))==null?void 0:J.value),0)},0),M=Math.max(0,100-B),F=Math.max(0,_-I),D=_*M/100;return{allowedGrams:Math.max(0,Math.min(F,D)),allowedPct:M}}function n(g,_,L){if(!g)return;let I=g.querySelector(`[data-role="oil-${_}-hint"]`);I&&(L?(I.textContent=L,I.classList.add("is-visible")):(I.textContent="",I.classList.remove("is-visible")))}function r(g){g&&(g.classList.remove("oil-input-bounce"),g.offsetWidth,g.classList.add("oil-input-bounce"))}function d(g,_,L={}){let I=q();if(!g||!I||I<=0){n(g,_,"");return}let B=g.querySelector(".oil-grams"),M=g.querySelector(".oil-percent"),F=a(g,I);if(_==="grams"&&B){let D=U(B.value),Q="";if(D>I+.01?Q="Entry exceeds the max oils allowed in stage 2.":F.allowedGrams!==null&&D>F.allowedGrams+.01&&(Q=`Must be under ${u(R(F.allowedGrams),2)} ${E.currentUnit} to stay within the stage 2 oil limit.`),Q){let K=F.allowedGrams!==null?u(R(F.allowedGrams),2):u(R(I),2);B.value=K>0?K:"",n(g,_,Q),B.classList.add("oil-input-warning"),r(B),m()}else B.classList.remove("oil-input-warning"),n(g,_,"")}if(_==="percent"&&M){let D=N(v(M.value),0),Q="";if(D>100.01?Q="Entry exceeds the max oils allowed in stage 2.":F.allowedPct!==null&&D>F.allowedPct+.01&&(Q=`Must be under ${u(F.allowedPct,2)}% to stay within the stage 2 oil limit.`),Q){let K=F.allowedPct!==null?u(F.allowedPct,2):100;M.value=K>0?K:"",n(g,_,Q),M.classList.add("oil-input-warning"),r(M),m()}else M.classList.remove("oil-input-warning"),n(g,_,"")}}function l(g,_={}){let L=Array.from(document.querySelectorAll("#oilRows .oil-row")),I=g!=null?g:q(),B=!!_.force;if(!I||I<=0||!L.length){E.lastOilTarget=I;return}let M=L.reduce((D,Q)=>{var K;return D+N(v((K=Q.querySelector(".oil-percent"))==null?void 0:K.value),0)},0),F=L.reduce((D,Q)=>{var K;return D+U((K=Q.querySelector(".oil-grams"))==null?void 0:K.value)},0);if(M<=0&&F<=0){E.lastOilTarget=I;return}if(!(!B&&E.lastOilTarget&&Math.abs(E.lastOilTarget-I)<.01)){if(M>0)L.forEach(D=>{let Q=D.querySelector(".oil-percent"),K=D.querySelector(".oil-grams"),G=N(v(Q==null?void 0:Q.value),0),J=M>0?G/M:0;K&&(K.value=J>0?u(R(I*J),2):""),Q&&(Q.value=J>0?u(J*100,2):"")});else if(F>0){let D=I/F;L.forEach(Q=>{let K=Q.querySelector(".oil-grams"),G=Q.querySelector(".oil-percent"),J=U(K==null?void 0:K.value);if(K){let Z=J>0?J*D:0;K.value=Z>0?u(R(Z),2):""}if(G){let Z=U(K==null?void 0:K.value);G.value=Z>0?u(Z/I*100,2):""}})}E.lastOilTarget=I,m({skipEnforce:!0})}}function h(g,_){if(!E.lastOilEdit||!E.lastOilEdit.row)return!1;let L=E.lastOilEdit.row,I=g.reduce((D,Q)=>{var K;return Q===L?D:D+U((K=Q.querySelector(".oil-grams"))==null?void 0:K.value)},0),B=Math.max(0,_-I),M=L.querySelector(".oil-grams"),F=L.querySelector(".oil-percent");return!M||!F?!1:(M.value=B>0?u(R(B),2):"",F.value=B>0?u(B/_*100,2):"",E.wasCapped=!0,!0)}function c({totalWeight:g,totalPct:_,target:L,capped:I}){let B=document.getElementById("oilLimitWarning");if(!B)return;let M=[];if(I&&M.push("Oil total hit the mold cap and was adjusted."),L>0&&g>L+.01){let F=g-L;M.push(`Oil weights exceed the target by ${u(R(F),2)} ${E.currentUnit}.`)}_>100.01&&M.push(`Oil percentages are over 100% by ${u(_-100,2)}%.`),M.length?(B.classList.remove("d-none"),B.innerHTML=`${M.join(" ")} Adjust oils or mold % to continue.`):(B.classList.add("d-none"),B.textContent="")}function m(g={}){g.skipEnforce||(E.wasCapped=!1);let _=Array.from(document.querySelectorAll("#oilRows .oil-row")),L=e.mold.getMoldSettings(),I=q();if(!I&&!L.targetOils){let D=f(_);if(D>0){I=D;let Q=document.getElementById("oilTotalTarget");Q&&!Q.value&&(Q.value=u(R(D),2))}}let B=0,M=0;if(_.forEach(D=>{let Q=D.querySelector(".oil-grams"),K=D.querySelector(".oil-percent"),G=U(Q==null?void 0:Q.value),J=N(v(K==null?void 0:K.value),0);I>0&&(E.lastOilEdit&&E.lastOilEdit.row===D&&E.lastOilEdit.field==="percent"?(G=J>0?I*(J/100):0,Q.value=J>0?u(R(G),2):""):G>0?(J=G/I*100,K.value=u(J,2)):J>0&&(G=I*(J/100),Q.value=u(R(G),2)),M+=J),G>0&&(B+=G)}),I<=0&&(B>0?(M=0,_.forEach(D=>{let Q=D.querySelector(".oil-grams"),K=D.querySelector(".oil-percent"),G=U(Q==null?void 0:Q.value);if(G>0){let J=G/B*100;K.value=u(J,2),M+=J}})):M=_.reduce((D,Q)=>{var K;return D+N(v((K=Q.querySelector(".oil-percent"))==null?void 0:K.value),0)},0)),!g.skipEnforce&&L.targetOils>0&&B>L.targetOils+.01&&h(_,L.targetOils))return m({skipEnforce:!0});E.totalOilsGrams=B;let F=document.getElementById("oilTotalComputed");return F&&(F.textContent=B>0?`${u(R(B),2)} ${E.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=u(M,2),c({totalWeight:B,totalPct:M,target:I,capped:E.wasCapped}),e.additives.updateAdditivesOutput(B),e.mold.updateMoldSuggested(),k(),{totalWeight:B,totalPct:M,target:I}}function s(){let g=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!g.length)return;let _=q(),L=g.reduce((I,B)=>{var M;return I+N(v((M=B.querySelector(".oil-percent"))==null?void 0:M.value),0)},0);!L&&_>0&&(L=g.reduce((I,B)=>{var F;let M=U((F=B.querySelector(".oil-grams"))==null?void 0:F.value);return I+(M>0?M/_*100:0)},0)),!(L<=0)&&(g.forEach(I=>{let B=I.querySelector(".oil-percent"),M=I.querySelector(".oil-grams"),D=N(v(B.value),0)/L*100;B.value=u(D,2),_>0&&(M.value=D>0?u(R(_*(D/100)),2):"")}),m())}function A(){let g=[];return document.querySelectorAll("#oilRows .oil-row").forEach(_=>{var J,Z,ne,le,me,fe,se,re,ye;let L=(Z=(J=_.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:Z.trim(),I=U((ne=_.querySelector(".oil-grams"))==null?void 0:ne.value),B=v((le=_.querySelector(".oil-sap-koh"))==null?void 0:le.value),M=v((me=_.querySelector(".oil-iodine"))==null?void 0:me.value),F=((fe=_.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",D=((se=_.querySelector(".oil-gi-id"))==null?void 0:se.value)||"",Q=((re=_.querySelector(".oil-default-unit"))==null?void 0:re.value)||"",K=((ye=_.querySelector(".oil-category"))==null?void 0:ye.value)||"",G=null;if(F)try{G=JSON.parse(F)}catch{G=null}I<=0||g.push({name:L||null,grams:I,sapKoh:B,iodine:M,fattyProfile:G,global_item_id:D?parseInt(D):null,default_unit:Q||null,ingredient_category_name:K||null})}),g}function p({name:g,sapKoh:_,iodine:L,fattyProfile:I}={}){let B=document.getElementById("oilProfileFloat"),M=(Z,ne)=>{let le=document.getElementById(Z);le&&(le.textContent=ne)},F=g||"Pick an oil to preview";M("selectedOilName",F),M("selectedOilModalName",F),B&&B.classList.toggle("d-none",!g);let D=_>0?u(_,1):"--",Q=L>0?u(L,1):"--";M("selectedOilSap",D),M("selectedOilModalSap",D),M("selectedOilIodine",Q),M("selectedOilModalIodine",Q);let K=I?P(I):{},G=(Z,ne)=>{let le=isFinite(ne)&&ne>0?u(ne,1):"--";M(Z,le)};G("selectedOilHardness",K.hardness),G("selectedOilModalHardness",K.hardness),G("selectedOilCleansing",K.cleansing),G("selectedOilModalCleansing",K.cleansing),G("selectedOilConditioning",K.conditioning),G("selectedOilModalConditioning",K.conditioning),G("selectedOilBubbly",K.bubbly),G("selectedOilModalBubbly",K.bubbly),G("selectedOilCreamy",K.creamy),G("selectedOilModalCreamy",K.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(Z=>{let ne=`selectedOil${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,le=`selectedOilModal${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,me=I?v(I[Z]):0,fe=me>0?u(me,1):"--";M(ne,fe),M(le,fe)})}function t(g){if(!g){b();return}E.selectedOilProfile=g;let _=g.fatty_acid_profile||null;if(typeof _=="string")try{_=JSON.parse(_)}catch{_=null}p({name:g.text||g.display_name||g.name,sapKoh:v(g.saponification_value),iodine:v(g.iodine_value),fattyProfile:_})}function S(g){var F,D,Q,K,G;if(!g)return;let _=(D=(F=g.querySelector(".oil-typeahead"))==null?void 0:F.value)==null?void 0:D.trim(),L=v((Q=g.querySelector(".oil-sap-koh"))==null?void 0:Q.value),I=v((K=g.querySelector(".oil-iodine"))==null?void 0:K.value),B=((G=g.querySelector(".oil-fatty"))==null?void 0:G.value)||"",M=null;if(B)try{M=JSON.parse(B)}catch{M=null}p({name:_,sapKoh:L,iodine:I,fattyProfile:M})}function b(){E.selectedOilProfile=null,E.lastPreviewRow=null,p()}function k(){let g=document.getElementById("oilBlendTips");if(!g)return;let _=A().filter(B=>B.grams>0||B.percent>0);if(!_.length){g.classList.add("d-none"),g.textContent="";return}let L=new Set;_.forEach(B=>{let M=(B.name||"").toLowerCase();if(M&&O.forEach(F=>{F.match.test(M)&&L.add(F.tip)}),B.fattyProfile&&typeof B.fattyProfile=="object"){let F=v(B.fattyProfile.lauric),D=v(B.fattyProfile.myristic),Q=v(B.fattyProfile.palmitic),K=v(B.fattyProfile.stearic),G=v(B.fattyProfile.ricinoleic),J=v(B.fattyProfile.oleic),Z=v(B.fattyProfile.linoleic),ne=v(B.fattyProfile.linolenic);F+D>=30&&L.add(`${B.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),Q+K>=40&&L.add(`${B.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),J>=60&&L.add(`${B.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),Z+ne>=20&&L.add(`${B.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),G>=60&&L.add(`${B.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let I=Array.from(L).slice(0,6);if(!I.length){g.classList.add("d-none"),g.textContent="";return}g.classList.remove("d-none"),g.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${I.map(B=>`<li>${B}</li>`).join("")}</ul>`}function w(){return E.totalOilsGrams||0}function j(g){var _,L,I,B,M,F,D,Q,K;return g?{name:((_=g.querySelector(".oil-typeahead"))==null?void 0:_.value)||"",grams:((L=g.querySelector(".oil-grams"))==null?void 0:L.value)||"",percent:((I=g.querySelector(".oil-percent"))==null?void 0:I.value)||"",sap:((B=g.querySelector(".oil-sap-koh"))==null?void 0:B.value)||"",iodine:((M=g.querySelector(".oil-iodine"))==null?void 0:M.value)||"",fattyRaw:((F=g.querySelector(".oil-fatty"))==null?void 0:F.value)||"",gi:((D=g.querySelector(".oil-gi-id"))==null?void 0:D.value)||"",defaultUnit:((Q=g.querySelector(".oil-default-unit"))==null?void 0:Q.value)||"",categoryName:((K=g.querySelector(".oil-category"))==null?void 0:K.value)||""}:null}function H(g,_,L){let I=W(g);return I?_.has(I):L==="inventory"}function W(g){return!g||typeof g!="object"?null:g.ingredient&&g.ingredient.ingredient_category_name||g.ingredient_category_name||g.ingredient_category&&g.ingredient_category.name||null}e.oils={attachOilTypeahead:$,buildOilRow:o,getOilTargetGrams:q,updateOilTotals:m,normalizeOils:s,collectOilData:A,setSelectedOilProfileFromRow:S,clearSelectedOilProfile:b,updateOilTips:k,getTotalOilsGrams:w,serializeOilRow:j,validateOilEntry:d,scaleOilsToTarget:l}})(window);(function(x){"use strict";var p;let e=x.SoapTool=x.SoapTool||{},u=e.bulkOils=e.bulkOils||{},{toNumber:v,clamp:N}=e.helpers,z=e.state,U=Array.isArray((p=e.constants)==null?void 0:p.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],R=new Set(["selected_pct","selected_weight_g"]),T=25,O=140,P=260,E={mode:"basics",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function $(){var t,S;(S=(t=e.storage)==null?void 0:t.queueStateSave)==null||S.call(t)}function o(t,S){var b,k;(k=(b=e.ui)==null?void 0:b.showSoapAlert)==null||k.call(b,t,S,{dismissible:!0,timeoutMs:6e3})}function q(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),modeToggle:document.getElementById("bulkOilDisplayAllToggle"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function f(t){return t?t==="name"||R.has(t)?!0:U.includes(t):!1}function a(){(!z.bulkOilModal||typeof z.bulkOilModal!="object")&&(z.bulkOilModal=JSON.parse(JSON.stringify(E)));let t=z.bulkOilModal;return t.mode=t.mode==="all"?"all":"basics",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=f(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let S={},b=t&&typeof t=="object"?t:{};return U.forEach(k=>{let w=v(b[k]);w>0&&(S[k]=w)}),S}function r(t){let S=n(t==null?void 0:t.fatty_profile),b=String((t==null?void 0:t.name)||"").trim(),k=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:v(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${k}:${b.toLowerCase()}`)),name:b,sap_koh:v(t==null?void 0:t.sap_koh),iodine:v(t==null?void 0:t.iodine),fatty_profile:S,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:k,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=q(),S=a(),b=Object.keys(S.selection||{}).length,k=`Selected: ${b}`;t.summaryEl&&(t.summaryEl.textContent=k),t.stageCountEl&&(t.stageCountEl.textContent=String(b))}function l(t){var b;return((b=a().selection)==null?void 0:b[t])||null}function h(t,S={}){var j,H;let b=a();if(!t||!t.key)return null;let k=b.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:N(v((j=S.selected_pct)!=null?j:k.selected_pct),0,100),selected_weight_g:N(v((H=S.selected_weight_g)!=null?H:k.selected_weight_g),0)};return b.selection[t.key]=w,w}function c(t){var b;let S=a();(b=S.selection)!=null&&b[t]&&delete S.selection[t]}function m(t){var b;return((b=a().recordByKey)==null?void 0:b[t])||null}function s(){let t=a();return{mode:t.mode,view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(S=>({key:S.key,name:S.name,sap_koh:S.sap_koh,iodine:S.iodine,fatty_profile:S.fatty_profile||{},default_unit:S.default_unit,ingredient_category_name:S.ingredient_category_name,global_item_id:S.global_item_id,source:S.source,is_basic:!!S.is_basic,selected_pct:N(v(S.selected_pct),0,100),selected_weight_g:N(v(S.selected_weight_g),0)}))}}function A(t){let S=a();S.mode=(t==null?void 0:t.mode)==="all"?"all":"basics",S.viewSelected=!!(t!=null&&t.view_selected),S.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",S.sortKey=f(t==null?void 0:t.sort_key)?t.sort_key:"name",S.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let b={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let j=String((w==null?void 0:w.key)||"").trim(),H=String((w==null?void 0:w.name)||"").trim();!j||!H||(b[j]={key:j,name:H,sap_koh:v(w==null?void 0:w.sap_koh),iodine:v(w==null?void 0:w.iodine),fatty_profile:n(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:v(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:N(v(w==null?void 0:w.selected_pct),0,100),selected_weight_g:N(v(w==null?void 0:w.selected_weight_g),0)})}),S.selection=b,S.visibleRecords=[],S.offset=0,S.totalCount=0,S.hasMore=!0,S.loading=!1,d()}u.shared={FATTY_KEYS:U,LOCAL_SORT_KEYS:R,PAGE_SIZE:T,SCROLL_FETCH_THRESHOLD:O,SEARCH_DEBOUNCE_MS:P,queueStateSave:$,showAlert:o,getRefs:q,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:l,setSelection:h,removeSelection:c,getRecordByKey:m,serializeSelection:s,restoreState:A}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.bulkOils=e.bulkOils||{},v=u.shared;if(!v)return;let{round:N,toNumber:z}=e.helpers,{fromGrams:U}=e.units,{FATTY_KEYS:R,LOCAL_SORT_KEYS:T,getRefs:O,ensureModalState:P,selectionForRecordKey:E,updateSelectionCounters:$}=v;function o(p){let t=O();t.statusEl&&(t.statusEl.textContent=p)}function q(){let p=P(),t=p.mode==="all"?"all oils":"SoapCalc basics";if(p.loading&&!p.visibleRecords.length){o("Loading oils...");return}if(!p.visibleRecords.length){let j=p.query?"No oils match that search.":"No oils available.";o(j);return}let S=p.visibleRecords.length,b=p.totalCount,k=p.hasMore?" \u2022 scroll for more":"",w=p.query?` \u2022 search: "${p.query}"`:"";o(`Loaded ${S}/${b} in ${t}${w}${k}`)}function f(p,t,S){if(typeof p=="string"||typeof t=="string"){let w=String(p||"").toLowerCase(),j=String(t||"").toLowerCase();return w<j?S==="asc"?-1:1:w>j?S==="asc"?1:-1:0}let b=z(p),k=z(t);return b<k?S==="asc"?-1:1:b>k?S==="asc"?1:-1:0}function a(p,t){var S,b;return t==="selected_pct"?((S=E(p.key))==null?void 0:S.selected_pct)||0:t==="selected_weight_g"?((b=E(p.key))==null?void 0:b.selected_weight_g)||0:""}function n(){let p=P();T.has(p.sortKey)&&p.visibleRecords.sort((t,S)=>{let b=f(a(t,p.sortKey),a(S,p.sortKey),p.sortDir);return b!==0?b:f(t.name||"",S.name||"","asc")})}function r(){let p=P();if(!p.viewSelected)return;let t=[],S=[];p.visibleRecords.forEach(b=>{E(b.key)?t.push(b):S.push(b)}),p.visibleRecords=t.concat(S)}function d(){n(),r()}function l(p){let t=String(p||"").trim().toLowerCase();return t==="name"||R.includes(t)?t:"name"}function h(){let p=P();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let S=t.dataset.label||"",b=t.dataset.sortKey||"";p.sortKey===b?t.textContent=`${S} ${p.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=S})}function c(p,t){let S=E(t.key),b=p.querySelector(".bulk-oil-check"),k=p.querySelector(".bulk-oil-pct"),w=p.querySelector(".bulk-oil-weight");b&&(b.checked=!!S),k&&(k.value=S&&S.selected_pct>0?N(S.selected_pct,2):""),w&&(w.value=S&&S.selected_weight_g>0?N(U(S.selected_weight_g),2):"")}function m(p){let t=document.createElement("td");t.className="bulk-oil-acid";let S=z(p);return t.textContent=S>0?N(S,1).toString():"--",t}function s(p){let t=document.createElement("tr");t.dataset.recordKey=p.key;let S=document.createElement("td");S.className="text-center";let b=document.createElement("input");b.type="checkbox",b.className="form-check-input bulk-oil-check",S.appendChild(b),t.appendChild(S);let k=document.createElement("td");k.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=p.name;let j=document.createElement("div");j.className="text-muted small";let H=p.ingredient_category_name?` \xB7 ${p.ingredient_category_name}`:"";j.textContent=`${p.source}${H}`,k.appendChild(w),k.appendChild(j),t.appendChild(k),R.forEach(I=>{var B;t.appendChild(m((B=p.fatty_profile)==null?void 0:B[I]))});let W=document.createElement("td"),g=document.createElement("input");g.type="number",g.min="0",g.max="100",g.step="0.1",g.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",W.appendChild(g),t.appendChild(W);let _=document.createElement("td"),L=document.createElement("input");return L.type="number",L.min="0",L.step="0.1",L.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",_.appendChild(L),t.appendChild(_),c(t,p),t}function A(){let p=O(),t=P();if(!p.bodyEl)return;p.bodyEl.innerHTML="";let S=document.createDocumentFragment();t.visibleRecords.forEach(b=>{S.appendChild(s(b))}),p.bodyEl.appendChild(S),h(),$(),q()}u.render={updateStatusText:o,refreshCatalogStatus:q,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:l,sortButtonsLabel:h,renderVisibleRecords:A}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.bulkOils=e.bulkOils||{},v=u.shared,N=u.render;if(!v||!N)return;let{PAGE_SIZE:z,getRefs:U,ensureModalState:R,normalizeCatalogRecord:T}=v,{refreshCatalogStatus:O,normalizeServerSortKey:P,applyClientOrdering:E,renderVisibleRecords:$,updateStatusText:o}=N;function q(){let a=R(),n=U();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function f({reset:a=!1}={}){let n=R();if(!U().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&q();let d=n.requestToken+1;n.requestToken=d,n.loading=!0,O();let l=new URLSearchParams;l.set("mode",n.mode),l.set("offset",String(n.offset)),l.set("limit",String(z)),l.set("q",n.query||""),l.set("sort_key",P(n.sortKey)),l.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let h=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!h.ok)throw new Error("Unable to load oils catalog");let c=await h.json();if(!c||c.success!==!0||!c.result||!Array.isArray(c.result.records))throw new Error("Invalid oils catalog response");if(d!==n.requestToken)return;let m=c.result.records.map(T),s=Math.max(0,parseInt(c.result.next_offset,10)||n.offset+m.length),A=Math.max(m.length,parseInt(c.result.count,10)||0),p=!!c.result.has_more;m.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?m.slice():n.visibleRecords.concat(m),n.offset=s,n.totalCount=A,n.hasMore=p,E(),$()}catch(h){throw d===n.requestToken&&o("Unable to load oils catalog."),h}finally{d===n.requestToken&&(n.loading=!1,O())}}u.api={fetchCatalogPage:f}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.bulkOils=e.bulkOils||{},v=u.shared,N=u.render,z=u.api;if(!v||!N||!z)return;let{round:U,toNumber:R,clamp:T}=e.helpers,{toGrams:O,fromGrams:P}=e.units,E=e.state,{LOCAL_SORT_KEYS:$,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:q,queueStateSave:f,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:d,setSelection:l,removeSelection:h,getRecordByKey:c,serializeSelection:m,restoreState:s}=v,{applyClientOrdering:A,sortButtonsLabel:p,renderVisibleRecords:t}=N,{fetchCatalogPage:S}=z,b=null,k=null;function w(){var C;let y=n();y.modalEl&&(!b&&((C=x.bootstrap)!=null&&C.Modal)&&(b=x.bootstrap.Modal.getOrCreateInstance(y.modalEl)),b&&b.hide())}function j(){return document.getElementById("oilRows")}function H(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function W(y){return String(y||"").trim().toLowerCase()}function g(y){var C;return W((C=y==null?void 0:y.querySelector(".oil-typeahead"))==null?void 0:C.value)}function _(y){var V;let C=String(((V=y==null?void 0:y.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return C||""}function L(y,C){let V=String(y||"").trim();if(!V)return null;let X=H(),ee=X.find(ie=>String(ie.dataset.bulkOilKey||"")===V);if(ee)return ee;let ae=String((C==null?void 0:C.global_item_id)||"").trim();if(ae&&(ee=X.find(ie=>_(ie)===ae),ee))return ee;let ce=W(C==null?void 0:C.name);return ce&&(ee=X.find(ie=>g(ie)===ce),ee)?ee:null}function I(y,C){if(!y||!C)return;y.dataset.bulkOilKey=C.key||"";let V=y.querySelector(".oil-typeahead"),X=y.querySelector(".oil-sap-koh"),ee=y.querySelector(".oil-iodine"),ae=y.querySelector(".oil-fatty"),ce=y.querySelector(".oil-gi-id"),ie=y.querySelector(".oil-default-unit"),te=y.querySelector(".oil-category"),ue=y.querySelector(".oil-grams"),pe=y.querySelector(".oil-percent");V&&(V.value=C.name||""),X&&(X.value=C.sap_koh>0?U(C.sap_koh,3):""),ee&&(ee.value=C.iodine>0?U(C.iodine,3):""),ae&&(ae.value=C.fatty_profile&&Object.keys(C.fatty_profile).length?JSON.stringify(C.fatty_profile):""),ce&&(ce.value=C.global_item_id||""),ie&&(ie.value=C.default_unit||""),te&&(te.value=C.ingredient_category_name||""),pe&&(pe.value=C.selected_pct>0?U(C.selected_pct,2):""),ue&&(ue.value=C.selected_weight_g>0?U(P(C.selected_weight_g),2):"")}function B(y){if(!y||!y.key)return null;let C=L(y.key,y),V=j();return!C&&V&&(C=e.oils.buildOilRow(),C&&V.appendChild(C)),I(C,y),C}function M(y,C){let V=L(y,C);V&&(E.lastOilEdit&&E.lastOilEdit.row===V&&(E.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function F(){H().forEach(C=>{E.lastOilEdit&&E.lastOilEdit.row===C&&(E.lastOilEdit=null),C.remove()}),e.oils.clearSelectedOilProfile()}function D(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function Q(y,C,V){let X=String(V||"").trim();if(X)return X;let ee=String(C||"").trim();if(ee)return`global:${ee}`;let ae=W(y);return ae?`soapcalc:${ae}`:""}function K(){let y={};return H().forEach(C=>{var _e,de,Ee,Te,Ie,qe,oe,ge,Ce;let V=String(((_e=C.querySelector(".oil-typeahead"))==null?void 0:_e.value)||"").trim(),X=R((de=C.querySelector(".oil-sap-koh"))==null?void 0:de.value),ee=R((Ee=C.querySelector(".oil-iodine"))==null?void 0:Ee.value),ae=String(((Te=C.querySelector(".oil-gi-id"))==null?void 0:Te.value)||"").trim(),ce=String(((Ie=C.querySelector(".oil-default-unit"))==null?void 0:Ie.value)||"gram"),ie=String(((qe=C.querySelector(".oil-category"))==null?void 0:qe.value)||""),te=T(R((oe=C.querySelector(".oil-percent"))==null?void 0:oe.value),0,100),ue=T(O((ge=C.querySelector(".oil-grams"))==null?void 0:ge.value),0),pe=String(((Ce=C.querySelector(".oil-fatty"))==null?void 0:Ce.value)||""),ve={};if(pe)try{let Le=JSON.parse(pe);ve=v.normalizeFattyProfile(Le)}catch{ve={}}let Se=Q(V,ae,C.dataset.bulkOilKey);!Se||!(V||te>0||ue>0||X>0||ee>0||Object.keys(ve).length>0)||(C.dataset.bulkOilKey=Se,y[Se]={key:Se,name:V||"Unnamed oil",sap_koh:X,iodine:ee,fatty_profile:ve,default_unit:ce||"gram",ingredient_category_name:ie,global_item_id:ae?parseInt(ae,10):null,source:ae?"global":"soapcalc",is_basic:!ae,selected_pct:te,selected_weight_g:ue})}),y}function G(){let y=r();y.selection=K(),d()}function J(){let y=r(),C=Object.values(y.selection||{}),V=new Set(C.map(X=>X.key));H().forEach(X=>{let ee=String(X.dataset.bulkOilKey||"").trim();(!ee||!V.has(ee))&&X.remove()}),C.slice().sort((X,ee)=>String(X.name||"").localeCompare(String(ee.name||""))).forEach(X=>{B(X)}),D()}async function Z(){var V;let y=n(),C=r();if(y.modalEl){G(),!b&&((V=x.bootstrap)!=null&&V.Modal)&&(b=x.bootstrap.Modal.getOrCreateInstance(y.modalEl)),y.searchInput&&(y.searchInput.value=C.query||""),y.modeToggle&&(y.modeToggle.checked=C.mode==="all"),y.viewSelectedToggle&&(y.viewSelectedToggle.checked=!!C.viewSelected),y.unitLabelEl&&(y.unitLabelEl.textContent=E.currentUnit||"g"),b&&b.show(),p(),d();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ne(y){let C=y.target;if(!(C instanceof HTMLElement))return;let V=C.closest("tr[data-record-key]");if(!V)return;let X=V.dataset.recordKey||"",ee=c(X);if(!ee)return;let ae=V.querySelector(".bulk-oil-check"),ce=V.querySelector(".bulk-oil-pct"),ie=V.querySelector(".bulk-oil-weight"),te=T(R(ce==null?void 0:ce.value),0,100),ue=T(O(ie==null?void 0:ie.value),0),pe=te>0||ue>0;if(!!(ae!=null&&ae.checked)||pe){ae&&(ae.checked=!0);let _e=l(ee,{selected_pct:te,selected_weight_g:ue});B(_e)}else h(X),M(X,ee);let Se=r();$.has(Se.sortKey)||Se.viewSelected?(A(),t()):d(),D(),f()}async function le(y){let C=r();C.mode=y?"all":"basics",f();try{await S({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}function me(y){let C=r();C.viewSelected=!!y,A(),t(),f()}async function fe(y){let C=y.target instanceof HTMLElement?y.target.closest(".bulk-oil-sort"):null;if(!C)return;let V=C.getAttribute("data-sort-key")||"name",X=r();if(X.sortKey===V?X.sortDir=X.sortDir==="asc"?"desc":"asc":(X.sortKey=V,X.sortDir=V==="name"?"asc":"desc"),f(),$.has(X.sortKey)){A(),t();return}try{await S({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function se(){let y=r();y.selection={},F(),($.has(y.sortKey)||y.viewSelected)&&A(),t(),D(),f()}async function re(){let y=n(),C=r();if(!(!y.scrollEl||C.loading||!C.hasMore||!(y.scrollEl.scrollTop+y.scrollEl.clientHeight>=y.scrollEl.scrollHeight-o)))try{await S({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ye(){k&&x.clearTimeout(k),k=x.setTimeout(async()=>{try{await S({reset:!0})}catch{a("danger","Unable to search oils right now.")}},q)}function he(){J(),f(),w()}function i(){var C;let y=n();y.unitLabelEl&&(y.unitLabelEl.textContent=E.currentUnit||"g"),(C=y.modalEl)!=null&&C.classList.contains("show")&&t()}function Y(){let y=n();y.modalEl&&(y.openBtn&&y.openBtn.addEventListener("click",()=>{Z()}),y.searchInput&&y.searchInput.addEventListener("input",()=>{let C=r();C.query=y.searchInput.value||"",f(),ye()}),y.modeToggle&&y.modeToggle.addEventListener("change",async()=>{await le(!!y.modeToggle.checked)}),y.viewSelectedToggle&&y.viewSelectedToggle.addEventListener("change",()=>{me(!!y.viewSelectedToggle.checked)}),y.scrollEl&&y.scrollEl.addEventListener("scroll",re),y.bodyEl&&(y.bodyEl.addEventListener("input",ne),y.bodyEl.addEventListener("change",ne)),y.modalEl.querySelectorAll(".bulk-oil-sort").forEach(C=>{C.addEventListener("click",fe)}),y.importBtn&&y.importBtn.addEventListener("click",()=>{he()}),y.clearBtn&&y.clearBtn.addEventListener("click",()=>{se()}),y.modalEl.addEventListener("shown.bs.modal",()=>{let C=n();C.searchInput&&C.searchInput.focus()}))}Y(),d(),p(),e.bulkOilsModal={openModal:Z,serializeSelection:m,restoreState:s,onUnitChanged:i}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{toNumber:u,round:v,clamp:N,buildSoapcalcSearchBuilder:z}=e.helpers,{formatWeight:U,toGrams:R,fromGrams:T}=e.units,{FRAGRANCE_CATEGORY_SET:O}=e.constants,P=e.state;function E(c,m,s,A,p){var H;let t=document.getElementById(c),S=document.getElementById(m),b=A?document.getElementById(A):null,k=p?document.getElementById(p):null,w=(H=t==null?void 0:t.parentElement)==null?void 0:H.querySelector('[data-role="suggestions"]');if(!t||!w||typeof x.attachMergedInventoryGlobalTypeahead!="function")return;let j=z();x.attachMergedInventoryGlobalTypeahead({inputEl:t,listEl:w,mode:"public",giHiddenEl:S,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:j,searchType:"ingredient",resultFilter:(W,g)=>{let _=h(W);return _?s.has(_):g==="inventory"},requireHidden:!1,onSelection:function(W){b&&(b.value=(W==null?void 0:W.default_unit)||""),k&&(k.value=(W==null?void 0:W.ingredient_category_name)||""),e.storage.queueStateSave()}}),t.addEventListener("input",function(){this.value.trim()||(b&&(b.value=""),k&&(k.value=""))})}function $({pctId:c,weightId:m}){var S,b,k;let s=document.getElementById(c),A=s==null?void 0:s.value;if(A!==""&&A!==null&&A!==void 0)return u(A);let p=N(((b=(S=e.oils)==null?void 0:S.getTotalOilsGrams)==null?void 0:b.call(S))||0,0);if(p<=0)return 0;let t=R((k=document.getElementById(m))==null?void 0:k.value);return t<=0?0:t/p*100}function o(){var c,m,s,A,p,t,S,b;return{lactatePct:$({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:$({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:$({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:$({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((m=(c=document.getElementById("additiveLactateName"))==null?void 0:c.value)==null?void 0:m.trim())||"Sodium Lactate",sugarName:((A=(s=document.getElementById("additiveSugarName"))==null?void 0:s.value)==null?void 0:A.trim())||"Sugar",saltName:((t=(p=document.getElementById("additiveSaltName"))==null?void 0:p.value)==null?void 0:t.trim())||"Salt",citricName:((b=(S=document.getElementById("additiveCitricName"))==null?void 0:S.value)==null?void 0:b.trim())||"Citric Acid"}}function q(c){let m=(A,p)=>{let t=document.getElementById(A);t&&(t.tagName==="INPUT"?t.value=p:t.textContent=p)},s=A=>A>0?v(T(A),2):"";m("additiveLactateWeight",s(u(c==null?void 0:c.lactateG))),m("additiveSugarWeight",s(u(c==null?void 0:c.sugarG))),m("additiveSaltWeight",s(u(c==null?void 0:c.saltG))),m("additiveCitricWeight",s(u(c==null?void 0:c.citricG))),m("additiveCitricLyeOut",U(u(c==null?void 0:c.citricLyeG)))}function f(c){var S;let m=N(u(c),0),s=(S=e.state)==null?void 0:S.lastCalc,A=N(u(s==null?void 0:s.totalOils),0),p=Math.abs(A-m)<.01,t=s!=null&&s.additives&&p?s.additives:{lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0};return q(t),t}function a(c){let m=c.querySelector(".fragrance-typeahead"),s=c.querySelector(".fragrance-gi-id"),A=c.querySelector(".fragrance-default-unit"),p=c.querySelector(".fragrance-category"),t=c.querySelector('[data-role="suggestions"]');if(!m||!t||typeof x.attachMergedInventoryGlobalTypeahead!="function")return;let S=z();x.attachMergedInventoryGlobalTypeahead({inputEl:m,listEl:t,mode:"public",giHiddenEl:s,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:S,searchType:"ingredient",resultFilter:(b,k)=>{let w=h(b);return w?O.has(w):k==="inventory"},requireHidden:!1,onSelection:function(b){A&&(A.value=(b==null?void 0:b.default_unit)||""),p&&(p.value=(b==null?void 0:b.ingredient_category_name)||""),e.storage.queueStateSave()}}),m.addEventListener("input",function(){this.value.trim()||(A&&(A.value=""),p&&(p.value=""))})}function n(){var s,A;let c=document.getElementById("fragranceRowTemplate"),m=(A=(s=c==null?void 0:c.content)==null?void 0:s.querySelector(".fragrance-row"))==null?void 0:A.cloneNode(!0);return m?(m.querySelectorAll("input").forEach(p=>{p.value=""}),a(m),m.querySelectorAll(".unit-suffix").forEach(p=>{p.dataset.suffix=P.currentUnit}),m):document.createElement("div")}function r(c){let m=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),s=N(c||e.oils.getTotalOilsGrams()||0,0),A=0,p=0;m.forEach(b=>{let k=b.querySelector(".fragrance-grams"),w=b.querySelector(".fragrance-percent"),j=R(k==null?void 0:k.value),H=N(u(w==null?void 0:w.value),0),W=j,g=H;s>0&&(W<=0&&g>0?W=s*(g/100):g<=0&&W>0&&(g=W/s*100)),W>0&&(A+=W),p+=g});let t=document.getElementById("fragrancePercentTotal");t&&(t.textContent=v(p,2));let S=document.getElementById("fragranceTotalComputed");return S&&(S.textContent=A>0?U(A):"--"),{totalGrams:A,totalPct:p}}function d(){let c=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(m=>{var k,w,j,H,W,g,_;let s=((w=(k=m.querySelector(".fragrance-typeahead"))==null?void 0:k.value)==null?void 0:w.trim())||"",A=((j=m.querySelector(".fragrance-grams"))==null?void 0:j.value)||"",p=((H=m.querySelector(".fragrance-percent"))==null?void 0:H.value)||"",t=((W=m.querySelector(".fragrance-gi-id"))==null?void 0:W.value)||"",S=((g=m.querySelector(".fragrance-default-unit"))==null?void 0:g.value)||"",b=((_=m.querySelector(".fragrance-category"))==null?void 0:_.value)||"";!s&&!A&&!p&&!t||c.push({name:s,grams:A,percent:p,gi:t,defaultUnit:S,categoryName:b})}),c}function l(c){let m=document.getElementById("soapVisualGuidanceList");if(!m)return;let s=Array.isArray(c==null?void 0:c.tips)&&c.tips.length?c.tips:["No visual flags detected for this formula."];m.innerHTML=s.map(A=>`<li>${A}</li>`).join("")}function h(c){return!c||typeof c!="object"?null:c.ingredient&&c.ingredient.ingredient_category_name||c.ingredient_category_name||c.ingredient_category&&c.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:E,collectAdditiveSettings:o,applyComputedOutputs:q,updateAdditivesOutput:f,updateVisualGuidance:l},e.fragrances={buildFragranceRow:n,updateFragranceTotals:r,collectFragranceData:d}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{toNumber:u}=e.helpers,{STAGE_CONFIGS:v}=e.constants;function N(T){var E;let O=v[T];if(!O)return;let P=document.getElementById(O.tabId);if(P){if((E=x.bootstrap)!=null&&E.Tab)bootstrap.Tab.getOrCreateInstance(P).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),P.classList.add("active"),P.setAttribute("aria-selected","true");let $=document.getElementById(O.paneId);$&&$.classList.add("show","active")}e.layout.scheduleStageHeightSync(),P.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function z(T){var O,P;if(T===1){let E=document.getElementById("unitGrams");E&&(E.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let $=document.getElementById("moldCylinderCorrection");$&&($.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(O=e.mold)!=null&&O.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(T===2){let E=document.getElementById("oilRows");E&&(E.innerHTML="",E.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(T===3){let E=document.getElementById("lyeTypeNaoh");E&&(E.checked=!0);let $=document.getElementById("waterMethod");$&&($.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let q=document.getElementById("lyePurity");q&&(q.value="100");let f=document.getElementById("waterPct");f&&(f.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(T===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(E=>{let $=document.getElementById(E);$&&($.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(E=>{let $=document.getElementById(E);$&&($.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),T===5){let E=document.getElementById("fragranceRows");E&&(E.innerHTML="",(P=e.fragrances)!=null&&P.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()));let $=document.getElementById("fragrancePercentTotal");$&&($.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),R()}function U(T){var O;if(T===1){let P=u(document.getElementById("moldWaterWeight").value),E=u(document.getElementById("oilTotalTarget").value),$=u(document.getElementById("moldOilPct").value),q=!!document.querySelector('input[name="weight_unit"]:checked')&&(P>0||E>0)&&$>0;return{state:q?"complete":"incomplete",label:q?"Sized":"Needs target"}}if(T===2){let E=Array.from(document.querySelectorAll("#oilRows .oil-row")).some($=>{var a,n,r,d;let o=(n=(a=$.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),q=u((r=$.querySelector(".oil-grams"))==null?void 0:r.value),f=u((d=$.querySelector(".oil-percent"))==null?void 0:d.value);return o&&(q>0||f>0)});return{state:E?"complete":"incomplete",label:E?"Oils added":"Add oils"}}if(T===3){let P=u(document.getElementById("lyeSuperfat").value),E=(O=document.getElementById("waterMethod"))==null?void 0:O.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!E&&P>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return T===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(E=>u(document.getElementById(E).value)>0)?"Added":"Optional"}:T===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some($=>{var a,n,r,d;let o=(n=(a=$.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),q=u((r=$.querySelector(".fragrance-grams"))==null?void 0:r.value),f=u((d=$.querySelector(".fragrance-percent"))==null?void 0:d.value);return o||q>0||f>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function R(){let T=document.getElementById("soapStageTabList");T&&T.querySelectorAll(".soap-stage-status").forEach(P=>P.remove());let O=document.getElementById("soapStageProgress");O&&(O.textContent="")}e.stages={openStageByIndex:N,resetStage:z,updateStageStatuses:R}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v,clamp:N}=e.helpers,{computeFattyAcids:z,computeQualities:U,computeOilQualityScores:R}=e.calc,{QUALITY_RANGES:T,QUALITY_HINTS:O,QUALITY_FEEL_HINTS:P,IODINE_RANGE:E,IODINE_SCALE_MAX:$,INS_RANGE:o,INS_SCALE_MAX:q,QUALITY_BASE:f,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:l}=e.ui;function h({barId:j,fillId:H,value:W,max:g,label:_}){let L=document.getElementById(j),I=document.getElementById(H);if(!L||!I)return null;let B=isFinite(W)?W:0,M=Math.max(0,Math.min(g,B)),F=g>0?M/g*100:0;return I.style.width=`${F}%`,L.setAttribute("aria-valuemin","0"),L.setAttribute("aria-valuemax",String(g)),L.setAttribute("aria-valuenow",M.toFixed(1)),_&&L.setAttribute("aria-label",_),{bar:L,fill:I,value:B}}function c(j,H,W){if(!(!j||!W)){if(j.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(H)){j.classList.add("bg-secondary");return}H<W[0]?j.classList.add("bg-warning"):H>W[1]?j.classList.add("bg-danger"):j.classList.add("bg-success")}}function m(j,H,W,g,_,L){let I=h({barId:j,fillId:H,value:W,max:_,label:L});I&&c(I.fill,W,g)}function s(){let j={hardness:{range:T.hardness,scale:100},cleansing:{range:T.cleansing,scale:100},conditioning:{range:T.conditioning,scale:100},bubbly:{range:T.bubbly,scale:100},creamy:{range:T.creamy,scale:100},iodine:{range:E,scale:$},ins:{range:o,scale:q}};Object.entries(j).forEach(([H,W])=>{let[g,_]=W.range,L=W.scale,I=H.charAt(0).toUpperCase()+H.slice(1),B=H==="iodine"?"iodineBar":H==="ins"?"insBar":`quality${I}Bar`,M=document.getElementById(`quality${I}Safe`);if(M){let K=Math.max(0,Math.min(100,g/L*100)),G=Math.max(0,Math.min(100,(_-g)/L*100));M.style.left=`${K}%`,M.style.width=`${G}%`,M.title=`Safe range ${u(g,0)}-${u(_,0)}`}let F=document.getElementById(B);F&&(F.dataset.safeRange=`${u(g,0)}-${u(_,0)}`);let D=document.getElementById(`quality${I}RangeMin`),Q=document.getElementById(`quality${I}RangeMax`);D&&(D.textContent=u(g,0)),Q&&(Q.textContent=u(_,0))})}function A(j,H){let W=N(j.hardness||0,0,100),g=N(j.bubbly||0,0,100),_=N(j.conditioning||0,0,100),L=N(_+(H||0)*3,0,100),I=document.getElementById("feelHardness"),B=document.getElementById("feelBubbly"),M=document.getElementById("feelConditioning"),F=document.getElementById("feelGreasy");I&&(I.value=u(W,1)),B&&(B.value=u(g,1)),M&&(M.value=u(_,1)),F&&(F.value=u(L,1))}function p(j){r.forEach(H=>{let W=document.getElementById(`fattyBar${H.charAt(0).toUpperCase()}${H.slice(1)}`);if(!W)return;let g=N(v(j[H]),0,100),_=g;W.style.width=`${_}%`,W.style.backgroundColor=n[H]||"var(--color-muted)",W.title=`${H.charAt(0).toUpperCase()}${H.slice(1)}: ${u(g,1)}%`})}function t(){var g;let j=((g=document.getElementById("qualityPreset"))==null?void 0:g.value)||"balanced",H=Array.from(document.querySelectorAll(".quality-focus:checked"));if(j==="none"&&!H.length)return null;let W=j==="none"?{...f}:a[j]?{...a[j]}:{...f};return H.forEach(_=>{let L=_.dataset.attr,I=_.dataset.direction,B=T[L];B&&(W[L]=I==="low"?B[0]:B[1])}),W}function S(){let j=t(),H={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(H).forEach(([W,g])=>{if(!g)return;let _=document.getElementById(`${g.id}Label`);if(!j){g.classList.add("d-none"),_&&(_.textContent="");return}let L=v(j[W]);if(!isFinite(L)){g.classList.add("d-none"),_&&(_.textContent="");return}let I=W==="iodine"?$:W==="ins"?q:100,B=N(L,0,I);g.classList.remove("d-none"),g.style.left=`${B/I*100}%`,g.setAttribute("aria-label",`Apply ${W} target`),g.setAttribute("role","button"),g.setAttribute("tabindex","0"),g.title=`Target ${W}: ${u(L,1)}`,_&&(_.textContent=u(L,1))})}function b(){let j=t();if(!j){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let W=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(G=>{var le,me;let J=e.units.toGrams((le=G.querySelector(".oil-grams"))==null?void 0:le.value),Z=((me=G.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ne=null;if(Z)try{ne=JSON.parse(Z)}catch{ne=null}return{row:G,grams:J,fattyProfile:ne}}).filter(G=>G.grams>0);if(!W.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let g=z(W.map(G=>({grams:G.grams,fattyProfile:G.fattyProfile}))),_=U(g.percent),L={hardness:N((j.hardness-_.hardness)/100,-1,1),cleansing:N((j.cleansing-_.cleansing)/100,-1,1),conditioning:N((j.conditioning-_.conditioning)/100,-1,1),bubbly:N((j.bubbly-_.bubbly)/100,-1,1),creamy:N((j.creamy-_.creamy)/100,-1,1)},I=W.reduce((G,J)=>G+J.grams,0),B=[],M=0,F=.8,D=W.filter(G=>!G.fattyProfile||typeof G.fattyProfile!="object").length;if(D===W.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(D&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),W.forEach(G=>{let J=R(G.fattyProfile),Z=L.hardness*J.hardness+L.cleansing*J.cleansing+L.conditioning*J.conditioning+L.bubbly*J.bubbly+L.creamy*J.creamy,ne=N(1+Z*F,.2,1.8),le=G.grams*ne;B.push({row:G.row,grams:le}),M+=le}),M<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let Q=I/M,K=e.oils.getOilTargetGrams()||I;B.forEach(G=>{let J=G.grams*Q,Z=G.row.querySelector(".oil-grams"),ne=G.row.querySelector(".oil-percent");if(Z&&(Z.value=J>0?u(e.units.fromGrams(J),2):""),ne&&K>0){let le=J/K*100;ne.value=le>0?u(le,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function k(j){let{qualities:H,fattyPercent:W,coveragePct:g,iodine:_,ins:L,sapAvg:I,superfat:B,warnings:M}=j,F=g>0;function D(se,re){var C,V;let ye=document.getElementById(`quality${se}Value`),he=document.getElementById(`quality${se}Hint`);if(!ye)return;ye.textContent=F&&isFinite(re)?u(re,1):"--",d(ye);let i=se.toLowerCase(),Y=T[i],y=h({barId:`quality${se}Bar`,fillId:`quality${se}Fill`,value:F?re:0,max:100,label:se});y&&Y&&(c(y.fill,re,Y),F&&isFinite(re)?y.bar.title=`${se}: ${u(re,1)} (safe ${Y[0]}-${Y[1]}). ${O[i]||""}`.trim():y.bar.title=`${se}: -- (safe ${Y[0]}-${Y[1]}). ${O[i]||""}`.trim()),he&&Y&&(!F||!isFinite(re)?he.textContent="":re<Y[0]?he.textContent=((C=P[i])==null?void 0:C.low)||"":re>Y[1]?he.textContent=((V=P[i])==null?void 0:V.high)||"":he.textContent="")}D("Hardness",H.hardness),D("Cleansing",H.cleansing),D("Conditioning",H.conditioning),D("Bubbly",H.bubbly),D("Creamy",H.creamy);let Q=document.getElementById("fattyCoverageNote");Q&&(Q.textContent=g>0?`Fatty acid coverage: ${u(g,1)}% of oils`:"Fatty acid coverage: not enough data yet");let K=document.getElementById("iodineValue"),G=document.getElementById("insValue"),J=document.getElementById("sapAvgValue");K&&(K.textContent=_>0?u(_,1):"--",d(K)),G&&(G.textContent=L>0?u(L,1):"--",d(G)),J&&(J.textContent=I>0?u(I,1):"--",d(J)),m("iodineBar","iodineFill",_,E,$,"Iodine"),m("insBar","insFill",L,o,q,"INS");let Z=(W.lauric||0)+(W.myristic||0)+(W.palmitic||0)+(W.stearic||0),ne=(W.ricinoleic||0)+(W.oleic||0)+(W.linoleic||0)+(W.linolenic||0),le=document.getElementById("fattySatRatioResult");le&&(le.textContent=Z+ne>0?`${u(Z,0)}:${u(ne,0)}`:"--",d(le)),r.forEach(se=>{let re=`fatty${se.charAt(0).toUpperCase()}${se.slice(1)}`,ye=W[se];document.getElementById(re).textContent=F&&ye?`${u(ye,1)}%`:"--"}),A(H,B||0),p(W),S();let me=Array.isArray(M)?M.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(se=>`<li>${se}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var j;document.querySelectorAll(".soap-quality-help").forEach(H=>{let W=H.dataset.quality;O[W]&&H.setAttribute("title",O[W])}),(j=x.bootstrap)!=null&&j.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(H=>{bootstrap.Tooltip.getOrCreateInstance(H)})}e.quality={setQualityRangeBars:s,updateQualityTargets:S,applyQualityTargets:b,updateQualitiesDisplay:k,initQualityTooltips:w}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v,clamp:N}=e.helpers;function z(o){let q=0,f=0;return(o||[]).forEach(a=>{let n=v(a==null?void 0:a.sapKoh),r=v(a==null?void 0:a.grams);n>0&&r>0&&(q+=n*r,f+=r)}),f>0?q/f:0}function U(o){var h,c,m,s,A,p,t,S,b,k,w,j;let q=o.qualityReport||{},f=q.fatty_acids_pct||{},a=q.qualities||{},n=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:v(q.sap_avg_koh)||z(o.oils||[]),r=v(q.iodine),d=v(q.ins)||(n&&r?n-r:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((h=document.getElementById("qualityPreset"))==null?void 0:h.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(H=>H.id),mold:l,oils:(o.oils||[]).map(H=>({name:H.name||null,grams:u(H.grams||0,2),iodine:H.iodine||null,sap_koh:H.sapKoh||null,fatty_profile:H.fattyProfile||null,global_item_id:H.global_item_id||null,default_unit:H.default_unit||null,ingredient_category_name:H.ingredient_category_name||null})),totals:{total_oils_g:u(o.totalOils||0,2),batch_yield_g:u(o.batchYield||0,2),lye_pure_g:u(o.lyePure||0,2),lye_adjusted_g:u(o.lyeAdjusted||0,2),water_g:u(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((c=o.additives)==null?void 0:c.fragrancePct)||0,lactate_pct:((m=o.additives)==null?void 0:m.lactatePct)||0,sugar_pct:((s=o.additives)==null?void 0:s.sugarPct)||0,salt_pct:((A=o.additives)==null?void 0:A.saltPct)||0,citric_pct:((p=o.additives)==null?void 0:p.citricPct)||0,fragrance_g:u(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:u(((S=o.additives)==null?void 0:S.lactateG)||0,2),sugar_g:u(((b=o.additives)==null?void 0:b.sugarG)||0,2),salt_g:u(((k=o.additives)==null?void 0:k.saltG)||0,2),citric_g:u(((w=o.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:u(((j=o.additives)==null?void 0:j.citricLyeG)||0,2)},qualities:{hardness:u(a.hardness||0,1),cleansing:u(a.cleansing||0,1),conditioning:u(a.conditioning||0,1),bubbly:u(a.bubbly||0,1),creamy:u(a.creamy||0,1),iodine:u(r||0,1),ins:u(d||0,1),sap_avg:u(n||0,1)},fatty_acids:f,updated_at:new Date().toISOString()}}function R(o,q,f,a,n){var c,m,s,A,p;let r=(m=(c=document.getElementById(o))==null?void 0:c.value)==null?void 0:m.trim(),d=((s=document.getElementById(q))==null?void 0:s.value)||"",l=a&&((A=document.getElementById(a))==null?void 0:A.value)||"",h=n&&((p=document.getElementById(n))==null?void 0:p.value)||"";return{name:r||f,globalItemId:d?parseInt(d):void 0,defaultUnit:l||void 0,categoryName:h||void 0}}function T(o){let q=[],f=N(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var A,p,t,S,b,k,w;let n=(p=(A=a.querySelector(".fragrance-typeahead"))==null?void 0:A.value)==null?void 0:p.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((S=a.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",l=((b=a.querySelector(".fragrance-category"))==null?void 0:b.value)||"",h=(k=a.querySelector(".fragrance-grams"))==null?void 0:k.value,c=(w=a.querySelector(".fragrance-percent"))==null?void 0:w.value,m=e.units.toGrams(h),s=N(v(c),0);m<=0&&s>0&&f>0&&(m=f*(s/100)),!(!n&&!r&&m<=0)&&q.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:l||void 0,grams:m,pct:s})}),q}function O(o,q){let f=[];return document.querySelectorAll(`#${o} .row`).forEach(function(a){var c,m,s;let n=(m=(c=a.querySelector(".tool-typeahead"))==null?void 0:c.value)==null?void 0:m.trim(),r=((s=a.querySelector(".tool-gi-id"))==null?void 0:s.value)||"",d=a.querySelector(".tool-qty"),l=a.querySelector(".tool-unit"),h=d&&d.value!=="";!n&&!r||(q==="container"?f.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(d.value):1}):f.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:h?parseFloat(d.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),f}function P(o){let q=e.config.isAuthenticated?"member":"public",f=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:q,mode:f,unitOptionsHtml:e.config.unitOptionsHtml})}function E(o,q){let f=P(o),a=f.querySelector(".tool-typeahead"),n=f.querySelector(".tool-qty");a&&(a.value=q),n&&o==="container"&&(n.value=1),o==="container"?document.getElementById("tool-containers").appendChild(f):o==="consumable"?document.getElementById("tool-consumables").appendChild(f):document.getElementById("tool-ingredients").appendChild(f)}function $(o){var r,d,l,h;let q=U(o),f=(o.oils||[]).map(c=>({name:c.name||void 0,global_item_id:c.global_item_id||void 0,quantity:c.grams,unit:"gram",default_unit:c.default_unit||void 0,ingredient_category_name:c.ingredient_category_name||void 0})),a=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&f.push({name:a,quantity:u(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&f.push({name:"Distilled Water",quantity:u(o.water,2),unit:"gram"}),T(o.totalOils||0).forEach(c=>{c.grams>0&&f.push({name:c.name,global_item_id:c.globalItemId,quantity:u(c.grams,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let c=R("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:u(o.additives.lactateG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((d=o.additives)==null?void 0:d.sugarG)>0){let c=R("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:u(o.additives.sugarG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((l=o.additives)==null?void 0:l.saltG)>0){let c=R("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:u(o.additives.saltG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName})}if(((h=o.additives)==null?void 0:h.citricG)>0){let c=R("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");f.push({name:c.name,global_item_id:c.globalItemId,quantity:u(o.additives.citricG,2),unit:"gram",default_unit:c.defaultUnit,ingredient_category_name:c.categoryName}),f.push({name:"Extra Lye for Citric Acid",quantity:u(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:f.concat(O("tool-ingredients","ingredient")),consumables:O("tool-consumables","consumable"),containers:O("tool-containers","container"),notes:JSON.stringify(q)}}e.recipePayload={collectFragranceRows:T,collectDraftLines:O,buildLineRow:P,addStubLine:E,buildSoapRecipePayload:$}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v,clamp:N}=e.helpers,{formatWeight:z,formatPercent:U}=e.units;function R(){var h;let a=((h=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:h.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,d=v(n==null?void 0:n.value),l=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:l,purity:d}}function T(){let a=document.getElementById("lyePurity"),n=R();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function O(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function P(a=null,n=null){var h;let r=document.getElementById("stageWaterOutput"),d=document.getElementById("stageWaterComputedHint"),l=n||(a==null?void 0:a.waterMethod)||((h=document.getElementById("waterMethod"))==null?void 0:h.value)||"percent";if(r){let c=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=c?z(a.waterG):"--"}if(d){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){d.textContent=`Set oils in Stage 2 to calculate water. ${O(l)}`;return}if(l==="concentration"){let c=a.lyeConcentrationInput||a.lyeConcentration||0;d.textContent=`Using ${u(c,1)}% lye concentration from ${z(a.lyeAdjusted||0)} lye.`;return}if(l==="ratio"){let c=a.waterRatioInput||a.waterRatio||0;d.textContent=`Using ${u(c,2)} : 1 water-to-lye ratio from ${z(a.lyeAdjusted||0)} lye.`;return}d.textContent=`Using ${u(a.waterPct||0,1)}% of total oils (${z(a.totalOils)}).`}}function E(a=null,n=null){var k;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),h=document.getElementById("concPreview"),c=document.getElementById("ratioPreview");if(!r&&!d&&!l&&!h&&!c)return;let m=(w,j)=>{w&&(w.textContent=j)},s=n||(a==null?void 0:a.waterMethod)||((k=document.getElementById("waterMethod"))==null?void 0:k.value)||"percent",A=v(a==null?void 0:a.totalOils),p=v(a==null?void 0:a.lyeAdjusted),t=v(a==null?void 0:a.waterG);if(A<=0||p<=0){m(r,"Based on -- oils. All values update live as you change inputs."),m(d,"--"),m(l,"--"),m(h,"--"),m(c,"--");return}let S=v(a==null?void 0:a.lyeConcentration)>0?v(a==null?void 0:a.lyeConcentration):p+t>0?p/(p+t)*100:0,b=v(a==null?void 0:a.waterRatio)>0?v(a==null?void 0:a.waterRatio):p>0?t/p:0;if(m(r,`Based on ${z(A)} oils. All values update live as you change inputs.`),m(d,z(p)),m(l,z(t)),m(h,S>0?U(S):"--"),m(c,b>0?`${u(b,2)} : 1`:"--"),s==="concentration"){let w=v(a==null?void 0:a.lyeConcentrationInput);w>0&&m(h,U(w))}if(s==="ratio"){let w=v(a==null?void 0:a.waterRatioInput);w>0&&m(c,`${u(w,2)} : 1`)}}function $(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),P(null,a),E(null,a)}function o(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,d=[],l=e.oils.collectOilData(),h=e.oils.getOilTargetGrams(),m=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(s=>N(v(s.value),0)).some(s=>s>0);return(!l.length||n<=0)&&d.push("Add at least one oil with a weight or percent."),!h&&n<=0&&m&&d.push("Enter a total oils target or weights to convert percentages."),h>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),h>0&&n>h+.01?d.push("Oil weights exceed the mold target."):!h&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:l}}function q(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=v(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function f(){var c,m,s,A;let n=R().purity;isFinite(n)||(n=100);let r=((c=document.getElementById("waterMethod"))==null?void 0:c.value)||"percent",d=v((m=document.getElementById("waterPct"))==null?void 0:m.value),l=v((s=document.getElementById("lyeConcentration"))==null?void 0:s.value),h=v((A=document.getElementById("waterRatio"))==null?void 0:A.value);return{purity:n,waterMethod:r,waterPct:d,lyeConcentration:l,waterRatio:h}}e.runnerInputs={getLyeSelection:R,applyLyeSelection:T,setWaterMethod:$,updateStageWaterSummary:P,updateLiveCalculationPreview:E,validateCalculation:o,readSuperfatInput:q,sanitizeLyeInputs:f}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{getStorage:u}=e.helpers;function v(){if(!e.config.calcLimit)return{count:0,date:null};let T=u();if(!T)return{count:0,date:null};try{let O=T.getItem("soap_calc_usage"),P=new Date().toISOString().slice(0,10);if(!O)return{count:0,date:P};let E=JSON.parse(O);return!E||E.date!==P?{count:0,date:P}:{count:Number(E.count)||0,date:P}}catch{return{count:0,date:null}}}function N(T){if(!e.config.calcLimit)return;let O=u();if(!O)return;let P=new Date().toISOString().slice(0,10);try{O.setItem("soap_calc_usage",JSON.stringify({count:T,date:P}))}catch{}}function z(){return e.config.calcLimit&&v().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function U(){if(!e.config.calcLimit)return;let O=v().count+1;N(O);let P=Math.max(0,e.config.calcLimit-O);P<=1&&e.ui.showSoapAlert("info",`You have ${P} calculation${P===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function R(T){if(!e.config.calcLimit||T===null||T>1)return;let O=document.getElementById("soapSignupModal");O&&(x.bootstrap&&x.bootstrap.Modal?x.bootstrap.Modal.getOrCreateInstance(O).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:z,consumeCalcQuota:U,maybeShowSignupModal:R}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.state;function v({oils:z,selection:U,superfat:R,purity:T,waterMethod:O,waterPct:P,lyeConcentration:E,waterRatio:$,totalOils:o}){let q=e.additives.collectAdditiveSettings(),f=e.recipePayload.collectFragranceRows(o||0);return{oils:(z||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:f.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:q.lactatePct||0,sugar_pct:q.sugarPct||0,salt_pct:q.saltPct||0,citric_pct:q.citricPct||0,lactate_name:q.lactateName||"Sodium Lactate",sugar_name:q.sugarName||"Sugar",salt_name:q.saltName||"Salt",citric_name:q.citricName||"Citric Acid"},lye:{selected:(U==null?void 0:U.selected)||"NaOH",superfat:R,purity:T},water:{method:O,water_pct:P,lye_concentration:E,water_ratio:$},meta:{unit_display:u.currentUnit||"g"}}}async function N(z){var O;let U=((O=document.querySelector('meta[name="csrf-token"]'))==null?void 0:O.getAttribute("content"))||"",R=new AbortController,T=x.setTimeout(()=>R.abort(),2500);try{let P=await fetch("/tools/api/soap/calculate",{method:"POST",signal:R.signal,headers:{"Content-Type":"application/json",...U?{"X-CSRFToken":U}:{}},body:JSON.stringify(z||{})});if(!P.ok)return null;let E=await P.json();return!E||E.success!==!0||typeof E.result!="object"?null:E.result}catch{return null}finally{x.clearTimeout(T)}}e.runnerService={buildServicePayload:v,calculateWithSoapService:N}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{round:u,toNumber:v}=e.helpers,{formatWeight:N,formatPercent:z}=e.units,U=e.state,R={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function T(o){return(o||[]).map(q=>{var f;return{name:q.name||null,grams:v(q.grams),sapKoh:v((f=q.sap_koh)!=null?f:q.sapKoh),iodine:v(q.iodine),fattyProfile:q.fatty_profile||q.fattyProfile||null,global_item_id:q.global_item_id||null,default_unit:q.default_unit||null,ingredient_category_name:q.ingredient_category_name||null}})}function O(o,q){let f=document.getElementById(o);f&&(f.textContent=q)}function P({resultsCard:o,lyeAdjusted:q,waterData:f,batchYield:a,totalOils:n,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let l=v(o.water_lye_ratio)||f.waterRatio;O("lyeAdjustedOutput",N(v(o.lye_adjusted_g)||q)),O("waterOutput",N(v(o.water_g)||f.waterG)),O("batchYieldOutput",N(a)),O("lyeConcentrationOutput",z(v(o.lye_concentration_pct)||f.lyeConcentration)),O("waterRatioOutput",isFinite(l)&&l>0?u(l,2).toString():"--"),O("totalOilsOutput",N(n)),O("superfatOutput",z(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(h=>e.ui.pulseValue(document.getElementById(h)))}function E({showAlerts:o,lyeTotals:q,purity:f,waterData:a}){if(!o)return;q.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),f<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${u(f,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function $({serviceResult:o,validation:q,selection:f,superfat:a,purity:n,waterMethod:r,waterPct:d,lyeConcentrationInput:l,waterRatioInput:h,showAlerts:c}){var Q;let m=o.lye_type||f.lyeType||"NaOH",s=v(o.total_oils_g)||q.totals.totalWeight,A=v(o.superfat_pct),p=isFinite(A)?A:a,t={sapAvg:v(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},S=v(o.lye_pure_g),b=v(o.lye_adjusted_base_g),k=v(o.lye_adjusted_g),w=v(o.lye_purity_pct)||n,j=o.water_method||r,H=v(o.water_pct)||d,W=v(o.lye_concentration_input_pct)||l,g=v(o.water_ratio_input)||h,_={waterG:v(o.water_g),lyeConcentration:v(o.lye_concentration_pct),waterRatio:v(o.water_lye_ratio)},L=o.results_card||{},I=o.quality_report||{},B=T(o.oils||q.oils),M={waterG:_.waterG,lyeAdjusted:k,totalOils:s,waterMethod:j,waterPct:H,lyeConcentrationInput:W,waterRatioInput:g,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio};e.runnerInputs.updateStageWaterSummary(M),e.runnerInputs.updateLiveCalculationPreview(M);let F=o.additives||R;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(F);let D=v(L.batch_yield_g)||s+k+_.waterG+F.fragranceG+F.lactateG+F.sugarG+F.saltG+F.citricG;return(Q=e.mold)!=null&&Q.updateWetBatterWarning&&e.mold.updateWetBatterWarning(D),P({resultsCard:L,lyeAdjusted:k,waterData:_,batchYield:D,totalOils:s,superfat:p}),e.ui.updateResultsWarnings(_),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:I.qualities||{},fattyPercent:I.fatty_acids_pct||{},coveragePct:v(I.coverage_pct),iodine:v(I.iodine),ins:v(I.ins),sapAvg:t.sapAvg,superfat:p,waterData:_,additives:F,oils:B,totalOils:s,warnings:I.warnings||[]}),e.additives.updateVisualGuidance({tips:I.visual_guidance||[]}),e.stages.updateStageStatuses(),E({showAlerts:c,lyeTotals:t,purity:w,waterData:_}),U.lastCalc={totalOils:s,oils:B,lyeType:m,superfat:p,purity:w,lyePure:S,lyeAdjustedBase:isFinite(b)?b:null,lyeAdjusted:k,water:_.waterG,waterMethod:j,waterPct:H,lyeConcentration:_.lyeConcentration,waterRatio:_.waterRatio,sapAvg:t.sapAvg,usedSapFallback:t.usedFallback,additives:F,batchYield:D,qualityReport:I,export:o.export||null},U.lastCalc}e.runnerRender={applyServiceResult:$}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},u=e.state,v=e.runnerInputs,N=e.runnerQuota,z=e.runnerService,U=e.runnerRender;async function R(T={}){var P;let O={consumeQuota:!1,showAlerts:!0,...T};try{O.showAlerts&&e.ui.clearSoapAlerts();let E=v.validateCalculation();if(!E.ok)return v.updateStageWaterSummary(null),v.updateLiveCalculationPreview(null),(P=e.mold)!=null&&P.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),O.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${E.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(O.consumeQuota&&!N.canConsumeCalcQuota())return null;let $=v.readSuperfatInput(),o=v.getLyeSelection(),q=v.sanitizeLyeInputs(),f=(u.calcRequestSeq||0)+1;u.calcRequestSeq=f;let a=z.buildServicePayload({oils:E.oils,selection:o,superfat:$,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentration:q.lyeConcentration,waterRatio:q.waterRatio,totalOils:E.totals.totalWeight}),n=await z.calculateWithSoapService(a);if(f!==u.calcRequestSeq)return u.lastCalc;if(!n)return O.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=U.applyServiceResult({serviceResult:n,validation:E,selection:o,superfat:$,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentrationInput:q.lyeConcentration,waterRatioInput:q.waterRatio,showAlerts:O.showAlerts});return O.consumeQuota&&N.consumeCalcQuota(),r}catch{return O.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...T)=>v.getLyeSelection(...T),applyLyeSelection:(...T)=>v.applyLyeSelection(...T),setWaterMethod:(...T)=>v.setWaterMethod(...T),updateLiveCalculationPreview:(...T)=>v.updateLiveCalculationPreview(...T),calculateAll:R,buildSoapRecipePayload:(...T)=>e.recipePayload.buildSoapRecipePayload(...T),buildLineRow:(...T)=>e.recipePayload.buildLineRow(...T),addStubLine:(...T)=>e.recipePayload.addStubLine(...T),maybeShowSignupModal:(...T)=>N.maybeShowSignupModal(...T)}})(window);(function(x){"use strict";let e=x.SoapTool=x.SoapTool||{},{formatTime:u,getStorage:v}=e.helpers,N="soap_tool_state_v2";function z(f,a){let n=[];return document.querySelectorAll(`#${f} .row`).forEach(d=>{var A,p,t;let l=(p=(A=d.querySelector(".tool-typeahead"))==null?void 0:A.value)==null?void 0:p.trim(),h=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",c=d.querySelector(".tool-qty"),m=d.querySelector(".tool-unit"),s=c&&c.value!==""?e.helpers.toNumber(c.value):null;!l&&!h||(a==="container"?n.push({name:l||"",global_item_id:h?parseInt(h):null,quantity:s&&s>0?s:1}):n.push({name:l||"",global_item_id:h?parseInt(h):null,quantity:s&&s>=0?s:0,unit:(m==null?void 0:m.value)||"gram"}))}),n}function U(){let f=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var p,t,S,b,k,w,j,H,W,g;let n=((t=(p=a.querySelector(".oil-typeahead"))==null?void 0:p.value)==null?void 0:t.trim())||"",r=((S=a.querySelector(".oil-grams"))==null?void 0:S.value)||"",d=((b=a.querySelector(".oil-percent"))==null?void 0:b.value)||"",l=((k=a.querySelector(".oil-sap-koh"))==null?void 0:k.value)||"",h=((w=a.querySelector(".oil-iodine"))==null?void 0:w.value)||"",c=((j=a.querySelector(".oil-fatty"))==null?void 0:j.value)||"",m=((H=a.querySelector(".oil-gi-id"))==null?void 0:H.value)||"",s=((W=a.querySelector(".oil-default-unit"))==null?void 0:W.value)||"",A=((g=a.querySelector(".oil-category"))==null?void 0:g.value)||"";!n&&!r&&!d&&!m||f.push({name:n,grams:r,percent:d,sap:l,iodine:h,fattyRaw:c,gi:m,defaultUnit:s,categoryName:A})}),f}function R(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let f=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var s,A,p,t,S,b,k;let r=((A=(s=n.querySelector(".fragrance-typeahead"))==null?void 0:s.value)==null?void 0:A.trim())||"",d=((p=n.querySelector(".fragrance-grams"))==null?void 0:p.value)||"",l=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",h=((S=n.querySelector(".fragrance-gi-id"))==null?void 0:S.value)||"",c=((b=n.querySelector(".fragrance-default-unit"))==null?void 0:b.value)||"",m=((k=n.querySelector(".fragrance-category"))==null?void 0:k.value)||"";!r&&!d&&!l&&!h||f.push({name:r,grams:d,percent:l,gi:h,defaultUnit:c,categoryName:m})}),f}function T(f,a){let n=document.getElementById("oilRows");if(!n||!f)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=f.name||"",r.querySelector(".oil-grams").value=f.grams||"",r.querySelector(".oil-percent").value=f.percent||"",r.querySelector(".oil-sap-koh").value=f.sap||"",r.querySelector(".oil-iodine").value=f.iodine||"",r.querySelector(".oil-fatty").value=f.fattyRaw||"",r.querySelector(".oil-gi-id").value=f.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=f.defaultUnit||"");let l=r.querySelector(".oil-category");l&&(l.value=f.categoryName||"");let h=Array.from(n.children);return a>=h.length?n.appendChild(r):n.insertBefore(r,h[a]),r}function O(){var n,r,d,l,h,c,m,s,A,p,t,S,b,k,w,j,H,W,g,_,L,I,B,M,F,D,Q;let f=v();if(!f)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:U(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((h=document.getElementById("waterPct"))==null?void 0:h.value)||"",lye_concentration:((c=document.getElementById("lyeConcentration"))==null?void 0:c.value)||"",water_ratio:((m=document.getElementById("waterRatio"))==null?void 0:m.value)||""},additives:{fragrances:R(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((s=document.getElementById("additiveLactateName"))==null?void 0:s.value)||"",lactate_gi:((A=document.getElementById("additiveLactateGi"))==null?void 0:A.value)||"",lactate_unit:((p=document.getElementById("additiveLactateUnit"))==null?void 0:p.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((S=document.getElementById("additiveSugarName"))==null?void 0:S.value)||"",sugar_gi:((b=document.getElementById("additiveSugarGi"))==null?void 0:b.value)||"",sugar_unit:((k=document.getElementById("additiveSugarUnit"))==null?void 0:k.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((j=document.getElementById("additiveSaltName"))==null?void 0:j.value)||"",salt_gi:((H=document.getElementById("additiveSaltGi"))==null?void 0:H.value)||"",salt_unit:((W=document.getElementById("additiveSaltUnit"))==null?void 0:W.value)||"",salt_category:((g=document.getElementById("additiveSaltCategory"))==null?void 0:g.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((_=document.getElementById("additiveCitricName"))==null?void 0:_.value)||"",citric_gi:((L=document.getElementById("additiveCitricGi"))==null?void 0:L.value)||"",citric_unit:((I=document.getElementById("additiveCitricUnit"))==null?void 0:I.value)||"",citric_category:((B=document.getElementById("additiveCitricCategory"))==null?void 0:B.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((M=document.getElementById("moldShape"))==null?void 0:M.value)||"loaf",cylinder_correction:!!((F=document.getElementById("moldCylinderCorrection"))!=null&&F.checked),cylinder_factor:((D=document.getElementById("moldCylinderFactor"))==null?void 0:D.value)||"0.85"},quality:{preset:((Q=document.getElementById("qualityPreset"))==null?void 0:Q.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(K=>K.id)},lines:{ingredients:z("tool-ingredients","ingredient"),consumables:z("tool-consumables","consumable"),containers:z("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"basics",selections:[]},updated_at:Date.now()};try{f.setItem(N,JSON.stringify(a));let K=document.getElementById("soapLastSaved");K&&(K.textContent=u(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function P(){var l,h,c;let f=v();if(!f)return;let a=f.getItem(N);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let m=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);m&&(m.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(s=>{let A=e.oils.buildOilRow();A.querySelector(".oil-typeahead").value=s.name||"",A.querySelector(".oil-grams").value=s.grams||"",A.querySelector(".oil-percent").value=s.percent||"",A.querySelector(".oil-sap-koh").value=s.sap||"",A.querySelector(".oil-iodine").value=s.iodine||"",A.querySelector(".oil-fatty").value=s.fattyRaw||"",A.querySelector(".oil-gi-id").value=s.gi||"";let p=A.querySelector(".oil-default-unit");p&&(p.value=s.defaultUnit||"");let t=A.querySelector(".oil-category");t&&(t.value=s.categoryName||""),r.appendChild(A)})),n.lye_form){let m=document.getElementById("lyeSuperfat");m&&(m.value=n.lye_form.superfat||"5");let s=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);s&&(s.checked=!0);let A=document.getElementById("lyePurity");A&&(A.value=n.lye_form.lye_purity||"100");let p=document.getElementById("waterMethod");p&&(p.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let S=document.getElementById("lyeConcentration");S&&(S.value=n.lye_form.lye_concentration||"");let b=document.getElementById("waterRatio");b&&(b.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let m=document.getElementById("fragranceRows");if(m&&((l=e.fragrances)!=null&&l.buildFragranceRow)){m.innerHTML="";let M=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(M)M.forEach(F=>{let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=F.name||"",D.querySelector(".fragrance-grams").value=F.grams||"",D.querySelector(".fragrance-percent").value=F.percent||"",D.querySelector(".fragrance-gi-id").value=F.gi||"";let Q=D.querySelector(".fragrance-default-unit");Q&&(Q.value=F.defaultUnit||"");let K=D.querySelector(".fragrance-category");K&&(K.value=F.categoryName||""),m.appendChild(D)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let F=e.fragrances.buildFragranceRow();F.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",F.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",F.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",m.appendChild(F)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let s=document.getElementById("additiveLactateName");s&&(s.value=n.additives.lactate_name||"");let A=document.getElementById("additiveLactateGi");A&&(A.value=n.additives.lactate_gi||"");let p=document.getElementById("additiveLactateUnit");p&&(p.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let S=document.getElementById("additiveSugarName");S&&(S.value=n.additives.sugar_name||"");let b=document.getElementById("additiveSugarGi");b&&(b.value=n.additives.sugar_gi||"");let k=document.getElementById("additiveSugarUnit");k&&(k.value=n.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let j=document.getElementById("additiveSaltName");j&&(j.value=n.additives.salt_name||"");let H=document.getElementById("additiveSaltGi");H&&(H.value=n.additives.salt_gi||"");let W=document.getElementById("additiveSaltUnit");W&&(W.value=n.additives.salt_unit||"");let g=document.getElementById("additiveSaltCategory");g&&(g.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let _=document.getElementById("additiveCitricName");_&&(_.value=n.additives.citric_name||"");let L=document.getElementById("additiveCitricGi");L&&(L.value=n.additives.citric_gi||"");let I=document.getElementById("additiveCitricUnit");I&&(I.value=n.additives.citric_unit||"");let B=document.getElementById("additiveCitricCategory");B&&(B.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let m=document.getElementById("moldShape");m&&(m.value=n.mold.shape||"loaf");let s=document.getElementById("moldCylinderCorrection");s&&(s.checked=!!n.mold.cylinder_correction);let A=document.getElementById("moldCylinderFactor");A&&(A.value=n.mold.cylinder_factor||"0.85");let p=document.getElementById("oilTotalTarget");(h=e.mold)!=null&&h.syncMoldPctFromTarget&&((c=e.mold)!=null&&c.syncTargetFromMold)&&(e.units.toGrams(p==null?void 0:p.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let m=document.getElementById("qualityPreset");if(m){let s=n.quality.preset||"balanced",A=Array.from(m.options).find(p=>p.value===s);m.value=A?s:"balanced"}document.querySelectorAll(".quality-focus").forEach(s=>{s.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(s.id)})}function d(m,s,A){let p=document.getElementById(m);p&&(p.innerHTML="",(s||[]).forEach(t=>{let S=e.runner.buildLineRow(A),b=S.querySelector(".tool-typeahead"),k=S.querySelector(".tool-gi-id"),w=S.querySelector(".tool-qty"),j=S.querySelector(".tool-unit");b&&(b.value=t.name||""),k&&(k.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),j&&t.unit&&Array.from(j.options).find(W=>W.value===t.unit)&&(j.value=t.unit),p.appendChild(S)}))}if(n.lines&&(d("tool-ingredients",n.lines.ingredients,"ingredient"),d("tool-consumables",n.lines.consumables,"consumable"),d("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let m=document.getElementById("soapLastSaved");m&&(m.textContent=u(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let E=null;function $(){E&&clearTimeout(E),E=setTimeout(O,350)}let o=null;function q(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:O,restoreState:P,serializeLines:z,serializeOils:U,restoreOilRow:T,queueStateSave:$,queueAutoCalc:q}})(window);(function(x){"use strict";var ye,he;let e=x.SoapTool=x.SoapTool||{},{LACTATE_CATEGORY_SET:u,SUGAR_CATEGORY_SET:v,SALT_CATEGORY_SET:N,CITRIC_CATEGORY_SET:z}=e.constants,{round:U,toNumber:R,clamp:T}=e.helpers,{formatWeight:O,formatPercent:P,toGrams:E}=e.units,$=e.state;async function o(){var Y;let i=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return i||((Y=e.ui)!=null&&Y.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function q(i){let Y=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(y=>{var ce,ie,te,ue;let C=(ie=(ce=y.querySelector(".fragrance-typeahead"))==null?void 0:ce.value)==null?void 0:ie.trim(),V=(te=y.querySelector(".fragrance-grams"))==null?void 0:te.value,X=(ue=y.querySelector(".fragrance-percent"))==null?void 0:ue.value,ee=E(V),ae=T(R(X),0);ee<=0&&ae>0&&i>0&&(ee=i*(ae/100)),!(ee<=0&&ae<=0&&!C)&&(!ae&&ee>0&&i>0&&(ae=ee/i*100),Y.push({name:C||"Fragrance/Essential Oils",grams:ee,pct:ae}))}),Y}function f(i){var ee,ae,ce,ie,te,ue,pe,ve;let Y=[];if(!i)return Y;let y=((ae=(ee=document.getElementById("additiveLactateName"))==null?void 0:ee.value)==null?void 0:ae.trim())||"Sodium Lactate",C=((ie=(ce=document.getElementById("additiveSugarName"))==null?void 0:ce.value)==null?void 0:ie.trim())||"Sugar",V=((ue=(te=document.getElementById("additiveSaltName"))==null?void 0:te.value)==null?void 0:ue.trim())||"Salt",X=((ve=(pe=document.getElementById("additiveCitricName"))==null?void 0:pe.value)==null?void 0:ve.trim())||"Citric Acid";return i.lactateG>0&&Y.push({name:y,grams:i.lactateG,pct:i.lactatePct}),i.sugarG>0&&Y.push({name:C,grams:i.sugarG,pct:i.sugarPct}),i.saltG>0&&Y.push({name:V,grams:i.saltG,pct:i.saltPct}),i.citricG>0&&Y.push({name:X,grams:i.citricG,pct:i.citricPct}),Y}function a(i){var ce,ie;if(Array.isArray((ce=i==null?void 0:i.export)==null?void 0:ce.csv_rows)&&i.export.csv_rows.length)return i.export.csv_rows;let Y=i.totalOils||0,y=[["section","name","quantity","unit","percent"]];y.push(["Summary","Lye Type",i.lyeType||"","",""]),y.push(["Summary","Superfat",U(i.superfat||0,2),"%",""]),y.push(["Summary","Lye Purity",U(i.purity||0,1),"%",""]),y.push(["Summary","Water Method",i.waterMethod||"","",""]),y.push(["Summary","Water %",U(i.waterPct||0,1),"%",""]),y.push(["Summary","Lye Concentration",U(i.lyeConcentration||0,1),"%",""]),y.push(["Summary","Water Ratio",U(i.waterRatio||0,2),"",""]),y.push(["Summary","Total Oils",U(Y,2),"gram",""]),y.push(["Summary","Batch Yield",U(i.batchYield||0,2),"gram",""]),(i.oils||[]).forEach(te=>{let ue=Y>0?U(te.grams/Y*100,2):"";y.push(["Oils",te.name||"Oil",U(te.grams||0,2),"gram",ue])});let C=R((ie=i.additives)==null?void 0:ie.citricLyeG),X=i.lyeAdjustedBase!==null&&i.lyeAdjustedBase!==void 0&&i.lyeAdjustedBase!==""?R(i.lyeAdjustedBase)+C:R(i.lyeAdjusted);if(X>0){let te=i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";C>0&&(te+="*"),y.push(["Lye",te,U(X,2),"gram",""])}return i.water>0&&y.push(["Water","Distilled Water",U(i.water,2),"gram",""]),q(Y).forEach(te=>{y.push(["Fragrance",te.name,U(te.grams||0,2),"gram",U(te.pct||0,2)])}),f(i.additives).forEach(te=>{y.push(["Additives",te.name,U(te.grams||0,2),"gram",U(te.pct||0,2)])}),C>0&&y.push(["Notes",`* ${O(C)} lye added extra to accommodate the extra citrus.`,"","",""]),y}function n(i){if(i==null)return"";let Y=String(i);return/[",\n]/.test(Y)?`"${Y.replace(/"/g,'""')}"`:Y}function r(i){return i.map(Y=>Y.map(n).join(",")).join(`
`)}function d(i,Y){let y=new Blob([i],{type:"text/csv;charset=utf-8;"}),C=URL.createObjectURL(y),V=document.createElement("a");V.href=C,V.download=Y,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(C)}function l(i){var be,_e;if(typeof((be=i==null?void 0:i.export)==null?void 0:be.sheet_html)=="string"&&i.export.sheet_html.trim())return i.export.sheet_html;let Y=i.totalOils||0,y=(i.oils||[]).map(de=>({name:de.name||"Oil",grams:de.grams||0,pct:Y>0?de.grams/Y*100:0})),C=q(Y),V=f(i.additives),X=new Date().toLocaleString(),ee=y.length?y.map(de=>`
          <tr>
            <td>${de.name}</td>
            <td class="text-end">${O(de.grams)}</td>
            <td class="text-end">${P(de.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',ae=C.length?C.map(de=>`
          <tr>
            <td>${de.name}</td>
            <td class="text-end">${O(de.grams)}</td>
            <td class="text-end">${P(de.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',ce=V.length?V.map(de=>`
          <tr>
            <td>${de.name}</td>
            <td class="text-end">${O(de.grams)}</td>
            <td class="text-end">${P(de.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',ie=R((_e=i.additives)==null?void 0:_e.citricLyeG),ue=i.lyeAdjustedBase!==null&&i.lyeAdjustedBase!==void 0&&i.lyeAdjustedBase!==""?R(i.lyeAdjustedBase)+ie:R(i.lyeAdjusted),pe=`${i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${ie>0?"*":""}`,ve=`${O(ue)}${ie>0?"*":""}`,Se=ie>0?`<div class="footnote">* ${O(ie)} lye added extra to accommodate the extra citrus.</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${X}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${i.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${P(i.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${P(i.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${O(Y)}</span></div>
      <div class="summary-item"><span>Water</span><span>${O(i.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${O(i.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${i.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${P(i.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ee}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${pe}</td><td class="text-end">${ve}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${O(i.water||0)}</td></tr>
      </tbody>
    </table>
    ${Se}

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ae}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ce}</tbody>
    </table>
  </body>
</html>`}let h=document.getElementById("oilRows"),c=document.getElementById("addOil"),m=document.getElementById("normalizeOils");c&&h&&(c.dataset.bound="direct",c.addEventListener("click",function(){h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),m&&(m.dataset.bound="direct",m.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),h&&h.addEventListener("input",function(i){i.target.classList.contains("oil-grams")&&($.lastOilEdit={row:i.target.closest(".oil-row"),field:"grams"}),i.target.classList.contains("oil-percent")&&($.lastOilEdit={row:i.target.closest(".oil-row"),field:"percent"}),(i.target.classList.contains("oil-grams")||i.target.classList.contains("oil-percent")||i.target.classList.contains("oil-typeahead"))&&(i.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(i.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),h&&h.addEventListener("focusin",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(i.target.closest(".oil-row"))}),h&&h.addEventListener("focusout",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),i.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(i.target.closest(".oil-row"),"grams"),i.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(i.target.closest(".oil-row"),"percent")}),h&&h.addEventListener("keydown",function(i){i.key==="Enter"&&(i.target.classList.contains("oil-grams")&&(i.preventDefault(),e.oils.validateOilEntry(i.target.closest(".oil-row"),"grams")),i.target.classList.contains("oil-percent")&&(i.preventDefault(),e.oils.validateOilEntry(i.target.closest(".oil-row"),"percent")))}),h&&h.addEventListener("mouseover",function(i){if(!i.target.classList.contains("oil-typeahead"))return;let Y=i.target.closest(".oil-row");!Y||Y===$.lastPreviewRow||($.lastPreviewRow=Y,e.oils.setSelectedOilProfileFromRow(Y))}),h&&h.addEventListener("mouseout",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),h&&h.addEventListener("click",function(i){let Y=i.target.closest(".oil-profile-open");if(Y){let C=Y.closest(".oil-row");if(C){e.oils.setSelectedOilProfileFromRow(C);let V=document.getElementById("oilProfileModal");V&&x.bootstrap&&bootstrap.Modal.getOrCreateInstance(V).show()}return}let y=i.target.closest(".remove-oil");if(y){let C=y.closest(".oil-row");C&&($.lastRemovedOil=e.oils.serializeOilRow(C),$.lastRemovedOilIndex=Array.from(C.parentElement.children).indexOf(C),e.ui.showUndoToast("Oil removed.")),C&&$.lastOilEdit&&$.lastOilEdit.row===C&&($.lastOilEdit=null,e.oils.clearSelectedOilProfile()),C&&C.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let s=document.getElementById("fragranceRows"),A=document.getElementById("addFragrance");A&&s&&(A.dataset.bound="direct",A.addEventListener("click",function(){s.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),s&&(s.addEventListener("input",function(i){i.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:i.target.closest(".fragrance-row"),field:"grams"}),i.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:i.target.closest(".fragrance-row"),field:"percent"}),(i.target.classList.contains("fragrance-grams")||i.target.classList.contains("fragrance-percent")||i.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),s.addEventListener("click",function(i){let Y=i.target.closest(".remove-fragrance");if(!Y)return;let y=Y.closest(".fragrance-row");y&&y.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let p=document.getElementById("soapStageTabContent"),t=()=>{if(!p)return null;let i=p.querySelector(".tab-pane.active")||p.querySelector(".tab-pane.show.active");return i?i.querySelector(".soap-stage-body")||i:null},S=()=>{p&&p.addEventListener("wheel",i=>{let Y=i.target;if(!(Y instanceof HTMLElement))return;let y=Y.closest('input[type="number"]');if(!(y instanceof HTMLInputElement))return;let C=t();if(!(C instanceof HTMLElement)||C.scrollHeight<=C.clientHeight+1)return;document.activeElement===y&&typeof y.blur=="function"&&y.blur();let V=C.scrollTop<=0,X=C.scrollTop+C.clientHeight>=C.scrollHeight-1;i.deltaY<0&&V||i.deltaY>0&&X||(C.scrollTop+=i.deltaY,i.preventDefault())},{passive:!1})};p&&(p.addEventListener("click",i=>{let Y=i.target.closest("[data-stage-action]"),y=i.target.closest("[data-soap-action]");if(!Y&&!y)return;if(i.preventDefault(),i.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),y){if(y.dataset.bound==="direct")return;let X=y.dataset.soapAction;X==="add-oil"&&h&&(h.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),X==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),X==="add-fragrance"&&s&&(s.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let C=Y.dataset.stageAction,V=Number(Y.dataset.stageIndex);Number.isNaN(V)||(C==="prev"&&e.stages.openStageByIndex(Math.max(0,V-1)),C==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,V+1)),C==="reset"&&e.stages.resetStage(V+1))}),S());let b=document.getElementById("soapStageTabList"),k=()=>{if(!b)return;b.querySelectorAll(".nav-item").forEach(Y=>Y.classList.remove("is-expanded"));let i=b.querySelector(".nav-link.active");i&&i.closest(".nav-item")&&i.closest(".nav-item").classList.add("is-expanded")};b&&(b.addEventListener("shown.bs.tab",()=>{k(),e.layout.scheduleStageHeightSync()}),k());let w=document.getElementById("resultsCardToggle"),j=document.getElementById("resultsCard");w&&j&&w.addEventListener("click",()=>{j.classList.toggle("is-collapsed");let i=j.classList.contains("is-collapsed");w.setAttribute("aria-expanded",(!i).toString());let Y=i?"Expand formula details":"Collapse formula details";w.setAttribute("aria-label",Y),w.setAttribute("title",Y);let y=w.querySelector("i");y&&(y.classList.toggle("fa-chevron-down",i),y.classList.toggle("fa-chevron-up",!i))}),document.querySelectorAll('input[name="weight_unit"]').forEach(i=>{i.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let H=()=>{var i;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(i=e.mold)!=null&&i.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},W=document.getElementById("oilTotalTarget");W&&W.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let g=document.getElementById("waterMethod");g&&g.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(i=>{i.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(i=>{let Y=document.getElementById(i);Y&&["input","change"].forEach(y=>{Y.addEventListener(y,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].forEach(i=>{let Y=document.getElementById(i);Y&&Y.addEventListener("input",()=>{e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),[{weightId:"additiveLactateWeight"},{weightId:"additiveSugarWeight"},{weightId:"additiveSaltWeight"},{weightId:"additiveCitricWeight"}].forEach(({weightId:i})=>{let Y=document.getElementById(i);Y&&Y.addEventListener("input",()=>{let y=e.oils.getTotalOilsGrams();y&&(e.additives.updateAdditivesOutput(y),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}),document.querySelectorAll(".additive-typeahead").forEach(i=>{i.addEventListener("input",()=>{e.storage.queueStateSave()})});let L=document.getElementById("qualityPreset");L&&L.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(i=>{i.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let I=document.getElementById("applyQualityTargets");I&&I.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(i=>{i.addEventListener("click",()=>e.quality.applyQualityTargets()),i.addEventListener("keydown",Y=>{(Y.key==="Enter"||Y.key===" ")&&(Y.preventDefault(),e.quality.applyQualityTargets())})});let B=document.getElementById("moldWaterWeight");B&&B.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let M=document.getElementById("moldOilPct");M&&M.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let F=document.getElementById("moldShape");F&&F.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldCylinderCorrection");D&&D.addEventListener("change",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Q=document.getElementById("moldCylinderFactor");Q&&Q.addEventListener("input",function(){e.mold.syncTargetFromMold(),H(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(i=>{i.addEventListener("click",function(){let Y=this.dataset.stubKind,y=this.dataset.stubName;e.runner.addStubLine(Y,y),e.storage.queueStateSave()})});let K=document.getElementById("soapToolPage");K&&(K.addEventListener("click",function(i){i.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),K.addEventListener("input",function(i){i.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(i.target),e.stages.updateStageStatuses(),e.ui.flashStage(i.target.closest(".soap-stage-card")))}),K.addEventListener("change",function(i){i.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(i.target),e.stages.updateStageStatuses())}));let G=document.getElementById("addToolIngredient");G&&G.addEventListener("click",function(){let i=document.getElementById("tool-ingredients");i&&i.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let J=document.getElementById("addToolConsumable");J&&J.addEventListener("click",function(){let i=document.getElementById("tool-consumables");i&&i.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let Z=document.getElementById("addToolContainer");Z&&Z.addEventListener("click",function(){let i=document.getElementById("tool-containers");i&&i.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let ne=document.getElementById("calcLyeBtn");ne&&ne.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let le=document.getElementById("saveSoapTool");le&&le.addEventListener("click",async function(){try{let i=$.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!i)return;let Y=e.runner.buildSoapRecipePayload(i);$.lastRecipePayload=Y;try{let y=e.helpers.getStorage();y&&y.setItem("soap_recipe_payload",JSON.stringify(Y))}catch{}x.SOAP_RECIPE_DTO=Y,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let me=document.getElementById("exportSoapCsv");me&&me.addEventListener("click",async function(){var C;let i=await o();if(!i)return;let Y=a(i),y=typeof((C=i==null?void 0:i.export)==null?void 0:C.csv_text)=="string"&&i.export.csv_text?i.export.csv_text:r(Y);d(y,"soap_formula.csv")});let fe=document.getElementById("printSoapSheet");fe&&fe.addEventListener("click",async function(){var C;let i=await o();if(!i)return;let Y=l(i),y=x.open("","_blank","width=960,height=720");if(!y){(C=e.ui)!=null&&C.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}y.document.open(),y.document.write(Y),y.document.close(),y.focus(),y.onload=()=>{y.print()}});let se=document.getElementById("soapUndoRemove");se&&se.addEventListener("click",()=>{$.lastRemovedOil&&(e.storage.restoreOilRow($.lastRemovedOil,$.lastRemovedOilIndex||0),$.lastRemovedOil=null,$.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let i=document.getElementById("soapMobileDrawer"),Y=document.getElementById("soapMobileDrawerContent"),y=document.getElementById("soapMobileDrawerTitle"),C=document.getElementById("soapDrawerEmpty"),V=document.getElementById("soapDrawerClose"),X=document.getElementById("soapQualityCard"),ee=document.getElementById("resultsCard");if(!i||!Y||!y||!X||!ee)return;let ae=X.parentElement,ce=ee.parentElement,ie=new Map,te=null,ue=()=>x.matchMedia("(max-width: 767px)").matches,pe=oe=>oe==="quality"?X:ee,ve=oe=>oe==="quality"?ae:ce,Se=oe=>oe==="quality"?"Display":"Results",be=oe=>{let ge=ie.get(oe);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",ie.set(oe,ge)),ge.style.height=`${oe.offsetHeight}px`,oe.parentElement&&oe.parentElement!==Y&&!ge.parentElement&&oe.parentElement.insertBefore(ge,oe)},_e=oe=>{oe&&(be(oe),Y.appendChild(oe))},de=(oe,ge)=>{let Ce=ie.get(oe);Ce&&Ce.parentElement?Ce.replaceWith(oe):ge&&oe.parentElement!==ge&&ge.appendChild(oe)},Ee=()=>{if(!C)return;let oe=te==="results",ge=getComputedStyle(ee).display!=="none";C.classList.toggle("d-none",!oe||ge)},Te=oe=>{ue()&&(te&&te!==oe&&de(pe(te),ve(te)),_e(pe(oe)),y.textContent=Se(oe),te=oe,i.classList.add("is-open"),Ee())},Ie=()=>{te&&(de(pe(te),ve(te)),te=null,i.classList.remove("is-open"),Ee())};i.querySelectorAll("[data-drawer-target]").forEach(oe=>{oe.addEventListener("click",()=>{let ge=oe.dataset.drawerTarget;ge&&(i.classList.contains("is-open")&&te===ge?Ie():Te(ge))})}),V&&V.addEventListener("click",Ie),x.addEventListener("resize",()=>{!ue()&&te&&Ie()}),new MutationObserver(()=>Ee()).observe(ee,{attributes:!0,attributeFilter:["style","class"]})})(),x.addEventListener("resize",e.layout.scheduleStageHeightSync),x.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",u,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",v,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",N,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",z,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),h&&!h.querySelector(".oil-row")&&h.appendChild(e.oils.buildOilRow()),s&&!s.querySelector(".fragrance-row")&&(ye=e.fragrances)!=null&&ye.buildFragranceRow&&s.appendChild(e.fragrances.buildFragranceRow()),(he=e.fragrances)!=null&&he.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
