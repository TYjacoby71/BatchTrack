(function(R){"use strict";let e={inventory:"Inventory",global:"Global Library"},s={inventory:"bg-primary",global:"bg-info text-dark"},y={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function N(r,c){let l;return function(){let T=arguments;clearTimeout(l),l=setTimeout(()=>r.apply(null,T),c)}}function J(r){return(r||"").trim().toLowerCase()}function H(r){if(r)return r;let c=document.createElement("div");return c.className="list-group position-absolute w-100 d-none inventory-suggestions",c.style.zIndex="1050",c.style.maxHeight="300px",c.style.overflowY="auto",c}function O(r){return typeof r=="function"?r():r}function E(r){let c=new Set;return(r||[]).forEach(l=>{let T=l&&(l.global_item_id||l.id);T&&c.add(String(T))}),c}function A(r){if(!r)return"";let c=e[r]||r;return`<span class="badge ${s[r]||"bg-secondary"} ms-2">${c}</span>`}function G(r,c,l,T){T=T||{},r.innerHTML="";let _=!1;if(c.forEach(I=>{!I.items||!I.items.length||(_=!0,I.items.forEach(h=>{let v=document.createElement("a");v.href="#",v.className="list-group-item list-group-item-action suggestion-item";let m=T.showSubtitle&&h.subtitle?`<div class="small text-muted mt-1">${h.subtitle}</div>`:"";v.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${h.text||h.display_name||h.name||""}</span>
          ${T.showSourceBadge?A(I.source||h.source):""}
        </div>${m}`,v.addEventListener("click",function(t){t.preventDefault(),l(h,I.source||h.source),r.classList.add("d-none")}),r.appendChild(v)}))}),r.classList.toggle("d-none",!_),!_&&r.dataset.emptyMessage){let I=document.createElement("div");I.className="list-group-item text-muted small",I.textContent=r.dataset.emptyMessage,r.appendChild(I),r.classList.remove("d-none")}}function L(r,c,l){r.innerHTML="";let T=!1;c.forEach(_=>{if(!_.ingredients||!_.ingredients.length)return;T=!0;let I=document.createElement("div");I.className="list-group-item text-muted small fw-semibold",I.textContent=_.title,r.appendChild(I),_.ingredients.forEach(h=>{let v=document.createElement("div");v.className="list-group-item ingredient-result";let m=document.createElement("div");m.className="d-flex justify-content-between align-items-center ingredient-summary",m.setAttribute("role","button"),m.setAttribute("tabindex","0"),m.innerHTML=`<span class="fw-semibold">${h.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${h.forms.length} option${h.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",h.forms.forEach(S=>{let M=document.createElement("button");M.type="button",M.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",M.innerHTML=`<div class="fw-semibold">${S.text||S.display_name||S.name||"Form"}</div>`,M.addEventListener("click",function(){l(S,S.source||_.source),r.classList.add("d-none")}),t.appendChild(M)});function f(S){S.type==="keydown"&&S.key!=="Enter"&&S.key!==" "||(S.preventDefault(),t.classList.toggle("d-none"))}m.addEventListener("click",f),m.addEventListener("keydown",f),v.appendChild(m),v.appendChild(t),r.appendChild(v),h.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!T)}function Y(r,c,l){r.innerHTML="";let T=!1;if((c||[]).forEach(_=>{T=!0;let I=document.createElement("a");I.href="#",I.className="list-group-item list-group-item-action suggestion-item";let h=_.inci_name?`<div class="small text-muted">${_.inci_name}</div>`:"";I.innerHTML=`<div class="fw-semibold">${_.text||_.name}</div>${h}`,I.addEventListener("click",function(v){v.preventDefault(),l(_,"definition"),r.classList.add("d-none")}),r.appendChild(I)}),r.classList.toggle("d-none",!T),!T&&r.dataset.emptyMessage){let _=document.createElement("div");_.className="list-group-item text-muted small",_.textContent=r.dataset.emptyMessage,r.appendChild(_),r.classList.remove("d-none")}}function o(r){let c=[];return(r||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let T=l.ingredient&&l.ingredient.name||l.ingredient_name||null,_=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,I=l.category_tags||[];l.forms.forEach(h=>{var t,f,S,M,w,P,F,j,u,b;let v=h.physical_form||{},m=h.display_name||h.text||h.name||(T&&h.physical_form_name?`${T}, ${h.physical_form_name}`:l.display_name||l.text||l.name||"");c.push({id:h.id,text:m,item_type:h.item_type||l.item_type,default_unit:h.default_unit||h.unit||l.default_unit||l.unit||null,source:"global",global_item_id:h.id,ingredient_id:h.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:h.ingredient_name||T,physical_form_id:h.physical_form_id||v&&v.id||null,physical_form_name:h.physical_form_name||v&&v.name||null,ingredient_category_name:_,category_tags:I,density:h.density||l.density||null,capacity:h.capacity||l.capacity||null,capacity_unit:h.capacity_unit||l.capacity_unit||null,container_material:h.container_material||l.container_material||null,container_type:h.container_type||l.container_type||null,container_style:h.container_style||l.container_style||null,container_color:h.container_color||l.container_color||null,default_is_perishable:(t=h.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(f=h.recommended_shelf_life_days)!=null?f:l.recommended_shelf_life_days,saponification_value:(M=(S=h.saponification_value)!=null?S:l.saponification_value)!=null?M:null,iodine_value:(P=(w=h.iodine_value)!=null?w:l.iodine_value)!=null?P:null,fatty_acid_profile:(j=(F=h.fatty_acid_profile)!=null?F:l.fatty_acid_profile)!=null?j:null,melting_point_c:(b=(u=h.melting_point_c)!=null?u:l.melting_point_c)!=null?b:null})})}else if(l){let T=l.display_name||l.text||l.name||"",_=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;c.push({id:l.id,text:T,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:_,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),c}function q(r){let c=new Map;return(r||[]).forEach(l=>{let T=l.ingredient_name||l.text||l.name||"",_=l.ingredient_id?`id:${l.ingredient_id}`:`name:${J(T)}`,I=c.get(_)||{ingredient_id:l.ingredient_id||null,name:T,forms:[]};I.forms.push({id:l.id,text:l.text||T,ingredient_name:T,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),c.set(_,I)}),Array.from(c.values())}function d(r,c){let l=[];return(r||[]).forEach(T=>{let _=(T.forms||[]).map(h=>({id:h.id,text:h.name||h.display_name||h.text,ingredient_name:h.ingredient_name||T.name||T.ingredient&&T.ingredient.name||"Ingredient",physical_form_name:h.physical_form_name||null,default_unit:h.default_unit||h.unit||null,source:"global",global_item_id:h.id,density:h.density||null,capacity:h.capacity||null,capacity_unit:h.capacity_unit||null,container_material:h.container_material||null,container_type:h.container_type||null,container_style:h.container_style||null,container_color:h.container_color||null,saponification_value:h.saponification_value||null,iodine_value:h.iodine_value||null,fatty_acid_profile:h.fatty_acid_profile||null,melting_point_c:h.melting_point_c||null})),I=c?_.filter(h=>!h.global_item_id||!c.has(String(h.global_item_id))):_;I.length&&l.push({ingredient_id:T.ingredient_id||T.id||null,name:T.name||T.ingredient&&T.ingredient.name||_[0]&&_[0].ingredient_name||"Ingredient",forms:I})}),l}function i(r){let c=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${c.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function a(r){let c={...y,...r},l=c.inputEl,T=c.invHiddenEl,_=c.giHiddenEl,I=H(c.listEl),h=c.mode||"recipe",v=c.searchType||"ingredient",m=c.includeInventory,t=c.includeGlobal,f=c.ingredientFirst,S=c.displayVariant,M=typeof c.resultFilter=="function"?c.resultFilter:null,w=typeof c.onSelection=="function"?c.onSelection:null,P=c.globalUrlBuilder;if(!l||!T&&h==="recipe"||!_&&c.requireHidden!==!1)return;I&&!I.classList.contains("list-group")&&I.classList.add("list-group"),!I.parentNode&&l.parentNode&&l.parentNode.appendChild(I);function F(p,g){let C=new URLSearchParams({q:p});return g&&g!=="all"&&C.set("type",g),`/inventory/api/search?${C.toString()}`}function j(p,g,C){if(typeof P=="function")return P(p,g,C);let x=new URLSearchParams({q:p});return g&&g!=="all"&&x.set("type",g),g==="ingredient"&&C&&x.set("group","ingredient"),`${h==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${x.toString()}`}let u=N(function(){let p=(l.value||"").trim();if(!p){I.classList.add("d-none"),I.innerHTML="",T&&(T.value=""),_&&(_.value="");return}let g=(O(v)||"ingredient").toLowerCase(),C=O(m),x=O(t),U=g==="ingredient"&&!!O(f),V=S||(U?"grouped":"compact");if(g==="ingredient_definition"||g==="definition"){i(p).then($=>{let X=$&&$.results||[];Y(I,X.map(Z=>({id:Z.id,text:Z.name,name:Z.name,inci_name:Z.inci_name,slug:Z.slug,ingredient_category_id:Z.ingredient_category_id,ingredient_category_name:Z.ingredient_category_name})),b)}).catch(()=>I.classList.add("d-none"));return}let z=C!==!1?fetch(F(p,g)).then($=>$.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),D=x!==!1?fetch(j(p,g,U)).then($=>$.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([z,D]).then($=>{let X=$[0]&&$[0].results||[],Z=$[1]&&$[1].results||[],le=M?X.filter(de=>M(de,"inventory")):X,ue=M?Z.filter(de=>M(de,"global")):Z,pe=E(le),Se=o(ue).filter(de=>!de.global_item_id||!pe.has(String(de.global_item_id))).filter(de=>M?M(de,"global"):!0);if(U){let de=q(le),be=d(ue,pe),Te=[];de.length&&Te.push({title:"Your Inventory",source:"inventory",ingredients:de}),be.length&&Te.push({title:"Global Library",source:"global",ingredients:be}),L(I,Te,b);return}let me=[];le.length&&me.push({title:"Your Inventory",source:"inventory",items:le}),Se.length&&me.push({title:"Global Library",source:"global",items:Se}),G(I,me,b,{showSourceBadge:c.showSourceBadge!==!1,showSubtitle:V==="detailed"})}).catch(()=>{I.classList.add("d-none")})},200);function b(p,g){l.value=p.text||p.display_name||p.name||"",g==="inventory"?(T&&(T.value=p.id_numeric||p.id||""),_&&(_.value=p.global_item_id||"")):(_&&(_.value=p.global_item_id||p.id||""),T&&(T.value="")),typeof w=="function"&&w(p,g)}l.addEventListener("input",function(){T&&(T.value=""),_&&(_.value=""),u()}),document.addEventListener("click",function(p){!I.contains(p.target)&&!l.contains(p.target)&&I.classList.add("d-none")})}R.attachMergedInventoryGlobalTypeahead=a,R.renderInventoryTypeaheadList=G})(window);(function(R){"use strict";function e(s,y){var N=y&&y.context||"public",J=y&&y.unitOptionsHtml||"",H=y&&y.mode||(N==="public"?"public":"recipe"),O=document.createElement("div");O.className="row g-2 align-items-end mb-2",O.innerHTML=['<div class="col-md-6">','  <label class="form-label">',s==="container"?"Container":s==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',s==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',s==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',J,"  </select>","</div>",'<div class="col-md-3 ',s!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var E=O.querySelector(".tool-typeahead"),A=O.querySelector(".tool-gi-id"),G=O.querySelector('[data-role="suggestions"]');if(typeof R.attachMergedInventoryGlobalTypeahead=="function"){let L=s==="container"?"container":s==="consumable"?"consumable":"ingredient",Y=N!=="public";R.attachMergedInventoryGlobalTypeahead({inputEl:E,giHiddenEl:A,listEl:G,mode:H,context:N,ingredientFirst:s==="ingredient",searchType:L,includeInventory:Y,includeGlobal:!0})}return O.querySelector(".tool-remove").addEventListener("click",function(){O.remove()}),O}R.buildToolLineRow=e})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};e.config={unitOptionsHtml:R.soapToolConfig&&R.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(R.SOAP_CALC_LIMIT)?R.SOAP_CALC_LIMIT:null,calcTier:R.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(R.soapToolConfig&&R.soapToolConfig.useCsvPrimary),isAuthenticated:R.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:s,toNumber:y,clamp:N,formatTime:J,getStorage:H,buildSoapcalcSearchBuilder:O};function s(E,A=3){if(!isFinite(E))return 0;let G=Math.pow(10,A);return Math.round(E*G)/G}function y(E){let A=E;typeof A=="string"&&(A=A.replace(/,/g,"").trim());let G=parseFloat(A);return isFinite(G)?G:0}function N(E,A,G){return!isFinite(E)||E<A?A:G!=null&&E>G?G:E}function J(E){return E?`Saved ${new Date(E).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function H(){try{return R.localStorage}catch{return null}}function O(){let E=(G,L,Y)=>{let o=new URLSearchParams({q:G});return L&&L!=="all"&&o.set("type",L),L==="ingredient"&&Y&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},A=(G,L,Y)=>{let o=new URLSearchParams({q:G});return Y&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?A:E}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},y={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},N={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},J=[41,70],H=100,O=[136,170],E=250,A={hardness:(s.hardness[0]+s.hardness[1])/2,cleansing:(s.cleansing[0]+s.cleansing[1])/2,conditioning:(s.conditioning[0]+s.conditioning[1])/2,bubbly:(s.bubbly[0]+s.bubbly[1])/2,creamy:(s.creamy[0]+s.creamy[1])/2},G={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},L={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},Y=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],q={g:1,oz:28.3495,lb:453.592},d=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],i=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),a=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),c=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),T=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:s,QUALITY_HINTS:y,QUALITY_FEEL_HINTS:N,IODINE_RANGE:J,IODINE_SCALE_MAX:H,INS_RANGE:O,INS_SCALE_MAX:E,QUALITY_BASE:A,QUALITY_PRESETS:G,FATTY_BAR_COLORS:L,FATTY_DISPLAY_KEYS:Y,OIL_TIP_RULES:o,UNIT_FACTORS:q,STAGE_CONFIGS:d,OIL_CATEGORY_SET:i,FRAGRANCE_CATEGORY_SET:a,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:c,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:T}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:s}=e.helpers;function y(O){let E=0,A=0;return O.forEach(G=>{G.iodine>0&&(E+=G.grams,A+=G.iodine*G.grams)}),{iodine:E>0?A/E:0,coverageWeight:E}}function N(O){let E={},A=0;O.forEach(L=>{!L.fattyProfile||typeof L.fattyProfile!="object"||(A+=L.grams,Object.entries(L.fattyProfile).forEach(([Y,o])=>{let q=s(o);q>0&&(E[Y]=(E[Y]||0)+L.grams*(q/100))}))});let G={};return A>0&&Object.entries(E).forEach(([L,Y])=>{G[L]=Y/A*100}),{percent:G,coveredWeight:A}}function J(O){let E=A=>O[A]||0;return{hardness:E("lauric")+E("myristic")+E("palmitic")+E("stearic"),cleansing:E("lauric")+E("myristic"),conditioning:E("oleic")+E("linoleic")+E("linolenic")+E("ricinoleic"),bubbly:E("lauric")+E("myristic")+E("ricinoleic"),creamy:E("palmitic")+E("stearic")+E("ricinoleic")}}function H(O){if(!O||typeof O!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let E={lauric:s(O.lauric),myristic:s(O.myristic),palmitic:s(O.palmitic),stearic:s(O.stearic),ricinoleic:s(O.ricinoleic),oleic:s(O.oleic),linoleic:s(O.linoleic),linolenic:s(O.linolenic)},A=J(E);return{hardness:(A.hardness||0)/100,cleansing:(A.cleansing||0)/100,conditioning:(A.conditioning||0)/100,bubbly:(A.bubbly||0)/100,creamy:(A.creamy||0)/100}}e.calc={computeIodine:y,computeFattyAcids:N,computeQualities:J,computeOilQualityScores:H},R.SoapCalcService=e.calc})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y,clamp:N}=e.helpers,{UNIT_FACTORS:J}=e.constants,H=e.state;function O(o){return N(y(o),0)*(J[H.currentUnit]||1)}function E(o){return N(o,0)/(J[H.currentUnit]||1)}function A(o){return!isFinite(o)||o<=0?"--":`${s(E(o),2)} ${H.currentUnit}`}function G(o){return isFinite(o)?`${s(o,1)}%`:"--"}function L(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=H.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=H.currentUnit})}function Y(o,q={}){if(!o)return;if(o===H.currentUnit){L();return}let d=H.currentUnit;if(H.currentUnit=o,L(),q.skipConvert)return;let i=(J[d]||1)/(J[o]||1);document.querySelectorAll(".oil-grams").forEach(c=>{let l=y(c.value);l>0&&(c.value=s(l*i,2))}),document.querySelectorAll(".fragrance-grams").forEach(c=>{let l=y(c.value);l>0&&(c.value=s(l*i,2))});let a=document.getElementById("oilTotalTarget");if(a&&a.value){let c=y(a.value);c>0&&(a.value=s(c*i,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let c=y(r.value);c>0&&(r.value=s(c*i,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),q.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:O,fromGrams:E,formatWeight:A,formatPercent:G,updateUnitLabels:L,setUnit:Y}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.state,y={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function N(d){d&&(d.classList.remove("soap-number-pulse"),d.offsetWidth,d.classList.add("soap-number-pulse"))}function J(d){var a;let i=document.getElementById(d);return!i||!((a=R.bootstrap)!=null&&a.Toast)?null:bootstrap.Toast.getOrCreateInstance(i)}function H(){let d=Date.now();if(d-s.lastSaveToastAt<3500)return;s.lastSaveToastAt=d;let i=J("soapAutosaveToast");i&&i.show()}function O(d){let i=document.getElementById("soapUndoToast");if(!i)return;let a=i.querySelector(".toast-body");a&&(a.textContent=d||"Oil removed.");let r=J("soapUndoToast");r&&r.show()}function E(){let d=document.getElementById("resultsReadyBadge"),i=document.getElementById("resultsUpdatedAt");d&&d.classList.remove("d-none"),i&&(i.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function A(d){let i=document.getElementById("lyeConcentrationWarning"),a=document.getElementById("waterRatioWarning");if(i){let r=(d==null?void 0:d.lyeConcentration)||0,c="";r>40&&(c="High concentration"),r>0&&r<25&&(c="Low concentration"),i.textContent=c,i.classList.toggle("d-none",!c)}if(a){let r=(d==null?void 0:d.waterRatio)||0,c="";r>0&&r<1.8&&(c="Low water"),r>2.7&&(c="High water"),a.textContent=c,a.classList.toggle("d-none",!c)}}function G(){document.querySelectorAll("#soapToolPage .form-text").forEach(d=>{let i=d.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");i&&i.classList.add("soap-field")})}function L(d){if(!d||d.type!=="number")return;let i=d.value;if(i===""){d.classList.remove("is-invalid");return}let a=parseFloat(i),r=d.getAttribute("min"),c=d.getAttribute("max"),l=r!==null&&r!==""&&a<parseFloat(r),T=c!==null&&c!==""&&a>parseFloat(c);d.classList.toggle("is-invalid",!isFinite(a)||l||T)}function Y(d){var a;if(!d)return;let i=((a=d.querySelector)==null?void 0:a.call(d,".soap-stage-card"))||d;i.classList.add("soap-stage-highlight"),setTimeout(()=>i.classList.remove("soap-stage-highlight"),900)}function o(d,i,a={}){var T;let r=document.getElementById("soapAlertStack");if(!r)return;let c=y[d]||y.info,l=document.createElement("div");l.className=`alert alert-${d} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${c} mt-1"></i>
      <div class="flex-grow-1">${i}</div>
      ${a.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,a.dismissible&&((T=l.querySelector('[data-role="dismiss"]'))==null||T.addEventListener("click",()=>l.remove())),r.prepend(l),a.persist||setTimeout(()=>{l.parentNode&&l.remove()},a.timeoutMs||4500)}function q(){let d=document.getElementById("soapAlertStack");d&&d.querySelectorAll(".alert").forEach(i=>i.remove())}e.ui={pulseValue:N,getToastInstance:J,showAutosaveToast:H,showUndoToast:O,updateResultsMeta:E,updateResultsWarnings:A,applyHelperVisibility:G,validateNumericField:L,flashStage:Y,showSoapAlert:o,clearSoapAlerts:q}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function s(){let N=document.getElementById("soapStagePane"),J=document.getElementById("soapQualityCard");if(!N||!J)return;if(!R.matchMedia("(min-width: 768px)").matches){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}let O=J.offsetHeight;if(!O){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}N.style.setProperty("--soap-stage-height",`${O}px`),N.classList.add("is-height-synced")}let y=()=>{R.requestAnimationFrame(s)};e.layout={syncStageHeight:s,scheduleStageHeightSync:y}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{clamp:s,toNumber:y,round:N}=e.helpers,{toGrams:J,fromGrams:H}=e.units;function O(){let o=L(),q=document.getElementById("oilTotalTarget"),d=document.getElementById("oilTargetHint");q&&o.effectiveCapacity>0&&J(q.value)<=0&&(q.value=o.targetOils>0?N(H(o.targetOils),2):""),d&&(o.effectiveCapacity>0?d.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":d.textContent="Auto-fills when mold sizing is set.");let i=document.getElementById("moldSuggestionNote");if(i){let a="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?a=`Cylinder correction applied (${N(o.cylinderFactor*100,0)}% of capacity).`:a="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),i.textContent=a}E()}function E(o=null){var h;let q=document.getElementById("moldWetBatterWarning");if(!q)return;let d=()=>{q.classList.add("d-none"),q.textContent=""},i=L(),a=e.state||{},r=a.lastCalc||null,c=(h=e.oils)!=null&&h.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=y(r==null?void 0:r.totalOils),T=y(o);if((!isFinite(T)||T<=0)&&(T=y(r==null?void 0:r.batchYield)),o==null&&l>0&&c>0&&Math.abs(l-c)>.01){d();return}if(!isFinite(T)||T<=0||i.effectiveCapacity<=0){d();return}let _=T-i.effectiveCapacity;if(_<=.01){d();return}let I=a.currentUnit||"g";q.textContent=`Full wet batter is ${N(H(T),2)} ${I}, exceeding mold capacity ${N(H(i.effectiveCapacity),2)} ${I} by ${N(H(_),2)} ${I}. Reduce oils target/% of mold or lower water/additives.`,q.classList.remove("d-none")}function A(){let o=document.getElementById("oilTotalTarget"),q=L();return o&&(q.effectiveCapacity>0&&(o.value=q.targetOils>0?N(H(q.targetOils),2):""),O()),q}function G(){let o=document.getElementById("oilTotalTarget"),q=document.getElementById("moldOilPct");if(!o||!q){let a=L();return O(),a}let d=L();if(d.effectiveCapacity>0){let a=J(o.value),r=s(a,0,d.effectiveCapacity);a>d.effectiveCapacity+.01&&(o.value=N(H(r),2));let c=r>0?r/d.effectiveCapacity*100:0;q.value=r>0?N(c,2):""}let i=L();return O(),i}function L(){var l,T,_;let o=J(document.getElementById("moldWaterWeight").value),q=s(y(document.getElementById("moldOilPct").value),0,100),d=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",i=!!((T=document.getElementById("moldCylinderCorrection"))!=null&&T.checked),a=s(y((_=document.getElementById("moldCylinderFactor"))==null?void 0:_.value),.5,1),r=o>0?o*(i?a:1):0,c=r>0?r*(q/100):0;return{waterWeight:o,oilPct:q,shape:d,useCylinder:i,cylinderFactor:a,effectiveCapacity:r,targetOils:c}}function Y(){var d;let o=((d=document.getElementById("moldShape"))==null?void 0:d.value)||"loaf",q=document.getElementById("moldCylinderOptions");q&&q.classList.toggle("d-none",o!=="cylinder"),O()}e.mold={updateMoldSuggested:O,updateWetBatterWarning:E,syncTargetFromMold:A,syncMoldPctFromTarget:G,getMoldSettings:L,updateMoldShapeUI:Y}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y,clamp:N,buildSoapcalcSearchBuilder:J}=e.helpers,{toGrams:H,fromGrams:O}=e.units,{OIL_CATEGORY_SET:E,OIL_TIP_RULES:A}=e.constants,{computeQualities:G}=e.calc,L=e.state;function Y(u){let b=u.querySelector(".oil-typeahead"),p=u.querySelector(".oil-sap-koh"),g=u.querySelector(".oil-iodine"),C=u.querySelector(".oil-fatty"),x=u.querySelector(".oil-gi-id"),U=u.querySelector(".oil-default-unit"),V=u.querySelector(".oil-category"),z=u.querySelector('[data-role="suggestions"]');if(!b||!z||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let D=J();R.attachMergedInventoryGlobalTypeahead({inputEl:b,listEl:z,mode:"public",giHiddenEl:x,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:D,searchType:"ingredient",resultFilter:($,X)=>F($,E,X),requireHidden:!1,onSelection:function($){p&&(p.value=($==null?void 0:$.saponification_value)||""),g&&(g.value=($==null?void 0:$.iodine_value)||""),C&&(C.value=$!=null&&$.fatty_acid_profile?JSON.stringify($.fatty_acid_profile):""),U&&(U.value=($==null?void 0:$.default_unit)||""),V&&(V.value=($==null?void 0:$.ingredient_category_name)||""),t($),I(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),b.addEventListener("input",function(){this.value.trim()||(p&&(p.value=""),g&&(g.value=""),C&&(C.value=""),x&&(x.value=""),U&&(U.value=""),V&&(V.value=""),S())})}function o(){var p,g;let u=document.getElementById("oilRowTemplate"),b=(g=(p=u==null?void 0:u.content)==null?void 0:p.querySelector(".oil-row"))==null?void 0:g.cloneNode(!0);return b?(b.querySelectorAll("input").forEach(C=>{C.value=""}),b.querySelectorAll(".form-text").forEach(C=>{let x=C.closest('.soap-field-stack, [class*="col-"]');x&&x.classList.add("soap-field")}),Y(b),b.querySelectorAll(".unit-suffix").forEach(C=>{C.dataset.suffix=L.currentUnit}),b):document.createElement("div")}function q(){let u=document.getElementById("oilTotalTarget"),b=H(u==null?void 0:u.value);if(b>0)return b;let p=e.mold.getMoldSettings();return p.targetOils>0?p.targetOils:0}function d(u){let b=[];return u.forEach(g=>{var U,V;let C=H((U=g.querySelector(".oil-grams"))==null?void 0:U.value),x=N(y((V=g.querySelector(".oil-percent"))==null?void 0:V.value),0);C>0&&x>0&&b.push(C/(x/100))}),b.length?b.reduce((g,C)=>g+C,0)/b.length:0}function i(u,b){if(!u||!b||b<=0)return{allowedGrams:null,allowedPct:null};let p=Array.from(document.querySelectorAll("#oilRows .oil-row")),g=p.reduce((D,$)=>{var X;return $===u?D:D+H((X=$.querySelector(".oil-grams"))==null?void 0:X.value)},0),C=p.reduce((D,$)=>{var X;return $===u?D:D+N(y((X=$.querySelector(".oil-percent"))==null?void 0:X.value),0)},0),x=Math.max(0,100-C),U=Math.max(0,b-g),V=b*x/100;return{allowedGrams:Math.max(0,Math.min(U,V)),allowedPct:x}}function a(u,b,p){if(!u)return;let g=u.querySelector(`[data-role="oil-${b}-hint"]`);g&&(p?(g.textContent=p,g.classList.add("is-visible")):(g.textContent="",g.classList.remove("is-visible")))}function r(u){u&&(u.classList.remove("oil-input-bounce"),u.offsetWidth,u.classList.add("oil-input-bounce"))}function c(u,b,p={}){let g=q();if(!u||!g||g<=0){a(u,b,"");return}let C=u.querySelector(".oil-grams"),x=u.querySelector(".oil-percent"),U=i(u,g);if(b==="grams"&&C){let V=H(C.value),z="";if(V>g+.01?z="Entry exceeds the max oils allowed in stage 2.":U.allowedGrams!==null&&V>U.allowedGrams+.01&&(z=`Must be under ${s(O(U.allowedGrams),2)} ${L.currentUnit} to stay within the stage 2 oil limit.`),z){let D=U.allowedGrams!==null?s(O(U.allowedGrams),2):s(O(g),2);C.value=D>0?D:"",a(u,b,z),C.classList.add("oil-input-warning"),r(C),I()}else C.classList.remove("oil-input-warning"),a(u,b,"")}if(b==="percent"&&x){let V=N(y(x.value),0),z="";if(V>100.01?z="Entry exceeds the max oils allowed in stage 2.":U.allowedPct!==null&&V>U.allowedPct+.01&&(z=`Must be under ${s(U.allowedPct,2)}% to stay within the stage 2 oil limit.`),z){let D=U.allowedPct!==null?s(U.allowedPct,2):100;x.value=D>0?D:"",a(u,b,z),x.classList.add("oil-input-warning"),r(x),I()}else x.classList.remove("oil-input-warning"),a(u,b,"")}}function l(u,b={}){let p=Array.from(document.querySelectorAll("#oilRows .oil-row")),g=u!=null?u:q(),C=!!b.force;if(!g||g<=0||!p.length){L.lastOilTarget=g;return}let x=p.reduce((V,z)=>{var D;return V+N(y((D=z.querySelector(".oil-percent"))==null?void 0:D.value),0)},0),U=p.reduce((V,z)=>{var D;return V+H((D=z.querySelector(".oil-grams"))==null?void 0:D.value)},0);if(x<=0&&U<=0){L.lastOilTarget=g;return}if(!(!C&&L.lastOilTarget&&Math.abs(L.lastOilTarget-g)<.01)){if(x>0)p.forEach(V=>{let z=V.querySelector(".oil-percent"),D=V.querySelector(".oil-grams"),$=N(y(z==null?void 0:z.value),0),X=x>0?$/x:0;D&&(D.value=X>0?s(O(g*X),2):""),z&&(z.value=X>0?s(X*100,2):"")});else if(U>0){let V=g/U;p.forEach(z=>{let D=z.querySelector(".oil-grams"),$=z.querySelector(".oil-percent"),X=H(D==null?void 0:D.value);if(D){let Z=X>0?X*V:0;D.value=Z>0?s(O(Z),2):""}if($){let Z=H(D==null?void 0:D.value);$.value=Z>0?s(Z/g*100,2):""}})}L.lastOilTarget=g,I({skipEnforce:!0})}}function T(u,b){if(!L.lastOilEdit||!L.lastOilEdit.row)return!1;let p=L.lastOilEdit.row,g=u.reduce((V,z)=>{var D;return z===p?V:V+H((D=z.querySelector(".oil-grams"))==null?void 0:D.value)},0),C=Math.max(0,b-g),x=p.querySelector(".oil-grams"),U=p.querySelector(".oil-percent");return!x||!U?!1:(x.value=C>0?s(O(C),2):"",U.value=C>0?s(C/b*100,2):"",L.wasCapped=!0,!0)}function _({totalWeight:u,totalPct:b,target:p,capped:g}){let C=document.getElementById("oilLimitWarning");if(!C)return;let x=[];if(g&&x.push("Oil total hit the mold cap and was adjusted."),p>0&&u>p+.01){let U=u-p;x.push(`Oil weights exceed the target by ${s(O(U),2)} ${L.currentUnit}.`)}b>100.01&&x.push(`Oil percentages are over 100% by ${s(b-100,2)}%.`),x.length?(C.classList.remove("d-none"),C.innerHTML=`${x.join(" ")} Adjust oils or mold % to continue.`):(C.classList.add("d-none"),C.textContent="")}function I(u={}){var V;u.skipEnforce||(L.wasCapped=!1);let b=Array.from(document.querySelectorAll("#oilRows .oil-row")),p=e.mold.getMoldSettings(),g=q();if(!g&&!p.targetOils){let z=d(b);if(z>0){g=z;let D=document.getElementById("oilTotalTarget");D&&!D.value&&(D.value=s(O(z),2))}}let C=0,x=0;if(b.forEach(z=>{let D=z.querySelector(".oil-grams"),$=z.querySelector(".oil-percent"),X=H(D==null?void 0:D.value),Z=N(y($==null?void 0:$.value),0);g>0&&(L.lastOilEdit&&L.lastOilEdit.row===z&&L.lastOilEdit.field==="percent"?(X=Z>0?g*(Z/100):0,D.value=Z>0?s(O(X),2):""):X>0?(Z=X/g*100,$.value=s(Z,2)):Z>0&&(X=g*(Z/100),D.value=s(O(X),2)),x+=Z),X>0&&(C+=X)}),g<=0&&(C>0?(x=0,b.forEach(z=>{let D=z.querySelector(".oil-grams"),$=z.querySelector(".oil-percent"),X=H(D==null?void 0:D.value);if(X>0){let Z=X/C*100;$.value=s(Z,2),x+=Z}})):x=b.reduce((z,D)=>{var $;return z+N(y(($=D.querySelector(".oil-percent"))==null?void 0:$.value),0)},0)),!u.skipEnforce&&p.targetOils>0&&C>p.targetOils+.01&&T(b,p.targetOils))return I({skipEnforce:!0});L.totalOilsGrams=C;let U=document.getElementById("oilTotalComputed");return U&&(U.textContent=C>0?`${s(O(C),2)} ${L.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=s(x,2),_({totalWeight:C,totalPct:x,target:g,capped:L.wasCapped}),e.additives.updateAdditivesOutput(C),(V=e.fragrances)!=null&&V.updateFragranceTotals&&e.fragrances.updateFragranceTotals(C),e.mold.updateMoldSuggested(),M(),{totalWeight:C,totalPct:x,target:g}}function h(){let u=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!u.length)return;let b=q(),p=u.reduce((g,C)=>{var x;return g+N(y((x=C.querySelector(".oil-percent"))==null?void 0:x.value),0)},0);!p&&b>0&&(p=u.reduce((g,C)=>{var U;let x=H((U=C.querySelector(".oil-grams"))==null?void 0:U.value);return g+(x>0?x/b*100:0)},0)),!(p<=0)&&(u.forEach(g=>{let C=g.querySelector(".oil-percent"),x=g.querySelector(".oil-grams"),V=N(y(C.value),0)/p*100;C.value=s(V,2),b>0&&(x.value=V>0?s(O(b*(V/100)),2):"")}),I())}function v(){let u=[];return document.querySelectorAll("#oilRows .oil-row").forEach(b=>{var X,Z,le,ue,pe,Se,me,de,be;let p=(Z=(X=b.querySelector(".oil-typeahead"))==null?void 0:X.value)==null?void 0:Z.trim(),g=H((le=b.querySelector(".oil-grams"))==null?void 0:le.value),C=y((ue=b.querySelector(".oil-sap-koh"))==null?void 0:ue.value),x=y((pe=b.querySelector(".oil-iodine"))==null?void 0:pe.value),U=((Se=b.querySelector(".oil-fatty"))==null?void 0:Se.value)||"",V=((me=b.querySelector(".oil-gi-id"))==null?void 0:me.value)||"",z=((de=b.querySelector(".oil-default-unit"))==null?void 0:de.value)||"",D=((be=b.querySelector(".oil-category"))==null?void 0:be.value)||"",$=null;if(U)try{$=JSON.parse(U)}catch{$=null}g<=0||u.push({name:p||null,grams:g,sapKoh:C,iodine:x,fattyProfile:$,global_item_id:V?parseInt(V):null,default_unit:z||null,ingredient_category_name:D||null})}),u}function m({name:u,sapKoh:b,iodine:p,fattyProfile:g}={}){let C=document.getElementById("oilProfileFloat"),x=(Z,le)=>{let ue=document.getElementById(Z);ue&&(ue.textContent=le)},U=u||"Pick an oil to preview";x("selectedOilName",U),x("selectedOilModalName",U),C&&C.classList.toggle("d-none",!u);let V=b>0?s(b,1):"--",z=p>0?s(p,1):"--";x("selectedOilSap",V),x("selectedOilModalSap",V),x("selectedOilIodine",z),x("selectedOilModalIodine",z);let D=g?G(g):{},$=(Z,le)=>{let ue=isFinite(le)&&le>0?s(le,1):"--";x(Z,ue)};$("selectedOilHardness",D.hardness),$("selectedOilModalHardness",D.hardness),$("selectedOilCleansing",D.cleansing),$("selectedOilModalCleansing",D.cleansing),$("selectedOilConditioning",D.conditioning),$("selectedOilModalConditioning",D.conditioning),$("selectedOilBubbly",D.bubbly),$("selectedOilModalBubbly",D.bubbly),$("selectedOilCreamy",D.creamy),$("selectedOilModalCreamy",D.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(Z=>{let le=`selectedOil${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,ue=`selectedOilModal${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,pe=g?y(g[Z]):0,Se=pe>0?s(pe,1):"--";x(le,Se),x(ue,Se)})}function t(u){if(!u){S();return}L.selectedOilProfile=u;let b=u.fatty_acid_profile||null;if(typeof b=="string")try{b=JSON.parse(b)}catch{b=null}m({name:u.text||u.display_name||u.name,sapKoh:y(u.saponification_value),iodine:y(u.iodine_value),fattyProfile:b})}function f(u){var U,V,z,D,$;if(!u)return;let b=(V=(U=u.querySelector(".oil-typeahead"))==null?void 0:U.value)==null?void 0:V.trim(),p=y((z=u.querySelector(".oil-sap-koh"))==null?void 0:z.value),g=y((D=u.querySelector(".oil-iodine"))==null?void 0:D.value),C=(($=u.querySelector(".oil-fatty"))==null?void 0:$.value)||"",x=null;if(C)try{x=JSON.parse(C)}catch{x=null}m({name:b,sapKoh:p,iodine:g,fattyProfile:x})}function S(){L.selectedOilProfile=null,L.lastPreviewRow=null,m()}function M(){let u=document.getElementById("oilBlendTips");if(!u)return;let b=v().filter(C=>C.grams>0||C.percent>0);if(!b.length){u.classList.add("d-none"),u.textContent="";return}let p=new Set;b.forEach(C=>{let x=(C.name||"").toLowerCase();if(x&&A.forEach(U=>{U.match.test(x)&&p.add(U.tip)}),C.fattyProfile&&typeof C.fattyProfile=="object"){let U=y(C.fattyProfile.lauric),V=y(C.fattyProfile.myristic),z=y(C.fattyProfile.palmitic),D=y(C.fattyProfile.stearic),$=y(C.fattyProfile.ricinoleic),X=y(C.fattyProfile.oleic),Z=y(C.fattyProfile.linoleic),le=y(C.fattyProfile.linolenic);U+V>=30&&p.add(`${C.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),z+D>=40&&p.add(`${C.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),X>=60&&p.add(`${C.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),Z+le>=20&&p.add(`${C.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),$>=60&&p.add(`${C.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let g=Array.from(p).slice(0,6);if(!g.length){u.classList.add("d-none"),u.textContent="";return}u.classList.remove("d-none"),u.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${g.map(C=>`<li>${C}</li>`).join("")}</ul>`}function w(){return L.totalOilsGrams||0}function P(u){var b,p,g,C,x,U,V,z,D;return u?{name:((b=u.querySelector(".oil-typeahead"))==null?void 0:b.value)||"",grams:((p=u.querySelector(".oil-grams"))==null?void 0:p.value)||"",percent:((g=u.querySelector(".oil-percent"))==null?void 0:g.value)||"",sap:((C=u.querySelector(".oil-sap-koh"))==null?void 0:C.value)||"",iodine:((x=u.querySelector(".oil-iodine"))==null?void 0:x.value)||"",fattyRaw:((U=u.querySelector(".oil-fatty"))==null?void 0:U.value)||"",gi:((V=u.querySelector(".oil-gi-id"))==null?void 0:V.value)||"",defaultUnit:((z=u.querySelector(".oil-default-unit"))==null?void 0:z.value)||"",categoryName:((D=u.querySelector(".oil-category"))==null?void 0:D.value)||""}:null}function F(u,b,p){let g=j(u);return g?b.has(g):p==="inventory"}function j(u){return!u||typeof u!="object"?null:u.ingredient&&u.ingredient.ingredient_category_name||u.ingredient_category_name||u.ingredient_category&&u.ingredient_category.name||null}e.oils={attachOilTypeahead:Y,buildOilRow:o,getOilTargetGrams:q,updateOilTotals:I,normalizeOils:h,collectOilData:v,setSelectedOilProfileFromRow:f,clearSelectedOilProfile:S,updateOilTips:M,getTotalOilsGrams:w,serializeOilRow:P,validateOilEntry:c,scaleOilsToTarget:l}})(window);(function(R){"use strict";var m;let e=R.SoapTool=R.SoapTool||{},s=e.bulkOils=e.bulkOils||{},{toNumber:y,clamp:N}=e.helpers,J=e.state,H=Array.isArray((m=e.constants)==null?void 0:m.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],O=new Set(["selected_pct","selected_weight_g"]),E=25,A=140,G=260,L={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function Y(){var t,f;(f=(t=e.storage)==null?void 0:t.queueStateSave)==null||f.call(t)}function o(t,f){var S,M;(M=(S=e.ui)==null?void 0:S.showSoapAlert)==null||M.call(S,t,f,{dismissible:!0,timeoutMs:6e3})}function q(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function d(t){return t?t==="name"||O.has(t)?!0:H.includes(t):!1}function i(){(!J.bulkOilModal||typeof J.bulkOilModal!="object")&&(J.bulkOilModal=JSON.parse(JSON.stringify(L)));let t=J.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=d(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function a(t){let f={},S=t&&typeof t=="object"?t:{};return H.forEach(M=>{let w=y(S[M]);w>0&&(f[M]=w)}),f}function r(t){let f=a(t==null?void 0:t.fatty_profile),S=String((t==null?void 0:t.name)||"").trim(),M=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:y(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${M}:${S.toLowerCase()}`)),name:S,sap_koh:y(t==null?void 0:t.sap_koh),iodine:y(t==null?void 0:t.iodine),fatty_profile:f,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:M,is_basic:!!(t!=null&&t.is_basic)}}function c(){let t=q(),f=i(),S=Object.keys(f.selection||{}).length,M=`Selected: ${S}`;t.summaryEl&&(t.summaryEl.textContent=M),t.stageCountEl&&(t.stageCountEl.textContent=String(S))}function l(t){var S;return((S=i().selection)==null?void 0:S[t])||null}function T(t,f={}){var P,F;let S=i();if(!t||!t.key)return null;let M=S.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:N(y((P=f.selected_pct)!=null?P:M.selected_pct),0,100),selected_weight_g:N(y((F=f.selected_weight_g)!=null?F:M.selected_weight_g),0)};return S.selection[t.key]=w,w}function _(t){var S;let f=i();(S=f.selection)!=null&&S[t]&&delete f.selection[t]}function I(t){var S;return((S=i().recordByKey)==null?void 0:S[t])||null}function h(){let t=i();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(f=>({key:f.key,name:f.name,sap_koh:f.sap_koh,iodine:f.iodine,fatty_profile:f.fatty_profile||{},default_unit:f.default_unit,ingredient_category_name:f.ingredient_category_name,global_item_id:f.global_item_id,source:f.source,is_basic:!!f.is_basic,selected_pct:N(y(f.selected_pct),0,100),selected_weight_g:N(y(f.selected_weight_g),0)}))}}function v(t){let f=i();f.mode="all",f.viewSelected=!!(t!=null&&t.view_selected),f.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",f.sortKey=d(t==null?void 0:t.sort_key)?t.sort_key:"name",f.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let S={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let P=String((w==null?void 0:w.key)||"").trim(),F=String((w==null?void 0:w.name)||"").trim();!P||!F||(S[P]={key:P,name:F,sap_koh:y(w==null?void 0:w.sap_koh),iodine:y(w==null?void 0:w.iodine),fatty_profile:a(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:y(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:N(y(w==null?void 0:w.selected_pct),0,100),selected_weight_g:N(y(w==null?void 0:w.selected_weight_g),0)})}),f.selection=S,f.visibleRecords=[],f.offset=0,f.totalCount=0,f.hasMore=!0,f.loading=!1,c()}s.shared={FATTY_KEYS:H,LOCAL_SORT_KEYS:O,PAGE_SIZE:E,SCROLL_FETCH_THRESHOLD:A,SEARCH_DEBOUNCE_MS:G,queueStateSave:Y,showAlert:o,getRefs:q,ensureModalState:i,normalizeFattyProfile:a,normalizeCatalogRecord:r,updateSelectionCounters:c,selectionForRecordKey:l,setSelection:T,removeSelection:_,getRecordByKey:I,serializeSelection:h,restoreState:v}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.bulkOils=e.bulkOils||{},y=s.shared;if(!y)return;let{round:N,toNumber:J}=e.helpers,{fromGrams:H}=e.units,{FATTY_KEYS:O,LOCAL_SORT_KEYS:E,getRefs:A,ensureModalState:G,selectionForRecordKey:L,updateSelectionCounters:Y}=y;function o(m){let t=A();t.statusEl&&(t.statusEl.textContent=m)}function q(){let m=G();if(m.loading&&!m.visibleRecords.length){o("Loading oils...");return}if(!m.visibleRecords.length){let w=m.query?"No oils match that search.":"No oils available.";o(w);return}let t=m.visibleRecords.length,f=m.totalCount,S=m.hasMore?" \u2022 scroll for more":"",M=m.query?` \u2022 search: "${m.query}"`:"";o(`Showing ${t} of ${f} oils${M}${S}`)}function d(m,t,f){if(typeof m=="string"||typeof t=="string"){let w=String(m||"").toLowerCase(),P=String(t||"").toLowerCase();return w<P?f==="asc"?-1:1:w>P?f==="asc"?1:-1:0}let S=J(m),M=J(t);return S<M?f==="asc"?-1:1:S>M?f==="asc"?1:-1:0}function i(m,t){var f,S;return t==="selected_pct"?((f=L(m.key))==null?void 0:f.selected_pct)||0:t==="selected_weight_g"?((S=L(m.key))==null?void 0:S.selected_weight_g)||0:""}function a(){let m=G();E.has(m.sortKey)&&m.visibleRecords.sort((t,f)=>{let S=d(i(t,m.sortKey),i(f,m.sortKey),m.sortDir);return S!==0?S:d(t.name||"",f.name||"","asc")})}function r(){let m=G();if(!m.viewSelected)return;let t=[],f=[];m.visibleRecords.forEach(S=>{L(S.key)?t.push(S):f.push(S)}),m.visibleRecords=t.concat(f)}function c(){a(),r()}function l(m){let t=String(m||"").trim().toLowerCase();return t==="name"||O.includes(t)?t:"name"}function T(){let m=G();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[▲▼]\s*$/,"").trim());let f=t.dataset.label||"",S=t.dataset.sortKey||"";m.sortKey===S?t.textContent=`${f} ${m.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=f})}function _(m,t){let f=L(t.key),S=m.querySelector(".bulk-oil-check"),M=m.querySelector(".bulk-oil-pct"),w=m.querySelector(".bulk-oil-weight");S&&(S.checked=!!f),M&&(M.value=f&&f.selected_pct>0?N(f.selected_pct,2):""),w&&(w.value=f&&f.selected_weight_g>0?N(H(f.selected_weight_g),2):"")}function I(m){let t=document.createElement("td");t.className="bulk-oil-acid";let f=J(m);return t.textContent=f>0?N(f,1).toString():"--",t}function h(m){let t=document.createElement("tr");t.dataset.recordKey=m.key;let f=document.createElement("td");f.className="text-center";let S=document.createElement("input");S.type="checkbox",S.className="form-check-input bulk-oil-check",f.appendChild(S),t.appendChild(f);let M=document.createElement("td");M.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=m.name;let P=document.createElement("div");P.className="text-muted small";let F=m.ingredient_category_name?` \xB7 ${m.ingredient_category_name}`:"";P.textContent=`${m.source}${F}`,M.appendChild(w),M.appendChild(P),t.appendChild(M),O.forEach(g=>{var C;t.appendChild(I((C=m.fatty_profile)==null?void 0:C[g]))});let j=document.createElement("td"),u=document.createElement("input");u.type="number",u.min="0",u.max="100",u.step="0.1",u.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",j.appendChild(u),t.appendChild(j);let b=document.createElement("td"),p=document.createElement("input");return p.type="number",p.min="0",p.step="0.1",p.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",b.appendChild(p),t.appendChild(b),_(t,m),t}function v(){let m=A(),t=G();if(!m.bodyEl)return;m.bodyEl.innerHTML="";let f=document.createDocumentFragment();t.visibleRecords.forEach(S=>{f.appendChild(h(S))}),m.bodyEl.appendChild(f),T(),Y(),q()}s.render={updateStatusText:o,refreshCatalogStatus:q,applyLocalSelectionSortIfNeeded:a,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:c,normalizeServerSortKey:l,sortButtonsLabel:T,renderVisibleRecords:v}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.bulkOils=e.bulkOils||{},y=s.shared,N=s.render;if(!y||!N)return;let{PAGE_SIZE:J,getRefs:H,ensureModalState:O,normalizeCatalogRecord:E}=y,{refreshCatalogStatus:A,normalizeServerSortKey:G,applyClientOrdering:L,renderVisibleRecords:Y,updateStatusText:o}=N;function q(){let i=O(),a=H();i.visibleRecords=[],i.offset=0,i.totalCount=0,i.hasMore=!0,a.bodyEl&&(a.bodyEl.innerHTML=""),a.scrollEl&&(a.scrollEl.scrollTop=0)}async function d({reset:i=!1}={}){let a=O();if(!H().modalEl||a.loading&&!i||!a.hasMore&&!i)return;i&&q();let c=a.requestToken+1;a.requestToken=c,a.loading=!0,A();let l=new URLSearchParams;l.set("mode",a.mode),l.set("offset",String(a.offset)),l.set("limit",String(J)),l.set("q",a.query||""),l.set("sort_key",G(a.sortKey)),l.set("sort_dir",a.sortDir==="desc"?"desc":"asc");try{let T=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!T.ok)throw new Error("Unable to load oils catalog");let _=await T.json();if(!_||_.success!==!0||!_.result||!Array.isArray(_.result.records))throw new Error("Invalid oils catalog response");if(c!==a.requestToken)return;let I=_.result.records.map(E),h=Math.max(0,parseInt(_.result.next_offset,10)||a.offset+I.length),v=Math.max(I.length,parseInt(_.result.count,10)||0),m=!!_.result.has_more;I.forEach(t=>{a.recordByKey[t.key]=t}),a.visibleRecords=i?I.slice():a.visibleRecords.concat(I),a.offset=h,a.totalCount=v,a.hasMore=m,L(),Y()}catch(T){throw c===a.requestToken&&o("Unable to load oils catalog."),T}finally{c===a.requestToken&&(a.loading=!1,A())}}s.api={fetchCatalogPage:d}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.bulkOils=e.bulkOils||{},y=s.shared,N=s.render,J=s.api;if(!y||!N||!J)return;let{round:H,toNumber:O,clamp:E}=e.helpers,{toGrams:A,fromGrams:G}=e.units,L=e.state,{LOCAL_SORT_KEYS:Y,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:q,queueStateSave:d,showAlert:i,getRefs:a,ensureModalState:r,updateSelectionCounters:c,setSelection:l,removeSelection:T,getRecordByKey:_,serializeSelection:I,restoreState:h}=y,{applyClientOrdering:v,sortButtonsLabel:m,renderVisibleRecords:t}=N,{fetchCatalogPage:f}=J,S=null,M=null;function w(){var W;let k=a();k.modalEl&&(!S&&((W=R.bootstrap)!=null&&W.Modal)&&(S=R.bootstrap.Modal.getOrCreateInstance(k.modalEl)),S&&S.hide())}function P(){return document.getElementById("oilRows")}function F(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function j(k){return String(k||"").trim().toLowerCase()}function u(k){var W;return j((W=k==null?void 0:k.querySelector(".oil-typeahead"))==null?void 0:W.value)}function b(k){var te;let W=String(((te=k==null?void 0:k.querySelector(".oil-gi-id"))==null?void 0:te.value)||"").trim();return W||""}function p(k,W){let te=String(k||"").trim();if(!te)return null;let ie=F(),re=ie.find(he=>String(he.dataset.bulkOilKey||"")===te);if(re)return re;let ge=String((W==null?void 0:W.global_item_id)||"").trim();if(ge&&(re=ie.find(he=>b(he)===ge),re))return re;let Ee=j(W==null?void 0:W.name);return Ee&&(re=ie.find(he=>u(he)===Ee),re)?re:null}function g(k,W){if(!k||!W)return;k.dataset.bulkOilKey=W.key||"";let te=k.querySelector(".oil-typeahead"),ie=k.querySelector(".oil-sap-koh"),re=k.querySelector(".oil-iodine"),ge=k.querySelector(".oil-fatty"),Ee=k.querySelector(".oil-gi-id"),he=k.querySelector(".oil-default-unit"),Ce=k.querySelector(".oil-category"),Oe=k.querySelector(".oil-grams"),we=k.querySelector(".oil-percent");te&&(te.value=W.name||""),ie&&(ie.value=W.sap_koh>0?H(W.sap_koh,3):""),re&&(re.value=W.iodine>0?H(W.iodine,3):""),ge&&(ge.value=W.fatty_profile&&Object.keys(W.fatty_profile).length?JSON.stringify(W.fatty_profile):""),Ee&&(Ee.value=W.global_item_id||""),he&&(he.value=W.default_unit||""),Ce&&(Ce.value=W.ingredient_category_name||""),we&&(we.value=W.selected_pct>0?H(W.selected_pct,2):""),Oe&&(Oe.value=W.selected_weight_g>0?H(G(W.selected_weight_g),2):"")}function C(k){if(!k||!k.key)return null;let W=p(k.key,k),te=P();return!W&&te&&(W=e.oils.buildOilRow(),W&&te.appendChild(W)),g(W,k),W}function x(k,W){let te=p(k,W);te&&(L.lastOilEdit&&L.lastOilEdit.row===te&&(L.lastOilEdit=null,e.oils.clearSelectedOilProfile()),te.remove())}function U(){F().forEach(W=>{L.lastOilEdit&&L.lastOilEdit.row===W&&(L.lastOilEdit=null),W.remove()}),e.oils.clearSelectedOilProfile()}function V(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function z(k,W,te){let ie=String(te||"").trim();if(ie)return ie;let re=String(W||"").trim();if(re)return`global:${re}`;let ge=j(k);return ge?`soapcalc:${ge}`:""}function D(){let k={};return F().forEach(W=>{var Ge,n,B,K,Q,ee,oe,ne,fe;let te=String(((Ge=W.querySelector(".oil-typeahead"))==null?void 0:Ge.value)||"").trim(),ie=O((n=W.querySelector(".oil-sap-koh"))==null?void 0:n.value),re=O((B=W.querySelector(".oil-iodine"))==null?void 0:B.value),ge=String(((K=W.querySelector(".oil-gi-id"))==null?void 0:K.value)||"").trim(),Ee=String(((Q=W.querySelector(".oil-default-unit"))==null?void 0:Q.value)||"gram"),he=String(((ee=W.querySelector(".oil-category"))==null?void 0:ee.value)||""),Ce=E(O((oe=W.querySelector(".oil-percent"))==null?void 0:oe.value),0,100),Oe=E(A((ne=W.querySelector(".oil-grams"))==null?void 0:ne.value),0),we=String(((fe=W.querySelector(".oil-fatty"))==null?void 0:fe.value)||""),xe={};if(we)try{let ye=JSON.parse(we);xe=y.normalizeFattyProfile(ye)}catch{xe={}}let Re=z(te,ge,W.dataset.bulkOilKey);!Re||!(te||Ce>0||Oe>0||ie>0||re>0||Object.keys(xe).length>0)||(W.dataset.bulkOilKey=Re,k[Re]={key:Re,name:te||"Unnamed oil",sap_koh:ie,iodine:re,fatty_profile:xe,default_unit:Ee||"gram",ingredient_category_name:he,global_item_id:ge?parseInt(ge,10):null,source:ge?"global":"soapcalc",is_basic:!ge,selected_pct:Ce,selected_weight_g:Oe})}),k}function $(){let k=r();k.selection=D(),c()}function X(){let k=r(),W=Object.values(k.selection||{}),te=new Set(W.map(ie=>ie.key));F().forEach(ie=>{let re=String(ie.dataset.bulkOilKey||"").trim();(!re||!te.has(re))&&ie.remove()}),W.slice().sort((ie,re)=>String(ie.name||"").localeCompare(String(re.name||""))).forEach(ie=>{C(ie)}),V()}async function Z(){var te;let k=a(),W=r();if(k.modalEl){$(),!S&&((te=R.bootstrap)!=null&&te.Modal)&&(S=R.bootstrap.Modal.getOrCreateInstance(k.modalEl)),k.searchInput&&(k.searchInput.value=W.query||""),k.viewSelectedToggle&&(k.viewSelectedToggle.checked=!!W.viewSelected),k.unitLabelEl&&(k.unitLabelEl.textContent=L.currentUnit||"g"),S&&S.show(),m(),c();try{await f({reset:!0})}catch{i("danger","Unable to load bulk oils catalog right now.")}}}function le(k){let W=k.target;if(!(W instanceof HTMLElement))return;let te=W.closest("tr[data-record-key]");if(!te)return;let ie=te.dataset.recordKey||"",re=_(ie);if(!re)return;let ge=te.querySelector(".bulk-oil-check"),Ee=te.querySelector(".bulk-oil-pct"),he=te.querySelector(".bulk-oil-weight"),Ce=E(O(Ee==null?void 0:Ee.value),0,100),Oe=E(A(he==null?void 0:he.value),0),we=Ce>0||Oe>0;if(!!(ge!=null&&ge.checked)||we){ge&&(ge.checked=!0);let Ge=l(re,{selected_pct:Ce,selected_weight_g:Oe});C(Ge)}else T(ie),x(ie,re);let Re=r();Y.has(Re.sortKey)||Re.viewSelected?(v(),t()):c(),V(),d()}function ue(k){let W=r();W.viewSelected=!!k,v(),t(),d()}async function pe(k){let W=k.target instanceof HTMLElement?k.target.closest(".bulk-oil-sort"):null;if(!W)return;let te=W.getAttribute("data-sort-key")||"name",ie=r();if(ie.sortKey===te?ie.sortDir=ie.sortDir==="asc"?"desc":"asc":(ie.sortKey=te,ie.sortDir=te==="name"?"asc":"desc"),d(),Y.has(ie.sortKey)){v(),t();return}try{await f({reset:!0})}catch{i("danger","Unable to load oils in that sort order.")}}function Se(){let k=r();k.selection={},U(),(Y.has(k.sortKey)||k.viewSelected)&&v(),t(),V(),d()}async function me(){let k=a(),W=r();if(!(!k.scrollEl||W.loading||!W.hasMore||!(k.scrollEl.scrollTop+k.scrollEl.clientHeight>=k.scrollEl.scrollHeight-o)))try{await f({reset:!1})}catch{i("danger","Unable to load more oils right now.")}}function de(){M&&R.clearTimeout(M),M=R.setTimeout(async()=>{try{await f({reset:!0})}catch{i("danger","Unable to search oils right now.")}},q)}function be(){X(),d(),w()}function Te(k,W){if(!(k instanceof HTMLInputElement))return!1;let ie=a().bodyEl;if(!(ie instanceof HTMLElement))return!1;let re=k.classList.contains("bulk-oil-pct")?"bulk-oil-pct":k.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!re)return!1;let ge=Array.from(ie.querySelectorAll(`input.${re}`)),Ee=ge.indexOf(k);if(Ee<0)return!1;let he=Ee+W;if(he<0||he>=ge.length)return!1;let Ce=ge[he];return Ce instanceof HTMLInputElement?(Ce.focus(),typeof Ce.select=="function"&&Ce.select(),!0):!1}function Ae(){var W;let k=a();k.unitLabelEl&&(k.unitLabelEl.textContent=L.currentUnit||"g"),(W=k.modalEl)!=null&&W.classList.contains("show")&&t()}function Le(){let k=a();k.modalEl&&(k.openBtn&&k.openBtn.addEventListener("click",()=>{Z()}),k.searchInput&&k.searchInput.addEventListener("input",()=>{let W=r();W.query=k.searchInput.value||"",d(),de()}),k.viewSelectedToggle&&k.viewSelectedToggle.addEventListener("change",()=>{ue(!!k.viewSelectedToggle.checked)}),k.scrollEl&&k.scrollEl.addEventListener("scroll",me),k.bodyEl&&(k.bodyEl.addEventListener("change",le),k.bodyEl.addEventListener("keydown",W=>{let te=W.target;if(!(!(te instanceof HTMLInputElement)||!(te.classList.contains("bulk-oil-pct")||te.classList.contains("bulk-oil-weight")))){if(W.key==="Enter"){W.preventDefault(),te.blur();return}W.key==="Tab"&&Te(te,W.shiftKey?-1:1)&&W.preventDefault()}})),k.modalEl.querySelectorAll(".bulk-oil-sort").forEach(W=>{W.addEventListener("click",pe)}),k.importBtn&&k.importBtn.addEventListener("click",()=>{be()}),k.clearBtn&&k.clearBtn.addEventListener("click",()=>{Se()}),k.modalEl.addEventListener("shown.bs.modal",()=>{let W=a();W.searchInput&&W.searchInput.focus()}))}Le(),c(),m(),e.bulkOilsModal={openModal:Z,serializeSelection:I,restoreState:h,onUnitChanged:Ae}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:s,round:y,clamp:N,buildSoapcalcSearchBuilder:J}=e.helpers,{formatWeight:H,toGrams:O,fromGrams:E}=e.units,{FRAGRANCE_CATEGORY_SET:A}=e.constants,G=e.state;function L(v,m,t,f,S){var b;let M=document.getElementById(v),w=document.getElementById(m),P=f?document.getElementById(f):null,F=S?document.getElementById(S):null,j=(b=M==null?void 0:M.parentElement)==null?void 0:b.querySelector('[data-role="suggestions"]');if(!M||!j||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let u=J();R.attachMergedInventoryGlobalTypeahead({inputEl:M,listEl:j,mode:"public",giHiddenEl:w,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:u,searchType:"ingredient",resultFilter:(p,g)=>{let C=h(p);return C?t.has(C):g==="inventory"},requireHidden:!1,onSelection:function(p){P&&(P.value=(p==null?void 0:p.default_unit)||""),F&&(F.value=(p==null?void 0:p.ingredient_category_name)||""),e.storage.queueStateSave()}}),M.addEventListener("input",function(){this.value.trim()||(P&&(P.value=""),F&&(F.value=""))})}function Y({pctId:v,weightId:m}){var w,P,F;let t=document.getElementById(v),f=t==null?void 0:t.value;if(f!==""&&f!==null&&f!==void 0)return s(f);let S=N(((P=(w=e.oils)==null?void 0:w.getTotalOilsGrams)==null?void 0:P.call(w))||0,0);if(S<=0)return 0;let M=O((F=document.getElementById(m))==null?void 0:F.value);return M<=0?0:M/S*100}function o(){var v,m,t,f,S,M,w,P;return{lactatePct:Y({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:Y({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:Y({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:Y({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((m=(v=document.getElementById("additiveLactateName"))==null?void 0:v.value)==null?void 0:m.trim())||"Sodium Lactate",sugarName:((f=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:f.trim())||"Sugar",saltName:((M=(S=document.getElementById("additiveSaltName"))==null?void 0:S.value)==null?void 0:M.trim())||"Salt",citricName:((P=(w=document.getElementById("additiveCitricName"))==null?void 0:w.value)==null?void 0:P.trim())||"Citric Acid"}}function q(){var m;return(((m=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:m.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function d(v){let m=N(s(v),0),t=N(Y({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),f=N(Y({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),S=N(Y({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),M=N(Y({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),w=m*(t/100),P=m*(f/100),F=m*(S/100),j=m*(M/100),u=q()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:f,saltPct:S,citricPct:M,lactateG:w,sugarG:P,saltG:F,citricG:j,citricLyeG:j*u}}function i({pctId:v,weightId:m,sourceField:t,totalOils:f}){let S=document.getElementById(v),M=document.getElementById(m);if(!S||!M)return;let w=N(s(f),0);if(w<=0)return;if(t==="weight"){let u=M.value;if(u===""||u===null||u===void 0){S.value="";return}let b=N(O(u),0),p=b>0?b/w*100:0;S.value=p>0?y(p,2):"";return}let P=S.value;if(P===""||P===null||P===void 0){M.value="";return}let F=N(s(P),0),j=w*(F/100);M.value=j>0?y(E(j),2):""}function a(v){let m=(f,S)=>{let M=document.getElementById(f);if(M)if(M.tagName==="INPUT"){if(document.activeElement===M)return;M.value=S}else M.textContent=S},t=f=>f>0?y(E(f),2):"";m("additiveLactateWeight",t(s(v==null?void 0:v.lactateG))),m("additiveSugarWeight",t(s(v==null?void 0:v.sugarG))),m("additiveSaltWeight",t(s(v==null?void 0:v.saltG))),m("additiveCitricWeight",t(s(v==null?void 0:v.citricG))),m("additiveCitricLyeOut",H(s(v==null?void 0:v.citricLyeG)))}function r(v){let m=N(s(v),0),t=d(m);return a(t),t}function c(v){let m=v.querySelector(".fragrance-typeahead"),t=v.querySelector(".fragrance-gi-id"),f=v.querySelector(".fragrance-default-unit"),S=v.querySelector(".fragrance-category"),M=v.querySelector('[data-role="suggestions"]');if(!m||!M||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let w=J();R.attachMergedInventoryGlobalTypeahead({inputEl:m,listEl:M,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:w,searchType:"ingredient",resultFilter:(P,F)=>{let j=h(P);return j?A.has(j):F==="inventory"},requireHidden:!1,onSelection:function(P){f&&(f.value=(P==null?void 0:P.default_unit)||""),S&&(S.value=(P==null?void 0:P.ingredient_category_name)||""),e.storage.queueStateSave()}}),m.addEventListener("input",function(){this.value.trim()||(f&&(f.value=""),S&&(S.value=""))})}function l(){var t,f;let v=document.getElementById("fragranceRowTemplate"),m=(f=(t=v==null?void 0:v.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:f.cloneNode(!0);return m?(m.querySelectorAll("input").forEach(S=>{S.value=""}),c(m),m.querySelectorAll(".unit-suffix").forEach(S=>{S.dataset.suffix=G.currentUnit}),m):document.createElement("div")}function T(v){let m=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=N(v||e.oils.getTotalOilsGrams()||0,0),f=0,S=0;m.forEach(P=>{let F=P.querySelector(".fragrance-grams"),j=P.querySelector(".fragrance-percent");if(!F||!j)return;let u=F.value,b=j.value,p=O(u),g=N(s(b),0),C=e.state.lastFragranceEdit,x=C&&C.row===P?C.field:null;t>0&&(x==="percent"?(p=t*(g/100),F.value=p>0?y(E(p),2):""):x==="grams"?(g=p/t*100,j.value=g>0?y(g,2):""):p>0?(g=p/t*100,document.activeElement!==j&&(j.value=y(g,2))):g>0&&(p=t*(g/100),document.activeElement!==F&&(F.value=y(E(p),2)))),p>0&&(f+=p),S+=g});let M=document.getElementById("fragrancePercentTotal");M&&(M.textContent=y(S,2));let w=document.getElementById("fragranceTotalComputed");return w&&(w.textContent=f>0?H(f):"--"),{totalGrams:f,totalPct:S}}function _(){let v=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(m=>{var F,j,u,b,p,g,C;let t=((j=(F=m.querySelector(".fragrance-typeahead"))==null?void 0:F.value)==null?void 0:j.trim())||"",f=((u=m.querySelector(".fragrance-grams"))==null?void 0:u.value)||"",S=((b=m.querySelector(".fragrance-percent"))==null?void 0:b.value)||"",M=((p=m.querySelector(".fragrance-gi-id"))==null?void 0:p.value)||"",w=((g=m.querySelector(".fragrance-default-unit"))==null?void 0:g.value)||"",P=((C=m.querySelector(".fragrance-category"))==null?void 0:C.value)||"";!t&&!f&&!S&&!M||v.push({name:t,grams:f,percent:S,gi:M,defaultUnit:w,categoryName:P})}),v}function I(v){let m=document.getElementById("soapVisualGuidanceList");if(!m)return;let t=Array.isArray(v==null?void 0:v.tips)&&v.tips.length?v.tips:["No visual flags detected for this formula."];m.innerHTML=t.map(f=>`<li>${f}</li>`).join("")}function h(v){return!v||typeof v!="object"?null:v.ingredient&&v.ingredient.ingredient_category_name||v.ingredient_category_name||v.ingredient_category&&v.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:L,collectAdditiveSettings:o,syncAdditivePair:i,applyComputedOutputs:a,updateAdditivesOutput:r,updateVisualGuidance:I},e.fragrances={buildFragranceRow:l,updateFragranceTotals:T,collectFragranceData:_}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:s}=e.helpers,{STAGE_CONFIGS:y}=e.constants;function N(E){var L;let A=y[E];if(!A)return;let G=document.getElementById(A.tabId);if(G){if((L=R.bootstrap)!=null&&L.Tab)bootstrap.Tab.getOrCreateInstance(G).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),G.classList.add("active"),G.setAttribute("aria-selected","true");let Y=document.getElementById(A.paneId);Y&&Y.classList.add("show","active")}e.layout.scheduleStageHeightSync(),G.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function J(E){var A,G;if(E===1){let L=document.getElementById("unitGrams");L&&(L.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let Y=document.getElementById("moldCylinderCorrection");Y&&(Y.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(A=e.mold)!=null&&A.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(E===2){let L=document.getElementById("oilRows");L&&(L.innerHTML="",L.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(E===3){let L=document.getElementById("lyeTypeNaoh");L&&(L.checked=!0);let Y=document.getElementById("waterMethod");Y&&(Y.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let q=document.getElementById("lyePurity");q&&(q.value="100");let d=document.getElementById("waterPct");d&&(d.value="33");let i=document.getElementById("lyeConcentration");i&&(i.value="33");let a=document.getElementById("waterRatio");a&&(a.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(E===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(L=>{let Y=document.getElementById(L);Y&&(Y.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(L=>{let Y=document.getElementById(L);Y&&(Y.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),E===5){let L=document.getElementById("fragranceRows");L&&(L.innerHTML="",(G=e.fragrances)!=null&&G.buildFragranceRow&&L.appendChild(e.fragrances.buildFragranceRow()));let Y=document.getElementById("fragrancePercentTotal");Y&&(Y.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),O()}function H(E){var A;if(E===1){let G=s(document.getElementById("moldWaterWeight").value),L=s(document.getElementById("oilTotalTarget").value),Y=s(document.getElementById("moldOilPct").value),q=!!document.querySelector('input[name="weight_unit"]:checked')&&(G>0||L>0)&&Y>0;return{state:q?"complete":"incomplete",label:q?"Sized":"Needs target"}}if(E===2){let L=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(Y=>{var i,a,r,c;let o=(a=(i=Y.querySelector(".oil-typeahead"))==null?void 0:i.value)==null?void 0:a.trim(),q=s((r=Y.querySelector(".oil-grams"))==null?void 0:r.value),d=s((c=Y.querySelector(".oil-percent"))==null?void 0:c.value);return o&&(q>0||d>0)});return{state:L?"complete":"incomplete",label:L?"Oils added":"Add oils"}}if(E===3){let G=s(document.getElementById("lyeSuperfat").value),L=(A=document.getElementById("waterMethod"))==null?void 0:A.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!L&&G>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return E===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(L=>s(document.getElementById(L).value)>0)?"Added":"Optional"}:E===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(Y=>{var i,a,r,c;let o=(a=(i=Y.querySelector(".fragrance-typeahead"))==null?void 0:i.value)==null?void 0:a.trim(),q=s((r=Y.querySelector(".fragrance-grams"))==null?void 0:r.value),d=s((c=Y.querySelector(".fragrance-percent"))==null?void 0:c.value);return o||q>0||d>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function O(){let E=document.getElementById("soapStageTabList");E&&E.querySelectorAll(".soap-stage-status").forEach(G=>G.remove());let A=document.getElementById("soapStageProgress");A&&(A.textContent="")}e.stages={openStageByIndex:N,resetStage:J,updateStageStatuses:O}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y,clamp:N}=e.helpers,{computeFattyAcids:J,computeQualities:H,computeOilQualityScores:O}=e.calc,{QUALITY_RANGES:E,QUALITY_HINTS:A,QUALITY_FEEL_HINTS:G,IODINE_RANGE:L,IODINE_SCALE_MAX:Y,INS_RANGE:o,INS_SCALE_MAX:q,QUALITY_BASE:d,QUALITY_PRESETS:i,FATTY_BAR_COLORS:a,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:c,showSoapAlert:l}=e.ui;function T({barId:P,fillId:F,value:j,max:u,label:b}){let p=document.getElementById(P),g=document.getElementById(F);if(!p||!g)return null;let C=isFinite(j)?j:0,x=Math.max(0,Math.min(u,C)),U=u>0?x/u*100:0;return g.style.width=`${U}%`,p.setAttribute("aria-valuemin","0"),p.setAttribute("aria-valuemax",String(u)),p.setAttribute("aria-valuenow",x.toFixed(1)),b&&p.setAttribute("aria-label",b),{bar:p,fill:g,value:C}}function _(P,F,j){if(!(!P||!j)){if(P.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(F)){P.classList.add("bg-secondary");return}F<j[0]?P.classList.add("bg-warning"):F>j[1]?P.classList.add("bg-danger"):P.classList.add("bg-success")}}function I(P,F,j,u,b,p){let g=T({barId:P,fillId:F,value:j,max:b,label:p});g&&_(g.fill,j,u)}function h(){let P={hardness:{range:E.hardness,scale:100},cleansing:{range:E.cleansing,scale:100},conditioning:{range:E.conditioning,scale:100},bubbly:{range:E.bubbly,scale:100},creamy:{range:E.creamy,scale:100},iodine:{range:L,scale:Y},ins:{range:o,scale:q}};Object.entries(P).forEach(([F,j])=>{let[u,b]=j.range,p=j.scale,g=F.charAt(0).toUpperCase()+F.slice(1),C=F==="iodine"?"iodineBar":F==="ins"?"insBar":`quality${g}Bar`,x=document.getElementById(`quality${g}Safe`);if(x){let D=Math.max(0,Math.min(100,u/p*100)),$=Math.max(0,Math.min(100,(b-u)/p*100));x.style.left=`${D}%`,x.style.width=`${$}%`,x.title=`Safe range ${s(u,0)}-${s(b,0)}`}let U=document.getElementById(C);U&&(U.dataset.safeRange=`${s(u,0)}-${s(b,0)}`);let V=document.getElementById(`quality${g}RangeMin`),z=document.getElementById(`quality${g}RangeMax`);V&&(V.textContent=s(u,0)),z&&(z.textContent=s(b,0))})}function v(P,F){let j=N(P.hardness||0,0,100),u=N(P.bubbly||0,0,100),b=N(P.conditioning||0,0,100),p=N(b+(F||0)*3,0,100),g=document.getElementById("feelHardness"),C=document.getElementById("feelBubbly"),x=document.getElementById("feelConditioning"),U=document.getElementById("feelGreasy");g&&(g.value=s(j,1)),C&&(C.value=s(u,1)),x&&(x.value=s(b,1)),U&&(U.value=s(p,1))}function m(P){r.forEach(F=>{let j=document.getElementById(`fattyBar${F.charAt(0).toUpperCase()}${F.slice(1)}`);if(!j)return;let u=N(y(P[F]),0,100),b=u;j.style.width=`${b}%`,j.style.backgroundColor=a[F]||"var(--color-muted)",j.title=`${F.charAt(0).toUpperCase()}${F.slice(1)}: ${s(u,1)}%`})}function t(){var u;let P=((u=document.getElementById("qualityPreset"))==null?void 0:u.value)||"balanced",F=Array.from(document.querySelectorAll(".quality-focus:checked"));if(P==="none"&&!F.length)return null;let j=P==="none"?{...d}:i[P]?{...i[P]}:{...d};return F.forEach(b=>{let p=b.dataset.attr,g=b.dataset.direction,C=E[p];C&&(j[p]=g==="low"?C[0]:C[1])}),j}function f(){let P=t(),F={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(F).forEach(([j,u])=>{if(!u)return;let b=document.getElementById(`${u.id}Label`);if(!P){u.classList.add("d-none"),b&&(b.textContent="");return}let p=y(P[j]);if(!isFinite(p)){u.classList.add("d-none"),b&&(b.textContent="");return}let g=j==="iodine"?Y:j==="ins"?q:100,C=N(p,0,g);u.classList.remove("d-none"),u.style.left=`${C/g*100}%`,u.setAttribute("aria-label",`Apply ${j} target`),u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.title=`Target ${j}: ${s(p,1)}`,b&&(b.textContent=s(p,1))})}function S(){let P=t();if(!P){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let j=Array.from(document.querySelectorAll("#oilRows .oil-row")).map($=>{var ue,pe;let X=e.units.toGrams((ue=$.querySelector(".oil-grams"))==null?void 0:ue.value),Z=((pe=$.querySelector(".oil-fatty"))==null?void 0:pe.value)||"",le=null;if(Z)try{le=JSON.parse(Z)}catch{le=null}return{row:$,grams:X,fattyProfile:le}}).filter($=>$.grams>0);if(!j.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let u=J(j.map($=>({grams:$.grams,fattyProfile:$.fattyProfile}))),b=H(u.percent),p={hardness:N((P.hardness-b.hardness)/100,-1,1),cleansing:N((P.cleansing-b.cleansing)/100,-1,1),conditioning:N((P.conditioning-b.conditioning)/100,-1,1),bubbly:N((P.bubbly-b.bubbly)/100,-1,1),creamy:N((P.creamy-b.creamy)/100,-1,1)},g=j.reduce(($,X)=>$+X.grams,0),C=[],x=0,U=.8,V=j.filter($=>!$.fattyProfile||typeof $.fattyProfile!="object").length;if(V===j.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(V&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),j.forEach($=>{let X=O($.fattyProfile),Z=p.hardness*X.hardness+p.cleansing*X.cleansing+p.conditioning*X.conditioning+p.bubbly*X.bubbly+p.creamy*X.creamy,le=N(1+Z*U,.2,1.8),ue=$.grams*le;C.push({row:$.row,grams:ue}),x+=ue}),x<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let z=g/x,D=e.oils.getOilTargetGrams()||g;C.forEach($=>{let X=$.grams*z,Z=$.row.querySelector(".oil-grams"),le=$.row.querySelector(".oil-percent");if(Z&&(Z.value=X>0?s(e.units.fromGrams(X),2):""),le&&D>0){let ue=X/D*100;le.value=ue>0?s(ue,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function M(P){let{qualities:F,fattyPercent:j,coveragePct:u,iodine:b,ins:p,sapAvg:g,superfat:C,warnings:x}=P,U=u>0;function V(me,de){var W,te;let be=document.getElementById(`quality${me}Value`),Te=document.getElementById(`quality${me}Hint`);if(!be)return;be.textContent=U&&isFinite(de)?s(de,1):"--",c(be);let Ae=me.toLowerCase(),Le=E[Ae],k=T({barId:`quality${me}Bar`,fillId:`quality${me}Fill`,value:U?de:0,max:100,label:me});k&&Le&&(_(k.fill,de,Le),U&&isFinite(de)?k.bar.title=`${me}: ${s(de,1)} (safe ${Le[0]}-${Le[1]}). ${A[Ae]||""}`.trim():k.bar.title=`${me}: -- (safe ${Le[0]}-${Le[1]}). ${A[Ae]||""}`.trim()),Te&&Le&&(!U||!isFinite(de)?Te.textContent="":de<Le[0]?Te.textContent=((W=G[Ae])==null?void 0:W.low)||"":de>Le[1]?Te.textContent=((te=G[Ae])==null?void 0:te.high)||"":Te.textContent="")}V("Hardness",F.hardness),V("Cleansing",F.cleansing),V("Conditioning",F.conditioning),V("Bubbly",F.bubbly),V("Creamy",F.creamy);let z=document.getElementById("fattyCoverageNote");z&&(z.textContent=u>0?`Fatty acid coverage: ${s(u,1)}% of oils`:"Fatty acid coverage: not enough data yet");let D=document.getElementById("iodineValue"),$=document.getElementById("insValue"),X=document.getElementById("sapAvgValue");D&&(D.textContent=b>0?s(b,1):"--",c(D)),$&&($.textContent=p>0?s(p,1):"--",c($)),X&&(X.textContent=g>0?s(g,1):"--",c(X)),I("iodineBar","iodineFill",b,L,Y,"Iodine"),I("insBar","insFill",p,o,q,"INS");let Z=(j.lauric||0)+(j.myristic||0)+(j.palmitic||0)+(j.stearic||0),le=(j.ricinoleic||0)+(j.oleic||0)+(j.linoleic||0)+(j.linolenic||0),ue=document.getElementById("fattySatRatioResult");ue&&(ue.textContent=Z+le>0?`${s(Z,0)}:${s(le,0)}`:"--",c(ue)),r.forEach(me=>{let de=`fatty${me.charAt(0).toUpperCase()}${me.slice(1)}`,be=j[me];document.getElementById(de).textContent=U&&be?`${s(be,1)}%`:"--"}),v(F,C||0),m(j),f();let pe=Array.isArray(x)?x.slice():[],Se=document.getElementById("soapQualityWarnings");pe.length?(Se.classList.remove("d-none"),Se.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${pe.map(me=>`<li>${me}</li>`).join("")}</ul>`):(Se.classList.add("d-none"),Se.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var P;document.querySelectorAll(".soap-quality-help").forEach(F=>{let j=F.dataset.quality;A[j]&&F.setAttribute("title",A[j])}),(P=R.bootstrap)!=null&&P.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(F=>{bootstrap.Tooltip.getOrCreateInstance(F)})}e.quality={setQualityRangeBars:h,updateQualityTargets:f,applyQualityTargets:S,updateQualitiesDisplay:M,initQualityTooltips:w}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y,clamp:N}=e.helpers;function J(o){let q=0,d=0;return(o||[]).forEach(i=>{let a=y(i==null?void 0:i.sapKoh),r=y(i==null?void 0:i.grams);a>0&&r>0&&(q+=a*r,d+=r)}),d>0?q/d:0}function H(o){var T,_,I,h,v,m,t,f,S,M,w,P;let q=o.qualityReport||{},d=q.fatty_acids_pct||{},i=q.qualities||{},a=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:y(q.sap_avg_koh)||J(o.oils||[]),r=y(q.iodine),c=y(q.ins)||(a&&r?a-r:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((T=document.getElementById("qualityPreset"))==null?void 0:T.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(F=>F.id),mold:l,oils:(o.oils||[]).map(F=>({name:F.name||null,grams:s(F.grams||0,2),iodine:F.iodine||null,sap_koh:F.sapKoh||null,fatty_profile:F.fattyProfile||null,global_item_id:F.global_item_id||null,default_unit:F.default_unit||null,ingredient_category_name:F.ingredient_category_name||null})),totals:{total_oils_g:s(o.totalOils||0,2),batch_yield_g:s(o.batchYield||0,2),lye_pure_g:s(o.lyePure||0,2),lye_adjusted_g:s(o.lyeAdjusted||0,2),water_g:s(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((_=o.additives)==null?void 0:_.fragrancePct)||0,lactate_pct:((I=o.additives)==null?void 0:I.lactatePct)||0,sugar_pct:((h=o.additives)==null?void 0:h.sugarPct)||0,salt_pct:((v=o.additives)==null?void 0:v.saltPct)||0,citric_pct:((m=o.additives)==null?void 0:m.citricPct)||0,fragrance_g:s(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:s(((f=o.additives)==null?void 0:f.lactateG)||0,2),sugar_g:s(((S=o.additives)==null?void 0:S.sugarG)||0,2),salt_g:s(((M=o.additives)==null?void 0:M.saltG)||0,2),citric_g:s(((w=o.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:s(((P=o.additives)==null?void 0:P.citricLyeG)||0,2)},qualities:{hardness:s(i.hardness||0,1),cleansing:s(i.cleansing||0,1),conditioning:s(i.conditioning||0,1),bubbly:s(i.bubbly||0,1),creamy:s(i.creamy||0,1),iodine:s(r||0,1),ins:s(c||0,1),sap_avg:s(a||0,1)},fatty_acids:d,updated_at:new Date().toISOString()}}function O(o,q,d,i,a){var _,I,h,v,m;let r=(I=(_=document.getElementById(o))==null?void 0:_.value)==null?void 0:I.trim(),c=((h=document.getElementById(q))==null?void 0:h.value)||"",l=i&&((v=document.getElementById(i))==null?void 0:v.value)||"",T=a&&((m=document.getElementById(a))==null?void 0:m.value)||"";return{name:r||d,globalItemId:c?parseInt(c):void 0,defaultUnit:l||void 0,categoryName:T||void 0}}function E(o){let q=[],d=N(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(i=>{var v,m,t,f,S,M,w;let a=(m=(v=i.querySelector(".fragrance-typeahead"))==null?void 0:v.value)==null?void 0:m.trim(),r=((t=i.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",c=((f=i.querySelector(".fragrance-default-unit"))==null?void 0:f.value)||"",l=((S=i.querySelector(".fragrance-category"))==null?void 0:S.value)||"",T=(M=i.querySelector(".fragrance-grams"))==null?void 0:M.value,_=(w=i.querySelector(".fragrance-percent"))==null?void 0:w.value,I=e.units.toGrams(T),h=N(y(_),0);I<=0&&h>0&&d>0&&(I=d*(h/100)),!(!a&&!r&&I<=0)&&q.push({name:a||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:c||void 0,categoryName:l||void 0,grams:I,pct:h})}),q}function A(o,q){let d=[];return document.querySelectorAll(`#${o} .row`).forEach(function(i){var _,I,h;let a=(I=(_=i.querySelector(".tool-typeahead"))==null?void 0:_.value)==null?void 0:I.trim(),r=((h=i.querySelector(".tool-gi-id"))==null?void 0:h.value)||"",c=i.querySelector(".tool-qty"),l=i.querySelector(".tool-unit"),T=c&&c.value!=="";!a&&!r||(q==="container"?d.push({name:a||void 0,global_item_id:r?parseInt(r):void 0,quantity:T?parseFloat(c.value):1}):d.push({name:a||void 0,global_item_id:r?parseInt(r):void 0,quantity:T?parseFloat(c.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),d}function G(o){let q=e.config.isAuthenticated?"member":"public",d=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:q,mode:d,unitOptionsHtml:e.config.unitOptionsHtml})}function L(o,q){let d=G(o),i=d.querySelector(".tool-typeahead"),a=d.querySelector(".tool-qty");i&&(i.value=q),a&&o==="container"&&(a.value=1),o==="container"?document.getElementById("tool-containers").appendChild(d):o==="consumable"?document.getElementById("tool-consumables").appendChild(d):document.getElementById("tool-ingredients").appendChild(d)}function Y(o){var r,c,l,T;let q=H(o),d=(o.oils||[]).map(_=>({name:_.name||void 0,global_item_id:_.global_item_id||void 0,quantity:_.grams,unit:"gram",default_unit:_.default_unit||void 0,ingredient_category_name:_.ingredient_category_name||void 0})),i=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&d.push({name:i,quantity:s(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&d.push({name:"Distilled Water",quantity:s(o.water,2),unit:"gram"}),E(o.totalOils||0).forEach(_=>{_.grams>0&&d.push({name:_.name,global_item_id:_.globalItemId,quantity:s(_.grams,2),unit:"gram",default_unit:_.defaultUnit,ingredient_category_name:_.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let _=O("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");d.push({name:_.name,global_item_id:_.globalItemId,quantity:s(o.additives.lactateG,2),unit:"gram",default_unit:_.defaultUnit,ingredient_category_name:_.categoryName})}if(((c=o.additives)==null?void 0:c.sugarG)>0){let _=O("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");d.push({name:_.name,global_item_id:_.globalItemId,quantity:s(o.additives.sugarG,2),unit:"gram",default_unit:_.defaultUnit,ingredient_category_name:_.categoryName})}if(((l=o.additives)==null?void 0:l.saltG)>0){let _=O("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");d.push({name:_.name,global_item_id:_.globalItemId,quantity:s(o.additives.saltG,2),unit:"gram",default_unit:_.defaultUnit,ingredient_category_name:_.categoryName})}if(((T=o.additives)==null?void 0:T.citricG)>0){let _=O("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");d.push({name:_.name,global_item_id:_.globalItemId,quantity:s(o.additives.citricG,2),unit:"gram",default_unit:_.defaultUnit,ingredient_category_name:_.categoryName}),d.push({name:"Extra Lye for Citric Acid",quantity:s(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:d.concat(A("tool-ingredients","ingredient")),consumables:A("tool-consumables","consumable"),containers:A("tool-containers","container"),notes:JSON.stringify(q)}}e.recipePayload={collectFragranceRows:E,collectDraftLines:A,buildLineRow:G,addStubLine:L,buildSoapRecipePayload:Y}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y,clamp:N}=e.helpers,{formatWeight:J,formatPercent:H}=e.units;function O(){var T;let i=((T=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:T.value)||"NaOH",a=document.getElementById("lyePurity"),r=a==null?void 0:a.value,c=y(a==null?void 0:a.value),l=i==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(c))&&(c=100),{selected:i,lyeType:l,purity:c}}function E(){let i=document.getElementById("lyePurity"),a=O();if(i)if(i.removeAttribute("readonly"),a.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function A(i){return i==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":i==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function G(i=null,a=null){var T;let r=document.getElementById("stageWaterOutput"),c=document.getElementById("stageWaterComputedHint"),l=a||(i==null?void 0:i.waterMethod)||((T=document.getElementById("waterMethod"))==null?void 0:T.value)||"percent";if(r){let _=i&&isFinite(i.waterG)&&i.waterG>0;r.textContent=_?J(i.waterG):"--"}if(c){if(!i||!isFinite(i.totalOils)||i.totalOils<=0){c.textContent=`Set oils in Stage 2 to calculate water. ${A(l)}`;return}if(l==="concentration"){let _=i.lyeConcentrationInput||i.lyeConcentration||0;c.textContent=`Using ${s(_,1)}% lye concentration from ${J(i.lyeAdjusted||0)} lye.`;return}if(l==="ratio"){let _=i.waterRatioInput||i.waterRatio||0;c.textContent=`Using ${s(_,2)} : 1 water-to-lye ratio from ${J(i.lyeAdjusted||0)} lye.`;return}c.textContent=`Using ${s(i.waterPct||0,1)}% of total oils (${J(i.totalOils)}).`}}function L(i=null,a=null){var M;let r=document.getElementById("lyeWaterPreviewAnchor"),c=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),T=document.getElementById("concPreview"),_=document.getElementById("ratioPreview");if(!r&&!c&&!l&&!T&&!_)return;let I=(w,P)=>{w&&(w.textContent=P)},h=a||(i==null?void 0:i.waterMethod)||((M=document.getElementById("waterMethod"))==null?void 0:M.value)||"percent",v=y(i==null?void 0:i.totalOils),m=y(i==null?void 0:i.lyeAdjusted),t=y(i==null?void 0:i.waterG);if(v<=0||m<=0){I(r,"Based on -- oils. All values update live as you change inputs."),I(c,"--"),I(l,"--"),I(T,"--"),I(_,"--");return}let f=y(i==null?void 0:i.lyeConcentration)>0?y(i==null?void 0:i.lyeConcentration):m+t>0?m/(m+t)*100:0,S=y(i==null?void 0:i.waterRatio)>0?y(i==null?void 0:i.waterRatio):m>0?t/m:0;if(I(r,`Based on ${J(v)} oils. All values update live as you change inputs.`),I(c,J(m)),I(l,J(t)),I(T,f>0?H(f):"--"),I(_,S>0?`${s(S,2)} : 1`:"--"),h==="concentration"){let w=y(i==null?void 0:i.lyeConcentrationInput);w>0&&I(T,H(w))}if(h==="ratio"){let w=y(i==null?void 0:i.waterRatioInput);w>0&&I(_,`${s(w,2)} : 1`)}}function Y(){var a;let i=((a=document.getElementById("waterMethod"))==null?void 0:a.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==i)}),G(null,i),L(null,i)}function o(){let i=e.oils.updateOilTotals(),a=i.totalWeight,r=i.totalPct,c=[],l=e.oils.collectOilData(),T=e.oils.getOilTargetGrams(),I=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(h=>N(y(h.value),0)).some(h=>h>0);return(!l.length||a<=0)&&c.push("Add at least one oil with a weight or percent."),!T&&a<=0&&I&&c.push("Enter a total oils target or weights to convert percentages."),T>0&&r>0&&Math.abs(r-100)>.5&&c.push("Oil percentages should total 100% (use Normalize to fix)."),T>0&&a>T+.01?c.push("Oil weights exceed the mold target."):!T&&r>100.01&&c.push("Oil percentages exceed 100%."),{ok:c.length===0,errors:c,totals:i,oils:l}}function q(){let i=document.getElementById("lyeSuperfat"),a=i==null?void 0:i.value,r=y(a);return(a===""||a===null||a===void 0||!isFinite(r))&&(r=5),r}function d(){var _,I,h,v;let a=O().purity;isFinite(a)||(a=100);let r=((_=document.getElementById("waterMethod"))==null?void 0:_.value)||"percent",c=y((I=document.getElementById("waterPct"))==null?void 0:I.value),l=y((h=document.getElementById("lyeConcentration"))==null?void 0:h.value),T=y((v=document.getElementById("waterRatio"))==null?void 0:v.value);return{purity:a,waterMethod:r,waterPct:c,lyeConcentration:l,waterRatio:T}}e.runnerInputs={getLyeSelection:O,applyLyeSelection:E,setWaterMethod:Y,updateStageWaterSummary:G,updateLiveCalculationPreview:L,validateCalculation:o,readSuperfatInput:q,sanitizeLyeInputs:d}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{getStorage:s}=e.helpers;function y(){if(!e.config.calcLimit)return{count:0,date:null};let E=s();if(!E)return{count:0,date:null};try{let A=E.getItem("soap_calc_usage"),G=new Date().toISOString().slice(0,10);if(!A)return{count:0,date:G};let L=JSON.parse(A);return!L||L.date!==G?{count:0,date:G}:{count:Number(L.count)||0,date:G}}catch{return{count:0,date:null}}}function N(E){if(!e.config.calcLimit)return;let A=s();if(!A)return;let G=new Date().toISOString().slice(0,10);try{A.setItem("soap_calc_usage",JSON.stringify({count:E,date:G}))}catch{}}function J(){return e.config.calcLimit&&y().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function H(){if(!e.config.calcLimit)return;let A=y().count+1;N(A);let G=Math.max(0,e.config.calcLimit-A);G<=1&&e.ui.showSoapAlert("info",`You have ${G} calculation${G===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function O(E){if(!e.config.calcLimit||E===null||E>1)return;let A=document.getElementById("soapSignupModal");A&&(R.bootstrap&&R.bootstrap.Modal?R.bootstrap.Modal.getOrCreateInstance(A).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:J,consumeCalcQuota:H,maybeShowSignupModal:O}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.state;function y({oils:J,selection:H,superfat:O,purity:E,waterMethod:A,waterPct:G,lyeConcentration:L,waterRatio:Y,totalOils:o}){let q=e.additives.collectAdditiveSettings(),d=e.recipePayload.collectFragranceRows(o||0);return{oils:(J||[]).map(i=>({name:i.name||null,grams:i.grams||0,sap_koh:i.sapKoh||0,iodine:i.iodine||0,fatty_profile:i.fattyProfile||null,global_item_id:i.global_item_id||null,default_unit:i.default_unit||null,ingredient_category_name:i.ingredient_category_name||null})),fragrances:d.map(i=>({name:i.name||"Fragrance/Essential Oils",grams:i.grams||0,pct:i.pct||0})),additives:{lactate_pct:q.lactatePct||0,sugar_pct:q.sugarPct||0,salt_pct:q.saltPct||0,citric_pct:q.citricPct||0,lactate_name:q.lactateName||"Sodium Lactate",sugar_name:q.sugarName||"Sugar",salt_name:q.saltName||"Salt",citric_name:q.citricName||"Citric Acid"},lye:{selected:(H==null?void 0:H.selected)||"NaOH",superfat:O,purity:E},water:{method:A,water_pct:G,lye_concentration:L,water_ratio:Y},meta:{unit_display:s.currentUnit||"g"}}}async function N(J){var A;let H=((A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"))||"",O=new AbortController,E=R.setTimeout(()=>O.abort(),2500);try{let G=await fetch("/tools/api/soap/calculate",{method:"POST",signal:O.signal,headers:{"Content-Type":"application/json",...H?{"X-CSRFToken":H}:{}},body:JSON.stringify(J||{})});if(!G.ok)return null;let L=await G.json();return!L||L.success!==!0||typeof L.result!="object"?null:L.result}catch{return null}finally{R.clearTimeout(E)}}e.runnerService={buildServicePayload:y,calculateWithSoapService:N}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:s,toNumber:y}=e.helpers,{formatWeight:N,formatPercent:J}=e.units,H=e.state,O={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function E(o){return(o||[]).map(q=>{var d;return{name:q.name||null,grams:y(q.grams),sapKoh:y((d=q.sap_koh)!=null?d:q.sapKoh),iodine:y(q.iodine),fattyProfile:q.fatty_profile||q.fattyProfile||null,global_item_id:q.global_item_id||null,default_unit:q.default_unit||null,ingredient_category_name:q.ingredient_category_name||null}})}function A(o,q){let d=document.getElementById(o);d&&(d.textContent=q)}function G({resultsCard:o,lyeAdjusted:q,waterData:d,batchYield:i,totalOils:a,superfat:r}){let c=document.getElementById("resultsCard");c&&(c.style.display="block");let l=y(o.water_lye_ratio)||d.waterRatio;A("lyeAdjustedOutput",N(y(o.lye_adjusted_g)||q)),A("waterOutput",N(y(o.water_g)||d.waterG)),A("batchYieldOutput",N(i)),A("lyeConcentrationOutput",J(y(o.lye_concentration_pct)||d.lyeConcentration)),A("waterRatioOutput",isFinite(l)&&l>0?s(l,2).toString():"--"),A("totalOilsOutput",N(a)),A("superfatOutput",J(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(T=>e.ui.pulseValue(document.getElementById(T)))}function L({showAlerts:o,lyeTotals:q,purity:d,waterData:i}){if(!o)return;q.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),d<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${s(d,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(i.lyeConcentration<25||i.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let a=e.mold.getMoldSettings();a.shape==="cylinder"&&a.waterWeight>0&&!a.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function Y({serviceResult:o,validation:q,selection:d,superfat:i,purity:a,waterMethod:r,waterPct:c,lyeConcentrationInput:l,waterRatioInput:T,showAlerts:_}){var $;let I=o.lye_type||d.lyeType||"NaOH",h=o.lye_selected||d.selected||null,v=y(o.total_oils_g)||q.totals.totalWeight,m=y(o.superfat_pct),t=isFinite(m)?m:i,f={sapAvg:y(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},S=y(o.lye_pure_g),w=Object.prototype.hasOwnProperty.call(o,"lye_adjusted_base_g")?y(o.lye_adjusted_base_g):null,P=y(o.lye_adjusted_g),F=y(o.lye_purity_pct)||a,j=o.water_method||r,u=y(o.water_pct)||c,b=y(o.lye_concentration_input_pct)||l,p=y(o.water_ratio_input)||T,g={waterG:y(o.water_g),lyeConcentration:y(o.lye_concentration_pct),waterRatio:y(o.water_lye_ratio)},C=o.results_card||{},x=o.quality_report||{},U=E(o.oils||q.oils),V={waterG:g.waterG,lyeAdjusted:P,totalOils:v,waterMethod:j,waterPct:u,lyeConcentrationInput:b,waterRatioInput:p,lyeConcentration:g.lyeConcentration,waterRatio:g.waterRatio};e.runnerInputs.updateStageWaterSummary(V),e.runnerInputs.updateLiveCalculationPreview(V);let z=o.additives||O;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(z);let D=y(C.batch_yield_g)||v+P+g.waterG+z.fragranceG+z.lactateG+z.sugarG+z.saltG+z.citricG;return($=e.mold)!=null&&$.updateWetBatterWarning&&e.mold.updateWetBatterWarning(D),G({resultsCard:C,lyeAdjusted:P,waterData:g,batchYield:D,totalOils:v,superfat:t}),e.ui.updateResultsWarnings(g),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:x.qualities||{},fattyPercent:x.fatty_acids_pct||{},coveragePct:y(x.coverage_pct),iodine:y(x.iodine),ins:y(x.ins),sapAvg:f.sapAvg,superfat:t,waterData:g,additives:z,oils:U,totalOils:v,warnings:x.warnings||[]}),e.additives.updateVisualGuidance({tips:x.visual_guidance||[]}),e.stages.updateStageStatuses(),L({showAlerts:_,lyeTotals:f,purity:F,waterData:g}),H.lastCalc={totalOils:v,oils:U,lyeType:I,lyeSelected:h,superfat:t,purity:F,lyePure:S,lyeAdjustedBase:w,lyeAdjusted:P,water:g.waterG,waterMethod:j,waterPct:u,lyeConcentration:g.lyeConcentration,waterRatio:g.waterRatio,sapAvg:f.sapAvg,usedSapFallback:f.usedFallback,additives:z,batchYield:D,qualityReport:x,export:o.export||null},H.lastCalc}e.runnerRender={applyServiceResult:Y}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},s=e.state,y=e.runnerInputs,N=e.runnerQuota,J=e.runnerService,H=e.runnerRender;async function O(E={}){var G;let A={consumeQuota:!1,showAlerts:!0,...E};try{A.showAlerts&&e.ui.clearSoapAlerts();let L=y.validateCalculation();if(!L.ok)return y.updateStageWaterSummary(null),y.updateLiveCalculationPreview(null),(G=e.mold)!=null&&G.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),A.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${L.errors.map(c=>`<li>${c}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(A.consumeQuota&&!N.canConsumeCalcQuota())return null;let Y=y.readSuperfatInput(),o=y.getLyeSelection(),q=y.sanitizeLyeInputs(),d=(s.calcRequestSeq||0)+1;s.calcRequestSeq=d;let i=J.buildServicePayload({oils:L.oils,selection:o,superfat:Y,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentration:q.lyeConcentration,waterRatio:q.waterRatio,totalOils:L.totals.totalWeight}),a=await J.calculateWithSoapService(i);if(d!==s.calcRequestSeq)return s.lastCalc;if(!a)return A.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=H.applyServiceResult({serviceResult:a,validation:L,selection:o,superfat:Y,purity:q.purity,waterMethod:q.waterMethod,waterPct:q.waterPct,lyeConcentrationInput:q.lyeConcentration,waterRatioInput:q.waterRatio,showAlerts:A.showAlerts});return A.consumeQuota&&N.consumeCalcQuota(),r}catch{return A.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...E)=>y.getLyeSelection(...E),applyLyeSelection:(...E)=>y.applyLyeSelection(...E),setWaterMethod:(...E)=>y.setWaterMethod(...E),updateLiveCalculationPreview:(...E)=>y.updateLiveCalculationPreview(...E),calculateAll:O,buildSoapRecipePayload:(...E)=>e.recipePayload.buildSoapRecipePayload(...E),buildLineRow:(...E)=>e.recipePayload.buildLineRow(...E),addStubLine:(...E)=>e.recipePayload.addStubLine(...E),maybeShowSignupModal:(...E)=>N.maybeShowSignupModal(...E)}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{formatTime:s,getStorage:y}=e.helpers,N="soap_tool_state_v2";function J(d,i){let a=[];return document.querySelectorAll(`#${d} .row`).forEach(c=>{var v,m,t;let l=(m=(v=c.querySelector(".tool-typeahead"))==null?void 0:v.value)==null?void 0:m.trim(),T=((t=c.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",_=c.querySelector(".tool-qty"),I=c.querySelector(".tool-unit"),h=_&&_.value!==""?e.helpers.toNumber(_.value):null;!l&&!T||(i==="container"?a.push({name:l||"",global_item_id:T?parseInt(T):null,quantity:h&&h>0?h:1}):a.push({name:l||"",global_item_id:T?parseInt(T):null,quantity:h&&h>=0?h:0,unit:(I==null?void 0:I.value)||"gram"}))}),a}function H(){let d=[];return document.querySelectorAll("#oilRows .oil-row").forEach(i=>{var m,t,f,S,M,w,P,F,j,u;let a=((t=(m=i.querySelector(".oil-typeahead"))==null?void 0:m.value)==null?void 0:t.trim())||"",r=((f=i.querySelector(".oil-grams"))==null?void 0:f.value)||"",c=((S=i.querySelector(".oil-percent"))==null?void 0:S.value)||"",l=((M=i.querySelector(".oil-sap-koh"))==null?void 0:M.value)||"",T=((w=i.querySelector(".oil-iodine"))==null?void 0:w.value)||"",_=((P=i.querySelector(".oil-fatty"))==null?void 0:P.value)||"",I=((F=i.querySelector(".oil-gi-id"))==null?void 0:F.value)||"",h=((j=i.querySelector(".oil-default-unit"))==null?void 0:j.value)||"",v=((u=i.querySelector(".oil-category"))==null?void 0:u.value)||"";!a&&!r&&!c&&!I||d.push({name:a,grams:r,percent:c,sap:l,iodine:T,fattyRaw:_,gi:I,defaultUnit:h,categoryName:v})}),d}function O(){var i;if((i=e.fragrances)!=null&&i.collectFragranceData)return e.fragrances.collectFragranceData();let d=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var h,v,m,t,f,S,M;let r=((v=(h=a.querySelector(".fragrance-typeahead"))==null?void 0:h.value)==null?void 0:v.trim())||"",c=((m=a.querySelector(".fragrance-grams"))==null?void 0:m.value)||"",l=((t=a.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",T=((f=a.querySelector(".fragrance-gi-id"))==null?void 0:f.value)||"",_=((S=a.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",I=((M=a.querySelector(".fragrance-category"))==null?void 0:M.value)||"";!r&&!c&&!l&&!T||d.push({name:r,grams:c,percent:l,gi:T,defaultUnit:_,categoryName:I})}),d}function E(d,i){let a=document.getElementById("oilRows");if(!a||!d)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=d.name||"",r.querySelector(".oil-grams").value=d.grams||"",r.querySelector(".oil-percent").value=d.percent||"",r.querySelector(".oil-sap-koh").value=d.sap||"",r.querySelector(".oil-iodine").value=d.iodine||"",r.querySelector(".oil-fatty").value=d.fattyRaw||"",r.querySelector(".oil-gi-id").value=d.gi||"";let c=r.querySelector(".oil-default-unit");c&&(c.value=d.defaultUnit||"");let l=r.querySelector(".oil-category");l&&(l.value=d.categoryName||"");let T=Array.from(a.children);return i>=T.length?a.appendChild(r):a.insertBefore(r,T[i]),r}function A(){var a,r,c,l,T,_,I,h,v,m,t,f,S,M,w,P,F,j,u,b,p,g,C,x,U,V,z;let d=y();if(!d)return;let i={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:H(),lye_form:{superfat:((a=document.getElementById("lyeSuperfat"))==null?void 0:a.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((c=document.getElementById("lyePurity"))==null?void 0:c.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((T=document.getElementById("waterPct"))==null?void 0:T.value)||"",lye_concentration:((_=document.getElementById("lyeConcentration"))==null?void 0:_.value)||"",water_ratio:((I=document.getElementById("waterRatio"))==null?void 0:I.value)||""},additives:{fragrances:O(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((h=document.getElementById("additiveLactateName"))==null?void 0:h.value)||"",lactate_gi:((v=document.getElementById("additiveLactateGi"))==null?void 0:v.value)||"",lactate_unit:((m=document.getElementById("additiveLactateUnit"))==null?void 0:m.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((f=document.getElementById("additiveSugarName"))==null?void 0:f.value)||"",sugar_gi:((S=document.getElementById("additiveSugarGi"))==null?void 0:S.value)||"",sugar_unit:((M=document.getElementById("additiveSugarUnit"))==null?void 0:M.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((P=document.getElementById("additiveSaltName"))==null?void 0:P.value)||"",salt_gi:((F=document.getElementById("additiveSaltGi"))==null?void 0:F.value)||"",salt_unit:((j=document.getElementById("additiveSaltUnit"))==null?void 0:j.value)||"",salt_category:((u=document.getElementById("additiveSaltCategory"))==null?void 0:u.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((b=document.getElementById("additiveCitricName"))==null?void 0:b.value)||"",citric_gi:((p=document.getElementById("additiveCitricGi"))==null?void 0:p.value)||"",citric_unit:((g=document.getElementById("additiveCitricUnit"))==null?void 0:g.value)||"",citric_category:((C=document.getElementById("additiveCitricCategory"))==null?void 0:C.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((x=document.getElementById("moldShape"))==null?void 0:x.value)||"loaf",cylinder_correction:!!((U=document.getElementById("moldCylinderCorrection"))!=null&&U.checked),cylinder_factor:((V=document.getElementById("moldCylinderFactor"))==null?void 0:V.value)||"0.85"},quality:{preset:((z=document.getElementById("qualityPreset"))==null?void 0:z.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(D=>D.id)},lines:{ingredients:J("tool-ingredients","ingredient"),consumables:J("tool-consumables","consumable"),containers:J("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{d.setItem(N,JSON.stringify(i));let D=document.getElementById("soapLastSaved");D&&(D.textContent=s(i.updated_at)),e.ui.showAutosaveToast()}catch{}}function G(){var l,T,_;let d=y();if(!d)return;let i=d.getItem(N);if(!i)return;let a=null;try{a=JSON.parse(i)}catch{return}if(!a||typeof a!="object")return;if(a.unit){let I=document.querySelector(`input[name="weight_unit"][value="${a.unit}"]`);I&&(I.checked=!0),e.units.setUnit(a.unit,{skipConvert:!0,skipAutoCalc:!0})}a.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=a.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(a.oils)&&a.oils.length?a.oils:[{}]).forEach(h=>{let v=e.oils.buildOilRow();v.querySelector(".oil-typeahead").value=h.name||"",v.querySelector(".oil-grams").value=h.grams||"",v.querySelector(".oil-percent").value=h.percent||"",v.querySelector(".oil-sap-koh").value=h.sap||"",v.querySelector(".oil-iodine").value=h.iodine||"",v.querySelector(".oil-fatty").value=h.fattyRaw||"",v.querySelector(".oil-gi-id").value=h.gi||"";let m=v.querySelector(".oil-default-unit");m&&(m.value=h.defaultUnit||"");let t=v.querySelector(".oil-category");t&&(t.value=h.categoryName||""),r.appendChild(v)})),a.lye_form){let I=document.getElementById("lyeSuperfat");I&&(I.value=a.lye_form.superfat||"5");let h=document.querySelector(`input[name="lye_type"][value="${a.lye_form.lye_type||"NaOH"}"]`);h&&(h.checked=!0);let v=document.getElementById("lyePurity");v&&(v.value=a.lye_form.lye_purity||"100");let m=document.getElementById("waterMethod");m&&(m.value=a.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=a.lye_form.water_pct||"");let f=document.getElementById("lyeConcentration");f&&(f.value=a.lye_form.lye_concentration||"");let S=document.getElementById("waterRatio");S&&(S.value=a.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(a.additives){let I=document.getElementById("fragranceRows");if(I&&((l=e.fragrances)!=null&&l.buildFragranceRow)){I.innerHTML="";let x=Array.isArray(a.additives.fragrances)&&a.additives.fragrances.length?a.additives.fragrances:null;if(x)x.forEach(U=>{let V=e.fragrances.buildFragranceRow();V.querySelector(".fragrance-typeahead").value=U.name||"",V.querySelector(".fragrance-grams").value=U.grams||"",V.querySelector(".fragrance-percent").value=U.percent||"",V.querySelector(".fragrance-gi-id").value=U.gi||"";let z=V.querySelector(".fragrance-default-unit");z&&(z.value=U.defaultUnit||"");let D=V.querySelector(".fragrance-category");D&&(D.value=U.categoryName||""),I.appendChild(V)});else if(a.additives.fragrance_pct||a.additives.fragrance_name||a.additives.fragrance_gi){let U=e.fragrances.buildFragranceRow();U.querySelector(".fragrance-typeahead").value=a.additives.fragrance_name||"",U.querySelector(".fragrance-percent").value=a.additives.fragrance_pct||"3",U.querySelector(".fragrance-gi-id").value=a.additives.fragrance_gi||"",I.appendChild(U)}}document.getElementById("additiveLactatePct").value=a.additives.lactate_pct||"1";let h=document.getElementById("additiveLactateName");h&&(h.value=a.additives.lactate_name||"");let v=document.getElementById("additiveLactateGi");v&&(v.value=a.additives.lactate_gi||"");let m=document.getElementById("additiveLactateUnit");m&&(m.value=a.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=a.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=a.additives.sugar_pct||"1";let f=document.getElementById("additiveSugarName");f&&(f.value=a.additives.sugar_name||"");let S=document.getElementById("additiveSugarGi");S&&(S.value=a.additives.sugar_gi||"");let M=document.getElementById("additiveSugarUnit");M&&(M.value=a.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=a.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=a.additives.salt_pct||"0.5";let P=document.getElementById("additiveSaltName");P&&(P.value=a.additives.salt_name||"");let F=document.getElementById("additiveSaltGi");F&&(F.value=a.additives.salt_gi||"");let j=document.getElementById("additiveSaltUnit");j&&(j.value=a.additives.salt_unit||"");let u=document.getElementById("additiveSaltCategory");u&&(u.value=a.additives.salt_category||""),document.getElementById("additiveCitricPct").value=a.additives.citric_pct||"0";let b=document.getElementById("additiveCitricName");b&&(b.value=a.additives.citric_name||"");let p=document.getElementById("additiveCitricGi");p&&(p.value=a.additives.citric_gi||"");let g=document.getElementById("additiveCitricUnit");g&&(g.value=a.additives.citric_unit||"");let C=document.getElementById("additiveCitricCategory");C&&(C.value=a.additives.citric_category||"")}if(a.mold){document.getElementById("moldWaterWeight").value=a.mold.water_weight||"",document.getElementById("moldOilPct").value=a.mold.oil_pct||"65";let I=document.getElementById("moldShape");I&&(I.value=a.mold.shape||"loaf");let h=document.getElementById("moldCylinderCorrection");h&&(h.checked=!!a.mold.cylinder_correction);let v=document.getElementById("moldCylinderFactor");v&&(v.value=a.mold.cylinder_factor||"0.85");let m=document.getElementById("oilTotalTarget");(T=e.mold)!=null&&T.syncMoldPctFromTarget&&((_=e.mold)!=null&&_.syncTargetFromMold)&&(e.units.toGrams(m==null?void 0:m.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(a.quality){let I=document.getElementById("qualityPreset");if(I){let h=a.quality.preset||"balanced",v=Array.from(I.options).find(m=>m.value===h);I.value=v?h:"balanced"}document.querySelectorAll(".quality-focus").forEach(h=>{h.checked=Array.isArray(a.quality.focus)&&a.quality.focus.includes(h.id)})}function c(I,h,v){let m=document.getElementById(I);m&&(m.innerHTML="",(h||[]).forEach(t=>{let f=e.runner.buildLineRow(v),S=f.querySelector(".tool-typeahead"),M=f.querySelector(".tool-gi-id"),w=f.querySelector(".tool-qty"),P=f.querySelector(".tool-unit");S&&(S.value=t.name||""),M&&(M.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),P&&t.unit&&Array.from(P.options).find(j=>j.value===t.unit)&&(P.value=t.unit),m.appendChild(f)}))}if(a.lines&&(c("tool-ingredients",a.lines.ingredients,"ingredient"),c("tool-consumables",a.lines.consumables,"consumable"),c("tool-containers",a.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(a.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),a.updated_at){let I=document.getElementById("soapLastSaved");I&&(I.textContent=s(a.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let L=null;function Y(){L&&clearTimeout(L),L=setTimeout(A,350)}let o=null;function q(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:A,restoreState:G,serializeLines:J,serializeOils:H,restoreOilRow:E,queueStateSave:Y,queueAutoCalc:q}})(window);(function(R){"use strict";var He,Ge;let e=R.SoapTool=R.SoapTool||{},{LACTATE_CATEGORY_SET:s,SUGAR_CATEGORY_SET:y,SALT_CATEGORY_SET:N,CITRIC_CATEGORY_SET:J}=e.constants,{round:H,toNumber:O,clamp:E}=e.helpers,{formatWeight:A,formatPercent:G,toGrams:L,fromGrams:Y}=e.units,o=e.state,q=90,d=120,i=80,a=130,r=50,c=200;async function l(){var B;let n=o.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return n||((B=e.ui)!=null&&B.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function T(n){let B=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(K=>{var ye,se,ae,_e;let Q=(se=(ye=K.querySelector(".fragrance-typeahead"))==null?void 0:ye.value)==null?void 0:se.trim(),ee=(ae=K.querySelector(".fragrance-grams"))==null?void 0:ae.value,oe=(_e=K.querySelector(".fragrance-percent"))==null?void 0:_e.value,ne=L(ee),fe=E(O(oe),0);ne<=0&&fe>0&&n>0&&(ne=n*(fe/100)),!(ne<=0&&fe<=0&&!Q)&&(!fe&&ne>0&&n>0&&(fe=ne/n*100),B.push({name:Q||"Fragrance/Essential Oils",grams:ne,pct:fe}))}),B}function _(n){var ne,fe,ye,se,ae,_e,Be,Pe;let B=[];if(!n)return B;let K=((fe=(ne=document.getElementById("additiveLactateName"))==null?void 0:ne.value)==null?void 0:fe.trim())||"Sodium Lactate",Q=((se=(ye=document.getElementById("additiveSugarName"))==null?void 0:ye.value)==null?void 0:se.trim())||"Sugar",ee=((_e=(ae=document.getElementById("additiveSaltName"))==null?void 0:ae.value)==null?void 0:_e.trim())||"Salt",oe=((Pe=(Be=document.getElementById("additiveCitricName"))==null?void 0:Be.value)==null?void 0:Pe.trim())||"Citric Acid";return n.lactateG>0&&B.push({name:K,grams:n.lactateG,pct:n.lactatePct}),n.sugarG>0&&B.push({name:Q,grams:n.sugarG,pct:n.sugarPct}),n.saltG>0&&B.push({name:ee,grams:n.saltG,pct:n.saltPct}),n.citricG>0&&B.push({name:oe,grams:n.citricG,pct:n.citricPct}),B}function I(n){var fe,ye;let B=[],K=O((fe=n.additives)==null?void 0:fe.citricLyeG),Q=O((ye=n.additives)==null?void 0:ye.citricG),ee=String(n.lyeType||"NaOH").toUpperCase();return K>0&&Q>0&&(ee==="KOH"?B.push("Citric-acid lye adjustment used 0.71 x citric acid because KOH was selected."):B.push("Citric-acid lye adjustment used 0.624 x citric acid because NaOH was selected."),B.push(`${A(K)} lye added extra to accommodate the extra citrus.`)),n.usedSapFallback&&B.push("Average SAP fallback was used for oils missing SAP values."),String(n.lyeSelected||"").toUpperCase()==="KOH90"&&B.push("KOH90 selection assumes 90% lye purity."),(Array.isArray(n.oils)?n.oils:[]).some(se=>{let ae=O(se==null?void 0:se.sapKoh);return ae>0&&ae<=1})&&B.push("SAP values at or below 1.0 were treated as decimal SAP and converted to mg KOH/g."),B}function h(n){var ye,se;if(Array.isArray((ye=n==null?void 0:n.export)==null?void 0:ye.csv_rows)&&n.export.csv_rows.length)return n.export.csv_rows;let B=n.totalOils||0,K=[["section","name","quantity","unit","percent"]];K.push(["Summary","Lye Type",n.lyeType||"","",""]),K.push(["Summary","Superfat",H(n.superfat||0,2),"%",""]),K.push(["Summary","Lye Purity",H(n.purity||0,1),"%",""]),K.push(["Summary","Water Method",n.waterMethod||"","",""]),K.push(["Summary","Water %",H(n.waterPct||0,1),"%",""]),K.push(["Summary","Lye Concentration",H(n.lyeConcentration||0,1),"%",""]),K.push(["Summary","Water Ratio",H(n.waterRatio||0,2),"",""]),K.push(["Summary","Total Oils",H(B,2),"gram",""]),K.push(["Summary","Batch Yield",H(n.batchYield||0,2),"gram",""]),(n.oils||[]).forEach(ae=>{let _e=B>0?H(ae.grams/B*100,2):"";K.push(["Oils",ae.name||"Oil",H(ae.grams||0,2),"gram",_e])});let Q=O((se=n.additives)==null?void 0:se.citricLyeG),oe=n.lyeAdjustedBase!==null&&n.lyeAdjustedBase!==void 0&&n.lyeAdjustedBase!==""?O(n.lyeAdjustedBase)+Q:O(n.lyeAdjusted);if(oe>0){let ae=n.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";Q>0&&(ae+="*"),K.push(["Lye",ae,H(oe,2),"gram",""])}return n.water>0&&K.push(["Water","Distilled Water",H(n.water,2),"gram",""]),T(B).forEach(ae=>{K.push(["Fragrance",ae.name,H(ae.grams||0,2),"gram",H(ae.pct||0,2)])}),_(n.additives).forEach(ae=>{K.push(["Additives",ae.name,H(ae.grams||0,2),"gram",H(ae.pct||0,2)])}),I(n).forEach(ae=>{K.push(["Notes",`* ${ae}`,"","",""])}),K}function v(n){if(n==null)return"";let B=String(n);return/[",\n]/.test(B)?`"${B.replace(/"/g,'""')}"`:B}function m(n){return n.map(B=>B.map(v).join(",")).join(`
`)}function t(n,B){let K=new Blob([n],{type:"text/csv;charset=utf-8;"}),Q=URL.createObjectURL(K),ee=document.createElement("a");ee.href=Q,ee.download=B,document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),URL.revokeObjectURL(Q)}function f(n){var oe;let B=(oe=e.mold)!=null&&oe.getMoldSettings?e.mold.getMoldSettings():null,K=O(B==null?void 0:B.effectiveCapacity),Q=O(n==null?void 0:n.batchYield);if(K<=0||Q<=0)return null;let ee=Q/K*100;return{moldCapacityG:K,batchYieldG:Q,fillPct:ee,differenceG:Q-K}}function S(n){return n?n.fillPct<q||n.fillPct>d:!1}function M(n){if(n<q){let B=n<i;return{toneClass:B?"text-danger":"text-warning",messageClass:B?"alert-danger":"alert-warning",message:B?"This recipe is far below mold capacity and may underfill bars.":"This recipe is below your target range and may leave extra headspace."}}if(n>d){let B=n>a;return{toneClass:B?"text-danger":"text-warning",messageClass:B?"alert-danger":"alert-warning",message:B?"This recipe is far above mold capacity and has a high overflow risk.":"This recipe is above your target range and may overflow this mold."}}return{toneClass:"text-success",messageClass:"alert-success",message:"This recipe is inside your target fill range."}}function w(n){let B=O(n);return!isFinite(B)||Math.abs(B)<.01?`0 ${o.currentUnit||"g"}`:`${B>0?"+":"-"}${H(Y(Math.abs(B)),2)} ${o.currentUnit||"g"}`}function P(n,B){let K=O(B);return!Array.isArray(n)||!isFinite(K)||K<=0?[]:n.map(Q=>({...Q,grams:O(Q==null?void 0:Q.grams)*K}))}function F(n,B,K){let Q=O(B);if(!isFinite(Q)||Q<=0||!n||typeof n!="object")return null;let ee={...n.additives||{}};["lactateG","sugarG","saltG","citricG","citricLyeG","fragranceG"].forEach(ne=>{ee[ne]=O(ee[ne])*Q});let oe=n.lyeAdjustedBase!==null&&n.lyeAdjustedBase!==void 0&&n.lyeAdjustedBase!=="";return{...n,totalOils:O(n.totalOils)*Q,oils:(n.oils||[]).map(ne=>({...ne,grams:O(ne==null?void 0:ne.grams)*Q})),lyePure:O(n.lyePure)*Q,lyeAdjustedBase:oe?O(n.lyeAdjustedBase)*Q:n.lyeAdjustedBase,lyeAdjusted:O(n.lyeAdjusted)*Q,water:O(n.water)*Q,batchYield:O(K)>0?O(K):O(n.batchYield)*Q,additives:ee,export:null}}function j(n,B,K){if(!B||!n)return null;let Q=E(O(K)>0?O(K):100,r,c),ee=B.moldCapacityG*(Q/100),oe=O(n.batchYield);if(!isFinite(ee)||ee<=0||!isFinite(oe)||oe<=0)return null;let ne=ee/oe,fe=F(n,ne,ee);if(!fe)return null;let ye=P(T(O(n.totalOils)),ne),se=P(_(n.additives),ne);return{calc:fe,fragrances:ye,additives:se,normalizationNote:`Normalized to ${H(Q,1)}% mold fill (${A(ee)} target batch).`}}function u(n){return new Promise(B=>{let K=document.getElementById("soapPrintConfirmModal");if(!K||!R.bootstrap){B({action:"print-as-is"});return}let Q=R.bootstrap.Modal.getOrCreateInstance(K),ee=document.getElementById("soapPrintConfirmBatchYield"),oe=document.getElementById("soapPrintConfirmMoldCapacity"),ne=document.getElementById("soapPrintConfirmFillPct"),fe=document.getElementById("soapPrintConfirmDiff"),ye=document.getElementById("soapPrintConfirmMessage"),se=document.getElementById("soapPrintNormalizePct"),ae=document.getElementById("soapPrintAsIsBtn"),_e=document.getElementById("soapNormalizePrintBtn");if(!ae||!_e){B({action:"print-as-is"});return}let Be=M(n.fillPct);ee&&(ee.textContent=A(n.batchYieldG)),oe&&(oe.textContent=A(n.moldCapacityG)),fe&&(fe.textContent=w(n.differenceG)),ne&&(ne.textContent=`${H(n.fillPct,1)}%`,ne.classList.remove("text-success","text-warning","text-danger"),ne.classList.add(Be.toneClass)),ye&&(ye.textContent=Be.message,ye.classList.remove("alert-success","alert-info","alert-warning","alert-danger"),ye.classList.add(Be.messageClass)),se&&(se.value="100");let Pe=!1,Ue=()=>{ae.removeEventListener("click",ke),_e.removeEventListener("click",Me),se&&se.removeEventListener("keydown",Ne),K.removeEventListener("hidden.bs.modal",$e)},Fe=qe=>{Pe||(Pe=!0,Ue(),B(qe))},ke=()=>{Fe({action:"print-as-is"}),Q.hide()},Me=()=>{let qe=O(se==null?void 0:se.value),ve=E(qe>0?qe:100,r,c);se&&(se.value=H(ve,2)),Fe({action:"normalize",targetPct:ve}),Q.hide()},Ne=qe=>{qe.key==="Enter"&&(qe.preventDefault(),Me())},$e=()=>{Fe(null)};ae.addEventListener("click",ke),_e.addEventListener("click",Me),se&&se.addEventListener("keydown",Ne),K.addEventListener("hidden.bs.modal",$e),Q.show(),se&&R.setTimeout(()=>se.focus(),120)})}function b(n){var K;let B=R.open("","_blank","width=960,height=720");return B?(B.document.open(),B.document.write(n),B.document.close(),B.focus(),B.onload=()=>{B.print()},!0):((K=e.ui)!=null&&K.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3}),!1)}function p(n,B={}){var $e,qe;if(typeof(($e=n==null?void 0:n.export)==null?void 0:$e.sheet_html)=="string"&&n.export.sheet_html.trim())return n.export.sheet_html;let K=n.totalOils||0,Q=(n.oils||[]).map(ve=>({name:ve.name||"Oil",grams:ve.grams||0,pct:K>0?ve.grams/K*100:0})),ee=Array.isArray(B==null?void 0:B.fragrances)?B.fragrances:T(K),oe=Array.isArray(B==null?void 0:B.additives)?B.additives:_(n.additives),ne=typeof(B==null?void 0:B.normalizationNote)=="string"?B.normalizationNote.trim():"",fe=new Date().toLocaleString(),ye=Q.length?Q.map(ve=>`
          <tr>
            <td>${ve.name}</td>
            <td class="text-end">${A(ve.grams)}</td>
            <td class="text-end">${G(ve.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',se=ee.length?ee.map(ve=>`
          <tr>
            <td>${ve.name}</td>
            <td class="text-end">${A(ve.grams)}</td>
            <td class="text-end">${G(ve.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',ae=oe.length?oe.map(ve=>`
          <tr>
            <td>${ve.name}</td>
            <td class="text-end">${A(ve.grams)}</td>
            <td class="text-end">${G(ve.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',_e=O((qe=n.additives)==null?void 0:qe.citricLyeG),Pe=n.lyeAdjustedBase!==null&&n.lyeAdjustedBase!==void 0&&n.lyeAdjustedBase!==""?O(n.lyeAdjustedBase)+_e:O(n.lyeAdjusted),Ue=`${n.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${_e>0?"*":""}`,Fe=`${A(Pe)}${_e>0?"*":""}`,ke=I(n),Me=ke.map(ve=>`<div class="footnote">* ${ve}</div>`).join(""),Ne=ke.length?`<div class="footnotes"><h2 class="footnotes-heading">Assumptions</h2>${Me}</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnotes { margin-top: 10px; }
      .footnotes-heading { font-size: 14px; margin: 12px 0 4px; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${fe}</div>
    ${ne?`<div class="meta">${ne}</div>`:""}
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${n.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${G(n.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${G(n.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${A(K)}</span></div>
      <div class="summary-item"><span>Water</span><span>${A(n.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${A(n.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${n.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${G(n.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ye}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${Ue}</td><td class="text-end">${Fe}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${A(n.water||0)}</td></tr>
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${se}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ae}</tbody>
    </table>
    ${Ne}
  </body>
</html>`}let g=document.getElementById("oilRows"),C=document.getElementById("addOil"),x=document.getElementById("normalizeOils");C&&g&&(C.dataset.bound="direct",C.addEventListener("click",function(){g.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),x&&(x.dataset.bound="direct",x.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),g&&g.addEventListener("input",function(n){n.target.classList.contains("oil-grams")&&(o.lastOilEdit={row:n.target.closest(".oil-row"),field:"grams"}),n.target.classList.contains("oil-percent")&&(o.lastOilEdit={row:n.target.closest(".oil-row"),field:"percent"}),(n.target.classList.contains("oil-grams")||n.target.classList.contains("oil-percent")||n.target.classList.contains("oil-typeahead"))&&(n.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(n.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),g&&g.addEventListener("focusin",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(n.target.closest(".oil-row"))}),g&&g.addEventListener("focusout",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),n.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(n.target.closest(".oil-row"),"grams"),n.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(n.target.closest(".oil-row"),"percent")}),g&&g.addEventListener("keydown",function(n){n.key==="Enter"&&(n.target.classList.contains("oil-grams")&&(n.preventDefault(),e.oils.validateOilEntry(n.target.closest(".oil-row"),"grams")),n.target.classList.contains("oil-percent")&&(n.preventDefault(),e.oils.validateOilEntry(n.target.closest(".oil-row"),"percent")))}),g&&g.addEventListener("mouseover",function(n){if(!n.target.classList.contains("oil-typeahead"))return;let B=n.target.closest(".oil-row");!B||B===o.lastPreviewRow||(o.lastPreviewRow=B,e.oils.setSelectedOilProfileFromRow(B))}),g&&g.addEventListener("mouseout",function(n){n.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),g&&g.addEventListener("click",function(n){let B=n.target.closest(".oil-profile-open");if(B){let Q=B.closest(".oil-row");if(Q){e.oils.setSelectedOilProfileFromRow(Q);let ee=document.getElementById("oilProfileModal");ee&&R.bootstrap&&bootstrap.Modal.getOrCreateInstance(ee).show()}return}let K=n.target.closest(".remove-oil");if(K){let Q=K.closest(".oil-row");Q&&(o.lastRemovedOil=e.oils.serializeOilRow(Q),o.lastRemovedOilIndex=Array.from(Q.parentElement.children).indexOf(Q),e.ui.showUndoToast("Oil removed.")),Q&&o.lastOilEdit&&o.lastOilEdit.row===Q&&(o.lastOilEdit=null,e.oils.clearSelectedOilProfile()),Q&&Q.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let U=document.getElementById("fragranceRows"),V=document.getElementById("addFragrance");V&&U&&(V.dataset.bound="direct",V.addEventListener("click",function(){U.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),U&&(U.addEventListener("input",function(n){n.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:n.target.closest(".fragrance-row"),field:"grams"}),n.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:n.target.closest(".fragrance-row"),field:"percent"}),(n.target.classList.contains("fragrance-grams")||n.target.classList.contains("fragrance-percent")||n.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),U.addEventListener("click",function(n){var Q;let B=n.target.closest(".remove-fragrance");if(!B)return;let K=B.closest(".fragrance-row");K&&((Q=e.state.lastFragranceEdit)==null?void 0:Q.row)===K&&(e.state.lastFragranceEdit=null),K&&K.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let z=document.getElementById("soapStageTabContent"),D=()=>{if(!z)return null;let n=z.querySelector(".tab-pane.active")||z.querySelector(".tab-pane.show.active");return n?n.querySelector(".soap-stage-body")||n:null},$=()=>{z&&z.addEventListener("wheel",n=>{let B=n.target;if(!(B instanceof HTMLElement))return;let K=B.closest('input[type="number"]');if(!(K instanceof HTMLInputElement))return;let Q=D();if(!(Q instanceof HTMLElement)||Q.scrollHeight<=Q.clientHeight+1)return;document.activeElement===K&&typeof K.blur=="function"&&K.blur();let ee=Q.scrollTop<=0,oe=Q.scrollTop+Q.clientHeight>=Q.scrollHeight-1;n.deltaY<0&&ee||n.deltaY>0&&oe||(Q.scrollTop+=n.deltaY,n.preventDefault())},{passive:!1})};z&&(z.addEventListener("click",n=>{let B=n.target.closest("[data-stage-action]"),K=n.target.closest("[data-soap-action]");if(!B&&!K)return;if(n.preventDefault(),n.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),K){if(K.dataset.bound==="direct")return;let oe=K.dataset.soapAction;oe==="add-oil"&&g&&(g.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),oe==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),oe==="add-fragrance"&&U&&(U.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let Q=B.dataset.stageAction,ee=Number(B.dataset.stageIndex);Number.isNaN(ee)||(Q==="prev"&&e.stages.openStageByIndex(Math.max(0,ee-1)),Q==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,ee+1)),Q==="reset"&&e.stages.resetStage(ee+1))}),$());let X=document.getElementById("soapStageTabList"),Z=()=>{if(!X)return;X.querySelectorAll(".nav-item").forEach(B=>B.classList.remove("is-expanded"));let n=X.querySelector(".nav-link.active");n&&n.closest(".nav-item")&&n.closest(".nav-item").classList.add("is-expanded")};X&&(X.addEventListener("shown.bs.tab",()=>{Z(),e.layout.scheduleStageHeightSync()}),Z());let le=document.getElementById("resultsCardToggle"),ue=document.getElementById("resultsCard");le&&ue&&le.addEventListener("click",()=>{ue.classList.toggle("is-collapsed");let n=ue.classList.contains("is-collapsed");le.setAttribute("aria-expanded",(!n).toString());let B=n?"Expand formula details":"Collapse formula details";le.setAttribute("aria-label",B),le.setAttribute("title",B);let K=le.querySelector("i");K&&(K.classList.toggle("fa-chevron-down",n),K.classList.toggle("fa-chevron-up",!n))}),document.querySelectorAll('input[name="weight_unit"]').forEach(n=>{n.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let pe=()=>{var n;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(n=e.mold)!=null&&n.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},Se=document.getElementById("oilTotalTarget");Se&&Se.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let me=document.getElementById("waterMethod");me&&me.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(n=>{n.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(n=>{let B=document.getElementById(n);B&&["input","change"].forEach(K=>{B.addEventListener(K,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:n,weightId:B})=>{let K=document.getElementById(n),Q=document.getElementById(B);K&&K.addEventListener("input",()=>{let ee=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:n,weightId:B,sourceField:"pct",totalOils:ee}),e.additives.updateAdditivesOutput(ee),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),Q&&Q.addEventListener("input",()=>{let ee=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:n,weightId:B,sourceField:"weight",totalOils:ee}),e.additives.updateAdditivesOutput(ee),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(n=>{n.addEventListener("input",()=>{e.storage.queueStateSave()})});let be=document.getElementById("qualityPreset");be&&be.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(n=>{n.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let Te=document.getElementById("applyQualityTargets");Te&&Te.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(n=>{n.addEventListener("click",()=>e.quality.applyQualityTargets()),n.addEventListener("keydown",B=>{(B.key==="Enter"||B.key===" ")&&(B.preventDefault(),e.quality.applyQualityTargets())})});let Ae=document.getElementById("moldWaterWeight");Ae&&Ae.addEventListener("input",function(){e.mold.syncTargetFromMold(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Le=document.getElementById("moldOilPct");Le&&Le.addEventListener("input",function(){e.mold.syncTargetFromMold(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let k=document.getElementById("moldShape");k&&k.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let W=document.getElementById("moldCylinderCorrection");W&&W.addEventListener("change",function(){e.mold.syncTargetFromMold(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let te=document.getElementById("moldCylinderFactor");te&&te.addEventListener("input",function(){e.mold.syncTargetFromMold(),pe(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(n=>{n.addEventListener("click",function(){let B=this.dataset.stubKind,K=this.dataset.stubName;e.runner.addStubLine(B,K),e.storage.queueStateSave()})});let ie=document.getElementById("soapToolPage");ie&&(ie.addEventListener("click",function(n){n.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),ie.addEventListener("input",function(n){n.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(n.target),e.stages.updateStageStatuses(),e.ui.flashStage(n.target.closest(".soap-stage-card")))}),ie.addEventListener("change",function(n){n.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(n.target),e.stages.updateStageStatuses())}));let re=document.getElementById("addToolIngredient");re&&re.addEventListener("click",function(){let n=document.getElementById("tool-ingredients");n&&n.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let ge=document.getElementById("addToolConsumable");ge&&ge.addEventListener("click",function(){let n=document.getElementById("tool-consumables");n&&n.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let Ee=document.getElementById("addToolContainer");Ee&&Ee.addEventListener("click",function(){let n=document.getElementById("tool-containers");n&&n.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let he=document.getElementById("calcLyeBtn");he&&he.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let Ce=document.getElementById("saveSoapTool");Ce&&Ce.addEventListener("click",async function(){try{let n=o.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!n)return;let B=e.runner.buildSoapRecipePayload(n);o.lastRecipePayload=B;try{let K=e.helpers.getStorage();K&&K.setItem("soap_recipe_payload",JSON.stringify(B))}catch{}R.SOAP_RECIPE_DTO=B,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let Oe=document.getElementById("exportSoapCsv");Oe&&Oe.addEventListener("click",async function(){var Q;let n=await l();if(!n)return;let B=h(n),K=typeof((Q=n==null?void 0:n.export)==null?void 0:Q.csv_text)=="string"&&n.export.csv_text?n.export.csv_text:m(B);t(K,"soap_formula.csv")});let we=document.getElementById("printSoapSheet");we&&we.addEventListener("click",async function(){let n=await l();if(!n)return;let B=f(n),K=n,Q={};if(S(B)){let oe=await u(B);if(!oe)return;if(oe.action==="normalize"){let ne=j(n,B,oe.targetPct);ne!=null&&ne.calc&&(K=ne.calc,Q={fragrances:ne.fragrances,additives:ne.additives,normalizationNote:ne.normalizationNote})}}let ee=p(K,Q);b(ee)});let xe=document.getElementById("soapUndoRemove");xe&&xe.addEventListener("click",()=>{o.lastRemovedOil&&(e.storage.restoreOilRow(o.lastRemovedOil,o.lastRemovedOilIndex||0),o.lastRemovedOil=null,o.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let n=document.getElementById("soapMobileDrawer"),B=document.getElementById("soapMobileDrawerContent"),K=document.getElementById("soapMobileDrawerTitle"),Q=document.getElementById("soapDrawerEmpty"),ee=document.getElementById("soapDrawerClose"),oe=document.getElementById("soapQualityCard"),ne=document.getElementById("resultsCard");if(!n||!B||!K||!oe||!ne)return;let fe=oe.parentElement,ye=ne.parentElement,se=new Map,ae=null,_e=()=>R.matchMedia("(max-width: 767px)").matches,Be=ce=>ce==="quality"?oe:ne,Pe=ce=>ce==="quality"?fe:ye,Ue=ce=>ce==="quality"?"Display":"Results",Fe=ce=>{let Ie=se.get(ce);Ie||(Ie=document.createElement("div"),Ie.className="soap-card-placeholder",se.set(ce,Ie)),Ie.style.height=`${ce.offsetHeight}px`,ce.parentElement&&ce.parentElement!==B&&!Ie.parentElement&&ce.parentElement.insertBefore(Ie,ce)},ke=ce=>{ce&&(Fe(ce),B.appendChild(ce))},Me=(ce,Ie)=>{let We=se.get(ce);We&&We.parentElement?We.replaceWith(ce):Ie&&ce.parentElement!==Ie&&Ie.appendChild(ce)},Ne=()=>{if(!Q)return;let ce=ae==="results",Ie=getComputedStyle(ne).display!=="none";Q.classList.toggle("d-none",!ce||Ie)},$e=ce=>{_e()&&(ae&&ae!==ce&&Me(Be(ae),Pe(ae)),ke(Be(ce)),K.textContent=Ue(ce),ae=ce,n.classList.add("is-open"),Ne())},qe=()=>{ae&&(Me(Be(ae),Pe(ae)),ae=null,n.classList.remove("is-open"),Ne())};n.querySelectorAll("[data-drawer-target]").forEach(ce=>{ce.addEventListener("click",()=>{let Ie=ce.dataset.drawerTarget;Ie&&(n.classList.contains("is-open")&&ae===Ie?qe():$e(Ie))})}),ee&&ee.addEventListener("click",qe),R.addEventListener("resize",()=>{!_e()&&ae&&qe()}),new MutationObserver(()=>Ne()).observe(ne,{attributes:!0,attributeFilter:["style","class"]})})(),R.addEventListener("resize",e.layout.scheduleStageHeightSync),R.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",s,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",y,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",N,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",J,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),g&&!g.querySelector(".oil-row")&&g.appendChild(e.oils.buildOilRow()),U&&!U.querySelector(".fragrance-row")&&(He=e.fragrances)!=null&&He.buildFragranceRow&&U.appendChild(e.fragrances.buildFragranceRow()),(Ge=e.fragrances)!=null&&Ge.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
