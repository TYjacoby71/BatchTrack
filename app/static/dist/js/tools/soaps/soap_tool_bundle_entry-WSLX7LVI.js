(function(P){"use strict";let e={inventory:"Inventory",global:"Global Library"},r={inventory:"bg-primary",global:"bg-info text-dark"},g={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function M(i,d){let n;return function(){let C=arguments;clearTimeout(n),n=setTimeout(()=>i.apply(null,C),d)}}function D(i){return(i||"").trim().toLowerCase()}function x(i){if(i)return i;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function O(i){return typeof i=="function"?i():i}function E(i){let d=new Set;return(i||[]).forEach(n=>{let C=n&&(n.global_item_id||n.id);C&&d.add(String(C))}),d}function h(i){if(!i)return"";let d=e[i]||i;return`<span class="badge ${r[i]||"bg-secondary"} ms-2">${d}</span>`}function f(i,d,n,C){C=C||{},i.innerHTML="";let w=!1;if(d.forEach(A=>{!A.items||!A.items.length||(w=!0,A.items.forEach(y=>{let G=document.createElement("a");G.href="#",G.className="list-group-item list-group-item-action suggestion-item";let b=C.showSubtitle&&y.subtitle?`<div class="small text-muted mt-1">${y.subtitle}</div>`:"";G.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${y.text||y.display_name||y.name||""}</span>
          ${C.showSourceBadge?h(A.source||y.source):""}
        </div>${b}`,G.addEventListener("click",function(t){t.preventDefault(),n(y,A.source||y.source),i.classList.add("d-none")}),i.appendChild(G)}))}),i.classList.toggle("d-none",!w),!w&&i.dataset.emptyMessage){let A=document.createElement("div");A.className="list-group-item text-muted small",A.textContent=i.dataset.emptyMessage,i.appendChild(A),i.classList.remove("d-none")}}function I(i,d,n){i.innerHTML="";let C=!1;d.forEach(w=>{if(!w.ingredients||!w.ingredients.length)return;C=!0;let A=document.createElement("div");A.className="list-group-item text-muted small fw-semibold",A.textContent=w.title,i.appendChild(A),w.ingredients.forEach(y=>{let G=document.createElement("div");G.className="list-group-item ingredient-result";let b=document.createElement("div");b.className="d-flex justify-content-between align-items-center ingredient-summary",b.setAttribute("role","button"),b.setAttribute("tabindex","0"),b.innerHTML=`<span class="fw-semibold">${y.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${y.forms.length} option${y.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",y.forms.forEach(S=>{let l=document.createElement("button");l.type="button",l.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",l.innerHTML=`<div class="fw-semibold">${S.text||S.display_name||S.name||"Form"}</div>`,l.addEventListener("click",function(){n(S,S.source||w.source),i.classList.add("d-none")}),t.appendChild(l)});function p(S){S.type==="keydown"&&S.key!=="Enter"&&S.key!==" "||(S.preventDefault(),t.classList.toggle("d-none"))}b.addEventListener("click",p),b.addEventListener("keydown",p),G.appendChild(b),G.appendChild(t),i.appendChild(G),y.forms.length===1&&t.classList.remove("d-none")})}),i.classList.toggle("d-none",!C)}function U(i,d,n){i.innerHTML="";let C=!1;if((d||[]).forEach(w=>{C=!0;let A=document.createElement("a");A.href="#",A.className="list-group-item list-group-item-action suggestion-item";let y=w.inci_name?`<div class="small text-muted">${w.inci_name}</div>`:"";A.innerHTML=`<div class="fw-semibold">${w.text||w.name}</div>${y}`,A.addEventListener("click",function(G){G.preventDefault(),n(w,"definition"),i.classList.add("d-none")}),i.appendChild(A)}),i.classList.toggle("d-none",!C),!C&&i.dataset.emptyMessage){let w=document.createElement("div");w.className="list-group-item text-muted small",w.textContent=i.dataset.emptyMessage,i.appendChild(w),i.classList.remove("d-none")}}function c(i){let d=[];return(i||[]).forEach(n=>{if(n&&Array.isArray(n.forms)&&n.forms.length){let C=n.ingredient&&n.ingredient.name||n.ingredient_name||null,w=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null,A=n.category_tags||[];n.forms.forEach(y=>{var t,p,S,l,s,_,T,N,L,H;let G=y.physical_form||{},b=y.display_name||y.text||y.name||(C&&y.physical_form_name?`${C}, ${y.physical_form_name}`:n.display_name||n.text||n.name||"");d.push({id:y.id,text:b,item_type:y.item_type||n.item_type,default_unit:y.default_unit||y.unit||n.default_unit||n.unit||null,source:"global",global_item_id:y.id,ingredient_id:y.ingredient_id||n.ingredient&&n.ingredient.id||n.ingredient_id||null,ingredient_name:y.ingredient_name||C,physical_form_id:y.physical_form_id||G&&G.id||null,physical_form_name:y.physical_form_name||G&&G.name||null,ingredient_category_name:w,category_tags:A,density:y.density||n.density||null,capacity:y.capacity||n.capacity||null,capacity_unit:y.capacity_unit||n.capacity_unit||null,container_material:y.container_material||n.container_material||null,container_type:y.container_type||n.container_type||null,container_style:y.container_style||n.container_style||null,container_color:y.container_color||n.container_color||null,default_is_perishable:(t=y.default_is_perishable)!=null?t:n.default_is_perishable,recommended_shelf_life_days:(p=y.recommended_shelf_life_days)!=null?p:n.recommended_shelf_life_days,saponification_value:(l=(S=y.saponification_value)!=null?S:n.saponification_value)!=null?l:null,iodine_value:(_=(s=y.iodine_value)!=null?s:n.iodine_value)!=null?_:null,fatty_acid_profile:(N=(T=y.fatty_acid_profile)!=null?T:n.fatty_acid_profile)!=null?N:null,melting_point_c:(H=(L=y.melting_point_c)!=null?L:n.melting_point_c)!=null?H:null})})}else if(n){let C=n.display_name||n.text||n.name||"",w=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null;d.push({id:n.id,text:C,source:"global",item_type:n.item_type,global_item_id:n.id,ingredient_name:n.ingredient&&n.ingredient.name||n.ingredient_name||n.name,ingredient_category_name:w,category_tags:n.category_tags||[],physical_form_name:n.physical_form&&n.physical_form.name||n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,density:n.density||null,capacity:n.capacity||null,capacity_unit:n.capacity_unit||null,container_material:n.container_material||null,container_type:n.container_type||null,container_style:n.container_style||null,container_color:n.container_color||null,default_is_perishable:n.default_is_perishable,recommended_shelf_life_days:n.recommended_shelf_life_days,saponification_value:n.saponification_value||null,iodine_value:n.iodine_value||null,fatty_acid_profile:n.fatty_acid_profile||null,melting_point_c:n.melting_point_c||null})}}),d}function u(i){let d=new Map;return(i||[]).forEach(n=>{let C=n.ingredient_name||n.text||n.name||"",w=n.ingredient_id?`id:${n.ingredient_id}`:`name:${D(C)}`,A=d.get(w)||{ingredient_id:n.ingredient_id||null,name:C,forms:[]};A.forms.push({id:n.id,text:n.text||C,ingredient_name:C,physical_form_name:n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,source:"inventory",global_item_id:n.global_item_id||null}),d.set(w,A)}),Array.from(d.values())}function v(i,d){let n=[];return(i||[]).forEach(C=>{let w=(C.forms||[]).map(y=>({id:y.id,text:y.name||y.display_name||y.text,ingredient_name:y.ingredient_name||C.name||C.ingredient&&C.ingredient.name||"Ingredient",physical_form_name:y.physical_form_name||null,default_unit:y.default_unit||y.unit||null,source:"global",global_item_id:y.id,density:y.density||null,capacity:y.capacity||null,capacity_unit:y.capacity_unit||null,container_material:y.container_material||null,container_type:y.container_type||null,container_style:y.container_style||null,container_color:y.container_color||null,saponification_value:y.saponification_value||null,iodine_value:y.iodine_value||null,fatty_acid_profile:y.fatty_acid_profile||null,melting_point_c:y.melting_point_c||null})),A=d?w.filter(y=>!y.global_item_id||!d.has(String(y.global_item_id))):w;A.length&&n.push({ingredient_id:C.ingredient_id||C.id||null,name:C.name||C.ingredient&&C.ingredient.name||w[0]&&w[0].ingredient_name||"Ingredient",forms:A})}),n}function q(i){let d=new URLSearchParams({q:i});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(n=>n.json()).catch(()=>({results:[]}))}function a(i){let d={...g,...i},n=d.inputEl,C=d.invHiddenEl,w=d.giHiddenEl,A=x(d.listEl),y=d.mode||"recipe",G=d.searchType||"ingredient",b=d.includeInventory,t=d.includeGlobal,p=d.ingredientFirst,S=d.displayVariant,l=typeof d.resultFilter=="function"?d.resultFilter:null,s=typeof d.onSelection=="function"?d.onSelection:null,_=d.globalUrlBuilder;if(!n||!C&&y==="recipe"||!w&&d.requireHidden!==!1)return;A&&!A.classList.contains("list-group")&&A.classList.add("list-group"),!A.parentNode&&n.parentNode&&n.parentNode.appendChild(A);function T($,K){let o=new URLSearchParams({q:$});return K&&K!=="all"&&o.set("type",K),`/inventory/api/search?${o.toString()}`}function N($,K,o){if(typeof _=="function")return _($,K,o);let m=new URLSearchParams({q:$});return K&&K!=="all"&&m.set("type",K),K==="ingredient"&&o&&m.set("group","ingredient"),`${y==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${m.toString()}`}let L=M(function(){let $=(n.value||"").trim();if(!$){A.classList.add("d-none"),A.innerHTML="",C&&(C.value=""),w&&(w.value="");return}let K=(O(G)||"ingredient").toLowerCase(),o=O(b),m=O(t),F=K==="ingredient"&&!!O(p),B=S||(F?"grouped":"compact");if(K==="ingredient_definition"||K==="definition"){q($).then(Y=>{let V=Y&&Y.results||[];U(A,V.map(z=>({id:z.id,text:z.name,name:z.name,inci_name:z.inci_name,slug:z.slug,ingredient_category_id:z.ingredient_category_id,ingredient_category_name:z.ingredient_category_name})),H)}).catch(()=>A.classList.add("d-none"));return}let R=o!==!1?fetch(T($,K)).then(Y=>Y.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),k=m!==!1?fetch(N($,K,F)).then(Y=>Y.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([R,k]).then(Y=>{let V=Y[0]&&Y[0].results||[],z=Y[1]&&Y[1].results||[],j=l?V.filter(Z=>l(Z,"inventory")):V,J=l?z.filter(Z=>l(Z,"global")):z,X=E(j),ee=c(J).filter(Z=>!Z.global_item_id||!X.has(String(Z.global_item_id))).filter(Z=>l?l(Z,"global"):!0);if(F){let Z=u(j),ae=v(J,X),le=[];Z.length&&le.push({title:"Your Inventory",source:"inventory",ingredients:Z}),ae.length&&le.push({title:"Global Library",source:"global",ingredients:ae}),I(A,le,H);return}let oe=[];j.length&&oe.push({title:"Your Inventory",source:"inventory",items:j}),ee.length&&oe.push({title:"Global Library",source:"global",items:ee}),f(A,oe,H,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:B==="detailed"})}).catch(()=>{A.classList.add("d-none")})},200);function H($,K){n.value=$.text||$.display_name||$.name||"",K==="inventory"?(C&&(C.value=$.id_numeric||$.id||""),w&&(w.value=$.global_item_id||"")):(w&&(w.value=$.global_item_id||$.id||""),C&&(C.value="")),typeof s=="function"&&s($,K)}n.addEventListener("input",function(){C&&(C.value=""),w&&(w.value=""),L()}),document.addEventListener("click",function($){!A.contains($.target)&&!n.contains($.target)&&A.classList.add("d-none")})}P.attachMergedInventoryGlobalTypeahead=a,P.renderInventoryTypeaheadList=f})(window);(function(P){"use strict";function e(r,g){var M=g&&g.context||"public",D=g&&g.unitOptionsHtml||"",x=g&&g.mode||(M==="public"?"public":"recipe"),O=document.createElement("div");O.className="row g-2 align-items-end mb-2",O.innerHTML=['<div class="col-md-6">','  <label class="form-label">',r==="container"?"Container":r==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',r==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',r==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',D,"  </select>","</div>",'<div class="col-md-3 ',r!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var E=O.querySelector(".tool-typeahead"),h=O.querySelector(".tool-gi-id"),f=O.querySelector('[data-role="suggestions"]');if(typeof P.attachMergedInventoryGlobalTypeahead=="function"){let I=r==="container"?"container":r==="consumable"?"consumable":"ingredient",U=M!=="public";P.attachMergedInventoryGlobalTypeahead({inputEl:E,giHiddenEl:h,listEl:f,mode:x,context:M,ingredientFirst:r==="ingredient",searchType:I,includeInventory:U,includeGlobal:!0})}return O.querySelector(".tool-remove").addEventListener("click",function(){O.remove()}),O}P.buildToolLineRow=e})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};e.config={unitOptionsHtml:P.soapToolConfig&&P.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(P.SOAP_CALC_LIMIT)?P.SOAP_CALC_LIMIT:null,calcTier:P.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(P.soapToolConfig&&P.soapToolConfig.useCsvPrimary),isAuthenticated:P.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:r,toNumber:g,clamp:M,formatTime:D,getStorage:x,buildSoapcalcSearchBuilder:O};function r(E,h=3){if(!isFinite(E))return 0;let f=Math.pow(10,h);return Math.round(E*f)/f}function g(E){let h=E;typeof h=="string"&&(h=h.replace(/,/g,"").trim());let f=parseFloat(h);return isFinite(f)?f:0}function M(E,h,f){return!isFinite(E)||E<h?h:f!=null&&E>f?f:E}function D(E){return E?`Saved ${new Date(E).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function x(){try{return P.localStorage}catch{return null}}function O(){let E=(f,I,U)=>{let c=new URLSearchParams({q:f});return I&&I!=="all"&&c.set("type",I),I==="ingredient"&&U&&c.set("group","ingredient"),`/api/public/global-items/search?${c.toString()}`},h=(f,I,U)=>{let c=new URLSearchParams({q:f});return U&&c.set("group","ingredient"),`/api/public/soapcalc-items/search?${c.toString()}`};return e.config.useCsvPrimary===!0?h:E}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r={quality_ranges:{hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},iodine_range:[41,70],iodine_scale_max:100,ins_range:[136,170],ins_scale_max:250,quality_base:{},fatty_display_keys:["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],unit_factors:{g:1,oz:28.3495,lb:453.592},stage_configs:[{id:1,tab_id:"soapStage1Tab",pane_id:"soapStage1Pane",required:!0},{id:2,tab_id:"soapStage2Tab",pane_id:"soapStage2Pane",required:!0},{id:3,tab_id:"soapStage3Tab",pane_id:"soapStage3Pane",required:!0},{id:4,tab_id:"soapStage4Tab",pane_id:"soapStage4Pane",required:!1},{id:5,tab_id:"soapStage5Tab",pane_id:"soapStage5Pane",required:!1}],ingredient_category_filters:{oils:["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"],fragrances:["Essential Oils","Fragrance Oils"],lactate_additives:["Aqueous Solutions & Blends","Preservatives & Additives"],sugar_additives:["Sugars & Syrups"],salt_additives:["Salts & Minerals"],citric_additives:["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]},citric_lye_factors:{NaOH:.624,KOH:.71},default_inputs:{unit:"g",mold_oil_pct:65,mold_shape:"loaf",mold_cylinder_correction:!1,mold_cylinder_factor:.85,lye_type:"NaOH",water_method:"percent",superfat_pct:5,lye_purity_pct:100,water_pct:33,lye_concentration_pct:33,water_ratio:2,additive_lactate_pct:1,additive_sugar_pct:1,additive_salt_pct:.5,additive_citric_pct:0,quality_preset:"balanced",fragrance_pct:3}};function g(B){return!B||typeof B!="object"||Array.isArray(B)?{}:B}function M(B,R=[]){return Array.isArray(B)?B.map(k=>typeof k=="string"?k.trim():"").filter(Boolean):R.slice()}function D(B,R){if(!Array.isArray(B)||B.length<2)return R.slice();let k=Number(B[0]),Y=Number(B[1]);return!isFinite(k)||!isFinite(Y)?R.slice():[k,Y]}function x(B,R){let k=Number(B);return isFinite(k)?k:R}let O=g(P.soapToolPolicy),E={...r.quality_ranges,...g(O.quality_ranges)},h=g(O.quality_hints),f=g(O.quality_feel_hints),I={...r.quality_base,...g(O.quality_base)},U=g(O.quality_presets),c=g(O.fatty_bar_colors),u={...r.unit_factors,...g(O.unit_factors)},v={...r.ingredient_category_filters,...g(O.ingredient_category_filters)},q={hardness:D(E.hardness,r.quality_ranges.hardness),cleansing:D(E.cleansing,r.quality_ranges.cleansing),conditioning:D(E.conditioning,r.quality_ranges.conditioning),bubbly:D(E.bubbly,r.quality_ranges.bubbly),creamy:D(E.creamy,r.quality_ranges.creamy)},a={hardness:h.hardness||"",cleansing:h.cleansing||"",conditioning:h.conditioning||"",bubbly:h.bubbly||"",creamy:h.creamy||""},i={hardness:g(f.hardness),cleansing:g(f.cleansing),conditioning:g(f.conditioning),bubbly:g(f.bubbly),creamy:g(f.creamy)},d=D(O.iodine_range,r.iodine_range),n=x(O.iodine_scale_max,r.iodine_scale_max),C=D(O.ins_range,r.ins_range),w=x(O.ins_scale_max,r.ins_scale_max),A={hardness:x(I.hardness,(q.hardness[0]+q.hardness[1])/2),cleansing:x(I.cleansing,(q.cleansing[0]+q.cleansing[1])/2),conditioning:x(I.conditioning,(q.conditioning[0]+q.conditioning[1])/2),bubbly:x(I.bubbly,(q.bubbly[0]+q.bubbly[1])/2),creamy:x(I.creamy,(q.creamy[0]+q.creamy[1])/2)},y={balanced:{...A}};Object.entries(U).forEach(([B,R])=>{!R||typeof R!="object"||(y[B]={...R})});let G={...c},b=M(O.fatty_display_keys,r.fatty_display_keys),t=[],p={g:x(u.g,r.unit_factors.g),oz:x(u.oz,r.unit_factors.oz),lb:x(u.lb,r.unit_factors.lb)},l=(Array.isArray(O.stage_configs)?O.stage_configs:r.stage_configs).map((B,R)=>{let k=g(B),Y=r.stage_configs[R]||{},V=x(k.id,x(Y.id,R+1)),z=k.tabId||k.tab_id||Y.tabId||Y.tab_id,j=k.paneId||k.pane_id||Y.paneId||Y.pane_id;return!z||!j?null:{id:V,tabId:z,paneId:j,required:typeof k.required=="boolean"?k.required:!!Y.required}}).filter(Boolean),s=l.length?l:r.stage_configs.map(B=>({id:B.id,tabId:B.tab_id,paneId:B.pane_id,required:!!B.required})),_=new Set(M(v.oils,r.ingredient_category_filters.oils)),T=new Set(M(v.fragrances,r.ingredient_category_filters.fragrances)),N=new Set(M(v.lactate_additives,r.ingredient_category_filters.lactate_additives)),L=new Set(M(v.sugar_additives,r.ingredient_category_filters.sugar_additives)),H=new Set(M(v.salt_additives,r.ingredient_category_filters.salt_additives)),$=new Set(M(v.citric_additives,r.ingredient_category_filters.citric_additives)),K={...r.citric_lye_factors,...g(O.citric_lye_factors)},o={NaOH:x(K.NaOH,r.citric_lye_factors.NaOH),KOH:x(K.KOH,r.citric_lye_factors.KOH)},m={...r.default_inputs,...g(O.default_inputs)},F={unit:m.unit||r.default_inputs.unit,moldOilPct:x(m.mold_oil_pct,r.default_inputs.mold_oil_pct),moldShape:m.mold_shape||r.default_inputs.mold_shape,moldCylinderCorrection:!!m.mold_cylinder_correction,moldCylinderFactor:x(m.mold_cylinder_factor,r.default_inputs.mold_cylinder_factor),lyeType:m.lye_type||r.default_inputs.lye_type,waterMethod:m.water_method||r.default_inputs.water_method,superfatPct:x(m.superfat_pct,r.default_inputs.superfat_pct),lyePurityPct:x(m.lye_purity_pct,r.default_inputs.lye_purity_pct),waterPct:x(m.water_pct,r.default_inputs.water_pct),lyeConcentrationPct:x(m.lye_concentration_pct,r.default_inputs.lye_concentration_pct),waterRatio:x(m.water_ratio,r.default_inputs.water_ratio),additiveLactatePct:x(m.additive_lactate_pct,r.default_inputs.additive_lactate_pct),additiveSugarPct:x(m.additive_sugar_pct,r.default_inputs.additive_sugar_pct),additiveSaltPct:x(m.additive_salt_pct,r.default_inputs.additive_salt_pct),additiveCitricPct:x(m.additive_citric_pct,r.default_inputs.additive_citric_pct),qualityPreset:m.quality_preset||r.default_inputs.quality_preset,fragrancePct:x(m.fragrance_pct,r.default_inputs.fragrance_pct)};e.constants={QUALITY_RANGES:q,QUALITY_HINTS:a,QUALITY_FEEL_HINTS:i,IODINE_RANGE:d,IODINE_SCALE_MAX:n,INS_RANGE:C,INS_SCALE_MAX:w,QUALITY_BASE:A,QUALITY_PRESETS:y,FATTY_BAR_COLORS:G,FATTY_DISPLAY_KEYS:b,OIL_TIP_RULES:t,UNIT_FACTORS:p,STAGE_CONFIGS:s,OIL_CATEGORY_SET:_,FRAGRANCE_CATEGORY_SET:T,LACTATE_CATEGORY_SET:N,SUGAR_CATEGORY_SET:L,SALT_CATEGORY_SET:H,CITRIC_CATEGORY_SET:$,CITRIC_LYE_FACTORS:o,DEFAULT_INPUTS:F}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:r}=e.helpers;function g(O){let E=0,h=0;return O.forEach(f=>{f.iodine>0&&(E+=f.grams,h+=f.iodine*f.grams)}),{iodine:E>0?h/E:0,coverageWeight:E}}function M(O){let E={},h=0;O.forEach(I=>{!I.fattyProfile||typeof I.fattyProfile!="object"||(h+=I.grams,Object.entries(I.fattyProfile).forEach(([U,c])=>{let u=r(c);u>0&&(E[U]=(E[U]||0)+I.grams*(u/100))}))});let f={};return h>0&&Object.entries(E).forEach(([I,U])=>{f[I]=U/h*100}),{percent:f,coveredWeight:h}}function D(O){let E=h=>O[h]||0;return{hardness:E("lauric")+E("myristic")+E("palmitic")+E("stearic"),cleansing:E("lauric")+E("myristic"),conditioning:E("oleic")+E("linoleic")+E("linolenic")+E("ricinoleic"),bubbly:E("lauric")+E("myristic")+E("ricinoleic"),creamy:E("palmitic")+E("stearic")+E("ricinoleic")}}function x(O){if(!O||typeof O!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let E={lauric:r(O.lauric),myristic:r(O.myristic),palmitic:r(O.palmitic),stearic:r(O.stearic),ricinoleic:r(O.ricinoleic),oleic:r(O.oleic),linoleic:r(O.linoleic),linolenic:r(O.linolenic)},h=D(E);return{hardness:(h.hardness||0)/100,cleansing:(h.cleansing||0)/100,conditioning:(h.conditioning||0)/100,bubbly:(h.bubbly||0)/100,creamy:(h.creamy||0)/100}}e.calc={computeIodine:g,computeFattyAcids:M,computeQualities:D,computeOilQualityScores:x},P.SoapCalcService=e.calc})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g,clamp:M}=e.helpers,{UNIT_FACTORS:D}=e.constants,x=e.state;function O(c){return M(g(c),0)*(D[x.currentUnit]||1)}function E(c){return M(c,0)/(D[x.currentUnit]||1)}function h(c){return!isFinite(c)||c<=0?"--":`${r(E(c),2)} ${x.currentUnit}`}function f(c){return isFinite(c)?`${r(c,1)}%`:"--"}function I(){document.querySelectorAll(".unit-label").forEach(c=>{c.textContent=x.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(c=>{c.dataset.suffix=x.currentUnit})}function U(c,u={}){if(!c)return;if(c===x.currentUnit){I();return}let v=x.currentUnit;if(x.currentUnit=c,I(),u.skipConvert)return;let q=(D[v]||1)/(D[c]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let n=g(d.value);n>0&&(d.value=r(n*q,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let n=g(d.value);n>0&&(d.value=r(n*q,2))});let a=document.getElementById("oilTotalTarget");if(a&&a.value){let d=g(a.value);d>0&&(a.value=r(d*q,2))}let i=document.getElementById("moldWaterWeight");if(i&&i.value){let d=g(i.value);d>0&&(i.value=r(d*q,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),u.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:O,fromGrams:E,formatWeight:h,formatPercent:f,updateUnitLabels:I,setUnit:U}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.state,g={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function M(a){a&&(a.classList.remove("soap-number-pulse"),a.offsetWidth,a.classList.add("soap-number-pulse"))}function D(a){var d;let i=document.getElementById(a);return!i||!((d=P.bootstrap)!=null&&d.Toast)?null:bootstrap.Toast.getOrCreateInstance(i)}function x(){let a=Date.now();if(a-r.lastSaveToastAt<3500)return;r.lastSaveToastAt=a;let i=D("soapAutosaveToast");i&&i.show()}function O(a){let i=document.getElementById("soapUndoToast");if(!i)return;let d=i.querySelector(".toast-body");d&&(d.textContent=a||"Oil removed.");let n=D("soapUndoToast");n&&n.show()}function E(){let a=document.getElementById("resultsReadyBadge"),i=document.getElementById("resultsUpdatedAt");a&&a.classList.remove("d-none"),i&&(i.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function h(a){var C,w;let i=document.getElementById("lyeConcentrationWarning"),d=document.getElementById("waterRatioWarning"),n=[];if(i){let A=(a==null?void 0:a.lyeConcentration)||0,y="";A>40&&(y="High concentration"),A>0&&A<25&&(y="Low concentration"),i.textContent=y,i.classList.toggle("d-none",!y),y&&n.push(`Lye concentration: ${y.toLowerCase()}.`)}if(d){let A=(a==null?void 0:a.waterRatio)||0,y="";A>0&&A<1.8&&(y="Low water"),A>2.7&&(y="High water"),d.textContent=y,d.classList.toggle("d-none",!y),y&&n.push(`Water to lye ratio: ${y.toLowerCase()}.`)}n.length?(C=e.guidance)==null||C.setSection("results-water-warnings",{title:"Process warnings",tone:"warning",items:n}):(w=e.guidance)==null||w.clearSection("results-water-warnings")}function f(){document.querySelectorAll("#soapToolPage .form-text").forEach(a=>{let i=a.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");i&&i.classList.add("soap-field")})}function I(a){if(!a||a.type!=="number")return;let i=a.value;if(i===""){a.classList.remove("is-invalid");return}let d=parseFloat(i),n=a.getAttribute("min"),C=a.getAttribute("max"),w=n!==null&&n!==""&&d<parseFloat(n),A=C!==null&&C!==""&&d>parseFloat(C);a.classList.toggle("is-invalid",!isFinite(d)||w||A)}function U(a){var d;if(!a)return;let i=((d=a.querySelector)==null?void 0:d.call(a,".soap-stage-card"))||a;i.classList.add("soap-stage-highlight"),setTimeout(()=>i.classList.remove("soap-stage-highlight"),900)}function c(a){var C,w;let i=document.getElementById(a),d=(w=(C=i==null?void 0:i.content)==null?void 0:C.cloneNode)==null?void 0:w.call(C,!0);if(!d)return null;let n=d.firstElementChild||d.querySelector("*");return{fragment:d,root:n}}function u(a,i,d){if(!a)return;let n=Array.isArray(d)?d.filter(y=>typeof y=="string"&&y.trim()):[];if(!n.length){a.textContent="";return}let C=c("soapTitledListTemplate");if(C!=null&&C.root){let y=C.root.querySelector('[data-role="title"]'),G=C.root.querySelector('[data-role="list"]');y&&(y.textContent=i||""),G&&(G.innerHTML="",n.forEach(b=>{let t=document.createElement("li");t.textContent=b,G.appendChild(t)})),a.replaceChildren(C.fragment);return}a.innerHTML="";let w=document.createElement("strong");w.textContent=i||"";let A=document.createElement("ul");A.className="mb-0",n.forEach(y=>{let G=document.createElement("li");G.textContent=y,A.appendChild(G)}),a.appendChild(w),a.appendChild(A)}function v(a,i,d={}){var y;let n=document.getElementById("soapAlertStack");if(!n)return;let C=g[a]||g.info,w=c("soapAlertTemplate"),A=(w==null?void 0:w.root)||document.createElement("div");if(w){A.classList.add(`alert-${a}`);let G=A.querySelector('[data-role="icon"]');G&&G.classList.add(C);let b=A.querySelector('[data-role="message"]');b&&(b.innerHTML=i);let t=A.querySelector('[data-role="dismiss"]');t&&t.classList.toggle("d-none",!d.dismissible)}else{A.className="alert d-flex align-items-start gap-2";let G=document.createElement("i");G.className=`fas ${C} mt-1`;let b=document.createElement("div");if(b.className="flex-grow-1",b.innerHTML=i,A.appendChild(G),A.appendChild(b),d.dismissible){let t=document.createElement("button");t.type="button",t.className="btn-close",t.dataset.role="dismiss",A.appendChild(t)}}A.classList.add(`alert-${a}`,"d-flex","align-items-start","gap-2"),d.dismissible&&((y=A.querySelector('[data-role="dismiss"]'))==null||y.addEventListener("click",()=>A.remove())),n.prepend(A),d.persist||setTimeout(()=>{A.parentNode&&A.remove()},d.timeoutMs||4500)}function q(){let a=document.getElementById("soapAlertStack");a&&a.querySelectorAll(".alert").forEach(i=>i.remove())}e.ui={pulseValue:M,getToastInstance:D,showAutosaveToast:x,showUndoToast:O,updateResultsMeta:E,updateResultsWarnings:h,applyHelperVisibility:f,validateNumericField:I,flashStage:U,renderTitledList:u,showSoapAlert:v,clearSoapAlerts:q}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=new Map,g=!1;function M(u){if(!Array.isArray(u))return[];let v=new Set,q=[];return u.forEach(a=>{let i=String(a||"").trim();!i||v.has(i)||(v.add(i),q.push(i))}),q}function D(){return Array.from(r.values()).filter(u=>!u.persistent&&u.items.length)}function x(){let v=D().reduce((q,a)=>q+a.items.length,0);return v?v===1?{totalItems:v,text:"1 active formula hint from your current configuration."}:{totalItems:v,text:`${v} active formula hints from your current configuration.`}:{totalItems:0,text:"No active formula hints from your current configuration."}}function O(){let u=document.getElementById("soapGuidanceSections"),v=document.getElementById("soapGuidanceSummary"),q=document.getElementById("soapGuidanceCount"),a=document.getElementById("soapGuidanceEmpty");if(!u||!v||!q||!a)return;let i=x();v.textContent=i.text,q.textContent=String(i.totalItems);let d=Array.from(r.values()).filter(n=>n.items.length);u.innerHTML="",d.forEach(n=>{let C=document.createElement("section");C.className=`soap-guidance-section ${n.tone?`is-${n.tone}`:""}`.trim();let w=document.createElement("h6");w.className="soap-guidance-section-title",w.textContent=n.title||"Guidance";let A=document.createElement("ul");A.className="soap-guidance-list",n.items.forEach(y=>{let G=document.createElement("li");G.textContent=y,A.appendChild(G)}),C.appendChild(w),C.appendChild(A),u.appendChild(C)}),a.classList.toggle("d-none",d.length>0)}function E(u,v={}){if(!u)return;let q=M(v.items);if(!q.length){r.delete(u),O();return}r.set(u,{key:u,title:v.title||"Guidance",tone:v.tone||"",persistent:!!v.persistent,items:q}),O()}function h(u){u&&r.has(u)&&(r.delete(u),O())}function f(u){let v=document.getElementById("soapGuidanceDock"),q=document.getElementById("soapGuidanceToggle"),a=document.getElementById("soapGuidanceOverlay");if(!v||!q)return;g=!!u,v.classList.toggle("is-expanded",g),a&&a.setAttribute("aria-hidden",g?"false":"true"),q.setAttribute("aria-expanded",g?"true":"false");let i=g?"Collapse guidance panel":"Expand guidance panel";q.setAttribute("aria-label",i),q.setAttribute("title",i);let d=q.querySelector("i");d&&(d.classList.toggle("fa-caret-up",!g),d.classList.toggle("fa-caret-down",g))}function I(u){if(typeof u=="boolean"){f(u);return}f(!g)}function U(){let u=document.getElementById("soapGuidanceToggle");!u||u.dataset.bound==="true"||(u.dataset.bound="true",u.addEventListener("click",()=>I()))}function c(){U(),f(!1),E("core-safety",{title:"Safety",tone:"warning",persistent:!0,items:["Always add lye to water (never water to lye) and wear protective gear."]})}e.guidance={init:c,render:O,setSection:E,clearSection:h,setExpanded:f,toggleExpanded:I},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c,{once:!0}):c()})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function r(){let M=document.getElementById("soapStagePane"),D=document.getElementById("soapQualityCard"),x=document.getElementById("soapStageQualityRow"),O=document.getElementById("soapGuidanceDock");if(x&&O){let f=x.offsetHeight||0,I=Math.max(280,f+96);O.style.setProperty("--soap-guidance-overlay-height",`${I}px`)}if(!M||!D)return;if(!P.matchMedia("(min-width: 768px)").matches){M.classList.remove("is-height-synced"),M.style.removeProperty("--soap-stage-height");return}let h=D.offsetHeight;if(!h){M.classList.remove("is-height-synced"),M.style.removeProperty("--soap-stage-height");return}M.style.setProperty("--soap-stage-height",`${h}px`),M.classList.add("is-height-synced")}let g=()=>{P.requestAnimationFrame(r)};e.layout={syncStageHeight:r,scheduleStageHeightSync:g}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{clamp:r,toNumber:g,round:M}=e.helpers,{toGrams:D,fromGrams:x}=e.units;function O(){let c=I(),u=document.getElementById("oilTotalTarget"),v=document.getElementById("oilTargetHint");u&&c.effectiveCapacity>0&&D(u.value)<=0&&(u.value=c.targetOils>0?M(x(c.targetOils),2):""),v&&(c.effectiveCapacity>0?v.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":v.textContent="Auto-fills when mold sizing is set.");let q=document.getElementById("moldSuggestionNote");if(q){let a="Target oils are capped to the mold size above.";c.shape==="cylinder"&&c.waterWeight>0&&(c.useCylinder?a=`Cylinder correction applied (${M(c.cylinderFactor*100,0)}% of capacity).`:a="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),q.textContent=a}E()}function E(c=null){var y;let u=document.getElementById("moldWetBatterWarning");if(!u)return;let v=()=>{u.classList.add("d-none"),u.textContent=""},q=I(),a=e.state||{},i=a.lastCalc||null,d=(y=e.oils)!=null&&y.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,n=g(i==null?void 0:i.totalOils),C=g(c);if((!isFinite(C)||C<=0)&&(C=g(i==null?void 0:i.batchYield)),c==null&&n>0&&d>0&&Math.abs(n-d)>.01){v();return}if(!isFinite(C)||C<=0||q.effectiveCapacity<=0){v();return}let w=C-q.effectiveCapacity;if(w<=.01){v();return}let A=a.currentUnit||"g";u.textContent=`Full wet batter is ${M(x(C),2)} ${A}, exceeding mold capacity ${M(x(q.effectiveCapacity),2)} ${A} by ${M(x(w),2)} ${A}. Reduce oils target/% of mold or lower water/additives.`,u.classList.remove("d-none")}function h(){let c=document.getElementById("oilTotalTarget"),u=I();return c&&(u.effectiveCapacity>0&&(c.value=u.targetOils>0?M(x(u.targetOils),2):""),O()),u}function f(){let c=document.getElementById("oilTotalTarget"),u=document.getElementById("moldOilPct");if(!c||!u){let a=I();return O(),a}let v=I();if(v.effectiveCapacity>0){let a=D(c.value),i=r(a,0,v.effectiveCapacity);a>v.effectiveCapacity+.01&&(c.value=M(x(i),2));let d=i>0?i/v.effectiveCapacity*100:0;u.value=i>0?M(d,2):""}let q=I();return O(),q}function I(){var n,C,w;let c=D(document.getElementById("moldWaterWeight").value),u=r(g(document.getElementById("moldOilPct").value),0,100),v=((n=document.getElementById("moldShape"))==null?void 0:n.value)||"loaf",q=!!((C=document.getElementById("moldCylinderCorrection"))!=null&&C.checked),a=r(g((w=document.getElementById("moldCylinderFactor"))==null?void 0:w.value),.5,1),i=c>0?c*(q?a:1):0,d=i>0?i*(u/100):0;return{waterWeight:c,oilPct:u,shape:v,useCylinder:q,cylinderFactor:a,effectiveCapacity:i,targetOils:d}}function U(){var v;let c=((v=document.getElementById("moldShape"))==null?void 0:v.value)||"loaf",u=document.getElementById("moldCylinderOptions");u&&u.classList.toggle("d-none",c!=="cylinder"),O()}e.mold={updateMoldSuggested:O,updateWetBatterWarning:E,syncTargetFromMold:h,syncMoldPctFromTarget:f,getMoldSettings:I,updateMoldShapeUI:U}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g,clamp:M,buildSoapcalcSearchBuilder:D}=e.helpers,{toGrams:x,fromGrams:O}=e.units,{OIL_CATEGORY_SET:E}=e.constants,{computeQualities:h}=e.calc,f=e.state,I=new Map;function U(o){return o?(o.dataset.hintKey||(f.nextOilHintId=(f.nextOilHintId||0)+1,o.dataset.hintKey=`oil-row-${f.nextOilHintId}`),o.dataset.hintKey):""}function c(){let o=new Set(Array.from(document.querySelectorAll("#oilRows .oil-row")).map(m=>U(m)));Array.from(I.keys()).forEach(m=>{let F=m.split(":")[0];o.has(F)||I.delete(m)})}function u(){var m,F;let o=Array.from(new Set(Array.from(I.values())));if(!o.length){(m=e.guidance)==null||m.clearSection("oil-entry-limits");return}(F=e.guidance)==null||F.setSection("oil-entry-limits",{title:"Stage 2 limits",tone:"warning",items:o})}function v(o){let m=o.querySelector(".oil-typeahead"),F=o.querySelector(".oil-sap-koh"),B=o.querySelector(".oil-iodine"),R=o.querySelector(".oil-fatty"),k=o.querySelector(".oil-gi-id"),Y=o.querySelector(".oil-default-unit"),V=o.querySelector(".oil-category"),z=o.querySelector('[data-role="suggestions"]');if(!m||!z||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let j=D();P.attachMergedInventoryGlobalTypeahead({inputEl:m,listEl:z,mode:"public",giHiddenEl:k,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:j,searchType:"ingredient",resultFilter:(J,X)=>$(J,E,X),requireHidden:!1,onSelection:function(J){F&&(F.value=(J==null?void 0:J.saponification_value)||""),B&&(B.value=(J==null?void 0:J.iodine_value)||""),R&&(R.value=J!=null&&J.fatty_acid_profile?JSON.stringify(J.fatty_acid_profile):""),Y&&(Y.value=(J==null?void 0:J.default_unit)||""),V&&(V.value=(J==null?void 0:J.ingredient_category_name)||""),l(J),b(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),m.addEventListener("input",function(){this.value.trim()||(F&&(F.value=""),B&&(B.value=""),R&&(R.value=""),k&&(k.value=""),Y&&(Y.value=""),V&&(V.value=""),_())})}function q(){var F,B;let o=document.getElementById("oilRowTemplate"),m=(B=(F=o==null?void 0:o.content)==null?void 0:F.querySelector(".oil-row"))==null?void 0:B.cloneNode(!0);return m?(m.querySelectorAll("input").forEach(R=>{R.value=""}),m.querySelectorAll(".form-text").forEach(R=>{let k=R.closest('.soap-field-stack, [class*="col-"]');k&&k.classList.add("soap-field")}),v(m),m.querySelectorAll(".unit-suffix").forEach(R=>{R.dataset.suffix=f.currentUnit}),m):document.createElement("div")}function a(){let o=document.getElementById("oilTotalTarget"),m=x(o==null?void 0:o.value);if(m>0)return m;let F=e.mold.getMoldSettings();return F.targetOils>0?F.targetOils:0}function i(o){let m=[];return o.forEach(B=>{var Y,V;let R=x((Y=B.querySelector(".oil-grams"))==null?void 0:Y.value),k=M(g((V=B.querySelector(".oil-percent"))==null?void 0:V.value),0);R>0&&k>0&&m.push(R/(k/100))}),m.length?m.reduce((B,R)=>B+R,0)/m.length:0}function d(o,m){if(!o||!m||m<=0)return{allowedGrams:null,allowedPct:null};let F=Array.from(document.querySelectorAll("#oilRows .oil-row")),B=F.reduce((j,J)=>{var X;return J===o?j:j+x((X=J.querySelector(".oil-grams"))==null?void 0:X.value)},0),R=F.reduce((j,J)=>{var X;return J===o?j:j+M(g((X=J.querySelector(".oil-percent"))==null?void 0:X.value),0)},0),k=Math.max(0,100-R),Y=Math.max(0,m-B),V=m*k/100;return{allowedGrams:Math.max(0,Math.min(Y,V)),allowedPct:k}}function n(o,m,F){if(!o)return;let R=`${U(o)}:${m}`;F?I.set(R,F):I.delete(R),u()}function C(o){o&&(o.classList.remove("oil-input-bounce"),o.offsetWidth,o.classList.add("oil-input-bounce"))}function w(o,m,F={}){let B=a();if(!o||!B||B<=0){n(o,m,"");return}let R=o.querySelector(".oil-grams"),k=o.querySelector(".oil-percent"),Y=d(o,B);if(m==="grams"&&R){let V=x(R.value),z="";if(V>B+.01?z="Entry exceeds the max oils allowed in stage 2.":Y.allowedGrams!==null&&V>Y.allowedGrams+.01&&(z=`Must be under ${r(O(Y.allowedGrams),2)} ${f.currentUnit} to stay within the stage 2 oil limit.`),z){let j=Y.allowedGrams!==null?r(O(Y.allowedGrams),2):r(O(B),2);R.value=j>0?j:"",n(o,m,z),R.classList.add("oil-input-warning"),C(R),b()}else R.classList.remove("oil-input-warning"),n(o,m,"")}if(m==="percent"&&k){let V=M(g(k.value),0),z="";if(V>100.01?z="Entry exceeds the max oils allowed in stage 2.":Y.allowedPct!==null&&V>Y.allowedPct+.01&&(z=`Must be under ${r(Y.allowedPct,2)}% to stay within the stage 2 oil limit.`),z){let j=Y.allowedPct!==null?r(Y.allowedPct,2):100;k.value=j>0?j:"",n(o,m,z),k.classList.add("oil-input-warning"),C(k),b()}else k.classList.remove("oil-input-warning"),n(o,m,"")}}function A(o,m={}){let F=Array.from(document.querySelectorAll("#oilRows .oil-row")),B=o!=null?o:a(),R=!!m.force;if(!B||B<=0||!F.length){f.lastOilTarget=B;return}let k=F.reduce((V,z)=>{var j;return V+M(g((j=z.querySelector(".oil-percent"))==null?void 0:j.value),0)},0),Y=F.reduce((V,z)=>{var j;return V+x((j=z.querySelector(".oil-grams"))==null?void 0:j.value)},0);if(k<=0&&Y<=0){f.lastOilTarget=B;return}if(!(!R&&f.lastOilTarget&&Math.abs(f.lastOilTarget-B)<.01)){if(k>0)F.forEach(V=>{let z=V.querySelector(".oil-percent"),j=V.querySelector(".oil-grams"),J=M(g(z==null?void 0:z.value),0),X=k>0?J/k:0;j&&(j.value=X>0?r(O(B*X),2):""),z&&(z.value=X>0?r(X*100,2):"")});else if(Y>0){let V=B/Y;F.forEach(z=>{let j=z.querySelector(".oil-grams"),J=z.querySelector(".oil-percent"),X=x(j==null?void 0:j.value);if(j){let ee=X>0?X*V:0;j.value=ee>0?r(O(ee),2):""}if(J){let ee=x(j==null?void 0:j.value);J.value=ee>0?r(ee/B*100,2):""}})}f.lastOilTarget=B,b({skipEnforce:!0})}}function y(o,m){if(!f.lastOilEdit||!f.lastOilEdit.row)return!1;let F=f.lastOilEdit.row,B=o.reduce((V,z)=>{var j;return z===F?V:V+x((j=z.querySelector(".oil-grams"))==null?void 0:j.value)},0),R=Math.max(0,m-B),k=F.querySelector(".oil-grams"),Y=F.querySelector(".oil-percent");return!k||!Y?!1:(k.value=R>0?r(O(R),2):"",Y.value=R>0?r(R/m*100,2):"",f.wasCapped=!0,!0)}function G({totalWeight:o,totalPct:m,target:F,capped:B}){var k,Y;let R=[];if(B&&R.push("Oil total hit the mold cap and was adjusted."),F>0&&o>F+.01){let V=o-F;R.push(`Oil weights exceed the target by ${r(O(V),2)} ${f.currentUnit}.`)}if(m>100.01&&R.push(`Oil percentages are over 100% by ${r(m-100,2)}%.`),R.length){(k=e.guidance)==null||k.setSection("oil-cap-warning",{title:"Oil cap warnings",tone:"warning",items:[`${R.join(" ")} Adjust oils or mold % to continue.`]});return}(Y=e.guidance)==null||Y.clearSection("oil-cap-warning")}function b(o={}){var V;o.skipEnforce||(f.wasCapped=!1),c(),u();let m=Array.from(document.querySelectorAll("#oilRows .oil-row")),F=e.mold.getMoldSettings(),B=a();if(!B&&!F.targetOils){let z=i(m);if(z>0){B=z;let j=document.getElementById("oilTotalTarget");j&&!j.value&&(j.value=r(O(z),2))}}let R=0,k=0;if(m.forEach(z=>{let j=z.querySelector(".oil-grams"),J=z.querySelector(".oil-percent"),X=x(j==null?void 0:j.value),ee=M(g(J==null?void 0:J.value),0);B>0&&(f.lastOilEdit&&f.lastOilEdit.row===z&&f.lastOilEdit.field==="percent"?(X=ee>0?B*(ee/100):0,j.value=ee>0?r(O(X),2):""):X>0?(ee=X/B*100,J.value=r(ee,2)):ee>0&&(X=B*(ee/100),j.value=r(O(X),2)),k+=ee),X>0&&(R+=X)}),B<=0&&(R>0?(k=0,m.forEach(z=>{let j=z.querySelector(".oil-grams"),J=z.querySelector(".oil-percent"),X=x(j==null?void 0:j.value);if(X>0){let ee=X/R*100;J.value=r(ee,2),k+=ee}})):k=m.reduce((z,j)=>{var J;return z+M(g((J=j.querySelector(".oil-percent"))==null?void 0:J.value),0)},0)),!o.skipEnforce&&F.targetOils>0&&R>F.targetOils+.01&&y(m,F.targetOils))return b({skipEnforce:!0});f.totalOilsGrams=R;let Y=document.getElementById("oilTotalComputed");return Y&&(Y.textContent=R>0?`${r(O(R),2)} ${f.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=r(k,2),G({totalWeight:R,totalPct:k,target:B,capped:f.wasCapped}),e.additives.updateAdditivesOutput(R),(V=e.fragrances)!=null&&V.updateFragranceTotals&&e.fragrances.updateFragranceTotals(R),e.mold.updateMoldSuggested(),T(),{totalWeight:R,totalPct:k,target:B}}function t(){let o=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!o.length)return;let m=a(),F=o.reduce((B,R)=>{var k;return B+M(g((k=R.querySelector(".oil-percent"))==null?void 0:k.value),0)},0);!F&&m>0&&(F=o.reduce((B,R)=>{var Y;let k=x((Y=R.querySelector(".oil-grams"))==null?void 0:Y.value);return B+(k>0?k/m*100:0)},0)),!(F<=0)&&(o.forEach(B=>{let R=B.querySelector(".oil-percent"),k=B.querySelector(".oil-grams"),V=M(g(R.value),0)/F*100;R.value=r(V,2),m>0&&(k.value=V>0?r(O(m*(V/100)),2):"")}),b())}function p(){let o=[];return document.querySelectorAll("#oilRows .oil-row").forEach(m=>{var X,ee,oe,Z,ae,le,de,ce,W;let F=(ee=(X=m.querySelector(".oil-typeahead"))==null?void 0:X.value)==null?void 0:ee.trim(),B=x((oe=m.querySelector(".oil-grams"))==null?void 0:oe.value),R=g((Z=m.querySelector(".oil-sap-koh"))==null?void 0:Z.value),k=g((ae=m.querySelector(".oil-iodine"))==null?void 0:ae.value),Y=((le=m.querySelector(".oil-fatty"))==null?void 0:le.value)||"",V=((de=m.querySelector(".oil-gi-id"))==null?void 0:de.value)||"",z=((ce=m.querySelector(".oil-default-unit"))==null?void 0:ce.value)||"",j=((W=m.querySelector(".oil-category"))==null?void 0:W.value)||"",J=null;if(Y)try{J=JSON.parse(Y)}catch{J=null}B<=0||o.push({name:F||null,grams:B,sapKoh:R,iodine:k,fattyProfile:J,global_item_id:V?parseInt(V):null,default_unit:z||null,ingredient_category_name:j||null})}),o}function S({name:o,sapKoh:m,iodine:F,fattyProfile:B}={}){let R=document.getElementById("oilProfileFloat"),k=(ee,oe)=>{let Z=document.getElementById(ee);Z&&(Z.textContent=oe)},Y=o||"Pick an oil to preview";k("selectedOilName",Y),k("selectedOilModalName",Y),R&&R.classList.toggle("d-none",!o);let V=m>0?r(m,1):"--",z=F>0?r(F,1):"--";k("selectedOilSap",V),k("selectedOilModalSap",V),k("selectedOilIodine",z),k("selectedOilModalIodine",z);let j=B?h(B):{},J=(ee,oe)=>{let Z=isFinite(oe)&&oe>0?r(oe,1):"--";k(ee,Z)};J("selectedOilHardness",j.hardness),J("selectedOilModalHardness",j.hardness),J("selectedOilCleansing",j.cleansing),J("selectedOilModalCleansing",j.cleansing),J("selectedOilConditioning",j.conditioning),J("selectedOilModalConditioning",j.conditioning),J("selectedOilBubbly",j.bubbly),J("selectedOilModalBubbly",j.bubbly),J("selectedOilCreamy",j.creamy),J("selectedOilModalCreamy",j.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(ee=>{let oe=`selectedOil${ee.charAt(0).toUpperCase()}${ee.slice(1)}`,Z=`selectedOilModal${ee.charAt(0).toUpperCase()}${ee.slice(1)}`,ae=B?g(B[ee]):0,le=ae>0?r(ae,1):"--";k(oe,le),k(Z,le)})}function l(o){if(!o){_();return}f.selectedOilProfile=o;let m=o.fatty_acid_profile||null;if(typeof m=="string")try{m=JSON.parse(m)}catch{m=null}S({name:o.text||o.display_name||o.name,sapKoh:g(o.saponification_value),iodine:g(o.iodine_value),fattyProfile:m})}function s(o){var Y,V,z,j,J;if(!o)return;let m=(V=(Y=o.querySelector(".oil-typeahead"))==null?void 0:Y.value)==null?void 0:V.trim(),F=g((z=o.querySelector(".oil-sap-koh"))==null?void 0:z.value),B=g((j=o.querySelector(".oil-iodine"))==null?void 0:j.value),R=((J=o.querySelector(".oil-fatty"))==null?void 0:J.value)||"",k=null;if(R)try{k=JSON.parse(R)}catch{k=null}S({name:m,sapKoh:F,iodine:B,fattyProfile:k})}function _(){f.selectedOilProfile=null,f.lastPreviewRow=null,S()}function T(){var B,R;let o=f.lastCalc,m=f.totalOilsGrams||0,F=g(o==null?void 0:o.totalOils);if(!o||F<=0||m<=0||Math.abs(F-m)>.01){(B=e.guidance)==null||B.clearSection("oil-blend-tips");return}N(((R=o==null?void 0:o.qualityReport)==null?void 0:R.blend_tips)||[])}function N(o){var F,B;let m=Array.isArray(o)?o.filter(R=>typeof R=="string"&&R.trim()).slice(0,6):[];if(!m.length){(F=e.guidance)==null||F.clearSection("oil-blend-tips");return}(B=e.guidance)==null||B.setSection("oil-blend-tips",{title:"Blend behavior tips",tone:"info",items:m})}function L(){return f.totalOilsGrams||0}function H(o){var m,F,B,R,k,Y,V,z,j;return o?{name:((m=o.querySelector(".oil-typeahead"))==null?void 0:m.value)||"",grams:((F=o.querySelector(".oil-grams"))==null?void 0:F.value)||"",percent:((B=o.querySelector(".oil-percent"))==null?void 0:B.value)||"",sap:((R=o.querySelector(".oil-sap-koh"))==null?void 0:R.value)||"",iodine:((k=o.querySelector(".oil-iodine"))==null?void 0:k.value)||"",fattyRaw:((Y=o.querySelector(".oil-fatty"))==null?void 0:Y.value)||"",gi:((V=o.querySelector(".oil-gi-id"))==null?void 0:V.value)||"",defaultUnit:((z=o.querySelector(".oil-default-unit"))==null?void 0:z.value)||"",categoryName:((j=o.querySelector(".oil-category"))==null?void 0:j.value)||""}:null}function $(o,m,F){let B=K(o);return B?m.has(B):F==="inventory"}function K(o){return!o||typeof o!="object"?null:o.ingredient&&o.ingredient.ingredient_category_name||o.ingredient_category_name||o.ingredient_category&&o.ingredient_category.name||null}e.oils={attachOilTypeahead:v,buildOilRow:q,getOilTargetGrams:a,updateOilTotals:b,normalizeOils:t,collectOilData:p,setSelectedOilProfileFromRow:s,clearSelectedOilProfile:_,updateOilTips:T,renderOilTips:N,getTotalOilsGrams:L,serializeOilRow:H,validateOilEntry:w,scaleOilsToTarget:A}})(window);(function(P){"use strict";var b;let e=P.SoapTool=P.SoapTool||{},r=e.bulkOils=e.bulkOils||{},{toNumber:g,clamp:M}=e.helpers,D=e.state,x=Array.isArray((b=e.constants)==null?void 0:b.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],O=new Set(["selected_pct","selected_weight_g"]),E=25,h=140,f=260,I={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function U(){var t,p;(p=(t=e.storage)==null?void 0:t.queueStateSave)==null||p.call(t)}function c(t,p){var S,l;(l=(S=e.ui)==null?void 0:S.showSoapAlert)==null||l.call(S,t,p,{dismissible:!0,timeoutMs:6e3})}function u(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function v(t){return t?t==="name"||O.has(t)?!0:x.includes(t):!1}function q(){(!D.bulkOilModal||typeof D.bulkOilModal!="object")&&(D.bulkOilModal=JSON.parse(JSON.stringify(I)));let t=D.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=v(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function a(t){let p={},S=t&&typeof t=="object"?t:{};return x.forEach(l=>{let s=g(S[l]);s>0&&(p[l]=s)}),p}function i(t){let p=a(t==null?void 0:t.fatty_profile),S=String((t==null?void 0:t.name)||"").trim(),l=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",s=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:g(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(s?`global:${s}`:`${l}:${S.toLowerCase()}`)),name:S,sap_koh:g(t==null?void 0:t.sap_koh),iodine:g(t==null?void 0:t.iodine),fatty_profile:p,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:s,source:l,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=u(),p=q(),S=Object.keys(p.selection||{}).length,l=`Selected: ${S}`;t.summaryEl&&(t.summaryEl.textContent=l),t.stageCountEl&&(t.stageCountEl.textContent=String(S))}function n(t){var S;return((S=q().selection)==null?void 0:S[t])||null}function C(t,p={}){var _,T;let S=q();if(!t||!t.key)return null;let l=S.selection[t.key]||{},s={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:M(g((_=p.selected_pct)!=null?_:l.selected_pct),0,100),selected_weight_g:M(g((T=p.selected_weight_g)!=null?T:l.selected_weight_g),0)};return S.selection[t.key]=s,s}function w(t){var S;let p=q();(S=p.selection)!=null&&S[t]&&delete p.selection[t]}function A(t){var S;return((S=q().recordByKey)==null?void 0:S[t])||null}function y(){let t=q();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(p=>({key:p.key,name:p.name,sap_koh:p.sap_koh,iodine:p.iodine,fatty_profile:p.fatty_profile||{},default_unit:p.default_unit,ingredient_category_name:p.ingredient_category_name,global_item_id:p.global_item_id,source:p.source,is_basic:!!p.is_basic,selected_pct:M(g(p.selected_pct),0,100),selected_weight_g:M(g(p.selected_weight_g),0)}))}}function G(t){let p=q();p.mode="all",p.viewSelected=!!(t!=null&&t.view_selected),p.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",p.sortKey=v(t==null?void 0:t.sort_key)?t.sort_key:"name",p.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let S={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(s=>{let _=String((s==null?void 0:s.key)||"").trim(),T=String((s==null?void 0:s.name)||"").trim();!_||!T||(S[_]={key:_,name:T,sap_koh:g(s==null?void 0:s.sap_koh),iodine:g(s==null?void 0:s.iodine),fatty_profile:a(s==null?void 0:s.fatty_profile),default_unit:String((s==null?void 0:s.default_unit)||"gram"),ingredient_category_name:String((s==null?void 0:s.ingredient_category_name)||""),global_item_id:g(s==null?void 0:s.global_item_id)>0?parseInt(s.global_item_id,10):null,source:String((s==null?void 0:s.source)||"soapcalc"),is_basic:!!(s!=null&&s.is_basic),selected_pct:M(g(s==null?void 0:s.selected_pct),0,100),selected_weight_g:M(g(s==null?void 0:s.selected_weight_g),0)})}),p.selection=S,p.visibleRecords=[],p.offset=0,p.totalCount=0,p.hasMore=!0,p.loading=!1,d()}r.shared={FATTY_KEYS:x,LOCAL_SORT_KEYS:O,PAGE_SIZE:E,SCROLL_FETCH_THRESHOLD:h,SEARCH_DEBOUNCE_MS:f,queueStateSave:U,showAlert:c,getRefs:u,ensureModalState:q,normalizeFattyProfile:a,normalizeCatalogRecord:i,updateSelectionCounters:d,selectionForRecordKey:n,setSelection:C,removeSelection:w,getRecordByKey:A,serializeSelection:y,restoreState:G}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.bulkOils=e.bulkOils||{},g=r.shared;if(!g)return;let{round:M,toNumber:D}=e.helpers,{fromGrams:x}=e.units,{FATTY_KEYS:O,LOCAL_SORT_KEYS:E,getRefs:h,ensureModalState:f,selectionForRecordKey:I,updateSelectionCounters:U}=g;function c(b){let t=h();t.statusEl&&(t.statusEl.textContent=b)}function u(){let b=f();if(b.loading&&!b.visibleRecords.length){c("Loading oils...");return}if(!b.visibleRecords.length){let s=b.query?"No oils match that search.":"No oils available.";c(s);return}let t=b.visibleRecords.length,p=b.totalCount,S=b.hasMore?" \u2022 scroll for more":"",l=b.query?` \u2022 search: "${b.query}"`:"";c(`Showing ${t} of ${p} oils${l}${S}`)}function v(b,t,p){if(typeof b=="string"||typeof t=="string"){let s=String(b||"").toLowerCase(),_=String(t||"").toLowerCase();return s<_?p==="asc"?-1:1:s>_?p==="asc"?1:-1:0}let S=D(b),l=D(t);return S<l?p==="asc"?-1:1:S>l?p==="asc"?1:-1:0}function q(b,t){var p,S;return t==="selected_pct"?((p=I(b.key))==null?void 0:p.selected_pct)||0:t==="selected_weight_g"?((S=I(b.key))==null?void 0:S.selected_weight_g)||0:""}function a(){let b=f();E.has(b.sortKey)&&b.visibleRecords.sort((t,p)=>{let S=v(q(t,b.sortKey),q(p,b.sortKey),b.sortDir);return S!==0?S:v(t.name||"",p.name||"","asc")})}function i(){let b=f();if(!b.viewSelected)return;let t=[],p=[];b.visibleRecords.forEach(S=>{I(S.key)?t.push(S):p.push(S)}),b.visibleRecords=t.concat(p)}function d(){a(),i()}function n(b){let t=String(b||"").trim().toLowerCase();return t==="name"||O.includes(t)?t:"name"}function C(){let b=f();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let p=t.dataset.label||"",S=t.dataset.sortKey||"";b.sortKey===S?t.textContent=`${p} ${b.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=p})}function w(b,t){let p=I(t.key),S=b.querySelector(".bulk-oil-check"),l=b.querySelector(".bulk-oil-pct"),s=b.querySelector(".bulk-oil-weight");S&&(S.checked=!!p),l&&(l.value=p&&p.selected_pct>0?M(p.selected_pct,2):""),s&&(s.value=p&&p.selected_weight_g>0?M(x(p.selected_weight_g),2):"")}function A(b){let t=document.createElement("td");t.className="bulk-oil-acid";let p=D(b);return t.textContent=p>0?M(p,1).toString():"--",t}function y(b){let t=document.createElement("tr");t.dataset.recordKey=b.key;let p=document.createElement("td");p.className="text-center";let S=document.createElement("input");S.type="checkbox",S.className="form-check-input bulk-oil-check",p.appendChild(S),t.appendChild(p);let l=document.createElement("td");l.className="bulk-oil-name";let s=document.createElement("div");s.className="fw-semibold small",s.textContent=b.name;let _=document.createElement("div");_.className="text-muted small";let T=b.ingredient_category_name?` \xB7 ${b.ingredient_category_name}`:"";_.textContent=`${b.source}${T}`,l.appendChild(s),l.appendChild(_),t.appendChild(l),O.forEach(K=>{var o;t.appendChild(A((o=b.fatty_profile)==null?void 0:o[K]))});let N=document.createElement("td"),L=document.createElement("input");L.type="number",L.min="0",L.max="100",L.step="0.1",L.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",N.appendChild(L),t.appendChild(N);let H=document.createElement("td"),$=document.createElement("input");return $.type="number",$.min="0",$.step="0.1",$.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",H.appendChild($),t.appendChild(H),w(t,b),t}function G(){let b=h(),t=f();if(!b.bodyEl)return;b.bodyEl.innerHTML="";let p=document.createDocumentFragment();t.visibleRecords.forEach(S=>{p.appendChild(y(S))}),b.bodyEl.appendChild(p),C(),U(),u()}r.render={updateStatusText:c,refreshCatalogStatus:u,applyLocalSelectionSortIfNeeded:a,applyViewSelectedOrderingIfNeeded:i,applyClientOrdering:d,normalizeServerSortKey:n,sortButtonsLabel:C,renderVisibleRecords:G}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.bulkOils=e.bulkOils||{},g=r.shared,M=r.render;if(!g||!M)return;let{PAGE_SIZE:D,getRefs:x,ensureModalState:O,normalizeCatalogRecord:E}=g,{refreshCatalogStatus:h,normalizeServerSortKey:f,applyClientOrdering:I,renderVisibleRecords:U,updateStatusText:c}=M;function u(){let q=O(),a=x();q.visibleRecords=[],q.offset=0,q.totalCount=0,q.hasMore=!0,a.bodyEl&&(a.bodyEl.innerHTML=""),a.scrollEl&&(a.scrollEl.scrollTop=0)}async function v({reset:q=!1}={}){let a=O();if(!x().modalEl||a.loading&&!q||!a.hasMore&&!q)return;q&&u();let d=a.requestToken+1;a.requestToken=d,a.loading=!0,h();let n=new URLSearchParams;n.set("mode",a.mode),n.set("offset",String(a.offset)),n.set("limit",String(D)),n.set("q",a.query||""),n.set("sort_key",f(a.sortKey)),n.set("sort_dir",a.sortDir==="desc"?"desc":"asc");try{let C=await fetch(`/tools/api/soap/oils-catalog?${n.toString()}`);if(!C.ok)throw new Error("Unable to load oils catalog");let w=await C.json();if(!w||w.success!==!0||!w.result||!Array.isArray(w.result.records))throw new Error("Invalid oils catalog response");if(d!==a.requestToken)return;let A=w.result.records.map(E),y=Math.max(0,parseInt(w.result.next_offset,10)||a.offset+A.length),G=Math.max(A.length,parseInt(w.result.count,10)||0),b=!!w.result.has_more;A.forEach(t=>{a.recordByKey[t.key]=t}),a.visibleRecords=q?A.slice():a.visibleRecords.concat(A),a.offset=y,a.totalCount=G,a.hasMore=b,I(),U()}catch(C){throw d===a.requestToken&&c("Unable to load oils catalog."),C}finally{d===a.requestToken&&(a.loading=!1,h())}}r.api={fetchCatalogPage:v}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.bulkOils=e.bulkOils||{},g=r.shared,M=r.render,D=r.api;if(!g||!M||!D)return;let{round:x,toNumber:O,clamp:E}=e.helpers,{toGrams:h,fromGrams:f}=e.units,I=e.state,{LOCAL_SORT_KEYS:U,SCROLL_FETCH_THRESHOLD:c,SEARCH_DEBOUNCE_MS:u,queueStateSave:v,showAlert:q,getRefs:a,ensureModalState:i,updateSelectionCounters:d,setSelection:n,removeSelection:C,getRecordByKey:w,serializeSelection:A,restoreState:y}=g,{applyClientOrdering:G,sortButtonsLabel:b,renderVisibleRecords:t}=M,{fetchCatalogPage:p}=D,S=null,l=null;function s(){var Q;let W=a();W.modalEl&&(!S&&((Q=P.bootstrap)!=null&&Q.Modal)&&(S=P.bootstrap.Modal.getOrCreateInstance(W.modalEl)),S&&S.hide())}function _(){return document.getElementById("oilRows")}function T(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function N(W){return String(W||"").trim().toLowerCase()}function L(W){var Q;return N((Q=W==null?void 0:W.querySelector(".oil-typeahead"))==null?void 0:Q.value)}function H(W){var te;let Q=String(((te=W==null?void 0:W.querySelector(".oil-gi-id"))==null?void 0:te.value)||"").trim();return Q||""}function $(W,Q){let te=String(W||"").trim();if(!te)return null;let ne=T(),ie=ne.find(se=>String(se.dataset.bulkOilKey||"")===te);if(ie)return ie;let re=String((Q==null?void 0:Q.global_item_id)||"").trim();if(re&&(ie=ne.find(se=>H(se)===re),ie))return ie;let ue=N(Q==null?void 0:Q.name);return ue&&(ie=ne.find(se=>L(se)===ue),ie)?ie:null}function K(W,Q){if(!W||!Q)return;W.dataset.bulkOilKey=Q.key||"";let te=W.querySelector(".oil-typeahead"),ne=W.querySelector(".oil-sap-koh"),ie=W.querySelector(".oil-iodine"),re=W.querySelector(".oil-fatty"),ue=W.querySelector(".oil-gi-id"),se=W.querySelector(".oil-default-unit"),ge=W.querySelector(".oil-category"),fe=W.querySelector(".oil-grams"),me=W.querySelector(".oil-percent");te&&(te.value=Q.name||""),ne&&(ne.value=Q.sap_koh>0?x(Q.sap_koh,3):""),ie&&(ie.value=Q.iodine>0?x(Q.iodine,3):""),re&&(re.value=Q.fatty_profile&&Object.keys(Q.fatty_profile).length?JSON.stringify(Q.fatty_profile):""),ue&&(ue.value=Q.global_item_id||""),se&&(se.value=Q.default_unit||""),ge&&(ge.value=Q.ingredient_category_name||""),me&&(me.value=Q.selected_pct>0?x(Q.selected_pct,2):""),fe&&(fe.value=Q.selected_weight_g>0?x(f(Q.selected_weight_g),2):"")}function o(W){if(!W||!W.key)return null;let Q=$(W.key,W),te=_();return!Q&&te&&(Q=e.oils.buildOilRow(),Q&&te.appendChild(Q)),K(Q,W),Q}function m(W,Q){let te=$(W,Q);te&&(I.lastOilEdit&&I.lastOilEdit.row===te&&(I.lastOilEdit=null,e.oils.clearSelectedOilProfile()),te.remove())}function F(){T().forEach(Q=>{I.lastOilEdit&&I.lastOilEdit.row===Q&&(I.lastOilEdit=null),Q.remove()}),e.oils.clearSelectedOilProfile()}function B(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function R(W,Q,te){let ne=String(te||"").trim();if(ne)return ne;let ie=String(Q||"").trim();if(ie)return`global:${ie}`;let re=N(W);return re?`soapcalc:${re}`:""}function k(){let W={};return T().forEach(Q=>{var Se,he,ve,_e,be,Ee,Ie,Ce,Te;let te=String(((Se=Q.querySelector(".oil-typeahead"))==null?void 0:Se.value)||"").trim(),ne=O((he=Q.querySelector(".oil-sap-koh"))==null?void 0:he.value),ie=O((ve=Q.querySelector(".oil-iodine"))==null?void 0:ve.value),re=String(((_e=Q.querySelector(".oil-gi-id"))==null?void 0:_e.value)||"").trim(),ue=String(((be=Q.querySelector(".oil-default-unit"))==null?void 0:be.value)||"gram"),se=String(((Ee=Q.querySelector(".oil-category"))==null?void 0:Ee.value)||""),ge=E(O((Ie=Q.querySelector(".oil-percent"))==null?void 0:Ie.value),0,100),fe=E(h((Ce=Q.querySelector(".oil-grams"))==null?void 0:Ce.value),0),me=String(((Te=Q.querySelector(".oil-fatty"))==null?void 0:Te.value)||""),pe={};if(me)try{let qe=JSON.parse(me);pe=g.normalizeFattyProfile(qe)}catch{pe={}}let ye=R(te,re,Q.dataset.bulkOilKey);!ye||!(te||ge>0||fe>0||ne>0||ie>0||Object.keys(pe).length>0)||(Q.dataset.bulkOilKey=ye,W[ye]={key:ye,name:te||"Unnamed oil",sap_koh:ne,iodine:ie,fatty_profile:pe,default_unit:ue||"gram",ingredient_category_name:se,global_item_id:re?parseInt(re,10):null,source:re?"global":"soapcalc",is_basic:!re,selected_pct:ge,selected_weight_g:fe})}),W}function Y(){let W=i();W.selection=k(),d()}function V(){let W=i(),Q=Object.values(W.selection||{}),te=new Set(Q.map(ne=>ne.key));T().forEach(ne=>{let ie=String(ne.dataset.bulkOilKey||"").trim();(!ie||!te.has(ie))&&ne.remove()}),Q.slice().sort((ne,ie)=>String(ne.name||"").localeCompare(String(ie.name||""))).forEach(ne=>{o(ne)}),B()}async function z(){var te;let W=a(),Q=i();if(W.modalEl){Y(),!S&&((te=P.bootstrap)!=null&&te.Modal)&&(S=P.bootstrap.Modal.getOrCreateInstance(W.modalEl)),W.searchInput&&(W.searchInput.value=Q.query||""),W.viewSelectedToggle&&(W.viewSelectedToggle.checked=!!Q.viewSelected),W.unitLabelEl&&(W.unitLabelEl.textContent=I.currentUnit||"g"),S&&S.show(),b(),d();try{await p({reset:!0})}catch{q("danger","Unable to load bulk oils catalog right now.")}}}function j(W){let Q=W.target;if(!(Q instanceof HTMLElement))return;let te=Q.closest("tr[data-record-key]");if(!te)return;let ne=te.dataset.recordKey||"",ie=w(ne);if(!ie)return;let re=te.querySelector(".bulk-oil-check"),ue=te.querySelector(".bulk-oil-pct"),se=te.querySelector(".bulk-oil-weight"),ge=E(O(ue==null?void 0:ue.value),0,100),fe=E(h(se==null?void 0:se.value),0),me=ge>0||fe>0;if(!!(re!=null&&re.checked)||me){re&&(re.checked=!0);let Se=n(ie,{selected_pct:ge,selected_weight_g:fe});o(Se)}else C(ne),m(ne,ie);let ye=i();U.has(ye.sortKey)||ye.viewSelected?(G(),t()):d(),B(),v()}function J(W){let Q=i();Q.viewSelected=!!W,G(),t(),v()}async function X(W){let Q=W.target instanceof HTMLElement?W.target.closest(".bulk-oil-sort"):null;if(!Q)return;let te=Q.getAttribute("data-sort-key")||"name",ne=i();if(ne.sortKey===te?ne.sortDir=ne.sortDir==="asc"?"desc":"asc":(ne.sortKey=te,ne.sortDir=te==="name"?"asc":"desc"),v(),U.has(ne.sortKey)){G(),t();return}try{await p({reset:!0})}catch{q("danger","Unable to load oils in that sort order.")}}function ee(){let W=i();W.selection={},F(),(U.has(W.sortKey)||W.viewSelected)&&G(),t(),B(),v()}async function oe(){let W=a(),Q=i();if(!(!W.scrollEl||Q.loading||!Q.hasMore||!(W.scrollEl.scrollTop+W.scrollEl.clientHeight>=W.scrollEl.scrollHeight-c)))try{await p({reset:!1})}catch{q("danger","Unable to load more oils right now.")}}function Z(){l&&P.clearTimeout(l),l=P.setTimeout(async()=>{try{await p({reset:!0})}catch{q("danger","Unable to search oils right now.")}},u)}function ae(){V(),v(),s()}function le(W,Q){if(!(W instanceof HTMLInputElement))return!1;let ne=a().bodyEl;if(!(ne instanceof HTMLElement))return!1;let ie=W.classList.contains("bulk-oil-pct")?"bulk-oil-pct":W.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!ie)return!1;let re=Array.from(ne.querySelectorAll(`input.${ie}`)),ue=re.indexOf(W);if(ue<0)return!1;let se=ue+Q;if(se<0||se>=re.length)return!1;let ge=re[se];return ge instanceof HTMLInputElement?(ge.focus(),typeof ge.select=="function"&&ge.select(),!0):!1}function de(){var Q;let W=a();W.unitLabelEl&&(W.unitLabelEl.textContent=I.currentUnit||"g"),(Q=W.modalEl)!=null&&Q.classList.contains("show")&&t()}function ce(){let W=a();W.modalEl&&(W.openBtn&&W.openBtn.addEventListener("click",()=>{z()}),W.searchInput&&W.searchInput.addEventListener("input",()=>{let Q=i();Q.query=W.searchInput.value||"",v(),Z()}),W.viewSelectedToggle&&W.viewSelectedToggle.addEventListener("change",()=>{J(!!W.viewSelectedToggle.checked)}),W.scrollEl&&W.scrollEl.addEventListener("scroll",oe),W.bodyEl&&(W.bodyEl.addEventListener("change",j),W.bodyEl.addEventListener("keydown",Q=>{let te=Q.target;if(!(!(te instanceof HTMLInputElement)||!(te.classList.contains("bulk-oil-pct")||te.classList.contains("bulk-oil-weight")))){if(Q.key==="Enter"){Q.preventDefault(),te.blur();return}Q.key==="Tab"&&le(te,Q.shiftKey?-1:1)&&Q.preventDefault()}})),W.modalEl.querySelectorAll(".bulk-oil-sort").forEach(Q=>{Q.addEventListener("click",X)}),W.importBtn&&W.importBtn.addEventListener("click",()=>{ae()}),W.clearBtn&&W.clearBtn.addEventListener("click",()=>{ee()}),W.modalEl.addEventListener("shown.bs.modal",()=>{let Q=a();Q.searchInput&&Q.searchInput.focus()}))}ce(),d(),b(),e.bulkOilsModal={openModal:z,serializeSelection:A,restoreState:y,onUnitChanged:de}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:r,round:g,clamp:M,buildSoapcalcSearchBuilder:D}=e.helpers,{formatWeight:x,toGrams:O,fromGrams:E}=e.units,{FRAGRANCE_CATEGORY_SET:h,CITRIC_LYE_FACTORS:f}=e.constants,I=e.state;function U(t,p,S,l,s){var K;let _=document.getElementById(t),T=document.getElementById(p),N=l?document.getElementById(l):null,L=s?document.getElementById(s):null,H=(K=_==null?void 0:_.parentElement)==null?void 0:K.querySelector('[data-role="suggestions"]');if(!_||!H||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let $=D();P.attachMergedInventoryGlobalTypeahead({inputEl:_,listEl:H,mode:"public",giHiddenEl:T,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:$,searchType:"ingredient",resultFilter:(o,m)=>{let F=b(o);return F?S.has(F):m==="inventory"},requireHidden:!1,onSelection:function(o){N&&(N.value=(o==null?void 0:o.default_unit)||""),L&&(L.value=(o==null?void 0:o.ingredient_category_name)||""),e.storage.queueStateSave()}}),_.addEventListener("input",function(){this.value.trim()||(N&&(N.value=""),L&&(L.value=""))})}function c({pctId:t,weightId:p}){var T,N,L;let S=document.getElementById(t),l=S==null?void 0:S.value;if(l!==""&&l!==null&&l!==void 0)return r(l);let s=M(((N=(T=e.oils)==null?void 0:T.getTotalOilsGrams)==null?void 0:N.call(T))||0,0);if(s<=0)return 0;let _=O((L=document.getElementById(p))==null?void 0:L.value);return _<=0?0:_/s*100}function u(){var s,_,T,N,L,H,$,K,o,m,F,B,R,k,Y,V,z,j,J,X;let t=((s=document.getElementById("additiveLactateGi"))==null?void 0:s.value)||"",p=((_=document.getElementById("additiveSugarGi"))==null?void 0:_.value)||"",S=((T=document.getElementById("additiveSaltGi"))==null?void 0:T.value)||"",l=((N=document.getElementById("additiveCitricGi"))==null?void 0:N.value)||"";return{lactatePct:c({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:c({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:c({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:c({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((H=(L=document.getElementById("additiveLactateName"))==null?void 0:L.value)==null?void 0:H.trim())||"Sodium Lactate",sugarName:((K=($=document.getElementById("additiveSugarName"))==null?void 0:$.value)==null?void 0:K.trim())||"Sugar",saltName:((m=(o=document.getElementById("additiveSaltName"))==null?void 0:o.value)==null?void 0:m.trim())||"Salt",citricName:((B=(F=document.getElementById("additiveCitricName"))==null?void 0:F.value)==null?void 0:B.trim())||"Citric Acid",lactateGlobalItemId:t?parseInt(t):void 0,sugarGlobalItemId:p?parseInt(p):void 0,saltGlobalItemId:S?parseInt(S):void 0,citricGlobalItemId:l?parseInt(l):void 0,lactateDefaultUnit:((R=document.getElementById("additiveLactateUnit"))==null?void 0:R.value)||void 0,sugarDefaultUnit:((k=document.getElementById("additiveSugarUnit"))==null?void 0:k.value)||void 0,saltDefaultUnit:((Y=document.getElementById("additiveSaltUnit"))==null?void 0:Y.value)||void 0,citricDefaultUnit:((V=document.getElementById("additiveCitricUnit"))==null?void 0:V.value)||void 0,lactateCategoryName:((z=document.getElementById("additiveLactateCategory"))==null?void 0:z.value)||void 0,sugarCategoryName:((j=document.getElementById("additiveSugarCategory"))==null?void 0:j.value)||void 0,saltCategoryName:((J=document.getElementById("additiveSaltCategory"))==null?void 0:J.value)||void 0,citricCategoryName:((X=document.getElementById("additiveCitricCategory"))==null?void 0:X.value)||void 0}}function v(){var p;return(((p=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:p.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function q(t){var K,o;let p=M(r(t),0),S=M(c({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),l=M(c({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),s=M(c({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),_=M(c({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),T=p*(S/100),N=p*(l/100),L=p*(s/100),H=p*(_/100),$=v()==="KOH"?(K=f==null?void 0:f.KOH)!=null?K:.71:(o=f==null?void 0:f.NaOH)!=null?o:.624;return{lactatePct:S,sugarPct:l,saltPct:s,citricPct:_,lactateG:T,sugarG:N,saltG:L,citricG:H,citricLyeG:H*$}}function a({pctId:t,weightId:p,sourceField:S,totalOils:l}){let s=document.getElementById(t),_=document.getElementById(p);if(!s||!_)return;let T=M(r(l),0);if(T<=0)return;if(S==="weight"){let $=_.value;if($===""||$===null||$===void 0){s.value="";return}let K=M(O($),0),o=K>0?K/T*100:0;s.value=o>0?g(o,2):"";return}let N=s.value;if(N===""||N===null||N===void 0){_.value="";return}let L=M(r(N),0),H=T*(L/100);_.value=H>0?g(E(H),2):""}function i(t){let p=(l,s)=>{let _=document.getElementById(l);if(_)if(_.tagName==="INPUT"){if(document.activeElement===_)return;_.value=s}else _.textContent=s},S=l=>l>0?g(E(l),2):"";p("additiveLactateWeight",S(r(t==null?void 0:t.lactateG))),p("additiveSugarWeight",S(r(t==null?void 0:t.sugarG))),p("additiveSaltWeight",S(r(t==null?void 0:t.saltG))),p("additiveCitricWeight",S(r(t==null?void 0:t.citricG))),p("additiveCitricLyeOut",x(r(t==null?void 0:t.citricLyeG)))}function d(t){let p=M(r(t),0),S=q(p);return i(S),S}function n(t){let p=t.querySelector(".fragrance-typeahead"),S=t.querySelector(".fragrance-gi-id"),l=t.querySelector(".fragrance-default-unit"),s=t.querySelector(".fragrance-category"),_=t.querySelector('[data-role="suggestions"]');if(!p||!_||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let T=D();P.attachMergedInventoryGlobalTypeahead({inputEl:p,listEl:_,mode:"public",giHiddenEl:S,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:T,searchType:"ingredient",resultFilter:(N,L)=>{let H=b(N);return H?h.has(H):L==="inventory"},requireHidden:!1,onSelection:function(N){l&&(l.value=(N==null?void 0:N.default_unit)||""),s&&(s.value=(N==null?void 0:N.ingredient_category_name)||""),e.storage.queueStateSave()}}),p.addEventListener("input",function(){this.value.trim()||(l&&(l.value=""),s&&(s.value=""))})}function C(){var S,l;let t=document.getElementById("fragranceRowTemplate"),p=(l=(S=t==null?void 0:t.content)==null?void 0:S.querySelector(".fragrance-row"))==null?void 0:l.cloneNode(!0);return p?(p.querySelectorAll("input").forEach(s=>{s.value=""}),n(p),p.querySelectorAll(".unit-suffix").forEach(s=>{s.dataset.suffix=I.currentUnit}),p):document.createElement("div")}function w(t){let p=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),S=M(t||e.oils.getTotalOilsGrams()||0,0),l=0,s=0;p.forEach(N=>{let L=N.querySelector(".fragrance-grams"),H=N.querySelector(".fragrance-percent");if(!L||!H)return;let $=L.value,K=H.value,o=O($),m=M(r(K),0),F=e.state.lastFragranceEdit,B=F&&F.row===N?F.field:null;S>0&&(B==="percent"?(o=S*(m/100),L.value=o>0?g(E(o),2):""):B==="grams"?(m=o/S*100,H.value=m>0?g(m,2):""):o>0?(m=o/S*100,document.activeElement!==H&&(H.value=g(m,2))):m>0&&(o=S*(m/100),document.activeElement!==L&&(L.value=g(E(o),2)))),o>0&&(l+=o),s+=m});let _=document.getElementById("fragrancePercentTotal");_&&(_.textContent=g(s,2));let T=document.getElementById("fragranceTotalComputed");return T&&(T.textContent=l>0?x(l):"--"),{totalGrams:l,totalPct:s}}function A(t){let p=[],S=M(t||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(l=>{var o,m,F,B,R,k,Y;let s=(m=(o=l.querySelector(".fragrance-typeahead"))==null?void 0:o.value)==null?void 0:m.trim(),_=((F=l.querySelector(".fragrance-gi-id"))==null?void 0:F.value)||"",T=((B=l.querySelector(".fragrance-default-unit"))==null?void 0:B.value)||"",N=((R=l.querySelector(".fragrance-category"))==null?void 0:R.value)||"",L=(k=l.querySelector(".fragrance-grams"))==null?void 0:k.value,H=(Y=l.querySelector(".fragrance-percent"))==null?void 0:Y.value,$=O(L),K=M(r(H),0);$<=0&&K>0&&S>0&&($=S*(K/100)),!(!s&&!_&&$<=0)&&p.push({name:s||"Fragrance/Essential Oils",globalItemId:_?parseInt(_):void 0,defaultUnit:T||void 0,categoryName:N||void 0,grams:$,pct:K})}),p}function y(){let t=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(p=>{var L,H,$,K,o,m,F;let S=((H=(L=p.querySelector(".fragrance-typeahead"))==null?void 0:L.value)==null?void 0:H.trim())||"",l=(($=p.querySelector(".fragrance-grams"))==null?void 0:$.value)||"",s=((K=p.querySelector(".fragrance-percent"))==null?void 0:K.value)||"",_=((o=p.querySelector(".fragrance-gi-id"))==null?void 0:o.value)||"",T=((m=p.querySelector(".fragrance-default-unit"))==null?void 0:m.value)||"",N=((F=p.querySelector(".fragrance-category"))==null?void 0:F.value)||"";!S&&!l&&!s&&!_||t.push({name:S,grams:l,percent:s,gi:_,defaultUnit:T,categoryName:N})}),t}function G(t){var S,l;let p=Array.isArray(t==null?void 0:t.tips)&&t.tips.length?t.tips:[];if(!p.length){(S=e.guidance)==null||S.clearSection("visual-guidance");return}(l=e.guidance)==null||l.setSection("visual-guidance",{title:"Visual guidance",tone:"info",items:p})}function b(t){return!t||typeof t!="object"?null:t.ingredient&&t.ingredient.ingredient_category_name||t.ingredient_category_name||t.ingredient_category&&t.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:U,collectAdditiveSettings:u,syncAdditivePair:a,applyComputedOutputs:i,updateAdditivesOutput:d,updateVisualGuidance:G},e.fragrances={buildFragranceRow:C,updateFragranceTotals:w,collectFragranceRows:A,collectFragranceData:y}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:r}=e.helpers,{STAGE_CONFIGS:g,DEFAULT_INPUTS:M}=e.constants;function D(h){var U;let f=g[h];if(!f)return;let I=document.getElementById(f.tabId);if(I){if((U=P.bootstrap)!=null&&U.Tab)bootstrap.Tab.getOrCreateInstance(I).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(u=>{u.classList.remove("active"),u.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(u=>{u.classList.remove("show","active")}),I.classList.add("active"),I.setAttribute("aria-selected","true");let c=document.getElementById(f.paneId);c&&c.classList.add("show","active")}e.layout.scheduleStageHeightSync(),I.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function x(h){var I,U,c,u,v,q,a,i,d,n,C,w,A;let f=M||{};if(h===1){let y=f.unit||"g",G=document.querySelector(`input[name="weight_unit"][value="${y}"]`)||document.getElementById("unitGrams");G&&(G.checked=!0),e.units.setUnit(y,{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value=String((I=f.moldOilPct)!=null?I:65),document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value=f.moldShape||"loaf";let b=document.getElementById("moldCylinderCorrection");b&&(b.checked=!!f.moldCylinderCorrection),document.getElementById("moldCylinderFactor").value=String((U=f.moldCylinderFactor)!=null?U:.85),e.mold.updateMoldShapeUI(),(c=e.mold)!=null&&c.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(h===2){let y=document.getElementById("oilRows");y&&(y.innerHTML="",y.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(h===3){let y=f.lyeType||"NaOH",G=document.querySelector(`input[name="lye_type"][value="${y}"]`)||document.getElementById("lyeTypeNaoh");G&&(G.checked=!0);let b=document.getElementById("waterMethod");b&&(b.value=f.waterMethod||"percent");let t=document.getElementById("lyeSuperfat");t&&(t.value=String((u=f.superfatPct)!=null?u:5));let p=document.getElementById("lyePurity");p&&(p.value=String((v=f.lyePurityPct)!=null?v:100));let S=document.getElementById("waterPct");S&&(S.value=String((q=f.waterPct)!=null?q:33));let l=document.getElementById("lyeConcentration");l&&(l.value=String((a=f.lyeConcentrationPct)!=null?a:33));let s=document.getElementById("waterRatio");s&&(s.value=String((i=f.waterRatio)!=null?i:2)),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(h===4&&(document.getElementById("additiveLactatePct").value=String((d=f.additiveLactatePct)!=null?d:1),document.getElementById("additiveSugarPct").value=String((n=f.additiveSugarPct)!=null?n:1),document.getElementById("additiveSaltPct").value=String((C=f.additiveSaltPct)!=null?C:.5),document.getElementById("additiveCitricPct").value=String((w=f.additiveCitricPct)!=null?w:0),["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(y=>{let G=document.getElementById(y);G&&(G.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(y=>{let G=document.getElementById(y);G&&(G.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),h===5){let y=document.getElementById("fragranceRows");y&&(y.innerHTML="",(A=e.fragrances)!=null&&A.buildFragranceRow&&y.appendChild(e.fragrances.buildFragranceRow()));let G=document.getElementById("fragrancePercentTotal");G&&(G.textContent="0");let b=document.getElementById("fragranceTotalComputed");b&&(b.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),E()}function O(h){var f;if(h===1){let I=r(document.getElementById("moldWaterWeight").value),U=r(document.getElementById("oilTotalTarget").value),c=r(document.getElementById("moldOilPct").value),v=!!document.querySelector('input[name="weight_unit"]:checked')&&(I>0||U>0)&&c>0;return{state:v?"complete":"incomplete",label:v?"Sized":"Needs target"}}if(h===2){let U=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(c=>{var a,i,d,n;let u=(i=(a=c.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:i.trim(),v=r((d=c.querySelector(".oil-grams"))==null?void 0:d.value),q=r((n=c.querySelector(".oil-percent"))==null?void 0:n.value);return u&&(v>0||q>0)});return{state:U?"complete":"incomplete",label:U?"Oils added":"Add oils"}}if(h===3){let I=r(document.getElementById("lyeSuperfat").value),U=(f=document.getElementById("waterMethod"))==null?void 0:f.value,u=!!document.querySelector('input[name="lye_type"]:checked')&&!!U&&I>=0;return{state:u?"complete":"incomplete",label:u?"Configured":"Set lye"}}return h===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(U=>r(document.getElementById(U).value)>0)?"Added":"Optional"}:h===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(c=>{var a,i,d,n;let u=(i=(a=c.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:i.trim(),v=r((d=c.querySelector(".fragrance-grams"))==null?void 0:d.value),q=r((n=c.querySelector(".fragrance-percent"))==null?void 0:n.value);return u||v>0||q>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function E(){let h=document.getElementById("soapStageTabList");h&&h.querySelectorAll(".soap-stage-status").forEach(I=>I.remove());let f=document.getElementById("soapStageProgress");f&&(f.textContent="")}e.stages={openStageByIndex:D,resetStage:x,updateStageStatuses:E}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g,clamp:M}=e.helpers,{QUALITY_RANGES:D,QUALITY_HINTS:x,QUALITY_FEEL_HINTS:O,IODINE_RANGE:E,IODINE_SCALE_MAX:h,INS_RANGE:f,INS_SCALE_MAX:I,QUALITY_BASE:U,QUALITY_PRESETS:c,FATTY_BAR_COLORS:u,FATTY_DISPLAY_KEYS:v}=e.constants,{pulseValue:q,showSoapAlert:a}=e.ui;function i({barId:S,fillId:l,value:s,max:_,label:T}){let N=document.getElementById(S),L=document.getElementById(l);if(!N||!L)return null;let H=isFinite(s)?s:0,$=Math.max(0,Math.min(_,H)),K=_>0?$/_*100:0;return L.style.width=`${K}%`,N.setAttribute("aria-valuemin","0"),N.setAttribute("aria-valuemax",String(_)),N.setAttribute("aria-valuenow",$.toFixed(1)),T&&N.setAttribute("aria-label",T),{bar:N,fill:L,value:H}}function d(S,l,s){if(!(!S||!s)){if(S.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(l)){S.classList.add("bg-secondary");return}l<s[0]?S.classList.add("bg-warning"):l>s[1]?S.classList.add("bg-danger"):S.classList.add("bg-success")}}function n(S,l,s,_,T,N){let L=i({barId:S,fillId:l,value:s,max:T,label:N});L&&d(L.fill,s,_)}function C(){let S={hardness:{range:D.hardness,scale:100},cleansing:{range:D.cleansing,scale:100},conditioning:{range:D.conditioning,scale:100},bubbly:{range:D.bubbly,scale:100},creamy:{range:D.creamy,scale:100},iodine:{range:E,scale:h},ins:{range:f,scale:I}};Object.entries(S).forEach(([l,s])=>{let[_,T]=s.range,N=s.scale,L=l.charAt(0).toUpperCase()+l.slice(1),H=l==="iodine"?"iodineBar":l==="ins"?"insBar":`quality${L}Bar`,$=document.getElementById(`quality${L}Safe`);if($){let F=Math.max(0,Math.min(100,_/N*100)),B=Math.max(0,Math.min(100,(T-_)/N*100));$.style.left=`${F}%`,$.style.width=`${B}%`,$.title=`Safe range ${r(_,0)}-${r(T,0)}`}let K=document.getElementById(H);K&&(K.dataset.safeRange=`${r(_,0)}-${r(T,0)}`);let o=document.getElementById(`quality${L}RangeMin`),m=document.getElementById(`quality${L}RangeMax`);o&&(o.textContent=r(_,0)),m&&(m.textContent=r(T,0))})}function w(S,l){let s=M(S.hardness||0,0,100),_=M(S.bubbly||0,0,100),T=M(S.conditioning||0,0,100),N=M(T+(l||0)*3,0,100),L=document.getElementById("feelHardness"),H=document.getElementById("feelBubbly"),$=document.getElementById("feelConditioning"),K=document.getElementById("feelGreasy");L&&(L.value=r(s,1)),H&&(H.value=r(_,1)),$&&($.value=r(T,1)),K&&(K.value=r(N,1))}function A(S){v.forEach(l=>{let s=document.getElementById(`fattyBar${l.charAt(0).toUpperCase()}${l.slice(1)}`);if(!s)return;let _=M(g(S[l]),0,100),T=_;s.style.width=`${T}%`,s.style.backgroundColor=u[l]||"var(--color-muted)",s.title=`${l.charAt(0).toUpperCase()}${l.slice(1)}: ${r(_,1)}%`})}function y(){var _;let S=((_=document.getElementById("qualityPreset"))==null?void 0:_.value)||"balanced",l=Array.from(document.querySelectorAll(".quality-focus:checked"));if(S==="none"&&!l.length)return null;let s=S==="none"?{...U}:c[S]?{...c[S]}:{...U};return l.forEach(T=>{let N=T.dataset.attr,L=T.dataset.direction,H=D[N];H&&(s[N]=L==="low"?H[0]:H[1])}),s}function G(){let S=y(),l={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(l).forEach(([s,_])=>{if(!_)return;let T=document.getElementById(`${_.id}Label`);if(!S){_.classList.add("d-none"),T&&(T.textContent="");return}let N=g(S[s]);if(!isFinite(N)){_.classList.add("d-none"),T&&(T.textContent="");return}let L=s==="iodine"?h:s==="ins"?I:100,H=M(N,0,L);_.classList.remove("d-none"),_.style.left=`${H/L*100}%`,_.setAttribute("aria-label",`Apply ${s} target`),_.setAttribute("role","button"),_.setAttribute("tabindex","0"),_.title=`Target ${s}: ${r(N,1)}`,T&&(T.textContent=r(N,1))})}async function b(){var $,K;let S=y();if(!S){a("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let l=Array.from(document.querySelectorAll("#oilRows .oil-row")),s=l.map((o,m)=>{var z,j,J,X,ee,oe;let F=e.units.toGrams((z=o.querySelector(".oil-grams"))==null?void 0:z.value),B=((j=o.querySelector(".oil-fatty"))==null?void 0:j.value)||"",R=((X=(J=o.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:X.trim())||null,k=g((ee=o.querySelector(".oil-sap-koh"))==null?void 0:ee.value),Y=g((oe=o.querySelector(".oil-iodine"))==null?void 0:oe.value),V=null;if(B)try{V=JSON.parse(B)}catch{V=null}return{row:o,rowIndex:m,name:R,grams:F,sapKoh:k,iodine:Y,fattyProfile:V}}).filter(o=>o.grams>0);if(!s.length){a("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let _=e.oils.getOilTargetGrams()||s.reduce((o,m)=>o+m.grams,0),T={oils:s.map(o=>({row_index:o.rowIndex,name:o.name,grams:o.grams,sap_koh:o.sapKoh,iodine:o.iodine,fatty_profile:o.fattyProfile})),targets:S,target_oils_g:_},N=await((K=($=e.runnerService)==null?void 0:$.applyQualityNudge)==null?void 0:K.call($,T));if(!N||N.ok!==!0){let o=(N==null?void 0:N.error)||"Unable to nudge blend right now. Please try again.";a("warning",o,{dismissible:!0,timeoutMs:6e3});return}(Array.isArray(N.warnings)?N.warnings:[]).forEach(o=>{a("info",o,{dismissible:!0,timeoutMs:5e3})}),(Array.isArray(N.adjusted_rows)?N.adjusted_rows:[]).forEach(o=>{let m=Number(o==null?void 0:o.index),F=g(o==null?void 0:o.grams);if(!isFinite(m)||m<0||!isFinite(F))return;let B=l[m];if(!B)return;let R=B.querySelector(".oil-grams"),k=B.querySelector(".oil-percent");if(R&&(R.value=F>0?r(e.units.fromGrams(F),2):""),k&&_>0){let Y=F/_*100;k.value=Y>0?r(Y,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),a("info",N.message||"Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function t(S){var J,X,ee,oe;let{qualities:l,fattyPercent:s,coveragePct:_,iodine:T,ins:N,sapAvg:L,superfat:H,warnings:$}=S,K=_>0,o=[];function m(Z,ae){var Q,te;let le=document.getElementById(`quality${Z}Value`);if(!le)return;le.textContent=K&&isFinite(ae)?r(ae,1):"--",q(le);let de=Z.toLowerCase(),ce=D[de],W=i({barId:`quality${Z}Bar`,fillId:`quality${Z}Fill`,value:K?ae:0,max:100,label:Z});W&&ce&&(d(W.fill,ae,ce),K&&isFinite(ae)?W.bar.title=`${Z}: ${r(ae,1)} (safe ${ce[0]}-${ce[1]}). ${x[de]||""}`.trim():W.bar.title=`${Z}: -- (safe ${ce[0]}-${ce[1]}). ${x[de]||""}`.trim()),ce&&K&&isFinite(ae)&&(ae<ce[0]?o.push(`${Z}: ${((Q=O[de])==null?void 0:Q.low)||"Below preferred range."}`):ae>ce[1]&&o.push(`${Z}: ${((te=O[de])==null?void 0:te.high)||"Above preferred range."}`))}m("Hardness",l.hardness),m("Cleansing",l.cleansing),m("Conditioning",l.conditioning),m("Bubbly",l.bubbly),m("Creamy",l.creamy);let F=document.getElementById("fattyCoverageNote");F&&(F.textContent=_>0?`Fatty acid coverage: ${r(_,1)}% of oils`:"Fatty acid coverage: not enough data yet");let B=document.getElementById("iodineValue"),R=document.getElementById("insValue"),k=document.getElementById("sapAvgValue");B&&(B.textContent=T>0?r(T,1):"--",q(B)),R&&(R.textContent=N>0?r(N,1):"--",q(R)),k&&(k.textContent=L>0?r(L,1):"--",q(k)),n("iodineBar","iodineFill",T,E,h,"Iodine"),n("insBar","insFill",N,f,I,"INS");let Y=(s.lauric||0)+(s.myristic||0)+(s.palmitic||0)+(s.stearic||0),V=(s.ricinoleic||0)+(s.oleic||0)+(s.linoleic||0)+(s.linolenic||0),z=document.getElementById("fattySatRatioResult");z&&(z.textContent=Y+V>0?`${r(Y,0)}:${r(V,0)}`:"--",q(z)),v.forEach(Z=>{let ae=`fatty${Z.charAt(0).toUpperCase()}${Z.slice(1)}`,le=s[Z];document.getElementById(ae).textContent=K&&le?`${r(le,1)}%`:"--"}),w(l,H||0),A(s),G();let j=Array.isArray($)?$.slice():[];o.length?(J=e.guidance)==null||J.setSection("quality-feel-hints",{title:"Quality feel hints",tone:"info",items:o}):(X=e.guidance)==null||X.clearSection("quality-feel-hints"),j.length?(ee=e.guidance)==null||ee.setSection("quality-warning-flags",{title:"Quality flags",tone:"warning",items:j}):(oe=e.guidance)==null||oe.clearSection("quality-warning-flags"),e.layout.scheduleStageHeightSync()}function p(){var S;document.querySelectorAll(".soap-quality-help").forEach(l=>{let s=l.dataset.quality;x[s]&&l.setAttribute("title",x[s])}),(S=P.bootstrap)!=null&&S.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(l=>{bootstrap.Tooltip.getOrCreateInstance(l)})}e.quality={setQualityRangeBars:C,updateQualityTargets:G,applyQualityTargets:b,updateQualitiesDisplay:t,initQualityTooltips:p}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function r(O,E){let h=[];return document.querySelectorAll(`#${O} .row`).forEach(function(f){var q,a,i;let I=(a=(q=f.querySelector(".tool-typeahead"))==null?void 0:q.value)==null?void 0:a.trim(),U=((i=f.querySelector(".tool-gi-id"))==null?void 0:i.value)||"",c=f.querySelector(".tool-qty"),u=f.querySelector(".tool-unit"),v=c&&c.value!=="";!I&&!U||(E==="container"?h.push({name:I||void 0,global_item_id:U?parseInt(U):void 0,quantity:v?parseFloat(c.value):1}):h.push({name:I||void 0,global_item_id:U?parseInt(U):void 0,quantity:v?parseFloat(c.value):0,unit:((u==null?void 0:u.value)||"").trim()||"gram"}))}),h}function g(O){let E=e.config.isAuthenticated?"member":"public",h=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(O,{context:E,mode:h,unitOptionsHtml:e.config.unitOptionsHtml})}function M(O,E){let h=g(O),f=h.querySelector(".tool-typeahead"),I=h.querySelector(".tool-qty");f&&(f.value=E),I&&O==="container"&&(I.value=1),O==="container"?document.getElementById("tool-containers").appendChild(h):O==="consumable"?document.getElementById("tool-consumables").appendChild(h):document.getElementById("tool-ingredients").appendChild(h)}function D(O){if(!O||typeof O!="object")return null;try{let E=JSON.parse(JSON.stringify(O));return E&&typeof E=="object"&&delete E.export,E}catch{return null}}function x(O){var U,c;let E=D(O);if(!E)return null;let h=((U=document.getElementById("qualityPreset"))==null?void 0:U.value)||"balanced",f=Array.from(document.querySelectorAll(".quality-focus:checked")).map(u=>u.id),I=(c=e.mold)!=null&&c.getMoldSettings?e.mold.getMoldSettings():null;return{calc:E,draft_lines:{ingredients:r("tool-ingredients","ingredient"),consumables:r("tool-consumables","consumable"),containers:r("tool-containers","container")},context:{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit||"g",input_mode:"mixed",quality_preset:h,quality_focus:f,mold:I}}}e.recipePayload={collectDraftLines:r,buildLineRow:g,addStubLine:M,buildSoapRecipePayloadRequest:x}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g,clamp:M}=e.helpers,{formatWeight:D,formatPercent:x}=e.units,{DEFAULT_INPUTS:O}=e.constants;function E(){var A,y;let a=O||{},i=((A=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:A.value)||a.lyeType||"NaOH",d=document.getElementById("lyePurity"),n=d==null?void 0:d.value,C=g(d==null?void 0:d.value),w=i==="NaOH"?"NaOH":"KOH";return(n===""||n===null||n===void 0||!isFinite(C))&&(C=(y=a.lyePurityPct)!=null?y:100),{selected:i,lyeType:w,purity:C}}function h(){var d,n;let a=document.getElementById("lyePurity"),i=E();a&&(a.removeAttribute("readonly"),i.selected==="KOH90"?(d=e.guidance)==null||d.setSection("lye-purity",{title:"Lye setup",tone:"info",items:["90% KOH selected. Safe default purity is 90%."]}):(n=e.guidance)==null||n.clearSection("lye-purity"))}function f(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function I(a=null,i=null){var w,A;let d=document.getElementById("stageWaterOutput"),n=i||(a==null?void 0:a.waterMethod)||((w=document.getElementById("waterMethod"))==null?void 0:w.value)||"percent";if(d){let y=a&&isFinite(a.waterG)&&a.waterG>0;d.textContent=y?D(a.waterG):"--"}let C="";if(!a||!isFinite(a.totalOils)||a.totalOils<=0)C=`Set oils in Stage 2 to calculate water. ${f(n)}`;else if(n==="concentration"){let y=a.lyeConcentrationInput||a.lyeConcentration||0;C=`Using ${r(y,1)}% lye concentration from ${D(a.lyeAdjusted||0)} lye.`}else if(n==="ratio"){let y=a.waterRatioInput||a.waterRatio||0;C=`Using ${r(y,2)} : 1 water-to-lye ratio from ${D(a.lyeAdjusted||0)} lye.`}else C=`Using ${r(a.waterPct||0,1)}% of total oils (${D(a.totalOils)}).`;(A=e.guidance)==null||A.setSection("water-method",{title:"Lye & water hints",tone:"info",items:[C]})}function U(a=null,i=null){var s;let d=document.getElementById("lyeWaterPreviewAnchor"),n=document.getElementById("lyePreview"),C=document.getElementById("waterPreview"),w=document.getElementById("concPreview"),A=document.getElementById("ratioPreview");if(!d&&!n&&!C&&!w&&!A)return;let y=(_,T)=>{_&&(_.textContent=T)},G=i||(a==null?void 0:a.waterMethod)||((s=document.getElementById("waterMethod"))==null?void 0:s.value)||"percent",b=g(a==null?void 0:a.totalOils),t=g(a==null?void 0:a.lyeAdjusted),p=g(a==null?void 0:a.waterG);if(b<=0||t<=0){y(d,"Based on -- oils. All values update live as you change inputs."),y(n,"--"),y(C,"--"),y(w,"--"),y(A,"--");return}let S=g(a==null?void 0:a.lyeConcentration)>0?g(a==null?void 0:a.lyeConcentration):t+p>0?t/(t+p)*100:0,l=g(a==null?void 0:a.waterRatio)>0?g(a==null?void 0:a.waterRatio):t>0?p/t:0;if(y(d,`Based on ${D(b)} oils. All values update live as you change inputs.`),y(n,D(t)),y(C,D(p)),y(w,S>0?x(S):"--"),y(A,l>0?`${r(l,2)} : 1`:"--"),G==="concentration"){let _=g(a==null?void 0:a.lyeConcentrationInput);_>0&&y(w,x(_))}if(G==="ratio"){let _=g(a==null?void 0:a.waterRatioInput);_>0&&y(A,`${r(_,2)} : 1`)}}function c(){var i;let a=((i=document.getElementById("waterMethod"))==null?void 0:i.value)||"percent";document.querySelectorAll(".water-input").forEach(d=>{d.classList.toggle("d-none",d.dataset.method!==a)}),I(null,a),U(null,a)}function u(){let a=e.oils.updateOilTotals(),i=a.totalWeight,d=a.totalPct,n=[],C=e.oils.collectOilData(),w=e.oils.getOilTargetGrams(),y=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(G=>M(g(G.value),0)).some(G=>G>0);return(!C.length||i<=0)&&n.push("Add at least one oil with a weight or percent."),!w&&i<=0&&y&&n.push("Enter a total oils target or weights to convert percentages."),w>0&&d>0&&Math.abs(d-100)>.5&&n.push("Oil percentages should total 100% (use Normalize to fix)."),w>0&&i>w+.01?n.push("Oil weights exceed the mold target."):!w&&d>100.01&&n.push("Oil percentages exceed 100%."),{ok:n.length===0,errors:n,totals:a,oils:C}}function v(){var C;let a=O||{},i=document.getElementById("lyeSuperfat"),d=i==null?void 0:i.value,n=g(d);return(d===""||d===null||d===void 0||!isFinite(n))&&(n=(C=a.superfatPct)!=null?C:5),n}function q(){var y,G,b,t,p;let a=O||{},d=E().purity;isFinite(d)||(d=(y=a.lyePurityPct)!=null?y:100);let n=((G=document.getElementById("waterMethod"))==null?void 0:G.value)||"percent",C=g((b=document.getElementById("waterPct"))==null?void 0:b.value),w=g((t=document.getElementById("lyeConcentration"))==null?void 0:t.value),A=g((p=document.getElementById("waterRatio"))==null?void 0:p.value);return{purity:d,waterMethod:n,waterPct:C,lyeConcentration:w,waterRatio:A}}e.runnerInputs={getLyeSelection:E,applyLyeSelection:h,setWaterMethod:c,updateStageWaterSummary:I,updateLiveCalculationPreview:U,validateCalculation:u,readSuperfatInput:v,sanitizeLyeInputs:q}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{getStorage:r}=e.helpers;function g(){if(!e.config.calcLimit)return{count:0,date:null};let E=r();if(!E)return{count:0,date:null};try{let h=E.getItem("soap_calc_usage"),f=new Date().toISOString().slice(0,10);if(!h)return{count:0,date:f};let I=JSON.parse(h);return!I||I.date!==f?{count:0,date:f}:{count:Number(I.count)||0,date:f}}catch{return{count:0,date:null}}}function M(E){if(!e.config.calcLimit)return;let h=r();if(!h)return;let f=new Date().toISOString().slice(0,10);try{h.setItem("soap_calc_usage",JSON.stringify({count:E,date:f}))}catch{}}function D(){return e.config.calcLimit&&g().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function x(){if(!e.config.calcLimit)return;let h=g().count+1;M(h);let f=Math.max(0,e.config.calcLimit-h);f<=1&&e.ui.showSoapAlert("info",`You have ${f} calculation${f===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function O(E){if(!e.config.calcLimit||E===null||E>1)return;let h=document.getElementById("soapSignupModal");h&&(P.bootstrap&&P.bootstrap.Modal?P.bootstrap.Modal.getOrCreateInstance(h).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:D,consumeCalcQuota:x,maybeShowSignupModal:O}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.state;function g(){var h;return((h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.getAttribute("content"))||""}async function M(h,f,I=2500){let U=g(),c=new AbortController,u=P.setTimeout(()=>c.abort(),I);try{let v=await fetch(h,{method:"POST",signal:c.signal,headers:{"Content-Type":"application/json",...U?{"X-CSRFToken":U}:{}},body:JSON.stringify(f||{})});if(!v.ok)return null;let q=await v.json();return!q||q.success!==!0||typeof q.result!="object"?null:q.result}catch{return null}finally{P.clearTimeout(u)}}function D({oils:h,selection:f,superfat:I,purity:U,waterMethod:c,waterPct:u,lyeConcentration:v,waterRatio:q,totalOils:a}){var A,y;let i=e.additives.collectAdditiveSettings(),d=e.fragrances.collectFragranceRows(a||0),n=Array.from(document.querySelectorAll(".quality-focus:checked")).map(G=>G.id),C=((A=document.getElementById("qualityPreset"))==null?void 0:A.value)||"balanced",w=(y=e.mold)!=null&&y.getMoldSettings?e.mold.getMoldSettings():null;return{oils:(h||[]).map(G=>({name:G.name||null,grams:G.grams||0,sap_koh:G.sapKoh||0,iodine:G.iodine||0,fatty_profile:G.fattyProfile||null,global_item_id:G.global_item_id||null,default_unit:G.default_unit||null,ingredient_category_name:G.ingredient_category_name||null})),fragrances:d.map(G=>({name:G.name||"Fragrance/Essential Oils",grams:G.grams||0,pct:G.pct||0,global_item_id:G.globalItemId||null,default_unit:G.defaultUnit||null,ingredient_category_name:G.categoryName||null})),additives:{lactate_pct:i.lactatePct||0,sugar_pct:i.sugarPct||0,salt_pct:i.saltPct||0,citric_pct:i.citricPct||0,lactate_name:i.lactateName||"Sodium Lactate",sugar_name:i.sugarName||"Sugar",salt_name:i.saltName||"Salt",citric_name:i.citricName||"Citric Acid",lactate_global_item_id:i.lactateGlobalItemId||null,sugar_global_item_id:i.sugarGlobalItemId||null,salt_global_item_id:i.saltGlobalItemId||null,citric_global_item_id:i.citricGlobalItemId||null,lactate_default_unit:i.lactateDefaultUnit||null,sugar_default_unit:i.sugarDefaultUnit||null,salt_default_unit:i.saltDefaultUnit||null,citric_default_unit:i.citricDefaultUnit||null,lactate_category_name:i.lactateCategoryName||null,sugar_category_name:i.sugarCategoryName||null,salt_category_name:i.saltCategoryName||null,citric_category_name:i.citricCategoryName||null},lye:{selected:(f==null?void 0:f.selected)||"NaOH",superfat:I,purity:U},water:{method:c,water_pct:u,lye_concentration:v,water_ratio:q},meta:{unit_display:r.currentUnit||"g",quality_preset:C,quality_focus:n,mold:w}}}async function x(h){return M("/tools/api/soap/calculate",h,2500)}async function O(h){return M("/tools/api/soap/recipe-payload",h,3500)}async function E(h){return M("/tools/api/soap/quality-nudge",h,3500)}e.runnerService={buildServicePayload:D,calculateWithSoapService:x,buildRecipePayload:O,applyQualityNudge:E}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g}=e.helpers,{formatWeight:M,formatPercent:D}=e.units,x=e.state,O={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function E(c){return(c||[]).map(u=>{var v;return{name:u.name||null,grams:g(u.grams),sapKoh:g((v=u.sap_koh)!=null?v:u.sapKoh),iodine:g(u.iodine),fattyProfile:u.fatty_profile||u.fattyProfile||null,global_item_id:u.global_item_id||null,default_unit:u.default_unit||null,ingredient_category_name:u.ingredient_category_name||null}})}function h(c,u){let v=document.getElementById(c);v&&(v.textContent=u)}function f({resultsCard:c,lyeAdjusted:u,waterData:v,batchYield:q,totalOils:a,superfat:i}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let n=g(c.water_lye_ratio)||v.waterRatio;h("lyeAdjustedOutput",M(g(c.lye_adjusted_g)||u)),h("waterOutput",M(g(c.water_g)||v.waterG)),h("batchYieldOutput",M(q)),h("lyeConcentrationOutput",D(g(c.lye_concentration_pct)||v.lyeConcentration)),h("waterRatioOutput",isFinite(n)&&n>0?r(n,2).toString():"--"),h("totalOilsOutput",M(a)),h("superfatOutput",D(i)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(C=>e.ui.pulseValue(document.getElementById(C)))}function I({showAlerts:c,lyeTotals:u,purity:v,waterData:q}){if(!c)return;u.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),v<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${r(v,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(q.lyeConcentration<25||q.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let a=e.mold.getMoldSettings();a.shape==="cylinder"&&a.waterWeight>0&&!a.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function U({serviceResult:c,validation:u,selection:v,superfat:q,purity:a,waterMethod:i,waterPct:d,lyeConcentrationInput:n,waterRatioInput:C,showAlerts:w}){var Y,V;let A=c.lye_type||v.lyeType||"NaOH",y=c.lye_selected||v.selected||null,G=g(c.total_oils_g)||u.totals.totalWeight,b=g(c.superfat_pct),t=isFinite(b)?b:q,p={sapAvg:g(c.sap_avg_koh),usedFallback:!!c.used_sap_fallback},S=g(c.lye_pure_g),s=Object.prototype.hasOwnProperty.call(c,"lye_adjusted_base_g")?g(c.lye_adjusted_base_g):null,_=g(c.lye_adjusted_g),T=g(c.lye_purity_pct)||a,N=c.water_method||i,L=g(c.water_pct)||d,H=g(c.lye_concentration_input_pct)||n,$=g(c.water_ratio_input)||C,K={waterG:g(c.water_g),lyeConcentration:g(c.lye_concentration_pct),waterRatio:g(c.water_lye_ratio)},o=c.results_card||{},m=c.quality_report||{},F=E(c.oils||u.oils),B={waterG:K.waterG,lyeAdjusted:_,totalOils:G,waterMethod:N,waterPct:L,lyeConcentrationInput:H,waterRatioInput:$,lyeConcentration:K.lyeConcentration,waterRatio:K.waterRatio};e.runnerInputs.updateStageWaterSummary(B),e.runnerInputs.updateLiveCalculationPreview(B);let R=c.additives||O;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(R);let k=g(o.batch_yield_g)||G+_+K.waterG+R.fragranceG+R.lactateG+R.sugarG+R.saltG+R.citricG;return(Y=e.mold)!=null&&Y.updateWetBatterWarning&&e.mold.updateWetBatterWarning(k),f({resultsCard:o,lyeAdjusted:_,waterData:K,batchYield:k,totalOils:G,superfat:t}),e.ui.updateResultsWarnings(K),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:m.qualities||{},fattyPercent:m.fatty_acids_pct||{},coveragePct:g(m.coverage_pct),iodine:g(m.iodine),ins:g(m.ins),sapAvg:p.sapAvg,superfat:t,waterData:K,additives:R,oils:F,totalOils:G,warnings:m.warnings||[]}),(V=e.oils)!=null&&V.renderOilTips&&e.oils.renderOilTips(m.blend_tips||[]),e.additives.updateVisualGuidance({tips:m.visual_guidance||[]}),e.stages.updateStageStatuses(),I({showAlerts:w,lyeTotals:p,purity:T,waterData:K}),x.lastCalc={totalOils:G,oils:F,lyeType:A,lyeSelected:y,superfat:t,purity:T,lyePure:S,lyeAdjustedBase:s,lyeAdjusted:_,water:K.waterG,waterMethod:N,waterPct:L,lyeConcentration:K.lyeConcentration,waterRatio:K.waterRatio,sapAvg:p.sapAvg,usedSapFallback:p.usedFallback,additives:R,batchYield:k,qualityReport:m,export:c.export||null},x.lastCalc}e.runnerRender={applyServiceResult:U}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.state,g=e.runnerInputs,M=e.runnerQuota,D=e.runnerService,x=e.runnerRender;async function O(h){let f=e.recipePayload.buildSoapRecipePayloadRequest(h);return f?D.buildRecipePayload(f):null}async function E(h={}){var I;let f={consumeQuota:!1,showAlerts:!0,...h};try{f.showAlerts&&e.ui.clearSoapAlerts();let U=g.validateCalculation();if(!U.ok)return g.updateStageWaterSummary(null),g.updateLiveCalculationPreview(null),(I=e.mold)!=null&&I.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),f.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${U.errors.map(n=>`<li>${n}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(f.consumeQuota&&!M.canConsumeCalcQuota())return null;let c=g.readSuperfatInput(),u=g.getLyeSelection(),v=g.sanitizeLyeInputs(),q=(r.calcRequestSeq||0)+1;r.calcRequestSeq=q;let a=D.buildServicePayload({oils:U.oils,selection:u,superfat:c,purity:v.purity,waterMethod:v.waterMethod,waterPct:v.waterPct,lyeConcentration:v.lyeConcentration,waterRatio:v.waterRatio,totalOils:U.totals.totalWeight}),i=await D.calculateWithSoapService(a);if(q!==r.calcRequestSeq)return r.lastCalc;if(!i)return f.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let d=x.applyServiceResult({serviceResult:i,validation:U,selection:u,superfat:c,purity:v.purity,waterMethod:v.waterMethod,waterPct:v.waterPct,lyeConcentrationInput:v.lyeConcentration,waterRatioInput:v.waterRatio,showAlerts:f.showAlerts});return f.consumeQuota&&M.consumeCalcQuota(),d}catch{return f.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...h)=>g.getLyeSelection(...h),applyLyeSelection:(...h)=>g.applyLyeSelection(...h),setWaterMethod:(...h)=>g.setWaterMethod(...h),updateLiveCalculationPreview:(...h)=>g.updateLiveCalculationPreview(...h),calculateAll:E,buildSoapRecipePayload:O,buildLineRow:(...h)=>e.recipePayload.buildLineRow(...h),addStubLine:(...h)=>e.recipePayload.addStubLine(...h),maybeShowSignupModal:(...h)=>M.maybeShowSignupModal(...h)}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{formatTime:r,getStorage:g}=e.helpers,{DEFAULT_INPUTS:M}=e.constants,D="soap_tool_state_v2";function x(){return M||{}}function O(a,i){let d=[];return document.querySelectorAll(`#${a} .row`).forEach(C=>{var t,p,S;let w=(p=(t=C.querySelector(".tool-typeahead"))==null?void 0:t.value)==null?void 0:p.trim(),A=((S=C.querySelector(".tool-gi-id"))==null?void 0:S.value)||"",y=C.querySelector(".tool-qty"),G=C.querySelector(".tool-unit"),b=y&&y.value!==""?e.helpers.toNumber(y.value):null;!w&&!A||(i==="container"?d.push({name:w||"",global_item_id:A?parseInt(A):null,quantity:b&&b>0?b:1}):d.push({name:w||"",global_item_id:A?parseInt(A):null,quantity:b&&b>=0?b:0,unit:(G==null?void 0:G.value)||"gram"}))}),d}function E(){let a=[];return document.querySelectorAll("#oilRows .oil-row").forEach(i=>{var p,S,l,s,_,T,N,L,H,$;let d=((S=(p=i.querySelector(".oil-typeahead"))==null?void 0:p.value)==null?void 0:S.trim())||"",n=((l=i.querySelector(".oil-grams"))==null?void 0:l.value)||"",C=((s=i.querySelector(".oil-percent"))==null?void 0:s.value)||"",w=((_=i.querySelector(".oil-sap-koh"))==null?void 0:_.value)||"",A=((T=i.querySelector(".oil-iodine"))==null?void 0:T.value)||"",y=((N=i.querySelector(".oil-fatty"))==null?void 0:N.value)||"",G=((L=i.querySelector(".oil-gi-id"))==null?void 0:L.value)||"",b=((H=i.querySelector(".oil-default-unit"))==null?void 0:H.value)||"",t=(($=i.querySelector(".oil-category"))==null?void 0:$.value)||"";!d&&!n&&!C&&!G||a.push({name:d,grams:n,percent:C,sap:w,iodine:A,fattyRaw:y,gi:G,defaultUnit:b,categoryName:t})}),a}function h(){var i;if((i=e.fragrances)!=null&&i.collectFragranceData)return e.fragrances.collectFragranceData();let a=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(d=>{var b,t,p,S,l,s,_;let n=((t=(b=d.querySelector(".fragrance-typeahead"))==null?void 0:b.value)==null?void 0:t.trim())||"",C=((p=d.querySelector(".fragrance-grams"))==null?void 0:p.value)||"",w=((S=d.querySelector(".fragrance-percent"))==null?void 0:S.value)||"",A=((l=d.querySelector(".fragrance-gi-id"))==null?void 0:l.value)||"",y=((s=d.querySelector(".fragrance-default-unit"))==null?void 0:s.value)||"",G=((_=d.querySelector(".fragrance-category"))==null?void 0:_.value)||"";!n&&!C&&!w&&!A||a.push({name:n,grams:C,percent:w,gi:A,defaultUnit:y,categoryName:G})}),a}function f(a,i){let d=document.getElementById("oilRows");if(!d||!a)return;let n=e.oils.buildOilRow();n.querySelector(".oil-typeahead").value=a.name||"",n.querySelector(".oil-grams").value=a.grams||"",n.querySelector(".oil-percent").value=a.percent||"",n.querySelector(".oil-sap-koh").value=a.sap||"",n.querySelector(".oil-iodine").value=a.iodine||"",n.querySelector(".oil-fatty").value=a.fattyRaw||"",n.querySelector(".oil-gi-id").value=a.gi||"";let C=n.querySelector(".oil-default-unit");C&&(C.value=a.defaultUnit||"");let w=n.querySelector(".oil-category");w&&(w.value=a.categoryName||"");let A=Array.from(d.children);return i>=A.length?d.appendChild(n):d.insertBefore(n,A[i]),n}function I(){var n,C,w,A,y,G,b,t,p,S,l,s,_,T,N,L,H,$,K,o,m,F,B,R,k,Y,V,z,j,J,X,ee,oe,Z,ae;let a=g();if(!a)return;let i=x(),d={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:E(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||String((C=i.superfatPct)!=null?C:5),lye_type:((w=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:w.value)||i.lyeType||"NaOH",lye_purity:((A=document.getElementById("lyePurity"))==null?void 0:A.value)||String((y=i.lyePurityPct)!=null?y:100),water_method:((G=document.getElementById("waterMethod"))==null?void 0:G.value)||i.waterMethod||"percent",water_pct:((b=document.getElementById("waterPct"))==null?void 0:b.value)||"",lye_concentration:((t=document.getElementById("lyeConcentration"))==null?void 0:t.value)||"",water_ratio:((p=document.getElementById("waterRatio"))==null?void 0:p.value)||""},additives:{fragrances:h(),lactate_pct:document.getElementById("additiveLactatePct").value||String((S=i.additiveLactatePct)!=null?S:1),lactate_name:((l=document.getElementById("additiveLactateName"))==null?void 0:l.value)||"",lactate_gi:((s=document.getElementById("additiveLactateGi"))==null?void 0:s.value)||"",lactate_unit:((_=document.getElementById("additiveLactateUnit"))==null?void 0:_.value)||"",lactate_category:((T=document.getElementById("additiveLactateCategory"))==null?void 0:T.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||String((N=i.additiveSugarPct)!=null?N:1),sugar_name:((L=document.getElementById("additiveSugarName"))==null?void 0:L.value)||"",sugar_gi:((H=document.getElementById("additiveSugarGi"))==null?void 0:H.value)||"",sugar_unit:(($=document.getElementById("additiveSugarUnit"))==null?void 0:$.value)||"",sugar_category:((K=document.getElementById("additiveSugarCategory"))==null?void 0:K.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||String((o=i.additiveSaltPct)!=null?o:.5),salt_name:((m=document.getElementById("additiveSaltName"))==null?void 0:m.value)||"",salt_gi:((F=document.getElementById("additiveSaltGi"))==null?void 0:F.value)||"",salt_unit:((B=document.getElementById("additiveSaltUnit"))==null?void 0:B.value)||"",salt_category:((R=document.getElementById("additiveSaltCategory"))==null?void 0:R.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||String((k=i.additiveCitricPct)!=null?k:0),citric_name:((Y=document.getElementById("additiveCitricName"))==null?void 0:Y.value)||"",citric_gi:((V=document.getElementById("additiveCitricGi"))==null?void 0:V.value)||"",citric_unit:((z=document.getElementById("additiveCitricUnit"))==null?void 0:z.value)||"",citric_category:((j=document.getElementById("additiveCitricCategory"))==null?void 0:j.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||String((J=i.moldOilPct)!=null?J:65),shape:((X=document.getElementById("moldShape"))==null?void 0:X.value)||i.moldShape||"loaf",cylinder_correction:!!((ee=document.getElementById("moldCylinderCorrection"))!=null&&ee.checked),cylinder_factor:((oe=document.getElementById("moldCylinderFactor"))==null?void 0:oe.value)||String((Z=i.moldCylinderFactor)!=null?Z:.85)},quality:{preset:((ae=document.getElementById("qualityPreset"))==null?void 0:ae.value)||i.qualityPreset||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(le=>le.id)},lines:{ingredients:O("tool-ingredients","ingredient"),consumables:O("tool-consumables","consumable"),containers:O("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{a.setItem(D,JSON.stringify(d));let le=document.getElementById("soapLastSaved");le&&(le.textContent=r(d.updated_at)),e.ui.showAutosaveToast()}catch{}}function U(){var A,y,G,b,t,p,S,l,s,_,T,N;let a=g();if(!a)return;let i=x(),d=a.getItem(D);if(!d)return;let n=null;try{n=JSON.parse(d)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let L=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);L&&(L.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let C=document.getElementById("oilRows");if(C&&(C.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(H=>{let $=e.oils.buildOilRow();$.querySelector(".oil-typeahead").value=H.name||"",$.querySelector(".oil-grams").value=H.grams||"",$.querySelector(".oil-percent").value=H.percent||"",$.querySelector(".oil-sap-koh").value=H.sap||"",$.querySelector(".oil-iodine").value=H.iodine||"",$.querySelector(".oil-fatty").value=H.fattyRaw||"",$.querySelector(".oil-gi-id").value=H.gi||"";let K=$.querySelector(".oil-default-unit");K&&(K.value=H.defaultUnit||"");let o=$.querySelector(".oil-category");o&&(o.value=H.categoryName||""),C.appendChild($)})),n.lye_form){let L=document.getElementById("lyeSuperfat");L&&(L.value=n.lye_form.superfat||String((A=i.superfatPct)!=null?A:5));let H=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||i.lyeType||"NaOH"}"]`);H&&(H.checked=!0);let $=document.getElementById("lyePurity");$&&($.value=n.lye_form.lye_purity||String((y=i.lyePurityPct)!=null?y:100));let K=document.getElementById("waterMethod");K&&(K.value=n.lye_form.water_method||i.waterMethod||"percent");let o=document.getElementById("waterPct");o&&(o.value=n.lye_form.water_pct||"");let m=document.getElementById("lyeConcentration");m&&(m.value=n.lye_form.lye_concentration||"");let F=document.getElementById("waterRatio");F&&(F.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let L=document.getElementById("fragranceRows");if(L&&((G=e.fragrances)!=null&&G.buildFragranceRow)){L.innerHTML="";let oe=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(oe)oe.forEach(Z=>{let ae=e.fragrances.buildFragranceRow();ae.querySelector(".fragrance-typeahead").value=Z.name||"",ae.querySelector(".fragrance-grams").value=Z.grams||"",ae.querySelector(".fragrance-percent").value=Z.percent||"",ae.querySelector(".fragrance-gi-id").value=Z.gi||"";let le=ae.querySelector(".fragrance-default-unit");le&&(le.value=Z.defaultUnit||"");let de=ae.querySelector(".fragrance-category");de&&(de.value=Z.categoryName||""),L.appendChild(ae)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let Z=e.fragrances.buildFragranceRow();Z.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",Z.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||String((b=i.fragrancePct)!=null?b:3),Z.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",L.appendChild(Z)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||String((t=i.additiveLactatePct)!=null?t:1);let H=document.getElementById("additiveLactateName");H&&(H.value=n.additives.lactate_name||"");let $=document.getElementById("additiveLactateGi");$&&($.value=n.additives.lactate_gi||"");let K=document.getElementById("additiveLactateUnit");K&&(K.value=n.additives.lactate_unit||"");let o=document.getElementById("additiveLactateCategory");o&&(o.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||String((p=i.additiveSugarPct)!=null?p:1);let m=document.getElementById("additiveSugarName");m&&(m.value=n.additives.sugar_name||"");let F=document.getElementById("additiveSugarGi");F&&(F.value=n.additives.sugar_gi||"");let B=document.getElementById("additiveSugarUnit");B&&(B.value=n.additives.sugar_unit||"");let R=document.getElementById("additiveSugarCategory");R&&(R.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||String((S=i.additiveSaltPct)!=null?S:.5);let k=document.getElementById("additiveSaltName");k&&(k.value=n.additives.salt_name||"");let Y=document.getElementById("additiveSaltGi");Y&&(Y.value=n.additives.salt_gi||"");let V=document.getElementById("additiveSaltUnit");V&&(V.value=n.additives.salt_unit||"");let z=document.getElementById("additiveSaltCategory");z&&(z.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||String((l=i.additiveCitricPct)!=null?l:0);let j=document.getElementById("additiveCitricName");j&&(j.value=n.additives.citric_name||"");let J=document.getElementById("additiveCitricGi");J&&(J.value=n.additives.citric_gi||"");let X=document.getElementById("additiveCitricUnit");X&&(X.value=n.additives.citric_unit||"");let ee=document.getElementById("additiveCitricCategory");ee&&(ee.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||String((s=i.moldOilPct)!=null?s:65);let L=document.getElementById("moldShape");L&&(L.value=n.mold.shape||i.moldShape||"loaf");let H=document.getElementById("moldCylinderCorrection");H&&(H.checked=!!n.mold.cylinder_correction);let $=document.getElementById("moldCylinderFactor");$&&($.value=n.mold.cylinder_factor||String((_=i.moldCylinderFactor)!=null?_:.85));let K=document.getElementById("oilTotalTarget");(T=e.mold)!=null&&T.syncMoldPctFromTarget&&((N=e.mold)!=null&&N.syncTargetFromMold)&&(e.units.toGrams(K==null?void 0:K.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let L=document.getElementById("qualityPreset");if(L){let H=n.quality.preset||i.qualityPreset||"balanced",$=Array.from(L.options).find(K=>K.value===H);L.value=$?H:i.qualityPreset||"balanced"}document.querySelectorAll(".quality-focus").forEach(H=>{H.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(H.id)})}function w(L,H,$){let K=document.getElementById(L);K&&(K.innerHTML="",(H||[]).forEach(o=>{let m=e.runner.buildLineRow($),F=m.querySelector(".tool-typeahead"),B=m.querySelector(".tool-gi-id"),R=m.querySelector(".tool-qty"),k=m.querySelector(".tool-unit");F&&(F.value=o.name||""),B&&(B.value=o.global_item_id||""),R&&o.quantity!==void 0&&o.quantity!==null&&(R.value=o.quantity),k&&o.unit&&Array.from(k.options).find(V=>V.value===o.unit)&&(k.value=o.unit),K.appendChild(m)}))}if(n.lines&&(w("tool-ingredients",n.lines.ingredients,"ingredient"),w("tool-consumables",n.lines.consumables,"consumable"),w("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let L=document.getElementById("soapLastSaved");L&&(L.textContent=r(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let c=null;function u(){c&&clearTimeout(c),c=setTimeout(I,350)}let v=null;function q(){v&&clearTimeout(v),v=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:I,restoreState:U,serializeLines:O,serializeOils:E,restoreOilRow:f,queueStateSave:u,queueAutoCalc:q}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:r,toNumber:g,clamp:M}=e.helpers,{formatWeight:D}=e.units,x=e.state,O=90,E=120,h=80,f=130,I=50,U=200;function c(l){return l&&typeof l=="object"&&l.export&&typeof l.export.csv_text=="string"&&l.export.csv_text.trim()&&typeof l.export.sheet_html=="string"&&l.export.sheet_html.trim()}function u(l){var T;let s=g(l==null?void 0:l.totalOils),_=(T=e.oils)!=null&&T.getTotalOilsGrams?e.oils.getTotalOilsGrams():0;return s<=0||_<=0?!1:Math.abs(s-_)>.01}async function v(){var s,_;let l=x.lastCalc;return(!l||u(l)||!c(l))&&(l=await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0})),l?c(l)?l:((_=e.ui)!=null&&_.showSoapAlert&&e.ui.showSoapAlert("danger","Export payload is missing. Please run the calculation again.",{dismissible:!0,timeoutMs:6e3}),null):((s=e.ui)!=null&&s.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function q(l,s){let _=new Blob([l],{type:"text/csv;charset=utf-8;"}),T=URL.createObjectURL(_),N=document.createElement("a");N.href=T,N.download=s,document.body.appendChild(N),N.click(),document.body.removeChild(N),URL.revokeObjectURL(T)}function a(l){var _;let s=P.open("","_blank","width=960,height=720");if(!s){(_=e.ui)!=null&&_.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}s.document.open(),s.document.write(l),s.document.close(),s.focus(),s.onload=()=>s.print()}function i(l){var L;let s=(L=e.mold)!=null&&L.getMoldSettings?e.mold.getMoldSettings():null,_=g(s==null?void 0:s.effectiveCapacity),T=g(l==null?void 0:l.batchYield);if(_<=0||T<=0)return null;let N=T/_*100;return{moldCapacityG:_,batchYieldG:T,fillPct:N,differenceG:T-_}}function d(l){return l?l.fillPct<O||l.fillPct>E:!1}function n(l){if(l<O){let s=l<h;return{toneClass:s?"text-danger":"text-warning",messageClass:s?"alert-danger":"alert-warning",message:s?"This recipe is far below mold capacity and may underfill bars.":"This recipe is below your target range and may leave extra headspace."}}if(l>E){let s=l>f;return{toneClass:s?"text-danger":"text-warning",messageClass:s?"alert-danger":"alert-warning",message:s?"This recipe is far above mold capacity and has a high overflow risk.":"This recipe is above your target range and may overflow this mold."}}return{toneClass:"text-success",messageClass:"alert-success",message:"This recipe is inside your target fill range."}}function C(l){let s=g(l);return!isFinite(s)||Math.abs(s)<.01?D(0):s>0?`+${D(s)}`:`-${D(Math.abs(s))}`}function w(l){return new Promise(s=>{let _=document.getElementById("soapPrintConfirmModal");if(!_||!P.bootstrap){s({action:"print-as-is"});return}let T=P.bootstrap.Modal.getOrCreateInstance(_),N=document.getElementById("soapPrintConfirmBatchYield"),L=document.getElementById("soapPrintConfirmMoldCapacity"),H=document.getElementById("soapPrintConfirmFillPct"),$=document.getElementById("soapPrintConfirmDiff"),K=document.getElementById("soapPrintConfirmMessage"),o=document.getElementById("soapPrintNormalizePct"),m=document.getElementById("soapPrintAsIsBtn"),F=document.getElementById("soapNormalizePrintBtn");if(!m||!F){s({action:"print-as-is"});return}let B=n(l.fillPct);N&&(N.textContent=D(l.batchYieldG)),L&&(L.textContent=D(l.moldCapacityG)),H&&(H.textContent=`${r(l.fillPct,1)}%`,H.classList.remove("text-success","text-warning","text-danger"),H.classList.add(B.toneClass)),$&&($.textContent=C(l.differenceG)),K&&(K.textContent=B.message,K.classList.remove("alert-success","alert-info","alert-warning","alert-danger"),K.classList.add(B.messageClass)),o&&(o.value="100");let R=!1,k=()=>{m.removeEventListener("click",V),F.removeEventListener("click",z),o&&o.removeEventListener("keydown",j),_.removeEventListener("hidden.bs.modal",J)},Y=X=>{R||(R=!0,k(),s(X))},V=()=>{Y({action:"print-as-is"}),T.hide()},z=()=>{let X=g(o==null?void 0:o.value),ee=M(X>0?X:100,I,U);o&&(o.value=r(ee,2)),Y({action:"normalize",targetPct:ee}),T.hide()},j=X=>{X.key==="Enter"&&(X.preventDefault(),z())},J=()=>{Y(null)};m.addEventListener("click",V),F.addEventListener("click",z),o&&o.addEventListener("keydown",j),_.addEventListener("hidden.bs.modal",J),T.show(),o&&P.setTimeout(()=>o.focus(),120)})}function A(l,s){return(Array.isArray(l==null?void 0:l.oils)?l.oils:[]).map(T=>{var N;return{name:(T==null?void 0:T.name)||null,grams:g(T==null?void 0:T.grams)*s,sapKoh:g((N=T==null?void 0:T.sapKoh)!=null?N:T==null?void 0:T.sap_koh),iodine:g(T==null?void 0:T.iodine),fattyProfile:(T==null?void 0:T.fattyProfile)||(T==null?void 0:T.fatty_profile)||null,global_item_id:(T==null?void 0:T.global_item_id)||(T==null?void 0:T.globalItemId)||null,default_unit:(T==null?void 0:T.default_unit)||(T==null?void 0:T.defaultUnit)||null,ingredient_category_name:(T==null?void 0:T.ingredient_category_name)||(T==null?void 0:T.ingredientCategoryName)||null}}).filter(T=>T.grams>0)}function y(l,s){var N;return((Array.isArray((N=l==null?void 0:l.additives)==null?void 0:N.fragranceRows)?l.additives.fragranceRows:null)||e.fragrances.collectFragranceRows(g(l==null?void 0:l.totalOils)||0)).map(L=>({name:(L==null?void 0:L.name)||"Fragrance/Essential Oils",grams:g(L==null?void 0:L.grams)*s,pct:g(L==null?void 0:L.pct),global_item_id:(L==null?void 0:L.global_item_id)||(L==null?void 0:L.globalItemId)||null,default_unit:(L==null?void 0:L.default_unit)||(L==null?void 0:L.defaultUnit)||null,ingredient_category_name:(L==null?void 0:L.ingredient_category_name)||(L==null?void 0:L.categoryName)||(L==null?void 0:L.ingredientCategoryName)||null})).filter(L=>L.grams>0||L.pct>0)}async function G(l,s,_){var Y,V,z,j,J,X;if(!s||!l||!((Y=e.runnerService)!=null&&Y.buildServicePayload)||!((V=e.runnerService)!=null&&V.calculateWithSoapService))return null;let T=M(g(_)>0?g(_):100,I,U),N=s.moldCapacityG*(T/100),L=g(l.batchYield);if(!isFinite(N)||N<=0||!isFinite(L)||L<=0)return null;let H=N/L;if(!isFinite(H)||H<=0)return null;let $=A(l,H);if(!$.length)return null;let K=(z=e.runnerInputs)!=null&&z.getLyeSelection?e.runnerInputs.getLyeSelection():{selected:l.lyeSelected||l.lyeType||"NaOH"},o=(j=e.runnerInputs)!=null&&j.readSuperfatInput?e.runnerInputs.readSuperfatInput():g(l.superfat),m=(J=e.runnerInputs)!=null&&J.sanitizeLyeInputs?e.runnerInputs.sanitizeLyeInputs():{purity:g(l.purity),waterMethod:l.waterMethod||"percent",waterPct:g(l.waterPct),lyeConcentration:g(l.lyeConcentration),waterRatio:g(l.waterRatio)},F=(g(l.totalOils)||0)*H,B=e.runnerService.buildServicePayload({oils:$,selection:K,superfat:o,purity:m.purity,waterMethod:m.waterMethod,waterPct:m.waterPct,lyeConcentration:m.lyeConcentration,waterRatio:m.waterRatio,totalOils:F});B.fragrances=y(l,H),B.meta={...B.meta||{},normalize_print_target_fill_pct:T};let R=await e.runnerService.calculateWithSoapService(B),k=typeof((X=R==null?void 0:R.export)==null?void 0:X.sheet_html)=="string"?R.export.sheet_html.trim():"";return k||null}function b(){let l=document.getElementById("saveSoapTool");l&&l.addEventListener("click",async function(){try{let s=x.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!s)return;let _=await e.runner.buildSoapRecipePayload(s);if(!_){e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0});return}x.lastRecipePayload=_;try{let T=e.helpers.getStorage();T&&T.setItem("soap_recipe_payload",JSON.stringify(_))}catch{}P.SOAP_RECIPE_DTO=_,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}})}function t(){let l=document.getElementById("exportSoapCsv");l&&l.addEventListener("click",async function(){let s=await v();s&&q(s.export.csv_text,"soap_formula.csv")})}function p(){let l=document.getElementById("printSoapSheet");l&&l.addEventListener("click",async function(){var N,L;let s=await v();if(!s)return;let _=i(s),T=s.export.sheet_html;if(d(_)){let H=await w(_);if(!H)return;if(H.action==="normalize"){let $=await G(s,_,H.targetPct);if(!$){(L=(N=e.ui)==null?void 0:N.showSoapAlert)==null||L.call(N,"warning","Unable to normalize this recipe right now. Please try again or print as-is.",{dismissible:!0,timeoutMs:6e3});return}T=$}}a(T)})}function S(){b(),t(),p()}e.eventsExports={bind:S}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},r=e.state;function g(E){if(!E)return;let h=document.getElementById("addOil"),f=document.getElementById("normalizeOils");h&&(h.dataset.bound="direct",h.addEventListener("click",function(){E.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),f&&(f.dataset.bound="direct",f.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),E.addEventListener("input",function(I){I.target.classList.contains("oil-grams")&&(r.lastOilEdit={row:I.target.closest(".oil-row"),field:"grams"}),I.target.classList.contains("oil-percent")&&(r.lastOilEdit={row:I.target.closest(".oil-row"),field:"percent"}),(I.target.classList.contains("oil-grams")||I.target.classList.contains("oil-percent")||I.target.classList.contains("oil-typeahead"))&&(I.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(I.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),E.addEventListener("focusin",function(I){I.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(I.target.closest(".oil-row"))}),E.addEventListener("focusout",function(I){I.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),I.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(I.target.closest(".oil-row"),"grams"),I.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(I.target.closest(".oil-row"),"percent")}),E.addEventListener("keydown",function(I){I.key==="Enter"&&(I.target.classList.contains("oil-grams")&&(I.preventDefault(),e.oils.validateOilEntry(I.target.closest(".oil-row"),"grams")),I.target.classList.contains("oil-percent")&&(I.preventDefault(),e.oils.validateOilEntry(I.target.closest(".oil-row"),"percent")))}),E.addEventListener("mouseover",function(I){if(!I.target.classList.contains("oil-typeahead"))return;let U=I.target.closest(".oil-row");!U||U===r.lastPreviewRow||(r.lastPreviewRow=U,e.oils.setSelectedOilProfileFromRow(U))}),E.addEventListener("mouseout",function(I){I.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),E.addEventListener("click",function(I){let U=I.target.closest(".oil-profile-open");if(U){let u=U.closest(".oil-row");if(u){e.oils.setSelectedOilProfileFromRow(u);let v=document.getElementById("oilProfileModal");v&&P.bootstrap&&P.bootstrap.Modal.getOrCreateInstance(v).show()}return}let c=I.target.closest(".remove-oil");if(c){let u=c.closest(".oil-row");u&&(r.lastRemovedOil=e.oils.serializeOilRow(u),r.lastRemovedOilIndex=Array.from(u.parentElement.children).indexOf(u),e.ui.showUndoToast("Oil removed.")),u&&r.lastOilEdit&&r.lastOilEdit.row===u&&(r.lastOilEdit=null,e.oils.clearSelectedOilProfile()),u&&u.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}})}function M(E){if(!E)return;let h=document.getElementById("addFragrance");h&&(h.dataset.bound="direct",h.addEventListener("click",function(){E.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),E.addEventListener("input",function(f){f.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:f.target.closest(".fragrance-row"),field:"grams"}),f.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:f.target.closest(".fragrance-row"),field:"percent"}),(f.target.classList.contains("fragrance-grams")||f.target.classList.contains("fragrance-percent")||f.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),E.addEventListener("click",function(f){var c;let I=f.target.closest(".remove-fragrance");if(!I)return;let U=I.closest(".fragrance-row");U&&((c=e.state.lastFragranceEdit)==null?void 0:c.row)===U&&(e.state.lastFragranceEdit=null),U&&U.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function D({oilRows:E,fragranceRows:h}){let f=document.getElementById("soapStageTabContent");if(!f)return;let I=()=>{let U=f.querySelector(".tab-pane.active")||f.querySelector(".tab-pane.show.active");return U?U.querySelector(".soap-stage-body")||U:null};f.addEventListener("wheel",U=>{let c=U.target;if(!(c instanceof HTMLElement))return;let u=c.closest('input[type="number"]');if(!(u instanceof HTMLInputElement))return;let v=I();if(!(v instanceof HTMLElement)||v.scrollHeight<=v.clientHeight+1)return;document.activeElement===u&&typeof u.blur=="function"&&u.blur();let q=v.scrollTop<=0,a=v.scrollTop+v.clientHeight>=v.scrollHeight-1;U.deltaY<0&&q||U.deltaY>0&&a||(v.scrollTop+=U.deltaY,U.preventDefault())},{passive:!1}),f.addEventListener("click",U=>{let c=U.target.closest("[data-stage-action]"),u=U.target.closest("[data-soap-action]");if(!c&&!u)return;if(U.preventDefault(),U.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),u){if(u.dataset.bound==="direct")return;let a=u.dataset.soapAction;a==="add-oil"&&E&&(E.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),a==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),a==="add-fragrance"&&h&&(h.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let v=c.dataset.stageAction,q=Number(c.dataset.stageIndex);Number.isNaN(q)||(v==="prev"&&e.stages.openStageByIndex(Math.max(0,q-1)),v==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,q+1)),v==="reset"&&e.stages.resetStage(q+1))})}function x(){let E=document.getElementById("soapUndoRemove");E&&E.addEventListener("click",()=>{r.lastRemovedOil&&(e.storage.restoreOilRow(r.lastRemovedOil,r.lastRemovedOilIndex||0),r.lastRemovedOil=null,r.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}function O(){let E=document.getElementById("oilRows"),h=document.getElementById("fragranceRows");return g(E),M(h),D({oilRows:E,fragranceRows:h}),x(),{oilRows:E,fragranceRows:h}}e.eventsRows={bind:O}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function r(){let c=document.getElementById("soapStageTabList");if(!c)return;let u=()=>{c.querySelectorAll(".nav-item").forEach(q=>q.classList.remove("is-expanded"));let v=c.querySelector(".nav-link.active");v&&v.closest(".nav-item")&&v.closest(".nav-item").classList.add("is-expanded")};c.addEventListener("shown.bs.tab",()=>{u(),e.layout.scheduleStageHeightSync()}),u()}function g(){let c=document.getElementById("resultsCardToggle"),u=document.getElementById("resultsCard");!c||!u||c.addEventListener("click",()=>{u.classList.toggle("is-collapsed");let v=u.classList.contains("is-collapsed");c.setAttribute("aria-expanded",(!v).toString());let q=v?"Expand formula details":"Collapse formula details";c.setAttribute("aria-label",q),c.setAttribute("title",q);let a=c.querySelector("i");a&&(a.classList.toggle("fa-chevron-down",v),a.classList.toggle("fa-chevron-up",!v))})}function M(){document.querySelectorAll('input[name="weight_unit"]').forEach(c=>{c.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})})}function D(){let c=()=>{var n;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(n=e.mold)!=null&&n.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},u=document.getElementById("oilTotalTarget");u&&u.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let v=document.getElementById("moldWaterWeight");v&&v.addEventListener("input",function(){e.mold.syncTargetFromMold(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let q=document.getElementById("moldOilPct");q&&q.addEventListener("input",function(){e.mold.syncTargetFromMold(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let a=document.getElementById("moldShape");a&&a.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let i=document.getElementById("moldCylinderCorrection");i&&i.addEventListener("change",function(){e.mold.syncTargetFromMold(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let d=document.getElementById("moldCylinderFactor");d&&d.addEventListener("input",function(){e.mold.syncTargetFromMold(),c(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function x(){let c=document.getElementById("waterMethod");c&&c.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(u=>{u.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(u=>{let v=document.getElementById(u);v&&["input","change"].forEach(q=>{v.addEventListener(q,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})})}function O(){[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:u,weightId:v})=>{let q=document.getElementById(u),a=document.getElementById(v);q&&q.addEventListener("input",()=>{let i=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:u,weightId:v,sourceField:"pct",totalOils:i}),e.additives.updateAdditivesOutput(i),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),a&&a.addEventListener("input",()=>{let i=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:u,weightId:v,sourceField:"weight",totalOils:i}),e.additives.updateAdditivesOutput(i),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(u=>{u.addEventListener("input",()=>{e.storage.queueStateSave()})})}function E(){let c=document.getElementById("qualityPreset");c&&c.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(v=>{v.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let u=document.getElementById("applyQualityTargets");u&&u.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(v=>{v.addEventListener("click",()=>e.quality.applyQualityTargets()),v.addEventListener("keydown",q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),e.quality.applyQualityTargets())})})}function h(){document.querySelectorAll(".stub-btn").forEach(u=>{u.addEventListener("click",function(){let v=this.dataset.stubKind,q=this.dataset.stubName;e.runner.addStubLine(v,q),e.storage.queueStateSave()})});let c=document.getElementById("soapToolPage");c&&(c.addEventListener("click",function(u){u.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),c.addEventListener("input",function(u){u.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(u.target),e.stages.updateStageStatuses(),e.ui.flashStage(u.target.closest(".soap-stage-card")))}),c.addEventListener("change",function(u){u.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(u.target),e.stages.updateStageStatuses())}))}function f(){let c=document.getElementById("addToolIngredient");c&&c.addEventListener("click",function(){let q=document.getElementById("tool-ingredients");q&&q.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let u=document.getElementById("addToolConsumable");u&&u.addEventListener("click",function(){let q=document.getElementById("tool-consumables");q&&q.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let v=document.getElementById("addToolContainer");v&&v.addEventListener("click",function(){let q=document.getElementById("tool-containers");q&&q.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()})}function I(){let c=document.getElementById("calcLyeBtn");c&&c.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()})}function U(){r(),g(),M(),D(),x(),O(),E(),h(),f(),I()}e.eventsForms={bind:U}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function r(){let M=document.getElementById("soapMobileDrawer"),D=document.getElementById("soapMobileDrawerContent"),x=document.getElementById("soapMobileDrawerTitle"),O=document.getElementById("soapDrawerEmpty"),E=document.getElementById("soapDrawerClose"),h=document.getElementById("soapQualityCard"),f=document.getElementById("resultsCard");if(!M||!D||!x||!h||!f)return;let I=h.parentElement,U=f.parentElement,c=new Map,u=null,v=()=>P.matchMedia("(max-width: 767px)").matches,q=b=>b==="quality"?h:f,a=b=>b==="quality"?I:U,i=b=>b==="quality"?"Display":"Results",d=b=>{let t=c.get(b);t||(t=document.createElement("div"),t.className="soap-card-placeholder",c.set(b,t)),t.style.height=`${b.offsetHeight}px`,b.parentElement&&b.parentElement!==D&&!t.parentElement&&b.parentElement.insertBefore(t,b)},n=b=>{b&&(d(b),D.appendChild(b))},C=(b,t)=>{let p=c.get(b);p&&p.parentElement?p.replaceWith(b):t&&b.parentElement!==t&&t.appendChild(b)},w=()=>{if(!O)return;let b=u==="results",t=getComputedStyle(f).display!=="none";O.classList.toggle("d-none",!b||t)},A=b=>{v()&&(u&&u!==b&&C(q(u),a(u)),n(q(b)),x.textContent=i(b),u=b,M.classList.add("is-open"),w())},y=()=>{u&&(C(q(u),a(u)),u=null,M.classList.remove("is-open"),w())};M.querySelectorAll("[data-drawer-target]").forEach(b=>{b.addEventListener("click",()=>{let t=b.dataset.drawerTarget;t&&(M.classList.contains("is-open")&&u===t?y():A(t))})}),E&&E.addEventListener("click",y),P.addEventListener("resize",()=>{!v()&&u&&y()}),new MutationObserver(()=>w()).observe(f,{attributes:!0,attributeFilter:["style","class"]})}function g(){r(),P.addEventListener("resize",e.layout.scheduleStageHeightSync),P.addEventListener("load",e.layout.scheduleStageHeightSync)}e.eventsMobile={bind:g}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:g,SALT_CATEGORY_SET:M,CITRIC_CATEGORY_SET:D}=e.constants;function x({oilRows:O,fragranceRows:E}={}){var h,f;e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",r,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",g,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",M,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",D,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),O&&!O.querySelector(".oil-row")&&O.appendChild(e.oils.buildOilRow()),E&&!E.querySelector(".fragrance-row")&&(h=e.fragrances)!=null&&h.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()),(f=e.fragrances)!=null&&f.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()}e.eventsInit={bind:x}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function r(){var M,D,x,O,E;let g=(M=e.eventsRows)!=null&&M.bind?e.eventsRows.bind():{oilRows:null,fragranceRows:null};(D=e.eventsForms)!=null&&D.bind&&e.eventsForms.bind(g),(x=e.eventsExports)!=null&&x.bind&&e.eventsExports.bind(g),(O=e.eventsMobile)!=null&&O.bind&&e.eventsMobile.bind(g),(E=e.eventsInit)!=null&&E.bind&&e.eventsInit.bind(g)}r()})(window);
