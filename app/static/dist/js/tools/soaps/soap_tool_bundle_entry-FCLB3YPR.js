(function(P){"use strict";let e={inventory:"Inventory",global:"Global Library"},c={inventory:"bg-primary",global:"bg-info text-dark"},p={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function M(r,d){let l;return function(){let _=arguments;clearTimeout(l),l=setTimeout(()=>r.apply(null,_),d)}}function V(r){return(r||"").trim().toLowerCase()}function W(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function A(r){return typeof r=="function"?r():r}function T(r){let d=new Set;return(r||[]).forEach(l=>{let _=l&&(l.global_item_id||l.id);_&&d.add(String(_))}),d}function L(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${c[r]||"bg-secondary"} ms-2">${d}</span>`}function R(r,d,l,_){_=_||{},r.innerHTML="";let g=!1;if(d.forEach(I=>{!I.items||!I.items.length||(g=!0,I.items.forEach(S=>{let b=document.createElement("a");b.href="#",b.className="list-group-item list-group-item-action suggestion-item";let m=_.showSubtitle&&S.subtitle?`<div class="small text-muted mt-1">${S.subtitle}</div>`:"";b.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${S.text||S.display_name||S.name||""}</span>
          ${_.showSourceBadge?L(I.source||S.source):""}
        </div>${m}`,b.addEventListener("click",function(t){t.preventDefault(),l(S,I.source||S.source),r.classList.add("d-none")}),r.appendChild(b)}))}),r.classList.toggle("d-none",!g),!g&&r.dataset.emptyMessage){let I=document.createElement("div");I.className="list-group-item text-muted small",I.textContent=r.dataset.emptyMessage,r.appendChild(I),r.classList.remove("d-none")}}function E(r,d,l){r.innerHTML="";let _=!1;d.forEach(g=>{if(!g.ingredients||!g.ingredients.length)return;_=!0;let I=document.createElement("div");I.className="list-group-item text-muted small fw-semibold",I.textContent=g.title,r.appendChild(I),g.ingredients.forEach(S=>{let b=document.createElement("div");b.className="list-group-item ingredient-result";let m=document.createElement("div");m.className="d-flex justify-content-between align-items-center ingredient-summary",m.setAttribute("role","button"),m.setAttribute("tabindex","0"),m.innerHTML=`<span class="fw-semibold">${S.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${S.forms.length} option${S.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",S.forms.forEach(C=>{let B=document.createElement("button");B.type="button",B.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",B.innerHTML=`<div class="fw-semibold">${C.text||C.display_name||C.name||"Form"}</div>`,B.addEventListener("click",function(){l(C,C.source||g.source),r.classList.add("d-none")}),t.appendChild(B)});function y(C){C.type==="keydown"&&C.key!=="Enter"&&C.key!==" "||(C.preventDefault(),t.classList.toggle("d-none"))}m.addEventListener("click",y),m.addEventListener("keydown",y),b.appendChild(m),b.appendChild(t),r.appendChild(b),S.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!_)}function N(r,d,l){r.innerHTML="";let _=!1;if((d||[]).forEach(g=>{_=!0;let I=document.createElement("a");I.href="#",I.className="list-group-item list-group-item-action suggestion-item";let S=g.inci_name?`<div class="small text-muted">${g.inci_name}</div>`:"";I.innerHTML=`<div class="fw-semibold">${g.text||g.name}</div>${S}`,I.addEventListener("click",function(b){b.preventDefault(),l(g,"definition"),r.classList.add("d-none")}),r.appendChild(I)}),r.classList.toggle("d-none",!_),!_&&r.dataset.emptyMessage){let g=document.createElement("div");g.className="list-group-item text-muted small",g.textContent=r.dataset.emptyMessage,r.appendChild(g),r.classList.remove("d-none")}}function o(r){let d=[];return(r||[]).forEach(l=>{if(l&&Array.isArray(l.forms)&&l.forms.length){let _=l.ingredient&&l.ingredient.name||l.ingredient_name||null,g=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null,I=l.category_tags||[];l.forms.forEach(S=>{var t,y,C,B,O,w,G,k,z,ee;let b=S.physical_form||{},m=S.display_name||S.text||S.name||(_&&S.physical_form_name?`${_}, ${S.physical_form_name}`:l.display_name||l.text||l.name||"");d.push({id:S.id,text:m,item_type:S.item_type||l.item_type,default_unit:S.default_unit||S.unit||l.default_unit||l.unit||null,source:"global",global_item_id:S.id,ingredient_id:S.ingredient_id||l.ingredient&&l.ingredient.id||l.ingredient_id||null,ingredient_name:S.ingredient_name||_,physical_form_id:S.physical_form_id||b&&b.id||null,physical_form_name:S.physical_form_name||b&&b.name||null,ingredient_category_name:g,category_tags:I,density:S.density||l.density||null,capacity:S.capacity||l.capacity||null,capacity_unit:S.capacity_unit||l.capacity_unit||null,container_material:S.container_material||l.container_material||null,container_type:S.container_type||l.container_type||null,container_style:S.container_style||l.container_style||null,container_color:S.container_color||l.container_color||null,default_is_perishable:(t=S.default_is_perishable)!=null?t:l.default_is_perishable,recommended_shelf_life_days:(y=S.recommended_shelf_life_days)!=null?y:l.recommended_shelf_life_days,saponification_value:(B=(C=S.saponification_value)!=null?C:l.saponification_value)!=null?B:null,iodine_value:(w=(O=S.iodine_value)!=null?O:l.iodine_value)!=null?w:null,fatty_acid_profile:(k=(G=S.fatty_acid_profile)!=null?G:l.fatty_acid_profile)!=null?k:null,melting_point_c:(ee=(z=S.melting_point_c)!=null?z:l.melting_point_c)!=null?ee:null})})}else if(l){let _=l.display_name||l.text||l.name||"",g=l.ingredient&&l.ingredient.ingredient_category_name||l.ingredient_category_name||l.ingredient_category&&l.ingredient_category.name||null;d.push({id:l.id,text:_,source:"global",item_type:l.item_type,global_item_id:l.id,ingredient_name:l.ingredient&&l.ingredient.name||l.ingredient_name||l.name,ingredient_category_name:g,category_tags:l.category_tags||[],physical_form_name:l.physical_form&&l.physical_form.name||l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,density:l.density||null,capacity:l.capacity||null,capacity_unit:l.capacity_unit||null,container_material:l.container_material||null,container_type:l.container_type||null,container_style:l.container_style||null,container_color:l.container_color||null,default_is_perishable:l.default_is_perishable,recommended_shelf_life_days:l.recommended_shelf_life_days,saponification_value:l.saponification_value||null,iodine_value:l.iodine_value||null,fatty_acid_profile:l.fatty_acid_profile||null,melting_point_c:l.melting_point_c||null})}}),d}function v(r){let d=new Map;return(r||[]).forEach(l=>{let _=l.ingredient_name||l.text||l.name||"",g=l.ingredient_id?`id:${l.ingredient_id}`:`name:${V(_)}`,I=d.get(g)||{ingredient_id:l.ingredient_id||null,name:_,forms:[]};I.forms.push({id:l.id,text:l.text||_,ingredient_name:_,physical_form_name:l.physical_form_name||null,default_unit:l.default_unit||l.unit||null,source:"inventory",global_item_id:l.global_item_id||null}),d.set(g,I)}),Array.from(d.values())}function s(r,d){let l=[];return(r||[]).forEach(_=>{let g=(_.forms||[]).map(S=>({id:S.id,text:S.name||S.display_name||S.text,ingredient_name:S.ingredient_name||_.name||_.ingredient&&_.ingredient.name||"Ingredient",physical_form_name:S.physical_form_name||null,default_unit:S.default_unit||S.unit||null,source:"global",global_item_id:S.id,density:S.density||null,capacity:S.capacity||null,capacity_unit:S.capacity_unit||null,container_material:S.container_material||null,container_type:S.container_type||null,container_style:S.container_style||null,container_color:S.container_color||null,saponification_value:S.saponification_value||null,iodine_value:S.iodine_value||null,fatty_acid_profile:S.fatty_acid_profile||null,melting_point_c:S.melting_point_c||null})),I=d?g.filter(S=>!S.global_item_id||!d.has(String(S.global_item_id))):g;I.length&&l.push({ingredient_id:_.ingredient_id||_.id||null,name:_.name||_.ingredient&&_.ingredient.name||g[0]&&g[0].ingredient_name||"Ingredient",forms:I})}),l}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(l=>l.json()).catch(()=>({results:[]}))}function n(r){let d={...p,...r},l=d.inputEl,_=d.invHiddenEl,g=d.giHiddenEl,I=W(d.listEl),S=d.mode||"recipe",b=d.searchType||"ingredient",m=d.includeInventory,t=d.includeGlobal,y=d.ingredientFirst,C=d.displayVariant,B=typeof d.resultFilter=="function"?d.resultFilter:null,O=typeof d.onSelection=="function"?d.onSelection:null,w=d.globalUrlBuilder;if(!l||!_&&S==="recipe"||!g&&d.requireHidden!==!1)return;I&&!I.classList.contains("list-group")&&I.classList.add("list-group"),!I.parentNode&&l.parentNode&&l.parentNode.appendChild(I);function G(K,Q){let h=new URLSearchParams({q:K});return Q&&Q!=="all"&&h.set("type",Q),`/inventory/api/search?${h.toString()}`}function k(K,Q,h){if(typeof w=="function")return w(K,Q,h);let q=new URLSearchParams({q:K});return Q&&Q!=="all"&&q.set("type",Q),Q==="ingredient"&&h&&q.set("group","ingredient"),`${S==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${q.toString()}`}let z=M(function(){let K=(l.value||"").trim();if(!K){I.classList.add("d-none"),I.innerHTML="",_&&(_.value=""),g&&(g.value="");return}let Q=(A(b)||"ingredient").toLowerCase(),h=A(m),q=A(t),$=Q==="ingredient"&&!!A(y),H=C||($?"grouped":"compact");if(Q==="ingredient_definition"||Q==="definition"){a(K).then(x=>{let X=x&&x.results||[];N(I,X.map(Y=>({id:Y.id,text:Y.name,name:Y.name,inci_name:Y.inci_name,slug:Y.slug,ingredient_category_id:Y.ingredient_category_id,ingredient_category_name:Y.ingredient_category_name})),ee)}).catch(()=>I.classList.add("d-none"));return}let U=h!==!1?fetch(G(K,Q)).then(x=>x.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),D=q!==!1?fetch(k(K,Q,$)).then(x=>x.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([U,D]).then(x=>{let X=x[0]&&x[0].results||[],Y=x[1]&&x[1].results||[],j=B?X.filter(ue=>B(ue,"inventory")):X,J=B?Y.filter(ue=>B(ue,"global")):Y,ne=T(j),oe=o(J).filter(ue=>!ue.global_item_id||!ne.has(String(ue.global_item_id))).filter(ue=>B?B(ue,"global"):!0);if($){let ue=v(j),he=s(J,ne),pe=[];ue.length&&pe.push({title:"Your Inventory",source:"inventory",ingredients:ue}),he.length&&pe.push({title:"Global Library",source:"global",ingredients:he}),E(I,pe,ee);return}let de=[];j.length&&de.push({title:"Your Inventory",source:"inventory",items:j}),oe.length&&de.push({title:"Global Library",source:"global",items:oe}),R(I,de,ee,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:H==="detailed"})}).catch(()=>{I.classList.add("d-none")})},200);function ee(K,Q){l.value=K.text||K.display_name||K.name||"",Q==="inventory"?(_&&(_.value=K.id_numeric||K.id||""),g&&(g.value=K.global_item_id||"")):(g&&(g.value=K.global_item_id||K.id||""),_&&(_.value="")),typeof O=="function"&&O(K,Q)}l.addEventListener("input",function(){_&&(_.value=""),g&&(g.value=""),z()}),document.addEventListener("click",function(K){!I.contains(K.target)&&!l.contains(K.target)&&I.classList.add("d-none")})}P.attachMergedInventoryGlobalTypeahead=n,P.renderInventoryTypeaheadList=R})(window);(function(P){"use strict";function e(c,p){var M=p&&p.context||"public",V=p&&p.unitOptionsHtml||"",W=p&&p.mode||(M==="public"?"public":"recipe"),A=document.createElement("div");A.className="row g-2 align-items-end mb-2",A.innerHTML=['<div class="col-md-6">','  <label class="form-label">',c==="container"?"Container":c==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',V,"  </select>","</div>",'<div class="col-md-3 ',c!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var T=A.querySelector(".tool-typeahead"),L=A.querySelector(".tool-gi-id"),R=A.querySelector('[data-role="suggestions"]');if(typeof P.attachMergedInventoryGlobalTypeahead=="function"){let E=c==="container"?"container":c==="consumable"?"consumable":"ingredient",N=M!=="public";P.attachMergedInventoryGlobalTypeahead({inputEl:T,giHiddenEl:L,listEl:R,mode:W,context:M,ingredientFirst:c==="ingredient",searchType:E,includeInventory:N,includeGlobal:!0})}return A.querySelector(".tool-remove").addEventListener("click",function(){A.remove()}),A}P.buildToolLineRow=e})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};e.config={unitOptionsHtml:P.soapToolConfig&&P.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(P.SOAP_CALC_LIMIT)?P.SOAP_CALC_LIMIT:null,calcTier:P.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(P.soapToolConfig&&P.soapToolConfig.useCsvPrimary),isAuthenticated:P.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:c,toNumber:p,clamp:M,formatTime:V,getStorage:W,buildSoapcalcSearchBuilder:A};function c(T,L=3){if(!isFinite(T))return 0;let R=Math.pow(10,L);return Math.round(T*R)/R}function p(T){let L=T;typeof L=="string"&&(L=L.replace(/,/g,"").trim());let R=parseFloat(L);return isFinite(R)?R:0}function M(T,L,R){return!isFinite(T)||T<L?L:R!=null&&T>R?R:T}function V(T){return T?`Saved ${new Date(T).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function W(){try{return P.localStorage}catch{return null}}function A(){let T=(R,E,N)=>{let o=new URLSearchParams({q:R});return E&&E!=="all"&&o.set("type",E),E==="ingredient"&&N&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},L=(R,E,N)=>{let o=new URLSearchParams({q:R});return N&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?L:T}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},p={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},M={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},V=[41,70],W=100,A=[136,170],T=250,L={hardness:(c.hardness[0]+c.hardness[1])/2,cleansing:(c.cleansing[0]+c.cleansing[1])/2,conditioning:(c.conditioning[0]+c.conditioning[1])/2,bubbly:(c.bubbly[0]+c.bubbly[1])/2,creamy:(c.creamy[0]+c.creamy[1])/2},R={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},E={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},N=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],v={g:1,oz:28.3495,lb:453.592},s=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),l=new Set(["Salts & Minerals"]),_=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:c,QUALITY_HINTS:p,QUALITY_FEEL_HINTS:M,IODINE_RANGE:V,IODINE_SCALE_MAX:W,INS_RANGE:A,INS_SCALE_MAX:T,QUALITY_BASE:L,QUALITY_PRESETS:R,FATTY_BAR_COLORS:E,FATTY_DISPLAY_KEYS:N,OIL_TIP_RULES:o,UNIT_FACTORS:v,STAGE_CONFIGS:s,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:l,CITRIC_CATEGORY_SET:_}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:c}=e.helpers;function p(A){let T=0,L=0;return A.forEach(R=>{R.iodine>0&&(T+=R.grams,L+=R.iodine*R.grams)}),{iodine:T>0?L/T:0,coverageWeight:T}}function M(A){let T={},L=0;A.forEach(E=>{!E.fattyProfile||typeof E.fattyProfile!="object"||(L+=E.grams,Object.entries(E.fattyProfile).forEach(([N,o])=>{let v=c(o);v>0&&(T[N]=(T[N]||0)+E.grams*(v/100))}))});let R={};return L>0&&Object.entries(T).forEach(([E,N])=>{R[E]=N/L*100}),{percent:R,coveredWeight:L}}function V(A){let T=L=>A[L]||0;return{hardness:T("lauric")+T("myristic")+T("palmitic")+T("stearic"),cleansing:T("lauric")+T("myristic"),conditioning:T("oleic")+T("linoleic")+T("linolenic")+T("ricinoleic"),bubbly:T("lauric")+T("myristic")+T("ricinoleic"),creamy:T("palmitic")+T("stearic")+T("ricinoleic")}}function W(A){if(!A||typeof A!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let T={lauric:c(A.lauric),myristic:c(A.myristic),palmitic:c(A.palmitic),stearic:c(A.stearic),ricinoleic:c(A.ricinoleic),oleic:c(A.oleic),linoleic:c(A.linoleic),linolenic:c(A.linolenic)},L=V(T);return{hardness:(L.hardness||0)/100,cleansing:(L.cleansing||0)/100,conditioning:(L.conditioning||0)/100,bubbly:(L.bubbly||0)/100,creamy:(L.creamy||0)/100}}e.calc={computeIodine:p,computeFattyAcids:M,computeQualities:V,computeOilQualityScores:W},P.SoapCalcService=e.calc})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p,clamp:M}=e.helpers,{UNIT_FACTORS:V}=e.constants,W=e.state;function A(o){return M(p(o),0)*(V[W.currentUnit]||1)}function T(o){return M(o,0)/(V[W.currentUnit]||1)}function L(o){return!isFinite(o)||o<=0?"--":`${c(T(o),2)} ${W.currentUnit}`}function R(o){return isFinite(o)?`${c(o,1)}%`:"--"}function E(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=W.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=W.currentUnit})}function N(o,v={}){if(!o)return;if(o===W.currentUnit){E();return}let s=W.currentUnit;if(W.currentUnit=o,E(),v.skipConvert)return;let a=(V[s]||1)/(V[o]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let l=p(d.value);l>0&&(d.value=c(l*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let l=p(d.value);l>0&&(d.value=c(l*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let d=p(n.value);d>0&&(n.value=c(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=p(r.value);d>0&&(r.value=c(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),v.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:A,fromGrams:T,formatWeight:L,formatPercent:R,updateUnitLabels:E,setUnit:N}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.state,p={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function M(s){s&&(s.classList.remove("soap-number-pulse"),s.offsetWidth,s.classList.add("soap-number-pulse"))}function V(s){var n;let a=document.getElementById(s);return!a||!((n=P.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function W(){let s=Date.now();if(s-c.lastSaveToastAt<3500)return;c.lastSaveToastAt=s;let a=V("soapAutosaveToast");a&&a.show()}function A(s){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=s||"Oil removed.");let r=V("soapUndoToast");r&&r.show()}function T(){let s=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");s&&s.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function L(s){var d,l;let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning"),r=[];if(a){let _=(s==null?void 0:s.lyeConcentration)||0,g="";_>40&&(g="High concentration"),_>0&&_<25&&(g="Low concentration"),a.textContent=g,a.classList.toggle("d-none",!g),g&&r.push(`Lye concentration: ${g.toLowerCase()}.`)}if(n){let _=(s==null?void 0:s.waterRatio)||0,g="";_>0&&_<1.8&&(g="Low water"),_>2.7&&(g="High water"),n.textContent=g,n.classList.toggle("d-none",!g),g&&r.push(`Water to lye ratio: ${g.toLowerCase()}.`)}r.length?(d=e.guidance)==null||d.setSection("results-water-warnings",{title:"Process warnings",tone:"warning",items:r}):(l=e.guidance)==null||l.clearSection("results-water-warnings")}function R(){document.querySelectorAll("#soapToolPage .form-text").forEach(s=>{let a=s.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function E(s){if(!s||s.type!=="number")return;let a=s.value;if(a===""){s.classList.remove("is-invalid");return}let n=parseFloat(a),r=s.getAttribute("min"),d=s.getAttribute("max"),l=r!==null&&r!==""&&n<parseFloat(r),_=d!==null&&d!==""&&n>parseFloat(d);s.classList.toggle("is-invalid",!isFinite(n)||l||_)}function N(s){var n;if(!s)return;let a=((n=s.querySelector)==null?void 0:n.call(s,".soap-stage-card"))||s;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function o(s,a,n={}){var _;let r=document.getElementById("soapAlertStack");if(!r)return;let d=p[s]||p.info,l=document.createElement("div");l.className=`alert alert-${s} d-flex align-items-start gap-2`,l.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((_=l.querySelector('[data-role="dismiss"]'))==null||_.addEventListener("click",()=>l.remove())),r.prepend(l),n.persist||setTimeout(()=>{l.parentNode&&l.remove()},n.timeoutMs||4500)}function v(){let s=document.getElementById("soapAlertStack");s&&s.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:M,getToastInstance:V,showAutosaveToast:W,showUndoToast:A,updateResultsMeta:T,updateResultsWarnings:L,applyHelperVisibility:R,validateNumericField:E,flashStage:N,showSoapAlert:o,clearSoapAlerts:v}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=new Map,p=!1;function M(v){if(!Array.isArray(v))return[];let s=new Set,a=[];return v.forEach(n=>{let r=String(n||"").trim();!r||s.has(r)||(s.add(r),a.push(r))}),a}function V(){return Array.from(c.values()).filter(v=>!v.persistent&&v.items.length)}function W(){let s=V().reduce((a,n)=>a+n.items.length,0);return s?s===1?{totalItems:s,text:"1 active formula hint from your current configuration."}:{totalItems:s,text:`${s} active formula hints from your current configuration.`}:{totalItems:0,text:"No active formula hints from your current configuration."}}function A(){let v=document.getElementById("soapGuidanceSections"),s=document.getElementById("soapGuidanceSummary"),a=document.getElementById("soapGuidanceCount"),n=document.getElementById("soapGuidanceEmpty");if(!v||!s||!a||!n)return;let r=W();s.textContent=r.text,a.textContent=String(r.totalItems);let d=Array.from(c.values()).filter(l=>l.items.length);v.innerHTML="",d.forEach(l=>{let _=document.createElement("section");_.className=`soap-guidance-section ${l.tone?`is-${l.tone}`:""}`.trim();let g=document.createElement("h6");g.className="soap-guidance-section-title",g.textContent=l.title||"Guidance";let I=document.createElement("ul");I.className="soap-guidance-list",l.items.forEach(S=>{let b=document.createElement("li");b.textContent=S,I.appendChild(b)}),_.appendChild(g),_.appendChild(I),v.appendChild(_)}),n.classList.toggle("d-none",d.length>0)}function T(v,s={}){if(!v)return;let a=M(s.items);if(!a.length){c.delete(v),A();return}c.set(v,{key:v,title:s.title||"Guidance",tone:s.tone||"",persistent:!!s.persistent,items:a}),A()}function L(v){v&&c.has(v)&&(c.delete(v),A())}function R(v){let s=document.getElementById("soapGuidanceDock"),a=document.getElementById("soapGuidanceToggle"),n=document.getElementById("soapGuidanceOverlay");if(!s||!a)return;p=!!v,s.classList.toggle("is-expanded",p),n&&n.setAttribute("aria-hidden",p?"false":"true"),a.setAttribute("aria-expanded",p?"true":"false");let r=p?"Collapse guidance panel":"Expand guidance panel";a.setAttribute("aria-label",r),a.setAttribute("title",r);let d=a.querySelector("i");d&&(d.classList.toggle("fa-caret-up",!p),d.classList.toggle("fa-caret-down",p))}function E(v){if(typeof v=="boolean"){R(v);return}R(!p)}function N(){let v=document.getElementById("soapGuidanceToggle");!v||v.dataset.bound==="true"||(v.dataset.bound="true",v.addEventListener("click",()=>E()))}function o(){N(),R(!1),T("core-safety",{title:"Safety",tone:"warning",persistent:!0,items:["Always add lye to water (never water to lye) and wear protective gear."]})}e.guidance={init:o,render:A,setSection:T,clearSection:L,setExpanded:R,toggleExpanded:E},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o,{once:!0}):o()})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{};function c(){let M=document.getElementById("soapStagePane"),V=document.getElementById("soapQualityCard"),W=document.getElementById("soapStageQualityRow"),A=document.getElementById("soapGuidanceDock");if(W&&A){let R=W.offsetHeight||0,E=Math.max(280,R+96);A.style.setProperty("--soap-guidance-overlay-height",`${E}px`)}if(!M||!V)return;if(!P.matchMedia("(min-width: 768px)").matches){M.classList.remove("is-height-synced"),M.style.removeProperty("--soap-stage-height");return}let L=V.offsetHeight;if(!L){M.classList.remove("is-height-synced"),M.style.removeProperty("--soap-stage-height");return}M.style.setProperty("--soap-stage-height",`${L}px`),M.classList.add("is-height-synced")}let p=()=>{P.requestAnimationFrame(c)};e.layout={syncStageHeight:c,scheduleStageHeightSync:p}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{clamp:c,toNumber:p,round:M}=e.helpers,{toGrams:V,fromGrams:W}=e.units;function A(){let o=E(),v=document.getElementById("oilTotalTarget"),s=document.getElementById("oilTargetHint");v&&o.effectiveCapacity>0&&V(v.value)<=0&&(v.value=o.targetOils>0?M(W(o.targetOils),2):""),s&&(o.effectiveCapacity>0?s.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":s.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?n=`Cylinder correction applied (${M(o.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}T()}function T(o=null){var S;let v=document.getElementById("moldWetBatterWarning");if(!v)return;let s=()=>{v.classList.add("d-none"),v.textContent=""},a=E(),n=e.state||{},r=n.lastCalc||null,d=(S=e.oils)!=null&&S.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,l=p(r==null?void 0:r.totalOils),_=p(o);if((!isFinite(_)||_<=0)&&(_=p(r==null?void 0:r.batchYield)),o==null&&l>0&&d>0&&Math.abs(l-d)>.01){s();return}if(!isFinite(_)||_<=0||a.effectiveCapacity<=0){s();return}let g=_-a.effectiveCapacity;if(g<=.01){s();return}let I=n.currentUnit||"g";v.textContent=`Full wet batter is ${M(W(_),2)} ${I}, exceeding mold capacity ${M(W(a.effectiveCapacity),2)} ${I} by ${M(W(g),2)} ${I}. Reduce oils target/% of mold or lower water/additives.`,v.classList.remove("d-none")}function L(){let o=document.getElementById("oilTotalTarget"),v=E();return o&&(v.effectiveCapacity>0&&(o.value=v.targetOils>0?M(W(v.targetOils),2):""),A()),v}function R(){let o=document.getElementById("oilTotalTarget"),v=document.getElementById("moldOilPct");if(!o||!v){let n=E();return A(),n}let s=E();if(s.effectiveCapacity>0){let n=V(o.value),r=c(n,0,s.effectiveCapacity);n>s.effectiveCapacity+.01&&(o.value=M(W(r),2));let d=r>0?r/s.effectiveCapacity*100:0;v.value=r>0?M(d,2):""}let a=E();return A(),a}function E(){var l,_,g;let o=V(document.getElementById("moldWaterWeight").value),v=c(p(document.getElementById("moldOilPct").value),0,100),s=((l=document.getElementById("moldShape"))==null?void 0:l.value)||"loaf",a=!!((_=document.getElementById("moldCylinderCorrection"))!=null&&_.checked),n=c(p((g=document.getElementById("moldCylinderFactor"))==null?void 0:g.value),.5,1),r=o>0?o*(a?n:1):0,d=r>0?r*(v/100):0;return{waterWeight:o,oilPct:v,shape:s,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:d}}function N(){var s;let o=((s=document.getElementById("moldShape"))==null?void 0:s.value)||"loaf",v=document.getElementById("moldCylinderOptions");v&&v.classList.toggle("d-none",o!=="cylinder"),A()}e.mold={updateMoldSuggested:A,updateWetBatterWarning:T,syncTargetFromMold:L,syncMoldPctFromTarget:R,getMoldSettings:E,updateMoldShapeUI:N}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p,clamp:M,buildSoapcalcSearchBuilder:V}=e.helpers,{toGrams:W,fromGrams:A}=e.units,{OIL_CATEGORY_SET:T,OIL_TIP_RULES:L}=e.constants,{computeQualities:R}=e.calc,E=e.state,N=new Map;function o(h){return h?(h.dataset.hintKey||(E.nextOilHintId=(E.nextOilHintId||0)+1,h.dataset.hintKey=`oil-row-${E.nextOilHintId}`),h.dataset.hintKey):""}function v(){let h=new Set(Array.from(document.querySelectorAll("#oilRows .oil-row")).map(q=>o(q)));Array.from(N.keys()).forEach(q=>{let $=q.split(":")[0];h.has($)||N.delete(q)})}function s(){var q,$;let h=Array.from(new Set(Array.from(N.values())));if(!h.length){(q=e.guidance)==null||q.clearSection("oil-entry-limits");return}($=e.guidance)==null||$.setSection("oil-entry-limits",{title:"Stage 2 limits",tone:"warning",items:h})}function a(h){let q=h.querySelector(".oil-typeahead"),$=h.querySelector(".oil-sap-koh"),H=h.querySelector(".oil-iodine"),U=h.querySelector(".oil-fatty"),D=h.querySelector(".oil-gi-id"),x=h.querySelector(".oil-default-unit"),X=h.querySelector(".oil-category"),Y=h.querySelector('[data-role="suggestions"]');if(!q||!Y||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let j=V();P.attachMergedInventoryGlobalTypeahead({inputEl:q,listEl:Y,mode:"public",giHiddenEl:D,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:j,searchType:"ingredient",resultFilter:(J,ne)=>K(J,T,ne),requireHidden:!1,onSelection:function(J){$&&($.value=(J==null?void 0:J.saponification_value)||""),H&&(H.value=(J==null?void 0:J.iodine_value)||""),U&&(U.value=J!=null&&J.fatty_acid_profile?JSON.stringify(J.fatty_acid_profile):""),x&&(x.value=(J==null?void 0:J.default_unit)||""),X&&(X.value=(J==null?void 0:J.ingredient_category_name)||""),O(J),t(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),q.addEventListener("input",function(){this.value.trim()||($&&($.value=""),H&&(H.value=""),U&&(U.value=""),D&&(D.value=""),x&&(x.value=""),X&&(X.value=""),G())})}function n(){var $,H;let h=document.getElementById("oilRowTemplate"),q=(H=($=h==null?void 0:h.content)==null?void 0:$.querySelector(".oil-row"))==null?void 0:H.cloneNode(!0);return q?(q.querySelectorAll("input").forEach(U=>{U.value=""}),q.querySelectorAll(".form-text").forEach(U=>{let D=U.closest('.soap-field-stack, [class*="col-"]');D&&D.classList.add("soap-field")}),a(q),q.querySelectorAll(".unit-suffix").forEach(U=>{U.dataset.suffix=E.currentUnit}),q):document.createElement("div")}function r(){let h=document.getElementById("oilTotalTarget"),q=W(h==null?void 0:h.value);if(q>0)return q;let $=e.mold.getMoldSettings();return $.targetOils>0?$.targetOils:0}function d(h){let q=[];return h.forEach(H=>{var x,X;let U=W((x=H.querySelector(".oil-grams"))==null?void 0:x.value),D=M(p((X=H.querySelector(".oil-percent"))==null?void 0:X.value),0);U>0&&D>0&&q.push(U/(D/100))}),q.length?q.reduce((H,U)=>H+U,0)/q.length:0}function l(h,q){if(!h||!q||q<=0)return{allowedGrams:null,allowedPct:null};let $=Array.from(document.querySelectorAll("#oilRows .oil-row")),H=$.reduce((j,J)=>{var ne;return J===h?j:j+W((ne=J.querySelector(".oil-grams"))==null?void 0:ne.value)},0),U=$.reduce((j,J)=>{var ne;return J===h?j:j+M(p((ne=J.querySelector(".oil-percent"))==null?void 0:ne.value),0)},0),D=Math.max(0,100-U),x=Math.max(0,q-H),X=q*D/100;return{allowedGrams:Math.max(0,Math.min(x,X)),allowedPct:D}}function _(h,q,$){if(!h)return;let U=`${o(h)}:${q}`;$?N.set(U,$):N.delete(U),s()}function g(h){h&&(h.classList.remove("oil-input-bounce"),h.offsetWidth,h.classList.add("oil-input-bounce"))}function I(h,q,$={}){let H=r();if(!h||!H||H<=0){_(h,q,"");return}let U=h.querySelector(".oil-grams"),D=h.querySelector(".oil-percent"),x=l(h,H);if(q==="grams"&&U){let X=W(U.value),Y="";if(X>H+.01?Y="Entry exceeds the max oils allowed in stage 2.":x.allowedGrams!==null&&X>x.allowedGrams+.01&&(Y=`Must be under ${c(A(x.allowedGrams),2)} ${E.currentUnit} to stay within the stage 2 oil limit.`),Y){let j=x.allowedGrams!==null?c(A(x.allowedGrams),2):c(A(H),2);U.value=j>0?j:"",_(h,q,Y),U.classList.add("oil-input-warning"),g(U),t()}else U.classList.remove("oil-input-warning"),_(h,q,"")}if(q==="percent"&&D){let X=M(p(D.value),0),Y="";if(X>100.01?Y="Entry exceeds the max oils allowed in stage 2.":x.allowedPct!==null&&X>x.allowedPct+.01&&(Y=`Must be under ${c(x.allowedPct,2)}% to stay within the stage 2 oil limit.`),Y){let j=x.allowedPct!==null?c(x.allowedPct,2):100;D.value=j>0?j:"",_(h,q,Y),D.classList.add("oil-input-warning"),g(D),t()}else D.classList.remove("oil-input-warning"),_(h,q,"")}}function S(h,q={}){let $=Array.from(document.querySelectorAll("#oilRows .oil-row")),H=h!=null?h:r(),U=!!q.force;if(!H||H<=0||!$.length){E.lastOilTarget=H;return}let D=$.reduce((X,Y)=>{var j;return X+M(p((j=Y.querySelector(".oil-percent"))==null?void 0:j.value),0)},0),x=$.reduce((X,Y)=>{var j;return X+W((j=Y.querySelector(".oil-grams"))==null?void 0:j.value)},0);if(D<=0&&x<=0){E.lastOilTarget=H;return}if(!(!U&&E.lastOilTarget&&Math.abs(E.lastOilTarget-H)<.01)){if(D>0)$.forEach(X=>{let Y=X.querySelector(".oil-percent"),j=X.querySelector(".oil-grams"),J=M(p(Y==null?void 0:Y.value),0),ne=D>0?J/D:0;j&&(j.value=ne>0?c(A(H*ne),2):""),Y&&(Y.value=ne>0?c(ne*100,2):"")});else if(x>0){let X=H/x;$.forEach(Y=>{let j=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),ne=W(j==null?void 0:j.value);if(j){let oe=ne>0?ne*X:0;j.value=oe>0?c(A(oe),2):""}if(J){let oe=W(j==null?void 0:j.value);J.value=oe>0?c(oe/H*100,2):""}})}E.lastOilTarget=H,t({skipEnforce:!0})}}function b(h,q){if(!E.lastOilEdit||!E.lastOilEdit.row)return!1;let $=E.lastOilEdit.row,H=h.reduce((X,Y)=>{var j;return Y===$?X:X+W((j=Y.querySelector(".oil-grams"))==null?void 0:j.value)},0),U=Math.max(0,q-H),D=$.querySelector(".oil-grams"),x=$.querySelector(".oil-percent");return!D||!x?!1:(D.value=U>0?c(A(U),2):"",x.value=U>0?c(U/q*100,2):"",E.wasCapped=!0,!0)}function m({totalWeight:h,totalPct:q,target:$,capped:H}){var D,x;let U=[];if(H&&U.push("Oil total hit the mold cap and was adjusted."),$>0&&h>$+.01){let X=h-$;U.push(`Oil weights exceed the target by ${c(A(X),2)} ${E.currentUnit}.`)}if(q>100.01&&U.push(`Oil percentages are over 100% by ${c(q-100,2)}%.`),U.length){(D=e.guidance)==null||D.setSection("oil-cap-warning",{title:"Oil cap warnings",tone:"warning",items:[`${U.join(" ")} Adjust oils or mold % to continue.`]});return}(x=e.guidance)==null||x.clearSection("oil-cap-warning")}function t(h={}){var X;h.skipEnforce||(E.wasCapped=!1),v(),s();let q=Array.from(document.querySelectorAll("#oilRows .oil-row")),$=e.mold.getMoldSettings(),H=r();if(!H&&!$.targetOils){let Y=d(q);if(Y>0){H=Y;let j=document.getElementById("oilTotalTarget");j&&!j.value&&(j.value=c(A(Y),2))}}let U=0,D=0;if(q.forEach(Y=>{let j=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),ne=W(j==null?void 0:j.value),oe=M(p(J==null?void 0:J.value),0);H>0&&(E.lastOilEdit&&E.lastOilEdit.row===Y&&E.lastOilEdit.field==="percent"?(ne=oe>0?H*(oe/100):0,j.value=oe>0?c(A(ne),2):""):ne>0?(oe=ne/H*100,J.value=c(oe,2)):oe>0&&(ne=H*(oe/100),j.value=c(A(ne),2)),D+=oe),ne>0&&(U+=ne)}),H<=0&&(U>0?(D=0,q.forEach(Y=>{let j=Y.querySelector(".oil-grams"),J=Y.querySelector(".oil-percent"),ne=W(j==null?void 0:j.value);if(ne>0){let oe=ne/U*100;J.value=c(oe,2),D+=oe}})):D=q.reduce((Y,j)=>{var J;return Y+M(p((J=j.querySelector(".oil-percent"))==null?void 0:J.value),0)},0)),!h.skipEnforce&&$.targetOils>0&&U>$.targetOils+.01&&b(q,$.targetOils))return t({skipEnforce:!0});E.totalOilsGrams=U;let x=document.getElementById("oilTotalComputed");return x&&(x.textContent=U>0?`${c(A(U),2)} ${E.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=c(D,2),m({totalWeight:U,totalPct:D,target:H,capped:E.wasCapped}),e.additives.updateAdditivesOutput(U),(X=e.fragrances)!=null&&X.updateFragranceTotals&&e.fragrances.updateFragranceTotals(U),e.mold.updateMoldSuggested(),k(),{totalWeight:U,totalPct:D,target:H}}function y(){let h=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!h.length)return;let q=r(),$=h.reduce((H,U)=>{var D;return H+M(p((D=U.querySelector(".oil-percent"))==null?void 0:D.value),0)},0);!$&&q>0&&($=h.reduce((H,U)=>{var x;let D=W((x=U.querySelector(".oil-grams"))==null?void 0:x.value);return H+(D>0?D/q*100:0)},0)),!($<=0)&&(h.forEach(H=>{let U=H.querySelector(".oil-percent"),D=H.querySelector(".oil-grams"),X=M(p(U.value),0)/$*100;U.value=c(X,2),q>0&&(D.value=X>0?c(A(q*(X/100)),2):"")}),t())}function C(){let h=[];return document.querySelectorAll("#oilRows .oil-row").forEach(q=>{var ne,oe,de,ue,he,pe,me,i,u;let $=(oe=(ne=q.querySelector(".oil-typeahead"))==null?void 0:ne.value)==null?void 0:oe.trim(),H=W((de=q.querySelector(".oil-grams"))==null?void 0:de.value),U=p((ue=q.querySelector(".oil-sap-koh"))==null?void 0:ue.value),D=p((he=q.querySelector(".oil-iodine"))==null?void 0:he.value),x=((pe=q.querySelector(".oil-fatty"))==null?void 0:pe.value)||"",X=((me=q.querySelector(".oil-gi-id"))==null?void 0:me.value)||"",Y=((i=q.querySelector(".oil-default-unit"))==null?void 0:i.value)||"",j=((u=q.querySelector(".oil-category"))==null?void 0:u.value)||"",J=null;if(x)try{J=JSON.parse(x)}catch{J=null}H<=0||h.push({name:$||null,grams:H,sapKoh:U,iodine:D,fattyProfile:J,global_item_id:X?parseInt(X):null,default_unit:Y||null,ingredient_category_name:j||null})}),h}function B({name:h,sapKoh:q,iodine:$,fattyProfile:H}={}){let U=document.getElementById("oilProfileFloat"),D=(oe,de)=>{let ue=document.getElementById(oe);ue&&(ue.textContent=de)},x=h||"Pick an oil to preview";D("selectedOilName",x),D("selectedOilModalName",x),U&&U.classList.toggle("d-none",!h);let X=q>0?c(q,1):"--",Y=$>0?c($,1):"--";D("selectedOilSap",X),D("selectedOilModalSap",X),D("selectedOilIodine",Y),D("selectedOilModalIodine",Y);let j=H?R(H):{},J=(oe,de)=>{let ue=isFinite(de)&&de>0?c(de,1):"--";D(oe,ue)};J("selectedOilHardness",j.hardness),J("selectedOilModalHardness",j.hardness),J("selectedOilCleansing",j.cleansing),J("selectedOilModalCleansing",j.cleansing),J("selectedOilConditioning",j.conditioning),J("selectedOilModalConditioning",j.conditioning),J("selectedOilBubbly",j.bubbly),J("selectedOilModalBubbly",j.bubbly),J("selectedOilCreamy",j.creamy),J("selectedOilModalCreamy",j.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(oe=>{let de=`selectedOil${oe.charAt(0).toUpperCase()}${oe.slice(1)}`,ue=`selectedOilModal${oe.charAt(0).toUpperCase()}${oe.slice(1)}`,he=H?p(H[oe]):0,pe=he>0?c(he,1):"--";D(de,pe),D(ue,pe)})}function O(h){if(!h){G();return}E.selectedOilProfile=h;let q=h.fatty_acid_profile||null;if(typeof q=="string")try{q=JSON.parse(q)}catch{q=null}B({name:h.text||h.display_name||h.name,sapKoh:p(h.saponification_value),iodine:p(h.iodine_value),fattyProfile:q})}function w(h){var x,X,Y,j,J;if(!h)return;let q=(X=(x=h.querySelector(".oil-typeahead"))==null?void 0:x.value)==null?void 0:X.trim(),$=p((Y=h.querySelector(".oil-sap-koh"))==null?void 0:Y.value),H=p((j=h.querySelector(".oil-iodine"))==null?void 0:j.value),U=((J=h.querySelector(".oil-fatty"))==null?void 0:J.value)||"",D=null;if(U)try{D=JSON.parse(U)}catch{D=null}B({name:q,sapKoh:$,iodine:H,fattyProfile:D})}function G(){E.selectedOilProfile=null,E.lastPreviewRow=null,B()}function k(){var H,U,D;let h=C().filter(x=>x.grams>0||x.percent>0);if(!h.length){(H=e.guidance)==null||H.clearSection("oil-blend-tips");return}let q=new Set;h.forEach(x=>{let X=(x.name||"").toLowerCase();if(X&&L.forEach(Y=>{Y.match.test(X)&&q.add(Y.tip)}),x.fattyProfile&&typeof x.fattyProfile=="object"){let Y=p(x.fattyProfile.lauric),j=p(x.fattyProfile.myristic),J=p(x.fattyProfile.palmitic),ne=p(x.fattyProfile.stearic),oe=p(x.fattyProfile.ricinoleic),de=p(x.fattyProfile.oleic),ue=p(x.fattyProfile.linoleic),he=p(x.fattyProfile.linolenic);Y+j>=30&&q.add(`${x.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),J+ne>=40&&q.add(`${x.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),de>=60&&q.add(`${x.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),ue+he>=20&&q.add(`${x.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),oe>=60&&q.add(`${x.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let $=Array.from(q).slice(0,6);if(!$.length){(U=e.guidance)==null||U.clearSection("oil-blend-tips");return}(D=e.guidance)==null||D.setSection("oil-blend-tips",{title:"Blend behavior tips",tone:"info",items:$})}function z(){return E.totalOilsGrams||0}function ee(h){var q,$,H,U,D,x,X,Y,j;return h?{name:((q=h.querySelector(".oil-typeahead"))==null?void 0:q.value)||"",grams:(($=h.querySelector(".oil-grams"))==null?void 0:$.value)||"",percent:((H=h.querySelector(".oil-percent"))==null?void 0:H.value)||"",sap:((U=h.querySelector(".oil-sap-koh"))==null?void 0:U.value)||"",iodine:((D=h.querySelector(".oil-iodine"))==null?void 0:D.value)||"",fattyRaw:((x=h.querySelector(".oil-fatty"))==null?void 0:x.value)||"",gi:((X=h.querySelector(".oil-gi-id"))==null?void 0:X.value)||"",defaultUnit:((Y=h.querySelector(".oil-default-unit"))==null?void 0:Y.value)||"",categoryName:((j=h.querySelector(".oil-category"))==null?void 0:j.value)||""}:null}function K(h,q,$){let H=Q(h);return H?q.has(H):$==="inventory"}function Q(h){return!h||typeof h!="object"?null:h.ingredient&&h.ingredient.ingredient_category_name||h.ingredient_category_name||h.ingredient_category&&h.ingredient_category.name||null}e.oils={attachOilTypeahead:a,buildOilRow:n,getOilTargetGrams:r,updateOilTotals:t,normalizeOils:y,collectOilData:C,setSelectedOilProfileFromRow:w,clearSelectedOilProfile:G,updateOilTips:k,getTotalOilsGrams:z,serializeOilRow:ee,validateOilEntry:I,scaleOilsToTarget:S}})(window);(function(P){"use strict";var m;let e=P.SoapTool=P.SoapTool||{},c=e.bulkOils=e.bulkOils||{},{toNumber:p,clamp:M}=e.helpers,V=e.state,W=Array.isArray((m=e.constants)==null?void 0:m.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],A=new Set(["selected_pct","selected_weight_g"]),T=25,L=140,R=260,E={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function N(){var t,y;(y=(t=e.storage)==null?void 0:t.queueStateSave)==null||y.call(t)}function o(t,y){var C,B;(B=(C=e.ui)==null?void 0:C.showSoapAlert)==null||B.call(C,t,y,{dismissible:!0,timeoutMs:6e3})}function v(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function s(t){return t?t==="name"||A.has(t)?!0:W.includes(t):!1}function a(){(!V.bulkOilModal||typeof V.bulkOilModal!="object")&&(V.bulkOilModal=JSON.parse(JSON.stringify(E)));let t=V.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=s(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let y={},C=t&&typeof t=="object"?t:{};return W.forEach(B=>{let O=p(C[B]);O>0&&(y[B]=O)}),y}function r(t){let y=n(t==null?void 0:t.fatty_profile),C=String((t==null?void 0:t.name)||"").trim(),B=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",O=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:p(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(O?`global:${O}`:`${B}:${C.toLowerCase()}`)),name:C,sap_koh:p(t==null?void 0:t.sap_koh),iodine:p(t==null?void 0:t.iodine),fatty_profile:y,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:O,source:B,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=v(),y=a(),C=Object.keys(y.selection||{}).length,B=`Selected: ${C}`;t.summaryEl&&(t.summaryEl.textContent=B),t.stageCountEl&&(t.stageCountEl.textContent=String(C))}function l(t){var C;return((C=a().selection)==null?void 0:C[t])||null}function _(t,y={}){var w,G;let C=a();if(!t||!t.key)return null;let B=C.selection[t.key]||{},O={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:M(p((w=y.selected_pct)!=null?w:B.selected_pct),0,100),selected_weight_g:M(p((G=y.selected_weight_g)!=null?G:B.selected_weight_g),0)};return C.selection[t.key]=O,O}function g(t){var C;let y=a();(C=y.selection)!=null&&C[t]&&delete y.selection[t]}function I(t){var C;return((C=a().recordByKey)==null?void 0:C[t])||null}function S(){let t=a();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(y=>({key:y.key,name:y.name,sap_koh:y.sap_koh,iodine:y.iodine,fatty_profile:y.fatty_profile||{},default_unit:y.default_unit,ingredient_category_name:y.ingredient_category_name,global_item_id:y.global_item_id,source:y.source,is_basic:!!y.is_basic,selected_pct:M(p(y.selected_pct),0,100),selected_weight_g:M(p(y.selected_weight_g),0)}))}}function b(t){let y=a();y.mode="all",y.viewSelected=!!(t!=null&&t.view_selected),y.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",y.sortKey=s(t==null?void 0:t.sort_key)?t.sort_key:"name",y.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let C={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(O=>{let w=String((O==null?void 0:O.key)||"").trim(),G=String((O==null?void 0:O.name)||"").trim();!w||!G||(C[w]={key:w,name:G,sap_koh:p(O==null?void 0:O.sap_koh),iodine:p(O==null?void 0:O.iodine),fatty_profile:n(O==null?void 0:O.fatty_profile),default_unit:String((O==null?void 0:O.default_unit)||"gram"),ingredient_category_name:String((O==null?void 0:O.ingredient_category_name)||""),global_item_id:p(O==null?void 0:O.global_item_id)>0?parseInt(O.global_item_id,10):null,source:String((O==null?void 0:O.source)||"soapcalc"),is_basic:!!(O!=null&&O.is_basic),selected_pct:M(p(O==null?void 0:O.selected_pct),0,100),selected_weight_g:M(p(O==null?void 0:O.selected_weight_g),0)})}),y.selection=C,y.visibleRecords=[],y.offset=0,y.totalCount=0,y.hasMore=!0,y.loading=!1,d()}c.shared={FATTY_KEYS:W,LOCAL_SORT_KEYS:A,PAGE_SIZE:T,SCROLL_FETCH_THRESHOLD:L,SEARCH_DEBOUNCE_MS:R,queueStateSave:N,showAlert:o,getRefs:v,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:l,setSelection:_,removeSelection:g,getRecordByKey:I,serializeSelection:S,restoreState:b}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared;if(!p)return;let{round:M,toNumber:V}=e.helpers,{fromGrams:W}=e.units,{FATTY_KEYS:A,LOCAL_SORT_KEYS:T,getRefs:L,ensureModalState:R,selectionForRecordKey:E,updateSelectionCounters:N}=p;function o(m){let t=L();t.statusEl&&(t.statusEl.textContent=m)}function v(){let m=R();if(m.loading&&!m.visibleRecords.length){o("Loading oils...");return}if(!m.visibleRecords.length){let O=m.query?"No oils match that search.":"No oils available.";o(O);return}let t=m.visibleRecords.length,y=m.totalCount,C=m.hasMore?" \u2022 scroll for more":"",B=m.query?` \u2022 search: "${m.query}"`:"";o(`Showing ${t} of ${y} oils${B}${C}`)}function s(m,t,y){if(typeof m=="string"||typeof t=="string"){let O=String(m||"").toLowerCase(),w=String(t||"").toLowerCase();return O<w?y==="asc"?-1:1:O>w?y==="asc"?1:-1:0}let C=V(m),B=V(t);return C<B?y==="asc"?-1:1:C>B?y==="asc"?1:-1:0}function a(m,t){var y,C;return t==="selected_pct"?((y=E(m.key))==null?void 0:y.selected_pct)||0:t==="selected_weight_g"?((C=E(m.key))==null?void 0:C.selected_weight_g)||0:""}function n(){let m=R();T.has(m.sortKey)&&m.visibleRecords.sort((t,y)=>{let C=s(a(t,m.sortKey),a(y,m.sortKey),m.sortDir);return C!==0?C:s(t.name||"",y.name||"","asc")})}function r(){let m=R();if(!m.viewSelected)return;let t=[],y=[];m.visibleRecords.forEach(C=>{E(C.key)?t.push(C):y.push(C)}),m.visibleRecords=t.concat(y)}function d(){n(),r()}function l(m){let t=String(m||"").trim().toLowerCase();return t==="name"||A.includes(t)?t:"name"}function _(){let m=R();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let y=t.dataset.label||"",C=t.dataset.sortKey||"";m.sortKey===C?t.textContent=`${y} ${m.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=y})}function g(m,t){let y=E(t.key),C=m.querySelector(".bulk-oil-check"),B=m.querySelector(".bulk-oil-pct"),O=m.querySelector(".bulk-oil-weight");C&&(C.checked=!!y),B&&(B.value=y&&y.selected_pct>0?M(y.selected_pct,2):""),O&&(O.value=y&&y.selected_weight_g>0?M(W(y.selected_weight_g),2):"")}function I(m){let t=document.createElement("td");t.className="bulk-oil-acid";let y=V(m);return t.textContent=y>0?M(y,1).toString():"--",t}function S(m){let t=document.createElement("tr");t.dataset.recordKey=m.key;let y=document.createElement("td");y.className="text-center";let C=document.createElement("input");C.type="checkbox",C.className="form-check-input bulk-oil-check",y.appendChild(C),t.appendChild(y);let B=document.createElement("td");B.className="bulk-oil-name";let O=document.createElement("div");O.className="fw-semibold small",O.textContent=m.name;let w=document.createElement("div");w.className="text-muted small";let G=m.ingredient_category_name?` \xB7 ${m.ingredient_category_name}`:"";w.textContent=`${m.source}${G}`,B.appendChild(O),B.appendChild(w),t.appendChild(B),A.forEach(Q=>{var h;t.appendChild(I((h=m.fatty_profile)==null?void 0:h[Q]))});let k=document.createElement("td"),z=document.createElement("input");z.type="number",z.min="0",z.max="100",z.step="0.1",z.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",k.appendChild(z),t.appendChild(k);let ee=document.createElement("td"),K=document.createElement("input");return K.type="number",K.min="0",K.step="0.1",K.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",ee.appendChild(K),t.appendChild(ee),g(t,m),t}function b(){let m=L(),t=R();if(!m.bodyEl)return;m.bodyEl.innerHTML="";let y=document.createDocumentFragment();t.visibleRecords.forEach(C=>{y.appendChild(S(C))}),m.bodyEl.appendChild(y),_(),N(),v()}c.render={updateStatusText:o,refreshCatalogStatus:v,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:l,sortButtonsLabel:_,renderVisibleRecords:b}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared,M=c.render;if(!p||!M)return;let{PAGE_SIZE:V,getRefs:W,ensureModalState:A,normalizeCatalogRecord:T}=p,{refreshCatalogStatus:L,normalizeServerSortKey:R,applyClientOrdering:E,renderVisibleRecords:N,updateStatusText:o}=M;function v(){let a=A(),n=W();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function s({reset:a=!1}={}){let n=A();if(!W().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&v();let d=n.requestToken+1;n.requestToken=d,n.loading=!0,L();let l=new URLSearchParams;l.set("mode",n.mode),l.set("offset",String(n.offset)),l.set("limit",String(V)),l.set("q",n.query||""),l.set("sort_key",R(n.sortKey)),l.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let _=await fetch(`/tools/api/soap/oils-catalog?${l.toString()}`);if(!_.ok)throw new Error("Unable to load oils catalog");let g=await _.json();if(!g||g.success!==!0||!g.result||!Array.isArray(g.result.records))throw new Error("Invalid oils catalog response");if(d!==n.requestToken)return;let I=g.result.records.map(T),S=Math.max(0,parseInt(g.result.next_offset,10)||n.offset+I.length),b=Math.max(I.length,parseInt(g.result.count,10)||0),m=!!g.result.has_more;I.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?I.slice():n.visibleRecords.concat(I),n.offset=S,n.totalCount=b,n.hasMore=m,E(),N()}catch(_){throw d===n.requestToken&&o("Unable to load oils catalog."),_}finally{d===n.requestToken&&(n.loading=!1,L())}}c.api={fetchCatalogPage:s}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.bulkOils=e.bulkOils||{},p=c.shared,M=c.render,V=c.api;if(!p||!M||!V)return;let{round:W,toNumber:A,clamp:T}=e.helpers,{toGrams:L,fromGrams:R}=e.units,E=e.state,{LOCAL_SORT_KEYS:N,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:v,queueStateSave:s,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:d,setSelection:l,removeSelection:_,getRecordByKey:g,serializeSelection:I,restoreState:S}=p,{applyClientOrdering:b,sortButtonsLabel:m,renderVisibleRecords:t}=M,{fetchCatalogPage:y}=V,C=null,B=null;function O(){var f;let u=n();u.modalEl&&(!C&&((f=P.bootstrap)!=null&&f.Modal)&&(C=P.bootstrap.Modal.getOrCreateInstance(u.modalEl)),C&&C.hide())}function w(){return document.getElementById("oilRows")}function G(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function k(u){return String(u||"").trim().toLowerCase()}function z(u){var f;return k((f=u==null?void 0:u.querySelector(".oil-typeahead"))==null?void 0:f.value)}function ee(u){var F;let f=String(((F=u==null?void 0:u.querySelector(".oil-gi-id"))==null?void 0:F.value)||"").trim();return f||""}function K(u,f){let F=String(u||"").trim();if(!F)return null;let Z=G(),te=Z.find(re=>String(re.dataset.bulkOilKey||"")===F);if(te)return te;let ie=String((f==null?void 0:f.global_item_id)||"").trim();if(ie&&(te=Z.find(re=>ee(re)===ie),te))return te;let ce=k(f==null?void 0:f.name);return ce&&(te=Z.find(re=>z(re)===ce),te)?te:null}function Q(u,f){if(!u||!f)return;u.dataset.bulkOilKey=f.key||"";let F=u.querySelector(".oil-typeahead"),Z=u.querySelector(".oil-sap-koh"),te=u.querySelector(".oil-iodine"),ie=u.querySelector(".oil-fatty"),ce=u.querySelector(".oil-gi-id"),re=u.querySelector(".oil-default-unit"),se=u.querySelector(".oil-category"),ae=u.querySelector(".oil-grams"),fe=u.querySelector(".oil-percent");F&&(F.value=f.name||""),Z&&(Z.value=f.sap_koh>0?W(f.sap_koh,3):""),te&&(te.value=f.iodine>0?W(f.iodine,3):""),ie&&(ie.value=f.fatty_profile&&Object.keys(f.fatty_profile).length?JSON.stringify(f.fatty_profile):""),ce&&(ce.value=f.global_item_id||""),re&&(re.value=f.default_unit||""),se&&(se.value=f.ingredient_category_name||""),fe&&(fe.value=f.selected_pct>0?W(f.selected_pct,2):""),ae&&(ae.value=f.selected_weight_g>0?W(R(f.selected_weight_g),2):"")}function h(u){if(!u||!u.key)return null;let f=K(u.key,u),F=w();return!f&&F&&(f=e.oils.buildOilRow(),f&&F.appendChild(f)),Q(f,u),f}function q(u,f){let F=K(u,f);F&&(E.lastOilEdit&&E.lastOilEdit.row===F&&(E.lastOilEdit=null,e.oils.clearSelectedOilProfile()),F.remove())}function $(){G().forEach(f=>{E.lastOilEdit&&E.lastOilEdit.row===f&&(E.lastOilEdit=null),f.remove()}),e.oils.clearSelectedOilProfile()}function H(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function U(u,f,F){let Z=String(F||"").trim();if(Z)return Z;let te=String(f||"").trim();if(te)return`global:${te}`;let ie=k(u);return ie?`soapcalc:${ie}`:""}function D(){let u={};return G().forEach(f=>{var _e,Ce,Ee,be,ge,Te,Le,le,ye;let F=String(((_e=f.querySelector(".oil-typeahead"))==null?void 0:_e.value)||"").trim(),Z=A((Ce=f.querySelector(".oil-sap-koh"))==null?void 0:Ce.value),te=A((Ee=f.querySelector(".oil-iodine"))==null?void 0:Ee.value),ie=String(((be=f.querySelector(".oil-gi-id"))==null?void 0:be.value)||"").trim(),ce=String(((ge=f.querySelector(".oil-default-unit"))==null?void 0:ge.value)||"gram"),re=String(((Te=f.querySelector(".oil-category"))==null?void 0:Te.value)||""),se=T(A((Le=f.querySelector(".oil-percent"))==null?void 0:Le.value),0,100),ae=T(L((le=f.querySelector(".oil-grams"))==null?void 0:le.value),0),fe=String(((ye=f.querySelector(".oil-fatty"))==null?void 0:ye.value)||""),Se={};if(fe)try{let qe=JSON.parse(fe);Se=p.normalizeFattyProfile(qe)}catch{Se={}}let ve=U(F,ie,f.dataset.bulkOilKey);!ve||!(F||se>0||ae>0||Z>0||te>0||Object.keys(Se).length>0)||(f.dataset.bulkOilKey=ve,u[ve]={key:ve,name:F||"Unnamed oil",sap_koh:Z,iodine:te,fatty_profile:Se,default_unit:ce||"gram",ingredient_category_name:re,global_item_id:ie?parseInt(ie,10):null,source:ie?"global":"soapcalc",is_basic:!ie,selected_pct:se,selected_weight_g:ae})}),u}function x(){let u=r();u.selection=D(),d()}function X(){let u=r(),f=Object.values(u.selection||{}),F=new Set(f.map(Z=>Z.key));G().forEach(Z=>{let te=String(Z.dataset.bulkOilKey||"").trim();(!te||!F.has(te))&&Z.remove()}),f.slice().sort((Z,te)=>String(Z.name||"").localeCompare(String(te.name||""))).forEach(Z=>{h(Z)}),H()}async function Y(){var F;let u=n(),f=r();if(u.modalEl){x(),!C&&((F=P.bootstrap)!=null&&F.Modal)&&(C=P.bootstrap.Modal.getOrCreateInstance(u.modalEl)),u.searchInput&&(u.searchInput.value=f.query||""),u.viewSelectedToggle&&(u.viewSelectedToggle.checked=!!f.viewSelected),u.unitLabelEl&&(u.unitLabelEl.textContent=E.currentUnit||"g"),C&&C.show(),m(),d();try{await y({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function j(u){let f=u.target;if(!(f instanceof HTMLElement))return;let F=f.closest("tr[data-record-key]");if(!F)return;let Z=F.dataset.recordKey||"",te=g(Z);if(!te)return;let ie=F.querySelector(".bulk-oil-check"),ce=F.querySelector(".bulk-oil-pct"),re=F.querySelector(".bulk-oil-weight"),se=T(A(ce==null?void 0:ce.value),0,100),ae=T(L(re==null?void 0:re.value),0),fe=se>0||ae>0;if(!!(ie!=null&&ie.checked)||fe){ie&&(ie.checked=!0);let _e=l(te,{selected_pct:se,selected_weight_g:ae});h(_e)}else _(Z),q(Z,te);let ve=r();N.has(ve.sortKey)||ve.viewSelected?(b(),t()):d(),H(),s()}function J(u){let f=r();f.viewSelected=!!u,b(),t(),s()}async function ne(u){let f=u.target instanceof HTMLElement?u.target.closest(".bulk-oil-sort"):null;if(!f)return;let F=f.getAttribute("data-sort-key")||"name",Z=r();if(Z.sortKey===F?Z.sortDir=Z.sortDir==="asc"?"desc":"asc":(Z.sortKey=F,Z.sortDir=F==="name"?"asc":"desc"),s(),N.has(Z.sortKey)){b(),t();return}try{await y({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function oe(){let u=r();u.selection={},$(),(N.has(u.sortKey)||u.viewSelected)&&b(),t(),H(),s()}async function de(){let u=n(),f=r();if(!(!u.scrollEl||f.loading||!f.hasMore||!(u.scrollEl.scrollTop+u.scrollEl.clientHeight>=u.scrollEl.scrollHeight-o)))try{await y({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ue(){B&&P.clearTimeout(B),B=P.setTimeout(async()=>{try{await y({reset:!0})}catch{a("danger","Unable to search oils right now.")}},v)}function he(){X(),s(),O()}function pe(u,f){if(!(u instanceof HTMLInputElement))return!1;let Z=n().bodyEl;if(!(Z instanceof HTMLElement))return!1;let te=u.classList.contains("bulk-oil-pct")?"bulk-oil-pct":u.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!te)return!1;let ie=Array.from(Z.querySelectorAll(`input.${te}`)),ce=ie.indexOf(u);if(ce<0)return!1;let re=ce+f;if(re<0||re>=ie.length)return!1;let se=ie[re];return se instanceof HTMLInputElement?(se.focus(),typeof se.select=="function"&&se.select(),!0):!1}function me(){var f;let u=n();u.unitLabelEl&&(u.unitLabelEl.textContent=E.currentUnit||"g"),(f=u.modalEl)!=null&&f.classList.contains("show")&&t()}function i(){let u=n();u.modalEl&&(u.openBtn&&u.openBtn.addEventListener("click",()=>{Y()}),u.searchInput&&u.searchInput.addEventListener("input",()=>{let f=r();f.query=u.searchInput.value||"",s(),ue()}),u.viewSelectedToggle&&u.viewSelectedToggle.addEventListener("change",()=>{J(!!u.viewSelectedToggle.checked)}),u.scrollEl&&u.scrollEl.addEventListener("scroll",de),u.bodyEl&&(u.bodyEl.addEventListener("change",j),u.bodyEl.addEventListener("keydown",f=>{let F=f.target;if(!(!(F instanceof HTMLInputElement)||!(F.classList.contains("bulk-oil-pct")||F.classList.contains("bulk-oil-weight")))){if(f.key==="Enter"){f.preventDefault(),F.blur();return}f.key==="Tab"&&pe(F,f.shiftKey?-1:1)&&f.preventDefault()}})),u.modalEl.querySelectorAll(".bulk-oil-sort").forEach(f=>{f.addEventListener("click",ne)}),u.importBtn&&u.importBtn.addEventListener("click",()=>{he()}),u.clearBtn&&u.clearBtn.addEventListener("click",()=>{oe()}),u.modalEl.addEventListener("shown.bs.modal",()=>{let f=n();f.searchInput&&f.searchInput.focus()}))}i(),d(),m(),e.bulkOilsModal={openModal:Y,serializeSelection:I,restoreState:S,onUnitChanged:me}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:c,round:p,clamp:M,buildSoapcalcSearchBuilder:V}=e.helpers,{formatWeight:W,toGrams:A,fromGrams:T}=e.units,{FRAGRANCE_CATEGORY_SET:L}=e.constants,R=e.state;function E(b,m,t,y,C){var ee;let B=document.getElementById(b),O=document.getElementById(m),w=y?document.getElementById(y):null,G=C?document.getElementById(C):null,k=(ee=B==null?void 0:B.parentElement)==null?void 0:ee.querySelector('[data-role="suggestions"]');if(!B||!k||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let z=V();P.attachMergedInventoryGlobalTypeahead({inputEl:B,listEl:k,mode:"public",giHiddenEl:O,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:z,searchType:"ingredient",resultFilter:(K,Q)=>{let h=S(K);return h?t.has(h):Q==="inventory"},requireHidden:!1,onSelection:function(K){w&&(w.value=(K==null?void 0:K.default_unit)||""),G&&(G.value=(K==null?void 0:K.ingredient_category_name)||""),e.storage.queueStateSave()}}),B.addEventListener("input",function(){this.value.trim()||(w&&(w.value=""),G&&(G.value=""))})}function N({pctId:b,weightId:m}){var O,w,G;let t=document.getElementById(b),y=t==null?void 0:t.value;if(y!==""&&y!==null&&y!==void 0)return c(y);let C=M(((w=(O=e.oils)==null?void 0:O.getTotalOilsGrams)==null?void 0:w.call(O))||0,0);if(C<=0)return 0;let B=A((G=document.getElementById(m))==null?void 0:G.value);return B<=0?0:B/C*100}function o(){var b,m,t,y,C,B,O,w;return{lactatePct:N({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:N({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:N({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:N({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((m=(b=document.getElementById("additiveLactateName"))==null?void 0:b.value)==null?void 0:m.trim())||"Sodium Lactate",sugarName:((y=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:y.trim())||"Sugar",saltName:((B=(C=document.getElementById("additiveSaltName"))==null?void 0:C.value)==null?void 0:B.trim())||"Salt",citricName:((w=(O=document.getElementById("additiveCitricName"))==null?void 0:O.value)==null?void 0:w.trim())||"Citric Acid"}}function v(){var m;return(((m=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:m.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function s(b){let m=M(c(b),0),t=M(N({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),y=M(N({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),C=M(N({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),B=M(N({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),O=m*(t/100),w=m*(y/100),G=m*(C/100),k=m*(B/100),z=v()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:y,saltPct:C,citricPct:B,lactateG:O,sugarG:w,saltG:G,citricG:k,citricLyeG:k*z}}function a({pctId:b,weightId:m,sourceField:t,totalOils:y}){let C=document.getElementById(b),B=document.getElementById(m);if(!C||!B)return;let O=M(c(y),0);if(O<=0)return;if(t==="weight"){let z=B.value;if(z===""||z===null||z===void 0){C.value="";return}let ee=M(A(z),0),K=ee>0?ee/O*100:0;C.value=K>0?p(K,2):"";return}let w=C.value;if(w===""||w===null||w===void 0){B.value="";return}let G=M(c(w),0),k=O*(G/100);B.value=k>0?p(T(k),2):""}function n(b){let m=(y,C)=>{let B=document.getElementById(y);if(B)if(B.tagName==="INPUT"){if(document.activeElement===B)return;B.value=C}else B.textContent=C},t=y=>y>0?p(T(y),2):"";m("additiveLactateWeight",t(c(b==null?void 0:b.lactateG))),m("additiveSugarWeight",t(c(b==null?void 0:b.sugarG))),m("additiveSaltWeight",t(c(b==null?void 0:b.saltG))),m("additiveCitricWeight",t(c(b==null?void 0:b.citricG))),m("additiveCitricLyeOut",W(c(b==null?void 0:b.citricLyeG)))}function r(b){let m=M(c(b),0),t=s(m);return n(t),t}function d(b){let m=b.querySelector(".fragrance-typeahead"),t=b.querySelector(".fragrance-gi-id"),y=b.querySelector(".fragrance-default-unit"),C=b.querySelector(".fragrance-category"),B=b.querySelector('[data-role="suggestions"]');if(!m||!B||typeof P.attachMergedInventoryGlobalTypeahead!="function")return;let O=V();P.attachMergedInventoryGlobalTypeahead({inputEl:m,listEl:B,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:O,searchType:"ingredient",resultFilter:(w,G)=>{let k=S(w);return k?L.has(k):G==="inventory"},requireHidden:!1,onSelection:function(w){y&&(y.value=(w==null?void 0:w.default_unit)||""),C&&(C.value=(w==null?void 0:w.ingredient_category_name)||""),e.storage.queueStateSave()}}),m.addEventListener("input",function(){this.value.trim()||(y&&(y.value=""),C&&(C.value=""))})}function l(){var t,y;let b=document.getElementById("fragranceRowTemplate"),m=(y=(t=b==null?void 0:b.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:y.cloneNode(!0);return m?(m.querySelectorAll("input").forEach(C=>{C.value=""}),d(m),m.querySelectorAll(".unit-suffix").forEach(C=>{C.dataset.suffix=R.currentUnit}),m):document.createElement("div")}function _(b){let m=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=M(b||e.oils.getTotalOilsGrams()||0,0),y=0,C=0;m.forEach(w=>{let G=w.querySelector(".fragrance-grams"),k=w.querySelector(".fragrance-percent");if(!G||!k)return;let z=G.value,ee=k.value,K=A(z),Q=M(c(ee),0),h=e.state.lastFragranceEdit,q=h&&h.row===w?h.field:null;t>0&&(q==="percent"?(K=t*(Q/100),G.value=K>0?p(T(K),2):""):q==="grams"?(Q=K/t*100,k.value=Q>0?p(Q,2):""):K>0?(Q=K/t*100,document.activeElement!==k&&(k.value=p(Q,2))):Q>0&&(K=t*(Q/100),document.activeElement!==G&&(G.value=p(T(K),2)))),K>0&&(y+=K),C+=Q});let B=document.getElementById("fragrancePercentTotal");B&&(B.textContent=p(C,2));let O=document.getElementById("fragranceTotalComputed");return O&&(O.textContent=y>0?W(y):"--"),{totalGrams:y,totalPct:C}}function g(){let b=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(m=>{var G,k,z,ee,K,Q,h;let t=((k=(G=m.querySelector(".fragrance-typeahead"))==null?void 0:G.value)==null?void 0:k.trim())||"",y=((z=m.querySelector(".fragrance-grams"))==null?void 0:z.value)||"",C=((ee=m.querySelector(".fragrance-percent"))==null?void 0:ee.value)||"",B=((K=m.querySelector(".fragrance-gi-id"))==null?void 0:K.value)||"",O=((Q=m.querySelector(".fragrance-default-unit"))==null?void 0:Q.value)||"",w=((h=m.querySelector(".fragrance-category"))==null?void 0:h.value)||"";!t&&!y&&!C&&!B||b.push({name:t,grams:y,percent:C,gi:B,defaultUnit:O,categoryName:w})}),b}function I(b){var t,y;let m=Array.isArray(b==null?void 0:b.tips)&&b.tips.length?b.tips:[];if(!m.length){(t=e.guidance)==null||t.clearSection("visual-guidance");return}(y=e.guidance)==null||y.setSection("visual-guidance",{title:"Visual guidance",tone:"info",items:m})}function S(b){return!b||typeof b!="object"?null:b.ingredient&&b.ingredient.ingredient_category_name||b.ingredient_category_name||b.ingredient_category&&b.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:E,collectAdditiveSettings:o,syncAdditivePair:a,applyComputedOutputs:n,updateAdditivesOutput:r,updateVisualGuidance:I},e.fragrances={buildFragranceRow:l,updateFragranceTotals:_,collectFragranceData:g}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{toNumber:c}=e.helpers,{STAGE_CONFIGS:p}=e.constants;function M(T){var E;let L=p[T];if(!L)return;let R=document.getElementById(L.tabId);if(R){if((E=P.bootstrap)!=null&&E.Tab)bootstrap.Tab.getOrCreateInstance(R).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),R.classList.add("active"),R.setAttribute("aria-selected","true");let N=document.getElementById(L.paneId);N&&N.classList.add("show","active")}e.layout.scheduleStageHeightSync(),R.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function V(T){var L,R;if(T===1){let E=document.getElementById("unitGrams");E&&(E.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let N=document.getElementById("moldCylinderCorrection");N&&(N.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(L=e.mold)!=null&&L.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(T===2){let E=document.getElementById("oilRows");E&&(E.innerHTML="",E.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(T===3){let E=document.getElementById("lyeTypeNaoh");E&&(E.checked=!0);let N=document.getElementById("waterMethod");N&&(N.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let v=document.getElementById("lyePurity");v&&(v.value="100");let s=document.getElementById("waterPct");s&&(s.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(T===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(E=>{let N=document.getElementById(E);N&&(N.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(E=>{let N=document.getElementById(E);N&&(N.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),T===5){let E=document.getElementById("fragranceRows");E&&(E.innerHTML="",(R=e.fragrances)!=null&&R.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()));let N=document.getElementById("fragrancePercentTotal");N&&(N.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),A()}function W(T){var L;if(T===1){let R=c(document.getElementById("moldWaterWeight").value),E=c(document.getElementById("oilTotalTarget").value),N=c(document.getElementById("moldOilPct").value),v=!!document.querySelector('input[name="weight_unit"]:checked')&&(R>0||E>0)&&N>0;return{state:v?"complete":"incomplete",label:v?"Sized":"Needs target"}}if(T===2){let E=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(N=>{var a,n,r,d;let o=(n=(a=N.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),v=c((r=N.querySelector(".oil-grams"))==null?void 0:r.value),s=c((d=N.querySelector(".oil-percent"))==null?void 0:d.value);return o&&(v>0||s>0)});return{state:E?"complete":"incomplete",label:E?"Oils added":"Add oils"}}if(T===3){let R=c(document.getElementById("lyeSuperfat").value),E=(L=document.getElementById("waterMethod"))==null?void 0:L.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!E&&R>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return T===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(E=>c(document.getElementById(E).value)>0)?"Added":"Optional"}:T===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(N=>{var a,n,r,d;let o=(n=(a=N.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),v=c((r=N.querySelector(".fragrance-grams"))==null?void 0:r.value),s=c((d=N.querySelector(".fragrance-percent"))==null?void 0:d.value);return o||v>0||s>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function A(){let T=document.getElementById("soapStageTabList");T&&T.querySelectorAll(".soap-stage-status").forEach(R=>R.remove());let L=document.getElementById("soapStageProgress");L&&(L.textContent="")}e.stages={openStageByIndex:M,resetStage:V,updateStageStatuses:A}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p,clamp:M}=e.helpers,{computeFattyAcids:V,computeQualities:W,computeOilQualityScores:A}=e.calc,{QUALITY_RANGES:T,QUALITY_HINTS:L,QUALITY_FEEL_HINTS:R,IODINE_RANGE:E,IODINE_SCALE_MAX:N,INS_RANGE:o,INS_SCALE_MAX:v,QUALITY_BASE:s,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:l}=e.ui;function _({barId:w,fillId:G,value:k,max:z,label:ee}){let K=document.getElementById(w),Q=document.getElementById(G);if(!K||!Q)return null;let h=isFinite(k)?k:0,q=Math.max(0,Math.min(z,h)),$=z>0?q/z*100:0;return Q.style.width=`${$}%`,K.setAttribute("aria-valuemin","0"),K.setAttribute("aria-valuemax",String(z)),K.setAttribute("aria-valuenow",q.toFixed(1)),ee&&K.setAttribute("aria-label",ee),{bar:K,fill:Q,value:h}}function g(w,G,k){if(!(!w||!k)){if(w.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(G)){w.classList.add("bg-secondary");return}G<k[0]?w.classList.add("bg-warning"):G>k[1]?w.classList.add("bg-danger"):w.classList.add("bg-success")}}function I(w,G,k,z,ee,K){let Q=_({barId:w,fillId:G,value:k,max:ee,label:K});Q&&g(Q.fill,k,z)}function S(){let w={hardness:{range:T.hardness,scale:100},cleansing:{range:T.cleansing,scale:100},conditioning:{range:T.conditioning,scale:100},bubbly:{range:T.bubbly,scale:100},creamy:{range:T.creamy,scale:100},iodine:{range:E,scale:N},ins:{range:o,scale:v}};Object.entries(w).forEach(([G,k])=>{let[z,ee]=k.range,K=k.scale,Q=G.charAt(0).toUpperCase()+G.slice(1),h=G==="iodine"?"iodineBar":G==="ins"?"insBar":`quality${Q}Bar`,q=document.getElementById(`quality${Q}Safe`);if(q){let D=Math.max(0,Math.min(100,z/K*100)),x=Math.max(0,Math.min(100,(ee-z)/K*100));q.style.left=`${D}%`,q.style.width=`${x}%`,q.title=`Safe range ${c(z,0)}-${c(ee,0)}`}let $=document.getElementById(h);$&&($.dataset.safeRange=`${c(z,0)}-${c(ee,0)}`);let H=document.getElementById(`quality${Q}RangeMin`),U=document.getElementById(`quality${Q}RangeMax`);H&&(H.textContent=c(z,0)),U&&(U.textContent=c(ee,0))})}function b(w,G){let k=M(w.hardness||0,0,100),z=M(w.bubbly||0,0,100),ee=M(w.conditioning||0,0,100),K=M(ee+(G||0)*3,0,100),Q=document.getElementById("feelHardness"),h=document.getElementById("feelBubbly"),q=document.getElementById("feelConditioning"),$=document.getElementById("feelGreasy");Q&&(Q.value=c(k,1)),h&&(h.value=c(z,1)),q&&(q.value=c(ee,1)),$&&($.value=c(K,1))}function m(w){r.forEach(G=>{let k=document.getElementById(`fattyBar${G.charAt(0).toUpperCase()}${G.slice(1)}`);if(!k)return;let z=M(p(w[G]),0,100),ee=z;k.style.width=`${ee}%`,k.style.backgroundColor=n[G]||"var(--color-muted)",k.title=`${G.charAt(0).toUpperCase()}${G.slice(1)}: ${c(z,1)}%`})}function t(){var z;let w=((z=document.getElementById("qualityPreset"))==null?void 0:z.value)||"balanced",G=Array.from(document.querySelectorAll(".quality-focus:checked"));if(w==="none"&&!G.length)return null;let k=w==="none"?{...s}:a[w]?{...a[w]}:{...s};return G.forEach(ee=>{let K=ee.dataset.attr,Q=ee.dataset.direction,h=T[K];h&&(k[K]=Q==="low"?h[0]:h[1])}),k}function y(){let w=t(),G={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(G).forEach(([k,z])=>{if(!z)return;let ee=document.getElementById(`${z.id}Label`);if(!w){z.classList.add("d-none"),ee&&(ee.textContent="");return}let K=p(w[k]);if(!isFinite(K)){z.classList.add("d-none"),ee&&(ee.textContent="");return}let Q=k==="iodine"?N:k==="ins"?v:100,h=M(K,0,Q);z.classList.remove("d-none"),z.style.left=`${h/Q*100}%`,z.setAttribute("aria-label",`Apply ${k} target`),z.setAttribute("role","button"),z.setAttribute("tabindex","0"),z.title=`Target ${k}: ${c(K,1)}`,ee&&(ee.textContent=c(K,1))})}function C(){let w=t();if(!w){l("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let k=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(x=>{var J,ne;let X=e.units.toGrams((J=x.querySelector(".oil-grams"))==null?void 0:J.value),Y=((ne=x.querySelector(".oil-fatty"))==null?void 0:ne.value)||"",j=null;if(Y)try{j=JSON.parse(Y)}catch{j=null}return{row:x,grams:X,fattyProfile:j}}).filter(x=>x.grams>0);if(!k.length){l("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let z=V(k.map(x=>({grams:x.grams,fattyProfile:x.fattyProfile}))),ee=W(z.percent),K={hardness:M((w.hardness-ee.hardness)/100,-1,1),cleansing:M((w.cleansing-ee.cleansing)/100,-1,1),conditioning:M((w.conditioning-ee.conditioning)/100,-1,1),bubbly:M((w.bubbly-ee.bubbly)/100,-1,1),creamy:M((w.creamy-ee.creamy)/100,-1,1)},Q=k.reduce((x,X)=>x+X.grams,0),h=[],q=0,$=.8,H=k.filter(x=>!x.fattyProfile||typeof x.fattyProfile!="object").length;if(H===k.length){l("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(H&&l("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),k.forEach(x=>{let X=A(x.fattyProfile),Y=K.hardness*X.hardness+K.cleansing*X.cleansing+K.conditioning*X.conditioning+K.bubbly*X.bubbly+K.creamy*X.creamy,j=M(1+Y*$,.2,1.8),J=x.grams*j;h.push({row:x.row,grams:J}),q+=J}),q<=0){l("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let U=Q/q,D=e.oils.getOilTargetGrams()||Q;h.forEach(x=>{let X=x.grams*U,Y=x.row.querySelector(".oil-grams"),j=x.row.querySelector(".oil-percent");if(Y&&(Y.value=X>0?c(e.units.fromGrams(X),2):""),j&&D>0){let J=X/D*100;j.value=J>0?c(J,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),l("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function B(w){var de,ue,he,pe;let{qualities:G,fattyPercent:k,coveragePct:z,iodine:ee,ins:K,sapAvg:Q,superfat:h,warnings:q}=w,$=z>0,H=[];function U(me,i){var te,ie;let u=document.getElementById(`quality${me}Value`);if(!u)return;u.textContent=$&&isFinite(i)?c(i,1):"--",d(u);let f=me.toLowerCase(),F=T[f],Z=_({barId:`quality${me}Bar`,fillId:`quality${me}Fill`,value:$?i:0,max:100,label:me});Z&&F&&(g(Z.fill,i,F),$&&isFinite(i)?Z.bar.title=`${me}: ${c(i,1)} (safe ${F[0]}-${F[1]}). ${L[f]||""}`.trim():Z.bar.title=`${me}: -- (safe ${F[0]}-${F[1]}). ${L[f]||""}`.trim()),F&&$&&isFinite(i)&&(i<F[0]?H.push(`${me}: ${((te=R[f])==null?void 0:te.low)||"Below preferred range."}`):i>F[1]&&H.push(`${me}: ${((ie=R[f])==null?void 0:ie.high)||"Above preferred range."}`))}U("Hardness",G.hardness),U("Cleansing",G.cleansing),U("Conditioning",G.conditioning),U("Bubbly",G.bubbly),U("Creamy",G.creamy);let D=document.getElementById("fattyCoverageNote");D&&(D.textContent=z>0?`Fatty acid coverage: ${c(z,1)}% of oils`:"Fatty acid coverage: not enough data yet");let x=document.getElementById("iodineValue"),X=document.getElementById("insValue"),Y=document.getElementById("sapAvgValue");x&&(x.textContent=ee>0?c(ee,1):"--",d(x)),X&&(X.textContent=K>0?c(K,1):"--",d(X)),Y&&(Y.textContent=Q>0?c(Q,1):"--",d(Y)),I("iodineBar","iodineFill",ee,E,N,"Iodine"),I("insBar","insFill",K,o,v,"INS");let j=(k.lauric||0)+(k.myristic||0)+(k.palmitic||0)+(k.stearic||0),J=(k.ricinoleic||0)+(k.oleic||0)+(k.linoleic||0)+(k.linolenic||0),ne=document.getElementById("fattySatRatioResult");ne&&(ne.textContent=j+J>0?`${c(j,0)}:${c(J,0)}`:"--",d(ne)),r.forEach(me=>{let i=`fatty${me.charAt(0).toUpperCase()}${me.slice(1)}`,u=k[me];document.getElementById(i).textContent=$&&u?`${c(u,1)}%`:"--"}),b(G,h||0),m(k),y();let oe=Array.isArray(q)?q.slice():[];H.length?(de=e.guidance)==null||de.setSection("quality-feel-hints",{title:"Quality feel hints",tone:"info",items:H}):(ue=e.guidance)==null||ue.clearSection("quality-feel-hints"),oe.length?(he=e.guidance)==null||he.setSection("quality-warning-flags",{title:"Quality flags",tone:"warning",items:oe}):(pe=e.guidance)==null||pe.clearSection("quality-warning-flags"),e.layout.scheduleStageHeightSync()}function O(){var w;document.querySelectorAll(".soap-quality-help").forEach(G=>{let k=G.dataset.quality;L[k]&&G.setAttribute("title",L[k])}),(w=P.bootstrap)!=null&&w.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(G=>{bootstrap.Tooltip.getOrCreateInstance(G)})}e.quality={setQualityRangeBars:S,updateQualityTargets:y,applyQualityTargets:C,updateQualitiesDisplay:B,initQualityTooltips:O}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p,clamp:M}=e.helpers;function V(o){let v=0,s=0;return(o||[]).forEach(a=>{let n=p(a==null?void 0:a.sapKoh),r=p(a==null?void 0:a.grams);n>0&&r>0&&(v+=n*r,s+=r)}),s>0?v/s:0}function W(o){var _,g,I,S,b,m,t,y,C,B,O,w;let v=o.qualityReport||{},s=v.fatty_acids_pct||{},a=v.qualities||{},n=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:p(v.sap_avg_koh)||V(o.oils||[]),r=p(v.iodine),d=p(v.ins)||(n&&r?n-r:0),l=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((_=document.getElementById("qualityPreset"))==null?void 0:_.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(G=>G.id),mold:l,oils:(o.oils||[]).map(G=>({name:G.name||null,grams:c(G.grams||0,2),iodine:G.iodine||null,sap_koh:G.sapKoh||null,fatty_profile:G.fattyProfile||null,global_item_id:G.global_item_id||null,default_unit:G.default_unit||null,ingredient_category_name:G.ingredient_category_name||null})),totals:{total_oils_g:c(o.totalOils||0,2),batch_yield_g:c(o.batchYield||0,2),lye_pure_g:c(o.lyePure||0,2),lye_adjusted_g:c(o.lyeAdjusted||0,2),water_g:c(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((g=o.additives)==null?void 0:g.fragrancePct)||0,lactate_pct:((I=o.additives)==null?void 0:I.lactatePct)||0,sugar_pct:((S=o.additives)==null?void 0:S.sugarPct)||0,salt_pct:((b=o.additives)==null?void 0:b.saltPct)||0,citric_pct:((m=o.additives)==null?void 0:m.citricPct)||0,fragrance_g:c(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:c(((y=o.additives)==null?void 0:y.lactateG)||0,2),sugar_g:c(((C=o.additives)==null?void 0:C.sugarG)||0,2),salt_g:c(((B=o.additives)==null?void 0:B.saltG)||0,2),citric_g:c(((O=o.additives)==null?void 0:O.citricG)||0,2),citric_lye_g:c(((w=o.additives)==null?void 0:w.citricLyeG)||0,2)},qualities:{hardness:c(a.hardness||0,1),cleansing:c(a.cleansing||0,1),conditioning:c(a.conditioning||0,1),bubbly:c(a.bubbly||0,1),creamy:c(a.creamy||0,1),iodine:c(r||0,1),ins:c(d||0,1),sap_avg:c(n||0,1)},fatty_acids:s,updated_at:new Date().toISOString()}}function A(o,v,s,a,n){var g,I,S,b,m;let r=(I=(g=document.getElementById(o))==null?void 0:g.value)==null?void 0:I.trim(),d=((S=document.getElementById(v))==null?void 0:S.value)||"",l=a&&((b=document.getElementById(a))==null?void 0:b.value)||"",_=n&&((m=document.getElementById(n))==null?void 0:m.value)||"";return{name:r||s,globalItemId:d?parseInt(d):void 0,defaultUnit:l||void 0,categoryName:_||void 0}}function T(o){let v=[],s=M(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var b,m,t,y,C,B,O;let n=(m=(b=a.querySelector(".fragrance-typeahead"))==null?void 0:b.value)==null?void 0:m.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((y=a.querySelector(".fragrance-default-unit"))==null?void 0:y.value)||"",l=((C=a.querySelector(".fragrance-category"))==null?void 0:C.value)||"",_=(B=a.querySelector(".fragrance-grams"))==null?void 0:B.value,g=(O=a.querySelector(".fragrance-percent"))==null?void 0:O.value,I=e.units.toGrams(_),S=M(p(g),0);I<=0&&S>0&&s>0&&(I=s*(S/100)),!(!n&&!r&&I<=0)&&v.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:l||void 0,grams:I,pct:S})}),v}function L(o,v){let s=[];return document.querySelectorAll(`#${o} .row`).forEach(function(a){var g,I,S;let n=(I=(g=a.querySelector(".tool-typeahead"))==null?void 0:g.value)==null?void 0:I.trim(),r=((S=a.querySelector(".tool-gi-id"))==null?void 0:S.value)||"",d=a.querySelector(".tool-qty"),l=a.querySelector(".tool-unit"),_=d&&d.value!=="";!n&&!r||(v==="container"?s.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:_?parseFloat(d.value):1}):s.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:_?parseFloat(d.value):0,unit:((l==null?void 0:l.value)||"").trim()||"gram"}))}),s}function R(o){let v=e.config.isAuthenticated?"member":"public",s=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:v,mode:s,unitOptionsHtml:e.config.unitOptionsHtml})}function E(o,v){let s=R(o),a=s.querySelector(".tool-typeahead"),n=s.querySelector(".tool-qty");a&&(a.value=v),n&&o==="container"&&(n.value=1),o==="container"?document.getElementById("tool-containers").appendChild(s):o==="consumable"?document.getElementById("tool-consumables").appendChild(s):document.getElementById("tool-ingredients").appendChild(s)}function N(o){var r,d,l,_;let v=W(o),s=(o.oils||[]).map(g=>({name:g.name||void 0,global_item_id:g.global_item_id||void 0,quantity:g.grams,unit:"gram",default_unit:g.default_unit||void 0,ingredient_category_name:g.ingredient_category_name||void 0})),a=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&s.push({name:a,quantity:c(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&s.push({name:"Distilled Water",quantity:c(o.water,2),unit:"gram"}),T(o.totalOils||0).forEach(g=>{g.grams>0&&s.push({name:g.name,global_item_id:g.globalItemId,quantity:c(g.grams,2),unit:"gram",default_unit:g.defaultUnit,ingredient_category_name:g.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let g=A("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");s.push({name:g.name,global_item_id:g.globalItemId,quantity:c(o.additives.lactateG,2),unit:"gram",default_unit:g.defaultUnit,ingredient_category_name:g.categoryName})}if(((d=o.additives)==null?void 0:d.sugarG)>0){let g=A("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");s.push({name:g.name,global_item_id:g.globalItemId,quantity:c(o.additives.sugarG,2),unit:"gram",default_unit:g.defaultUnit,ingredient_category_name:g.categoryName})}if(((l=o.additives)==null?void 0:l.saltG)>0){let g=A("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");s.push({name:g.name,global_item_id:g.globalItemId,quantity:c(o.additives.saltG,2),unit:"gram",default_unit:g.defaultUnit,ingredient_category_name:g.categoryName})}if(((_=o.additives)==null?void 0:_.citricG)>0){let g=A("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");s.push({name:g.name,global_item_id:g.globalItemId,quantity:c(o.additives.citricG,2),unit:"gram",default_unit:g.defaultUnit,ingredient_category_name:g.categoryName}),s.push({name:"Extra Lye for Citric Acid",quantity:c(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:s.concat(L("tool-ingredients","ingredient")),consumables:L("tool-consumables","consumable"),containers:L("tool-containers","container"),notes:JSON.stringify(v)}}e.recipePayload={collectFragranceRows:T,collectDraftLines:L,buildLineRow:R,addStubLine:E,buildSoapRecipePayload:N}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p,clamp:M}=e.helpers,{formatWeight:V,formatPercent:W}=e.units;function A(){var _;let a=((_=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:_.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,d=p(n==null?void 0:n.value),l=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:l,purity:d}}function T(){var r,d;let a=document.getElementById("lyePurity"),n=A();a&&(a.removeAttribute("readonly"),n.selected==="KOH90"?(r=e.guidance)==null||r.setSection("lye-purity",{title:"Lye setup",tone:"info",items:["90% KOH selected. Safe default purity is 90%."]}):(d=e.guidance)==null||d.clearSection("lye-purity"))}function L(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function R(a=null,n=null){var _,g;let r=document.getElementById("stageWaterOutput"),d=n||(a==null?void 0:a.waterMethod)||((_=document.getElementById("waterMethod"))==null?void 0:_.value)||"percent";if(r){let I=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=I?V(a.waterG):"--"}let l="";if(!a||!isFinite(a.totalOils)||a.totalOils<=0)l=`Set oils in Stage 2 to calculate water. ${L(d)}`;else if(d==="concentration"){let I=a.lyeConcentrationInput||a.lyeConcentration||0;l=`Using ${c(I,1)}% lye concentration from ${V(a.lyeAdjusted||0)} lye.`}else if(d==="ratio"){let I=a.waterRatioInput||a.waterRatio||0;l=`Using ${c(I,2)} : 1 water-to-lye ratio from ${V(a.lyeAdjusted||0)} lye.`}else l=`Using ${c(a.waterPct||0,1)}% of total oils (${V(a.totalOils)}).`;(g=e.guidance)==null||g.setSection("water-method",{title:"Lye & water hints",tone:"info",items:[l]})}function E(a=null,n=null){var B;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),l=document.getElementById("waterPreview"),_=document.getElementById("concPreview"),g=document.getElementById("ratioPreview");if(!r&&!d&&!l&&!_&&!g)return;let I=(O,w)=>{O&&(O.textContent=w)},S=n||(a==null?void 0:a.waterMethod)||((B=document.getElementById("waterMethod"))==null?void 0:B.value)||"percent",b=p(a==null?void 0:a.totalOils),m=p(a==null?void 0:a.lyeAdjusted),t=p(a==null?void 0:a.waterG);if(b<=0||m<=0){I(r,"Based on -- oils. All values update live as you change inputs."),I(d,"--"),I(l,"--"),I(_,"--"),I(g,"--");return}let y=p(a==null?void 0:a.lyeConcentration)>0?p(a==null?void 0:a.lyeConcentration):m+t>0?m/(m+t)*100:0,C=p(a==null?void 0:a.waterRatio)>0?p(a==null?void 0:a.waterRatio):m>0?t/m:0;if(I(r,`Based on ${V(b)} oils. All values update live as you change inputs.`),I(d,V(m)),I(l,V(t)),I(_,y>0?W(y):"--"),I(g,C>0?`${c(C,2)} : 1`:"--"),S==="concentration"){let O=p(a==null?void 0:a.lyeConcentrationInput);O>0&&I(_,W(O))}if(S==="ratio"){let O=p(a==null?void 0:a.waterRatioInput);O>0&&I(g,`${c(O,2)} : 1`)}}function N(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),R(null,a),E(null,a)}function o(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,d=[],l=e.oils.collectOilData(),_=e.oils.getOilTargetGrams(),I=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(S=>M(p(S.value),0)).some(S=>S>0);return(!l.length||n<=0)&&d.push("Add at least one oil with a weight or percent."),!_&&n<=0&&I&&d.push("Enter a total oils target or weights to convert percentages."),_>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),_>0&&n>_+.01?d.push("Oil weights exceed the mold target."):!_&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:l}}function v(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=p(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function s(){var g,I,S,b;let n=A().purity;isFinite(n)||(n=100);let r=((g=document.getElementById("waterMethod"))==null?void 0:g.value)||"percent",d=p((I=document.getElementById("waterPct"))==null?void 0:I.value),l=p((S=document.getElementById("lyeConcentration"))==null?void 0:S.value),_=p((b=document.getElementById("waterRatio"))==null?void 0:b.value);return{purity:n,waterMethod:r,waterPct:d,lyeConcentration:l,waterRatio:_}}e.runnerInputs={getLyeSelection:A,applyLyeSelection:T,setWaterMethod:N,updateStageWaterSummary:R,updateLiveCalculationPreview:E,validateCalculation:o,readSuperfatInput:v,sanitizeLyeInputs:s}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{getStorage:c}=e.helpers;function p(){if(!e.config.calcLimit)return{count:0,date:null};let T=c();if(!T)return{count:0,date:null};try{let L=T.getItem("soap_calc_usage"),R=new Date().toISOString().slice(0,10);if(!L)return{count:0,date:R};let E=JSON.parse(L);return!E||E.date!==R?{count:0,date:R}:{count:Number(E.count)||0,date:R}}catch{return{count:0,date:null}}}function M(T){if(!e.config.calcLimit)return;let L=c();if(!L)return;let R=new Date().toISOString().slice(0,10);try{L.setItem("soap_calc_usage",JSON.stringify({count:T,date:R}))}catch{}}function V(){return e.config.calcLimit&&p().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function W(){if(!e.config.calcLimit)return;let L=p().count+1;M(L);let R=Math.max(0,e.config.calcLimit-L);R<=1&&e.ui.showSoapAlert("info",`You have ${R} calculation${R===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function A(T){if(!e.config.calcLimit||T===null||T>1)return;let L=document.getElementById("soapSignupModal");L&&(P.bootstrap&&P.bootstrap.Modal?P.bootstrap.Modal.getOrCreateInstance(L).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:V,consumeCalcQuota:W,maybeShowSignupModal:A}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.state;function p({oils:V,selection:W,superfat:A,purity:T,waterMethod:L,waterPct:R,lyeConcentration:E,waterRatio:N,totalOils:o}){let v=e.additives.collectAdditiveSettings(),s=e.recipePayload.collectFragranceRows(o||0);return{oils:(V||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:s.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:v.lactatePct||0,sugar_pct:v.sugarPct||0,salt_pct:v.saltPct||0,citric_pct:v.citricPct||0,lactate_name:v.lactateName||"Sodium Lactate",sugar_name:v.sugarName||"Sugar",salt_name:v.saltName||"Salt",citric_name:v.citricName||"Citric Acid"},lye:{selected:(W==null?void 0:W.selected)||"NaOH",superfat:A,purity:T},water:{method:L,water_pct:R,lye_concentration:E,water_ratio:N},meta:{unit_display:c.currentUnit||"g"}}}async function M(V){var L;let W=((L=document.querySelector('meta[name="csrf-token"]'))==null?void 0:L.getAttribute("content"))||"",A=new AbortController,T=P.setTimeout(()=>A.abort(),2500);try{let R=await fetch("/tools/api/soap/calculate",{method:"POST",signal:A.signal,headers:{"Content-Type":"application/json",...W?{"X-CSRFToken":W}:{}},body:JSON.stringify(V||{})});if(!R.ok)return null;let E=await R.json();return!E||E.success!==!0||typeof E.result!="object"?null:E.result}catch{return null}finally{P.clearTimeout(T)}}e.runnerService={buildServicePayload:p,calculateWithSoapService:M}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{round:c,toNumber:p}=e.helpers,{formatWeight:M,formatPercent:V}=e.units,W=e.state,A={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function T(o){return(o||[]).map(v=>{var s;return{name:v.name||null,grams:p(v.grams),sapKoh:p((s=v.sap_koh)!=null?s:v.sapKoh),iodine:p(v.iodine),fattyProfile:v.fatty_profile||v.fattyProfile||null,global_item_id:v.global_item_id||null,default_unit:v.default_unit||null,ingredient_category_name:v.ingredient_category_name||null}})}function L(o,v){let s=document.getElementById(o);s&&(s.textContent=v)}function R({resultsCard:o,lyeAdjusted:v,waterData:s,batchYield:a,totalOils:n,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let l=p(o.water_lye_ratio)||s.waterRatio;L("lyeAdjustedOutput",M(p(o.lye_adjusted_g)||v)),L("waterOutput",M(p(o.water_g)||s.waterG)),L("batchYieldOutput",M(a)),L("lyeConcentrationOutput",V(p(o.lye_concentration_pct)||s.lyeConcentration)),L("waterRatioOutput",isFinite(l)&&l>0?c(l,2).toString():"--"),L("totalOilsOutput",M(n)),L("superfatOutput",V(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(_=>e.ui.pulseValue(document.getElementById(_)))}function E({showAlerts:o,lyeTotals:v,purity:s,waterData:a}){if(!o)return;v.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),s<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${c(s,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function N({serviceResult:o,validation:v,selection:s,superfat:a,purity:n,waterMethod:r,waterPct:d,lyeConcentrationInput:l,waterRatioInput:_,showAlerts:g}){var x;let I=o.lye_type||s.lyeType||"NaOH",S=o.lye_selected||s.selected||null,b=p(o.total_oils_g)||v.totals.totalWeight,m=p(o.superfat_pct),t=isFinite(m)?m:a,y={sapAvg:p(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},C=p(o.lye_pure_g),O=Object.prototype.hasOwnProperty.call(o,"lye_adjusted_base_g")?p(o.lye_adjusted_base_g):null,w=p(o.lye_adjusted_g),G=p(o.lye_purity_pct)||n,k=o.water_method||r,z=p(o.water_pct)||d,ee=p(o.lye_concentration_input_pct)||l,K=p(o.water_ratio_input)||_,Q={waterG:p(o.water_g),lyeConcentration:p(o.lye_concentration_pct),waterRatio:p(o.water_lye_ratio)},h=o.results_card||{},q=o.quality_report||{},$=T(o.oils||v.oils),H={waterG:Q.waterG,lyeAdjusted:w,totalOils:b,waterMethod:k,waterPct:z,lyeConcentrationInput:ee,waterRatioInput:K,lyeConcentration:Q.lyeConcentration,waterRatio:Q.waterRatio};e.runnerInputs.updateStageWaterSummary(H),e.runnerInputs.updateLiveCalculationPreview(H);let U=o.additives||A;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(U);let D=p(h.batch_yield_g)||b+w+Q.waterG+U.fragranceG+U.lactateG+U.sugarG+U.saltG+U.citricG;return(x=e.mold)!=null&&x.updateWetBatterWarning&&e.mold.updateWetBatterWarning(D),R({resultsCard:h,lyeAdjusted:w,waterData:Q,batchYield:D,totalOils:b,superfat:t}),e.ui.updateResultsWarnings(Q),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:q.qualities||{},fattyPercent:q.fatty_acids_pct||{},coveragePct:p(q.coverage_pct),iodine:p(q.iodine),ins:p(q.ins),sapAvg:y.sapAvg,superfat:t,waterData:Q,additives:U,oils:$,totalOils:b,warnings:q.warnings||[]}),e.additives.updateVisualGuidance({tips:q.visual_guidance||[]}),e.stages.updateStageStatuses(),E({showAlerts:g,lyeTotals:y,purity:G,waterData:Q}),W.lastCalc={totalOils:b,oils:$,lyeType:I,lyeSelected:S,superfat:t,purity:G,lyePure:C,lyeAdjustedBase:O,lyeAdjusted:w,water:Q.waterG,waterMethod:k,waterPct:z,lyeConcentration:Q.lyeConcentration,waterRatio:Q.waterRatio,sapAvg:y.sapAvg,usedSapFallback:y.usedFallback,additives:U,batchYield:D,qualityReport:q,export:o.export||null},W.lastCalc}e.runnerRender={applyServiceResult:N}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},c=e.state,p=e.runnerInputs,M=e.runnerQuota,V=e.runnerService,W=e.runnerRender;async function A(T={}){var R;let L={consumeQuota:!1,showAlerts:!0,...T};try{L.showAlerts&&e.ui.clearSoapAlerts();let E=p.validateCalculation();if(!E.ok)return p.updateStageWaterSummary(null),p.updateLiveCalculationPreview(null),(R=e.mold)!=null&&R.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),L.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${E.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(L.consumeQuota&&!M.canConsumeCalcQuota())return null;let N=p.readSuperfatInput(),o=p.getLyeSelection(),v=p.sanitizeLyeInputs(),s=(c.calcRequestSeq||0)+1;c.calcRequestSeq=s;let a=V.buildServicePayload({oils:E.oils,selection:o,superfat:N,purity:v.purity,waterMethod:v.waterMethod,waterPct:v.waterPct,lyeConcentration:v.lyeConcentration,waterRatio:v.waterRatio,totalOils:E.totals.totalWeight}),n=await V.calculateWithSoapService(a);if(s!==c.calcRequestSeq)return c.lastCalc;if(!n)return L.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=W.applyServiceResult({serviceResult:n,validation:E,selection:o,superfat:N,purity:v.purity,waterMethod:v.waterMethod,waterPct:v.waterPct,lyeConcentrationInput:v.lyeConcentration,waterRatioInput:v.waterRatio,showAlerts:L.showAlerts});return L.consumeQuota&&M.consumeCalcQuota(),r}catch{return L.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...T)=>p.getLyeSelection(...T),applyLyeSelection:(...T)=>p.applyLyeSelection(...T),setWaterMethod:(...T)=>p.setWaterMethod(...T),updateLiveCalculationPreview:(...T)=>p.updateLiveCalculationPreview(...T),calculateAll:A,buildSoapRecipePayload:(...T)=>e.recipePayload.buildSoapRecipePayload(...T),buildLineRow:(...T)=>e.recipePayload.buildLineRow(...T),addStubLine:(...T)=>e.recipePayload.addStubLine(...T),maybeShowSignupModal:(...T)=>M.maybeShowSignupModal(...T)}})(window);(function(P){"use strict";let e=P.SoapTool=P.SoapTool||{},{formatTime:c,getStorage:p}=e.helpers,M="soap_tool_state_v2";function V(s,a){let n=[];return document.querySelectorAll(`#${s} .row`).forEach(d=>{var b,m,t;let l=(m=(b=d.querySelector(".tool-typeahead"))==null?void 0:b.value)==null?void 0:m.trim(),_=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",g=d.querySelector(".tool-qty"),I=d.querySelector(".tool-unit"),S=g&&g.value!==""?e.helpers.toNumber(g.value):null;!l&&!_||(a==="container"?n.push({name:l||"",global_item_id:_?parseInt(_):null,quantity:S&&S>0?S:1}):n.push({name:l||"",global_item_id:_?parseInt(_):null,quantity:S&&S>=0?S:0,unit:(I==null?void 0:I.value)||"gram"}))}),n}function W(){let s=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var m,t,y,C,B,O,w,G,k,z;let n=((t=(m=a.querySelector(".oil-typeahead"))==null?void 0:m.value)==null?void 0:t.trim())||"",r=((y=a.querySelector(".oil-grams"))==null?void 0:y.value)||"",d=((C=a.querySelector(".oil-percent"))==null?void 0:C.value)||"",l=((B=a.querySelector(".oil-sap-koh"))==null?void 0:B.value)||"",_=((O=a.querySelector(".oil-iodine"))==null?void 0:O.value)||"",g=((w=a.querySelector(".oil-fatty"))==null?void 0:w.value)||"",I=((G=a.querySelector(".oil-gi-id"))==null?void 0:G.value)||"",S=((k=a.querySelector(".oil-default-unit"))==null?void 0:k.value)||"",b=((z=a.querySelector(".oil-category"))==null?void 0:z.value)||"";!n&&!r&&!d&&!I||s.push({name:n,grams:r,percent:d,sap:l,iodine:_,fattyRaw:g,gi:I,defaultUnit:S,categoryName:b})}),s}function A(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let s=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var S,b,m,t,y,C,B;let r=((b=(S=n.querySelector(".fragrance-typeahead"))==null?void 0:S.value)==null?void 0:b.trim())||"",d=((m=n.querySelector(".fragrance-grams"))==null?void 0:m.value)||"",l=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",_=((y=n.querySelector(".fragrance-gi-id"))==null?void 0:y.value)||"",g=((C=n.querySelector(".fragrance-default-unit"))==null?void 0:C.value)||"",I=((B=n.querySelector(".fragrance-category"))==null?void 0:B.value)||"";!r&&!d&&!l&&!_||s.push({name:r,grams:d,percent:l,gi:_,defaultUnit:g,categoryName:I})}),s}function T(s,a){let n=document.getElementById("oilRows");if(!n||!s)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=s.name||"",r.querySelector(".oil-grams").value=s.grams||"",r.querySelector(".oil-percent").value=s.percent||"",r.querySelector(".oil-sap-koh").value=s.sap||"",r.querySelector(".oil-iodine").value=s.iodine||"",r.querySelector(".oil-fatty").value=s.fattyRaw||"",r.querySelector(".oil-gi-id").value=s.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=s.defaultUnit||"");let l=r.querySelector(".oil-category");l&&(l.value=s.categoryName||"");let _=Array.from(n.children);return a>=_.length?n.appendChild(r):n.insertBefore(r,_[a]),r}function L(){var n,r,d,l,_,g,I,S,b,m,t,y,C,B,O,w,G,k,z,ee,K,Q,h,q,$,H,U;let s=p();if(!s)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:W(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((l=document.getElementById("waterMethod"))==null?void 0:l.value)||"percent",water_pct:((_=document.getElementById("waterPct"))==null?void 0:_.value)||"",lye_concentration:((g=document.getElementById("lyeConcentration"))==null?void 0:g.value)||"",water_ratio:((I=document.getElementById("waterRatio"))==null?void 0:I.value)||""},additives:{fragrances:A(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((S=document.getElementById("additiveLactateName"))==null?void 0:S.value)||"",lactate_gi:((b=document.getElementById("additiveLactateGi"))==null?void 0:b.value)||"",lactate_unit:((m=document.getElementById("additiveLactateUnit"))==null?void 0:m.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((y=document.getElementById("additiveSugarName"))==null?void 0:y.value)||"",sugar_gi:((C=document.getElementById("additiveSugarGi"))==null?void 0:C.value)||"",sugar_unit:((B=document.getElementById("additiveSugarUnit"))==null?void 0:B.value)||"",sugar_category:((O=document.getElementById("additiveSugarCategory"))==null?void 0:O.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((w=document.getElementById("additiveSaltName"))==null?void 0:w.value)||"",salt_gi:((G=document.getElementById("additiveSaltGi"))==null?void 0:G.value)||"",salt_unit:((k=document.getElementById("additiveSaltUnit"))==null?void 0:k.value)||"",salt_category:((z=document.getElementById("additiveSaltCategory"))==null?void 0:z.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((ee=document.getElementById("additiveCitricName"))==null?void 0:ee.value)||"",citric_gi:((K=document.getElementById("additiveCitricGi"))==null?void 0:K.value)||"",citric_unit:((Q=document.getElementById("additiveCitricUnit"))==null?void 0:Q.value)||"",citric_category:((h=document.getElementById("additiveCitricCategory"))==null?void 0:h.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((q=document.getElementById("moldShape"))==null?void 0:q.value)||"loaf",cylinder_correction:!!(($=document.getElementById("moldCylinderCorrection"))!=null&&$.checked),cylinder_factor:((H=document.getElementById("moldCylinderFactor"))==null?void 0:H.value)||"0.85"},quality:{preset:((U=document.getElementById("qualityPreset"))==null?void 0:U.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(D=>D.id)},lines:{ingredients:V("tool-ingredients","ingredient"),consumables:V("tool-consumables","consumable"),containers:V("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{s.setItem(M,JSON.stringify(a));let D=document.getElementById("soapLastSaved");D&&(D.textContent=c(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function R(){var l,_,g;let s=p();if(!s)return;let a=s.getItem(M);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let I=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);I&&(I.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(S=>{let b=e.oils.buildOilRow();b.querySelector(".oil-typeahead").value=S.name||"",b.querySelector(".oil-grams").value=S.grams||"",b.querySelector(".oil-percent").value=S.percent||"",b.querySelector(".oil-sap-koh").value=S.sap||"",b.querySelector(".oil-iodine").value=S.iodine||"",b.querySelector(".oil-fatty").value=S.fattyRaw||"",b.querySelector(".oil-gi-id").value=S.gi||"";let m=b.querySelector(".oil-default-unit");m&&(m.value=S.defaultUnit||"");let t=b.querySelector(".oil-category");t&&(t.value=S.categoryName||""),r.appendChild(b)})),n.lye_form){let I=document.getElementById("lyeSuperfat");I&&(I.value=n.lye_form.superfat||"5");let S=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);S&&(S.checked=!0);let b=document.getElementById("lyePurity");b&&(b.value=n.lye_form.lye_purity||"100");let m=document.getElementById("waterMethod");m&&(m.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let y=document.getElementById("lyeConcentration");y&&(y.value=n.lye_form.lye_concentration||"");let C=document.getElementById("waterRatio");C&&(C.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let I=document.getElementById("fragranceRows");if(I&&((l=e.fragrances)!=null&&l.buildFragranceRow)){I.innerHTML="";let q=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(q)q.forEach($=>{let H=e.fragrances.buildFragranceRow();H.querySelector(".fragrance-typeahead").value=$.name||"",H.querySelector(".fragrance-grams").value=$.grams||"",H.querySelector(".fragrance-percent").value=$.percent||"",H.querySelector(".fragrance-gi-id").value=$.gi||"";let U=H.querySelector(".fragrance-default-unit");U&&(U.value=$.defaultUnit||"");let D=H.querySelector(".fragrance-category");D&&(D.value=$.categoryName||""),I.appendChild(H)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let $=e.fragrances.buildFragranceRow();$.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",$.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",$.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",I.appendChild($)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let S=document.getElementById("additiveLactateName");S&&(S.value=n.additives.lactate_name||"");let b=document.getElementById("additiveLactateGi");b&&(b.value=n.additives.lactate_gi||"");let m=document.getElementById("additiveLactateUnit");m&&(m.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let y=document.getElementById("additiveSugarName");y&&(y.value=n.additives.sugar_name||"");let C=document.getElementById("additiveSugarGi");C&&(C.value=n.additives.sugar_gi||"");let B=document.getElementById("additiveSugarUnit");B&&(B.value=n.additives.sugar_unit||"");let O=document.getElementById("additiveSugarCategory");O&&(O.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let w=document.getElementById("additiveSaltName");w&&(w.value=n.additives.salt_name||"");let G=document.getElementById("additiveSaltGi");G&&(G.value=n.additives.salt_gi||"");let k=document.getElementById("additiveSaltUnit");k&&(k.value=n.additives.salt_unit||"");let z=document.getElementById("additiveSaltCategory");z&&(z.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let ee=document.getElementById("additiveCitricName");ee&&(ee.value=n.additives.citric_name||"");let K=document.getElementById("additiveCitricGi");K&&(K.value=n.additives.citric_gi||"");let Q=document.getElementById("additiveCitricUnit");Q&&(Q.value=n.additives.citric_unit||"");let h=document.getElementById("additiveCitricCategory");h&&(h.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let I=document.getElementById("moldShape");I&&(I.value=n.mold.shape||"loaf");let S=document.getElementById("moldCylinderCorrection");S&&(S.checked=!!n.mold.cylinder_correction);let b=document.getElementById("moldCylinderFactor");b&&(b.value=n.mold.cylinder_factor||"0.85");let m=document.getElementById("oilTotalTarget");(_=e.mold)!=null&&_.syncMoldPctFromTarget&&((g=e.mold)!=null&&g.syncTargetFromMold)&&(e.units.toGrams(m==null?void 0:m.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let I=document.getElementById("qualityPreset");if(I){let S=n.quality.preset||"balanced",b=Array.from(I.options).find(m=>m.value===S);I.value=b?S:"balanced"}document.querySelectorAll(".quality-focus").forEach(S=>{S.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(S.id)})}function d(I,S,b){let m=document.getElementById(I);m&&(m.innerHTML="",(S||[]).forEach(t=>{let y=e.runner.buildLineRow(b),C=y.querySelector(".tool-typeahead"),B=y.querySelector(".tool-gi-id"),O=y.querySelector(".tool-qty"),w=y.querySelector(".tool-unit");C&&(C.value=t.name||""),B&&(B.value=t.global_item_id||""),O&&t.quantity!==void 0&&t.quantity!==null&&(O.value=t.quantity),w&&t.unit&&Array.from(w.options).find(k=>k.value===t.unit)&&(w.value=t.unit),m.appendChild(y)}))}if(n.lines&&(d("tool-ingredients",n.lines.ingredients,"ingredient"),d("tool-consumables",n.lines.consumables,"consumable"),d("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let I=document.getElementById("soapLastSaved");I&&(I.textContent=c(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let E=null;function N(){E&&clearTimeout(E),E=setTimeout(L,350)}let o=null;function v(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:L,restoreState:R,serializeLines:V,serializeOils:W,restoreOilRow:T,queueStateSave:N,queueAutoCalc:v}})(window);(function(P){"use strict";var pe,me;let e=P.SoapTool=P.SoapTool||{},{LACTATE_CATEGORY_SET:c,SUGAR_CATEGORY_SET:p,SALT_CATEGORY_SET:M,CITRIC_CATEGORY_SET:V}=e.constants,{round:W,toNumber:A,clamp:T}=e.helpers,{formatWeight:L,formatPercent:R,toGrams:E}=e.units,N=e.state;async function o(){var u;let i=N.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return i||((u=e.ui)!=null&&u.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function v(i){let u=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(f=>{var re,se,ae,fe;let F=(se=(re=f.querySelector(".fragrance-typeahead"))==null?void 0:re.value)==null?void 0:se.trim(),Z=(ae=f.querySelector(".fragrance-grams"))==null?void 0:ae.value,te=(fe=f.querySelector(".fragrance-percent"))==null?void 0:fe.value,ie=E(Z),ce=T(A(te),0);ie<=0&&ce>0&&i>0&&(ie=i*(ce/100)),!(ie<=0&&ce<=0&&!F)&&(!ce&&ie>0&&i>0&&(ce=ie/i*100),u.push({name:F||"Fragrance/Essential Oils",grams:ie,pct:ce}))}),u}function s(i){var ie,ce,re,se,ae,fe,Se,ve;let u=[];if(!i)return u;let f=((ce=(ie=document.getElementById("additiveLactateName"))==null?void 0:ie.value)==null?void 0:ce.trim())||"Sodium Lactate",F=((se=(re=document.getElementById("additiveSugarName"))==null?void 0:re.value)==null?void 0:se.trim())||"Sugar",Z=((fe=(ae=document.getElementById("additiveSaltName"))==null?void 0:ae.value)==null?void 0:fe.trim())||"Salt",te=((ve=(Se=document.getElementById("additiveCitricName"))==null?void 0:Se.value)==null?void 0:ve.trim())||"Citric Acid";return i.lactateG>0&&u.push({name:f,grams:i.lactateG,pct:i.lactatePct}),i.sugarG>0&&u.push({name:F,grams:i.sugarG,pct:i.sugarPct}),i.saltG>0&&u.push({name:Z,grams:i.saltG,pct:i.saltPct}),i.citricG>0&&u.push({name:te,grams:i.citricG,pct:i.citricPct}),u}function a(i){var ce,re;let u=[],f=A((ce=i.additives)==null?void 0:ce.citricLyeG),F=A((re=i.additives)==null?void 0:re.citricG),Z=String(i.lyeType||"NaOH").toUpperCase();return f>0&&F>0&&(Z==="KOH"?u.push("Citric-acid lye adjustment used 0.71 x citric acid because KOH was selected."):u.push("Citric-acid lye adjustment used 0.624 x citric acid because NaOH was selected."),u.push(`${L(f)} lye added extra to accommodate the extra citrus.`)),i.usedSapFallback&&u.push("Average SAP fallback was used for oils missing SAP values."),String(i.lyeSelected||"").toUpperCase()==="KOH90"&&u.push("KOH90 selection assumes 90% lye purity."),(Array.isArray(i.oils)?i.oils:[]).some(se=>{let ae=A(se==null?void 0:se.sapKoh);return ae>0&&ae<=1})&&u.push("SAP values at or below 1.0 were treated as decimal SAP and converted to mg KOH/g."),u}function n(i){var re,se;if(Array.isArray((re=i==null?void 0:i.export)==null?void 0:re.csv_rows)&&i.export.csv_rows.length)return i.export.csv_rows;let u=i.totalOils||0,f=[["section","name","quantity","unit","percent"]];f.push(["Summary","Lye Type",i.lyeType||"","",""]),f.push(["Summary","Superfat",W(i.superfat||0,2),"%",""]),f.push(["Summary","Lye Purity",W(i.purity||0,1),"%",""]),f.push(["Summary","Water Method",i.waterMethod||"","",""]),f.push(["Summary","Water %",W(i.waterPct||0,1),"%",""]),f.push(["Summary","Lye Concentration",W(i.lyeConcentration||0,1),"%",""]),f.push(["Summary","Water Ratio",W(i.waterRatio||0,2),"",""]),f.push(["Summary","Total Oils",W(u,2),"gram",""]),f.push(["Summary","Batch Yield",W(i.batchYield||0,2),"gram",""]),(i.oils||[]).forEach(ae=>{let fe=u>0?W(ae.grams/u*100,2):"";f.push(["Oils",ae.name||"Oil",W(ae.grams||0,2),"gram",fe])});let F=A((se=i.additives)==null?void 0:se.citricLyeG),te=i.lyeAdjustedBase!==null&&i.lyeAdjustedBase!==void 0&&i.lyeAdjustedBase!==""?A(i.lyeAdjustedBase)+F:A(i.lyeAdjusted);if(te>0){let ae=i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";F>0&&(ae+="*"),f.push(["Lye",ae,W(te,2),"gram",""])}return i.water>0&&f.push(["Water","Distilled Water",W(i.water,2),"gram",""]),v(u).forEach(ae=>{f.push(["Fragrance",ae.name,W(ae.grams||0,2),"gram",W(ae.pct||0,2)])}),s(i.additives).forEach(ae=>{f.push(["Additives",ae.name,W(ae.grams||0,2),"gram",W(ae.pct||0,2)])}),a(i).forEach(ae=>{f.push(["Notes",`* ${ae}`,"","",""])}),f}function r(i){if(i==null)return"";let u=String(i);return/[",\n]/.test(u)?`"${u.replace(/"/g,'""')}"`:u}function d(i){return i.map(u=>u.map(r).join(",")).join(`
`)}function l(i,u){let f=new Blob([i],{type:"text/csv;charset=utf-8;"}),F=URL.createObjectURL(f),Z=document.createElement("a");Z.href=F,Z.download=u,document.body.appendChild(Z),Z.click(),document.body.removeChild(Z),URL.revokeObjectURL(F)}function _(i){var Ee,be;if(typeof((Ee=i==null?void 0:i.export)==null?void 0:Ee.sheet_html)=="string"&&i.export.sheet_html.trim())return i.export.sheet_html;let u=i.totalOils||0,f=(i.oils||[]).map(ge=>({name:ge.name||"Oil",grams:ge.grams||0,pct:u>0?ge.grams/u*100:0})),F=v(u),Z=s(i.additives),te=new Date().toLocaleString(),ie=f.length?f.map(ge=>`
          <tr>
            <td>${ge.name}</td>
            <td class="text-end">${L(ge.grams)}</td>
            <td class="text-end">${R(ge.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',ce=F.length?F.map(ge=>`
          <tr>
            <td>${ge.name}</td>
            <td class="text-end">${L(ge.grams)}</td>
            <td class="text-end">${R(ge.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',re=Z.length?Z.map(ge=>`
          <tr>
            <td>${ge.name}</td>
            <td class="text-end">${L(ge.grams)}</td>
            <td class="text-end">${R(ge.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',se=A((be=i.additives)==null?void 0:be.citricLyeG),fe=i.lyeAdjustedBase!==null&&i.lyeAdjustedBase!==void 0&&i.lyeAdjustedBase!==""?A(i.lyeAdjustedBase)+se:A(i.lyeAdjusted),Se=`${i.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)"}${se>0?"*":""}`,ve=`${L(fe)}${se>0?"*":""}`,Ie=a(i),_e=Ie.map(ge=>`<div class="footnote">* ${ge}</div>`).join(""),Ce=Ie.length?`<div class="footnotes"><h2 class="footnotes-heading">Assumptions</h2>${_e}</div>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
      .footnotes { margin-top: 10px; }
      .footnotes-heading { font-size: 14px; margin: 12px 0 4px; }
      .footnote { font-size: 11px; color: #555; margin-top: 6px; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${te}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${i.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${R(i.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${R(i.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${L(u)}</span></div>
      <div class="summary-item"><span>Water</span><span>${L(i.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${L(i.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${i.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${R(i.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ie}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${Se}</td><td class="text-end">${ve}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${L(i.water||0)}</td></tr>
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ce}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${re}</tbody>
    </table>
    ${Ce}
  </body>
</html>`}let g=document.getElementById("oilRows"),I=document.getElementById("addOil"),S=document.getElementById("normalizeOils");I&&g&&(I.dataset.bound="direct",I.addEventListener("click",function(){g.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),S&&(S.dataset.bound="direct",S.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),g&&g.addEventListener("input",function(i){i.target.classList.contains("oil-grams")&&(N.lastOilEdit={row:i.target.closest(".oil-row"),field:"grams"}),i.target.classList.contains("oil-percent")&&(N.lastOilEdit={row:i.target.closest(".oil-row"),field:"percent"}),(i.target.classList.contains("oil-grams")||i.target.classList.contains("oil-percent")||i.target.classList.contains("oil-typeahead"))&&(i.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(i.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),g&&g.addEventListener("focusin",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(i.target.closest(".oil-row"))}),g&&g.addEventListener("focusout",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),i.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(i.target.closest(".oil-row"),"grams"),i.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(i.target.closest(".oil-row"),"percent")}),g&&g.addEventListener("keydown",function(i){i.key==="Enter"&&(i.target.classList.contains("oil-grams")&&(i.preventDefault(),e.oils.validateOilEntry(i.target.closest(".oil-row"),"grams")),i.target.classList.contains("oil-percent")&&(i.preventDefault(),e.oils.validateOilEntry(i.target.closest(".oil-row"),"percent")))}),g&&g.addEventListener("mouseover",function(i){if(!i.target.classList.contains("oil-typeahead"))return;let u=i.target.closest(".oil-row");!u||u===N.lastPreviewRow||(N.lastPreviewRow=u,e.oils.setSelectedOilProfileFromRow(u))}),g&&g.addEventListener("mouseout",function(i){i.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),g&&g.addEventListener("click",function(i){let u=i.target.closest(".oil-profile-open");if(u){let F=u.closest(".oil-row");if(F){e.oils.setSelectedOilProfileFromRow(F);let Z=document.getElementById("oilProfileModal");Z&&P.bootstrap&&bootstrap.Modal.getOrCreateInstance(Z).show()}return}let f=i.target.closest(".remove-oil");if(f){let F=f.closest(".oil-row");F&&(N.lastRemovedOil=e.oils.serializeOilRow(F),N.lastRemovedOilIndex=Array.from(F.parentElement.children).indexOf(F),e.ui.showUndoToast("Oil removed.")),F&&N.lastOilEdit&&N.lastOilEdit.row===F&&(N.lastOilEdit=null,e.oils.clearSelectedOilProfile()),F&&F.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let b=document.getElementById("fragranceRows"),m=document.getElementById("addFragrance");m&&b&&(m.dataset.bound="direct",m.addEventListener("click",function(){b.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),b&&(b.addEventListener("input",function(i){i.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:i.target.closest(".fragrance-row"),field:"grams"}),i.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:i.target.closest(".fragrance-row"),field:"percent"}),(i.target.classList.contains("fragrance-grams")||i.target.classList.contains("fragrance-percent")||i.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),b.addEventListener("click",function(i){var F;let u=i.target.closest(".remove-fragrance");if(!u)return;let f=u.closest(".fragrance-row");f&&((F=e.state.lastFragranceEdit)==null?void 0:F.row)===f&&(e.state.lastFragranceEdit=null),f&&f.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let t=document.getElementById("soapStageTabContent"),y=()=>{if(!t)return null;let i=t.querySelector(".tab-pane.active")||t.querySelector(".tab-pane.show.active");return i?i.querySelector(".soap-stage-body")||i:null},C=()=>{t&&t.addEventListener("wheel",i=>{let u=i.target;if(!(u instanceof HTMLElement))return;let f=u.closest('input[type="number"]');if(!(f instanceof HTMLInputElement))return;let F=y();if(!(F instanceof HTMLElement)||F.scrollHeight<=F.clientHeight+1)return;document.activeElement===f&&typeof f.blur=="function"&&f.blur();let Z=F.scrollTop<=0,te=F.scrollTop+F.clientHeight>=F.scrollHeight-1;i.deltaY<0&&Z||i.deltaY>0&&te||(F.scrollTop+=i.deltaY,i.preventDefault())},{passive:!1})};t&&(t.addEventListener("click",i=>{let u=i.target.closest("[data-stage-action]"),f=i.target.closest("[data-soap-action]");if(!u&&!f)return;if(i.preventDefault(),i.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),f){if(f.dataset.bound==="direct")return;let te=f.dataset.soapAction;te==="add-oil"&&g&&(g.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),te==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),te==="add-fragrance"&&b&&(b.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let F=u.dataset.stageAction,Z=Number(u.dataset.stageIndex);Number.isNaN(Z)||(F==="prev"&&e.stages.openStageByIndex(Math.max(0,Z-1)),F==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,Z+1)),F==="reset"&&e.stages.resetStage(Z+1))}),C());let B=document.getElementById("soapStageTabList"),O=()=>{if(!B)return;B.querySelectorAll(".nav-item").forEach(u=>u.classList.remove("is-expanded"));let i=B.querySelector(".nav-link.active");i&&i.closest(".nav-item")&&i.closest(".nav-item").classList.add("is-expanded")};B&&(B.addEventListener("shown.bs.tab",()=>{O(),e.layout.scheduleStageHeightSync()}),O());let w=document.getElementById("resultsCardToggle"),G=document.getElementById("resultsCard");w&&G&&w.addEventListener("click",()=>{G.classList.toggle("is-collapsed");let i=G.classList.contains("is-collapsed");w.setAttribute("aria-expanded",(!i).toString());let u=i?"Expand formula details":"Collapse formula details";w.setAttribute("aria-label",u),w.setAttribute("title",u);let f=w.querySelector("i");f&&(f.classList.toggle("fa-chevron-down",i),f.classList.toggle("fa-chevron-up",!i))}),document.querySelectorAll('input[name="weight_unit"]').forEach(i=>{i.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let k=()=>{var i;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(i=e.mold)!=null&&i.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},z=document.getElementById("oilTotalTarget");z&&z.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let ee=document.getElementById("waterMethod");ee&&ee.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(i=>{i.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(i=>{let u=document.getElementById(i);u&&["input","change"].forEach(f=>{u.addEventListener(f,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:i,weightId:u})=>{let f=document.getElementById(i),F=document.getElementById(u);f&&f.addEventListener("input",()=>{let Z=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:i,weightId:u,sourceField:"pct",totalOils:Z}),e.additives.updateAdditivesOutput(Z),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),F&&F.addEventListener("input",()=>{let Z=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:i,weightId:u,sourceField:"weight",totalOils:Z}),e.additives.updateAdditivesOutput(Z),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(i=>{i.addEventListener("input",()=>{e.storage.queueStateSave()})});let Q=document.getElementById("qualityPreset");Q&&Q.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(i=>{i.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let h=document.getElementById("applyQualityTargets");h&&h.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(i=>{i.addEventListener("click",()=>e.quality.applyQualityTargets()),i.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),e.quality.applyQualityTargets())})});let q=document.getElementById("moldWaterWeight");q&&q.addEventListener("input",function(){e.mold.syncTargetFromMold(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let $=document.getElementById("moldOilPct");$&&$.addEventListener("input",function(){e.mold.syncTargetFromMold(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let H=document.getElementById("moldShape");H&&H.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let U=document.getElementById("moldCylinderCorrection");U&&U.addEventListener("change",function(){e.mold.syncTargetFromMold(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldCylinderFactor");D&&D.addEventListener("input",function(){e.mold.syncTargetFromMold(),k(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(i=>{i.addEventListener("click",function(){let u=this.dataset.stubKind,f=this.dataset.stubName;e.runner.addStubLine(u,f),e.storage.queueStateSave()})});let x=document.getElementById("soapToolPage");x&&(x.addEventListener("click",function(i){i.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),x.addEventListener("input",function(i){i.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(i.target),e.stages.updateStageStatuses(),e.ui.flashStage(i.target.closest(".soap-stage-card")))}),x.addEventListener("change",function(i){i.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(i.target),e.stages.updateStageStatuses())}));let X=document.getElementById("addToolIngredient");X&&X.addEventListener("click",function(){let i=document.getElementById("tool-ingredients");i&&i.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let Y=document.getElementById("addToolConsumable");Y&&Y.addEventListener("click",function(){let i=document.getElementById("tool-consumables");i&&i.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let j=document.getElementById("addToolContainer");j&&j.addEventListener("click",function(){let i=document.getElementById("tool-containers");i&&i.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let J=document.getElementById("calcLyeBtn");J&&J.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let ne=document.getElementById("saveSoapTool");ne&&ne.addEventListener("click",async function(){try{let i=N.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!i)return;let u=e.runner.buildSoapRecipePayload(i);N.lastRecipePayload=u;try{let f=e.helpers.getStorage();f&&f.setItem("soap_recipe_payload",JSON.stringify(u))}catch{}P.SOAP_RECIPE_DTO=u,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let oe=document.getElementById("exportSoapCsv");oe&&oe.addEventListener("click",async function(){var F;let i=await o();if(!i)return;let u=n(i),f=typeof((F=i==null?void 0:i.export)==null?void 0:F.csv_text)=="string"&&i.export.csv_text?i.export.csv_text:d(u);l(f,"soap_formula.csv")});let de=document.getElementById("printSoapSheet");de&&de.addEventListener("click",async function(){var F;let i=await o();if(!i)return;let u=_(i),f=P.open("","_blank","width=960,height=720");if(!f){(F=e.ui)!=null&&F.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}f.document.open(),f.document.write(u),f.document.close(),f.focus(),f.onload=()=>{f.print()}});let ue=document.getElementById("soapUndoRemove");ue&&ue.addEventListener("click",()=>{N.lastRemovedOil&&(e.storage.restoreOilRow(N.lastRemovedOil,N.lastRemovedOilIndex||0),N.lastRemovedOil=null,N.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let i=document.getElementById("soapMobileDrawer"),u=document.getElementById("soapMobileDrawerContent"),f=document.getElementById("soapMobileDrawerTitle"),F=document.getElementById("soapDrawerEmpty"),Z=document.getElementById("soapDrawerClose"),te=document.getElementById("soapQualityCard"),ie=document.getElementById("resultsCard");if(!i||!u||!f||!te||!ie)return;let ce=te.parentElement,re=ie.parentElement,se=new Map,ae=null,fe=()=>P.matchMedia("(max-width: 767px)").matches,Se=le=>le==="quality"?te:ie,ve=le=>le==="quality"?ce:re,Ie=le=>le==="quality"?"Display":"Results",_e=le=>{let ye=se.get(le);ye||(ye=document.createElement("div"),ye.className="soap-card-placeholder",se.set(le,ye)),ye.style.height=`${le.offsetHeight}px`,le.parentElement&&le.parentElement!==u&&!ye.parentElement&&le.parentElement.insertBefore(ye,le)},Ce=le=>{le&&(_e(le),u.appendChild(le))},Ee=(le,ye)=>{let qe=se.get(le);qe&&qe.parentElement?qe.replaceWith(le):ye&&le.parentElement!==ye&&ye.appendChild(le)},be=()=>{if(!F)return;let le=ae==="results",ye=getComputedStyle(ie).display!=="none";F.classList.toggle("d-none",!le||ye)},ge=le=>{fe()&&(ae&&ae!==le&&Ee(Se(ae),ve(ae)),Ce(Se(le)),f.textContent=Ie(le),ae=le,i.classList.add("is-open"),be())},Te=()=>{ae&&(Ee(Se(ae),ve(ae)),ae=null,i.classList.remove("is-open"),be())};i.querySelectorAll("[data-drawer-target]").forEach(le=>{le.addEventListener("click",()=>{let ye=le.dataset.drawerTarget;ye&&(i.classList.contains("is-open")&&ae===ye?Te():ge(ye))})}),Z&&Z.addEventListener("click",Te),P.addEventListener("resize",()=>{!fe()&&ae&&Te()}),new MutationObserver(()=>be()).observe(ie,{attributes:!0,attributeFilter:["style","class"]})})(),P.addEventListener("resize",e.layout.scheduleStageHeightSync),P.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",c,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",p,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",M,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",V,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),g&&!g.querySelector(".oil-row")&&g.appendChild(e.oils.buildOilRow()),b&&!b.querySelector(".fragrance-row")&&(pe=e.fragrances)!=null&&pe.buildFragranceRow&&b.appendChild(e.fragrances.buildFragranceRow()),(me=e.fragrances)!=null&&me.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
