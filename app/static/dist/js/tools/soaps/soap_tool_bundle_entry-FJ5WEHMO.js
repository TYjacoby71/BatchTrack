(function(B){"use strict";let e={inventory:"Inventory",global:"Global Library"},c={inventory:"bg-primary",global:"bg-info text-dark"},y={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function A(r,d){let s;return function(){let q=arguments;clearTimeout(s),s=setTimeout(()=>r.apply(null,q),d)}}function K(r){return(r||"").trim().toLowerCase()}function U(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function R(r){return typeof r=="function"?r():r}function m(r){let d=new Set;return(r||[]).forEach(s=>{let q=s&&(s.global_item_id||s.id);q&&d.add(String(q))}),d}function C(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${c[r]||"bg-secondary"} ms-2">${d}</span>`}function O(r,d,s,q){q=q||{},r.innerHTML="";let E=!1;if(d.forEach(T=>{!T.items||!T.items.length||(E=!0,T.items.forEach(h=>{let _=document.createElement("a");_.href="#",_.className="list-group-item list-group-item-action suggestion-item";let u=q.showSubtitle&&h.subtitle?`<div class="small text-muted mt-1">${h.subtitle}</div>`:"";_.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${h.text||h.display_name||h.name||""}</span>
          ${q.showSourceBadge?C(T.source||h.source):""}
        </div>${u}`,_.addEventListener("click",function(t){t.preventDefault(),s(h,T.source||h.source),r.classList.add("d-none")}),r.appendChild(_)}))}),r.classList.toggle("d-none",!E),!E&&r.dataset.emptyMessage){let T=document.createElement("div");T.className="list-group-item text-muted small",T.textContent=r.dataset.emptyMessage,r.appendChild(T),r.classList.remove("d-none")}}function g(r,d,s){r.innerHTML="";let q=!1;d.forEach(E=>{if(!E.ingredients||!E.ingredients.length)return;q=!0;let T=document.createElement("div");T.className="list-group-item text-muted small fw-semibold",T.textContent=E.title,r.appendChild(T),E.ingredients.forEach(h=>{let _=document.createElement("div");_.className="list-group-item ingredient-result";let u=document.createElement("div");u.className="d-flex justify-content-between align-items-center ingredient-summary",u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.innerHTML=`<span class="fw-semibold">${h.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${h.forms.length} option${h.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",h.forms.forEach(b=>{let G=document.createElement("button");G.type="button",G.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",G.innerHTML=`<div class="fw-semibold">${b.text||b.display_name||b.name||"Form"}</div>`,G.addEventListener("click",function(){s(b,b.source||E.source),r.classList.add("d-none")}),t.appendChild(G)});function p(b){b.type==="keydown"&&b.key!=="Enter"&&b.key!==" "||(b.preventDefault(),t.classList.toggle("d-none"))}u.addEventListener("click",p),u.addEventListener("keydown",p),_.appendChild(u),_.appendChild(t),r.appendChild(_),h.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!q)}function P(r,d,s){r.innerHTML="";let q=!1;if((d||[]).forEach(E=>{q=!0;let T=document.createElement("a");T.href="#",T.className="list-group-item list-group-item-action suggestion-item";let h=E.inci_name?`<div class="small text-muted">${E.inci_name}</div>`:"";T.innerHTML=`<div class="fw-semibold">${E.text||E.name}</div>${h}`,T.addEventListener("click",function(_){_.preventDefault(),s(E,"definition"),r.classList.add("d-none")}),r.appendChild(T)}),r.classList.toggle("d-none",!q),!q&&r.dataset.emptyMessage){let E=document.createElement("div");E.className="list-group-item text-muted small",E.textContent=r.dataset.emptyMessage,r.appendChild(E),r.classList.remove("d-none")}}function n(r){let d=[];return(r||[]).forEach(s=>{if(s&&Array.isArray(s.forms)&&s.forms.length){let q=s.ingredient&&s.ingredient.name||s.ingredient_name||null,E=s.ingredient&&s.ingredient.ingredient_category_name||s.ingredient_category_name||s.ingredient_category&&s.ingredient_category.name||null,T=s.category_tags||[];s.forms.forEach(h=>{var t,p,b,G,w,x,N,$,f,I;let _=h.physical_form||{},u=h.display_name||h.text||h.name||(q&&h.physical_form_name?`${q}, ${h.physical_form_name}`:s.display_name||s.text||s.name||"");d.push({id:h.id,text:u,item_type:h.item_type||s.item_type,default_unit:h.default_unit||h.unit||s.default_unit||s.unit||null,source:"global",global_item_id:h.id,ingredient_id:h.ingredient_id||s.ingredient&&s.ingredient.id||s.ingredient_id||null,ingredient_name:h.ingredient_name||q,physical_form_id:h.physical_form_id||_&&_.id||null,physical_form_name:h.physical_form_name||_&&_.name||null,ingredient_category_name:E,category_tags:T,density:h.density||s.density||null,capacity:h.capacity||s.capacity||null,capacity_unit:h.capacity_unit||s.capacity_unit||null,container_material:h.container_material||s.container_material||null,container_type:h.container_type||s.container_type||null,container_style:h.container_style||s.container_style||null,container_color:h.container_color||s.container_color||null,default_is_perishable:(t=h.default_is_perishable)!=null?t:s.default_is_perishable,recommended_shelf_life_days:(p=h.recommended_shelf_life_days)!=null?p:s.recommended_shelf_life_days,saponification_value:(G=(b=h.saponification_value)!=null?b:s.saponification_value)!=null?G:null,iodine_value:(x=(w=h.iodine_value)!=null?w:s.iodine_value)!=null?x:null,fatty_acid_profile:($=(N=h.fatty_acid_profile)!=null?N:s.fatty_acid_profile)!=null?$:null,melting_point_c:(I=(f=h.melting_point_c)!=null?f:s.melting_point_c)!=null?I:null})})}else if(s){let q=s.display_name||s.text||s.name||"",E=s.ingredient&&s.ingredient.ingredient_category_name||s.ingredient_category_name||s.ingredient_category&&s.ingredient_category.name||null;d.push({id:s.id,text:q,source:"global",item_type:s.item_type,global_item_id:s.id,ingredient_name:s.ingredient&&s.ingredient.name||s.ingredient_name||s.name,ingredient_category_name:E,category_tags:s.category_tags||[],physical_form_name:s.physical_form&&s.physical_form.name||s.physical_form_name||null,default_unit:s.default_unit||s.unit||null,density:s.density||null,capacity:s.capacity||null,capacity_unit:s.capacity_unit||null,container_material:s.container_material||null,container_type:s.container_type||null,container_style:s.container_style||null,container_color:s.container_color||null,default_is_perishable:s.default_is_perishable,recommended_shelf_life_days:s.recommended_shelf_life_days,saponification_value:s.saponification_value||null,iodine_value:s.iodine_value||null,fatty_acid_profile:s.fatty_acid_profile||null,melting_point_c:s.melting_point_c||null})}}),d}function l(r){let d=new Map;return(r||[]).forEach(s=>{let q=s.ingredient_name||s.text||s.name||"",E=s.ingredient_id?`id:${s.ingredient_id}`:`name:${K(q)}`,T=d.get(E)||{ingredient_id:s.ingredient_id||null,name:q,forms:[]};T.forms.push({id:s.id,text:s.text||q,ingredient_name:q,physical_form_name:s.physical_form_name||null,default_unit:s.default_unit||s.unit||null,source:"inventory",global_item_id:s.global_item_id||null}),d.set(E,T)}),Array.from(d.values())}function i(r,d){let s=[];return(r||[]).forEach(q=>{let E=(q.forms||[]).map(h=>({id:h.id,text:h.name||h.display_name||h.text,ingredient_name:h.ingredient_name||q.name||q.ingredient&&q.ingredient.name||"Ingredient",physical_form_name:h.physical_form_name||null,default_unit:h.default_unit||h.unit||null,source:"global",global_item_id:h.id,density:h.density||null,capacity:h.capacity||null,capacity_unit:h.capacity_unit||null,container_material:h.container_material||null,container_type:h.container_type||null,container_style:h.container_style||null,container_color:h.container_color||null,saponification_value:h.saponification_value||null,iodine_value:h.iodine_value||null,fatty_acid_profile:h.fatty_acid_profile||null,melting_point_c:h.melting_point_c||null})),T=d?E.filter(h=>!h.global_item_id||!d.has(String(h.global_item_id))):E;T.length&&s.push({ingredient_id:q.ingredient_id||q.id||null,name:q.name||q.ingredient&&q.ingredient.name||E[0]&&E[0].ingredient_name||"Ingredient",forms:T})}),s}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(s=>s.json()).catch(()=>({results:[]}))}function o(r){let d={...y,...r},s=d.inputEl,q=d.invHiddenEl,E=d.giHiddenEl,T=U(d.listEl),h=d.mode||"recipe",_=d.searchType||"ingredient",u=d.includeInventory,t=d.includeGlobal,p=d.ingredientFirst,b=d.displayVariant,G=typeof d.resultFilter=="function"?d.resultFilter:null,w=typeof d.onSelection=="function"?d.onSelection:null,x=d.globalUrlBuilder;if(!s||!q&&h==="recipe"||!E&&d.requireHidden!==!1)return;T&&!T.classList.contains("list-group")&&T.classList.add("list-group"),!T.parentNode&&s.parentNode&&s.parentNode.appendChild(T);function N(v,S){let L=new URLSearchParams({q:v});return S&&S!=="all"&&L.set("type",S),`/inventory/api/search?${L.toString()}`}function $(v,S,L){if(typeof x=="function")return x(v,S,L);let M=new URLSearchParams({q:v});return S&&S!=="all"&&M.set("type",S),S==="ingredient"&&L&&M.set("group","ingredient"),`${h==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${M.toString()}`}let f=A(function(){let v=(s.value||"").trim();if(!v){T.classList.add("d-none"),T.innerHTML="",q&&(q.value=""),E&&(E.value="");return}let S=(R(_)||"ingredient").toLowerCase(),L=R(u),M=R(t),D=S==="ingredient"&&!!R(p),Q=b||(D?"grouped":"compact");if(S==="ingredient_definition"||S==="definition"){a(v).then(F=>{let Y=F&&F.results||[];P(T,Y.map(z=>({id:z.id,text:z.name,name:z.name,inci_name:z.inci_name,slug:z.slug,ingredient_category_id:z.ingredient_category_id,ingredient_category_name:z.ingredient_category_name})),I)}).catch(()=>T.classList.add("d-none"));return}let j=L!==!1?fetch(N(v,S)).then(F=>F.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),W=M!==!1?fetch($(v,S,D)).then(F=>F.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([j,W]).then(F=>{let Y=F[0]&&F[0].results||[],z=F[1]&&F[1].results||[],X=G?Y.filter(ee=>G(ee,"inventory")):Y,te=G?z.filter(ee=>G(ee,"global")):z,ie=m(X),le=n(te).filter(ee=>!ee.global_item_id||!ie.has(String(ee.global_item_id))).filter(ee=>G?G(ee,"global"):!0);if(D){let ee=l(X),re=i(te,ie),ue=[];ee.length&&ue.push({title:"Your Inventory",source:"inventory",ingredients:ee}),re.length&&ue.push({title:"Global Library",source:"global",ingredients:re}),g(T,ue,I);return}let ae=[];X.length&&ae.push({title:"Your Inventory",source:"inventory",items:X}),le.length&&ae.push({title:"Global Library",source:"global",items:le}),O(T,ae,I,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:Q==="detailed"})}).catch(()=>{T.classList.add("d-none")})},200);function I(v,S){s.value=v.text||v.display_name||v.name||"",S==="inventory"?(q&&(q.value=v.id_numeric||v.id||""),E&&(E.value=v.global_item_id||"")):(E&&(E.value=v.global_item_id||v.id||""),q&&(q.value="")),typeof w=="function"&&w(v,S)}s.addEventListener("input",function(){q&&(q.value=""),E&&(E.value=""),f()}),document.addEventListener("click",function(v){!T.contains(v.target)&&!s.contains(v.target)&&T.classList.add("d-none")})}B.attachMergedInventoryGlobalTypeahead=o,B.renderInventoryTypeaheadList=O})(window);(function(B){"use strict";function e(c,y){var A=y&&y.context||"public",K=y&&y.unitOptionsHtml||"",U=y&&y.mode||(A==="public"?"public":"recipe"),R=document.createElement("div");R.className="row g-2 align-items-end mb-2",R.innerHTML=['<div class="col-md-6">','  <label class="form-label">',c==="container"?"Container":c==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',K,"  </select>","</div>",'<div class="col-md-3 ',c!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var m=R.querySelector(".tool-typeahead"),C=R.querySelector(".tool-gi-id"),O=R.querySelector('[data-role="suggestions"]');if(typeof B.attachMergedInventoryGlobalTypeahead=="function"){let g=c==="container"?"container":c==="consumable"?"consumable":"ingredient",P=A!=="public";B.attachMergedInventoryGlobalTypeahead({inputEl:m,giHiddenEl:C,listEl:O,mode:U,context:A,ingredientFirst:c==="ingredient",searchType:g,includeInventory:P,includeGlobal:!0})}return R.querySelector(".tool-remove").addEventListener("click",function(){R.remove()}),R}B.buildToolLineRow=e})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};e.config={unitOptionsHtml:B.soapToolConfig&&B.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(B.SOAP_CALC_LIMIT)?B.SOAP_CALC_LIMIT:null,calcTier:B.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(B.soapToolConfig&&B.soapToolConfig.useCsvPrimary),isAuthenticated:B.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:c,toNumber:y,clamp:A,formatTime:K,getStorage:U,buildSoapcalcSearchBuilder:R};function c(m,C=3){if(!isFinite(m))return 0;let O=Math.pow(10,C);return Math.round(m*O)/O}function y(m){let C=m;typeof C=="string"&&(C=C.replace(/,/g,"").trim());let O=parseFloat(C);return isFinite(O)?O:0}function A(m,C,O){return!isFinite(m)||m<C?C:O!=null&&m>O?O:m}function K(m){return m?`Saved ${new Date(m).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function U(){try{return B.localStorage}catch{return null}}function R(){let m=(O,g,P)=>{let n=new URLSearchParams({q:O});return g&&g!=="all"&&n.set("type",g),g==="ingredient"&&P&&n.set("group","ingredient"),`/api/public/global-items/search?${n.toString()}`},C=(O,g,P)=>{let n=new URLSearchParams({q:O});return P&&n.set("group","ingredient"),`/api/public/soapcalc-items/search?${n.toString()}`};return e.config.useCsvPrimary===!0?C:m}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},y={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},A={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},K=[41,70],U=100,R=[136,170],m=250,C={hardness:(c.hardness[0]+c.hardness[1])/2,cleansing:(c.cleansing[0]+c.cleansing[1])/2,conditioning:(c.conditioning[0]+c.conditioning[1])/2,bubbly:(c.bubbly[0]+c.bubbly[1])/2,creamy:(c.creamy[0]+c.creamy[1])/2},O={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},g={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},P=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],n=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],l={g:1,oz:28.3495,lb:453.592},i=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),o=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),s=new Set(["Salts & Minerals"]),q=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:c,QUALITY_HINTS:y,QUALITY_FEEL_HINTS:A,IODINE_RANGE:K,IODINE_SCALE_MAX:U,INS_RANGE:R,INS_SCALE_MAX:m,QUALITY_BASE:C,QUALITY_PRESETS:O,FATTY_BAR_COLORS:g,FATTY_DISPLAY_KEYS:P,OIL_TIP_RULES:n,UNIT_FACTORS:l,STAGE_CONFIGS:i,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:o,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:s,CITRIC_CATEGORY_SET:q}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:c}=e.helpers;function y(R){let m=0,C=0;return R.forEach(O=>{O.iodine>0&&(m+=O.grams,C+=O.iodine*O.grams)}),{iodine:m>0?C/m:0,coverageWeight:m}}function A(R){let m={},C=0;R.forEach(g=>{!g.fattyProfile||typeof g.fattyProfile!="object"||(C+=g.grams,Object.entries(g.fattyProfile).forEach(([P,n])=>{let l=c(n);l>0&&(m[P]=(m[P]||0)+g.grams*(l/100))}))});let O={};return C>0&&Object.entries(m).forEach(([g,P])=>{O[g]=P/C*100}),{percent:O,coveredWeight:C}}function K(R){let m=C=>R[C]||0;return{hardness:m("lauric")+m("myristic")+m("palmitic")+m("stearic"),cleansing:m("lauric")+m("myristic"),conditioning:m("oleic")+m("linoleic")+m("linolenic")+m("ricinoleic"),bubbly:m("lauric")+m("myristic")+m("ricinoleic"),creamy:m("palmitic")+m("stearic")+m("ricinoleic")}}function U(R){if(!R||typeof R!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let m={lauric:c(R.lauric),myristic:c(R.myristic),palmitic:c(R.palmitic),stearic:c(R.stearic),ricinoleic:c(R.ricinoleic),oleic:c(R.oleic),linoleic:c(R.linoleic),linolenic:c(R.linolenic)},C=K(m);return{hardness:(C.hardness||0)/100,cleansing:(C.cleansing||0)/100,conditioning:(C.conditioning||0)/100,bubbly:(C.bubbly||0)/100,creamy:(C.creamy||0)/100}}e.calc={computeIodine:y,computeFattyAcids:A,computeQualities:K,computeOilQualityScores:U},B.SoapCalcService=e.calc})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y,clamp:A}=e.helpers,{UNIT_FACTORS:K}=e.constants,U=e.state;function R(n){return A(y(n),0)*(K[U.currentUnit]||1)}function m(n){return A(n,0)/(K[U.currentUnit]||1)}function C(n){return!isFinite(n)||n<=0?"--":`${c(m(n),2)} ${U.currentUnit}`}function O(n){return isFinite(n)?`${c(n,1)}%`:"--"}function g(){document.querySelectorAll(".unit-label").forEach(n=>{n.textContent=U.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(n=>{n.dataset.suffix=U.currentUnit})}function P(n,l={}){if(!n)return;if(n===U.currentUnit){g();return}let i=U.currentUnit;if(U.currentUnit=n,g(),l.skipConvert)return;let a=(K[i]||1)/(K[n]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let s=y(d.value);s>0&&(d.value=c(s*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let s=y(d.value);s>0&&(d.value=c(s*a,2))});let o=document.getElementById("oilTotalTarget");if(o&&o.value){let d=y(o.value);d>0&&(o.value=c(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=y(r.value);d>0&&(r.value=c(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),l.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:R,fromGrams:m,formatWeight:C,formatPercent:O,updateUnitLabels:g,setUnit:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.state,y={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function A(i){i&&(i.classList.remove("soap-number-pulse"),i.offsetWidth,i.classList.add("soap-number-pulse"))}function K(i){var o;let a=document.getElementById(i);return!a||!((o=B.bootstrap)!=null&&o.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function U(){let i=Date.now();if(i-c.lastSaveToastAt<3500)return;c.lastSaveToastAt=i;let a=K("soapAutosaveToast");a&&a.show()}function R(i){let a=document.getElementById("soapUndoToast");if(!a)return;let o=a.querySelector(".toast-body");o&&(o.textContent=i||"Oil removed.");let r=K("soapUndoToast");r&&r.show()}function m(){let i=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");i&&i.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function C(i){let a=document.getElementById("lyeConcentrationWarning"),o=document.getElementById("waterRatioWarning");if(a){let r=(i==null?void 0:i.lyeConcentration)||0,d="";r>40&&(d="High concentration"),r>0&&r<25&&(d="Low concentration"),a.textContent=d,a.classList.toggle("d-none",!d)}if(o){let r=(i==null?void 0:i.waterRatio)||0,d="";r>0&&r<1.8&&(d="Low water"),r>2.7&&(d="High water"),o.textContent=d,o.classList.toggle("d-none",!d)}}function O(){document.querySelectorAll("#soapToolPage .form-text").forEach(i=>{let a=i.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function g(i){if(!i||i.type!=="number")return;let a=i.value;if(a===""){i.classList.remove("is-invalid");return}let o=parseFloat(a),r=i.getAttribute("min"),d=i.getAttribute("max"),s=r!==null&&r!==""&&o<parseFloat(r),q=d!==null&&d!==""&&o>parseFloat(d);i.classList.toggle("is-invalid",!isFinite(o)||s||q)}function P(i){var o;if(!i)return;let a=((o=i.querySelector)==null?void 0:o.call(i,".soap-stage-card"))||i;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function n(i,a,o={}){var q;let r=document.getElementById("soapAlertStack");if(!r)return;let d=y[i]||y.info,s=document.createElement("div");s.className=`alert alert-${i} d-flex align-items-start gap-2`,s.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${o.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,o.dismissible&&((q=s.querySelector('[data-role="dismiss"]'))==null||q.addEventListener("click",()=>s.remove())),r.prepend(s),o.persist||setTimeout(()=>{s.parentNode&&s.remove()},o.timeoutMs||4500)}function l(){let i=document.getElementById("soapAlertStack");i&&i.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:A,getToastInstance:K,showAutosaveToast:U,showUndoToast:R,updateResultsMeta:m,updateResultsWarnings:C,applyHelperVisibility:O,validateNumericField:g,flashStage:P,showSoapAlert:n,clearSoapAlerts:l}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function c(){let A=document.getElementById("soapStagePane"),K=document.getElementById("soapQualityCard");if(!A||!K)return;if(!B.matchMedia("(min-width: 768px)").matches){A.classList.remove("is-height-synced"),A.style.removeProperty("--soap-stage-height");return}let R=K.offsetHeight;if(!R){A.classList.remove("is-height-synced"),A.style.removeProperty("--soap-stage-height");return}A.style.setProperty("--soap-stage-height",`${R}px`),A.classList.add("is-height-synced")}let y=()=>{B.requestAnimationFrame(c)};e.layout={syncStageHeight:c,scheduleStageHeightSync:y}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{clamp:c,toNumber:y,round:A}=e.helpers,{toGrams:K,fromGrams:U}=e.units;function R(){let n=g(),l=document.getElementById("oilTotalTarget"),i=document.getElementById("oilTargetHint");l&&n.effectiveCapacity>0&&K(l.value)<=0&&(l.value=n.targetOils>0?A(U(n.targetOils),2):""),i&&(n.effectiveCapacity>0?i.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":i.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let o="Target oils are capped to the mold size above.";n.shape==="cylinder"&&n.waterWeight>0&&(n.useCylinder?o=`Cylinder correction applied (${A(n.cylinderFactor*100,0)}% of capacity).`:o="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=o}m()}function m(n=null){var h;let l=document.getElementById("moldWetBatterWarning");if(!l)return;let i=()=>{l.classList.add("d-none"),l.textContent=""},a=g(),o=e.state||{},r=o.lastCalc||null,d=(h=e.oils)!=null&&h.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,s=y(r==null?void 0:r.totalOils),q=y(n);if((!isFinite(q)||q<=0)&&(q=y(r==null?void 0:r.batchYield)),n==null&&s>0&&d>0&&Math.abs(s-d)>.01){i();return}if(!isFinite(q)||q<=0||a.effectiveCapacity<=0){i();return}let E=q-a.effectiveCapacity;if(E<=.01){i();return}let T=o.currentUnit||"g";l.textContent=`Full wet batter is ${A(U(q),2)} ${T}, exceeding mold capacity ${A(U(a.effectiveCapacity),2)} ${T} by ${A(U(E),2)} ${T}. Reduce oils target/% of mold or lower water/additives.`,l.classList.remove("d-none")}function C(){let n=document.getElementById("oilTotalTarget"),l=g();return n&&(l.effectiveCapacity>0&&(n.value=l.targetOils>0?A(U(l.targetOils),2):""),R()),l}function O(){let n=document.getElementById("oilTotalTarget"),l=document.getElementById("moldOilPct");if(!n||!l){let o=g();return R(),o}let i=g();if(i.effectiveCapacity>0){let o=K(n.value),r=c(o,0,i.effectiveCapacity);o>i.effectiveCapacity+.01&&(n.value=A(U(r),2));let d=r>0?r/i.effectiveCapacity*100:0;l.value=r>0?A(d,2):""}let a=g();return R(),a}function g(){var s,q,E;let n=K(document.getElementById("moldWaterWeight").value),l=c(y(document.getElementById("moldOilPct").value),0,100),i=((s=document.getElementById("moldShape"))==null?void 0:s.value)||"loaf",a=!!((q=document.getElementById("moldCylinderCorrection"))!=null&&q.checked),o=c(y((E=document.getElementById("moldCylinderFactor"))==null?void 0:E.value),.5,1),r=n>0?n*(a?o:1):0,d=r>0?r*(l/100):0;return{waterWeight:n,oilPct:l,shape:i,useCylinder:a,cylinderFactor:o,effectiveCapacity:r,targetOils:d}}function P(){var i;let n=((i=document.getElementById("moldShape"))==null?void 0:i.value)||"loaf",l=document.getElementById("moldCylinderOptions");l&&l.classList.toggle("d-none",n!=="cylinder"),R()}e.mold={updateMoldSuggested:R,updateWetBatterWarning:m,syncTargetFromMold:C,syncMoldPctFromTarget:O,getMoldSettings:g,updateMoldShapeUI:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y,clamp:A,buildSoapcalcSearchBuilder:K}=e.helpers,{toGrams:U,fromGrams:R}=e.units,{OIL_CATEGORY_SET:m,OIL_TIP_RULES:C}=e.constants,{computeQualities:O}=e.calc,g=e.state;function P(f){let I=f.querySelector(".oil-typeahead"),v=f.querySelector(".oil-sap-koh"),S=f.querySelector(".oil-iodine"),L=f.querySelector(".oil-fatty"),M=f.querySelector(".oil-gi-id"),D=f.querySelector(".oil-default-unit"),Q=f.querySelector(".oil-category"),j=f.querySelector('[data-role="suggestions"]');if(!I||!j||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let W=K();B.attachMergedInventoryGlobalTypeahead({inputEl:I,listEl:j,mode:"public",giHiddenEl:M,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:W,searchType:"ingredient",resultFilter:(F,Y)=>N(F,m,Y),requireHidden:!1,onSelection:function(F){v&&(v.value=(F==null?void 0:F.saponification_value)||""),S&&(S.value=(F==null?void 0:F.iodine_value)||""),L&&(L.value=F!=null&&F.fatty_acid_profile?JSON.stringify(F.fatty_acid_profile):""),D&&(D.value=(F==null?void 0:F.default_unit)||""),Q&&(Q.value=(F==null?void 0:F.ingredient_category_name)||""),t(F),T(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),I.addEventListener("input",function(){this.value.trim()||(v&&(v.value=""),S&&(S.value=""),L&&(L.value=""),M&&(M.value=""),D&&(D.value=""),Q&&(Q.value=""),b())})}function n(){var v,S;let f=document.getElementById("oilRowTemplate"),I=(S=(v=f==null?void 0:f.content)==null?void 0:v.querySelector(".oil-row"))==null?void 0:S.cloneNode(!0);return I?(I.querySelectorAll("input").forEach(L=>{L.value=""}),I.querySelectorAll(".form-text").forEach(L=>{let M=L.closest('.soap-field-stack, [class*="col-"]');M&&M.classList.add("soap-field")}),P(I),I.querySelectorAll(".unit-suffix").forEach(L=>{L.dataset.suffix=g.currentUnit}),I):document.createElement("div")}function l(){let f=document.getElementById("oilTotalTarget"),I=U(f==null?void 0:f.value);if(I>0)return I;let v=e.mold.getMoldSettings();return v.targetOils>0?v.targetOils:0}function i(f){let I=[];return f.forEach(S=>{var D,Q;let L=U((D=S.querySelector(".oil-grams"))==null?void 0:D.value),M=A(y((Q=S.querySelector(".oil-percent"))==null?void 0:Q.value),0);L>0&&M>0&&I.push(L/(M/100))}),I.length?I.reduce((S,L)=>S+L,0)/I.length:0}function a(f,I){if(!f||!I||I<=0)return{allowedGrams:null,allowedPct:null};let v=Array.from(document.querySelectorAll("#oilRows .oil-row")),S=v.reduce((W,F)=>{var Y;return F===f?W:W+U((Y=F.querySelector(".oil-grams"))==null?void 0:Y.value)},0),L=v.reduce((W,F)=>{var Y;return F===f?W:W+A(y((Y=F.querySelector(".oil-percent"))==null?void 0:Y.value),0)},0),M=Math.max(0,100-L),D=Math.max(0,I-S),Q=I*M/100;return{allowedGrams:Math.max(0,Math.min(D,Q)),allowedPct:M}}function o(f,I,v){if(!f)return;let S=f.querySelector(`[data-role="oil-${I}-hint"]`);S&&(v?(S.textContent=v,S.classList.add("is-visible")):(S.textContent="",S.classList.remove("is-visible")))}function r(f){f&&(f.classList.remove("oil-input-bounce"),f.offsetWidth,f.classList.add("oil-input-bounce"))}function d(f,I,v={}){let S=l();if(!f||!S||S<=0){o(f,I,"");return}let L=f.querySelector(".oil-grams"),M=f.querySelector(".oil-percent"),D=a(f,S);if(I==="grams"&&L){let Q=U(L.value),j="";if(Q>S+.01?j="Entry exceeds the max oils allowed in stage 2.":D.allowedGrams!==null&&Q>D.allowedGrams+.01&&(j=`Must be under ${c(R(D.allowedGrams),2)} ${g.currentUnit} to stay within the stage 2 oil limit.`),j){let W=D.allowedGrams!==null?c(R(D.allowedGrams),2):c(R(S),2);L.value=W>0?W:"",o(f,I,j),L.classList.add("oil-input-warning"),r(L),T()}else L.classList.remove("oil-input-warning"),o(f,I,"")}if(I==="percent"&&M){let Q=A(y(M.value),0),j="";if(Q>100.01?j="Entry exceeds the max oils allowed in stage 2.":D.allowedPct!==null&&Q>D.allowedPct+.01&&(j=`Must be under ${c(D.allowedPct,2)}% to stay within the stage 2 oil limit.`),j){let W=D.allowedPct!==null?c(D.allowedPct,2):100;M.value=W>0?W:"",o(f,I,j),M.classList.add("oil-input-warning"),r(M),T()}else M.classList.remove("oil-input-warning"),o(f,I,"")}}function s(f,I={}){let v=Array.from(document.querySelectorAll("#oilRows .oil-row")),S=f!=null?f:l(),L=!!I.force;if(!S||S<=0||!v.length){g.lastOilTarget=S;return}let M=v.reduce((Q,j)=>{var W;return Q+A(y((W=j.querySelector(".oil-percent"))==null?void 0:W.value),0)},0),D=v.reduce((Q,j)=>{var W;return Q+U((W=j.querySelector(".oil-grams"))==null?void 0:W.value)},0);if(M<=0&&D<=0){g.lastOilTarget=S;return}if(!(!L&&g.lastOilTarget&&Math.abs(g.lastOilTarget-S)<.01)){if(M>0)v.forEach(Q=>{let j=Q.querySelector(".oil-percent"),W=Q.querySelector(".oil-grams"),F=A(y(j==null?void 0:j.value),0),Y=M>0?F/M:0;W&&(W.value=Y>0?c(R(S*Y),2):""),j&&(j.value=Y>0?c(Y*100,2):"")});else if(D>0){let Q=S/D;v.forEach(j=>{let W=j.querySelector(".oil-grams"),F=j.querySelector(".oil-percent"),Y=U(W==null?void 0:W.value);if(W){let z=Y>0?Y*Q:0;W.value=z>0?c(R(z),2):""}if(F){let z=U(W==null?void 0:W.value);F.value=z>0?c(z/S*100,2):""}})}g.lastOilTarget=S,T({skipEnforce:!0})}}function q(f,I){if(!g.lastOilEdit||!g.lastOilEdit.row)return!1;let v=g.lastOilEdit.row,S=f.reduce((Q,j)=>{var W;return j===v?Q:Q+U((W=j.querySelector(".oil-grams"))==null?void 0:W.value)},0),L=Math.max(0,I-S),M=v.querySelector(".oil-grams"),D=v.querySelector(".oil-percent");return!M||!D?!1:(M.value=L>0?c(R(L),2):"",D.value=L>0?c(L/I*100,2):"",g.wasCapped=!0,!0)}function E({totalWeight:f,totalPct:I,target:v,capped:S}){let L=document.getElementById("oilLimitWarning");if(!L)return;let M=[];if(S&&M.push("Oil total hit the mold cap and was adjusted."),v>0&&f>v+.01){let D=f-v;M.push(`Oil weights exceed the target by ${c(R(D),2)} ${g.currentUnit}.`)}I>100.01&&M.push(`Oil percentages are over 100% by ${c(I-100,2)}%.`),M.length?(L.classList.remove("d-none"),L.innerHTML=`${M.join(" ")} Adjust oils or mold % to continue.`):(L.classList.add("d-none"),L.textContent="")}function T(f={}){var Q;f.skipEnforce||(g.wasCapped=!1);let I=Array.from(document.querySelectorAll("#oilRows .oil-row")),v=e.mold.getMoldSettings(),S=l();if(!S&&!v.targetOils){let j=i(I);if(j>0){S=j;let W=document.getElementById("oilTotalTarget");W&&!W.value&&(W.value=c(R(j),2))}}let L=0,M=0;if(I.forEach(j=>{let W=j.querySelector(".oil-grams"),F=j.querySelector(".oil-percent"),Y=U(W==null?void 0:W.value),z=A(y(F==null?void 0:F.value),0);S>0&&(g.lastOilEdit&&g.lastOilEdit.row===j&&g.lastOilEdit.field==="percent"?(Y=z>0?S*(z/100):0,W.value=z>0?c(R(Y),2):""):Y>0?(z=Y/S*100,F.value=c(z,2)):z>0&&(Y=S*(z/100),W.value=c(R(Y),2)),M+=z),Y>0&&(L+=Y)}),S<=0&&(L>0?(M=0,I.forEach(j=>{let W=j.querySelector(".oil-grams"),F=j.querySelector(".oil-percent"),Y=U(W==null?void 0:W.value);if(Y>0){let z=Y/L*100;F.value=c(z,2),M+=z}})):M=I.reduce((j,W)=>{var F;return j+A(y((F=W.querySelector(".oil-percent"))==null?void 0:F.value),0)},0)),!f.skipEnforce&&v.targetOils>0&&L>v.targetOils+.01&&q(I,v.targetOils))return T({skipEnforce:!0});g.totalOilsGrams=L;let D=document.getElementById("oilTotalComputed");return D&&(D.textContent=L>0?`${c(R(L),2)} ${g.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=c(M,2),E({totalWeight:L,totalPct:M,target:S,capped:g.wasCapped}),e.additives.updateAdditivesOutput(L),(Q=e.fragrances)!=null&&Q.updateFragranceTotals&&e.fragrances.updateFragranceTotals(L),e.mold.updateMoldSuggested(),G(),{totalWeight:L,totalPct:M,target:S}}function h(){let f=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!f.length)return;let I=l(),v=f.reduce((S,L)=>{var M;return S+A(y((M=L.querySelector(".oil-percent"))==null?void 0:M.value),0)},0);!v&&I>0&&(v=f.reduce((S,L)=>{var D;let M=U((D=L.querySelector(".oil-grams"))==null?void 0:D.value);return S+(M>0?M/I*100:0)},0)),!(v<=0)&&(f.forEach(S=>{let L=S.querySelector(".oil-percent"),M=S.querySelector(".oil-grams"),Q=A(y(L.value),0)/v*100;L.value=c(Q,2),I>0&&(M.value=Q>0?c(R(I*(Q/100)),2):"")}),T())}function _(){let f=[];return document.querySelectorAll("#oilRows .oil-row").forEach(I=>{var Y,z,X,te,ie,le,ae,ee,re;let v=(z=(Y=I.querySelector(".oil-typeahead"))==null?void 0:Y.value)==null?void 0:z.trim(),S=U((X=I.querySelector(".oil-grams"))==null?void 0:X.value),L=y((te=I.querySelector(".oil-sap-koh"))==null?void 0:te.value),M=y((ie=I.querySelector(".oil-iodine"))==null?void 0:ie.value),D=((le=I.querySelector(".oil-fatty"))==null?void 0:le.value)||"",Q=((ae=I.querySelector(".oil-gi-id"))==null?void 0:ae.value)||"",j=((ee=I.querySelector(".oil-default-unit"))==null?void 0:ee.value)||"",W=((re=I.querySelector(".oil-category"))==null?void 0:re.value)||"",F=null;if(D)try{F=JSON.parse(D)}catch{F=null}S<=0||f.push({name:v||null,grams:S,sapKoh:L,iodine:M,fattyProfile:F,global_item_id:Q?parseInt(Q):null,default_unit:j||null,ingredient_category_name:W||null})}),f}function u({name:f,sapKoh:I,iodine:v,fattyProfile:S}={}){let L=document.getElementById("oilProfileFloat"),M=(z,X)=>{let te=document.getElementById(z);te&&(te.textContent=X)},D=f||"Pick an oil to preview";M("selectedOilName",D),M("selectedOilModalName",D),L&&L.classList.toggle("d-none",!f);let Q=I>0?c(I,1):"--",j=v>0?c(v,1):"--";M("selectedOilSap",Q),M("selectedOilModalSap",Q),M("selectedOilIodine",j),M("selectedOilModalIodine",j);let W=S?O(S):{},F=(z,X)=>{let te=isFinite(X)&&X>0?c(X,1):"--";M(z,te)};F("selectedOilHardness",W.hardness),F("selectedOilModalHardness",W.hardness),F("selectedOilCleansing",W.cleansing),F("selectedOilModalCleansing",W.cleansing),F("selectedOilConditioning",W.conditioning),F("selectedOilModalConditioning",W.conditioning),F("selectedOilBubbly",W.bubbly),F("selectedOilModalBubbly",W.bubbly),F("selectedOilCreamy",W.creamy),F("selectedOilModalCreamy",W.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(z=>{let X=`selectedOil${z.charAt(0).toUpperCase()}${z.slice(1)}`,te=`selectedOilModal${z.charAt(0).toUpperCase()}${z.slice(1)}`,ie=S?y(S[z]):0,le=ie>0?c(ie,1):"--";M(X,le),M(te,le)})}function t(f){if(!f){b();return}g.selectedOilProfile=f;let I=f.fatty_acid_profile||null;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=null}u({name:f.text||f.display_name||f.name,sapKoh:y(f.saponification_value),iodine:y(f.iodine_value),fattyProfile:I})}function p(f){var D,Q,j,W,F;if(!f)return;let I=(Q=(D=f.querySelector(".oil-typeahead"))==null?void 0:D.value)==null?void 0:Q.trim(),v=y((j=f.querySelector(".oil-sap-koh"))==null?void 0:j.value),S=y((W=f.querySelector(".oil-iodine"))==null?void 0:W.value),L=((F=f.querySelector(".oil-fatty"))==null?void 0:F.value)||"",M=null;if(L)try{M=JSON.parse(L)}catch{M=null}u({name:I,sapKoh:v,iodine:S,fattyProfile:M})}function b(){g.selectedOilProfile=null,g.lastPreviewRow=null,u()}function G(){let f=document.getElementById("oilBlendTips");if(!f)return;let I=_().filter(L=>L.grams>0||L.percent>0);if(!I.length){f.classList.add("d-none"),f.textContent="";return}let v=new Set;I.forEach(L=>{let M=(L.name||"").toLowerCase();if(M&&C.forEach(D=>{D.match.test(M)&&v.add(D.tip)}),L.fattyProfile&&typeof L.fattyProfile=="object"){let D=y(L.fattyProfile.lauric),Q=y(L.fattyProfile.myristic),j=y(L.fattyProfile.palmitic),W=y(L.fattyProfile.stearic),F=y(L.fattyProfile.ricinoleic),Y=y(L.fattyProfile.oleic),z=y(L.fattyProfile.linoleic),X=y(L.fattyProfile.linolenic);D+Q>=30&&v.add(`${L.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),j+W>=40&&v.add(`${L.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),Y>=60&&v.add(`${L.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),z+X>=20&&v.add(`${L.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),F>=60&&v.add(`${L.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let S=Array.from(v).slice(0,6);if(!S.length){f.classList.add("d-none"),f.textContent="";return}f.classList.remove("d-none"),f.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${S.map(L=>`<li>${L}</li>`).join("")}</ul>`}function w(){return g.totalOilsGrams||0}function x(f){var I,v,S,L,M,D,Q,j,W;return f?{name:((I=f.querySelector(".oil-typeahead"))==null?void 0:I.value)||"",grams:((v=f.querySelector(".oil-grams"))==null?void 0:v.value)||"",percent:((S=f.querySelector(".oil-percent"))==null?void 0:S.value)||"",sap:((L=f.querySelector(".oil-sap-koh"))==null?void 0:L.value)||"",iodine:((M=f.querySelector(".oil-iodine"))==null?void 0:M.value)||"",fattyRaw:((D=f.querySelector(".oil-fatty"))==null?void 0:D.value)||"",gi:((Q=f.querySelector(".oil-gi-id"))==null?void 0:Q.value)||"",defaultUnit:((j=f.querySelector(".oil-default-unit"))==null?void 0:j.value)||"",categoryName:((W=f.querySelector(".oil-category"))==null?void 0:W.value)||""}:null}function N(f,I,v){let S=$(f);return S?I.has(S):v==="inventory"}function $(f){return!f||typeof f!="object"?null:f.ingredient&&f.ingredient.ingredient_category_name||f.ingredient_category_name||f.ingredient_category&&f.ingredient_category.name||null}e.oils={attachOilTypeahead:P,buildOilRow:n,getOilTargetGrams:l,updateOilTotals:T,normalizeOils:h,collectOilData:_,setSelectedOilProfileFromRow:p,clearSelectedOilProfile:b,updateOilTips:G,getTotalOilsGrams:w,serializeOilRow:x,validateOilEntry:d,scaleOilsToTarget:s}})(window);(function(B){"use strict";var u;let e=B.SoapTool=B.SoapTool||{},c=e.bulkOils=e.bulkOils||{},{toNumber:y,clamp:A}=e.helpers,K=e.state,U=Array.isArray((u=e.constants)==null?void 0:u.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],R=new Set(["selected_pct","selected_weight_g"]),m=25,C=140,O=260,g={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function P(){var t,p;(p=(t=e.storage)==null?void 0:t.queueStateSave)==null||p.call(t)}function n(t,p){var b,G;(G=(b=e.ui)==null?void 0:b.showSoapAlert)==null||G.call(b,t,p,{dismissible:!0,timeoutMs:6e3})}function l(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function i(t){return t?t==="name"||R.has(t)?!0:U.includes(t):!1}function a(){(!K.bulkOilModal||typeof K.bulkOilModal!="object")&&(K.bulkOilModal=JSON.parse(JSON.stringify(g)));let t=K.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=i(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function o(t){let p={},b=t&&typeof t=="object"?t:{};return U.forEach(G=>{let w=y(b[G]);w>0&&(p[G]=w)}),p}function r(t){let p=o(t==null?void 0:t.fatty_profile),b=String((t==null?void 0:t.name)||"").trim(),G=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",w=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:y(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(w?`global:${w}`:`${G}:${b.toLowerCase()}`)),name:b,sap_koh:y(t==null?void 0:t.sap_koh),iodine:y(t==null?void 0:t.iodine),fatty_profile:p,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:w,source:G,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=l(),p=a(),b=Object.keys(p.selection||{}).length,G=`Selected: ${b}`;t.summaryEl&&(t.summaryEl.textContent=G),t.stageCountEl&&(t.stageCountEl.textContent=String(b))}function s(t){var b;return((b=a().selection)==null?void 0:b[t])||null}function q(t,p={}){var x,N;let b=a();if(!t||!t.key)return null;let G=b.selection[t.key]||{},w={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:A(y((x=p.selected_pct)!=null?x:G.selected_pct),0,100),selected_weight_g:A(y((N=p.selected_weight_g)!=null?N:G.selected_weight_g),0)};return b.selection[t.key]=w,w}function E(t){var b;let p=a();(b=p.selection)!=null&&b[t]&&delete p.selection[t]}function T(t){var b;return((b=a().recordByKey)==null?void 0:b[t])||null}function h(){let t=a();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(p=>({key:p.key,name:p.name,sap_koh:p.sap_koh,iodine:p.iodine,fatty_profile:p.fatty_profile||{},default_unit:p.default_unit,ingredient_category_name:p.ingredient_category_name,global_item_id:p.global_item_id,source:p.source,is_basic:!!p.is_basic,selected_pct:A(y(p.selected_pct),0,100),selected_weight_g:A(y(p.selected_weight_g),0)}))}}function _(t){let p=a();p.mode="all",p.viewSelected=!!(t!=null&&t.view_selected),p.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",p.sortKey=i(t==null?void 0:t.sort_key)?t.sort_key:"name",p.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let b={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(w=>{let x=String((w==null?void 0:w.key)||"").trim(),N=String((w==null?void 0:w.name)||"").trim();!x||!N||(b[x]={key:x,name:N,sap_koh:y(w==null?void 0:w.sap_koh),iodine:y(w==null?void 0:w.iodine),fatty_profile:o(w==null?void 0:w.fatty_profile),default_unit:String((w==null?void 0:w.default_unit)||"gram"),ingredient_category_name:String((w==null?void 0:w.ingredient_category_name)||""),global_item_id:y(w==null?void 0:w.global_item_id)>0?parseInt(w.global_item_id,10):null,source:String((w==null?void 0:w.source)||"soapcalc"),is_basic:!!(w!=null&&w.is_basic),selected_pct:A(y(w==null?void 0:w.selected_pct),0,100),selected_weight_g:A(y(w==null?void 0:w.selected_weight_g),0)})}),p.selection=b,p.visibleRecords=[],p.offset=0,p.totalCount=0,p.hasMore=!0,p.loading=!1,d()}c.shared={FATTY_KEYS:U,LOCAL_SORT_KEYS:R,PAGE_SIZE:m,SCROLL_FETCH_THRESHOLD:C,SEARCH_DEBOUNCE_MS:O,queueStateSave:P,showAlert:n,getRefs:l,ensureModalState:a,normalizeFattyProfile:o,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:s,setSelection:q,removeSelection:E,getRecordByKey:T,serializeSelection:h,restoreState:_}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.bulkOils=e.bulkOils||{},y=c.shared;if(!y)return;let{round:A,toNumber:K}=e.helpers,{fromGrams:U}=e.units,{FATTY_KEYS:R,LOCAL_SORT_KEYS:m,getRefs:C,ensureModalState:O,selectionForRecordKey:g,updateSelectionCounters:P}=y;function n(u){let t=C();t.statusEl&&(t.statusEl.textContent=u)}function l(){let u=O();if(u.loading&&!u.visibleRecords.length){n("Loading oils...");return}if(!u.visibleRecords.length){let w=u.query?"No oils match that search.":"No oils available.";n(w);return}let t=u.visibleRecords.length,p=u.totalCount,b=u.hasMore?" \u2022 scroll for more":"",G=u.query?` \u2022 search: "${u.query}"`:"";n(`Showing ${t} of ${p} oils${G}${b}`)}function i(u,t,p){if(typeof u=="string"||typeof t=="string"){let w=String(u||"").toLowerCase(),x=String(t||"").toLowerCase();return w<x?p==="asc"?-1:1:w>x?p==="asc"?1:-1:0}let b=K(u),G=K(t);return b<G?p==="asc"?-1:1:b>G?p==="asc"?1:-1:0}function a(u,t){var p,b;return t==="selected_pct"?((p=g(u.key))==null?void 0:p.selected_pct)||0:t==="selected_weight_g"?((b=g(u.key))==null?void 0:b.selected_weight_g)||0:""}function o(){let u=O();m.has(u.sortKey)&&u.visibleRecords.sort((t,p)=>{let b=i(a(t,u.sortKey),a(p,u.sortKey),u.sortDir);return b!==0?b:i(t.name||"",p.name||"","asc")})}function r(){let u=O();if(!u.viewSelected)return;let t=[],p=[];u.visibleRecords.forEach(b=>{g(b.key)?t.push(b):p.push(b)}),u.visibleRecords=t.concat(p)}function d(){o(),r()}function s(u){let t=String(u||"").trim().toLowerCase();return t==="name"||R.includes(t)?t:"name"}function q(){let u=O();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[▲▼]\s*$/,"").trim());let p=t.dataset.label||"",b=t.dataset.sortKey||"";u.sortKey===b?t.textContent=`${p} ${u.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=p})}function E(u,t){let p=g(t.key),b=u.querySelector(".bulk-oil-check"),G=u.querySelector(".bulk-oil-pct"),w=u.querySelector(".bulk-oil-weight");b&&(b.checked=!!p),G&&(G.value=p&&p.selected_pct>0?A(p.selected_pct,2):""),w&&(w.value=p&&p.selected_weight_g>0?A(U(p.selected_weight_g),2):"")}function T(u){let t=document.createElement("td");t.className="bulk-oil-acid";let p=K(u);return t.textContent=p>0?A(p,1).toString():"--",t}function h(u){let t=document.createElement("tr");t.dataset.recordKey=u.key;let p=document.createElement("td");p.className="text-center";let b=document.createElement("input");b.type="checkbox",b.className="form-check-input bulk-oil-check",p.appendChild(b),t.appendChild(p);let G=document.createElement("td");G.className="bulk-oil-name";let w=document.createElement("div");w.className="fw-semibold small",w.textContent=u.name;let x=document.createElement("div");x.className="text-muted small";let N=u.ingredient_category_name?` \xB7 ${u.ingredient_category_name}`:"";x.textContent=`${u.source}${N}`,G.appendChild(w),G.appendChild(x),t.appendChild(G),R.forEach(S=>{var L;t.appendChild(T((L=u.fatty_profile)==null?void 0:L[S]))});let $=document.createElement("td"),f=document.createElement("input");f.type="number",f.min="0",f.max="100",f.step="0.1",f.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",$.appendChild(f),t.appendChild($);let I=document.createElement("td"),v=document.createElement("input");return v.type="number",v.min="0",v.step="0.1",v.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",I.appendChild(v),t.appendChild(I),E(t,u),t}function _(){let u=C(),t=O();if(!u.bodyEl)return;u.bodyEl.innerHTML="";let p=document.createDocumentFragment();t.visibleRecords.forEach(b=>{p.appendChild(h(b))}),u.bodyEl.appendChild(p),q(),P(),l()}c.render={updateStatusText:n,refreshCatalogStatus:l,applyLocalSelectionSortIfNeeded:o,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:s,sortButtonsLabel:q,renderVisibleRecords:_}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.bulkOils=e.bulkOils||{},y=c.shared,A=c.render;if(!y||!A)return;let{PAGE_SIZE:K,getRefs:U,ensureModalState:R,normalizeCatalogRecord:m}=y,{refreshCatalogStatus:C,normalizeServerSortKey:O,applyClientOrdering:g,renderVisibleRecords:P,updateStatusText:n}=A;function l(){let a=R(),o=U();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,o.bodyEl&&(o.bodyEl.innerHTML=""),o.scrollEl&&(o.scrollEl.scrollTop=0)}async function i({reset:a=!1}={}){let o=R();if(!U().modalEl||o.loading&&!a||!o.hasMore&&!a)return;a&&l();let d=o.requestToken+1;o.requestToken=d,o.loading=!0,C();let s=new URLSearchParams;s.set("mode",o.mode),s.set("offset",String(o.offset)),s.set("limit",String(K)),s.set("q",o.query||""),s.set("sort_key",O(o.sortKey)),s.set("sort_dir",o.sortDir==="desc"?"desc":"asc");try{let q=await fetch(`/tools/api/soap/oils-catalog?${s.toString()}`);if(!q.ok)throw new Error("Unable to load oils catalog");let E=await q.json();if(!E||E.success!==!0||!E.result||!Array.isArray(E.result.records))throw new Error("Invalid oils catalog response");if(d!==o.requestToken)return;let T=E.result.records.map(m),h=Math.max(0,parseInt(E.result.next_offset,10)||o.offset+T.length),_=Math.max(T.length,parseInt(E.result.count,10)||0),u=!!E.result.has_more;T.forEach(t=>{o.recordByKey[t.key]=t}),o.visibleRecords=a?T.slice():o.visibleRecords.concat(T),o.offset=h,o.totalCount=_,o.hasMore=u,g(),P()}catch(q){throw d===o.requestToken&&n("Unable to load oils catalog."),q}finally{d===o.requestToken&&(o.loading=!1,C())}}c.api={fetchCatalogPage:i}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.bulkOils=e.bulkOils||{},y=c.shared,A=c.render,K=c.api;if(!y||!A||!K)return;let{round:U,toNumber:R,clamp:m}=e.helpers,{toGrams:C,fromGrams:O}=e.units,g=e.state,{LOCAL_SORT_KEYS:P,SCROLL_FETCH_THRESHOLD:n,SEARCH_DEBOUNCE_MS:l,queueStateSave:i,showAlert:a,getRefs:o,ensureModalState:r,updateSelectionCounters:d,setSelection:s,removeSelection:q,getRecordByKey:E,serializeSelection:T,restoreState:h}=y,{applyClientOrdering:_,sortButtonsLabel:u,renderVisibleRecords:t}=A,{fetchCatalogPage:p}=K,b=null,G=null;function w(){var H;let k=o();k.modalEl&&(!b&&((H=B.bootstrap)!=null&&H.Modal)&&(b=B.bootstrap.Modal.getOrCreateInstance(k.modalEl)),b&&b.hide())}function x(){return document.getElementById("oilRows")}function N(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function $(k){return String(k||"").trim().toLowerCase()}function f(k){var H;return $((H=k==null?void 0:k.querySelector(".oil-typeahead"))==null?void 0:H.value)}function I(k){var V;let H=String(((V=k==null?void 0:k.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return H||""}function v(k,H){let V=String(k||"").trim();if(!V)return null;let J=N(),Z=J.find(oe=>String(oe.dataset.bulkOilKey||"")===V);if(Z)return Z;let ne=String((H==null?void 0:H.global_item_id)||"").trim();if(ne&&(Z=J.find(oe=>I(oe)===ne),Z))return Z;let se=$(H==null?void 0:H.name);return se&&(Z=J.find(oe=>f(oe)===se),Z)?Z:null}function S(k,H){if(!k||!H)return;k.dataset.bulkOilKey=H.key||"";let V=k.querySelector(".oil-typeahead"),J=k.querySelector(".oil-sap-koh"),Z=k.querySelector(".oil-iodine"),ne=k.querySelector(".oil-fatty"),se=k.querySelector(".oil-gi-id"),oe=k.querySelector(".oil-default-unit"),ce=k.querySelector(".oil-category"),ge=k.querySelector(".oil-grams"),me=k.querySelector(".oil-percent");V&&(V.value=H.name||""),J&&(J.value=H.sap_koh>0?U(H.sap_koh,3):""),Z&&(Z.value=H.iodine>0?U(H.iodine,3):""),ne&&(ne.value=H.fatty_profile&&Object.keys(H.fatty_profile).length?JSON.stringify(H.fatty_profile):""),se&&(se.value=H.global_item_id||""),oe&&(oe.value=H.default_unit||""),ce&&(ce.value=H.ingredient_category_name||""),me&&(me.value=H.selected_pct>0?U(H.selected_pct,2):""),ge&&(ge.value=H.selected_weight_g>0?U(O(H.selected_weight_g),2):"")}function L(k){if(!k||!k.key)return null;let H=v(k.key,k),V=x();return!H&&V&&(H=e.oils.buildOilRow(),H&&V.appendChild(H)),S(H,k),H}function M(k,H){let V=v(k,H);V&&(g.lastOilEdit&&g.lastOilEdit.row===V&&(g.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function D(){N().forEach(H=>{g.lastOilEdit&&g.lastOilEdit.row===H&&(g.lastOilEdit=null),H.remove()}),e.oils.clearSelectedOilProfile()}function Q(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function j(k,H,V){let J=String(V||"").trim();if(J)return J;let Z=String(H||"").trim();if(Z)return`global:${Z}`;let ne=$(k);return ne?`soapcalc:${ne}`:""}function W(){let k={};return N().forEach(H=>{var he,ve,Se,_e,be,Ee,Ie,Ce,Te;let V=String(((he=H.querySelector(".oil-typeahead"))==null?void 0:he.value)||"").trim(),J=R((ve=H.querySelector(".oil-sap-koh"))==null?void 0:ve.value),Z=R((Se=H.querySelector(".oil-iodine"))==null?void 0:Se.value),ne=String(((_e=H.querySelector(".oil-gi-id"))==null?void 0:_e.value)||"").trim(),se=String(((be=H.querySelector(".oil-default-unit"))==null?void 0:be.value)||"gram"),oe=String(((Ee=H.querySelector(".oil-category"))==null?void 0:Ee.value)||""),ce=m(R((Ie=H.querySelector(".oil-percent"))==null?void 0:Ie.value),0,100),ge=m(C((Ce=H.querySelector(".oil-grams"))==null?void 0:Ce.value),0),me=String(((Te=H.querySelector(".oil-fatty"))==null?void 0:Te.value)||""),pe={};if(me)try{let qe=JSON.parse(me);pe=y.normalizeFattyProfile(qe)}catch{pe={}}let ye=j(V,ne,H.dataset.bulkOilKey);!ye||!(V||ce>0||ge>0||J>0||Z>0||Object.keys(pe).length>0)||(H.dataset.bulkOilKey=ye,k[ye]={key:ye,name:V||"Unnamed oil",sap_koh:J,iodine:Z,fatty_profile:pe,default_unit:se||"gram",ingredient_category_name:oe,global_item_id:ne?parseInt(ne,10):null,source:ne?"global":"soapcalc",is_basic:!ne,selected_pct:ce,selected_weight_g:ge})}),k}function F(){let k=r();k.selection=W(),d()}function Y(){let k=r(),H=Object.values(k.selection||{}),V=new Set(H.map(J=>J.key));N().forEach(J=>{let Z=String(J.dataset.bulkOilKey||"").trim();(!Z||!V.has(Z))&&J.remove()}),H.slice().sort((J,Z)=>String(J.name||"").localeCompare(String(Z.name||""))).forEach(J=>{L(J)}),Q()}async function z(){var V;let k=o(),H=r();if(k.modalEl){F(),!b&&((V=B.bootstrap)!=null&&V.Modal)&&(b=B.bootstrap.Modal.getOrCreateInstance(k.modalEl)),k.searchInput&&(k.searchInput.value=H.query||""),k.viewSelectedToggle&&(k.viewSelectedToggle.checked=!!H.viewSelected),k.unitLabelEl&&(k.unitLabelEl.textContent=g.currentUnit||"g"),b&&b.show(),u(),d();try{await p({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function X(k){let H=k.target;if(!(H instanceof HTMLElement))return;let V=H.closest("tr[data-record-key]");if(!V)return;let J=V.dataset.recordKey||"",Z=E(J);if(!Z)return;let ne=V.querySelector(".bulk-oil-check"),se=V.querySelector(".bulk-oil-pct"),oe=V.querySelector(".bulk-oil-weight"),ce=m(R(se==null?void 0:se.value),0,100),ge=m(C(oe==null?void 0:oe.value),0),me=ce>0||ge>0;if(!!(ne!=null&&ne.checked)||me){ne&&(ne.checked=!0);let he=s(Z,{selected_pct:ce,selected_weight_g:ge});L(he)}else q(J),M(J,Z);let ye=r();P.has(ye.sortKey)||ye.viewSelected?(_(),t()):d(),Q(),i()}function te(k){let H=r();H.viewSelected=!!k,_(),t(),i()}async function ie(k){let H=k.target instanceof HTMLElement?k.target.closest(".bulk-oil-sort"):null;if(!H)return;let V=H.getAttribute("data-sort-key")||"name",J=r();if(J.sortKey===V?J.sortDir=J.sortDir==="asc"?"desc":"asc":(J.sortKey=V,J.sortDir=V==="name"?"asc":"desc"),i(),P.has(J.sortKey)){_(),t();return}try{await p({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function le(){let k=r();k.selection={},D(),(P.has(k.sortKey)||k.viewSelected)&&_(),t(),Q(),i()}async function ae(){let k=o(),H=r();if(!(!k.scrollEl||H.loading||!H.hasMore||!(k.scrollEl.scrollTop+k.scrollEl.clientHeight>=k.scrollEl.scrollHeight-n)))try{await p({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ee(){G&&B.clearTimeout(G),G=B.setTimeout(async()=>{try{await p({reset:!0})}catch{a("danger","Unable to search oils right now.")}},l)}function re(){Y(),i(),w()}function ue(k,H){if(!(k instanceof HTMLInputElement))return!1;let J=o().bodyEl;if(!(J instanceof HTMLElement))return!1;let Z=k.classList.contains("bulk-oil-pct")?"bulk-oil-pct":k.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!Z)return!1;let ne=Array.from(J.querySelectorAll(`input.${Z}`)),se=ne.indexOf(k);if(se<0)return!1;let oe=se+H;if(oe<0||oe>=ne.length)return!1;let ce=ne[oe];return ce instanceof HTMLInputElement?(ce.focus(),typeof ce.select=="function"&&ce.select(),!0):!1}function fe(){var H;let k=o();k.unitLabelEl&&(k.unitLabelEl.textContent=g.currentUnit||"g"),(H=k.modalEl)!=null&&H.classList.contains("show")&&t()}function de(){let k=o();k.modalEl&&(k.openBtn&&k.openBtn.addEventListener("click",()=>{z()}),k.searchInput&&k.searchInput.addEventListener("input",()=>{let H=r();H.query=k.searchInput.value||"",i(),ee()}),k.viewSelectedToggle&&k.viewSelectedToggle.addEventListener("change",()=>{te(!!k.viewSelectedToggle.checked)}),k.scrollEl&&k.scrollEl.addEventListener("scroll",ae),k.bodyEl&&(k.bodyEl.addEventListener("change",X),k.bodyEl.addEventListener("keydown",H=>{let V=H.target;if(!(!(V instanceof HTMLInputElement)||!(V.classList.contains("bulk-oil-pct")||V.classList.contains("bulk-oil-weight")))){if(H.key==="Enter"){H.preventDefault(),V.blur();return}H.key==="Tab"&&ue(V,H.shiftKey?-1:1)&&H.preventDefault()}})),k.modalEl.querySelectorAll(".bulk-oil-sort").forEach(H=>{H.addEventListener("click",ie)}),k.importBtn&&k.importBtn.addEventListener("click",()=>{re()}),k.clearBtn&&k.clearBtn.addEventListener("click",()=>{le()}),k.modalEl.addEventListener("shown.bs.modal",()=>{let H=o();H.searchInput&&H.searchInput.focus()}))}de(),d(),u(),e.bulkOilsModal={openModal:z,serializeSelection:T,restoreState:h,onUnitChanged:fe}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:c,round:y,clamp:A,buildSoapcalcSearchBuilder:K}=e.helpers,{formatWeight:U,toGrams:R,fromGrams:m}=e.units,{FRAGRANCE_CATEGORY_SET:C}=e.constants,O=e.state;function g(_,u,t,p,b){var I;let G=document.getElementById(_),w=document.getElementById(u),x=p?document.getElementById(p):null,N=b?document.getElementById(b):null,$=(I=G==null?void 0:G.parentElement)==null?void 0:I.querySelector('[data-role="suggestions"]');if(!G||!$||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let f=K();B.attachMergedInventoryGlobalTypeahead({inputEl:G,listEl:$,mode:"public",giHiddenEl:w,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:f,searchType:"ingredient",resultFilter:(v,S)=>{let L=h(v);return L?t.has(L):S==="inventory"},requireHidden:!1,onSelection:function(v){x&&(x.value=(v==null?void 0:v.default_unit)||""),N&&(N.value=(v==null?void 0:v.ingredient_category_name)||""),e.storage.queueStateSave()}}),G.addEventListener("input",function(){this.value.trim()||(x&&(x.value=""),N&&(N.value=""))})}function P({pctId:_,weightId:u}){var w,x,N;let t=document.getElementById(_),p=t==null?void 0:t.value;if(p!==""&&p!==null&&p!==void 0)return c(p);let b=A(((x=(w=e.oils)==null?void 0:w.getTotalOilsGrams)==null?void 0:x.call(w))||0,0);if(b<=0)return 0;let G=R((N=document.getElementById(u))==null?void 0:N.value);return G<=0?0:G/b*100}function n(){var _,u,t,p,b,G,w,x;return{lactatePct:P({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:P({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:P({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:P({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((u=(_=document.getElementById("additiveLactateName"))==null?void 0:_.value)==null?void 0:u.trim())||"Sodium Lactate",sugarName:((p=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:p.trim())||"Sugar",saltName:((G=(b=document.getElementById("additiveSaltName"))==null?void 0:b.value)==null?void 0:G.trim())||"Salt",citricName:((x=(w=document.getElementById("additiveCitricName"))==null?void 0:w.value)==null?void 0:x.trim())||"Citric Acid"}}function l(){var u;return(((u=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:u.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function i(_){let u=A(c(_),0),t=A(P({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),p=A(P({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),b=A(P({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),G=A(P({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),w=u*(t/100),x=u*(p/100),N=u*(b/100),$=u*(G/100),f=l()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:p,saltPct:b,citricPct:G,lactateG:w,sugarG:x,saltG:N,citricG:$,citricLyeG:$*f}}function a({pctId:_,weightId:u,sourceField:t,totalOils:p}){let b=document.getElementById(_),G=document.getElementById(u);if(!b||!G)return;let w=A(c(p),0);if(w<=0)return;if(t==="weight"){let f=G.value;if(f===""||f===null||f===void 0){b.value="";return}let I=A(R(f),0),v=I>0?I/w*100:0;b.value=v>0?y(v,2):"";return}let x=b.value;if(x===""||x===null||x===void 0){G.value="";return}let N=A(c(x),0),$=w*(N/100);G.value=$>0?y(m($),2):""}function o(_){let u=(p,b)=>{let G=document.getElementById(p);if(G)if(G.tagName==="INPUT"){if(document.activeElement===G)return;G.value=b}else G.textContent=b},t=p=>p>0?y(m(p),2):"";u("additiveLactateWeight",t(c(_==null?void 0:_.lactateG))),u("additiveSugarWeight",t(c(_==null?void 0:_.sugarG))),u("additiveSaltWeight",t(c(_==null?void 0:_.saltG))),u("additiveCitricWeight",t(c(_==null?void 0:_.citricG))),u("additiveCitricLyeOut",U(c(_==null?void 0:_.citricLyeG)))}function r(_){let u=A(c(_),0),t=i(u);return o(t),t}function d(_){let u=_.querySelector(".fragrance-typeahead"),t=_.querySelector(".fragrance-gi-id"),p=_.querySelector(".fragrance-default-unit"),b=_.querySelector(".fragrance-category"),G=_.querySelector('[data-role="suggestions"]');if(!u||!G||typeof B.attachMergedInventoryGlobalTypeahead!="function")return;let w=K();B.attachMergedInventoryGlobalTypeahead({inputEl:u,listEl:G,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:w,searchType:"ingredient",resultFilter:(x,N)=>{let $=h(x);return $?C.has($):N==="inventory"},requireHidden:!1,onSelection:function(x){p&&(p.value=(x==null?void 0:x.default_unit)||""),b&&(b.value=(x==null?void 0:x.ingredient_category_name)||""),e.storage.queueStateSave()}}),u.addEventListener("input",function(){this.value.trim()||(p&&(p.value=""),b&&(b.value=""))})}function s(){var t,p;let _=document.getElementById("fragranceRowTemplate"),u=(p=(t=_==null?void 0:_.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:p.cloneNode(!0);return u?(u.querySelectorAll("input").forEach(b=>{b.value=""}),d(u),u.querySelectorAll(".unit-suffix").forEach(b=>{b.dataset.suffix=O.currentUnit}),u):document.createElement("div")}function q(_){let u=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=A(_||e.oils.getTotalOilsGrams()||0,0),p=0,b=0;u.forEach(x=>{let N=x.querySelector(".fragrance-grams"),$=x.querySelector(".fragrance-percent");if(!N||!$)return;let f=N.value,I=$.value,v=R(f),S=A(c(I),0),L=e.state.lastFragranceEdit,M=L&&L.row===x?L.field:null;t>0&&(M==="percent"?(v=t*(S/100),N.value=v>0?y(m(v),2):""):M==="grams"?(S=v/t*100,$.value=S>0?y(S,2):""):v>0?(S=v/t*100,document.activeElement!==$&&($.value=y(S,2))):S>0&&(v=t*(S/100),document.activeElement!==N&&(N.value=y(m(v),2)))),v>0&&(p+=v),b+=S});let G=document.getElementById("fragrancePercentTotal");G&&(G.textContent=y(b,2));let w=document.getElementById("fragranceTotalComputed");return w&&(w.textContent=p>0?U(p):"--"),{totalGrams:p,totalPct:b}}function E(){let _=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(u=>{var N,$,f,I,v,S,L;let t=(($=(N=u.querySelector(".fragrance-typeahead"))==null?void 0:N.value)==null?void 0:$.trim())||"",p=((f=u.querySelector(".fragrance-grams"))==null?void 0:f.value)||"",b=((I=u.querySelector(".fragrance-percent"))==null?void 0:I.value)||"",G=((v=u.querySelector(".fragrance-gi-id"))==null?void 0:v.value)||"",w=((S=u.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",x=((L=u.querySelector(".fragrance-category"))==null?void 0:L.value)||"";!t&&!p&&!b&&!G||_.push({name:t,grams:p,percent:b,gi:G,defaultUnit:w,categoryName:x})}),_}function T(_){let u=document.getElementById("soapVisualGuidanceList");if(!u)return;let t=Array.isArray(_==null?void 0:_.tips)&&_.tips.length?_.tips:["No visual flags detected for this formula."];u.innerHTML=t.map(p=>`<li>${p}</li>`).join("")}function h(_){return!_||typeof _!="object"?null:_.ingredient&&_.ingredient.ingredient_category_name||_.ingredient_category_name||_.ingredient_category&&_.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:g,collectAdditiveSettings:n,syncAdditivePair:a,applyComputedOutputs:o,updateAdditivesOutput:r,updateVisualGuidance:T},e.fragrances={buildFragranceRow:s,updateFragranceTotals:q,collectFragranceData:E}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:c}=e.helpers,{STAGE_CONFIGS:y}=e.constants;function A(m){var g;let C=y[m];if(!C)return;let O=document.getElementById(C.tabId);if(O){if((g=B.bootstrap)!=null&&g.Tab)bootstrap.Tab.getOrCreateInstance(O).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(n=>{n.classList.remove("active"),n.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(n=>{n.classList.remove("show","active")}),O.classList.add("active"),O.setAttribute("aria-selected","true");let P=document.getElementById(C.paneId);P&&P.classList.add("show","active")}e.layout.scheduleStageHeightSync(),O.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function K(m){var C,O;if(m===1){let g=document.getElementById("unitGrams");g&&(g.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let P=document.getElementById("moldCylinderCorrection");P&&(P.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(C=e.mold)!=null&&C.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(m===2){let g=document.getElementById("oilRows");g&&(g.innerHTML="",g.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(m===3){let g=document.getElementById("lyeTypeNaoh");g&&(g.checked=!0);let P=document.getElementById("waterMethod");P&&(P.value="percent");let n=document.getElementById("lyeSuperfat");n&&(n.value="5");let l=document.getElementById("lyePurity");l&&(l.value="100");let i=document.getElementById("waterPct");i&&(i.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let o=document.getElementById("waterRatio");o&&(o.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(m===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(g=>{let P=document.getElementById(g);P&&(P.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(g=>{let P=document.getElementById(g);P&&(P.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),m===5){let g=document.getElementById("fragranceRows");g&&(g.innerHTML="",(O=e.fragrances)!=null&&O.buildFragranceRow&&g.appendChild(e.fragrances.buildFragranceRow()));let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent="0");let n=document.getElementById("fragranceTotalComputed");n&&(n.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),R()}function U(m){var C;if(m===1){let O=c(document.getElementById("moldWaterWeight").value),g=c(document.getElementById("oilTotalTarget").value),P=c(document.getElementById("moldOilPct").value),l=!!document.querySelector('input[name="weight_unit"]:checked')&&(O>0||g>0)&&P>0;return{state:l?"complete":"incomplete",label:l?"Sized":"Needs target"}}if(m===2){let g=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(P=>{var a,o,r,d;let n=(o=(a=P.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:o.trim(),l=c((r=P.querySelector(".oil-grams"))==null?void 0:r.value),i=c((d=P.querySelector(".oil-percent"))==null?void 0:d.value);return n&&(l>0||i>0)});return{state:g?"complete":"incomplete",label:g?"Oils added":"Add oils"}}if(m===3){let O=c(document.getElementById("lyeSuperfat").value),g=(C=document.getElementById("waterMethod"))==null?void 0:C.value,n=!!document.querySelector('input[name="lye_type"]:checked')&&!!g&&O>=0;return{state:n?"complete":"incomplete",label:n?"Configured":"Set lye"}}return m===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(g=>c(document.getElementById(g).value)>0)?"Added":"Optional"}:m===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(P=>{var a,o,r,d;let n=(o=(a=P.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:o.trim(),l=c((r=P.querySelector(".fragrance-grams"))==null?void 0:r.value),i=c((d=P.querySelector(".fragrance-percent"))==null?void 0:d.value);return n||l>0||i>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function R(){let m=document.getElementById("soapStageTabList");m&&m.querySelectorAll(".soap-stage-status").forEach(O=>O.remove());let C=document.getElementById("soapStageProgress");C&&(C.textContent="")}e.stages={openStageByIndex:A,resetStage:K,updateStageStatuses:R}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y,clamp:A}=e.helpers,{computeFattyAcids:K,computeQualities:U,computeOilQualityScores:R}=e.calc,{QUALITY_RANGES:m,QUALITY_HINTS:C,QUALITY_FEEL_HINTS:O,IODINE_RANGE:g,IODINE_SCALE_MAX:P,INS_RANGE:n,INS_SCALE_MAX:l,QUALITY_BASE:i,QUALITY_PRESETS:a,FATTY_BAR_COLORS:o,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:s}=e.ui;function q({barId:x,fillId:N,value:$,max:f,label:I}){let v=document.getElementById(x),S=document.getElementById(N);if(!v||!S)return null;let L=isFinite($)?$:0,M=Math.max(0,Math.min(f,L)),D=f>0?M/f*100:0;return S.style.width=`${D}%`,v.setAttribute("aria-valuemin","0"),v.setAttribute("aria-valuemax",String(f)),v.setAttribute("aria-valuenow",M.toFixed(1)),I&&v.setAttribute("aria-label",I),{bar:v,fill:S,value:L}}function E(x,N,$){if(!(!x||!$)){if(x.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(N)){x.classList.add("bg-secondary");return}N<$[0]?x.classList.add("bg-warning"):N>$[1]?x.classList.add("bg-danger"):x.classList.add("bg-success")}}function T(x,N,$,f,I,v){let S=q({barId:x,fillId:N,value:$,max:I,label:v});S&&E(S.fill,$,f)}function h(){let x={hardness:{range:m.hardness,scale:100},cleansing:{range:m.cleansing,scale:100},conditioning:{range:m.conditioning,scale:100},bubbly:{range:m.bubbly,scale:100},creamy:{range:m.creamy,scale:100},iodine:{range:g,scale:P},ins:{range:n,scale:l}};Object.entries(x).forEach(([N,$])=>{let[f,I]=$.range,v=$.scale,S=N.charAt(0).toUpperCase()+N.slice(1),L=N==="iodine"?"iodineBar":N==="ins"?"insBar":`quality${S}Bar`,M=document.getElementById(`quality${S}Safe`);if(M){let W=Math.max(0,Math.min(100,f/v*100)),F=Math.max(0,Math.min(100,(I-f)/v*100));M.style.left=`${W}%`,M.style.width=`${F}%`,M.title=`Safe range ${c(f,0)}-${c(I,0)}`}let D=document.getElementById(L);D&&(D.dataset.safeRange=`${c(f,0)}-${c(I,0)}`);let Q=document.getElementById(`quality${S}RangeMin`),j=document.getElementById(`quality${S}RangeMax`);Q&&(Q.textContent=c(f,0)),j&&(j.textContent=c(I,0))})}function _(x,N){let $=A(x.hardness||0,0,100),f=A(x.bubbly||0,0,100),I=A(x.conditioning||0,0,100),v=A(I+(N||0)*3,0,100),S=document.getElementById("feelHardness"),L=document.getElementById("feelBubbly"),M=document.getElementById("feelConditioning"),D=document.getElementById("feelGreasy");S&&(S.value=c($,1)),L&&(L.value=c(f,1)),M&&(M.value=c(I,1)),D&&(D.value=c(v,1))}function u(x){r.forEach(N=>{let $=document.getElementById(`fattyBar${N.charAt(0).toUpperCase()}${N.slice(1)}`);if(!$)return;let f=A(y(x[N]),0,100),I=f;$.style.width=`${I}%`,$.style.backgroundColor=o[N]||"var(--color-muted)",$.title=`${N.charAt(0).toUpperCase()}${N.slice(1)}: ${c(f,1)}%`})}function t(){var f;let x=((f=document.getElementById("qualityPreset"))==null?void 0:f.value)||"balanced",N=Array.from(document.querySelectorAll(".quality-focus:checked"));if(x==="none"&&!N.length)return null;let $=x==="none"?{...i}:a[x]?{...a[x]}:{...i};return N.forEach(I=>{let v=I.dataset.attr,S=I.dataset.direction,L=m[v];L&&($[v]=S==="low"?L[0]:L[1])}),$}function p(){let x=t(),N={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(N).forEach(([$,f])=>{if(!f)return;let I=document.getElementById(`${f.id}Label`);if(!x){f.classList.add("d-none"),I&&(I.textContent="");return}let v=y(x[$]);if(!isFinite(v)){f.classList.add("d-none"),I&&(I.textContent="");return}let S=$==="iodine"?P:$==="ins"?l:100,L=A(v,0,S);f.classList.remove("d-none"),f.style.left=`${L/S*100}%`,f.setAttribute("aria-label",`Apply ${$} target`),f.setAttribute("role","button"),f.setAttribute("tabindex","0"),f.title=`Target ${$}: ${c(v,1)}`,I&&(I.textContent=c(v,1))})}function b(){let x=t();if(!x){s("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let $=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(F=>{var te,ie;let Y=e.units.toGrams((te=F.querySelector(".oil-grams"))==null?void 0:te.value),z=((ie=F.querySelector(".oil-fatty"))==null?void 0:ie.value)||"",X=null;if(z)try{X=JSON.parse(z)}catch{X=null}return{row:F,grams:Y,fattyProfile:X}}).filter(F=>F.grams>0);if(!$.length){s("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let f=K($.map(F=>({grams:F.grams,fattyProfile:F.fattyProfile}))),I=U(f.percent),v={hardness:A((x.hardness-I.hardness)/100,-1,1),cleansing:A((x.cleansing-I.cleansing)/100,-1,1),conditioning:A((x.conditioning-I.conditioning)/100,-1,1),bubbly:A((x.bubbly-I.bubbly)/100,-1,1),creamy:A((x.creamy-I.creamy)/100,-1,1)},S=$.reduce((F,Y)=>F+Y.grams,0),L=[],M=0,D=.8,Q=$.filter(F=>!F.fattyProfile||typeof F.fattyProfile!="object").length;if(Q===$.length){s("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(Q&&s("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),$.forEach(F=>{let Y=R(F.fattyProfile),z=v.hardness*Y.hardness+v.cleansing*Y.cleansing+v.conditioning*Y.conditioning+v.bubbly*Y.bubbly+v.creamy*Y.creamy,X=A(1+z*D,.2,1.8),te=F.grams*X;L.push({row:F.row,grams:te}),M+=te}),M<=0){s("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let j=S/M,W=e.oils.getOilTargetGrams()||S;L.forEach(F=>{let Y=F.grams*j,z=F.row.querySelector(".oil-grams"),X=F.row.querySelector(".oil-percent");if(z&&(z.value=Y>0?c(e.units.fromGrams(Y),2):""),X&&W>0){let te=Y/W*100;X.value=te>0?c(te,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),s("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function G(x){let{qualities:N,fattyPercent:$,coveragePct:f,iodine:I,ins:v,sapAvg:S,superfat:L,warnings:M}=x,D=f>0;function Q(ae,ee){var H,V;let re=document.getElementById(`quality${ae}Value`),ue=document.getElementById(`quality${ae}Hint`);if(!re)return;re.textContent=D&&isFinite(ee)?c(ee,1):"--",d(re);let fe=ae.toLowerCase(),de=m[fe],k=q({barId:`quality${ae}Bar`,fillId:`quality${ae}Fill`,value:D?ee:0,max:100,label:ae});k&&de&&(E(k.fill,ee,de),D&&isFinite(ee)?k.bar.title=`${ae}: ${c(ee,1)} (safe ${de[0]}-${de[1]}). ${C[fe]||""}`.trim():k.bar.title=`${ae}: -- (safe ${de[0]}-${de[1]}). ${C[fe]||""}`.trim()),ue&&de&&(!D||!isFinite(ee)?ue.textContent="":ee<de[0]?ue.textContent=((H=O[fe])==null?void 0:H.low)||"":ee>de[1]?ue.textContent=((V=O[fe])==null?void 0:V.high)||"":ue.textContent="")}Q("Hardness",N.hardness),Q("Cleansing",N.cleansing),Q("Conditioning",N.conditioning),Q("Bubbly",N.bubbly),Q("Creamy",N.creamy);let j=document.getElementById("fattyCoverageNote");j&&(j.textContent=f>0?`Fatty acid coverage: ${c(f,1)}% of oils`:"Fatty acid coverage: not enough data yet");let W=document.getElementById("iodineValue"),F=document.getElementById("insValue"),Y=document.getElementById("sapAvgValue");W&&(W.textContent=I>0?c(I,1):"--",d(W)),F&&(F.textContent=v>0?c(v,1):"--",d(F)),Y&&(Y.textContent=S>0?c(S,1):"--",d(Y)),T("iodineBar","iodineFill",I,g,P,"Iodine"),T("insBar","insFill",v,n,l,"INS");let z=($.lauric||0)+($.myristic||0)+($.palmitic||0)+($.stearic||0),X=($.ricinoleic||0)+($.oleic||0)+($.linoleic||0)+($.linolenic||0),te=document.getElementById("fattySatRatioResult");te&&(te.textContent=z+X>0?`${c(z,0)}:${c(X,0)}`:"--",d(te)),r.forEach(ae=>{let ee=`fatty${ae.charAt(0).toUpperCase()}${ae.slice(1)}`,re=$[ae];document.getElementById(ee).textContent=D&&re?`${c(re,1)}%`:"--"}),_(N,L||0),u($),p();let ie=Array.isArray(M)?M.slice():[],le=document.getElementById("soapQualityWarnings");ie.length?(le.classList.remove("d-none"),le.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${ie.map(ae=>`<li>${ae}</li>`).join("")}</ul>`):(le.classList.add("d-none"),le.textContent=""),e.layout.scheduleStageHeightSync()}function w(){var x;document.querySelectorAll(".soap-quality-help").forEach(N=>{let $=N.dataset.quality;C[$]&&N.setAttribute("title",C[$])}),(x=B.bootstrap)!=null&&x.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(N=>{bootstrap.Tooltip.getOrCreateInstance(N)})}e.quality={setQualityRangeBars:h,updateQualityTargets:p,applyQualityTargets:b,updateQualitiesDisplay:G,initQualityTooltips:w}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y,clamp:A}=e.helpers;function K(n){let l=0,i=0;return(n||[]).forEach(a=>{let o=y(a==null?void 0:a.sapKoh),r=y(a==null?void 0:a.grams);o>0&&r>0&&(l+=o*r,i+=r)}),i>0?l/i:0}function U(n){var q,E,T,h,_,u,t,p,b,G,w,x;let l=n.qualityReport||{},i=l.fatty_acids_pct||{},a=l.qualities||{},o=isFinite(n.sapAvg)&&n.sapAvg>0?n.sapAvg:y(l.sap_avg_koh)||K(n.oils||[]),r=y(l.iodine),d=y(l.ins)||(o&&r?o-r:0),s=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((q=document.getElementById("qualityPreset"))==null?void 0:q.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(N=>N.id),mold:s,oils:(n.oils||[]).map(N=>({name:N.name||null,grams:c(N.grams||0,2),iodine:N.iodine||null,sap_koh:N.sapKoh||null,fatty_profile:N.fattyProfile||null,global_item_id:N.global_item_id||null,default_unit:N.default_unit||null,ingredient_category_name:N.ingredient_category_name||null})),totals:{total_oils_g:c(n.totalOils||0,2),batch_yield_g:c(n.batchYield||0,2),lye_pure_g:c(n.lyePure||0,2),lye_adjusted_g:c(n.lyeAdjusted||0,2),water_g:c(n.water||0,2)},lye:{lye_type:n.lyeType,superfat:n.superfat,purity:n.purity,water_method:n.waterMethod,water_pct:n.waterPct,lye_concentration:n.lyeConcentration,water_ratio:n.waterRatio},additives:{fragrance_pct:((E=n.additives)==null?void 0:E.fragrancePct)||0,lactate_pct:((T=n.additives)==null?void 0:T.lactatePct)||0,sugar_pct:((h=n.additives)==null?void 0:h.sugarPct)||0,salt_pct:((_=n.additives)==null?void 0:_.saltPct)||0,citric_pct:((u=n.additives)==null?void 0:u.citricPct)||0,fragrance_g:c(((t=n.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:c(((p=n.additives)==null?void 0:p.lactateG)||0,2),sugar_g:c(((b=n.additives)==null?void 0:b.sugarG)||0,2),salt_g:c(((G=n.additives)==null?void 0:G.saltG)||0,2),citric_g:c(((w=n.additives)==null?void 0:w.citricG)||0,2),citric_lye_g:c(((x=n.additives)==null?void 0:x.citricLyeG)||0,2)},qualities:{hardness:c(a.hardness||0,1),cleansing:c(a.cleansing||0,1),conditioning:c(a.conditioning||0,1),bubbly:c(a.bubbly||0,1),creamy:c(a.creamy||0,1),iodine:c(r||0,1),ins:c(d||0,1),sap_avg:c(o||0,1)},fatty_acids:i,updated_at:new Date().toISOString()}}function R(n,l,i,a,o){var E,T,h,_,u;let r=(T=(E=document.getElementById(n))==null?void 0:E.value)==null?void 0:T.trim(),d=((h=document.getElementById(l))==null?void 0:h.value)||"",s=a&&((_=document.getElementById(a))==null?void 0:_.value)||"",q=o&&((u=document.getElementById(o))==null?void 0:u.value)||"";return{name:r||i,globalItemId:d?parseInt(d):void 0,defaultUnit:s||void 0,categoryName:q||void 0}}function m(n){let l=[],i=A(n||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var _,u,t,p,b,G,w;let o=(u=(_=a.querySelector(".fragrance-typeahead"))==null?void 0:_.value)==null?void 0:u.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((p=a.querySelector(".fragrance-default-unit"))==null?void 0:p.value)||"",s=((b=a.querySelector(".fragrance-category"))==null?void 0:b.value)||"",q=(G=a.querySelector(".fragrance-grams"))==null?void 0:G.value,E=(w=a.querySelector(".fragrance-percent"))==null?void 0:w.value,T=e.units.toGrams(q),h=A(y(E),0);T<=0&&h>0&&i>0&&(T=i*(h/100)),!(!o&&!r&&T<=0)&&l.push({name:o||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:s||void 0,grams:T,pct:h})}),l}function C(n,l){let i=[];return document.querySelectorAll(`#${n} .row`).forEach(function(a){var E,T,h;let o=(T=(E=a.querySelector(".tool-typeahead"))==null?void 0:E.value)==null?void 0:T.trim(),r=((h=a.querySelector(".tool-gi-id"))==null?void 0:h.value)||"",d=a.querySelector(".tool-qty"),s=a.querySelector(".tool-unit"),q=d&&d.value!=="";!o&&!r||(l==="container"?i.push({name:o||void 0,global_item_id:r?parseInt(r):void 0,quantity:q?parseFloat(d.value):1}):i.push({name:o||void 0,global_item_id:r?parseInt(r):void 0,quantity:q?parseFloat(d.value):0,unit:((s==null?void 0:s.value)||"").trim()||"gram"}))}),i}function O(n){let l=e.config.isAuthenticated?"member":"public",i=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(n,{context:l,mode:i,unitOptionsHtml:e.config.unitOptionsHtml})}function g(n,l){let i=O(n),a=i.querySelector(".tool-typeahead"),o=i.querySelector(".tool-qty");a&&(a.value=l),o&&n==="container"&&(o.value=1),n==="container"?document.getElementById("tool-containers").appendChild(i):n==="consumable"?document.getElementById("tool-consumables").appendChild(i):document.getElementById("tool-ingredients").appendChild(i)}function P(n){var r,d,s,q;let l=U(n),i=(n.oils||[]).map(E=>({name:E.name||void 0,global_item_id:E.global_item_id||void 0,quantity:E.grams,unit:"gram",default_unit:E.default_unit||void 0,ingredient_category_name:E.ingredient_category_name||void 0})),a=n.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(n.lyeAdjusted>0&&i.push({name:a,quantity:c(n.lyeAdjusted,2),unit:"gram"}),n.water>0&&i.push({name:"Distilled Water",quantity:c(n.water,2),unit:"gram"}),m(n.totalOils||0).forEach(E=>{E.grams>0&&i.push({name:E.name,global_item_id:E.globalItemId,quantity:c(E.grams,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}),((r=n.additives)==null?void 0:r.lactateG)>0){let E=R("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");i.push({name:E.name,global_item_id:E.globalItemId,quantity:c(n.additives.lactateG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((d=n.additives)==null?void 0:d.sugarG)>0){let E=R("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");i.push({name:E.name,global_item_id:E.globalItemId,quantity:c(n.additives.sugarG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((s=n.additives)==null?void 0:s.saltG)>0){let E=R("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");i.push({name:E.name,global_item_id:E.globalItemId,quantity:c(n.additives.saltG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((q=n.additives)==null?void 0:q.citricG)>0){let E=R("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");i.push({name:E.name,global_item_id:E.globalItemId,quantity:c(n.additives.citricG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName}),i.push({name:"Extra Lye for Citric Acid",quantity:c(n.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((n.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:n.superfat,soap_lye_type:n.lyeType,soap_lye_purity:n.purity,soap_water_method:n.waterMethod,soap_water_pct:n.waterPct,soap_lye_concentration:n.lyeConcentration,soap_water_ratio:n.waterRatio,soap_oils_total_g:n.totalOils,soap_lye_g:n.lyeAdjusted,soap_water_g:n.water},ingredients:i.concat(C("tool-ingredients","ingredient")),consumables:C("tool-consumables","consumable"),containers:C("tool-containers","container"),notes:JSON.stringify(l)}}e.recipePayload={collectFragranceRows:m,collectDraftLines:C,buildLineRow:O,addStubLine:g,buildSoapRecipePayload:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y,clamp:A}=e.helpers,{formatWeight:K,formatPercent:U}=e.units;function R(){var q;let a=((q=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:q.value)||"NaOH",o=document.getElementById("lyePurity"),r=o==null?void 0:o.value,d=y(o==null?void 0:o.value),s=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:s,purity:d}}function m(){let a=document.getElementById("lyePurity"),o=R();if(a)if(a.removeAttribute("readonly"),o.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function C(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function O(a=null,o=null){var q;let r=document.getElementById("stageWaterOutput"),d=document.getElementById("stageWaterComputedHint"),s=o||(a==null?void 0:a.waterMethod)||((q=document.getElementById("waterMethod"))==null?void 0:q.value)||"percent";if(r){let E=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=E?K(a.waterG):"--"}if(d){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){d.textContent=`Set oils in Stage 2 to calculate water. ${C(s)}`;return}if(s==="concentration"){let E=a.lyeConcentrationInput||a.lyeConcentration||0;d.textContent=`Using ${c(E,1)}% lye concentration from ${K(a.lyeAdjusted||0)} lye.`;return}if(s==="ratio"){let E=a.waterRatioInput||a.waterRatio||0;d.textContent=`Using ${c(E,2)} : 1 water-to-lye ratio from ${K(a.lyeAdjusted||0)} lye.`;return}d.textContent=`Using ${c(a.waterPct||0,1)}% of total oils (${K(a.totalOils)}).`}}function g(a=null,o=null){var G;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),s=document.getElementById("waterPreview"),q=document.getElementById("concPreview"),E=document.getElementById("ratioPreview");if(!r&&!d&&!s&&!q&&!E)return;let T=(w,x)=>{w&&(w.textContent=x)},h=o||(a==null?void 0:a.waterMethod)||((G=document.getElementById("waterMethod"))==null?void 0:G.value)||"percent",_=y(a==null?void 0:a.totalOils),u=y(a==null?void 0:a.lyeAdjusted),t=y(a==null?void 0:a.waterG);if(_<=0||u<=0){T(r,"Based on -- oils. All values update live as you change inputs."),T(d,"--"),T(s,"--"),T(q,"--"),T(E,"--");return}let p=y(a==null?void 0:a.lyeConcentration)>0?y(a==null?void 0:a.lyeConcentration):u+t>0?u/(u+t)*100:0,b=y(a==null?void 0:a.waterRatio)>0?y(a==null?void 0:a.waterRatio):u>0?t/u:0;if(T(r,`Based on ${K(_)} oils. All values update live as you change inputs.`),T(d,K(u)),T(s,K(t)),T(q,p>0?U(p):"--"),T(E,b>0?`${c(b,2)} : 1`:"--"),h==="concentration"){let w=y(a==null?void 0:a.lyeConcentrationInput);w>0&&T(q,U(w))}if(h==="ratio"){let w=y(a==null?void 0:a.waterRatioInput);w>0&&T(E,`${c(w,2)} : 1`)}}function P(){var o;let a=((o=document.getElementById("waterMethod"))==null?void 0:o.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),O(null,a),g(null,a)}function n(){let a=e.oils.updateOilTotals(),o=a.totalWeight,r=a.totalPct,d=[],s=e.oils.collectOilData(),q=e.oils.getOilTargetGrams(),T=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(h=>A(y(h.value),0)).some(h=>h>0);return(!s.length||o<=0)&&d.push("Add at least one oil with a weight or percent."),!q&&o<=0&&T&&d.push("Enter a total oils target or weights to convert percentages."),q>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),q>0&&o>q+.01?d.push("Oil weights exceed the mold target."):!q&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:s}}function l(){let a=document.getElementById("lyeSuperfat"),o=a==null?void 0:a.value,r=y(o);return(o===""||o===null||o===void 0||!isFinite(r))&&(r=5),r}function i(){var E,T,h,_;let o=R().purity;isFinite(o)||(o=100);let r=((E=document.getElementById("waterMethod"))==null?void 0:E.value)||"percent",d=y((T=document.getElementById("waterPct"))==null?void 0:T.value),s=y((h=document.getElementById("lyeConcentration"))==null?void 0:h.value),q=y((_=document.getElementById("waterRatio"))==null?void 0:_.value);return{purity:o,waterMethod:r,waterPct:d,lyeConcentration:s,waterRatio:q}}e.runnerInputs={getLyeSelection:R,applyLyeSelection:m,setWaterMethod:P,updateStageWaterSummary:O,updateLiveCalculationPreview:g,validateCalculation:n,readSuperfatInput:l,sanitizeLyeInputs:i}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{getStorage:c}=e.helpers;function y(){if(!e.config.calcLimit)return{count:0,date:null};let m=c();if(!m)return{count:0,date:null};try{let C=m.getItem("soap_calc_usage"),O=new Date().toISOString().slice(0,10);if(!C)return{count:0,date:O};let g=JSON.parse(C);return!g||g.date!==O?{count:0,date:O}:{count:Number(g.count)||0,date:O}}catch{return{count:0,date:null}}}function A(m){if(!e.config.calcLimit)return;let C=c();if(!C)return;let O=new Date().toISOString().slice(0,10);try{C.setItem("soap_calc_usage",JSON.stringify({count:m,date:O}))}catch{}}function K(){return e.config.calcLimit&&y().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function U(){if(!e.config.calcLimit)return;let C=y().count+1;A(C);let O=Math.max(0,e.config.calcLimit-C);O<=1&&e.ui.showSoapAlert("info",`You have ${O} calculation${O===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function R(m){if(!e.config.calcLimit||m===null||m>1)return;let C=document.getElementById("soapSignupModal");C&&(B.bootstrap&&B.bootstrap.Modal?B.bootstrap.Modal.getOrCreateInstance(C).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:K,consumeCalcQuota:U,maybeShowSignupModal:R}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.state;function y({oils:K,selection:U,superfat:R,purity:m,waterMethod:C,waterPct:O,lyeConcentration:g,waterRatio:P,totalOils:n}){let l=e.additives.collectAdditiveSettings(),i=e.recipePayload.collectFragranceRows(n||0);return{oils:(K||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:i.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:l.lactatePct||0,sugar_pct:l.sugarPct||0,salt_pct:l.saltPct||0,citric_pct:l.citricPct||0,lactate_name:l.lactateName||"Sodium Lactate",sugar_name:l.sugarName||"Sugar",salt_name:l.saltName||"Salt",citric_name:l.citricName||"Citric Acid"},lye:{selected:(U==null?void 0:U.selected)||"NaOH",superfat:R,purity:m},water:{method:C,water_pct:O,lye_concentration:g,water_ratio:P},meta:{unit_display:c.currentUnit||"g"}}}async function A(K){var C;let U=((C=document.querySelector('meta[name="csrf-token"]'))==null?void 0:C.getAttribute("content"))||"",R=new AbortController,m=B.setTimeout(()=>R.abort(),2500);try{let O=await fetch("/tools/api/soap/calculate",{method:"POST",signal:R.signal,headers:{"Content-Type":"application/json",...U?{"X-CSRFToken":U}:{}},body:JSON.stringify(K||{})});if(!O.ok)return null;let g=await O.json();return!g||g.success!==!0||typeof g.result!="object"?null:g.result}catch{return null}finally{B.clearTimeout(m)}}e.runnerService={buildServicePayload:y,calculateWithSoapService:A}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{round:c,toNumber:y}=e.helpers,{formatWeight:A,formatPercent:K}=e.units,U=e.state,R={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function m(n){return(n||[]).map(l=>{var i;return{name:l.name||null,grams:y(l.grams),sapKoh:y((i=l.sap_koh)!=null?i:l.sapKoh),iodine:y(l.iodine),fattyProfile:l.fatty_profile||l.fattyProfile||null,global_item_id:l.global_item_id||null,default_unit:l.default_unit||null,ingredient_category_name:l.ingredient_category_name||null}})}function C(n,l){let i=document.getElementById(n);i&&(i.textContent=l)}function O({resultsCard:n,lyeAdjusted:l,waterData:i,batchYield:a,totalOils:o,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let s=y(n.water_lye_ratio)||i.waterRatio;C("lyeAdjustedOutput",A(y(n.lye_adjusted_g)||l)),C("waterOutput",A(y(n.water_g)||i.waterG)),C("batchYieldOutput",A(a)),C("lyeConcentrationOutput",K(y(n.lye_concentration_pct)||i.lyeConcentration)),C("waterRatioOutput",isFinite(s)&&s>0?c(s,2).toString():"--"),C("totalOilsOutput",A(o)),C("superfatOutput",K(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(q=>e.ui.pulseValue(document.getElementById(q)))}function g({showAlerts:n,lyeTotals:l,purity:i,waterData:a}){if(!n)return;l.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),i<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${c(i,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let o=e.mold.getMoldSettings();o.shape==="cylinder"&&o.waterWeight>0&&!o.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function P({serviceResult:n,validation:l,selection:i,superfat:a,purity:o,waterMethod:r,waterPct:d,lyeConcentrationInput:s,waterRatioInput:q,showAlerts:E}){var F;let T=n.lye_type||i.lyeType||"NaOH",h=n.lye_selected||i.selected||null,_=y(n.total_oils_g)||l.totals.totalWeight,u=y(n.superfat_pct),t=isFinite(u)?u:a,p={sapAvg:y(n.sap_avg_koh),usedFallback:!!n.used_sap_fallback},b=y(n.lye_pure_g),w=Object.prototype.hasOwnProperty.call(n,"lye_adjusted_base_g")?y(n.lye_adjusted_base_g):null,x=y(n.lye_adjusted_g),N=y(n.lye_purity_pct)||o,$=n.water_method||r,f=y(n.water_pct)||d,I=y(n.lye_concentration_input_pct)||s,v=y(n.water_ratio_input)||q,S={waterG:y(n.water_g),lyeConcentration:y(n.lye_concentration_pct),waterRatio:y(n.water_lye_ratio)},L=n.results_card||{},M=n.quality_report||{},D=m(n.oils||l.oils),Q={waterG:S.waterG,lyeAdjusted:x,totalOils:_,waterMethod:$,waterPct:f,lyeConcentrationInput:I,waterRatioInput:v,lyeConcentration:S.lyeConcentration,waterRatio:S.waterRatio};e.runnerInputs.updateStageWaterSummary(Q),e.runnerInputs.updateLiveCalculationPreview(Q);let j=n.additives||R;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(j);let W=y(L.batch_yield_g)||_+x+S.waterG+j.fragranceG+j.lactateG+j.sugarG+j.saltG+j.citricG;return(F=e.mold)!=null&&F.updateWetBatterWarning&&e.mold.updateWetBatterWarning(W),O({resultsCard:L,lyeAdjusted:x,waterData:S,batchYield:W,totalOils:_,superfat:t}),e.ui.updateResultsWarnings(S),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:M.qualities||{},fattyPercent:M.fatty_acids_pct||{},coveragePct:y(M.coverage_pct),iodine:y(M.iodine),ins:y(M.ins),sapAvg:p.sapAvg,superfat:t,waterData:S,additives:j,oils:D,totalOils:_,warnings:M.warnings||[]}),e.additives.updateVisualGuidance({tips:M.visual_guidance||[]}),e.stages.updateStageStatuses(),g({showAlerts:E,lyeTotals:p,purity:N,waterData:S}),U.lastCalc={totalOils:_,oils:D,lyeType:T,lyeSelected:h,superfat:t,purity:N,lyePure:b,lyeAdjustedBase:w,lyeAdjusted:x,water:S.waterG,waterMethod:$,waterPct:f,lyeConcentration:S.lyeConcentration,waterRatio:S.waterRatio,sapAvg:p.sapAvg,usedSapFallback:p.usedFallback,additives:j,batchYield:W,qualityReport:M,export:n.export||null},U.lastCalc}e.runnerRender={applyServiceResult:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.state,y=e.runnerInputs,A=e.runnerQuota,K=e.runnerService,U=e.runnerRender;async function R(m={}){var O;let C={consumeQuota:!1,showAlerts:!0,...m};try{C.showAlerts&&e.ui.clearSoapAlerts();let g=y.validateCalculation();if(!g.ok)return y.updateStageWaterSummary(null),y.updateLiveCalculationPreview(null),(O=e.mold)!=null&&O.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),C.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${g.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(C.consumeQuota&&!A.canConsumeCalcQuota())return null;let P=y.readSuperfatInput(),n=y.getLyeSelection(),l=y.sanitizeLyeInputs(),i=(c.calcRequestSeq||0)+1;c.calcRequestSeq=i;let a=K.buildServicePayload({oils:g.oils,selection:n,superfat:P,purity:l.purity,waterMethod:l.waterMethod,waterPct:l.waterPct,lyeConcentration:l.lyeConcentration,waterRatio:l.waterRatio,totalOils:g.totals.totalWeight}),o=await K.calculateWithSoapService(a);if(i!==c.calcRequestSeq)return c.lastCalc;if(!o)return C.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=U.applyServiceResult({serviceResult:o,validation:g,selection:n,superfat:P,purity:l.purity,waterMethod:l.waterMethod,waterPct:l.waterPct,lyeConcentrationInput:l.lyeConcentration,waterRatioInput:l.waterRatio,showAlerts:C.showAlerts});return C.consumeQuota&&A.consumeCalcQuota(),r}catch{return C.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...m)=>y.getLyeSelection(...m),applyLyeSelection:(...m)=>y.applyLyeSelection(...m),setWaterMethod:(...m)=>y.setWaterMethod(...m),updateLiveCalculationPreview:(...m)=>y.updateLiveCalculationPreview(...m),calculateAll:R,buildSoapRecipePayload:(...m)=>e.recipePayload.buildSoapRecipePayload(...m),buildLineRow:(...m)=>e.recipePayload.buildLineRow(...m),addStubLine:(...m)=>e.recipePayload.addStubLine(...m),maybeShowSignupModal:(...m)=>A.maybeShowSignupModal(...m)}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{formatTime:c,getStorage:y}=e.helpers,A="soap_tool_state_v2";function K(i,a){let o=[];return document.querySelectorAll(`#${i} .row`).forEach(d=>{var _,u,t;let s=(u=(_=d.querySelector(".tool-typeahead"))==null?void 0:_.value)==null?void 0:u.trim(),q=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",E=d.querySelector(".tool-qty"),T=d.querySelector(".tool-unit"),h=E&&E.value!==""?e.helpers.toNumber(E.value):null;!s&&!q||(a==="container"?o.push({name:s||"",global_item_id:q?parseInt(q):null,quantity:h&&h>0?h:1}):o.push({name:s||"",global_item_id:q?parseInt(q):null,quantity:h&&h>=0?h:0,unit:(T==null?void 0:T.value)||"gram"}))}),o}function U(){let i=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var u,t,p,b,G,w,x,N,$,f;let o=((t=(u=a.querySelector(".oil-typeahead"))==null?void 0:u.value)==null?void 0:t.trim())||"",r=((p=a.querySelector(".oil-grams"))==null?void 0:p.value)||"",d=((b=a.querySelector(".oil-percent"))==null?void 0:b.value)||"",s=((G=a.querySelector(".oil-sap-koh"))==null?void 0:G.value)||"",q=((w=a.querySelector(".oil-iodine"))==null?void 0:w.value)||"",E=((x=a.querySelector(".oil-fatty"))==null?void 0:x.value)||"",T=((N=a.querySelector(".oil-gi-id"))==null?void 0:N.value)||"",h=(($=a.querySelector(".oil-default-unit"))==null?void 0:$.value)||"",_=((f=a.querySelector(".oil-category"))==null?void 0:f.value)||"";!o&&!r&&!d&&!T||i.push({name:o,grams:r,percent:d,sap:s,iodine:q,fattyRaw:E,gi:T,defaultUnit:h,categoryName:_})}),i}function R(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let i=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(o=>{var h,_,u,t,p,b,G;let r=((_=(h=o.querySelector(".fragrance-typeahead"))==null?void 0:h.value)==null?void 0:_.trim())||"",d=((u=o.querySelector(".fragrance-grams"))==null?void 0:u.value)||"",s=((t=o.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",q=((p=o.querySelector(".fragrance-gi-id"))==null?void 0:p.value)||"",E=((b=o.querySelector(".fragrance-default-unit"))==null?void 0:b.value)||"",T=((G=o.querySelector(".fragrance-category"))==null?void 0:G.value)||"";!r&&!d&&!s&&!q||i.push({name:r,grams:d,percent:s,gi:q,defaultUnit:E,categoryName:T})}),i}function m(i,a){let o=document.getElementById("oilRows");if(!o||!i)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=i.name||"",r.querySelector(".oil-grams").value=i.grams||"",r.querySelector(".oil-percent").value=i.percent||"",r.querySelector(".oil-sap-koh").value=i.sap||"",r.querySelector(".oil-iodine").value=i.iodine||"",r.querySelector(".oil-fatty").value=i.fattyRaw||"",r.querySelector(".oil-gi-id").value=i.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=i.defaultUnit||"");let s=r.querySelector(".oil-category");s&&(s.value=i.categoryName||"");let q=Array.from(o.children);return a>=q.length?o.appendChild(r):o.insertBefore(r,q[a]),r}function C(){var o,r,d,s,q,E,T,h,_,u,t,p,b,G,w,x,N,$,f,I,v,S,L,M,D,Q,j;let i=y();if(!i)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:U(),lye_form:{superfat:((o=document.getElementById("lyeSuperfat"))==null?void 0:o.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((s=document.getElementById("waterMethod"))==null?void 0:s.value)||"percent",water_pct:((q=document.getElementById("waterPct"))==null?void 0:q.value)||"",lye_concentration:((E=document.getElementById("lyeConcentration"))==null?void 0:E.value)||"",water_ratio:((T=document.getElementById("waterRatio"))==null?void 0:T.value)||""},additives:{fragrances:R(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((h=document.getElementById("additiveLactateName"))==null?void 0:h.value)||"",lactate_gi:((_=document.getElementById("additiveLactateGi"))==null?void 0:_.value)||"",lactate_unit:((u=document.getElementById("additiveLactateUnit"))==null?void 0:u.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((p=document.getElementById("additiveSugarName"))==null?void 0:p.value)||"",sugar_gi:((b=document.getElementById("additiveSugarGi"))==null?void 0:b.value)||"",sugar_unit:((G=document.getElementById("additiveSugarUnit"))==null?void 0:G.value)||"",sugar_category:((w=document.getElementById("additiveSugarCategory"))==null?void 0:w.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((x=document.getElementById("additiveSaltName"))==null?void 0:x.value)||"",salt_gi:((N=document.getElementById("additiveSaltGi"))==null?void 0:N.value)||"",salt_unit:(($=document.getElementById("additiveSaltUnit"))==null?void 0:$.value)||"",salt_category:((f=document.getElementById("additiveSaltCategory"))==null?void 0:f.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((I=document.getElementById("additiveCitricName"))==null?void 0:I.value)||"",citric_gi:((v=document.getElementById("additiveCitricGi"))==null?void 0:v.value)||"",citric_unit:((S=document.getElementById("additiveCitricUnit"))==null?void 0:S.value)||"",citric_category:((L=document.getElementById("additiveCitricCategory"))==null?void 0:L.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((M=document.getElementById("moldShape"))==null?void 0:M.value)||"loaf",cylinder_correction:!!((D=document.getElementById("moldCylinderCorrection"))!=null&&D.checked),cylinder_factor:((Q=document.getElementById("moldCylinderFactor"))==null?void 0:Q.value)||"0.85"},quality:{preset:((j=document.getElementById("qualityPreset"))==null?void 0:j.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(W=>W.id)},lines:{ingredients:K("tool-ingredients","ingredient"),consumables:K("tool-consumables","consumable"),containers:K("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{i.setItem(A,JSON.stringify(a));let W=document.getElementById("soapLastSaved");W&&(W.textContent=c(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function O(){var s,q,E;let i=y();if(!i)return;let a=i.getItem(A);if(!a)return;let o=null;try{o=JSON.parse(a)}catch{return}if(!o||typeof o!="object")return;if(o.unit){let T=document.querySelector(`input[name="weight_unit"][value="${o.unit}"]`);T&&(T.checked=!0),e.units.setUnit(o.unit,{skipConvert:!0,skipAutoCalc:!0})}o.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=o.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(o.oils)&&o.oils.length?o.oils:[{}]).forEach(h=>{let _=e.oils.buildOilRow();_.querySelector(".oil-typeahead").value=h.name||"",_.querySelector(".oil-grams").value=h.grams||"",_.querySelector(".oil-percent").value=h.percent||"",_.querySelector(".oil-sap-koh").value=h.sap||"",_.querySelector(".oil-iodine").value=h.iodine||"",_.querySelector(".oil-fatty").value=h.fattyRaw||"",_.querySelector(".oil-gi-id").value=h.gi||"";let u=_.querySelector(".oil-default-unit");u&&(u.value=h.defaultUnit||"");let t=_.querySelector(".oil-category");t&&(t.value=h.categoryName||""),r.appendChild(_)})),o.lye_form){let T=document.getElementById("lyeSuperfat");T&&(T.value=o.lye_form.superfat||"5");let h=document.querySelector(`input[name="lye_type"][value="${o.lye_form.lye_type||"NaOH"}"]`);h&&(h.checked=!0);let _=document.getElementById("lyePurity");_&&(_.value=o.lye_form.lye_purity||"100");let u=document.getElementById("waterMethod");u&&(u.value=o.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=o.lye_form.water_pct||"");let p=document.getElementById("lyeConcentration");p&&(p.value=o.lye_form.lye_concentration||"");let b=document.getElementById("waterRatio");b&&(b.value=o.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(o.additives){let T=document.getElementById("fragranceRows");if(T&&((s=e.fragrances)!=null&&s.buildFragranceRow)){T.innerHTML="";let M=Array.isArray(o.additives.fragrances)&&o.additives.fragrances.length?o.additives.fragrances:null;if(M)M.forEach(D=>{let Q=e.fragrances.buildFragranceRow();Q.querySelector(".fragrance-typeahead").value=D.name||"",Q.querySelector(".fragrance-grams").value=D.grams||"",Q.querySelector(".fragrance-percent").value=D.percent||"",Q.querySelector(".fragrance-gi-id").value=D.gi||"";let j=Q.querySelector(".fragrance-default-unit");j&&(j.value=D.defaultUnit||"");let W=Q.querySelector(".fragrance-category");W&&(W.value=D.categoryName||""),T.appendChild(Q)});else if(o.additives.fragrance_pct||o.additives.fragrance_name||o.additives.fragrance_gi){let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=o.additives.fragrance_name||"",D.querySelector(".fragrance-percent").value=o.additives.fragrance_pct||"3",D.querySelector(".fragrance-gi-id").value=o.additives.fragrance_gi||"",T.appendChild(D)}}document.getElementById("additiveLactatePct").value=o.additives.lactate_pct||"1";let h=document.getElementById("additiveLactateName");h&&(h.value=o.additives.lactate_name||"");let _=document.getElementById("additiveLactateGi");_&&(_.value=o.additives.lactate_gi||"");let u=document.getElementById("additiveLactateUnit");u&&(u.value=o.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=o.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=o.additives.sugar_pct||"1";let p=document.getElementById("additiveSugarName");p&&(p.value=o.additives.sugar_name||"");let b=document.getElementById("additiveSugarGi");b&&(b.value=o.additives.sugar_gi||"");let G=document.getElementById("additiveSugarUnit");G&&(G.value=o.additives.sugar_unit||"");let w=document.getElementById("additiveSugarCategory");w&&(w.value=o.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=o.additives.salt_pct||"0.5";let x=document.getElementById("additiveSaltName");x&&(x.value=o.additives.salt_name||"");let N=document.getElementById("additiveSaltGi");N&&(N.value=o.additives.salt_gi||"");let $=document.getElementById("additiveSaltUnit");$&&($.value=o.additives.salt_unit||"");let f=document.getElementById("additiveSaltCategory");f&&(f.value=o.additives.salt_category||""),document.getElementById("additiveCitricPct").value=o.additives.citric_pct||"0";let I=document.getElementById("additiveCitricName");I&&(I.value=o.additives.citric_name||"");let v=document.getElementById("additiveCitricGi");v&&(v.value=o.additives.citric_gi||"");let S=document.getElementById("additiveCitricUnit");S&&(S.value=o.additives.citric_unit||"");let L=document.getElementById("additiveCitricCategory");L&&(L.value=o.additives.citric_category||"")}if(o.mold){document.getElementById("moldWaterWeight").value=o.mold.water_weight||"",document.getElementById("moldOilPct").value=o.mold.oil_pct||"65";let T=document.getElementById("moldShape");T&&(T.value=o.mold.shape||"loaf");let h=document.getElementById("moldCylinderCorrection");h&&(h.checked=!!o.mold.cylinder_correction);let _=document.getElementById("moldCylinderFactor");_&&(_.value=o.mold.cylinder_factor||"0.85");let u=document.getElementById("oilTotalTarget");(q=e.mold)!=null&&q.syncMoldPctFromTarget&&((E=e.mold)!=null&&E.syncTargetFromMold)&&(e.units.toGrams(u==null?void 0:u.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(o.quality){let T=document.getElementById("qualityPreset");if(T){let h=o.quality.preset||"balanced",_=Array.from(T.options).find(u=>u.value===h);T.value=_?h:"balanced"}document.querySelectorAll(".quality-focus").forEach(h=>{h.checked=Array.isArray(o.quality.focus)&&o.quality.focus.includes(h.id)})}function d(T,h,_){let u=document.getElementById(T);u&&(u.innerHTML="",(h||[]).forEach(t=>{let p=e.runner.buildLineRow(_),b=p.querySelector(".tool-typeahead"),G=p.querySelector(".tool-gi-id"),w=p.querySelector(".tool-qty"),x=p.querySelector(".tool-unit");b&&(b.value=t.name||""),G&&(G.value=t.global_item_id||""),w&&t.quantity!==void 0&&t.quantity!==null&&(w.value=t.quantity),x&&t.unit&&Array.from(x.options).find($=>$.value===t.unit)&&(x.value=t.unit),u.appendChild(p)}))}if(o.lines&&(d("tool-ingredients",o.lines.ingredients,"ingredient"),d("tool-consumables",o.lines.consumables,"consumable"),d("tool-containers",o.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(o.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),o.updated_at){let T=document.getElementById("soapLastSaved");T&&(T.textContent=c(o.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let g=null;function P(){g&&clearTimeout(g),g=setTimeout(C,350)}let n=null;function l(){n&&clearTimeout(n),n=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:C,restoreState:O,serializeLines:K,serializeOils:U,restoreOilRow:m,queueStateSave:P,queueAutoCalc:l}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{toNumber:c}=e.helpers,y=e.state;function A(n){return n&&typeof n=="object"&&n.export&&typeof n.export.csv_text=="string"&&n.export.csv_text.trim()&&typeof n.export.sheet_html=="string"&&n.export.sheet_html.trim()}function K(n){var a;let l=c(n==null?void 0:n.totalOils),i=(a=e.oils)!=null&&a.getTotalOilsGrams?e.oils.getTotalOilsGrams():0;return l<=0||i<=0?!1:Math.abs(l-i)>.01}async function U(){var l,i;let n=y.lastCalc;return(!n||K(n)||!A(n))&&(n=await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0})),n?A(n)?n:((i=e.ui)!=null&&i.showSoapAlert&&e.ui.showSoapAlert("danger","Export payload is missing. Please run the calculation again.",{dismissible:!0,timeoutMs:6e3}),null):((l=e.ui)!=null&&l.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function R(n,l){let i=new Blob([n],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=l,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function m(n){var i;let l=B.open("","_blank","width=960,height=720");if(!l){(i=e.ui)!=null&&i.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}l.document.open(),l.document.write(n),l.document.close(),l.focus(),l.onload=()=>l.print()}function C(){let n=document.getElementById("saveSoapTool");n&&n.addEventListener("click",async function(){try{let l=y.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!l)return;let i=e.runner.buildSoapRecipePayload(l);y.lastRecipePayload=i;try{let a=e.helpers.getStorage();a&&a.setItem("soap_recipe_payload",JSON.stringify(i))}catch{}B.SOAP_RECIPE_DTO=i,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}})}function O(){let n=document.getElementById("exportSoapCsv");n&&n.addEventListener("click",async function(){let l=await U();l&&R(l.export.csv_text,"soap_formula.csv")})}function g(){let n=document.getElementById("printSoapSheet");n&&n.addEventListener("click",async function(){let l=await U();l&&m(l.export.sheet_html)})}function P(){C(),O(),g()}e.eventsExports={bind:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},c=e.state;function y(m){if(!m)return;let C=document.getElementById("addOil"),O=document.getElementById("normalizeOils");C&&(C.dataset.bound="direct",C.addEventListener("click",function(){m.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),O&&(O.dataset.bound="direct",O.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),m.addEventListener("input",function(g){g.target.classList.contains("oil-grams")&&(c.lastOilEdit={row:g.target.closest(".oil-row"),field:"grams"}),g.target.classList.contains("oil-percent")&&(c.lastOilEdit={row:g.target.closest(".oil-row"),field:"percent"}),(g.target.classList.contains("oil-grams")||g.target.classList.contains("oil-percent")||g.target.classList.contains("oil-typeahead"))&&(g.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(g.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),m.addEventListener("focusin",function(g){g.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(g.target.closest(".oil-row"))}),m.addEventListener("focusout",function(g){g.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),g.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(g.target.closest(".oil-row"),"grams"),g.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(g.target.closest(".oil-row"),"percent")}),m.addEventListener("keydown",function(g){g.key==="Enter"&&(g.target.classList.contains("oil-grams")&&(g.preventDefault(),e.oils.validateOilEntry(g.target.closest(".oil-row"),"grams")),g.target.classList.contains("oil-percent")&&(g.preventDefault(),e.oils.validateOilEntry(g.target.closest(".oil-row"),"percent")))}),m.addEventListener("mouseover",function(g){if(!g.target.classList.contains("oil-typeahead"))return;let P=g.target.closest(".oil-row");!P||P===c.lastPreviewRow||(c.lastPreviewRow=P,e.oils.setSelectedOilProfileFromRow(P))}),m.addEventListener("mouseout",function(g){g.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),m.addEventListener("click",function(g){let P=g.target.closest(".oil-profile-open");if(P){let l=P.closest(".oil-row");if(l){e.oils.setSelectedOilProfileFromRow(l);let i=document.getElementById("oilProfileModal");i&&B.bootstrap&&B.bootstrap.Modal.getOrCreateInstance(i).show()}return}let n=g.target.closest(".remove-oil");if(n){let l=n.closest(".oil-row");l&&(c.lastRemovedOil=e.oils.serializeOilRow(l),c.lastRemovedOilIndex=Array.from(l.parentElement.children).indexOf(l),e.ui.showUndoToast("Oil removed.")),l&&c.lastOilEdit&&c.lastOilEdit.row===l&&(c.lastOilEdit=null,e.oils.clearSelectedOilProfile()),l&&l.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}})}function A(m){if(!m)return;let C=document.getElementById("addFragrance");C&&(C.dataset.bound="direct",C.addEventListener("click",function(){m.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),m.addEventListener("input",function(O){O.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:O.target.closest(".fragrance-row"),field:"grams"}),O.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:O.target.closest(".fragrance-row"),field:"percent"}),(O.target.classList.contains("fragrance-grams")||O.target.classList.contains("fragrance-percent")||O.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),m.addEventListener("click",function(O){var n;let g=O.target.closest(".remove-fragrance");if(!g)return;let P=g.closest(".fragrance-row");P&&((n=e.state.lastFragranceEdit)==null?void 0:n.row)===P&&(e.state.lastFragranceEdit=null),P&&P.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function K({oilRows:m,fragranceRows:C}){let O=document.getElementById("soapStageTabContent");if(!O)return;let g=()=>{let P=O.querySelector(".tab-pane.active")||O.querySelector(".tab-pane.show.active");return P?P.querySelector(".soap-stage-body")||P:null};O.addEventListener("wheel",P=>{let n=P.target;if(!(n instanceof HTMLElement))return;let l=n.closest('input[type="number"]');if(!(l instanceof HTMLInputElement))return;let i=g();if(!(i instanceof HTMLElement)||i.scrollHeight<=i.clientHeight+1)return;document.activeElement===l&&typeof l.blur=="function"&&l.blur();let a=i.scrollTop<=0,o=i.scrollTop+i.clientHeight>=i.scrollHeight-1;P.deltaY<0&&a||P.deltaY>0&&o||(i.scrollTop+=P.deltaY,P.preventDefault())},{passive:!1}),O.addEventListener("click",P=>{let n=P.target.closest("[data-stage-action]"),l=P.target.closest("[data-soap-action]");if(!n&&!l)return;if(P.preventDefault(),P.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),l){if(l.dataset.bound==="direct")return;let o=l.dataset.soapAction;o==="add-oil"&&m&&(m.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),o==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),o==="add-fragrance"&&C&&(C.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let i=n.dataset.stageAction,a=Number(n.dataset.stageIndex);Number.isNaN(a)||(i==="prev"&&e.stages.openStageByIndex(Math.max(0,a-1)),i==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,a+1)),i==="reset"&&e.stages.resetStage(a+1))})}function U(){let m=document.getElementById("soapUndoRemove");m&&m.addEventListener("click",()=>{c.lastRemovedOil&&(e.storage.restoreOilRow(c.lastRemovedOil,c.lastRemovedOilIndex||0),c.lastRemovedOil=null,c.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}function R(){let m=document.getElementById("oilRows"),C=document.getElementById("fragranceRows");return y(m),A(C),K({oilRows:m,fragranceRows:C}),U(),{oilRows:m,fragranceRows:C}}e.eventsRows={bind:R}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function c(){let n=document.getElementById("soapStageTabList");if(!n)return;let l=()=>{n.querySelectorAll(".nav-item").forEach(a=>a.classList.remove("is-expanded"));let i=n.querySelector(".nav-link.active");i&&i.closest(".nav-item")&&i.closest(".nav-item").classList.add("is-expanded")};n.addEventListener("shown.bs.tab",()=>{l(),e.layout.scheduleStageHeightSync()}),l()}function y(){let n=document.getElementById("resultsCardToggle"),l=document.getElementById("resultsCard");!n||!l||n.addEventListener("click",()=>{l.classList.toggle("is-collapsed");let i=l.classList.contains("is-collapsed");n.setAttribute("aria-expanded",(!i).toString());let a=i?"Expand formula details":"Collapse formula details";n.setAttribute("aria-label",a),n.setAttribute("title",a);let o=n.querySelector("i");o&&(o.classList.toggle("fa-chevron-down",i),o.classList.toggle("fa-chevron-up",!i))})}function A(){document.querySelectorAll('input[name="weight_unit"]').forEach(n=>{n.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})})}function K(){let n=()=>{var s;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(s=e.mold)!=null&&s.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},l=document.getElementById("oilTotalTarget");l&&l.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let i=document.getElementById("moldWaterWeight");i&&i.addEventListener("input",function(){e.mold.syncTargetFromMold(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let a=document.getElementById("moldOilPct");a&&a.addEventListener("input",function(){e.mold.syncTargetFromMold(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let o=document.getElementById("moldShape");o&&o.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let r=document.getElementById("moldCylinderCorrection");r&&r.addEventListener("change",function(){e.mold.syncTargetFromMold(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let d=document.getElementById("moldCylinderFactor");d&&d.addEventListener("input",function(){e.mold.syncTargetFromMold(),n(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function U(){let n=document.getElementById("waterMethod");n&&n.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(l=>{l.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(l=>{let i=document.getElementById(l);i&&["input","change"].forEach(a=>{i.addEventListener(a,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})})}function R(){[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:l,weightId:i})=>{let a=document.getElementById(l),o=document.getElementById(i);a&&a.addEventListener("input",()=>{let r=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:i,sourceField:"pct",totalOils:r}),e.additives.updateAdditivesOutput(r),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),o&&o.addEventListener("input",()=>{let r=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:i,sourceField:"weight",totalOils:r}),e.additives.updateAdditivesOutput(r),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(l=>{l.addEventListener("input",()=>{e.storage.queueStateSave()})})}function m(){let n=document.getElementById("qualityPreset");n&&n.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(i=>{i.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let l=document.getElementById("applyQualityTargets");l&&l.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(i=>{i.addEventListener("click",()=>e.quality.applyQualityTargets()),i.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),e.quality.applyQualityTargets())})})}function C(){document.querySelectorAll(".stub-btn").forEach(l=>{l.addEventListener("click",function(){let i=this.dataset.stubKind,a=this.dataset.stubName;e.runner.addStubLine(i,a),e.storage.queueStateSave()})});let n=document.getElementById("soapToolPage");n&&(n.addEventListener("click",function(l){l.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),n.addEventListener("input",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses(),e.ui.flashStage(l.target.closest(".soap-stage-card")))}),n.addEventListener("change",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses())}))}function O(){let n=document.getElementById("addToolIngredient");n&&n.addEventListener("click",function(){let a=document.getElementById("tool-ingredients");a&&a.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let l=document.getElementById("addToolConsumable");l&&l.addEventListener("click",function(){let a=document.getElementById("tool-consumables");a&&a.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let i=document.getElementById("addToolContainer");i&&i.addEventListener("click",function(){let a=document.getElementById("tool-containers");a&&a.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()})}function g(){let n=document.getElementById("calcLyeBtn");n&&n.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()})}function P(){c(),y(),A(),K(),U(),R(),m(),C(),O(),g()}e.eventsForms={bind:P}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function c(){let A=document.getElementById("soapMobileDrawer"),K=document.getElementById("soapMobileDrawerContent"),U=document.getElementById("soapMobileDrawerTitle"),R=document.getElementById("soapDrawerEmpty"),m=document.getElementById("soapDrawerClose"),C=document.getElementById("soapQualityCard"),O=document.getElementById("resultsCard");if(!A||!K||!U||!C||!O)return;let g=C.parentElement,P=O.parentElement,n=new Map,l=null,i=()=>B.matchMedia("(max-width: 767px)").matches,a=u=>u==="quality"?C:O,o=u=>u==="quality"?g:P,r=u=>u==="quality"?"Display":"Results",d=u=>{let t=n.get(u);t||(t=document.createElement("div"),t.className="soap-card-placeholder",n.set(u,t)),t.style.height=`${u.offsetHeight}px`,u.parentElement&&u.parentElement!==K&&!t.parentElement&&u.parentElement.insertBefore(t,u)},s=u=>{u&&(d(u),K.appendChild(u))},q=(u,t)=>{let p=n.get(u);p&&p.parentElement?p.replaceWith(u):t&&u.parentElement!==t&&t.appendChild(u)},E=()=>{if(!R)return;let u=l==="results",t=getComputedStyle(O).display!=="none";R.classList.toggle("d-none",!u||t)},T=u=>{i()&&(l&&l!==u&&q(a(l),o(l)),s(a(u)),U.textContent=r(u),l=u,A.classList.add("is-open"),E())},h=()=>{l&&(q(a(l),o(l)),l=null,A.classList.remove("is-open"),E())};A.querySelectorAll("[data-drawer-target]").forEach(u=>{u.addEventListener("click",()=>{let t=u.dataset.drawerTarget;t&&(A.classList.contains("is-open")&&l===t?h():T(t))})}),m&&m.addEventListener("click",h),B.addEventListener("resize",()=>{!i()&&l&&h()}),new MutationObserver(()=>E()).observe(O,{attributes:!0,attributeFilter:["style","class"]})}function y(){c(),B.addEventListener("resize",e.layout.scheduleStageHeightSync),B.addEventListener("load",e.layout.scheduleStageHeightSync)}e.eventsMobile={bind:y}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{},{LACTATE_CATEGORY_SET:c,SUGAR_CATEGORY_SET:y,SALT_CATEGORY_SET:A,CITRIC_CATEGORY_SET:K}=e.constants;function U({oilRows:R,fragranceRows:m}={}){var C,O;e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",c,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",y,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",A,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",K,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),R&&!R.querySelector(".oil-row")&&R.appendChild(e.oils.buildOilRow()),m&&!m.querySelector(".fragrance-row")&&(C=e.fragrances)!=null&&C.buildFragranceRow&&m.appendChild(e.fragrances.buildFragranceRow()),(O=e.fragrances)!=null&&O.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()}e.eventsInit={bind:U}})(window);(function(B){"use strict";let e=B.SoapTool=B.SoapTool||{};function c(){var A,K,U,R,m;let y=(A=e.eventsRows)!=null&&A.bind?e.eventsRows.bind():{oilRows:null,fragranceRows:null};(K=e.eventsForms)!=null&&K.bind&&e.eventsForms.bind(y),(U=e.eventsExports)!=null&&U.bind&&e.eventsExports.bind(y),(R=e.eventsMobile)!=null&&R.bind&&e.eventsMobile.bind(y),(m=e.eventsInit)!=null&&m.bind&&e.eventsInit.bind(y)}c()})(window);
