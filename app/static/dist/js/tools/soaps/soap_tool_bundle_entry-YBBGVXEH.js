(function(R){"use strict";let e={inventory:"Inventory",global:"Global Library"},l={inventory:"bg-primary",global:"bg-info text-dark"},g={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function x(i,s){let n;return function(){let I=arguments;clearTimeout(n),n=setTimeout(()=>i.apply(null,I),s)}}function W(i){return(i||"").trim().toLowerCase()}function M(i){if(i)return i;let s=document.createElement("div");return s.className="list-group position-absolute w-100 d-none inventory-suggestions",s.style.zIndex="1050",s.style.maxHeight="300px",s.style.overflowY="auto",s}function B(i){return typeof i=="function"?i():i}function E(i){let s=new Set;return(i||[]).forEach(n=>{let I=n&&(n.global_item_id||n.id);I&&s.add(String(I))}),s}function S(i){if(!i)return"";let s=e[i]||i;return`<span class="badge ${l[i]||"bg-secondary"} ms-2">${s}</span>`}function u(i,s,n,I){I=I||{},i.innerHTML="";let A=!1;if(s.forEach(w=>{!w.items||!w.items.length||(A=!0,w.items.forEach(b=>{let N=document.createElement("a");N.href="#",N.className="list-group-item list-group-item-action suggestion-item";let C=I.showSubtitle&&b.subtitle?`<div class="small text-muted mt-1">${b.subtitle}</div>`:"";N.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${b.text||b.display_name||b.name||""}</span>
          ${I.showSourceBadge?S(w.source||b.source):""}
        </div>${C}`,N.addEventListener("click",function(t){t.preventDefault(),n(b,w.source||b.source),i.classList.add("d-none")}),i.appendChild(N)}))}),i.classList.toggle("d-none",!A),!A&&i.dataset.emptyMessage){let w=document.createElement("div");w.className="list-group-item text-muted small",w.textContent=i.dataset.emptyMessage,i.appendChild(w),i.classList.remove("d-none")}}function O(i,s,n){i.innerHTML="";let I=!1;s.forEach(A=>{if(!A.ingredients||!A.ingredients.length)return;I=!0;let w=document.createElement("div");w.className="list-group-item text-muted small fw-semibold",w.textContent=A.title,i.appendChild(w),A.ingredients.forEach(b=>{let N=document.createElement("div");N.className="list-group-item ingredient-result";let C=document.createElement("div");C.className="d-flex justify-content-between align-items-center ingredient-summary",C.setAttribute("role","button"),C.setAttribute("tabindex","0"),C.innerHTML=`<span class="fw-semibold">${b.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${b.forms.length} option${b.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",b.forms.forEach(y=>{let T=document.createElement("button");T.type="button",T.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",T.innerHTML=`<div class="fw-semibold">${y.text||y.display_name||y.name||"Form"}</div>`,T.addEventListener("click",function(){n(y,y.source||A.source),i.classList.add("d-none")}),t.appendChild(T)});function d(y){y.type==="keydown"&&y.key!=="Enter"&&y.key!==" "||(y.preventDefault(),t.classList.toggle("d-none"))}C.addEventListener("click",d),C.addEventListener("keydown",d),N.appendChild(C),N.appendChild(t),i.appendChild(N),b.forms.length===1&&t.classList.remove("d-none")})}),i.classList.toggle("d-none",!I)}function G(i,s,n){i.innerHTML="";let I=!1;if((s||[]).forEach(A=>{I=!0;let w=document.createElement("a");w.href="#",w.className="list-group-item list-group-item-action suggestion-item";let b=A.inci_name?`<div class="small text-muted">${A.inci_name}</div>`:"";w.innerHTML=`<div class="fw-semibold">${A.text||A.name}</div>${b}`,w.addEventListener("click",function(N){N.preventDefault(),n(A,"definition"),i.classList.add("d-none")}),i.appendChild(w)}),i.classList.toggle("d-none",!I),!I&&i.dataset.emptyMessage){let A=document.createElement("div");A.className="list-group-item text-muted small",A.textContent=i.dataset.emptyMessage,i.appendChild(A),i.classList.remove("d-none")}}function o(i){let s=[];return(i||[]).forEach(n=>{if(n&&Array.isArray(n.forms)&&n.forms.length){let I=n.ingredient&&n.ingredient.name||n.ingredient_name||null,A=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null,w=n.category_tags||[];n.forms.forEach(b=>{var t,d,y,T,p,P,Q,K,r,f;let N=b.physical_form||{},C=b.display_name||b.text||b.name||(I&&b.physical_form_name?`${I}, ${b.physical_form_name}`:n.display_name||n.text||n.name||"");s.push({id:b.id,text:C,item_type:b.item_type||n.item_type,default_unit:b.default_unit||b.unit||n.default_unit||n.unit||null,source:"global",global_item_id:b.id,ingredient_id:b.ingredient_id||n.ingredient&&n.ingredient.id||n.ingredient_id||null,ingredient_name:b.ingredient_name||I,physical_form_id:b.physical_form_id||N&&N.id||null,physical_form_name:b.physical_form_name||N&&N.name||null,ingredient_category_name:A,category_tags:w,density:b.density||n.density||null,capacity:b.capacity||n.capacity||null,capacity_unit:b.capacity_unit||n.capacity_unit||null,container_material:b.container_material||n.container_material||null,container_type:b.container_type||n.container_type||null,container_style:b.container_style||n.container_style||null,container_color:b.container_color||n.container_color||null,default_is_perishable:(t=b.default_is_perishable)!=null?t:n.default_is_perishable,recommended_shelf_life_days:(d=b.recommended_shelf_life_days)!=null?d:n.recommended_shelf_life_days,saponification_value:(T=(y=b.saponification_value)!=null?y:n.saponification_value)!=null?T:null,iodine_value:(P=(p=b.iodine_value)!=null?p:n.iodine_value)!=null?P:null,fatty_acid_profile:(K=(Q=b.fatty_acid_profile)!=null?Q:n.fatty_acid_profile)!=null?K:null,melting_point_c:(f=(r=b.melting_point_c)!=null?r:n.melting_point_c)!=null?f:null})})}else if(n){let I=n.display_name||n.text||n.name||"",A=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null;s.push({id:n.id,text:I,source:"global",item_type:n.item_type,global_item_id:n.id,ingredient_name:n.ingredient&&n.ingredient.name||n.ingredient_name||n.name,ingredient_category_name:A,category_tags:n.category_tags||[],physical_form_name:n.physical_form&&n.physical_form.name||n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,density:n.density||null,capacity:n.capacity||null,capacity_unit:n.capacity_unit||null,container_material:n.container_material||null,container_type:n.container_type||null,container_style:n.container_style||null,container_color:n.container_color||null,default_is_perishable:n.default_is_perishable,recommended_shelf_life_days:n.recommended_shelf_life_days,saponification_value:n.saponification_value||null,iodine_value:n.iodine_value||null,fatty_acid_profile:n.fatty_acid_profile||null,melting_point_c:n.melting_point_c||null})}}),s}function c(i){let s=new Map;return(i||[]).forEach(n=>{let I=n.ingredient_name||n.text||n.name||"",A=n.ingredient_id?`id:${n.ingredient_id}`:`name:${W(I)}`,w=s.get(A)||{ingredient_id:n.ingredient_id||null,name:I,forms:[]};w.forms.push({id:n.id,text:n.text||I,ingredient_name:I,physical_form_name:n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,source:"inventory",global_item_id:n.global_item_id||null}),s.set(A,w)}),Array.from(s.values())}function h(i,s){let n=[];return(i||[]).forEach(I=>{let A=(I.forms||[]).map(b=>({id:b.id,text:b.name||b.display_name||b.text,ingredient_name:b.ingredient_name||I.name||I.ingredient&&I.ingredient.name||"Ingredient",physical_form_name:b.physical_form_name||null,default_unit:b.default_unit||b.unit||null,source:"global",global_item_id:b.id,density:b.density||null,capacity:b.capacity||null,capacity_unit:b.capacity_unit||null,container_material:b.container_material||null,container_type:b.container_type||null,container_style:b.container_style||null,container_color:b.container_color||null,saponification_value:b.saponification_value||null,iodine_value:b.iodine_value||null,fatty_acid_profile:b.fatty_acid_profile||null,melting_point_c:b.melting_point_c||null})),w=s?A.filter(b=>!b.global_item_id||!s.has(String(b.global_item_id))):A;w.length&&n.push({ingredient_id:I.ingredient_id||I.id||null,name:I.name||I.ingredient&&I.ingredient.name||A[0]&&A[0].ingredient_name||"Ingredient",forms:w})}),n}function L(i){let s=new URLSearchParams({q:i});return fetch(`/api/ingredients/definitions/search?${s.toString()}`).then(n=>n.json()).catch(()=>({results:[]}))}function a(i){let s={...g,...i},n=s.inputEl,I=s.invHiddenEl,A=s.giHiddenEl,w=M(s.listEl),b=s.mode||"recipe",N=s.searchType||"ingredient",C=s.includeInventory,t=s.includeGlobal,d=s.ingredientFirst,y=s.displayVariant,T=typeof s.resultFilter=="function"?s.resultFilter:null,p=typeof s.onSelection=="function"?s.onSelection:null,P=s.globalUrlBuilder;if(!n||!I&&b==="recipe"||!A&&s.requireHidden!==!1)return;w&&!w.classList.contains("list-group")&&w.classList.add("list-group"),!w.parentNode&&n.parentNode&&n.parentNode.appendChild(w);function Q(_,v){let m=new URLSearchParams({q:_});return v&&v!=="all"&&m.set("type",v),`/inventory/api/search?${m.toString()}`}function K(_,v,m){if(typeof P=="function")return P(_,v,m);let q=new URLSearchParams({q:_});return v&&v!=="all"&&q.set("type",v),v==="ingredient"&&m&&q.set("group","ingredient"),`${b==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${q.toString()}`}let r=x(function(){let _=(n.value||"").trim();if(!_){w.classList.add("d-none"),w.innerHTML="",I&&(I.value=""),A&&(A.value="");return}let v=(B(N)||"ingredient").toLowerCase(),m=B(C),q=B(t),$=v==="ingredient"&&!!B(d),U=y||($?"grouped":"compact");if(v==="ingredient_definition"||v==="definition"){L(_).then(k=>{let Y=k&&k.results||[];G(w,Y.map(z=>({id:z.id,text:z.name,name:z.name,inci_name:z.inci_name,slug:z.slug,ingredient_category_id:z.ingredient_category_id,ingredient_category_name:z.ingredient_category_name})),f)}).catch(()=>w.classList.add("d-none"));return}let H=m!==!1?fetch(Q(_,v)).then(k=>k.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),F=q!==!1?fetch(K(_,v,$)).then(k=>k.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([H,F]).then(k=>{let Y=k[0]&&k[0].results||[],z=k[1]&&k[1].results||[],X=T?Y.filter(ee=>T(ee,"inventory")):Y,J=T?z.filter(ee=>T(ee,"global")):z,te=E(X),oe=o(J).filter(ee=>!ee.global_item_id||!te.has(String(ee.global_item_id))).filter(ee=>T?T(ee,"global"):!0);if($){let ee=c(X),ae=h(J,te),re=[];ee.length&&re.push({title:"Your Inventory",source:"inventory",ingredients:ee}),ae.length&&re.push({title:"Global Library",source:"global",ingredients:ae}),O(w,re,f);return}let le=[];X.length&&le.push({title:"Your Inventory",source:"inventory",items:X}),oe.length&&le.push({title:"Global Library",source:"global",items:oe}),u(w,le,f,{showSourceBadge:s.showSourceBadge!==!1,showSubtitle:U==="detailed"})}).catch(()=>{w.classList.add("d-none")})},200);function f(_,v){n.value=_.text||_.display_name||_.name||"",v==="inventory"?(I&&(I.value=_.id_numeric||_.id||""),A&&(A.value=_.global_item_id||"")):(A&&(A.value=_.global_item_id||_.id||""),I&&(I.value="")),typeof p=="function"&&p(_,v)}n.addEventListener("input",function(){I&&(I.value=""),A&&(A.value=""),r()}),document.addEventListener("click",function(_){!w.contains(_.target)&&!n.contains(_.target)&&w.classList.add("d-none")})}R.attachMergedInventoryGlobalTypeahead=a,R.renderInventoryTypeaheadList=u})(window);(function(R){"use strict";function e(l,g){var x=g&&g.context||"public",W=g&&g.unitOptionsHtml||"",M=g&&g.mode||(x==="public"?"public":"recipe"),B=document.createElement("div");B.className="row g-2 align-items-end mb-2",B.innerHTML=['<div class="col-md-6">','  <label class="form-label">',l==="container"?"Container":l==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',l==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',l==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',W,"  </select>","</div>",'<div class="col-md-3 ',l!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var E=B.querySelector(".tool-typeahead"),S=B.querySelector(".tool-gi-id"),u=B.querySelector('[data-role="suggestions"]');if(typeof R.attachMergedInventoryGlobalTypeahead=="function"){let O=l==="container"?"container":l==="consumable"?"consumable":"ingredient",G=x!=="public";R.attachMergedInventoryGlobalTypeahead({inputEl:E,giHiddenEl:S,listEl:u,mode:M,context:x,ingredientFirst:l==="ingredient",searchType:O,includeInventory:G,includeGlobal:!0})}return B.querySelector(".tool-remove").addEventListener("click",function(){B.remove()}),B}R.buildToolLineRow=e})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};e.config={unitOptionsHtml:R.soapToolConfig&&R.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(R.SOAP_CALC_LIMIT)?R.SOAP_CALC_LIMIT:null,calcTier:R.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(R.soapToolConfig&&R.soapToolConfig.useCsvPrimary),isAuthenticated:R.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:l,toNumber:g,clamp:x,formatTime:W,getStorage:M,buildSoapcalcSearchBuilder:B};function l(E,S=3){if(!isFinite(E))return 0;let u=Math.pow(10,S);return Math.round(E*u)/u}function g(E){let S=E;typeof S=="string"&&(S=S.replace(/,/g,"").trim());let u=parseFloat(S);return isFinite(u)?u:0}function x(E,S,u){return!isFinite(E)||E<S?S:u!=null&&E>u?u:E}function W(E){return E?`Saved ${new Date(E).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function M(){try{return R.localStorage}catch{return null}}function B(){let E=(u,O,G)=>{let o=new URLSearchParams({q:u});return O&&O!=="all"&&o.set("type",O),O==="ingredient"&&G&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},S=(u,O,G)=>{let o=new URLSearchParams({q:u});return G&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?S:E}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l={quality_ranges:{hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},iodine_range:[41,70],iodine_scale_max:100,ins_range:[136,170],ins_scale_max:250,quality_base:{},fatty_display_keys:["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],unit_factors:{g:1,oz:28.3495,lb:453.592},stage_configs:[{id:1,tab_id:"soapStage1Tab",pane_id:"soapStage1Pane",required:!0},{id:2,tab_id:"soapStage2Tab",pane_id:"soapStage2Pane",required:!0},{id:3,tab_id:"soapStage3Tab",pane_id:"soapStage3Pane",required:!0},{id:4,tab_id:"soapStage4Tab",pane_id:"soapStage4Pane",required:!1},{id:5,tab_id:"soapStage5Tab",pane_id:"soapStage5Pane",required:!1}],ingredient_category_filters:{oils:["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"],fragrances:["Essential Oils","Fragrance Oils"],lactate_additives:["Aqueous Solutions & Blends","Preservatives & Additives"],sugar_additives:["Sugars & Syrups"],salt_additives:["Salts & Minerals"],citric_additives:["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]},citric_lye_factors:{NaOH:.624,KOH:.71},default_inputs:{unit:"g",mold_oil_pct:65,mold_shape:"loaf",mold_cylinder_correction:!1,mold_cylinder_factor:.85,lye_type:"NaOH",water_method:"percent",superfat_pct:5,lye_purity_pct:100,water_pct:33,lye_concentration_pct:33,water_ratio:2,additive_lactate_pct:1,additive_sugar_pct:1,additive_salt_pct:.5,additive_citric_pct:0,quality_preset:"balanced",fragrance_pct:3}};function g(U){return!U||typeof U!="object"||Array.isArray(U)?{}:U}function x(U,H=[]){return Array.isArray(U)?U.map(F=>typeof F=="string"?F.trim():"").filter(Boolean):H.slice()}function W(U,H){if(!Array.isArray(U)||U.length<2)return H.slice();let F=Number(U[0]),k=Number(U[1]);return!isFinite(F)||!isFinite(k)?H.slice():[F,k]}function M(U,H){let F=Number(U);return isFinite(F)?F:H}let B=g(R.soapToolPolicy),E={...l.quality_ranges,...g(B.quality_ranges)},S=g(B.quality_hints),u=g(B.quality_feel_hints),O={...l.quality_base,...g(B.quality_base)},G=g(B.quality_presets),o=g(B.fatty_bar_colors),c={...l.unit_factors,...g(B.unit_factors)},h={...l.ingredient_category_filters,...g(B.ingredient_category_filters)},L={hardness:W(E.hardness,l.quality_ranges.hardness),cleansing:W(E.cleansing,l.quality_ranges.cleansing),conditioning:W(E.conditioning,l.quality_ranges.conditioning),bubbly:W(E.bubbly,l.quality_ranges.bubbly),creamy:W(E.creamy,l.quality_ranges.creamy)},a={hardness:S.hardness||"",cleansing:S.cleansing||"",conditioning:S.conditioning||"",bubbly:S.bubbly||"",creamy:S.creamy||""},i={hardness:g(u.hardness),cleansing:g(u.cleansing),conditioning:g(u.conditioning),bubbly:g(u.bubbly),creamy:g(u.creamy)},s=W(B.iodine_range,l.iodine_range),n=M(B.iodine_scale_max,l.iodine_scale_max),I=W(B.ins_range,l.ins_range),A=M(B.ins_scale_max,l.ins_scale_max),w={hardness:M(O.hardness,(L.hardness[0]+L.hardness[1])/2),cleansing:M(O.cleansing,(L.cleansing[0]+L.cleansing[1])/2),conditioning:M(O.conditioning,(L.conditioning[0]+L.conditioning[1])/2),bubbly:M(O.bubbly,(L.bubbly[0]+L.bubbly[1])/2),creamy:M(O.creamy,(L.creamy[0]+L.creamy[1])/2)},b={balanced:{...w}};Object.entries(G).forEach(([U,H])=>{!H||typeof H!="object"||(b[U]={...H})});let N={...o},C=x(B.fatty_display_keys,l.fatty_display_keys),t=[],d={g:M(c.g,l.unit_factors.g),oz:M(c.oz,l.unit_factors.oz),lb:M(c.lb,l.unit_factors.lb)},T=(Array.isArray(B.stage_configs)?B.stage_configs:l.stage_configs).map((U,H)=>{let F=g(U),k=l.stage_configs[H]||{},Y=M(F.id,M(k.id,H+1)),z=F.tabId||F.tab_id||k.tabId||k.tab_id,X=F.paneId||F.pane_id||k.paneId||k.pane_id;return!z||!X?null:{id:Y,tabId:z,paneId:X,required:typeof F.required=="boolean"?F.required:!!k.required}}).filter(Boolean),p=T.length?T:l.stage_configs.map(U=>({id:U.id,tabId:U.tab_id,paneId:U.pane_id,required:!!U.required})),P=new Set(x(h.oils,l.ingredient_category_filters.oils)),Q=new Set(x(h.fragrances,l.ingredient_category_filters.fragrances)),K=new Set(x(h.lactate_additives,l.ingredient_category_filters.lactate_additives)),r=new Set(x(h.sugar_additives,l.ingredient_category_filters.sugar_additives)),f=new Set(x(h.salt_additives,l.ingredient_category_filters.salt_additives)),_=new Set(x(h.citric_additives,l.ingredient_category_filters.citric_additives)),v={...l.citric_lye_factors,...g(B.citric_lye_factors)},m={NaOH:M(v.NaOH,l.citric_lye_factors.NaOH),KOH:M(v.KOH,l.citric_lye_factors.KOH)},q={...l.default_inputs,...g(B.default_inputs)},$={unit:q.unit||l.default_inputs.unit,moldOilPct:M(q.mold_oil_pct,l.default_inputs.mold_oil_pct),moldShape:q.mold_shape||l.default_inputs.mold_shape,moldCylinderCorrection:!!q.mold_cylinder_correction,moldCylinderFactor:M(q.mold_cylinder_factor,l.default_inputs.mold_cylinder_factor),lyeType:q.lye_type||l.default_inputs.lye_type,waterMethod:q.water_method||l.default_inputs.water_method,superfatPct:M(q.superfat_pct,l.default_inputs.superfat_pct),lyePurityPct:M(q.lye_purity_pct,l.default_inputs.lye_purity_pct),waterPct:M(q.water_pct,l.default_inputs.water_pct),lyeConcentrationPct:M(q.lye_concentration_pct,l.default_inputs.lye_concentration_pct),waterRatio:M(q.water_ratio,l.default_inputs.water_ratio),additiveLactatePct:M(q.additive_lactate_pct,l.default_inputs.additive_lactate_pct),additiveSugarPct:M(q.additive_sugar_pct,l.default_inputs.additive_sugar_pct),additiveSaltPct:M(q.additive_salt_pct,l.default_inputs.additive_salt_pct),additiveCitricPct:M(q.additive_citric_pct,l.default_inputs.additive_citric_pct),qualityPreset:q.quality_preset||l.default_inputs.quality_preset,fragrancePct:M(q.fragrance_pct,l.default_inputs.fragrance_pct)};e.constants={QUALITY_RANGES:L,QUALITY_HINTS:a,QUALITY_FEEL_HINTS:i,IODINE_RANGE:s,IODINE_SCALE_MAX:n,INS_RANGE:I,INS_SCALE_MAX:A,QUALITY_BASE:w,QUALITY_PRESETS:b,FATTY_BAR_COLORS:N,FATTY_DISPLAY_KEYS:C,OIL_TIP_RULES:t,UNIT_FACTORS:d,STAGE_CONFIGS:p,OIL_CATEGORY_SET:P,FRAGRANCE_CATEGORY_SET:Q,LACTATE_CATEGORY_SET:K,SUGAR_CATEGORY_SET:r,SALT_CATEGORY_SET:f,CITRIC_CATEGORY_SET:_,CITRIC_LYE_FACTORS:m,DEFAULT_INPUTS:$}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:l}=e.helpers;function g(B){let E=0,S=0;return B.forEach(u=>{u.iodine>0&&(E+=u.grams,S+=u.iodine*u.grams)}),{iodine:E>0?S/E:0,coverageWeight:E}}function x(B){let E={},S=0;B.forEach(O=>{!O.fattyProfile||typeof O.fattyProfile!="object"||(S+=O.grams,Object.entries(O.fattyProfile).forEach(([G,o])=>{let c=l(o);c>0&&(E[G]=(E[G]||0)+O.grams*(c/100))}))});let u={};return S>0&&Object.entries(E).forEach(([O,G])=>{u[O]=G/S*100}),{percent:u,coveredWeight:S}}function W(B){let E=S=>B[S]||0;return{hardness:E("lauric")+E("myristic")+E("palmitic")+E("stearic"),cleansing:E("lauric")+E("myristic"),conditioning:E("oleic")+E("linoleic")+E("linolenic")+E("ricinoleic"),bubbly:E("lauric")+E("myristic")+E("ricinoleic"),creamy:E("palmitic")+E("stearic")+E("ricinoleic")}}function M(B){if(!B||typeof B!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let E={lauric:l(B.lauric),myristic:l(B.myristic),palmitic:l(B.palmitic),stearic:l(B.stearic),ricinoleic:l(B.ricinoleic),oleic:l(B.oleic),linoleic:l(B.linoleic),linolenic:l(B.linolenic)},S=W(E);return{hardness:(S.hardness||0)/100,cleansing:(S.cleansing||0)/100,conditioning:(S.conditioning||0)/100,bubbly:(S.bubbly||0)/100,creamy:(S.creamy||0)/100}}e.calc={computeIodine:g,computeFattyAcids:x,computeQualities:W,computeOilQualityScores:M},R.SoapCalcService=e.calc})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:l,toNumber:g,clamp:x}=e.helpers,{UNIT_FACTORS:W}=e.constants,M=e.state;function B(o){return x(g(o),0)*(W[M.currentUnit]||1)}function E(o){return x(o,0)/(W[M.currentUnit]||1)}function S(o){return!isFinite(o)||o<=0?"--":`${l(E(o),2)} ${M.currentUnit}`}function u(o){return isFinite(o)?`${l(o,1)}%`:"--"}function O(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=M.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=M.currentUnit})}function G(o,c={}){if(!o)return;if(o===M.currentUnit){O();return}let h=M.currentUnit;if(M.currentUnit=o,O(),c.skipConvert)return;let L=(W[h]||1)/(W[o]||1);document.querySelectorAll(".oil-grams").forEach(s=>{let n=g(s.value);n>0&&(s.value=l(n*L,2))}),document.querySelectorAll(".fragrance-grams").forEach(s=>{let n=g(s.value);n>0&&(s.value=l(n*L,2))});let a=document.getElementById("oilTotalTarget");if(a&&a.value){let s=g(a.value);s>0&&(a.value=l(s*L,2))}let i=document.getElementById("moldWaterWeight");if(i&&i.value){let s=g(i.value);s>0&&(i.value=l(s*L,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),c.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:B,fromGrams:E,formatWeight:S,formatPercent:u,updateUnitLabels:O,setUnit:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.state,g={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function x(a){a&&(a.classList.remove("soap-number-pulse"),a.offsetWidth,a.classList.add("soap-number-pulse"))}function W(a){var s;let i=document.getElementById(a);return!i||!((s=R.bootstrap)!=null&&s.Toast)?null:bootstrap.Toast.getOrCreateInstance(i)}function M(){let a=Date.now();if(a-l.lastSaveToastAt<3500)return;l.lastSaveToastAt=a;let i=W("soapAutosaveToast");i&&i.show()}function B(a){let i=document.getElementById("soapUndoToast");if(!i)return;let s=i.querySelector(".toast-body");s&&(s.textContent=a||"Oil removed.");let n=W("soapUndoToast");n&&n.show()}function E(){let a=document.getElementById("resultsReadyBadge"),i=document.getElementById("resultsUpdatedAt");a&&a.classList.remove("d-none"),i&&(i.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function S(a){let i=document.getElementById("lyeConcentrationWarning"),s=document.getElementById("waterRatioWarning");if(i){let n=(a==null?void 0:a.lyeConcentration)||0,I="";n>40&&(I="High concentration"),n>0&&n<25&&(I="Low concentration"),i.textContent=I,i.classList.toggle("d-none",!I)}if(s){let n=(a==null?void 0:a.waterRatio)||0,I="";n>0&&n<1.8&&(I="Low water"),n>2.7&&(I="High water"),s.textContent=I,s.classList.toggle("d-none",!I)}}function u(){document.querySelectorAll("#soapToolPage .form-text").forEach(a=>{let i=a.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");i&&i.classList.add("soap-field")})}function O(a){if(!a||a.type!=="number")return;let i=a.value;if(i===""){a.classList.remove("is-invalid");return}let s=parseFloat(i),n=a.getAttribute("min"),I=a.getAttribute("max"),A=n!==null&&n!==""&&s<parseFloat(n),w=I!==null&&I!==""&&s>parseFloat(I);a.classList.toggle("is-invalid",!isFinite(s)||A||w)}function G(a){var s;if(!a)return;let i=((s=a.querySelector)==null?void 0:s.call(a,".soap-stage-card"))||a;i.classList.add("soap-stage-highlight"),setTimeout(()=>i.classList.remove("soap-stage-highlight"),900)}function o(a){var I,A;let i=document.getElementById(a),s=(A=(I=i==null?void 0:i.content)==null?void 0:I.cloneNode)==null?void 0:A.call(I,!0);if(!s)return null;let n=s.firstElementChild||s.querySelector("*");return{fragment:s,root:n}}function c(a,i,s){if(!a)return;let n=Array.isArray(s)?s.filter(b=>typeof b=="string"&&b.trim()):[];if(!n.length){a.textContent="";return}let I=o("soapTitledListTemplate");if(I!=null&&I.root){let b=I.root.querySelector('[data-role="title"]'),N=I.root.querySelector('[data-role="list"]');b&&(b.textContent=i||""),N&&(N.innerHTML="",n.forEach(C=>{let t=document.createElement("li");t.textContent=C,N.appendChild(t)})),a.replaceChildren(I.fragment);return}a.innerHTML="";let A=document.createElement("strong");A.textContent=i||"";let w=document.createElement("ul");w.className="mb-0",n.forEach(b=>{let N=document.createElement("li");N.textContent=b,w.appendChild(N)}),a.appendChild(A),a.appendChild(w)}function h(a,i,s={}){var b;let n=document.getElementById("soapAlertStack");if(!n)return;let I=g[a]||g.info,A=o("soapAlertTemplate"),w=(A==null?void 0:A.root)||document.createElement("div");if(A){w.classList.add(`alert-${a}`);let N=w.querySelector('[data-role="icon"]');N&&N.classList.add(I);let C=w.querySelector('[data-role="message"]');C&&(C.innerHTML=i);let t=w.querySelector('[data-role="dismiss"]');t&&t.classList.toggle("d-none",!s.dismissible)}else{w.className="alert d-flex align-items-start gap-2";let N=document.createElement("i");N.className=`fas ${I} mt-1`;let C=document.createElement("div");if(C.className="flex-grow-1",C.innerHTML=i,w.appendChild(N),w.appendChild(C),s.dismissible){let t=document.createElement("button");t.type="button",t.className="btn-close",t.dataset.role="dismiss",w.appendChild(t)}}w.classList.add(`alert-${a}`,"d-flex","align-items-start","gap-2"),s.dismissible&&((b=w.querySelector('[data-role="dismiss"]'))==null||b.addEventListener("click",()=>w.remove())),n.prepend(w),s.persist||setTimeout(()=>{w.parentNode&&w.remove()},s.timeoutMs||4500)}function L(){let a=document.getElementById("soapAlertStack");a&&a.querySelectorAll(".alert").forEach(i=>i.remove())}e.ui={pulseValue:x,getToastInstance:W,showAutosaveToast:M,showUndoToast:B,updateResultsMeta:E,updateResultsWarnings:S,applyHelperVisibility:u,validateNumericField:O,flashStage:G,renderTitledList:c,showSoapAlert:h,clearSoapAlerts:L}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function l(){let x=document.getElementById("soapStagePane"),W=document.getElementById("soapQualityCard");if(!x||!W)return;if(!R.matchMedia("(min-width: 768px)").matches){x.classList.remove("is-height-synced"),x.style.removeProperty("--soap-stage-height");return}let B=W.offsetHeight;if(!B){x.classList.remove("is-height-synced"),x.style.removeProperty("--soap-stage-height");return}x.style.setProperty("--soap-stage-height",`${B}px`),x.classList.add("is-height-synced")}let g=()=>{R.requestAnimationFrame(l)};e.layout={syncStageHeight:l,scheduleStageHeightSync:g}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{clamp:l,toNumber:g,round:x}=e.helpers,{toGrams:W,fromGrams:M}=e.units;function B(){let o=O(),c=document.getElementById("oilTotalTarget"),h=document.getElementById("oilTargetHint");c&&o.effectiveCapacity>0&&W(c.value)<=0&&(c.value=o.targetOils>0?x(M(o.targetOils),2):""),h&&(o.effectiveCapacity>0?h.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":h.textContent="Auto-fills when mold sizing is set.");let L=document.getElementById("moldSuggestionNote");if(L){let a="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?a=`Cylinder correction applied (${x(o.cylinderFactor*100,0)}% of capacity).`:a="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),L.textContent=a}E()}function E(o=null){var b;let c=document.getElementById("moldWetBatterWarning");if(!c)return;let h=()=>{c.classList.add("d-none"),c.textContent=""},L=O(),a=e.state||{},i=a.lastCalc||null,s=(b=e.oils)!=null&&b.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,n=g(i==null?void 0:i.totalOils),I=g(o);if((!isFinite(I)||I<=0)&&(I=g(i==null?void 0:i.batchYield)),o==null&&n>0&&s>0&&Math.abs(n-s)>.01){h();return}if(!isFinite(I)||I<=0||L.effectiveCapacity<=0){h();return}let A=I-L.effectiveCapacity;if(A<=.01){h();return}let w=a.currentUnit||"g";c.textContent=`Full wet batter is ${x(M(I),2)} ${w}, exceeding mold capacity ${x(M(L.effectiveCapacity),2)} ${w} by ${x(M(A),2)} ${w}. Reduce oils target/% of mold or lower water/additives.`,c.classList.remove("d-none")}function S(){let o=document.getElementById("oilTotalTarget"),c=O();return o&&(c.effectiveCapacity>0&&(o.value=c.targetOils>0?x(M(c.targetOils),2):""),B()),c}function u(){let o=document.getElementById("oilTotalTarget"),c=document.getElementById("moldOilPct");if(!o||!c){let a=O();return B(),a}let h=O();if(h.effectiveCapacity>0){let a=W(o.value),i=l(a,0,h.effectiveCapacity);a>h.effectiveCapacity+.01&&(o.value=x(M(i),2));let s=i>0?i/h.effectiveCapacity*100:0;c.value=i>0?x(s,2):""}let L=O();return B(),L}function O(){var n,I,A;let o=W(document.getElementById("moldWaterWeight").value),c=l(g(document.getElementById("moldOilPct").value),0,100),h=((n=document.getElementById("moldShape"))==null?void 0:n.value)||"loaf",L=!!((I=document.getElementById("moldCylinderCorrection"))!=null&&I.checked),a=l(g((A=document.getElementById("moldCylinderFactor"))==null?void 0:A.value),.5,1),i=o>0?o*(L?a:1):0,s=i>0?i*(c/100):0;return{waterWeight:o,oilPct:c,shape:h,useCylinder:L,cylinderFactor:a,effectiveCapacity:i,targetOils:s}}function G(){var h;let o=((h=document.getElementById("moldShape"))==null?void 0:h.value)||"loaf",c=document.getElementById("moldCylinderOptions");c&&c.classList.toggle("d-none",o!=="cylinder"),B()}e.mold={updateMoldSuggested:B,updateWetBatterWarning:E,syncTargetFromMold:S,syncMoldPctFromTarget:u,getMoldSettings:O,updateMoldShapeUI:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:l,toNumber:g,clamp:x,buildSoapcalcSearchBuilder:W}=e.helpers,{toGrams:M,fromGrams:B}=e.units,{OIL_CATEGORY_SET:E}=e.constants,{computeQualities:S}=e.calc,u=e.state;function O(r){let f=r.querySelector(".oil-typeahead"),_=r.querySelector(".oil-sap-koh"),v=r.querySelector(".oil-iodine"),m=r.querySelector(".oil-fatty"),q=r.querySelector(".oil-gi-id"),$=r.querySelector(".oil-default-unit"),U=r.querySelector(".oil-category"),H=r.querySelector('[data-role="suggestions"]');if(!f||!H||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let F=W();R.attachMergedInventoryGlobalTypeahead({inputEl:f,listEl:H,mode:"public",giHiddenEl:q,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:F,searchType:"ingredient",resultFilter:(k,Y)=>Q(k,E,Y),requireHidden:!1,onSelection:function(k){_&&(_.value=(k==null?void 0:k.saponification_value)||""),v&&(v.value=(k==null?void 0:k.iodine_value)||""),m&&(m.value=k!=null&&k.fatty_acid_profile?JSON.stringify(k.fatty_acid_profile):""),$&&($.value=(k==null?void 0:k.default_unit)||""),U&&(U.value=(k==null?void 0:k.ingredient_category_name)||""),C(k),A(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),f.addEventListener("input",function(){this.value.trim()||(_&&(_.value=""),v&&(v.value=""),m&&(m.value=""),q&&(q.value=""),$&&($.value=""),U&&(U.value=""),d())})}function G(){var _,v;let r=document.getElementById("oilRowTemplate"),f=(v=(_=r==null?void 0:r.content)==null?void 0:_.querySelector(".oil-row"))==null?void 0:v.cloneNode(!0);return f?(f.querySelectorAll("input").forEach(m=>{m.value=""}),f.querySelectorAll(".form-text").forEach(m=>{let q=m.closest('.soap-field-stack, [class*="col-"]');q&&q.classList.add("soap-field")}),O(f),f.querySelectorAll(".unit-suffix").forEach(m=>{m.dataset.suffix=u.currentUnit}),f):document.createElement("div")}function o(){let r=document.getElementById("oilTotalTarget"),f=M(r==null?void 0:r.value);if(f>0)return f;let _=e.mold.getMoldSettings();return _.targetOils>0?_.targetOils:0}function c(r){let f=[];return r.forEach(v=>{var $,U;let m=M(($=v.querySelector(".oil-grams"))==null?void 0:$.value),q=x(g((U=v.querySelector(".oil-percent"))==null?void 0:U.value),0);m>0&&q>0&&f.push(m/(q/100))}),f.length?f.reduce((v,m)=>v+m,0)/f.length:0}function h(r,f){if(!r||!f||f<=0)return{allowedGrams:null,allowedPct:null};let _=Array.from(document.querySelectorAll("#oilRows .oil-row")),v=_.reduce((F,k)=>{var Y;return k===r?F:F+M((Y=k.querySelector(".oil-grams"))==null?void 0:Y.value)},0),m=_.reduce((F,k)=>{var Y;return k===r?F:F+x(g((Y=k.querySelector(".oil-percent"))==null?void 0:Y.value),0)},0),q=Math.max(0,100-m),$=Math.max(0,f-v),U=f*q/100;return{allowedGrams:Math.max(0,Math.min($,U)),allowedPct:q}}function L(r,f,_){if(!r)return;let v=r.querySelector(`[data-role="oil-${f}-hint"]`);v&&(_?(v.textContent=_,v.classList.add("is-visible")):(v.textContent="",v.classList.remove("is-visible")))}function a(r){r&&(r.classList.remove("oil-input-bounce"),r.offsetWidth,r.classList.add("oil-input-bounce"))}function i(r,f,_={}){let v=o();if(!r||!v||v<=0){L(r,f,"");return}let m=r.querySelector(".oil-grams"),q=r.querySelector(".oil-percent"),$=h(r,v);if(f==="grams"&&m){let U=M(m.value),H="";if(U>v+.01?H="Entry exceeds the max oils allowed in stage 2.":$.allowedGrams!==null&&U>$.allowedGrams+.01&&(H=`Must be under ${l(B($.allowedGrams),2)} ${u.currentUnit} to stay within the stage 2 oil limit.`),H){let F=$.allowedGrams!==null?l(B($.allowedGrams),2):l(B(v),2);m.value=F>0?F:"",L(r,f,H),m.classList.add("oil-input-warning"),a(m),A()}else m.classList.remove("oil-input-warning"),L(r,f,"")}if(f==="percent"&&q){let U=x(g(q.value),0),H="";if(U>100.01?H="Entry exceeds the max oils allowed in stage 2.":$.allowedPct!==null&&U>$.allowedPct+.01&&(H=`Must be under ${l($.allowedPct,2)}% to stay within the stage 2 oil limit.`),H){let F=$.allowedPct!==null?l($.allowedPct,2):100;q.value=F>0?F:"",L(r,f,H),q.classList.add("oil-input-warning"),a(q),A()}else q.classList.remove("oil-input-warning"),L(r,f,"")}}function s(r,f={}){let _=Array.from(document.querySelectorAll("#oilRows .oil-row")),v=r!=null?r:o(),m=!!f.force;if(!v||v<=0||!_.length){u.lastOilTarget=v;return}let q=_.reduce((U,H)=>{var F;return U+x(g((F=H.querySelector(".oil-percent"))==null?void 0:F.value),0)},0),$=_.reduce((U,H)=>{var F;return U+M((F=H.querySelector(".oil-grams"))==null?void 0:F.value)},0);if(q<=0&&$<=0){u.lastOilTarget=v;return}if(!(!m&&u.lastOilTarget&&Math.abs(u.lastOilTarget-v)<.01)){if(q>0)_.forEach(U=>{let H=U.querySelector(".oil-percent"),F=U.querySelector(".oil-grams"),k=x(g(H==null?void 0:H.value),0),Y=q>0?k/q:0;F&&(F.value=Y>0?l(B(v*Y),2):""),H&&(H.value=Y>0?l(Y*100,2):"")});else if($>0){let U=v/$;_.forEach(H=>{let F=H.querySelector(".oil-grams"),k=H.querySelector(".oil-percent"),Y=M(F==null?void 0:F.value);if(F){let z=Y>0?Y*U:0;F.value=z>0?l(B(z),2):""}if(k){let z=M(F==null?void 0:F.value);k.value=z>0?l(z/v*100,2):""}})}u.lastOilTarget=v,A({skipEnforce:!0})}}function n(r,f){if(!u.lastOilEdit||!u.lastOilEdit.row)return!1;let _=u.lastOilEdit.row,v=r.reduce((U,H)=>{var F;return H===_?U:U+M((F=H.querySelector(".oil-grams"))==null?void 0:F.value)},0),m=Math.max(0,f-v),q=_.querySelector(".oil-grams"),$=_.querySelector(".oil-percent");return!q||!$?!1:(q.value=m>0?l(B(m),2):"",$.value=m>0?l(m/f*100,2):"",u.wasCapped=!0,!0)}function I({totalWeight:r,totalPct:f,target:_,capped:v}){let m=document.getElementById("oilLimitWarning");if(!m)return;let q=[];if(v&&q.push("Oil total hit the mold cap and was adjusted."),_>0&&r>_+.01){let $=r-_;q.push(`Oil weights exceed the target by ${l(B($),2)} ${u.currentUnit}.`)}f>100.01&&q.push(`Oil percentages are over 100% by ${l(f-100,2)}%.`),q.length?(m.classList.remove("d-none"),m.textContent=`${q.join(" ")} Adjust oils or mold % to continue.`):(m.classList.add("d-none"),m.textContent="")}function A(r={}){var U;r.skipEnforce||(u.wasCapped=!1);let f=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=e.mold.getMoldSettings(),v=o();if(!v&&!_.targetOils){let H=c(f);if(H>0){v=H;let F=document.getElementById("oilTotalTarget");F&&!F.value&&(F.value=l(B(H),2))}}let m=0,q=0;if(f.forEach(H=>{let F=H.querySelector(".oil-grams"),k=H.querySelector(".oil-percent"),Y=M(F==null?void 0:F.value),z=x(g(k==null?void 0:k.value),0);v>0&&(u.lastOilEdit&&u.lastOilEdit.row===H&&u.lastOilEdit.field==="percent"?(Y=z>0?v*(z/100):0,F.value=z>0?l(B(Y),2):""):Y>0?(z=Y/v*100,k.value=l(z,2)):z>0&&(Y=v*(z/100),F.value=l(B(Y),2)),q+=z),Y>0&&(m+=Y)}),v<=0&&(m>0?(q=0,f.forEach(H=>{let F=H.querySelector(".oil-grams"),k=H.querySelector(".oil-percent"),Y=M(F==null?void 0:F.value);if(Y>0){let z=Y/m*100;k.value=l(z,2),q+=z}})):q=f.reduce((H,F)=>{var k;return H+x(g((k=F.querySelector(".oil-percent"))==null?void 0:k.value),0)},0)),!r.skipEnforce&&_.targetOils>0&&m>_.targetOils+.01&&n(f,_.targetOils))return A({skipEnforce:!0});u.totalOilsGrams=m;let $=document.getElementById("oilTotalComputed");return $&&($.textContent=m>0?`${l(B(m),2)} ${u.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=l(q,2),I({totalWeight:m,totalPct:q,target:v,capped:u.wasCapped}),e.additives.updateAdditivesOutput(m),(U=e.fragrances)!=null&&U.updateFragranceTotals&&e.fragrances.updateFragranceTotals(m),e.mold.updateMoldSuggested(),y(),{totalWeight:m,totalPct:q,target:v}}function w(){let r=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!r.length)return;let f=o(),_=r.reduce((v,m)=>{var q;return v+x(g((q=m.querySelector(".oil-percent"))==null?void 0:q.value),0)},0);!_&&f>0&&(_=r.reduce((v,m)=>{var $;let q=M(($=m.querySelector(".oil-grams"))==null?void 0:$.value);return v+(q>0?q/f*100:0)},0)),!(_<=0)&&(r.forEach(v=>{let m=v.querySelector(".oil-percent"),q=v.querySelector(".oil-grams"),U=x(g(m.value),0)/_*100;m.value=l(U,2),f>0&&(q.value=U>0?l(B(f*(U/100)),2):"")}),A())}function b(){let r=[];return document.querySelectorAll("#oilRows .oil-row").forEach(f=>{var Y,z,X,J,te,oe,le,ee,ae;let _=(z=(Y=f.querySelector(".oil-typeahead"))==null?void 0:Y.value)==null?void 0:z.trim(),v=M((X=f.querySelector(".oil-grams"))==null?void 0:X.value),m=g((J=f.querySelector(".oil-sap-koh"))==null?void 0:J.value),q=g((te=f.querySelector(".oil-iodine"))==null?void 0:te.value),$=((oe=f.querySelector(".oil-fatty"))==null?void 0:oe.value)||"",U=((le=f.querySelector(".oil-gi-id"))==null?void 0:le.value)||"",H=((ee=f.querySelector(".oil-default-unit"))==null?void 0:ee.value)||"",F=((ae=f.querySelector(".oil-category"))==null?void 0:ae.value)||"",k=null;if($)try{k=JSON.parse($)}catch{k=null}v<=0||r.push({name:_||null,grams:v,sapKoh:m,iodine:q,fattyProfile:k,global_item_id:U?parseInt(U):null,default_unit:H||null,ingredient_category_name:F||null})}),r}function N({name:r,sapKoh:f,iodine:_,fattyProfile:v}={}){let m=document.getElementById("oilProfileFloat"),q=(z,X)=>{let J=document.getElementById(z);J&&(J.textContent=X)},$=r||"Pick an oil to preview";q("selectedOilName",$),q("selectedOilModalName",$),m&&m.classList.toggle("d-none",!r);let U=f>0?l(f,1):"--",H=_>0?l(_,1):"--";q("selectedOilSap",U),q("selectedOilModalSap",U),q("selectedOilIodine",H),q("selectedOilModalIodine",H);let F=v?S(v):{},k=(z,X)=>{let J=isFinite(X)&&X>0?l(X,1):"--";q(z,J)};k("selectedOilHardness",F.hardness),k("selectedOilModalHardness",F.hardness),k("selectedOilCleansing",F.cleansing),k("selectedOilModalCleansing",F.cleansing),k("selectedOilConditioning",F.conditioning),k("selectedOilModalConditioning",F.conditioning),k("selectedOilBubbly",F.bubbly),k("selectedOilModalBubbly",F.bubbly),k("selectedOilCreamy",F.creamy),k("selectedOilModalCreamy",F.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(z=>{let X=`selectedOil${z.charAt(0).toUpperCase()}${z.slice(1)}`,J=`selectedOilModal${z.charAt(0).toUpperCase()}${z.slice(1)}`,te=v?g(v[z]):0,oe=te>0?l(te,1):"--";q(X,oe),q(J,oe)})}function C(r){if(!r){d();return}u.selectedOilProfile=r;let f=r.fatty_acid_profile||null;if(typeof f=="string")try{f=JSON.parse(f)}catch{f=null}N({name:r.text||r.display_name||r.name,sapKoh:g(r.saponification_value),iodine:g(r.iodine_value),fattyProfile:f})}function t(r){var $,U,H,F,k;if(!r)return;let f=(U=($=r.querySelector(".oil-typeahead"))==null?void 0:$.value)==null?void 0:U.trim(),_=g((H=r.querySelector(".oil-sap-koh"))==null?void 0:H.value),v=g((F=r.querySelector(".oil-iodine"))==null?void 0:F.value),m=((k=r.querySelector(".oil-fatty"))==null?void 0:k.value)||"",q=null;if(m)try{q=JSON.parse(m)}catch{q=null}N({name:f,sapKoh:_,iodine:v,fattyProfile:q})}function d(){u.selectedOilProfile=null,u.lastPreviewRow=null,N()}function y(){var q;let r=document.getElementById("oilBlendTips");if(!r)return;let f=u.lastCalc,_=u.totalOilsGrams||0,v=g(f==null?void 0:f.totalOils);if(!f||v<=0||_<=0||Math.abs(v-_)>.01){r.classList.add("d-none"),r.textContent="";return}let m=Array.isArray((q=f==null?void 0:f.qualityReport)==null?void 0:q.blend_tips)?f.qualityReport.blend_tips.filter($=>typeof $=="string"&&$.trim()).slice(0,6):[];if(!m.length){r.classList.add("d-none"),r.textContent="";return}r.classList.remove("d-none"),e.ui.renderTitledList(r,"Blend behavior tips:",m)}function T(r){let f=document.getElementById("oilBlendTips");if(!f)return;let _=Array.isArray(r)?r.filter(v=>typeof v=="string"&&v.trim()).slice(0,6):[];if(!_.length){f.classList.add("d-none"),f.textContent="";return}f.classList.remove("d-none"),e.ui.renderTitledList(f,"Blend behavior tips:",_)}function p(){return u.totalOilsGrams||0}function P(r){var f,_,v,m,q,$,U,H,F;return r?{name:((f=r.querySelector(".oil-typeahead"))==null?void 0:f.value)||"",grams:((_=r.querySelector(".oil-grams"))==null?void 0:_.value)||"",percent:((v=r.querySelector(".oil-percent"))==null?void 0:v.value)||"",sap:((m=r.querySelector(".oil-sap-koh"))==null?void 0:m.value)||"",iodine:((q=r.querySelector(".oil-iodine"))==null?void 0:q.value)||"",fattyRaw:(($=r.querySelector(".oil-fatty"))==null?void 0:$.value)||"",gi:((U=r.querySelector(".oil-gi-id"))==null?void 0:U.value)||"",defaultUnit:((H=r.querySelector(".oil-default-unit"))==null?void 0:H.value)||"",categoryName:((F=r.querySelector(".oil-category"))==null?void 0:F.value)||""}:null}function Q(r,f,_){let v=K(r);return v?f.has(v):_==="inventory"}function K(r){return!r||typeof r!="object"?null:r.ingredient&&r.ingredient.ingredient_category_name||r.ingredient_category_name||r.ingredient_category&&r.ingredient_category.name||null}e.oils={attachOilTypeahead:O,buildOilRow:G,getOilTargetGrams:o,updateOilTotals:A,normalizeOils:w,collectOilData:b,setSelectedOilProfileFromRow:t,clearSelectedOilProfile:d,updateOilTips:y,renderOilTips:T,getTotalOilsGrams:p,serializeOilRow:P,validateOilEntry:i,scaleOilsToTarget:s}})(window);(function(R){"use strict";var C;let e=R.SoapTool=R.SoapTool||{},l=e.bulkOils=e.bulkOils||{},{toNumber:g,clamp:x}=e.helpers,W=e.state,M=Array.isArray((C=e.constants)==null?void 0:C.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],B=new Set(["selected_pct","selected_weight_g"]),E=25,S=140,u=260,O={mode:"all",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function G(){var t,d;(d=(t=e.storage)==null?void 0:t.queueStateSave)==null||d.call(t)}function o(t,d){var y,T;(T=(y=e.ui)==null?void 0:y.showSoapAlert)==null||T.call(y,t,d,{dismissible:!0,timeoutMs:6e3})}function c(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function h(t){return t?t==="name"||B.has(t)?!0:M.includes(t):!1}function L(){(!W.bulkOilModal||typeof W.bulkOilModal!="object")&&(W.bulkOilModal=JSON.parse(JSON.stringify(O)));let t=W.bulkOilModal;return t.mode="all",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=h(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function a(t){let d={},y=t&&typeof t=="object"?t:{};return M.forEach(T=>{let p=g(y[T]);p>0&&(d[T]=p)}),d}function i(t){let d=a(t==null?void 0:t.fatty_profile),y=String((t==null?void 0:t.name)||"").trim(),T=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",p=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:g(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(p?`global:${p}`:`${T}:${y.toLowerCase()}`)),name:y,sap_koh:g(t==null?void 0:t.sap_koh),iodine:g(t==null?void 0:t.iodine),fatty_profile:d,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:p,source:T,is_basic:!!(t!=null&&t.is_basic)}}function s(){let t=c(),d=L(),y=Object.keys(d.selection||{}).length,T=`Selected: ${y}`;t.summaryEl&&(t.summaryEl.textContent=T),t.stageCountEl&&(t.stageCountEl.textContent=String(y))}function n(t){var y;return((y=L().selection)==null?void 0:y[t])||null}function I(t,d={}){var P,Q;let y=L();if(!t||!t.key)return null;let T=y.selection[t.key]||{},p={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:x(g((P=d.selected_pct)!=null?P:T.selected_pct),0,100),selected_weight_g:x(g((Q=d.selected_weight_g)!=null?Q:T.selected_weight_g),0)};return y.selection[t.key]=p,p}function A(t){var y;let d=L();(y=d.selection)!=null&&y[t]&&delete d.selection[t]}function w(t){var y;return((y=L().recordByKey)==null?void 0:y[t])||null}function b(){let t=L();return{mode:"all",view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(d=>({key:d.key,name:d.name,sap_koh:d.sap_koh,iodine:d.iodine,fatty_profile:d.fatty_profile||{},default_unit:d.default_unit,ingredient_category_name:d.ingredient_category_name,global_item_id:d.global_item_id,source:d.source,is_basic:!!d.is_basic,selected_pct:x(g(d.selected_pct),0,100),selected_weight_g:x(g(d.selected_weight_g),0)}))}}function N(t){let d=L();d.mode="all",d.viewSelected=!!(t!=null&&t.view_selected),d.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",d.sortKey=h(t==null?void 0:t.sort_key)?t.sort_key:"name",d.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let y={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(p=>{let P=String((p==null?void 0:p.key)||"").trim(),Q=String((p==null?void 0:p.name)||"").trim();!P||!Q||(y[P]={key:P,name:Q,sap_koh:g(p==null?void 0:p.sap_koh),iodine:g(p==null?void 0:p.iodine),fatty_profile:a(p==null?void 0:p.fatty_profile),default_unit:String((p==null?void 0:p.default_unit)||"gram"),ingredient_category_name:String((p==null?void 0:p.ingredient_category_name)||""),global_item_id:g(p==null?void 0:p.global_item_id)>0?parseInt(p.global_item_id,10):null,source:String((p==null?void 0:p.source)||"soapcalc"),is_basic:!!(p!=null&&p.is_basic),selected_pct:x(g(p==null?void 0:p.selected_pct),0,100),selected_weight_g:x(g(p==null?void 0:p.selected_weight_g),0)})}),d.selection=y,d.visibleRecords=[],d.offset=0,d.totalCount=0,d.hasMore=!0,d.loading=!1,s()}l.shared={FATTY_KEYS:M,LOCAL_SORT_KEYS:B,PAGE_SIZE:E,SCROLL_FETCH_THRESHOLD:S,SEARCH_DEBOUNCE_MS:u,queueStateSave:G,showAlert:o,getRefs:c,ensureModalState:L,normalizeFattyProfile:a,normalizeCatalogRecord:i,updateSelectionCounters:s,selectionForRecordKey:n,setSelection:I,removeSelection:A,getRecordByKey:w,serializeSelection:b,restoreState:N}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.bulkOils=e.bulkOils||{},g=l.shared;if(!g)return;let{round:x,toNumber:W}=e.helpers,{fromGrams:M}=e.units,{FATTY_KEYS:B,LOCAL_SORT_KEYS:E,getRefs:S,ensureModalState:u,selectionForRecordKey:O,updateSelectionCounters:G}=g;function o(C){let t=S();t.statusEl&&(t.statusEl.textContent=C)}function c(){let C=u();if(C.loading&&!C.visibleRecords.length){o("Loading oils...");return}if(!C.visibleRecords.length){let p=C.query?"No oils match that search.":"No oils available.";o(p);return}let t=C.visibleRecords.length,d=C.totalCount,y=C.hasMore?" \u2022 scroll for more":"",T=C.query?` \u2022 search: "${C.query}"`:"";o(`Showing ${t} of ${d} oils${T}${y}`)}function h(C,t,d){if(typeof C=="string"||typeof t=="string"){let p=String(C||"").toLowerCase(),P=String(t||"").toLowerCase();return p<P?d==="asc"?-1:1:p>P?d==="asc"?1:-1:0}let y=W(C),T=W(t);return y<T?d==="asc"?-1:1:y>T?d==="asc"?1:-1:0}function L(C,t){var d,y;return t==="selected_pct"?((d=O(C.key))==null?void 0:d.selected_pct)||0:t==="selected_weight_g"?((y=O(C.key))==null?void 0:y.selected_weight_g)||0:""}function a(){let C=u();E.has(C.sortKey)&&C.visibleRecords.sort((t,d)=>{let y=h(L(t,C.sortKey),L(d,C.sortKey),C.sortDir);return y!==0?y:h(t.name||"",d.name||"","asc")})}function i(){let C=u();if(!C.viewSelected)return;let t=[],d=[];C.visibleRecords.forEach(y=>{O(y.key)?t.push(y):d.push(y)}),C.visibleRecords=t.concat(d)}function s(){a(),i()}function n(C){let t=String(C||"").trim().toLowerCase();return t==="name"||B.includes(t)?t:"name"}function I(){let C=u();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let d=t.dataset.label||"",y=t.dataset.sortKey||"";C.sortKey===y?t.textContent=`${d} ${C.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=d})}function A(C,t){let d=O(t.key),y=C.querySelector(".bulk-oil-check"),T=C.querySelector(".bulk-oil-pct"),p=C.querySelector(".bulk-oil-weight");y&&(y.checked=!!d),T&&(T.value=d&&d.selected_pct>0?x(d.selected_pct,2):""),p&&(p.value=d&&d.selected_weight_g>0?x(M(d.selected_weight_g),2):"")}function w(C){let t=document.createElement("td");t.className="bulk-oil-acid";let d=W(C);return t.textContent=d>0?x(d,1).toString():"--",t}function b(C){let t=document.createElement("tr");t.dataset.recordKey=C.key;let d=document.createElement("td");d.className="text-center";let y=document.createElement("input");y.type="checkbox",y.className="form-check-input bulk-oil-check",d.appendChild(y),t.appendChild(d);let T=document.createElement("td");T.className="bulk-oil-name";let p=document.createElement("div");p.className="fw-semibold small",p.textContent=C.name;let P=document.createElement("div");P.className="text-muted small";let Q=C.ingredient_category_name?` \xB7 ${C.ingredient_category_name}`:"";P.textContent=`${C.source}${Q}`,T.appendChild(p),T.appendChild(P),t.appendChild(T),B.forEach(v=>{var m;t.appendChild(w((m=C.fatty_profile)==null?void 0:m[v]))});let K=document.createElement("td"),r=document.createElement("input");r.type="number",r.min="0",r.max="100",r.step="0.1",r.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",K.appendChild(r),t.appendChild(K);let f=document.createElement("td"),_=document.createElement("input");return _.type="number",_.min="0",_.step="0.1",_.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",f.appendChild(_),t.appendChild(f),A(t,C),t}function N(){let C=S(),t=u();if(!C.bodyEl)return;C.bodyEl.innerHTML="";let d=document.createDocumentFragment();t.visibleRecords.forEach(y=>{d.appendChild(b(y))}),C.bodyEl.appendChild(d),I(),G(),c()}l.render={updateStatusText:o,refreshCatalogStatus:c,applyLocalSelectionSortIfNeeded:a,applyViewSelectedOrderingIfNeeded:i,applyClientOrdering:s,normalizeServerSortKey:n,sortButtonsLabel:I,renderVisibleRecords:N}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.bulkOils=e.bulkOils||{},g=l.shared,x=l.render;if(!g||!x)return;let{PAGE_SIZE:W,getRefs:M,ensureModalState:B,normalizeCatalogRecord:E}=g,{refreshCatalogStatus:S,normalizeServerSortKey:u,applyClientOrdering:O,renderVisibleRecords:G,updateStatusText:o}=x;function c(){let L=B(),a=M();L.visibleRecords=[],L.offset=0,L.totalCount=0,L.hasMore=!0,a.bodyEl&&(a.bodyEl.innerHTML=""),a.scrollEl&&(a.scrollEl.scrollTop=0)}async function h({reset:L=!1}={}){let a=B();if(!M().modalEl||a.loading&&!L||!a.hasMore&&!L)return;L&&c();let s=a.requestToken+1;a.requestToken=s,a.loading=!0,S();let n=new URLSearchParams;n.set("mode",a.mode),n.set("offset",String(a.offset)),n.set("limit",String(W)),n.set("q",a.query||""),n.set("sort_key",u(a.sortKey)),n.set("sort_dir",a.sortDir==="desc"?"desc":"asc");try{let I=await fetch(`/tools/api/soap/oils-catalog?${n.toString()}`);if(!I.ok)throw new Error("Unable to load oils catalog");let A=await I.json();if(!A||A.success!==!0||!A.result||!Array.isArray(A.result.records))throw new Error("Invalid oils catalog response");if(s!==a.requestToken)return;let w=A.result.records.map(E),b=Math.max(0,parseInt(A.result.next_offset,10)||a.offset+w.length),N=Math.max(w.length,parseInt(A.result.count,10)||0),C=!!A.result.has_more;w.forEach(t=>{a.recordByKey[t.key]=t}),a.visibleRecords=L?w.slice():a.visibleRecords.concat(w),a.offset=b,a.totalCount=N,a.hasMore=C,O(),G()}catch(I){throw s===a.requestToken&&o("Unable to load oils catalog."),I}finally{s===a.requestToken&&(a.loading=!1,S())}}l.api={fetchCatalogPage:h}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.bulkOils=e.bulkOils||{},g=l.shared,x=l.render,W=l.api;if(!g||!x||!W)return;let{round:M,toNumber:B,clamp:E}=e.helpers,{toGrams:S,fromGrams:u}=e.units,O=e.state,{LOCAL_SORT_KEYS:G,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:c,queueStateSave:h,showAlert:L,getRefs:a,ensureModalState:i,updateSelectionCounters:s,setSelection:n,removeSelection:I,getRecordByKey:A,serializeSelection:w,restoreState:b}=g,{applyClientOrdering:N,sortButtonsLabel:C,renderVisibleRecords:t}=x,{fetchCatalogPage:d}=W,y=null,T=null;function p(){var j;let D=a();D.modalEl&&(!y&&((j=R.bootstrap)!=null&&j.Modal)&&(y=R.bootstrap.Modal.getOrCreateInstance(D.modalEl)),y&&y.hide())}function P(){return document.getElementById("oilRows")}function Q(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function K(D){return String(D||"").trim().toLowerCase()}function r(D){var j;return K((j=D==null?void 0:D.querySelector(".oil-typeahead"))==null?void 0:j.value)}function f(D){var V;let j=String(((V=D==null?void 0:D.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return j||""}function _(D,j){let V=String(D||"").trim();if(!V)return null;let Z=Q(),ne=Z.find(se=>String(se.dataset.bulkOilKey||"")===V);if(ne)return ne;let ie=String((j==null?void 0:j.global_item_id)||"").trim();if(ie&&(ne=Z.find(se=>f(se)===ie),ne))return ne;let ce=K(j==null?void 0:j.name);return ce&&(ne=Z.find(se=>r(se)===ce),ne)?ne:null}function v(D,j){if(!D||!j)return;D.dataset.bulkOilKey=j.key||"";let V=D.querySelector(".oil-typeahead"),Z=D.querySelector(".oil-sap-koh"),ne=D.querySelector(".oil-iodine"),ie=D.querySelector(".oil-fatty"),ce=D.querySelector(".oil-gi-id"),se=D.querySelector(".oil-default-unit"),ue=D.querySelector(".oil-category"),de=D.querySelector(".oil-grams"),fe=D.querySelector(".oil-percent");V&&(V.value=j.name||""),Z&&(Z.value=j.sap_koh>0?M(j.sap_koh,3):""),ne&&(ne.value=j.iodine>0?M(j.iodine,3):""),ie&&(ie.value=j.fatty_profile&&Object.keys(j.fatty_profile).length?JSON.stringify(j.fatty_profile):""),ce&&(ce.value=j.global_item_id||""),se&&(se.value=j.default_unit||""),ue&&(ue.value=j.ingredient_category_name||""),fe&&(fe.value=j.selected_pct>0?M(j.selected_pct,2):""),de&&(de.value=j.selected_weight_g>0?M(u(j.selected_weight_g),2):"")}function m(D){if(!D||!D.key)return null;let j=_(D.key,D),V=P();return!j&&V&&(j=e.oils.buildOilRow(),j&&V.appendChild(j)),v(j,D),j}function q(D,j){let V=_(D,j);V&&(O.lastOilEdit&&O.lastOilEdit.row===V&&(O.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function $(){Q().forEach(j=>{O.lastOilEdit&&O.lastOilEdit.row===j&&(O.lastOilEdit=null),j.remove()}),e.oils.clearSelectedOilProfile()}function U(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function H(D,j,V){let Z=String(V||"").trim();if(Z)return Z;let ne=String(j||"").trim();if(ne)return`global:${ne}`;let ie=K(D);return ie?`soapcalc:${ie}`:""}function F(){let D={};return Q().forEach(j=>{var Se,ve,he,_e,be,Ee,Ie,Ce,Te;let V=String(((Se=j.querySelector(".oil-typeahead"))==null?void 0:Se.value)||"").trim(),Z=B((ve=j.querySelector(".oil-sap-koh"))==null?void 0:ve.value),ne=B((he=j.querySelector(".oil-iodine"))==null?void 0:he.value),ie=String(((_e=j.querySelector(".oil-gi-id"))==null?void 0:_e.value)||"").trim(),ce=String(((be=j.querySelector(".oil-default-unit"))==null?void 0:be.value)||"gram"),se=String(((Ee=j.querySelector(".oil-category"))==null?void 0:Ee.value)||""),ue=E(B((Ie=j.querySelector(".oil-percent"))==null?void 0:Ie.value),0,100),de=E(S((Ce=j.querySelector(".oil-grams"))==null?void 0:Ce.value),0),fe=String(((Te=j.querySelector(".oil-fatty"))==null?void 0:Te.value)||""),ye={};if(fe)try{let qe=JSON.parse(fe);ye=g.normalizeFattyProfile(qe)}catch{ye={}}let me=H(V,ie,j.dataset.bulkOilKey);!me||!(V||ue>0||de>0||Z>0||ne>0||Object.keys(ye).length>0)||(j.dataset.bulkOilKey=me,D[me]={key:me,name:V||"Unnamed oil",sap_koh:Z,iodine:ne,fatty_profile:ye,default_unit:ce||"gram",ingredient_category_name:se,global_item_id:ie?parseInt(ie,10):null,source:ie?"global":"soapcalc",is_basic:!ie,selected_pct:ue,selected_weight_g:de})}),D}function k(){let D=i();D.selection=F(),s()}function Y(){let D=i(),j=Object.values(D.selection||{}),V=new Set(j.map(Z=>Z.key));Q().forEach(Z=>{let ne=String(Z.dataset.bulkOilKey||"").trim();(!ne||!V.has(ne))&&Z.remove()}),j.slice().sort((Z,ne)=>String(Z.name||"").localeCompare(String(ne.name||""))).forEach(Z=>{m(Z)}),U()}async function z(){var V;let D=a(),j=i();if(D.modalEl){k(),!y&&((V=R.bootstrap)!=null&&V.Modal)&&(y=R.bootstrap.Modal.getOrCreateInstance(D.modalEl)),D.searchInput&&(D.searchInput.value=j.query||""),D.viewSelectedToggle&&(D.viewSelectedToggle.checked=!!j.viewSelected),D.unitLabelEl&&(D.unitLabelEl.textContent=O.currentUnit||"g"),y&&y.show(),C(),s();try{await d({reset:!0})}catch{L("danger","Unable to load bulk oils catalog right now.")}}}function X(D){let j=D.target;if(!(j instanceof HTMLElement))return;let V=j.closest("tr[data-record-key]");if(!V)return;let Z=V.dataset.recordKey||"",ne=A(Z);if(!ne)return;let ie=V.querySelector(".bulk-oil-check"),ce=V.querySelector(".bulk-oil-pct"),se=V.querySelector(".bulk-oil-weight"),ue=E(B(ce==null?void 0:ce.value),0,100),de=E(S(se==null?void 0:se.value),0),fe=ue>0||de>0;if(!!(ie!=null&&ie.checked)||fe){ie&&(ie.checked=!0);let Se=n(ne,{selected_pct:ue,selected_weight_g:de});m(Se)}else I(Z),q(Z,ne);let me=i();G.has(me.sortKey)||me.viewSelected?(N(),t()):s(),U(),h()}function J(D){let j=i();j.viewSelected=!!D,N(),t(),h()}async function te(D){let j=D.target instanceof HTMLElement?D.target.closest(".bulk-oil-sort"):null;if(!j)return;let V=j.getAttribute("data-sort-key")||"name",Z=i();if(Z.sortKey===V?Z.sortDir=Z.sortDir==="asc"?"desc":"asc":(Z.sortKey=V,Z.sortDir=V==="name"?"asc":"desc"),h(),G.has(Z.sortKey)){N(),t();return}try{await d({reset:!0})}catch{L("danger","Unable to load oils in that sort order.")}}function oe(){let D=i();D.selection={},$(),(G.has(D.sortKey)||D.viewSelected)&&N(),t(),U(),h()}async function le(){let D=a(),j=i();if(!(!D.scrollEl||j.loading||!j.hasMore||!(D.scrollEl.scrollTop+D.scrollEl.clientHeight>=D.scrollEl.scrollHeight-o)))try{await d({reset:!1})}catch{L("danger","Unable to load more oils right now.")}}function ee(){T&&R.clearTimeout(T),T=R.setTimeout(async()=>{try{await d({reset:!0})}catch{L("danger","Unable to search oils right now.")}},c)}function ae(){Y(),h(),p()}function re(D,j){if(!(D instanceof HTMLInputElement))return!1;let Z=a().bodyEl;if(!(Z instanceof HTMLElement))return!1;let ne=D.classList.contains("bulk-oil-pct")?"bulk-oil-pct":D.classList.contains("bulk-oil-weight")?"bulk-oil-weight":"";if(!ne)return!1;let ie=Array.from(Z.querySelectorAll(`input.${ne}`)),ce=ie.indexOf(D);if(ce<0)return!1;let se=ce+j;if(se<0||se>=ie.length)return!1;let ue=ie[se];return ue instanceof HTMLInputElement?(ue.focus(),typeof ue.select=="function"&&ue.select(),!0):!1}function ge(){var j;let D=a();D.unitLabelEl&&(D.unitLabelEl.textContent=O.currentUnit||"g"),(j=D.modalEl)!=null&&j.classList.contains("show")&&t()}function pe(){let D=a();D.modalEl&&(D.openBtn&&D.openBtn.addEventListener("click",()=>{z()}),D.searchInput&&D.searchInput.addEventListener("input",()=>{let j=i();j.query=D.searchInput.value||"",h(),ee()}),D.viewSelectedToggle&&D.viewSelectedToggle.addEventListener("change",()=>{J(!!D.viewSelectedToggle.checked)}),D.scrollEl&&D.scrollEl.addEventListener("scroll",le),D.bodyEl&&(D.bodyEl.addEventListener("change",X),D.bodyEl.addEventListener("keydown",j=>{let V=j.target;if(!(!(V instanceof HTMLInputElement)||!(V.classList.contains("bulk-oil-pct")||V.classList.contains("bulk-oil-weight")))){if(j.key==="Enter"){j.preventDefault(),V.blur();return}j.key==="Tab"&&re(V,j.shiftKey?-1:1)&&j.preventDefault()}})),D.modalEl.querySelectorAll(".bulk-oil-sort").forEach(j=>{j.addEventListener("click",te)}),D.importBtn&&D.importBtn.addEventListener("click",()=>{ae()}),D.clearBtn&&D.clearBtn.addEventListener("click",()=>{oe()}),D.modalEl.addEventListener("shown.bs.modal",()=>{let j=a();j.searchInput&&j.searchInput.focus()}))}pe(),s(),C(),e.bulkOilsModal={openModal:z,serializeSelection:w,restoreState:b,onUnitChanged:ge}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:l,round:g,clamp:x,buildSoapcalcSearchBuilder:W}=e.helpers,{formatWeight:M,toGrams:B,fromGrams:E}=e.units,{FRAGRANCE_CATEGORY_SET:S,CITRIC_LYE_FACTORS:u}=e.constants,O=e.state;function G(t,d,y,T,p){var v;let P=document.getElementById(t),Q=document.getElementById(d),K=T?document.getElementById(T):null,r=p?document.getElementById(p):null,f=(v=P==null?void 0:P.parentElement)==null?void 0:v.querySelector('[data-role="suggestions"]');if(!P||!f||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let _=W();R.attachMergedInventoryGlobalTypeahead({inputEl:P,listEl:f,mode:"public",giHiddenEl:Q,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:_,searchType:"ingredient",resultFilter:(m,q)=>{let $=C(m);return $?y.has($):q==="inventory"},requireHidden:!1,onSelection:function(m){K&&(K.value=(m==null?void 0:m.default_unit)||""),r&&(r.value=(m==null?void 0:m.ingredient_category_name)||""),e.storage.queueStateSave()}}),P.addEventListener("input",function(){this.value.trim()||(K&&(K.value=""),r&&(r.value=""))})}function o({pctId:t,weightId:d}){var Q,K,r;let y=document.getElementById(t),T=y==null?void 0:y.value;if(T!==""&&T!==null&&T!==void 0)return l(T);let p=x(((K=(Q=e.oils)==null?void 0:Q.getTotalOilsGrams)==null?void 0:K.call(Q))||0,0);if(p<=0)return 0;let P=B((r=document.getElementById(d))==null?void 0:r.value);return P<=0?0:P/p*100}function c(){var p,P,Q,K,r,f,_,v,m,q,$,U,H,F,k,Y,z,X,J,te;let t=((p=document.getElementById("additiveLactateGi"))==null?void 0:p.value)||"",d=((P=document.getElementById("additiveSugarGi"))==null?void 0:P.value)||"",y=((Q=document.getElementById("additiveSaltGi"))==null?void 0:Q.value)||"",T=((K=document.getElementById("additiveCitricGi"))==null?void 0:K.value)||"";return{lactatePct:o({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:o({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:o({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:o({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((f=(r=document.getElementById("additiveLactateName"))==null?void 0:r.value)==null?void 0:f.trim())||"Sodium Lactate",sugarName:((v=(_=document.getElementById("additiveSugarName"))==null?void 0:_.value)==null?void 0:v.trim())||"Sugar",saltName:((q=(m=document.getElementById("additiveSaltName"))==null?void 0:m.value)==null?void 0:q.trim())||"Salt",citricName:((U=($=document.getElementById("additiveCitricName"))==null?void 0:$.value)==null?void 0:U.trim())||"Citric Acid",lactateGlobalItemId:t?parseInt(t):void 0,sugarGlobalItemId:d?parseInt(d):void 0,saltGlobalItemId:y?parseInt(y):void 0,citricGlobalItemId:T?parseInt(T):void 0,lactateDefaultUnit:((H=document.getElementById("additiveLactateUnit"))==null?void 0:H.value)||void 0,sugarDefaultUnit:((F=document.getElementById("additiveSugarUnit"))==null?void 0:F.value)||void 0,saltDefaultUnit:((k=document.getElementById("additiveSaltUnit"))==null?void 0:k.value)||void 0,citricDefaultUnit:((Y=document.getElementById("additiveCitricUnit"))==null?void 0:Y.value)||void 0,lactateCategoryName:((z=document.getElementById("additiveLactateCategory"))==null?void 0:z.value)||void 0,sugarCategoryName:((X=document.getElementById("additiveSugarCategory"))==null?void 0:X.value)||void 0,saltCategoryName:((J=document.getElementById("additiveSaltCategory"))==null?void 0:J.value)||void 0,citricCategoryName:((te=document.getElementById("additiveCitricCategory"))==null?void 0:te.value)||void 0}}function h(){var d;return(((d=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:d.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function L(t){var v,m;let d=x(l(t),0),y=x(o({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),T=x(o({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),p=x(o({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),P=x(o({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),Q=d*(y/100),K=d*(T/100),r=d*(p/100),f=d*(P/100),_=h()==="KOH"?(v=u==null?void 0:u.KOH)!=null?v:.71:(m=u==null?void 0:u.NaOH)!=null?m:.624;return{lactatePct:y,sugarPct:T,saltPct:p,citricPct:P,lactateG:Q,sugarG:K,saltG:r,citricG:f,citricLyeG:f*_}}function a({pctId:t,weightId:d,sourceField:y,totalOils:T}){let p=document.getElementById(t),P=document.getElementById(d);if(!p||!P)return;let Q=x(l(T),0);if(Q<=0)return;if(y==="weight"){let _=P.value;if(_===""||_===null||_===void 0){p.value="";return}let v=x(B(_),0),m=v>0?v/Q*100:0;p.value=m>0?g(m,2):"";return}let K=p.value;if(K===""||K===null||K===void 0){P.value="";return}let r=x(l(K),0),f=Q*(r/100);P.value=f>0?g(E(f),2):""}function i(t){let d=(T,p)=>{let P=document.getElementById(T);if(P)if(P.tagName==="INPUT"){if(document.activeElement===P)return;P.value=p}else P.textContent=p},y=T=>T>0?g(E(T),2):"";d("additiveLactateWeight",y(l(t==null?void 0:t.lactateG))),d("additiveSugarWeight",y(l(t==null?void 0:t.sugarG))),d("additiveSaltWeight",y(l(t==null?void 0:t.saltG))),d("additiveCitricWeight",y(l(t==null?void 0:t.citricG))),d("additiveCitricLyeOut",M(l(t==null?void 0:t.citricLyeG)))}function s(t){let d=x(l(t),0),y=L(d);return i(y),y}function n(t){let d=t.querySelector(".fragrance-typeahead"),y=t.querySelector(".fragrance-gi-id"),T=t.querySelector(".fragrance-default-unit"),p=t.querySelector(".fragrance-category"),P=t.querySelector('[data-role="suggestions"]');if(!d||!P||typeof R.attachMergedInventoryGlobalTypeahead!="function")return;let Q=W();R.attachMergedInventoryGlobalTypeahead({inputEl:d,listEl:P,mode:"public",giHiddenEl:y,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:Q,searchType:"ingredient",resultFilter:(K,r)=>{let f=C(K);return f?S.has(f):r==="inventory"},requireHidden:!1,onSelection:function(K){T&&(T.value=(K==null?void 0:K.default_unit)||""),p&&(p.value=(K==null?void 0:K.ingredient_category_name)||""),e.storage.queueStateSave()}}),d.addEventListener("input",function(){this.value.trim()||(T&&(T.value=""),p&&(p.value=""))})}function I(){var y,T;let t=document.getElementById("fragranceRowTemplate"),d=(T=(y=t==null?void 0:t.content)==null?void 0:y.querySelector(".fragrance-row"))==null?void 0:T.cloneNode(!0);return d?(d.querySelectorAll("input").forEach(p=>{p.value=""}),n(d),d.querySelectorAll(".unit-suffix").forEach(p=>{p.dataset.suffix=O.currentUnit}),d):document.createElement("div")}function A(t){let d=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),y=x(t||e.oils.getTotalOilsGrams()||0,0),T=0,p=0;d.forEach(K=>{let r=K.querySelector(".fragrance-grams"),f=K.querySelector(".fragrance-percent");if(!r||!f)return;let _=r.value,v=f.value,m=B(_),q=x(l(v),0),$=e.state.lastFragranceEdit,U=$&&$.row===K?$.field:null;y>0&&(U==="percent"?(m=y*(q/100),r.value=m>0?g(E(m),2):""):U==="grams"?(q=m/y*100,f.value=q>0?g(q,2):""):m>0?(q=m/y*100,document.activeElement!==f&&(f.value=g(q,2))):q>0&&(m=y*(q/100),document.activeElement!==r&&(r.value=g(E(m),2)))),m>0&&(T+=m),p+=q});let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent=g(p,2));let Q=document.getElementById("fragranceTotalComputed");return Q&&(Q.textContent=T>0?M(T):"--"),{totalGrams:T,totalPct:p}}function w(t){let d=[],y=x(t||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(T=>{var m,q,$,U,H,F,k;let p=(q=(m=T.querySelector(".fragrance-typeahead"))==null?void 0:m.value)==null?void 0:q.trim(),P=(($=T.querySelector(".fragrance-gi-id"))==null?void 0:$.value)||"",Q=((U=T.querySelector(".fragrance-default-unit"))==null?void 0:U.value)||"",K=((H=T.querySelector(".fragrance-category"))==null?void 0:H.value)||"",r=(F=T.querySelector(".fragrance-grams"))==null?void 0:F.value,f=(k=T.querySelector(".fragrance-percent"))==null?void 0:k.value,_=B(r),v=x(l(f),0);_<=0&&v>0&&y>0&&(_=y*(v/100)),!(!p&&!P&&_<=0)&&d.push({name:p||"Fragrance/Essential Oils",globalItemId:P?parseInt(P):void 0,defaultUnit:Q||void 0,categoryName:K||void 0,grams:_,pct:v})}),d}function b(){let t=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(d=>{var r,f,_,v,m,q,$;let y=((f=(r=d.querySelector(".fragrance-typeahead"))==null?void 0:r.value)==null?void 0:f.trim())||"",T=((_=d.querySelector(".fragrance-grams"))==null?void 0:_.value)||"",p=((v=d.querySelector(".fragrance-percent"))==null?void 0:v.value)||"",P=((m=d.querySelector(".fragrance-gi-id"))==null?void 0:m.value)||"",Q=((q=d.querySelector(".fragrance-default-unit"))==null?void 0:q.value)||"",K=(($=d.querySelector(".fragrance-category"))==null?void 0:$.value)||"";!y&&!T&&!p&&!P||t.push({name:y,grams:T,percent:p,gi:P,defaultUnit:Q,categoryName:K})}),t}function N(t){let d=document.getElementById("soapVisualGuidanceList");if(!d)return;let y=Array.isArray(t==null?void 0:t.tips)&&t.tips.length?t.tips:["No visual flags detected for this formula."];d.innerHTML="",y.forEach(T=>{let p=document.createElement("li");p.textContent=T,d.appendChild(p)})}function C(t){return!t||typeof t!="object"?null:t.ingredient&&t.ingredient.ingredient_category_name||t.ingredient_category_name||t.ingredient_category&&t.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:G,collectAdditiveSettings:c,syncAdditivePair:a,applyComputedOutputs:i,updateAdditivesOutput:s,updateVisualGuidance:N},e.fragrances={buildFragranceRow:I,updateFragranceTotals:A,collectFragranceRows:w,collectFragranceData:b}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:l}=e.helpers,{STAGE_CONFIGS:g,DEFAULT_INPUTS:x}=e.constants;function W(S){var G;let u=g[S];if(!u)return;let O=document.getElementById(u.tabId);if(O){if((G=R.bootstrap)!=null&&G.Tab)bootstrap.Tab.getOrCreateInstance(O).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(c=>{c.classList.remove("active"),c.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(c=>{c.classList.remove("show","active")}),O.classList.add("active"),O.setAttribute("aria-selected","true");let o=document.getElementById(u.paneId);o&&o.classList.add("show","active")}e.layout.scheduleStageHeightSync(),O.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function M(S){var O,G,o,c,h,L,a,i,s,n,I,A,w;let u=x||{};if(S===1){let b=u.unit||"g",N=document.querySelector(`input[name="weight_unit"][value="${b}"]`)||document.getElementById("unitGrams");N&&(N.checked=!0),e.units.setUnit(b,{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value=String((O=u.moldOilPct)!=null?O:65),document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value=u.moldShape||"loaf";let C=document.getElementById("moldCylinderCorrection");C&&(C.checked=!!u.moldCylinderCorrection),document.getElementById("moldCylinderFactor").value=String((G=u.moldCylinderFactor)!=null?G:.85),e.mold.updateMoldShapeUI(),(o=e.mold)!=null&&o.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(S===2){let b=document.getElementById("oilRows");b&&(b.innerHTML="",b.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(S===3){let b=u.lyeType||"NaOH",N=document.querySelector(`input[name="lye_type"][value="${b}"]`)||document.getElementById("lyeTypeNaoh");N&&(N.checked=!0);let C=document.getElementById("waterMethod");C&&(C.value=u.waterMethod||"percent");let t=document.getElementById("lyeSuperfat");t&&(t.value=String((c=u.superfatPct)!=null?c:5));let d=document.getElementById("lyePurity");d&&(d.value=String((h=u.lyePurityPct)!=null?h:100));let y=document.getElementById("waterPct");y&&(y.value=String((L=u.waterPct)!=null?L:33));let T=document.getElementById("lyeConcentration");T&&(T.value=String((a=u.lyeConcentrationPct)!=null?a:33));let p=document.getElementById("waterRatio");p&&(p.value=String((i=u.waterRatio)!=null?i:2)),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(S===4&&(document.getElementById("additiveLactatePct").value=String((s=u.additiveLactatePct)!=null?s:1),document.getElementById("additiveSugarPct").value=String((n=u.additiveSugarPct)!=null?n:1),document.getElementById("additiveSaltPct").value=String((I=u.additiveSaltPct)!=null?I:.5),document.getElementById("additiveCitricPct").value=String((A=u.additiveCitricPct)!=null?A:0),["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(b=>{let N=document.getElementById(b);N&&(N.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(b=>{let N=document.getElementById(b);N&&(N.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),S===5){let b=document.getElementById("fragranceRows");b&&(b.innerHTML="",(w=e.fragrances)!=null&&w.buildFragranceRow&&b.appendChild(e.fragrances.buildFragranceRow()));let N=document.getElementById("fragrancePercentTotal");N&&(N.textContent="0");let C=document.getElementById("fragranceTotalComputed");C&&(C.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),E()}function B(S){var u;if(S===1){let O=l(document.getElementById("moldWaterWeight").value),G=l(document.getElementById("oilTotalTarget").value),o=l(document.getElementById("moldOilPct").value),h=!!document.querySelector('input[name="weight_unit"]:checked')&&(O>0||G>0)&&o>0;return{state:h?"complete":"incomplete",label:h?"Sized":"Needs target"}}if(S===2){let G=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(o=>{var a,i,s,n;let c=(i=(a=o.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:i.trim(),h=l((s=o.querySelector(".oil-grams"))==null?void 0:s.value),L=l((n=o.querySelector(".oil-percent"))==null?void 0:n.value);return c&&(h>0||L>0)});return{state:G?"complete":"incomplete",label:G?"Oils added":"Add oils"}}if(S===3){let O=l(document.getElementById("lyeSuperfat").value),G=(u=document.getElementById("waterMethod"))==null?void 0:u.value,c=!!document.querySelector('input[name="lye_type"]:checked')&&!!G&&O>=0;return{state:c?"complete":"incomplete",label:c?"Configured":"Set lye"}}return S===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(G=>l(document.getElementById(G).value)>0)?"Added":"Optional"}:S===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(o=>{var a,i,s,n;let c=(i=(a=o.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:i.trim(),h=l((s=o.querySelector(".fragrance-grams"))==null?void 0:s.value),L=l((n=o.querySelector(".fragrance-percent"))==null?void 0:n.value);return c||h>0||L>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function E(){let S=document.getElementById("soapStageTabList");S&&S.querySelectorAll(".soap-stage-status").forEach(O=>O.remove());let u=document.getElementById("soapStageProgress");u&&(u.textContent="")}e.stages={openStageByIndex:W,resetStage:M,updateStageStatuses:E}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:l,toNumber:g,clamp:x}=e.helpers,{QUALITY_RANGES:W,QUALITY_HINTS:M,QUALITY_FEEL_HINTS:B,IODINE_RANGE:E,IODINE_SCALE_MAX:S,INS_RANGE:u,INS_SCALE_MAX:O,QUALITY_BASE:G,QUALITY_PRESETS:o,FATTY_BAR_COLORS:c,FATTY_DISPLAY_KEYS:h}=e.constants,{pulseValue:L,showSoapAlert:a}=e.ui;function i({barId:y,fillId:T,value:p,max:P,label:Q}){let K=document.getElementById(y),r=document.getElementById(T);if(!K||!r)return null;let f=isFinite(p)?p:0,_=Math.max(0,Math.min(P,f)),v=P>0?_/P*100:0;return r.style.width=`${v}%`,K.setAttribute("aria-valuemin","0"),K.setAttribute("aria-valuemax",String(P)),K.setAttribute("aria-valuenow",_.toFixed(1)),Q&&K.setAttribute("aria-label",Q),{bar:K,fill:r,value:f}}function s(y,T,p){if(!(!y||!p)){if(y.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(T)){y.classList.add("bg-secondary");return}T<p[0]?y.classList.add("bg-warning"):T>p[1]?y.classList.add("bg-danger"):y.classList.add("bg-success")}}function n(y,T,p,P,Q,K){let r=i({barId:y,fillId:T,value:p,max:Q,label:K});r&&s(r.fill,p,P)}function I(){let y={hardness:{range:W.hardness,scale:100},cleansing:{range:W.cleansing,scale:100},conditioning:{range:W.conditioning,scale:100},bubbly:{range:W.bubbly,scale:100},creamy:{range:W.creamy,scale:100},iodine:{range:E,scale:S},ins:{range:u,scale:O}};Object.entries(y).forEach(([T,p])=>{let[P,Q]=p.range,K=p.scale,r=T.charAt(0).toUpperCase()+T.slice(1),f=T==="iodine"?"iodineBar":T==="ins"?"insBar":`quality${r}Bar`,_=document.getElementById(`quality${r}Safe`);if(_){let $=Math.max(0,Math.min(100,P/K*100)),U=Math.max(0,Math.min(100,(Q-P)/K*100));_.style.left=`${$}%`,_.style.width=`${U}%`,_.title=`Safe range ${l(P,0)}-${l(Q,0)}`}let v=document.getElementById(f);v&&(v.dataset.safeRange=`${l(P,0)}-${l(Q,0)}`);let m=document.getElementById(`quality${r}RangeMin`),q=document.getElementById(`quality${r}RangeMax`);m&&(m.textContent=l(P,0)),q&&(q.textContent=l(Q,0))})}function A(y,T){let p=x(y.hardness||0,0,100),P=x(y.bubbly||0,0,100),Q=x(y.conditioning||0,0,100),K=x(Q+(T||0)*3,0,100),r=document.getElementById("feelHardness"),f=document.getElementById("feelBubbly"),_=document.getElementById("feelConditioning"),v=document.getElementById("feelGreasy");r&&(r.value=l(p,1)),f&&(f.value=l(P,1)),_&&(_.value=l(Q,1)),v&&(v.value=l(K,1))}function w(y){h.forEach(T=>{let p=document.getElementById(`fattyBar${T.charAt(0).toUpperCase()}${T.slice(1)}`);if(!p)return;let P=x(g(y[T]),0,100),Q=P;p.style.width=`${Q}%`,p.style.backgroundColor=c[T]||"var(--color-muted)",p.title=`${T.charAt(0).toUpperCase()}${T.slice(1)}: ${l(P,1)}%`})}function b(){var P;let y=((P=document.getElementById("qualityPreset"))==null?void 0:P.value)||"balanced",T=Array.from(document.querySelectorAll(".quality-focus:checked"));if(y==="none"&&!T.length)return null;let p=y==="none"?{...G}:o[y]?{...o[y]}:{...G};return T.forEach(Q=>{let K=Q.dataset.attr,r=Q.dataset.direction,f=W[K];f&&(p[K]=r==="low"?f[0]:f[1])}),p}function N(){let y=b(),T={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(T).forEach(([p,P])=>{if(!P)return;let Q=document.getElementById(`${P.id}Label`);if(!y){P.classList.add("d-none"),Q&&(Q.textContent="");return}let K=g(y[p]);if(!isFinite(K)){P.classList.add("d-none"),Q&&(Q.textContent="");return}let r=p==="iodine"?S:p==="ins"?O:100,f=x(K,0,r);P.classList.remove("d-none"),P.style.left=`${f/r*100}%`,P.setAttribute("aria-label",`Apply ${p} target`),P.setAttribute("role","button"),P.setAttribute("tabindex","0"),P.title=`Target ${p}: ${l(K,1)}`,Q&&(Q.textContent=l(K,1))})}async function C(){var _,v;let y=b();if(!y){a("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let T=Array.from(document.querySelectorAll("#oilRows .oil-row")),p=T.map(m=>{var Y,z,X,J,te,oe;let q=e.units.toGrams((Y=m.querySelector(".oil-grams"))==null?void 0:Y.value),$=((z=m.querySelector(".oil-fatty"))==null?void 0:z.value)||"",U=((J=(X=m.querySelector(".oil-typeahead"))==null?void 0:X.value)==null?void 0:J.trim())||null,H=g((te=m.querySelector(".oil-sap-koh"))==null?void 0:te.value),F=g((oe=m.querySelector(".oil-iodine"))==null?void 0:oe.value),k=null;if($)try{k=JSON.parse($)}catch{k=null}return{row:m,name:U,grams:q,sapKoh:H,iodine:F,fattyProfile:k}}).filter(m=>m.grams>0);if(!p.length){a("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let P=e.oils.getOilTargetGrams()||p.reduce((m,q)=>m+q.grams,0),Q={oils:p.map(m=>({name:m.name,grams:m.grams,sap_koh:m.sapKoh,iodine:m.iodine,fatty_profile:m.fattyProfile})),targets:y,target_oils_g:P},K=await((v=(_=e.runnerService)==null?void 0:_.applyQualityNudge)==null?void 0:v.call(_,Q));if(!K||K.ok!==!0){let m=(K==null?void 0:K.error)||"Unable to nudge blend right now. Please try again.";a("warning",m,{dismissible:!0,timeoutMs:6e3});return}(Array.isArray(K.warnings)?K.warnings:[]).forEach(m=>{a("info",m,{dismissible:!0,timeoutMs:5e3})}),(Array.isArray(K.adjusted_rows)?K.adjusted_rows:[]).forEach(m=>{let q=Number(m==null?void 0:m.index),$=g(m==null?void 0:m.grams);if(!isFinite(q)||q<0||!isFinite($))return;let U=T[q];if(!U)return;let H=U.querySelector(".oil-grams"),F=U.querySelector(".oil-percent");if(H&&(H.value=$>0?l(e.units.fromGrams($),2):""),F&&P>0){let k=$/P*100;F.value=k>0?l(k,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),a("info",K.message||"Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function t(y){let{qualities:T,fattyPercent:p,coveragePct:P,iodine:Q,ins:K,sapAvg:r,superfat:f,warnings:_}=y,v=P>0;function m(J,te){var ge,pe;let oe=document.getElementById(`quality${J}Value`),le=document.getElementById(`quality${J}Hint`);if(!oe)return;oe.textContent=v&&isFinite(te)?l(te,1):"--",L(oe);let ee=J.toLowerCase(),ae=W[ee],re=i({barId:`quality${J}Bar`,fillId:`quality${J}Fill`,value:v?te:0,max:100,label:J});re&&ae&&(s(re.fill,te,ae),v&&isFinite(te)?re.bar.title=`${J}: ${l(te,1)} (safe ${ae[0]}-${ae[1]}). ${M[ee]||""}`.trim():re.bar.title=`${J}: -- (safe ${ae[0]}-${ae[1]}). ${M[ee]||""}`.trim()),le&&ae&&(!v||!isFinite(te)?le.textContent="":te<ae[0]?le.textContent=((ge=B[ee])==null?void 0:ge.low)||"":te>ae[1]?le.textContent=((pe=B[ee])==null?void 0:pe.high)||"":le.textContent="")}m("Hardness",T.hardness),m("Cleansing",T.cleansing),m("Conditioning",T.conditioning),m("Bubbly",T.bubbly),m("Creamy",T.creamy);let q=document.getElementById("fattyCoverageNote");q&&(q.textContent=P>0?`Fatty acid coverage: ${l(P,1)}% of oils`:"Fatty acid coverage: not enough data yet");let $=document.getElementById("iodineValue"),U=document.getElementById("insValue"),H=document.getElementById("sapAvgValue");$&&($.textContent=Q>0?l(Q,1):"--",L($)),U&&(U.textContent=K>0?l(K,1):"--",L(U)),H&&(H.textContent=r>0?l(r,1):"--",L(H)),n("iodineBar","iodineFill",Q,E,S,"Iodine"),n("insBar","insFill",K,u,O,"INS");let F=(p.lauric||0)+(p.myristic||0)+(p.palmitic||0)+(p.stearic||0),k=(p.ricinoleic||0)+(p.oleic||0)+(p.linoleic||0)+(p.linolenic||0),Y=document.getElementById("fattySatRatioResult");Y&&(Y.textContent=F+k>0?`${l(F,0)}:${l(k,0)}`:"--",L(Y)),h.forEach(J=>{let te=`fatty${J.charAt(0).toUpperCase()}${J.slice(1)}`,oe=p[J];document.getElementById(te).textContent=v&&oe?`${l(oe,1)}%`:"--"}),A(T,f||0),w(p),N();let z=Array.isArray(_)?_.slice():[],X=document.getElementById("soapQualityWarnings");if(!X){e.layout.scheduleStageHeightSync();return}z.length?(X.classList.remove("d-none"),e.ui.renderTitledList(X,"Guidance & flags:",z)):(X.classList.add("d-none"),X.textContent=""),e.layout.scheduleStageHeightSync()}function d(){var y;document.querySelectorAll(".soap-quality-help").forEach(T=>{let p=T.dataset.quality;M[p]&&T.setAttribute("title",M[p])}),(y=R.bootstrap)!=null&&y.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(T=>{bootstrap.Tooltip.getOrCreateInstance(T)})}e.quality={setQualityRangeBars:I,updateQualityTargets:N,applyQualityTargets:C,updateQualitiesDisplay:t,initQualityTooltips:d}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function l(B,E){let S=[];return document.querySelectorAll(`#${B} .row`).forEach(function(u){var L,a,i;let O=(a=(L=u.querySelector(".tool-typeahead"))==null?void 0:L.value)==null?void 0:a.trim(),G=((i=u.querySelector(".tool-gi-id"))==null?void 0:i.value)||"",o=u.querySelector(".tool-qty"),c=u.querySelector(".tool-unit"),h=o&&o.value!=="";!O&&!G||(E==="container"?S.push({name:O||void 0,global_item_id:G?parseInt(G):void 0,quantity:h?parseFloat(o.value):1}):S.push({name:O||void 0,global_item_id:G?parseInt(G):void 0,quantity:h?parseFloat(o.value):0,unit:((c==null?void 0:c.value)||"").trim()||"gram"}))}),S}function g(B){let E=e.config.isAuthenticated?"member":"public",S=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(B,{context:E,mode:S,unitOptionsHtml:e.config.unitOptionsHtml})}function x(B,E){let S=g(B),u=S.querySelector(".tool-typeahead"),O=S.querySelector(".tool-qty");u&&(u.value=E),O&&B==="container"&&(O.value=1),B==="container"?document.getElementById("tool-containers").appendChild(S):B==="consumable"?document.getElementById("tool-consumables").appendChild(S):document.getElementById("tool-ingredients").appendChild(S)}function W(B){if(!B||typeof B!="object")return null;try{let E=JSON.parse(JSON.stringify(B));return E&&typeof E=="object"&&delete E.export,E}catch{return null}}function M(B){var G,o;let E=W(B);if(!E)return null;let S=((G=document.getElementById("qualityPreset"))==null?void 0:G.value)||"balanced",u=Array.from(document.querySelectorAll(".quality-focus:checked")).map(c=>c.id),O=(o=e.mold)!=null&&o.getMoldSettings?e.mold.getMoldSettings():null;return{calc:E,draft_lines:{ingredients:l("tool-ingredients","ingredient"),consumables:l("tool-consumables","consumable"),containers:l("tool-containers","container")},context:{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit||"g",input_mode:"mixed",quality_preset:S,quality_focus:u,mold:O}}}e.recipePayload={collectDraftLines:l,buildLineRow:g,addStubLine:x,buildSoapRecipePayloadRequest:M}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:l,toNumber:g,clamp:x}=e.helpers,{formatWeight:W,formatPercent:M}=e.units,{DEFAULT_INPUTS:B}=e.constants;function E(){var w,b;let a=B||{},i=((w=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:w.value)||a.lyeType||"NaOH",s=document.getElementById("lyePurity"),n=s==null?void 0:s.value,I=g(s==null?void 0:s.value),A=i==="NaOH"?"NaOH":"KOH";return(n===""||n===null||n===void 0||!isFinite(I))&&(I=(b=a.lyePurityPct)!=null?b:100),{selected:i,lyeType:A,purity:I}}function S(){let a=document.getElementById("lyePurity"),i=E();if(a)if(a.removeAttribute("readonly"),i.selected==="KOH90"){let s=document.getElementById("lyePurityHint");s&&(s.textContent="90% KOH selected. Safe default purity is 90%.")}else{let s=document.getElementById("lyePurityHint");s&&(s.textContent="Safe default is 100%.")}}function u(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function O(a=null,i=null){var A;let s=document.getElementById("stageWaterOutput"),n=document.getElementById("stageWaterComputedHint"),I=i||(a==null?void 0:a.waterMethod)||((A=document.getElementById("waterMethod"))==null?void 0:A.value)||"percent";if(s){let w=a&&isFinite(a.waterG)&&a.waterG>0;s.textContent=w?W(a.waterG):"--"}if(n){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){n.textContent=`Set oils in Stage 2 to calculate water. ${u(I)}`;return}if(I==="concentration"){let w=a.lyeConcentrationInput||a.lyeConcentration||0;n.textContent=`Using ${l(w,1)}% lye concentration from ${W(a.lyeAdjusted||0)} lye.`;return}if(I==="ratio"){let w=a.waterRatioInput||a.waterRatio||0;n.textContent=`Using ${l(w,2)} : 1 water-to-lye ratio from ${W(a.lyeAdjusted||0)} lye.`;return}n.textContent=`Using ${l(a.waterPct||0,1)}% of total oils (${W(a.totalOils)}).`}}function G(a=null,i=null){var p;let s=document.getElementById("lyeWaterPreviewAnchor"),n=document.getElementById("lyePreview"),I=document.getElementById("waterPreview"),A=document.getElementById("concPreview"),w=document.getElementById("ratioPreview");if(!s&&!n&&!I&&!A&&!w)return;let b=(P,Q)=>{P&&(P.textContent=Q)},N=i||(a==null?void 0:a.waterMethod)||((p=document.getElementById("waterMethod"))==null?void 0:p.value)||"percent",C=g(a==null?void 0:a.totalOils),t=g(a==null?void 0:a.lyeAdjusted),d=g(a==null?void 0:a.waterG);if(C<=0||t<=0){b(s,"Based on -- oils. All values update live as you change inputs."),b(n,"--"),b(I,"--"),b(A,"--"),b(w,"--");return}let y=g(a==null?void 0:a.lyeConcentration)>0?g(a==null?void 0:a.lyeConcentration):t+d>0?t/(t+d)*100:0,T=g(a==null?void 0:a.waterRatio)>0?g(a==null?void 0:a.waterRatio):t>0?d/t:0;if(b(s,`Based on ${W(C)} oils. All values update live as you change inputs.`),b(n,W(t)),b(I,W(d)),b(A,y>0?M(y):"--"),b(w,T>0?`${l(T,2)} : 1`:"--"),N==="concentration"){let P=g(a==null?void 0:a.lyeConcentrationInput);P>0&&b(A,M(P))}if(N==="ratio"){let P=g(a==null?void 0:a.waterRatioInput);P>0&&b(w,`${l(P,2)} : 1`)}}function o(){var i;let a=((i=document.getElementById("waterMethod"))==null?void 0:i.value)||"percent";document.querySelectorAll(".water-input").forEach(s=>{s.classList.toggle("d-none",s.dataset.method!==a)}),O(null,a),G(null,a)}function c(){let a=e.oils.updateOilTotals(),i=a.totalWeight,s=a.totalPct,n=[],I=e.oils.collectOilData(),A=e.oils.getOilTargetGrams(),b=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(N=>x(g(N.value),0)).some(N=>N>0);return(!I.length||i<=0)&&n.push("Add at least one oil with a weight or percent."),!A&&i<=0&&b&&n.push("Enter a total oils target or weights to convert percentages."),A>0&&s>0&&Math.abs(s-100)>.5&&n.push("Oil percentages should total 100% (use Normalize to fix)."),A>0&&i>A+.01?n.push("Oil weights exceed the mold target."):!A&&s>100.01&&n.push("Oil percentages exceed 100%."),{ok:n.length===0,errors:n,totals:a,oils:I}}function h(){var I;let a=B||{},i=document.getElementById("lyeSuperfat"),s=i==null?void 0:i.value,n=g(s);return(s===""||s===null||s===void 0||!isFinite(n))&&(n=(I=a.superfatPct)!=null?I:5),n}function L(){var b,N,C,t,d;let a=B||{},s=E().purity;isFinite(s)||(s=(b=a.lyePurityPct)!=null?b:100);let n=((N=document.getElementById("waterMethod"))==null?void 0:N.value)||"percent",I=g((C=document.getElementById("waterPct"))==null?void 0:C.value),A=g((t=document.getElementById("lyeConcentration"))==null?void 0:t.value),w=g((d=document.getElementById("waterRatio"))==null?void 0:d.value);return{purity:s,waterMethod:n,waterPct:I,lyeConcentration:A,waterRatio:w}}e.runnerInputs={getLyeSelection:E,applyLyeSelection:S,setWaterMethod:o,updateStageWaterSummary:O,updateLiveCalculationPreview:G,validateCalculation:c,readSuperfatInput:h,sanitizeLyeInputs:L}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{getStorage:l}=e.helpers;function g(){if(!e.config.calcLimit)return{count:0,date:null};let E=l();if(!E)return{count:0,date:null};try{let S=E.getItem("soap_calc_usage"),u=new Date().toISOString().slice(0,10);if(!S)return{count:0,date:u};let O=JSON.parse(S);return!O||O.date!==u?{count:0,date:u}:{count:Number(O.count)||0,date:u}}catch{return{count:0,date:null}}}function x(E){if(!e.config.calcLimit)return;let S=l();if(!S)return;let u=new Date().toISOString().slice(0,10);try{S.setItem("soap_calc_usage",JSON.stringify({count:E,date:u}))}catch{}}function W(){return e.config.calcLimit&&g().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function M(){if(!e.config.calcLimit)return;let S=g().count+1;x(S);let u=Math.max(0,e.config.calcLimit-S);u<=1&&e.ui.showSoapAlert("info",`You have ${u} calculation${u===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function B(E){if(!e.config.calcLimit||E===null||E>1)return;let S=document.getElementById("soapSignupModal");S&&(R.bootstrap&&R.bootstrap.Modal?R.bootstrap.Modal.getOrCreateInstance(S).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:W,consumeCalcQuota:M,maybeShowSignupModal:B}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.state;function g(){var S;return((S=document.querySelector('meta[name="csrf-token"]'))==null?void 0:S.getAttribute("content"))||""}async function x(S,u,O=2500){let G=g(),o=new AbortController,c=R.setTimeout(()=>o.abort(),O);try{let h=await fetch(S,{method:"POST",signal:o.signal,headers:{"Content-Type":"application/json",...G?{"X-CSRFToken":G}:{}},body:JSON.stringify(u||{})});if(!h.ok)return null;let L=await h.json();return!L||L.success!==!0||typeof L.result!="object"?null:L.result}catch{return null}finally{R.clearTimeout(c)}}function W({oils:S,selection:u,superfat:O,purity:G,waterMethod:o,waterPct:c,lyeConcentration:h,waterRatio:L,totalOils:a}){var w,b;let i=e.additives.collectAdditiveSettings(),s=e.fragrances.collectFragranceRows(a||0),n=Array.from(document.querySelectorAll(".quality-focus:checked")).map(N=>N.id),I=((w=document.getElementById("qualityPreset"))==null?void 0:w.value)||"balanced",A=(b=e.mold)!=null&&b.getMoldSettings?e.mold.getMoldSettings():null;return{oils:(S||[]).map(N=>({name:N.name||null,grams:N.grams||0,sap_koh:N.sapKoh||0,iodine:N.iodine||0,fatty_profile:N.fattyProfile||null,global_item_id:N.global_item_id||null,default_unit:N.default_unit||null,ingredient_category_name:N.ingredient_category_name||null})),fragrances:s.map(N=>({name:N.name||"Fragrance/Essential Oils",grams:N.grams||0,pct:N.pct||0,global_item_id:N.globalItemId||null,default_unit:N.defaultUnit||null,ingredient_category_name:N.categoryName||null})),additives:{lactate_pct:i.lactatePct||0,sugar_pct:i.sugarPct||0,salt_pct:i.saltPct||0,citric_pct:i.citricPct||0,lactate_name:i.lactateName||"Sodium Lactate",sugar_name:i.sugarName||"Sugar",salt_name:i.saltName||"Salt",citric_name:i.citricName||"Citric Acid",lactate_global_item_id:i.lactateGlobalItemId||null,sugar_global_item_id:i.sugarGlobalItemId||null,salt_global_item_id:i.saltGlobalItemId||null,citric_global_item_id:i.citricGlobalItemId||null,lactate_default_unit:i.lactateDefaultUnit||null,sugar_default_unit:i.sugarDefaultUnit||null,salt_default_unit:i.saltDefaultUnit||null,citric_default_unit:i.citricDefaultUnit||null,lactate_category_name:i.lactateCategoryName||null,sugar_category_name:i.sugarCategoryName||null,salt_category_name:i.saltCategoryName||null,citric_category_name:i.citricCategoryName||null},lye:{selected:(u==null?void 0:u.selected)||"NaOH",superfat:O,purity:G},water:{method:o,water_pct:c,lye_concentration:h,water_ratio:L},meta:{unit_display:l.currentUnit||"g",quality_preset:I,quality_focus:n,mold:A}}}async function M(S){return x("/tools/api/soap/calculate",S,2500)}async function B(S){return x("/tools/api/soap/recipe-payload",S,3500)}async function E(S){return x("/tools/api/soap/quality-nudge",S,3500)}e.runnerService={buildServicePayload:W,calculateWithSoapService:M,buildRecipePayload:B,applyQualityNudge:E}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{round:l,toNumber:g}=e.helpers,{formatWeight:x,formatPercent:W}=e.units,M=e.state,B={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function E(o){return(o||[]).map(c=>{var h;return{name:c.name||null,grams:g(c.grams),sapKoh:g((h=c.sap_koh)!=null?h:c.sapKoh),iodine:g(c.iodine),fattyProfile:c.fatty_profile||c.fattyProfile||null,global_item_id:c.global_item_id||null,default_unit:c.default_unit||null,ingredient_category_name:c.ingredient_category_name||null}})}function S(o,c){let h=document.getElementById(o);h&&(h.textContent=c)}function u({resultsCard:o,lyeAdjusted:c,waterData:h,batchYield:L,totalOils:a,superfat:i}){let s=document.getElementById("resultsCard");s&&(s.style.display="block");let n=g(o.water_lye_ratio)||h.waterRatio;S("lyeAdjustedOutput",x(g(o.lye_adjusted_g)||c)),S("waterOutput",x(g(o.water_g)||h.waterG)),S("batchYieldOutput",x(L)),S("lyeConcentrationOutput",W(g(o.lye_concentration_pct)||h.lyeConcentration)),S("waterRatioOutput",isFinite(n)&&n>0?l(n,2).toString():"--"),S("totalOilsOutput",x(a)),S("superfatOutput",W(i)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(I=>e.ui.pulseValue(document.getElementById(I)))}function O({showAlerts:o,lyeTotals:c,purity:h,waterData:L}){if(!o)return;c.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),h<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${l(h,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(L.lyeConcentration<25||L.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let a=e.mold.getMoldSettings();a.shape==="cylinder"&&a.waterWeight>0&&!a.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function G({serviceResult:o,validation:c,selection:h,superfat:L,purity:a,waterMethod:i,waterPct:s,lyeConcentrationInput:n,waterRatioInput:I,showAlerts:A}){var k,Y;let w=o.lye_type||h.lyeType||"NaOH",b=o.lye_selected||h.selected||null,N=g(o.total_oils_g)||c.totals.totalWeight,C=g(o.superfat_pct),t=isFinite(C)?C:L,d={sapAvg:g(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},y=g(o.lye_pure_g),p=Object.prototype.hasOwnProperty.call(o,"lye_adjusted_base_g")?g(o.lye_adjusted_base_g):null,P=g(o.lye_adjusted_g),Q=g(o.lye_purity_pct)||a,K=o.water_method||i,r=g(o.water_pct)||s,f=g(o.lye_concentration_input_pct)||n,_=g(o.water_ratio_input)||I,v={waterG:g(o.water_g),lyeConcentration:g(o.lye_concentration_pct),waterRatio:g(o.water_lye_ratio)},m=o.results_card||{},q=o.quality_report||{},$=E(o.oils||c.oils),U={waterG:v.waterG,lyeAdjusted:P,totalOils:N,waterMethod:K,waterPct:r,lyeConcentrationInput:f,waterRatioInput:_,lyeConcentration:v.lyeConcentration,waterRatio:v.waterRatio};e.runnerInputs.updateStageWaterSummary(U),e.runnerInputs.updateLiveCalculationPreview(U);let H=o.additives||B;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(H);let F=g(m.batch_yield_g)||N+P+v.waterG+H.fragranceG+H.lactateG+H.sugarG+H.saltG+H.citricG;return(k=e.mold)!=null&&k.updateWetBatterWarning&&e.mold.updateWetBatterWarning(F),u({resultsCard:m,lyeAdjusted:P,waterData:v,batchYield:F,totalOils:N,superfat:t}),e.ui.updateResultsWarnings(v),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:q.qualities||{},fattyPercent:q.fatty_acids_pct||{},coveragePct:g(q.coverage_pct),iodine:g(q.iodine),ins:g(q.ins),sapAvg:d.sapAvg,superfat:t,waterData:v,additives:H,oils:$,totalOils:N,warnings:q.warnings||[]}),(Y=e.oils)!=null&&Y.renderOilTips&&e.oils.renderOilTips(q.blend_tips||[]),e.additives.updateVisualGuidance({tips:q.visual_guidance||[]}),e.stages.updateStageStatuses(),O({showAlerts:A,lyeTotals:d,purity:Q,waterData:v}),M.lastCalc={totalOils:N,oils:$,lyeType:w,lyeSelected:b,superfat:t,purity:Q,lyePure:y,lyeAdjustedBase:p,lyeAdjusted:P,water:v.waterG,waterMethod:K,waterPct:r,lyeConcentration:v.lyeConcentration,waterRatio:v.waterRatio,sapAvg:d.sapAvg,usedSapFallback:d.usedFallback,additives:H,batchYield:F,qualityReport:q,export:o.export||null},M.lastCalc}e.runnerRender={applyServiceResult:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.state,g=e.runnerInputs,x=e.runnerQuota,W=e.runnerService,M=e.runnerRender;async function B(S){let u=e.recipePayload.buildSoapRecipePayloadRequest(S);return u?W.buildRecipePayload(u):null}async function E(S={}){var O;let u={consumeQuota:!1,showAlerts:!0,...S};try{u.showAlerts&&e.ui.clearSoapAlerts();let G=g.validateCalculation();if(!G.ok)return g.updateStageWaterSummary(null),g.updateLiveCalculationPreview(null),(O=e.mold)!=null&&O.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),u.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${G.errors.map(n=>`<li>${n}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(u.consumeQuota&&!x.canConsumeCalcQuota())return null;let o=g.readSuperfatInput(),c=g.getLyeSelection(),h=g.sanitizeLyeInputs(),L=(l.calcRequestSeq||0)+1;l.calcRequestSeq=L;let a=W.buildServicePayload({oils:G.oils,selection:c,superfat:o,purity:h.purity,waterMethod:h.waterMethod,waterPct:h.waterPct,lyeConcentration:h.lyeConcentration,waterRatio:h.waterRatio,totalOils:G.totals.totalWeight}),i=await W.calculateWithSoapService(a);if(L!==l.calcRequestSeq)return l.lastCalc;if(!i)return u.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let s=M.applyServiceResult({serviceResult:i,validation:G,selection:c,superfat:o,purity:h.purity,waterMethod:h.waterMethod,waterPct:h.waterPct,lyeConcentrationInput:h.lyeConcentration,waterRatioInput:h.waterRatio,showAlerts:u.showAlerts});return u.consumeQuota&&x.consumeCalcQuota(),s}catch{return u.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...S)=>g.getLyeSelection(...S),applyLyeSelection:(...S)=>g.applyLyeSelection(...S),setWaterMethod:(...S)=>g.setWaterMethod(...S),updateLiveCalculationPreview:(...S)=>g.updateLiveCalculationPreview(...S),calculateAll:E,buildSoapRecipePayload:B,buildLineRow:(...S)=>e.recipePayload.buildLineRow(...S),addStubLine:(...S)=>e.recipePayload.addStubLine(...S),maybeShowSignupModal:(...S)=>x.maybeShowSignupModal(...S)}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{formatTime:l,getStorage:g}=e.helpers,{DEFAULT_INPUTS:x}=e.constants,W="soap_tool_state_v2";function M(){return x||{}}function B(a,i){let s=[];return document.querySelectorAll(`#${a} .row`).forEach(I=>{var t,d,y;let A=(d=(t=I.querySelector(".tool-typeahead"))==null?void 0:t.value)==null?void 0:d.trim(),w=((y=I.querySelector(".tool-gi-id"))==null?void 0:y.value)||"",b=I.querySelector(".tool-qty"),N=I.querySelector(".tool-unit"),C=b&&b.value!==""?e.helpers.toNumber(b.value):null;!A&&!w||(i==="container"?s.push({name:A||"",global_item_id:w?parseInt(w):null,quantity:C&&C>0?C:1}):s.push({name:A||"",global_item_id:w?parseInt(w):null,quantity:C&&C>=0?C:0,unit:(N==null?void 0:N.value)||"gram"}))}),s}function E(){let a=[];return document.querySelectorAll("#oilRows .oil-row").forEach(i=>{var d,y,T,p,P,Q,K,r,f,_;let s=((y=(d=i.querySelector(".oil-typeahead"))==null?void 0:d.value)==null?void 0:y.trim())||"",n=((T=i.querySelector(".oil-grams"))==null?void 0:T.value)||"",I=((p=i.querySelector(".oil-percent"))==null?void 0:p.value)||"",A=((P=i.querySelector(".oil-sap-koh"))==null?void 0:P.value)||"",w=((Q=i.querySelector(".oil-iodine"))==null?void 0:Q.value)||"",b=((K=i.querySelector(".oil-fatty"))==null?void 0:K.value)||"",N=((r=i.querySelector(".oil-gi-id"))==null?void 0:r.value)||"",C=((f=i.querySelector(".oil-default-unit"))==null?void 0:f.value)||"",t=((_=i.querySelector(".oil-category"))==null?void 0:_.value)||"";!s&&!n&&!I&&!N||a.push({name:s,grams:n,percent:I,sap:A,iodine:w,fattyRaw:b,gi:N,defaultUnit:C,categoryName:t})}),a}function S(){var i;if((i=e.fragrances)!=null&&i.collectFragranceData)return e.fragrances.collectFragranceData();let a=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(s=>{var C,t,d,y,T,p,P;let n=((t=(C=s.querySelector(".fragrance-typeahead"))==null?void 0:C.value)==null?void 0:t.trim())||"",I=((d=s.querySelector(".fragrance-grams"))==null?void 0:d.value)||"",A=((y=s.querySelector(".fragrance-percent"))==null?void 0:y.value)||"",w=((T=s.querySelector(".fragrance-gi-id"))==null?void 0:T.value)||"",b=((p=s.querySelector(".fragrance-default-unit"))==null?void 0:p.value)||"",N=((P=s.querySelector(".fragrance-category"))==null?void 0:P.value)||"";!n&&!I&&!A&&!w||a.push({name:n,grams:I,percent:A,gi:w,defaultUnit:b,categoryName:N})}),a}function u(a,i){let s=document.getElementById("oilRows");if(!s||!a)return;let n=e.oils.buildOilRow();n.querySelector(".oil-typeahead").value=a.name||"",n.querySelector(".oil-grams").value=a.grams||"",n.querySelector(".oil-percent").value=a.percent||"",n.querySelector(".oil-sap-koh").value=a.sap||"",n.querySelector(".oil-iodine").value=a.iodine||"",n.querySelector(".oil-fatty").value=a.fattyRaw||"",n.querySelector(".oil-gi-id").value=a.gi||"";let I=n.querySelector(".oil-default-unit");I&&(I.value=a.defaultUnit||"");let A=n.querySelector(".oil-category");A&&(A.value=a.categoryName||"");let w=Array.from(s.children);return i>=w.length?s.appendChild(n):s.insertBefore(n,w[i]),n}function O(){var n,I,A,w,b,N,C,t,d,y,T,p,P,Q,K,r,f,_,v,m,q,$,U,H,F,k,Y,z,X,J,te,oe,le,ee,ae;let a=g();if(!a)return;let i=M(),s={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:E(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||String((I=i.superfatPct)!=null?I:5),lye_type:((A=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:A.value)||i.lyeType||"NaOH",lye_purity:((w=document.getElementById("lyePurity"))==null?void 0:w.value)||String((b=i.lyePurityPct)!=null?b:100),water_method:((N=document.getElementById("waterMethod"))==null?void 0:N.value)||i.waterMethod||"percent",water_pct:((C=document.getElementById("waterPct"))==null?void 0:C.value)||"",lye_concentration:((t=document.getElementById("lyeConcentration"))==null?void 0:t.value)||"",water_ratio:((d=document.getElementById("waterRatio"))==null?void 0:d.value)||""},additives:{fragrances:S(),lactate_pct:document.getElementById("additiveLactatePct").value||String((y=i.additiveLactatePct)!=null?y:1),lactate_name:((T=document.getElementById("additiveLactateName"))==null?void 0:T.value)||"",lactate_gi:((p=document.getElementById("additiveLactateGi"))==null?void 0:p.value)||"",lactate_unit:((P=document.getElementById("additiveLactateUnit"))==null?void 0:P.value)||"",lactate_category:((Q=document.getElementById("additiveLactateCategory"))==null?void 0:Q.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||String((K=i.additiveSugarPct)!=null?K:1),sugar_name:((r=document.getElementById("additiveSugarName"))==null?void 0:r.value)||"",sugar_gi:((f=document.getElementById("additiveSugarGi"))==null?void 0:f.value)||"",sugar_unit:((_=document.getElementById("additiveSugarUnit"))==null?void 0:_.value)||"",sugar_category:((v=document.getElementById("additiveSugarCategory"))==null?void 0:v.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||String((m=i.additiveSaltPct)!=null?m:.5),salt_name:((q=document.getElementById("additiveSaltName"))==null?void 0:q.value)||"",salt_gi:(($=document.getElementById("additiveSaltGi"))==null?void 0:$.value)||"",salt_unit:((U=document.getElementById("additiveSaltUnit"))==null?void 0:U.value)||"",salt_category:((H=document.getElementById("additiveSaltCategory"))==null?void 0:H.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||String((F=i.additiveCitricPct)!=null?F:0),citric_name:((k=document.getElementById("additiveCitricName"))==null?void 0:k.value)||"",citric_gi:((Y=document.getElementById("additiveCitricGi"))==null?void 0:Y.value)||"",citric_unit:((z=document.getElementById("additiveCitricUnit"))==null?void 0:z.value)||"",citric_category:((X=document.getElementById("additiveCitricCategory"))==null?void 0:X.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||String((J=i.moldOilPct)!=null?J:65),shape:((te=document.getElementById("moldShape"))==null?void 0:te.value)||i.moldShape||"loaf",cylinder_correction:!!((oe=document.getElementById("moldCylinderCorrection"))!=null&&oe.checked),cylinder_factor:((le=document.getElementById("moldCylinderFactor"))==null?void 0:le.value)||String((ee=i.moldCylinderFactor)!=null?ee:.85)},quality:{preset:((ae=document.getElementById("qualityPreset"))==null?void 0:ae.value)||i.qualityPreset||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(re=>re.id)},lines:{ingredients:B("tool-ingredients","ingredient"),consumables:B("tool-consumables","consumable"),containers:B("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"all",selections:[]},updated_at:Date.now()};try{a.setItem(W,JSON.stringify(s));let re=document.getElementById("soapLastSaved");re&&(re.textContent=l(s.updated_at)),e.ui.showAutosaveToast()}catch{}}function G(){var w,b,N,C,t,d,y,T,p,P,Q,K;let a=g();if(!a)return;let i=M(),s=a.getItem(W);if(!s)return;let n=null;try{n=JSON.parse(s)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let r=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);r&&(r.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let I=document.getElementById("oilRows");if(I&&(I.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(f=>{let _=e.oils.buildOilRow();_.querySelector(".oil-typeahead").value=f.name||"",_.querySelector(".oil-grams").value=f.grams||"",_.querySelector(".oil-percent").value=f.percent||"",_.querySelector(".oil-sap-koh").value=f.sap||"",_.querySelector(".oil-iodine").value=f.iodine||"",_.querySelector(".oil-fatty").value=f.fattyRaw||"",_.querySelector(".oil-gi-id").value=f.gi||"";let v=_.querySelector(".oil-default-unit");v&&(v.value=f.defaultUnit||"");let m=_.querySelector(".oil-category");m&&(m.value=f.categoryName||""),I.appendChild(_)})),n.lye_form){let r=document.getElementById("lyeSuperfat");r&&(r.value=n.lye_form.superfat||String((w=i.superfatPct)!=null?w:5));let f=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||i.lyeType||"NaOH"}"]`);f&&(f.checked=!0);let _=document.getElementById("lyePurity");_&&(_.value=n.lye_form.lye_purity||String((b=i.lyePurityPct)!=null?b:100));let v=document.getElementById("waterMethod");v&&(v.value=n.lye_form.water_method||i.waterMethod||"percent");let m=document.getElementById("waterPct");m&&(m.value=n.lye_form.water_pct||"");let q=document.getElementById("lyeConcentration");q&&(q.value=n.lye_form.lye_concentration||"");let $=document.getElementById("waterRatio");$&&($.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let r=document.getElementById("fragranceRows");if(r&&((N=e.fragrances)!=null&&N.buildFragranceRow)){r.innerHTML="";let le=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(le)le.forEach(ee=>{let ae=e.fragrances.buildFragranceRow();ae.querySelector(".fragrance-typeahead").value=ee.name||"",ae.querySelector(".fragrance-grams").value=ee.grams||"",ae.querySelector(".fragrance-percent").value=ee.percent||"",ae.querySelector(".fragrance-gi-id").value=ee.gi||"";let re=ae.querySelector(".fragrance-default-unit");re&&(re.value=ee.defaultUnit||"");let ge=ae.querySelector(".fragrance-category");ge&&(ge.value=ee.categoryName||""),r.appendChild(ae)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let ee=e.fragrances.buildFragranceRow();ee.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",ee.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||String((C=i.fragrancePct)!=null?C:3),ee.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",r.appendChild(ee)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||String((t=i.additiveLactatePct)!=null?t:1);let f=document.getElementById("additiveLactateName");f&&(f.value=n.additives.lactate_name||"");let _=document.getElementById("additiveLactateGi");_&&(_.value=n.additives.lactate_gi||"");let v=document.getElementById("additiveLactateUnit");v&&(v.value=n.additives.lactate_unit||"");let m=document.getElementById("additiveLactateCategory");m&&(m.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||String((d=i.additiveSugarPct)!=null?d:1);let q=document.getElementById("additiveSugarName");q&&(q.value=n.additives.sugar_name||"");let $=document.getElementById("additiveSugarGi");$&&($.value=n.additives.sugar_gi||"");let U=document.getElementById("additiveSugarUnit");U&&(U.value=n.additives.sugar_unit||"");let H=document.getElementById("additiveSugarCategory");H&&(H.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||String((y=i.additiveSaltPct)!=null?y:.5);let F=document.getElementById("additiveSaltName");F&&(F.value=n.additives.salt_name||"");let k=document.getElementById("additiveSaltGi");k&&(k.value=n.additives.salt_gi||"");let Y=document.getElementById("additiveSaltUnit");Y&&(Y.value=n.additives.salt_unit||"");let z=document.getElementById("additiveSaltCategory");z&&(z.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||String((T=i.additiveCitricPct)!=null?T:0);let X=document.getElementById("additiveCitricName");X&&(X.value=n.additives.citric_name||"");let J=document.getElementById("additiveCitricGi");J&&(J.value=n.additives.citric_gi||"");let te=document.getElementById("additiveCitricUnit");te&&(te.value=n.additives.citric_unit||"");let oe=document.getElementById("additiveCitricCategory");oe&&(oe.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||String((p=i.moldOilPct)!=null?p:65);let r=document.getElementById("moldShape");r&&(r.value=n.mold.shape||i.moldShape||"loaf");let f=document.getElementById("moldCylinderCorrection");f&&(f.checked=!!n.mold.cylinder_correction);let _=document.getElementById("moldCylinderFactor");_&&(_.value=n.mold.cylinder_factor||String((P=i.moldCylinderFactor)!=null?P:.85));let v=document.getElementById("oilTotalTarget");(Q=e.mold)!=null&&Q.syncMoldPctFromTarget&&((K=e.mold)!=null&&K.syncTargetFromMold)&&(e.units.toGrams(v==null?void 0:v.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let r=document.getElementById("qualityPreset");if(r){let f=n.quality.preset||i.qualityPreset||"balanced",_=Array.from(r.options).find(v=>v.value===f);r.value=_?f:i.qualityPreset||"balanced"}document.querySelectorAll(".quality-focus").forEach(f=>{f.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(f.id)})}function A(r,f,_){let v=document.getElementById(r);v&&(v.innerHTML="",(f||[]).forEach(m=>{let q=e.runner.buildLineRow(_),$=q.querySelector(".tool-typeahead"),U=q.querySelector(".tool-gi-id"),H=q.querySelector(".tool-qty"),F=q.querySelector(".tool-unit");$&&($.value=m.name||""),U&&(U.value=m.global_item_id||""),H&&m.quantity!==void 0&&m.quantity!==null&&(H.value=m.quantity),F&&m.unit&&Array.from(F.options).find(Y=>Y.value===m.unit)&&(F.value=m.unit),v.appendChild(q)}))}if(n.lines&&(A("tool-ingredients",n.lines.ingredients,"ingredient"),A("tool-consumables",n.lines.consumables,"consumable"),A("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let r=document.getElementById("soapLastSaved");r&&(r.textContent=l(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let o=null;function c(){o&&clearTimeout(o),o=setTimeout(O,350)}let h=null;function L(){h&&clearTimeout(h),h=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:O,restoreState:G,serializeLines:B,serializeOils:E,restoreOilRow:u,queueStateSave:c,queueAutoCalc:L}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{toNumber:l}=e.helpers,g=e.state;function x(o){return o&&typeof o=="object"&&o.export&&typeof o.export.csv_text=="string"&&o.export.csv_text.trim()&&typeof o.export.sheet_html=="string"&&o.export.sheet_html.trim()}function W(o){var L;let c=l(o==null?void 0:o.totalOils),h=(L=e.oils)!=null&&L.getTotalOilsGrams?e.oils.getTotalOilsGrams():0;return c<=0||h<=0?!1:Math.abs(c-h)>.01}async function M(){var c,h;let o=g.lastCalc;return(!o||W(o)||!x(o))&&(o=await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0})),o?x(o)?o:((h=e.ui)!=null&&h.showSoapAlert&&e.ui.showSoapAlert("danger","Export payload is missing. Please run the calculation again.",{dismissible:!0,timeoutMs:6e3}),null):((c=e.ui)!=null&&c.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function B(o,c){let h=new Blob([o],{type:"text/csv;charset=utf-8;"}),L=URL.createObjectURL(h),a=document.createElement("a");a.href=L,a.download=c,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(L)}function E(o){var h;let c=R.open("","_blank","width=960,height=720");if(!c){(h=e.ui)!=null&&h.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}c.document.open(),c.document.write(o),c.document.close(),c.focus(),c.onload=()=>c.print()}function S(){let o=document.getElementById("saveSoapTool");o&&o.addEventListener("click",async function(){try{let c=g.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!c)return;let h=await e.runner.buildSoapRecipePayload(c);if(!h){e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0});return}g.lastRecipePayload=h;try{let L=e.helpers.getStorage();L&&L.setItem("soap_recipe_payload",JSON.stringify(h))}catch{}R.SOAP_RECIPE_DTO=h,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}})}function u(){let o=document.getElementById("exportSoapCsv");o&&o.addEventListener("click",async function(){let c=await M();c&&B(c.export.csv_text,"soap_formula.csv")})}function O(){let o=document.getElementById("printSoapSheet");o&&o.addEventListener("click",async function(){let c=await M();c&&E(c.export.sheet_html)})}function G(){S(),u(),O()}e.eventsExports={bind:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},l=e.state;function g(E){if(!E)return;let S=document.getElementById("addOil"),u=document.getElementById("normalizeOils");S&&(S.dataset.bound="direct",S.addEventListener("click",function(){E.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),u&&(u.dataset.bound="direct",u.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),E.addEventListener("input",function(O){O.target.classList.contains("oil-grams")&&(l.lastOilEdit={row:O.target.closest(".oil-row"),field:"grams"}),O.target.classList.contains("oil-percent")&&(l.lastOilEdit={row:O.target.closest(".oil-row"),field:"percent"}),(O.target.classList.contains("oil-grams")||O.target.classList.contains("oil-percent")||O.target.classList.contains("oil-typeahead"))&&(O.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(O.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),E.addEventListener("focusin",function(O){O.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(O.target.closest(".oil-row"))}),E.addEventListener("focusout",function(O){O.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),O.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(O.target.closest(".oil-row"),"grams"),O.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(O.target.closest(".oil-row"),"percent")}),E.addEventListener("keydown",function(O){O.key==="Enter"&&(O.target.classList.contains("oil-grams")&&(O.preventDefault(),e.oils.validateOilEntry(O.target.closest(".oil-row"),"grams")),O.target.classList.contains("oil-percent")&&(O.preventDefault(),e.oils.validateOilEntry(O.target.closest(".oil-row"),"percent")))}),E.addEventListener("mouseover",function(O){if(!O.target.classList.contains("oil-typeahead"))return;let G=O.target.closest(".oil-row");!G||G===l.lastPreviewRow||(l.lastPreviewRow=G,e.oils.setSelectedOilProfileFromRow(G))}),E.addEventListener("mouseout",function(O){O.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),E.addEventListener("click",function(O){let G=O.target.closest(".oil-profile-open");if(G){let c=G.closest(".oil-row");if(c){e.oils.setSelectedOilProfileFromRow(c);let h=document.getElementById("oilProfileModal");h&&R.bootstrap&&R.bootstrap.Modal.getOrCreateInstance(h).show()}return}let o=O.target.closest(".remove-oil");if(o){let c=o.closest(".oil-row");c&&(l.lastRemovedOil=e.oils.serializeOilRow(c),l.lastRemovedOilIndex=Array.from(c.parentElement.children).indexOf(c),e.ui.showUndoToast("Oil removed.")),c&&l.lastOilEdit&&l.lastOilEdit.row===c&&(l.lastOilEdit=null,e.oils.clearSelectedOilProfile()),c&&c.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}})}function x(E){if(!E)return;let S=document.getElementById("addFragrance");S&&(S.dataset.bound="direct",S.addEventListener("click",function(){E.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),E.addEventListener("input",function(u){u.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:u.target.closest(".fragrance-row"),field:"grams"}),u.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:u.target.closest(".fragrance-row"),field:"percent"}),(u.target.classList.contains("fragrance-grams")||u.target.classList.contains("fragrance-percent")||u.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),E.addEventListener("click",function(u){var o;let O=u.target.closest(".remove-fragrance");if(!O)return;let G=O.closest(".fragrance-row");G&&((o=e.state.lastFragranceEdit)==null?void 0:o.row)===G&&(e.state.lastFragranceEdit=null),G&&G.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function W({oilRows:E,fragranceRows:S}){let u=document.getElementById("soapStageTabContent");if(!u)return;let O=()=>{let G=u.querySelector(".tab-pane.active")||u.querySelector(".tab-pane.show.active");return G?G.querySelector(".soap-stage-body")||G:null};u.addEventListener("wheel",G=>{let o=G.target;if(!(o instanceof HTMLElement))return;let c=o.closest('input[type="number"]');if(!(c instanceof HTMLInputElement))return;let h=O();if(!(h instanceof HTMLElement)||h.scrollHeight<=h.clientHeight+1)return;document.activeElement===c&&typeof c.blur=="function"&&c.blur();let L=h.scrollTop<=0,a=h.scrollTop+h.clientHeight>=h.scrollHeight-1;G.deltaY<0&&L||G.deltaY>0&&a||(h.scrollTop+=G.deltaY,G.preventDefault())},{passive:!1}),u.addEventListener("click",G=>{let o=G.target.closest("[data-stage-action]"),c=G.target.closest("[data-soap-action]");if(!o&&!c)return;if(G.preventDefault(),G.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),c){if(c.dataset.bound==="direct")return;let a=c.dataset.soapAction;a==="add-oil"&&E&&(E.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),a==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),a==="add-fragrance"&&S&&(S.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let h=o.dataset.stageAction,L=Number(o.dataset.stageIndex);Number.isNaN(L)||(h==="prev"&&e.stages.openStageByIndex(Math.max(0,L-1)),h==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,L+1)),h==="reset"&&e.stages.resetStage(L+1))})}function M(){let E=document.getElementById("soapUndoRemove");E&&E.addEventListener("click",()=>{l.lastRemovedOil&&(e.storage.restoreOilRow(l.lastRemovedOil,l.lastRemovedOilIndex||0),l.lastRemovedOil=null,l.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())})}function B(){let E=document.getElementById("oilRows"),S=document.getElementById("fragranceRows");return g(E),x(S),W({oilRows:E,fragranceRows:S}),M(),{oilRows:E,fragranceRows:S}}e.eventsRows={bind:B}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function l(){let o=document.getElementById("soapStageTabList");if(!o)return;let c=()=>{o.querySelectorAll(".nav-item").forEach(L=>L.classList.remove("is-expanded"));let h=o.querySelector(".nav-link.active");h&&h.closest(".nav-item")&&h.closest(".nav-item").classList.add("is-expanded")};o.addEventListener("shown.bs.tab",()=>{c(),e.layout.scheduleStageHeightSync()}),c()}function g(){let o=document.getElementById("resultsCardToggle"),c=document.getElementById("resultsCard");!o||!c||o.addEventListener("click",()=>{c.classList.toggle("is-collapsed");let h=c.classList.contains("is-collapsed");o.setAttribute("aria-expanded",(!h).toString());let L=h?"Expand formula details":"Collapse formula details";o.setAttribute("aria-label",L),o.setAttribute("title",L);let a=o.querySelector("i");a&&(a.classList.toggle("fa-chevron-down",h),a.classList.toggle("fa-chevron-up",!h))})}function x(){document.querySelectorAll('input[name="weight_unit"]').forEach(o=>{o.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})})}function W(){let o=()=>{var n;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(n=e.mold)!=null&&n.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},c=document.getElementById("oilTotalTarget");c&&c.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let h=document.getElementById("moldWaterWeight");h&&h.addEventListener("input",function(){e.mold.syncTargetFromMold(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let L=document.getElementById("moldOilPct");L&&L.addEventListener("input",function(){e.mold.syncTargetFromMold(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let a=document.getElementById("moldShape");a&&a.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let i=document.getElementById("moldCylinderCorrection");i&&i.addEventListener("change",function(){e.mold.syncTargetFromMold(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let s=document.getElementById("moldCylinderFactor");s&&s.addEventListener("input",function(){e.mold.syncTargetFromMold(),o(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}function M(){let o=document.getElementById("waterMethod");o&&o.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(c=>{c.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(c=>{let h=document.getElementById(c);h&&["input","change"].forEach(L=>{h.addEventListener(L,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})})}function B(){[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:c,weightId:h})=>{let L=document.getElementById(c),a=document.getElementById(h);L&&L.addEventListener("input",()=>{let i=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:c,weightId:h,sourceField:"pct",totalOils:i}),e.additives.updateAdditivesOutput(i),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),a&&a.addEventListener("input",()=>{let i=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:c,weightId:h,sourceField:"weight",totalOils:i}),e.additives.updateAdditivesOutput(i),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(c=>{c.addEventListener("input",()=>{e.storage.queueStateSave()})})}function E(){let o=document.getElementById("qualityPreset");o&&o.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(h=>{h.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let c=document.getElementById("applyQualityTargets");c&&c.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(h=>{h.addEventListener("click",()=>e.quality.applyQualityTargets()),h.addEventListener("keydown",L=>{(L.key==="Enter"||L.key===" ")&&(L.preventDefault(),e.quality.applyQualityTargets())})})}function S(){document.querySelectorAll(".stub-btn").forEach(c=>{c.addEventListener("click",function(){let h=this.dataset.stubKind,L=this.dataset.stubName;e.runner.addStubLine(h,L),e.storage.queueStateSave()})});let o=document.getElementById("soapToolPage");o&&(o.addEventListener("click",function(c){c.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),o.addEventListener("input",function(c){c.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(c.target),e.stages.updateStageStatuses(),e.ui.flashStage(c.target.closest(".soap-stage-card")))}),o.addEventListener("change",function(c){c.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(c.target),e.stages.updateStageStatuses())}))}function u(){let o=document.getElementById("addToolIngredient");o&&o.addEventListener("click",function(){let L=document.getElementById("tool-ingredients");L&&L.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let c=document.getElementById("addToolConsumable");c&&c.addEventListener("click",function(){let L=document.getElementById("tool-consumables");L&&L.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let h=document.getElementById("addToolContainer");h&&h.addEventListener("click",function(){let L=document.getElementById("tool-containers");L&&L.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()})}function O(){let o=document.getElementById("calcLyeBtn");o&&o.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()})}function G(){l(),g(),x(),W(),M(),B(),E(),S(),u(),O()}e.eventsForms={bind:G}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function l(){let x=document.getElementById("soapMobileDrawer"),W=document.getElementById("soapMobileDrawerContent"),M=document.getElementById("soapMobileDrawerTitle"),B=document.getElementById("soapDrawerEmpty"),E=document.getElementById("soapDrawerClose"),S=document.getElementById("soapQualityCard"),u=document.getElementById("resultsCard");if(!x||!W||!M||!S||!u)return;let O=S.parentElement,G=u.parentElement,o=new Map,c=null,h=()=>R.matchMedia("(max-width: 767px)").matches,L=C=>C==="quality"?S:u,a=C=>C==="quality"?O:G,i=C=>C==="quality"?"Display":"Results",s=C=>{let t=o.get(C);t||(t=document.createElement("div"),t.className="soap-card-placeholder",o.set(C,t)),t.style.height=`${C.offsetHeight}px`,C.parentElement&&C.parentElement!==W&&!t.parentElement&&C.parentElement.insertBefore(t,C)},n=C=>{C&&(s(C),W.appendChild(C))},I=(C,t)=>{let d=o.get(C);d&&d.parentElement?d.replaceWith(C):t&&C.parentElement!==t&&t.appendChild(C)},A=()=>{if(!B)return;let C=c==="results",t=getComputedStyle(u).display!=="none";B.classList.toggle("d-none",!C||t)},w=C=>{h()&&(c&&c!==C&&I(L(c),a(c)),n(L(C)),M.textContent=i(C),c=C,x.classList.add("is-open"),A())},b=()=>{c&&(I(L(c),a(c)),c=null,x.classList.remove("is-open"),A())};x.querySelectorAll("[data-drawer-target]").forEach(C=>{C.addEventListener("click",()=>{let t=C.dataset.drawerTarget;t&&(x.classList.contains("is-open")&&c===t?b():w(t))})}),E&&E.addEventListener("click",b),R.addEventListener("resize",()=>{!h()&&c&&b()}),new MutationObserver(()=>A()).observe(u,{attributes:!0,attributeFilter:["style","class"]})}function g(){l(),R.addEventListener("resize",e.layout.scheduleStageHeightSync),R.addEventListener("load",e.layout.scheduleStageHeightSync)}e.eventsMobile={bind:g}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{},{LACTATE_CATEGORY_SET:l,SUGAR_CATEGORY_SET:g,SALT_CATEGORY_SET:x,CITRIC_CATEGORY_SET:W}=e.constants;function M({oilRows:B,fragranceRows:E}={}){var S,u;e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",l,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",g,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",x,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",W,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),B&&!B.querySelector(".oil-row")&&B.appendChild(e.oils.buildOilRow()),E&&!E.querySelector(".fragrance-row")&&(S=e.fragrances)!=null&&S.buildFragranceRow&&E.appendChild(e.fragrances.buildFragranceRow()),(u=e.fragrances)!=null&&u.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()}e.eventsInit={bind:M}})(window);(function(R){"use strict";let e=R.SoapTool=R.SoapTool||{};function l(){var x,W,M,B,E;let g=(x=e.eventsRows)!=null&&x.bind?e.eventsRows.bind():{oilRows:null,fragranceRows:null};(W=e.eventsForms)!=null&&W.bind&&e.eventsForms.bind(g),(M=e.eventsExports)!=null&&M.bind&&e.eventsExports.bind(g),(B=e.eventsMobile)!=null&&B.bind&&e.eventsMobile.bind(g),(E=e.eventsInit)!=null&&E.bind&&e.eventsInit.bind(g)}l()})(window);
