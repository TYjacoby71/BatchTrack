(function(M){"use strict";let e={inventory:"Inventory",global:"Global Library"},c={inventory:"bg-primary",global:"bg-info text-dark"},h={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function N(r,d){let i;return function(){let v=arguments;clearTimeout(i),i=setTimeout(()=>r.apply(null,v),d)}}function Q(r){return(r||"").trim().toLowerCase()}function H(r){if(r)return r;let d=document.createElement("div");return d.className="list-group position-absolute w-100 d-none inventory-suggestions",d.style.zIndex="1050",d.style.maxHeight="300px",d.style.overflowY="auto",d}function $(r){return typeof r=="function"?r():r}function L(r){let d=new Set;return(r||[]).forEach(i=>{let v=i&&(i.global_item_id||i.id);v&&d.add(String(v))}),d}function w(r){if(!r)return"";let d=e[r]||r;return`<span class="badge ${c[r]||"bg-secondary"} ms-2">${d}</span>`}function F(r,d,i,v){v=v||{},r.innerHTML="";let E=!1;if(d.forEach(C=>{!C.items||!C.items.length||(E=!0,C.items.forEach(y=>{let b=document.createElement("a");b.href="#",b.className="list-group-item list-group-item-action suggestion-item";let u=v.showSubtitle&&y.subtitle?`<div class="small text-muted mt-1">${y.subtitle}</div>`:"";b.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${y.text||y.display_name||y.name||""}</span>
          ${v.showSourceBadge?w(C.source||y.source):""}
        </div>${u}`,b.addEventListener("click",function(t){t.preventDefault(),i(y,C.source||y.source),r.classList.add("d-none")}),r.appendChild(b)}))}),r.classList.toggle("d-none",!E),!E&&r.dataset.emptyMessage){let C=document.createElement("div");C.className="list-group-item text-muted small",C.textContent=r.dataset.emptyMessage,r.appendChild(C),r.classList.remove("d-none")}}function O(r,d,i){r.innerHTML="";let v=!1;d.forEach(E=>{if(!E.ingredients||!E.ingredients.length)return;v=!0;let C=document.createElement("div");C.className="list-group-item text-muted small fw-semibold",C.textContent=E.title,r.appendChild(C),E.ingredients.forEach(y=>{let b=document.createElement("div");b.className="list-group-item ingredient-result";let u=document.createElement("div");u.className="d-flex justify-content-between align-items-center ingredient-summary",u.setAttribute("role","button"),u.setAttribute("tabindex","0"),u.innerHTML=`<span class="fw-semibold">${y.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${y.forms.length} option${y.forms.length===1?"":"s"}</span>`;let t=document.createElement("div");t.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",y.forms.forEach(S=>{let P=document.createElement("button");P.type="button",P.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",P.innerHTML=`<div class="fw-semibold">${S.text||S.display_name||S.name||"Form"}</div>`,P.addEventListener("click",function(){i(S,S.source||E.source),r.classList.add("d-none")}),t.appendChild(P)});function f(S){S.type==="keydown"&&S.key!=="Enter"&&S.key!==" "||(S.preventDefault(),t.classList.toggle("d-none"))}u.addEventListener("click",f),u.addEventListener("keydown",f),b.appendChild(u),b.appendChild(t),r.appendChild(b),y.forms.length===1&&t.classList.remove("d-none")})}),r.classList.toggle("d-none",!v)}function k(r,d,i){r.innerHTML="";let v=!1;if((d||[]).forEach(E=>{v=!0;let C=document.createElement("a");C.href="#",C.className="list-group-item list-group-item-action suggestion-item";let y=E.inci_name?`<div class="small text-muted">${E.inci_name}</div>`:"";C.innerHTML=`<div class="fw-semibold">${E.text||E.name}</div>${y}`,C.addEventListener("click",function(b){b.preventDefault(),i(E,"definition"),r.classList.add("d-none")}),r.appendChild(C)}),r.classList.toggle("d-none",!v),!v&&r.dataset.emptyMessage){let E=document.createElement("div");E.className="list-group-item text-muted small",E.textContent=r.dataset.emptyMessage,r.appendChild(E),r.classList.remove("d-none")}}function o(r){let d=[];return(r||[]).forEach(i=>{if(i&&Array.isArray(i.forms)&&i.forms.length){let v=i.ingredient&&i.ingredient.name||i.ingredient_name||null,E=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null,C=i.category_tags||[];i.forms.forEach(y=>{var t,f,S,P,A,x,G,W,s,I;let b=y.physical_form||{},u=y.display_name||y.text||y.name||(v&&y.physical_form_name?`${v}, ${y.physical_form_name}`:i.display_name||i.text||i.name||"");d.push({id:y.id,text:u,item_type:y.item_type||i.item_type,default_unit:y.default_unit||y.unit||i.default_unit||i.unit||null,source:"global",global_item_id:y.id,ingredient_id:y.ingredient_id||i.ingredient&&i.ingredient.id||i.ingredient_id||null,ingredient_name:y.ingredient_name||v,physical_form_id:y.physical_form_id||b&&b.id||null,physical_form_name:y.physical_form_name||b&&b.name||null,ingredient_category_name:E,category_tags:C,density:y.density||i.density||null,capacity:y.capacity||i.capacity||null,capacity_unit:y.capacity_unit||i.capacity_unit||null,container_material:y.container_material||i.container_material||null,container_type:y.container_type||i.container_type||null,container_style:y.container_style||i.container_style||null,container_color:y.container_color||i.container_color||null,default_is_perishable:(t=y.default_is_perishable)!=null?t:i.default_is_perishable,recommended_shelf_life_days:(f=y.recommended_shelf_life_days)!=null?f:i.recommended_shelf_life_days,saponification_value:(P=(S=y.saponification_value)!=null?S:i.saponification_value)!=null?P:null,iodine_value:(x=(A=y.iodine_value)!=null?A:i.iodine_value)!=null?x:null,fatty_acid_profile:(W=(G=y.fatty_acid_profile)!=null?G:i.fatty_acid_profile)!=null?W:null,melting_point_c:(I=(s=y.melting_point_c)!=null?s:i.melting_point_c)!=null?I:null})})}else if(i){let v=i.display_name||i.text||i.name||"",E=i.ingredient&&i.ingredient.ingredient_category_name||i.ingredient_category_name||i.ingredient_category&&i.ingredient_category.name||null;d.push({id:i.id,text:v,source:"global",item_type:i.item_type,global_item_id:i.id,ingredient_name:i.ingredient&&i.ingredient.name||i.ingredient_name||i.name,ingredient_category_name:E,category_tags:i.category_tags||[],physical_form_name:i.physical_form&&i.physical_form.name||i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,density:i.density||null,capacity:i.capacity||null,capacity_unit:i.capacity_unit||null,container_material:i.container_material||null,container_type:i.container_type||null,container_style:i.container_style||null,container_color:i.container_color||null,default_is_perishable:i.default_is_perishable,recommended_shelf_life_days:i.recommended_shelf_life_days,saponification_value:i.saponification_value||null,iodine_value:i.iodine_value||null,fatty_acid_profile:i.fatty_acid_profile||null,melting_point_c:i.melting_point_c||null})}}),d}function B(r){let d=new Map;return(r||[]).forEach(i=>{let v=i.ingredient_name||i.text||i.name||"",E=i.ingredient_id?`id:${i.ingredient_id}`:`name:${Q(v)}`,C=d.get(E)||{ingredient_id:i.ingredient_id||null,name:v,forms:[]};C.forms.push({id:i.id,text:i.text||v,ingredient_name:v,physical_form_name:i.physical_form_name||null,default_unit:i.default_unit||i.unit||null,source:"inventory",global_item_id:i.global_item_id||null}),d.set(E,C)}),Array.from(d.values())}function m(r,d){let i=[];return(r||[]).forEach(v=>{let E=(v.forms||[]).map(y=>({id:y.id,text:y.name||y.display_name||y.text,ingredient_name:y.ingredient_name||v.name||v.ingredient&&v.ingredient.name||"Ingredient",physical_form_name:y.physical_form_name||null,default_unit:y.default_unit||y.unit||null,source:"global",global_item_id:y.id,density:y.density||null,capacity:y.capacity||null,capacity_unit:y.capacity_unit||null,container_material:y.container_material||null,container_type:y.container_type||null,container_style:y.container_style||null,container_color:y.container_color||null,saponification_value:y.saponification_value||null,iodine_value:y.iodine_value||null,fatty_acid_profile:y.fatty_acid_profile||null,melting_point_c:y.melting_point_c||null})),C=d?E.filter(y=>!y.global_item_id||!d.has(String(y.global_item_id))):E;C.length&&i.push({ingredient_id:v.ingredient_id||v.id||null,name:v.name||v.ingredient&&v.ingredient.name||E[0]&&E[0].ingredient_name||"Ingredient",forms:C})}),i}function a(r){let d=new URLSearchParams({q:r});return fetch(`/api/ingredients/definitions/search?${d.toString()}`).then(i=>i.json()).catch(()=>({results:[]}))}function n(r){let d={...h,...r},i=d.inputEl,v=d.invHiddenEl,E=d.giHiddenEl,C=H(d.listEl),y=d.mode||"recipe",b=d.searchType||"ingredient",u=d.includeInventory,t=d.includeGlobal,f=d.ingredientFirst,S=d.displayVariant,P=typeof d.resultFilter=="function"?d.resultFilter:null,A=typeof d.onSelection=="function"?d.onSelection:null,x=d.globalUrlBuilder;if(!i||!v&&y==="recipe"||!E&&d.requireHidden!==!1)return;C&&!C.classList.contains("list-group")&&C.classList.add("list-group"),!C.parentNode&&i.parentNode&&i.parentNode.appendChild(C);function G(p,_){let T=new URLSearchParams({q:p});return _&&_!=="all"&&T.set("type",_),`/inventory/api/search?${T.toString()}`}function W(p,_,T){if(typeof x=="function")return x(p,_,T);let R=new URLSearchParams({q:p});return _&&_!=="all"&&R.set("type",_),_==="ingredient"&&T&&R.set("group","ingredient"),`${y==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${R.toString()}`}let s=N(function(){let p=(i.value||"").trim();if(!p){C.classList.add("d-none"),C.innerHTML="",v&&(v.value=""),E&&(E.value="");return}let _=($(b)||"ingredient").toLowerCase(),T=$(u),R=$(t),D=_==="ingredient"&&!!$(f),Y=S||(D?"grouped":"compact");if(_==="ingredient_definition"||_==="definition"){a(p).then(U=>{let J=U&&U.results||[];k(C,J.map(X=>({id:X.id,text:X.name,name:X.name,inci_name:X.inci_name,slug:X.slug,ingredient_category_id:X.ingredient_category_id,ingredient_category_name:X.ingredient_category_name})),I)}).catch(()=>C.classList.add("d-none"));return}let z=T!==!1?fetch(G(p,_)).then(U=>U.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),K=R!==!1?fetch(W(p,_,D)).then(U=>U.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([z,K]).then(U=>{let J=U[0]&&U[0].results||[],X=U[1]&&U[1].results||[],ne=P?J.filter(ie=>P(ie,"inventory")):J,oe=P?X.filter(ie=>P(ie,"global")):X,me=L(ne),fe=o(oe).filter(ie=>!ie.global_item_id||!me.has(String(ie.global_item_id))).filter(ie=>P?P(ie,"global"):!0);if(D){let ie=B(ne),ye=m(oe,me),he=[];ie.length&&he.push({title:"Your Inventory",source:"inventory",ingredients:ie}),ye.length&&he.push({title:"Global Library",source:"global",ingredients:ye}),O(C,he,I);return}let se=[];ne.length&&se.push({title:"Your Inventory",source:"inventory",items:ne}),fe.length&&se.push({title:"Global Library",source:"global",items:fe}),F(C,se,I,{showSourceBadge:d.showSourceBadge!==!1,showSubtitle:Y==="detailed"})}).catch(()=>{C.classList.add("d-none")})},200);function I(p,_){i.value=p.text||p.display_name||p.name||"",_==="inventory"?(v&&(v.value=p.id_numeric||p.id||""),E&&(E.value=p.global_item_id||"")):(E&&(E.value=p.global_item_id||p.id||""),v&&(v.value="")),typeof A=="function"&&A(p,_)}i.addEventListener("input",function(){v&&(v.value=""),E&&(E.value=""),s()}),document.addEventListener("click",function(p){!C.contains(p.target)&&!i.contains(p.target)&&C.classList.add("d-none")})}M.attachMergedInventoryGlobalTypeahead=n,M.renderInventoryTypeaheadList=F})(window);(function(M){"use strict";function e(c,h){var N=h&&h.context||"public",Q=h&&h.unitOptionsHtml||"",H=h&&h.mode||(N==="public"?"public":"recipe"),$=document.createElement("div");$.className="row g-2 align-items-end mb-2",$.innerHTML=['<div class="col-md-6">','  <label class="form-label">',c==="container"?"Container":c==="consumable"?"Consumable":"Ingredient","</label>",'  <div class="position-relative">','    <input type="text" class="form-control tool-typeahead" placeholder="Search global..." autocomplete="off">','    <input type="hidden" class="tool-gi-id">','    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>',"  </div>","</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Quantity</label>','  <input type="number" step="0.01" min="0" class="form-control tool-qty">',"</div>",'<div class="col-md-3 ',c==="container"?"d-none":"",'">','  <label class="form-label">Unit</label>','  <select class="form-select tool-unit">',Q,"  </select>","</div>",'<div class="col-md-3 ',c!=="container"?"d-none":"",'">','  <label class="form-label">Count</label>','  <input type="number" min="1" step="1" class="form-control tool-qty">',"</div>",'<div class="col-md-2 d-grid">','  <button type="button" class="btn btn-outline-danger tool-remove">Remove</button>',"</div>"].join("");var L=$.querySelector(".tool-typeahead"),w=$.querySelector(".tool-gi-id"),F=$.querySelector('[data-role="suggestions"]');if(typeof M.attachMergedInventoryGlobalTypeahead=="function"){let O=c==="container"?"container":c==="consumable"?"consumable":"ingredient",k=N!=="public";M.attachMergedInventoryGlobalTypeahead({inputEl:L,giHiddenEl:w,listEl:F,mode:H,context:N,ingredientFirst:c==="ingredient",searchType:O,includeInventory:k,includeGlobal:!0})}return $.querySelector(".tool-remove").addEventListener("click",function(){$.remove()}),$}M.buildToolLineRow=e})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{};e.config={unitOptionsHtml:M.soapToolConfig&&M.soapToolConfig.unitOptionsHtml||"",calcLimit:Number.isFinite(M.SOAP_CALC_LIMIT)?M.SOAP_CALC_LIMIT:null,calcTier:M.SOAP_CALC_TIER||"guest",useCsvPrimary:!!(M.soapToolConfig&&M.soapToolConfig.useCsvPrimary),isAuthenticated:M.__IS_AUTHENTICATED__===!0},e.state={lastCalc:null,calcRequestSeq:0,lastOilEdit:null,lastFragranceEdit:null,selectedOilProfile:null,wasCapped:!1,lastPreviewRow:null,lastRemovedOil:null,lastRemovedOilIndex:null,lastSaveToastAt:0,lastRecipePayload:null,totalOilsGrams:0,currentUnit:"g"},e.helpers={round:c,toNumber:h,clamp:N,formatTime:Q,getStorage:H,buildSoapcalcSearchBuilder:$};function c(L,w=3){if(!isFinite(L))return 0;let F=Math.pow(10,w);return Math.round(L*F)/F}function h(L){let w=L;typeof w=="string"&&(w=w.replace(/,/g,"").trim());let F=parseFloat(w);return isFinite(F)?F:0}function N(L,w,F){return!isFinite(L)||L<w?w:F!=null&&L>F?F:L}function Q(L){return L?`Saved ${new Date(L).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`:"Not saved yet"}function H(){try{return M.localStorage}catch{return null}}function $(){let L=(F,O,k)=>{let o=new URLSearchParams({q:F});return O&&O!=="all"&&o.set("type",O),O==="ingredient"&&k&&o.set("group","ingredient"),`/api/public/global-items/search?${o.toString()}`},w=(F,O,k)=>{let o=new URLSearchParams({q:F});return k&&o.set("group","ingredient"),`/api/public/soapcalc-items/search?${o.toString()}`};return e.config.useCsvPrimary===!0?w:L}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c={hardness:[29,54],cleansing:[12,22],conditioning:[44,69],bubbly:[14,46],creamy:[16,48]},h={hardness:"Durable bar that resists mush.",cleansing:"Higher values feel more stripping.",conditioning:"Silky, moisturizing feel.",bubbly:"Fluffy lather and big bubbles.",creamy:"Stable, creamy lather."},N={hardness:{low:"Soft bar, slower unmold.",ok:"Balanced hardness for daily use.",high:"Very hard bar, can feel brittle."},cleansing:{low:"Very mild cleansing.",ok:"Balanced cleansing.",high:"Strong cleansing, can be drying."},conditioning:{low:"Less conditioning feel.",ok:"Smooth and conditioning.",high:"Very conditioning, may feel oily."},bubbly:{low:"Low bubbly lather.",ok:"Balanced bubbly lather.",high:"Very bubbly, big foam."},creamy:{low:"Light creamy lather.",ok:"Creamy and stable.",high:"Dense creamy lather."}},Q=[41,70],H=100,$=[136,170],L=250,w={hardness:(c.hardness[0]+c.hardness[1])/2,cleansing:(c.cleansing[0]+c.cleansing[1])/2,conditioning:(c.conditioning[0]+c.conditioning[1])/2,bubbly:(c.bubbly[0]+c.bubbly[1])/2,creamy:(c.creamy[0]+c.creamy[1])/2},F={balanced:{hardness:40,cleansing:15,conditioning:55,bubbly:25,creamy:25,iodine:55,ins:160},bubbly:{hardness:35,cleansing:20,conditioning:50,bubbly:35,creamy:25,iodine:60,ins:150},creamy:{hardness:45,cleansing:12,conditioning:60,bubbly:20,creamy:35,iodine:50,ins:155},hard:{hardness:50,cleansing:18,conditioning:48,bubbly:22,creamy:28,iodine:45,ins:165},gentle:{hardness:35,cleansing:10,conditioning:65,bubbly:15,creamy:20,iodine:65,ins:140},castile:{hardness:20,cleansing:5,conditioning:75,bubbly:10,creamy:15,iodine:80,ins:110},shampoo:{hardness:30,cleansing:22,conditioning:50,bubbly:30,creamy:25,iodine:60,ins:145},utility:{hardness:70,cleansing:50,conditioning:20,bubbly:50,creamy:20,iodine:10,ins:250},luxury:{hardness:55,cleansing:10,conditioning:55,bubbly:15,creamy:40,iodine:50,ins:150},palmFree:{hardness:42,cleansing:16,conditioning:58,bubbly:22,creamy:28,iodine:55,ins:155}},O={lauric:"var(--color-primary)",myristic:"var(--color-info)",palmitic:"var(--color-warning)",stearic:"var(--color-muted)",ricinoleic:"var(--color-info-hover)",oleic:"var(--color-success)",linoleic:"var(--color-primary-hover)",linolenic:"var(--color-danger)"},k=["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],o=[{match:/coconut|palm kernel|babassu|murumuru/i,tip:"High lauric oils trace fast and feel cleansing; keep superfat >= 5%."},{match:/olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i,tip:"High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure."},{match:/castor/i,tip:"Castor boosts lather but can feel sticky above 10-15%."},{match:/cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i,tip:"Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour."},{match:/beeswax|candelilla|carnauba|wax/i,tip:"Waxes harden fast and can seize; keep usage low and add hot."},{match:/hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i,tip:"High-PUFA oils shorten shelf life; keep low and add antioxidant."}],B={g:1,oz:28.3495,lb:453.592},m=[{id:1,tabId:"soapStage1Tab",paneId:"soapStage1Pane",required:!0},{id:2,tabId:"soapStage2Tab",paneId:"soapStage2Pane",required:!0},{id:3,tabId:"soapStage3Tab",paneId:"soapStage3Pane",required:!0},{id:4,tabId:"soapStage4Tab",paneId:"soapStage4Pane",required:!1},{id:5,tabId:"soapStage5Tab",paneId:"soapStage5Pane",required:!1}],a=new Set(["Oils (Carrier & Fixed)","Butters & Solid Fats","Waxes"]),n=new Set(["Essential Oils","Fragrance Oils"]),r=new Set(["Aqueous Solutions & Blends","Preservatives & Additives"]),d=new Set(["Sugars & Syrups"]),i=new Set(["Salts & Minerals"]),v=new Set(["Preservatives & Additives","Salts & Minerals","Aqueous Solutions & Blends"]);e.constants={QUALITY_RANGES:c,QUALITY_HINTS:h,QUALITY_FEEL_HINTS:N,IODINE_RANGE:Q,IODINE_SCALE_MAX:H,INS_RANGE:$,INS_SCALE_MAX:L,QUALITY_BASE:w,QUALITY_PRESETS:F,FATTY_BAR_COLORS:O,FATTY_DISPLAY_KEYS:k,OIL_TIP_RULES:o,UNIT_FACTORS:B,STAGE_CONFIGS:m,OIL_CATEGORY_SET:a,FRAGRANCE_CATEGORY_SET:n,LACTATE_CATEGORY_SET:r,SUGAR_CATEGORY_SET:d,SALT_CATEGORY_SET:i,CITRIC_CATEGORY_SET:v}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c}=e.helpers;function h($){let L=0,w=0;return $.forEach(F=>{F.iodine>0&&(L+=F.grams,w+=F.iodine*F.grams)}),{iodine:L>0?w/L:0,coverageWeight:L}}function N($){let L={},w=0;$.forEach(O=>{!O.fattyProfile||typeof O.fattyProfile!="object"||(w+=O.grams,Object.entries(O.fattyProfile).forEach(([k,o])=>{let B=c(o);B>0&&(L[k]=(L[k]||0)+O.grams*(B/100))}))});let F={};return w>0&&Object.entries(L).forEach(([O,k])=>{F[O]=k/w*100}),{percent:F,coveredWeight:w}}function Q($){let L=w=>$[w]||0;return{hardness:L("lauric")+L("myristic")+L("palmitic")+L("stearic"),cleansing:L("lauric")+L("myristic"),conditioning:L("oleic")+L("linoleic")+L("linolenic")+L("ricinoleic"),bubbly:L("lauric")+L("myristic")+L("ricinoleic"),creamy:L("palmitic")+L("stearic")+L("ricinoleic")}}function H($){if(!$||typeof $!="object")return{hardness:0,cleansing:0,conditioning:0,bubbly:0,creamy:0};let L={lauric:c($.lauric),myristic:c($.myristic),palmitic:c($.palmitic),stearic:c($.stearic),ricinoleic:c($.ricinoleic),oleic:c($.oleic),linoleic:c($.linoleic),linolenic:c($.linolenic)},w=Q(L);return{hardness:(w.hardness||0)/100,cleansing:(w.cleansing||0)/100,conditioning:(w.conditioning||0)/100,bubbly:(w.bubbly||0)/100,creamy:(w.creamy||0)/100}}e.calc={computeIodine:h,computeFattyAcids:N,computeQualities:Q,computeOilQualityScores:H},M.SoapCalcService=e.calc})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h,clamp:N}=e.helpers,{UNIT_FACTORS:Q}=e.constants,H=e.state;function $(o){return N(h(o),0)*(Q[H.currentUnit]||1)}function L(o){return N(o,0)/(Q[H.currentUnit]||1)}function w(o){return!isFinite(o)||o<=0?"--":`${c(L(o),2)} ${H.currentUnit}`}function F(o){return isFinite(o)?`${c(o,1)}%`:"--"}function O(){document.querySelectorAll(".unit-label").forEach(o=>{o.textContent=H.currentUnit}),document.querySelectorAll(".unit-suffix").forEach(o=>{o.dataset.suffix=H.currentUnit})}function k(o,B={}){if(!o)return;if(o===H.currentUnit){O();return}let m=H.currentUnit;if(H.currentUnit=o,O(),B.skipConvert)return;let a=(Q[m]||1)/(Q[o]||1);document.querySelectorAll(".oil-grams").forEach(d=>{let i=h(d.value);i>0&&(d.value=c(i*a,2))}),document.querySelectorAll(".fragrance-grams").forEach(d=>{let i=h(d.value);i>0&&(d.value=c(i*a,2))});let n=document.getElementById("oilTotalTarget");if(n&&n.value){let d=h(n.value);d>0&&(n.value=c(d*a,2))}let r=document.getElementById("moldWaterWeight");if(r&&r.value){let d=h(r.value);d>0&&(r.value=c(d*a,2))}e.oils.updateOilTotals(),e.mold.updateMoldSuggested(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.bulkOilsModal&&typeof e.bulkOilsModal.onUnitChanged=="function"&&e.bulkOilsModal.onUnitChanged(),B.skipAutoCalc||e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})}e.units={toGrams:$,fromGrams:L,formatWeight:w,formatPercent:F,updateUnitLabels:O,setUnit:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state,h={info:"fa-info-circle",warning:"fa-exclamation-triangle",danger:"fa-times-circle",success:"fa-check-circle"};function N(m){m&&(m.classList.remove("soap-number-pulse"),m.offsetWidth,m.classList.add("soap-number-pulse"))}function Q(m){var n;let a=document.getElementById(m);return!a||!((n=M.bootstrap)!=null&&n.Toast)?null:bootstrap.Toast.getOrCreateInstance(a)}function H(){let m=Date.now();if(m-c.lastSaveToastAt<3500)return;c.lastSaveToastAt=m;let a=Q("soapAutosaveToast");a&&a.show()}function $(m){let a=document.getElementById("soapUndoToast");if(!a)return;let n=a.querySelector(".toast-body");n&&(n.textContent=m||"Oil removed.");let r=Q("soapUndoToast");r&&r.show()}function L(){let m=document.getElementById("resultsReadyBadge"),a=document.getElementById("resultsUpdatedAt");m&&m.classList.remove("d-none"),a&&(a.textContent=`Updated ${new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`)}function w(m){let a=document.getElementById("lyeConcentrationWarning"),n=document.getElementById("waterRatioWarning");if(a){let r=(m==null?void 0:m.lyeConcentration)||0,d="";r>40&&(d="High concentration"),r>0&&r<25&&(d="Low concentration"),a.textContent=d,a.classList.toggle("d-none",!d)}if(n){let r=(m==null?void 0:m.waterRatio)||0,d="";r>0&&r<1.8&&(d="Low water"),r>2.7&&(d="High water"),n.textContent=d,n.classList.toggle("d-none",!d)}}function F(){document.querySelectorAll("#soapToolPage .form-text").forEach(m=>{let a=m.closest(".col-md-2, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-6, .col-lg-4, .col-12");a&&a.classList.add("soap-field")})}function O(m){if(!m||m.type!=="number")return;let a=m.value;if(a===""){m.classList.remove("is-invalid");return}let n=parseFloat(a),r=m.getAttribute("min"),d=m.getAttribute("max"),i=r!==null&&r!==""&&n<parseFloat(r),v=d!==null&&d!==""&&n>parseFloat(d);m.classList.toggle("is-invalid",!isFinite(n)||i||v)}function k(m){var n;if(!m)return;let a=((n=m.querySelector)==null?void 0:n.call(m,".soap-stage-card"))||m;a.classList.add("soap-stage-highlight"),setTimeout(()=>a.classList.remove("soap-stage-highlight"),900)}function o(m,a,n={}){var v;let r=document.getElementById("soapAlertStack");if(!r)return;let d=h[m]||h.info,i=document.createElement("div");i.className=`alert alert-${m} d-flex align-items-start gap-2`,i.innerHTML=`
      <i class="fas ${d} mt-1"></i>
      <div class="flex-grow-1">${a}</div>
      ${n.dismissible?'<button type="button" class="btn-close" data-role="dismiss"></button>':""}
    `,n.dismissible&&((v=i.querySelector('[data-role="dismiss"]'))==null||v.addEventListener("click",()=>i.remove())),r.prepend(i),n.persist||setTimeout(()=>{i.parentNode&&i.remove()},n.timeoutMs||4500)}function B(){let m=document.getElementById("soapAlertStack");m&&m.querySelectorAll(".alert").forEach(a=>a.remove())}e.ui={pulseValue:N,getToastInstance:Q,showAutosaveToast:H,showUndoToast:$,updateResultsMeta:L,updateResultsWarnings:w,applyHelperVisibility:F,validateNumericField:O,flashStage:k,showSoapAlert:o,clearSoapAlerts:B}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{};function c(){let N=document.getElementById("soapStagePane"),Q=document.getElementById("soapQualityCard");if(!N||!Q)return;if(!M.matchMedia("(min-width: 768px)").matches){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}let $=Q.offsetHeight;if(!$){N.classList.remove("is-height-synced"),N.style.removeProperty("--soap-stage-height");return}N.style.setProperty("--soap-stage-height",`${$}px`),N.classList.add("is-height-synced")}let h=()=>{M.requestAnimationFrame(c)};e.layout={syncStageHeight:c,scheduleStageHeightSync:h}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{clamp:c,toNumber:h,round:N}=e.helpers,{toGrams:Q,fromGrams:H}=e.units;function $(){let o=O(),B=document.getElementById("oilTotalTarget"),m=document.getElementById("oilTargetHint");B&&o.effectiveCapacity>0&&Q(B.value)<=0&&(B.value=o.targetOils>0?N(H(o.targetOils),2):""),m&&(o.effectiveCapacity>0?m.textContent="Linked to mold sizing. Edit oil % or total oils target to update the other.":m.textContent="Auto-fills when mold sizing is set.");let a=document.getElementById("moldSuggestionNote");if(a){let n="Target oils are capped to the mold size above.";o.shape==="cylinder"&&o.waterWeight>0&&(o.useCylinder?n=`Cylinder correction applied (${N(o.cylinderFactor*100,0)}% of capacity).`:n="Cylinder mold selected. Apply a correction if you want headspace or a smaller fill."),a.textContent=n}L()}function L(o=null){var y;let B=document.getElementById("moldWetBatterWarning");if(!B)return;let m=()=>{B.classList.add("d-none"),B.textContent=""},a=O(),n=e.state||{},r=n.lastCalc||null,d=(y=e.oils)!=null&&y.getTotalOilsGrams?e.oils.getTotalOilsGrams():0,i=h(r==null?void 0:r.totalOils),v=h(o);if((!isFinite(v)||v<=0)&&(v=h(r==null?void 0:r.batchYield)),o==null&&i>0&&d>0&&Math.abs(i-d)>.01){m();return}if(!isFinite(v)||v<=0||a.effectiveCapacity<=0){m();return}let E=v-a.effectiveCapacity;if(E<=.01){m();return}let C=n.currentUnit||"g";B.textContent=`Full wet batter is ${N(H(v),2)} ${C}, exceeding mold capacity ${N(H(a.effectiveCapacity),2)} ${C} by ${N(H(E),2)} ${C}. Reduce oils target/% of mold or lower water/additives.`,B.classList.remove("d-none")}function w(){let o=document.getElementById("oilTotalTarget"),B=O();return o&&(B.effectiveCapacity>0&&(o.value=B.targetOils>0?N(H(B.targetOils),2):""),$()),B}function F(){let o=document.getElementById("oilTotalTarget"),B=document.getElementById("moldOilPct");if(!o||!B){let n=O();return $(),n}let m=O();if(m.effectiveCapacity>0){let n=Q(o.value),r=c(n,0,m.effectiveCapacity);n>m.effectiveCapacity+.01&&(o.value=N(H(r),2));let d=r>0?r/m.effectiveCapacity*100:0;B.value=r>0?N(d,2):""}let a=O();return $(),a}function O(){var i,v,E;let o=Q(document.getElementById("moldWaterWeight").value),B=c(h(document.getElementById("moldOilPct").value),0,100),m=((i=document.getElementById("moldShape"))==null?void 0:i.value)||"loaf",a=!!((v=document.getElementById("moldCylinderCorrection"))!=null&&v.checked),n=c(h((E=document.getElementById("moldCylinderFactor"))==null?void 0:E.value),.5,1),r=o>0?o*(a?n:1):0,d=r>0?r*(B/100):0;return{waterWeight:o,oilPct:B,shape:m,useCylinder:a,cylinderFactor:n,effectiveCapacity:r,targetOils:d}}function k(){var m;let o=((m=document.getElementById("moldShape"))==null?void 0:m.value)||"loaf",B=document.getElementById("moldCylinderOptions");B&&B.classList.toggle("d-none",o!=="cylinder"),$()}e.mold={updateMoldSuggested:$,updateWetBatterWarning:L,syncTargetFromMold:w,syncMoldPctFromTarget:F,getMoldSettings:O,updateMoldShapeUI:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h,clamp:N,buildSoapcalcSearchBuilder:Q}=e.helpers,{toGrams:H,fromGrams:$}=e.units,{OIL_CATEGORY_SET:L,OIL_TIP_RULES:w}=e.constants,{computeQualities:F}=e.calc,O=e.state;function k(s){let I=s.querySelector(".oil-typeahead"),p=s.querySelector(".oil-sap-koh"),_=s.querySelector(".oil-iodine"),T=s.querySelector(".oil-fatty"),R=s.querySelector(".oil-gi-id"),D=s.querySelector(".oil-default-unit"),Y=s.querySelector(".oil-category"),z=s.querySelector('[data-role="suggestions"]');if(!I||!z||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let K=Q();M.attachMergedInventoryGlobalTypeahead({inputEl:I,listEl:z,mode:"public",giHiddenEl:R,includeInventory:!1,includeGlobal:!0,ingredientFirst:!0,globalUrlBuilder:K,searchType:"ingredient",resultFilter:(U,J)=>G(U,L,J),requireHidden:!1,onSelection:function(U){p&&(p.value=(U==null?void 0:U.saponification_value)||""),_&&(_.value=(U==null?void 0:U.iodine_value)||""),T&&(T.value=U!=null&&U.fatty_acid_profile?JSON.stringify(U.fatty_acid_profile):""),D&&(D.value=(U==null?void 0:U.default_unit)||""),Y&&(Y.value=(U==null?void 0:U.ingredient_category_name)||""),t(U),C(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}}),I.addEventListener("input",function(){this.value.trim()||(p&&(p.value=""),_&&(_.value=""),T&&(T.value=""),R&&(R.value=""),D&&(D.value=""),Y&&(Y.value=""),S())})}function o(){var p,_;let s=document.getElementById("oilRowTemplate"),I=(_=(p=s==null?void 0:s.content)==null?void 0:p.querySelector(".oil-row"))==null?void 0:_.cloneNode(!0);return I?(I.querySelectorAll("input").forEach(T=>{T.value=""}),I.querySelectorAll(".form-text").forEach(T=>{let R=T.closest('.soap-field-stack, [class*="col-"]');R&&R.classList.add("soap-field")}),k(I),I.querySelectorAll(".unit-suffix").forEach(T=>{T.dataset.suffix=O.currentUnit}),I):document.createElement("div")}function B(){let s=document.getElementById("oilTotalTarget"),I=H(s==null?void 0:s.value);if(I>0)return I;let p=e.mold.getMoldSettings();return p.targetOils>0?p.targetOils:0}function m(s){let I=[];return s.forEach(_=>{var D,Y;let T=H((D=_.querySelector(".oil-grams"))==null?void 0:D.value),R=N(h((Y=_.querySelector(".oil-percent"))==null?void 0:Y.value),0);T>0&&R>0&&I.push(T/(R/100))}),I.length?I.reduce((_,T)=>_+T,0)/I.length:0}function a(s,I){if(!s||!I||I<=0)return{allowedGrams:null,allowedPct:null};let p=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=p.reduce((K,U)=>{var J;return U===s?K:K+H((J=U.querySelector(".oil-grams"))==null?void 0:J.value)},0),T=p.reduce((K,U)=>{var J;return U===s?K:K+N(h((J=U.querySelector(".oil-percent"))==null?void 0:J.value),0)},0),R=Math.max(0,100-T),D=Math.max(0,I-_),Y=I*R/100;return{allowedGrams:Math.max(0,Math.min(D,Y)),allowedPct:R}}function n(s,I,p){if(!s)return;let _=s.querySelector(`[data-role="oil-${I}-hint"]`);_&&(p?(_.textContent=p,_.classList.add("is-visible")):(_.textContent="",_.classList.remove("is-visible")))}function r(s){s&&(s.classList.remove("oil-input-bounce"),s.offsetWidth,s.classList.add("oil-input-bounce"))}function d(s,I,p={}){let _=B();if(!s||!_||_<=0){n(s,I,"");return}let T=s.querySelector(".oil-grams"),R=s.querySelector(".oil-percent"),D=a(s,_);if(I==="grams"&&T){let Y=H(T.value),z="";if(Y>_+.01?z="Entry exceeds the max oils allowed in stage 2.":D.allowedGrams!==null&&Y>D.allowedGrams+.01&&(z=`Must be under ${c($(D.allowedGrams),2)} ${O.currentUnit} to stay within the stage 2 oil limit.`),z){let K=D.allowedGrams!==null?c($(D.allowedGrams),2):c($(_),2);T.value=K>0?K:"",n(s,I,z),T.classList.add("oil-input-warning"),r(T),C()}else T.classList.remove("oil-input-warning"),n(s,I,"")}if(I==="percent"&&R){let Y=N(h(R.value),0),z="";if(Y>100.01?z="Entry exceeds the max oils allowed in stage 2.":D.allowedPct!==null&&Y>D.allowedPct+.01&&(z=`Must be under ${c(D.allowedPct,2)}% to stay within the stage 2 oil limit.`),z){let K=D.allowedPct!==null?c(D.allowedPct,2):100;R.value=K>0?K:"",n(s,I,z),R.classList.add("oil-input-warning"),r(R),C()}else R.classList.remove("oil-input-warning"),n(s,I,"")}}function i(s,I={}){let p=Array.from(document.querySelectorAll("#oilRows .oil-row")),_=s!=null?s:B(),T=!!I.force;if(!_||_<=0||!p.length){O.lastOilTarget=_;return}let R=p.reduce((Y,z)=>{var K;return Y+N(h((K=z.querySelector(".oil-percent"))==null?void 0:K.value),0)},0),D=p.reduce((Y,z)=>{var K;return Y+H((K=z.querySelector(".oil-grams"))==null?void 0:K.value)},0);if(R<=0&&D<=0){O.lastOilTarget=_;return}if(!(!T&&O.lastOilTarget&&Math.abs(O.lastOilTarget-_)<.01)){if(R>0)p.forEach(Y=>{let z=Y.querySelector(".oil-percent"),K=Y.querySelector(".oil-grams"),U=N(h(z==null?void 0:z.value),0),J=R>0?U/R:0;K&&(K.value=J>0?c($(_*J),2):""),z&&(z.value=J>0?c(J*100,2):"")});else if(D>0){let Y=_/D;p.forEach(z=>{let K=z.querySelector(".oil-grams"),U=z.querySelector(".oil-percent"),J=H(K==null?void 0:K.value);if(K){let X=J>0?J*Y:0;K.value=X>0?c($(X),2):""}if(U){let X=H(K==null?void 0:K.value);U.value=X>0?c(X/_*100,2):""}})}O.lastOilTarget=_,C({skipEnforce:!0})}}function v(s,I){if(!O.lastOilEdit||!O.lastOilEdit.row)return!1;let p=O.lastOilEdit.row,_=s.reduce((Y,z)=>{var K;return z===p?Y:Y+H((K=z.querySelector(".oil-grams"))==null?void 0:K.value)},0),T=Math.max(0,I-_),R=p.querySelector(".oil-grams"),D=p.querySelector(".oil-percent");return!R||!D?!1:(R.value=T>0?c($(T),2):"",D.value=T>0?c(T/I*100,2):"",O.wasCapped=!0,!0)}function E({totalWeight:s,totalPct:I,target:p,capped:_}){let T=document.getElementById("oilLimitWarning");if(!T)return;let R=[];if(_&&R.push("Oil total hit the mold cap and was adjusted."),p>0&&s>p+.01){let D=s-p;R.push(`Oil weights exceed the target by ${c($(D),2)} ${O.currentUnit}.`)}I>100.01&&R.push(`Oil percentages are over 100% by ${c(I-100,2)}%.`),R.length?(T.classList.remove("d-none"),T.innerHTML=`${R.join(" ")} Adjust oils or mold % to continue.`):(T.classList.add("d-none"),T.textContent="")}function C(s={}){var Y;s.skipEnforce||(O.wasCapped=!1);let I=Array.from(document.querySelectorAll("#oilRows .oil-row")),p=e.mold.getMoldSettings(),_=B();if(!_&&!p.targetOils){let z=m(I);if(z>0){_=z;let K=document.getElementById("oilTotalTarget");K&&!K.value&&(K.value=c($(z),2))}}let T=0,R=0;if(I.forEach(z=>{let K=z.querySelector(".oil-grams"),U=z.querySelector(".oil-percent"),J=H(K==null?void 0:K.value),X=N(h(U==null?void 0:U.value),0);_>0&&(O.lastOilEdit&&O.lastOilEdit.row===z&&O.lastOilEdit.field==="percent"?(J=X>0?_*(X/100):0,K.value=X>0?c($(J),2):""):J>0?(X=J/_*100,U.value=c(X,2)):X>0&&(J=_*(X/100),K.value=c($(J),2)),R+=X),J>0&&(T+=J)}),_<=0&&(T>0?(R=0,I.forEach(z=>{let K=z.querySelector(".oil-grams"),U=z.querySelector(".oil-percent"),J=H(K==null?void 0:K.value);if(J>0){let X=J/T*100;U.value=c(X,2),R+=X}})):R=I.reduce((z,K)=>{var U;return z+N(h((U=K.querySelector(".oil-percent"))==null?void 0:U.value),0)},0)),!s.skipEnforce&&p.targetOils>0&&T>p.targetOils+.01&&v(I,p.targetOils))return C({skipEnforce:!0});O.totalOilsGrams=T;let D=document.getElementById("oilTotalComputed");return D&&(D.textContent=T>0?`${c($(T),2)} ${O.currentUnit}`:"--"),document.getElementById("oilPercentTotal").textContent=c(R,2),E({totalWeight:T,totalPct:R,target:_,capped:O.wasCapped}),e.additives.updateAdditivesOutput(T),(Y=e.fragrances)!=null&&Y.updateFragranceTotals&&e.fragrances.updateFragranceTotals(T),e.mold.updateMoldSuggested(),P(),{totalWeight:T,totalPct:R,target:_}}function y(){let s=Array.from(document.querySelectorAll("#oilRows .oil-row"));if(!s.length)return;let I=B(),p=s.reduce((_,T)=>{var R;return _+N(h((R=T.querySelector(".oil-percent"))==null?void 0:R.value),0)},0);!p&&I>0&&(p=s.reduce((_,T)=>{var D;let R=H((D=T.querySelector(".oil-grams"))==null?void 0:D.value);return _+(R>0?R/I*100:0)},0)),!(p<=0)&&(s.forEach(_=>{let T=_.querySelector(".oil-percent"),R=_.querySelector(".oil-grams"),Y=N(h(T.value),0)/p*100;T.value=c(Y,2),I>0&&(R.value=Y>0?c($(I*(Y/100)),2):"")}),C())}function b(){let s=[];return document.querySelectorAll("#oilRows .oil-row").forEach(I=>{var J,X,ne,oe,me,fe,se,ie,ye;let p=(X=(J=I.querySelector(".oil-typeahead"))==null?void 0:J.value)==null?void 0:X.trim(),_=H((ne=I.querySelector(".oil-grams"))==null?void 0:ne.value),T=h((oe=I.querySelector(".oil-sap-koh"))==null?void 0:oe.value),R=h((me=I.querySelector(".oil-iodine"))==null?void 0:me.value),D=((fe=I.querySelector(".oil-fatty"))==null?void 0:fe.value)||"",Y=((se=I.querySelector(".oil-gi-id"))==null?void 0:se.value)||"",z=((ie=I.querySelector(".oil-default-unit"))==null?void 0:ie.value)||"",K=((ye=I.querySelector(".oil-category"))==null?void 0:ye.value)||"",U=null;if(D)try{U=JSON.parse(D)}catch{U=null}_<=0||s.push({name:p||null,grams:_,sapKoh:T,iodine:R,fattyProfile:U,global_item_id:Y?parseInt(Y):null,default_unit:z||null,ingredient_category_name:K||null})}),s}function u({name:s,sapKoh:I,iodine:p,fattyProfile:_}={}){let T=document.getElementById("oilProfileFloat"),R=(X,ne)=>{let oe=document.getElementById(X);oe&&(oe.textContent=ne)},D=s||"Pick an oil to preview";R("selectedOilName",D),R("selectedOilModalName",D),T&&T.classList.toggle("d-none",!s);let Y=I>0?c(I,1):"--",z=p>0?c(p,1):"--";R("selectedOilSap",Y),R("selectedOilModalSap",Y),R("selectedOilIodine",z),R("selectedOilModalIodine",z);let K=_?F(_):{},U=(X,ne)=>{let oe=isFinite(ne)&&ne>0?c(ne,1):"--";R(X,oe)};U("selectedOilHardness",K.hardness),U("selectedOilModalHardness",K.hardness),U("selectedOilCleansing",K.cleansing),U("selectedOilModalCleansing",K.cleansing),U("selectedOilConditioning",K.conditioning),U("selectedOilModalConditioning",K.conditioning),U("selectedOilBubbly",K.bubbly),U("selectedOilModalBubbly",K.bubbly),U("selectedOilCreamy",K.creamy),U("selectedOilModalCreamy",K.creamy),["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"].forEach(X=>{let ne=`selectedOil${X.charAt(0).toUpperCase()}${X.slice(1)}`,oe=`selectedOilModal${X.charAt(0).toUpperCase()}${X.slice(1)}`,me=_?h(_[X]):0,fe=me>0?c(me,1):"--";R(ne,fe),R(oe,fe)})}function t(s){if(!s){S();return}O.selectedOilProfile=s;let I=s.fatty_acid_profile||null;if(typeof I=="string")try{I=JSON.parse(I)}catch{I=null}u({name:s.text||s.display_name||s.name,sapKoh:h(s.saponification_value),iodine:h(s.iodine_value),fattyProfile:I})}function f(s){var D,Y,z,K,U;if(!s)return;let I=(Y=(D=s.querySelector(".oil-typeahead"))==null?void 0:D.value)==null?void 0:Y.trim(),p=h((z=s.querySelector(".oil-sap-koh"))==null?void 0:z.value),_=h((K=s.querySelector(".oil-iodine"))==null?void 0:K.value),T=((U=s.querySelector(".oil-fatty"))==null?void 0:U.value)||"",R=null;if(T)try{R=JSON.parse(T)}catch{R=null}u({name:I,sapKoh:p,iodine:_,fattyProfile:R})}function S(){O.selectedOilProfile=null,O.lastPreviewRow=null,u()}function P(){let s=document.getElementById("oilBlendTips");if(!s)return;let I=b().filter(T=>T.grams>0||T.percent>0);if(!I.length){s.classList.add("d-none"),s.textContent="";return}let p=new Set;I.forEach(T=>{let R=(T.name||"").toLowerCase();if(R&&w.forEach(D=>{D.match.test(R)&&p.add(D.tip)}),T.fattyProfile&&typeof T.fattyProfile=="object"){let D=h(T.fattyProfile.lauric),Y=h(T.fattyProfile.myristic),z=h(T.fattyProfile.palmitic),K=h(T.fattyProfile.stearic),U=h(T.fattyProfile.ricinoleic),J=h(T.fattyProfile.oleic),X=h(T.fattyProfile.linoleic),ne=h(T.fattyProfile.linolenic);D+Y>=30&&p.add(`${T.name||"This oil"} is high in lauric/myristic; expect faster trace and stronger cleansing.`),z+K>=40&&p.add(`${T.name||"This oil"} is high in palmitic/stearic; expect a harder bar and quicker set-up.`),J>=60&&p.add(`${T.name||"This oil"} is high oleic; trace may be slow and bars may start softer.`),X+ne>=20&&p.add(`${T.name||"This oil"} is high in PUFAs; keep the % lower to reduce DOS risk.`),U>=60&&p.add(`${T.name||"This oil"} boosts lather but can feel tacky; keep under 10-15%.`)}});let _=Array.from(p).slice(0,6);if(!_.length){s.classList.add("d-none"),s.textContent="";return}s.classList.remove("d-none"),s.innerHTML=`<strong>Blend behavior tips:</strong><ul class="mb-0">${_.map(T=>`<li>${T}</li>`).join("")}</ul>`}function A(){return O.totalOilsGrams||0}function x(s){var I,p,_,T,R,D,Y,z,K;return s?{name:((I=s.querySelector(".oil-typeahead"))==null?void 0:I.value)||"",grams:((p=s.querySelector(".oil-grams"))==null?void 0:p.value)||"",percent:((_=s.querySelector(".oil-percent"))==null?void 0:_.value)||"",sap:((T=s.querySelector(".oil-sap-koh"))==null?void 0:T.value)||"",iodine:((R=s.querySelector(".oil-iodine"))==null?void 0:R.value)||"",fattyRaw:((D=s.querySelector(".oil-fatty"))==null?void 0:D.value)||"",gi:((Y=s.querySelector(".oil-gi-id"))==null?void 0:Y.value)||"",defaultUnit:((z=s.querySelector(".oil-default-unit"))==null?void 0:z.value)||"",categoryName:((K=s.querySelector(".oil-category"))==null?void 0:K.value)||""}:null}function G(s,I,p){let _=W(s);return _?I.has(_):p==="inventory"}function W(s){return!s||typeof s!="object"?null:s.ingredient&&s.ingredient.ingredient_category_name||s.ingredient_category_name||s.ingredient_category&&s.ingredient_category.name||null}e.oils={attachOilTypeahead:k,buildOilRow:o,getOilTargetGrams:B,updateOilTotals:C,normalizeOils:y,collectOilData:b,setSelectedOilProfileFromRow:f,clearSelectedOilProfile:S,updateOilTips:P,getTotalOilsGrams:A,serializeOilRow:x,validateOilEntry:d,scaleOilsToTarget:i}})(window);(function(M){"use strict";var u;let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},{toNumber:h,clamp:N}=e.helpers,Q=e.state,H=Array.isArray((u=e.constants)==null?void 0:u.FATTY_DISPLAY_KEYS)?e.constants.FATTY_DISPLAY_KEYS.slice():["lauric","myristic","palmitic","stearic","ricinoleic","oleic","linoleic","linolenic"],$=new Set(["selected_pct","selected_weight_g"]),L=25,w=140,F=260,O={mode:"basics",viewSelected:!1,query:"",sortKey:"name",sortDir:"asc",selection:{},recordByKey:{},visibleRecords:[],offset:0,totalCount:0,hasMore:!0,loading:!1,requestToken:0};function k(){var t,f;(f=(t=e.storage)==null?void 0:t.queueStateSave)==null||f.call(t)}function o(t,f){var S,P;(P=(S=e.ui)==null?void 0:S.showSoapAlert)==null||P.call(S,t,f,{dismissible:!0,timeoutMs:6e3})}function B(){return{modalEl:document.getElementById("bulkOilModal"),openBtn:document.getElementById("openBulkOilModal"),searchInput:document.getElementById("bulkOilSearchInput"),modeToggle:document.getElementById("bulkOilDisplayAllToggle"),viewSelectedToggle:document.getElementById("bulkOilViewSelectedToggle"),statusEl:document.getElementById("bulkOilCatalogStatus"),summaryEl:document.getElementById("bulkOilSelectedSummary"),stageCountEl:document.getElementById("bulkOilSelectionCount"),bodyEl:document.getElementById("bulkOilCatalogBody"),scrollEl:document.getElementById("bulkOilCatalogScroll"),importBtn:document.getElementById("bulkOilImportBtn"),clearBtn:document.getElementById("bulkOilClearSelectionBtn"),unitLabelEl:document.getElementById("bulkOilWeightUnitLabel")}}function m(t){return t?t==="name"||$.has(t)?!0:H.includes(t):!1}function a(){(!Q.bulkOilModal||typeof Q.bulkOilModal!="object")&&(Q.bulkOilModal=JSON.parse(JSON.stringify(O)));let t=Q.bulkOilModal;return t.mode=t.mode==="all"?"all":"basics",t.viewSelected=!!t.viewSelected,t.query=typeof t.query=="string"?t.query:"",t.sortKey=m(t.sortKey)?t.sortKey:"name",t.sortDir=t.sortDir==="desc"?"desc":"asc",t.selection=t.selection&&typeof t.selection=="object"?t.selection:{},t.recordByKey=t.recordByKey&&typeof t.recordByKey=="object"?t.recordByKey:{},t.visibleRecords=Array.isArray(t.visibleRecords)?t.visibleRecords:[],t.offset=Math.max(0,parseInt(t.offset,10)||0),t.totalCount=Math.max(0,parseInt(t.totalCount,10)||0),t.hasMore=t.hasMore!==!1,t.loading=!!t.loading,t.requestToken=Math.max(0,parseInt(t.requestToken,10)||0),t}function n(t){let f={},S=t&&typeof t=="object"?t:{};return H.forEach(P=>{let A=h(S[P]);A>0&&(f[P]=A)}),f}function r(t){let f=n(t==null?void 0:t.fatty_profile),S=String((t==null?void 0:t.name)||"").trim(),P=String((t==null?void 0:t.source)||"soapcalc").trim().toLowerCase()||"soapcalc",A=Number.isInteger(t==null?void 0:t.global_item_id)?t.global_item_id:h(t==null?void 0:t.global_item_id)>0?parseInt(t.global_item_id,10):null;return{key:String((t==null?void 0:t.key)||(A?`global:${A}`:`${P}:${S.toLowerCase()}`)),name:S,sap_koh:h(t==null?void 0:t.sap_koh),iodine:h(t==null?void 0:t.iodine),fatty_profile:f,default_unit:String((t==null?void 0:t.default_unit)||"gram"),ingredient_category_name:String((t==null?void 0:t.ingredient_category_name)||"Oils (Carrier & Fixed)"),global_item_id:A,source:P,is_basic:!!(t!=null&&t.is_basic)}}function d(){let t=B(),f=a(),S=Object.keys(f.selection||{}).length,P=`Selected: ${S}`;t.summaryEl&&(t.summaryEl.textContent=P),t.stageCountEl&&(t.stageCountEl.textContent=String(S))}function i(t){var S;return((S=a().selection)==null?void 0:S[t])||null}function v(t,f={}){var x,G;let S=a();if(!t||!t.key)return null;let P=S.selection[t.key]||{},A={key:t.key,name:t.name,sap_koh:t.sap_koh,iodine:t.iodine,fatty_profile:t.fatty_profile||{},default_unit:t.default_unit||"gram",ingredient_category_name:t.ingredient_category_name||"",global_item_id:t.global_item_id||null,source:t.source||"soapcalc",is_basic:!!t.is_basic,selected_pct:N(h((x=f.selected_pct)!=null?x:P.selected_pct),0,100),selected_weight_g:N(h((G=f.selected_weight_g)!=null?G:P.selected_weight_g),0)};return S.selection[t.key]=A,A}function E(t){var S;let f=a();(S=f.selection)!=null&&S[t]&&delete f.selection[t]}function C(t){var S;return((S=a().recordByKey)==null?void 0:S[t])||null}function y(){let t=a();return{mode:t.mode,view_selected:!!t.viewSelected,query:t.query,sort_key:t.sortKey,sort_dir:t.sortDir,selections:Object.values(t.selection||{}).map(f=>({key:f.key,name:f.name,sap_koh:f.sap_koh,iodine:f.iodine,fatty_profile:f.fatty_profile||{},default_unit:f.default_unit,ingredient_category_name:f.ingredient_category_name,global_item_id:f.global_item_id,source:f.source,is_basic:!!f.is_basic,selected_pct:N(h(f.selected_pct),0,100),selected_weight_g:N(h(f.selected_weight_g),0)}))}}function b(t){let f=a();f.mode=(t==null?void 0:t.mode)==="all"?"all":"basics",f.viewSelected=!!(t!=null&&t.view_selected),f.query=typeof(t==null?void 0:t.query)=="string"?t.query:"",f.sortKey=m(t==null?void 0:t.sort_key)?t.sort_key:"name",f.sortDir=(t==null?void 0:t.sort_dir)==="desc"?"desc":"asc";let S={};(Array.isArray(t==null?void 0:t.selections)?t.selections:[]).forEach(A=>{let x=String((A==null?void 0:A.key)||"").trim(),G=String((A==null?void 0:A.name)||"").trim();!x||!G||(S[x]={key:x,name:G,sap_koh:h(A==null?void 0:A.sap_koh),iodine:h(A==null?void 0:A.iodine),fatty_profile:n(A==null?void 0:A.fatty_profile),default_unit:String((A==null?void 0:A.default_unit)||"gram"),ingredient_category_name:String((A==null?void 0:A.ingredient_category_name)||""),global_item_id:h(A==null?void 0:A.global_item_id)>0?parseInt(A.global_item_id,10):null,source:String((A==null?void 0:A.source)||"soapcalc"),is_basic:!!(A!=null&&A.is_basic),selected_pct:N(h(A==null?void 0:A.selected_pct),0,100),selected_weight_g:N(h(A==null?void 0:A.selected_weight_g),0)})}),f.selection=S,f.visibleRecords=[],f.offset=0,f.totalCount=0,f.hasMore=!0,f.loading=!1,d()}c.shared={FATTY_KEYS:H,LOCAL_SORT_KEYS:$,PAGE_SIZE:L,SCROLL_FETCH_THRESHOLD:w,SEARCH_DEBOUNCE_MS:F,queueStateSave:k,showAlert:o,getRefs:B,ensureModalState:a,normalizeFattyProfile:n,normalizeCatalogRecord:r,updateSelectionCounters:d,selectionForRecordKey:i,setSelection:v,removeSelection:E,getRecordByKey:C,serializeSelection:y,restoreState:b}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared;if(!h)return;let{round:N,toNumber:Q}=e.helpers,{fromGrams:H}=e.units,{FATTY_KEYS:$,LOCAL_SORT_KEYS:L,getRefs:w,ensureModalState:F,selectionForRecordKey:O,updateSelectionCounters:k}=h;function o(u){let t=w();t.statusEl&&(t.statusEl.textContent=u)}function B(){let u=F(),t=u.mode==="all"?"all oils":"SoapCalc basics";if(u.loading&&!u.visibleRecords.length){o("Loading oils...");return}if(!u.visibleRecords.length){let x=u.query?"No oils match that search.":"No oils available.";o(x);return}let f=u.visibleRecords.length,S=u.totalCount,P=u.hasMore?" \u2022 scroll for more":"",A=u.query?` \u2022 search: "${u.query}"`:"";o(`Loaded ${f}/${S} in ${t}${A}${P}`)}function m(u,t,f){if(typeof u=="string"||typeof t=="string"){let A=String(u||"").toLowerCase(),x=String(t||"").toLowerCase();return A<x?f==="asc"?-1:1:A>x?f==="asc"?1:-1:0}let S=Q(u),P=Q(t);return S<P?f==="asc"?-1:1:S>P?f==="asc"?1:-1:0}function a(u,t){var f,S;return t==="selected_pct"?((f=O(u.key))==null?void 0:f.selected_pct)||0:t==="selected_weight_g"?((S=O(u.key))==null?void 0:S.selected_weight_g)||0:""}function n(){let u=F();L.has(u.sortKey)&&u.visibleRecords.sort((t,f)=>{let S=m(a(t,u.sortKey),a(f,u.sortKey),u.sortDir);return S!==0?S:m(t.name||"",f.name||"","asc")})}function r(){let u=F();if(!u.viewSelected)return;let t=[],f=[];u.visibleRecords.forEach(S=>{O(S.key)?t.push(S):f.push(S)}),u.visibleRecords=t.concat(f)}function d(){n(),r()}function i(u){let t=String(u||"").trim().toLowerCase();return t==="name"||$.includes(t)?t:"name"}function v(){let u=F();document.querySelectorAll(".bulk-oil-sort").forEach(t=>{t.dataset.label||(t.dataset.label=String(t.textContent||"").replace(/[]\s*$/,"").trim());let f=t.dataset.label||"",S=t.dataset.sortKey||"";u.sortKey===S?t.textContent=`${f} ${u.sortDir==="asc"?"\u25B2":"\u25BC"}`:t.textContent=f})}function E(u,t){let f=O(t.key),S=u.querySelector(".bulk-oil-check"),P=u.querySelector(".bulk-oil-pct"),A=u.querySelector(".bulk-oil-weight");S&&(S.checked=!!f),P&&(P.value=f&&f.selected_pct>0?N(f.selected_pct,2):""),A&&(A.value=f&&f.selected_weight_g>0?N(H(f.selected_weight_g),2):"")}function C(u){let t=document.createElement("td");t.className="bulk-oil-acid";let f=Q(u);return t.textContent=f>0?N(f,1).toString():"--",t}function y(u){let t=document.createElement("tr");t.dataset.recordKey=u.key;let f=document.createElement("td");f.className="text-center";let S=document.createElement("input");S.type="checkbox",S.className="form-check-input bulk-oil-check",f.appendChild(S),t.appendChild(f);let P=document.createElement("td");P.className="bulk-oil-name";let A=document.createElement("div");A.className="fw-semibold small",A.textContent=u.name;let x=document.createElement("div");x.className="text-muted small";let G=u.ingredient_category_name?` \xB7 ${u.ingredient_category_name}`:"";x.textContent=`${u.source}${G}`,P.appendChild(A),P.appendChild(x),t.appendChild(P),$.forEach(_=>{var T;t.appendChild(C((T=u.fatty_profile)==null?void 0:T[_]))});let W=document.createElement("td"),s=document.createElement("input");s.type="number",s.min="0",s.max="100",s.step="0.1",s.className="form-control form-control-sm bulk-oil-input bulk-oil-pct",W.appendChild(s),t.appendChild(W);let I=document.createElement("td"),p=document.createElement("input");return p.type="number",p.min="0",p.step="0.1",p.className="form-control form-control-sm bulk-oil-input bulk-oil-weight",I.appendChild(p),t.appendChild(I),E(t,u),t}function b(){let u=w(),t=F();if(!u.bodyEl)return;u.bodyEl.innerHTML="";let f=document.createDocumentFragment();t.visibleRecords.forEach(S=>{f.appendChild(y(S))}),u.bodyEl.appendChild(f),v(),k(),B()}c.render={updateStatusText:o,refreshCatalogStatus:B,applyLocalSelectionSortIfNeeded:n,applyViewSelectedOrderingIfNeeded:r,applyClientOrdering:d,normalizeServerSortKey:i,sortButtonsLabel:v,renderVisibleRecords:b}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared,N=c.render;if(!h||!N)return;let{PAGE_SIZE:Q,getRefs:H,ensureModalState:$,normalizeCatalogRecord:L}=h,{refreshCatalogStatus:w,normalizeServerSortKey:F,applyClientOrdering:O,renderVisibleRecords:k,updateStatusText:o}=N;function B(){let a=$(),n=H();a.visibleRecords=[],a.offset=0,a.totalCount=0,a.hasMore=!0,n.bodyEl&&(n.bodyEl.innerHTML=""),n.scrollEl&&(n.scrollEl.scrollTop=0)}async function m({reset:a=!1}={}){let n=$();if(!H().modalEl||n.loading&&!a||!n.hasMore&&!a)return;a&&B();let d=n.requestToken+1;n.requestToken=d,n.loading=!0,w();let i=new URLSearchParams;i.set("mode",n.mode),i.set("offset",String(n.offset)),i.set("limit",String(Q)),i.set("q",n.query||""),i.set("sort_key",F(n.sortKey)),i.set("sort_dir",n.sortDir==="desc"?"desc":"asc");try{let v=await fetch(`/tools/api/soap/oils-catalog?${i.toString()}`);if(!v.ok)throw new Error("Unable to load oils catalog");let E=await v.json();if(!E||E.success!==!0||!E.result||!Array.isArray(E.result.records))throw new Error("Invalid oils catalog response");if(d!==n.requestToken)return;let C=E.result.records.map(L),y=Math.max(0,parseInt(E.result.next_offset,10)||n.offset+C.length),b=Math.max(C.length,parseInt(E.result.count,10)||0),u=!!E.result.has_more;C.forEach(t=>{n.recordByKey[t.key]=t}),n.visibleRecords=a?C.slice():n.visibleRecords.concat(C),n.offset=y,n.totalCount=b,n.hasMore=u,O(),k()}catch(v){throw d===n.requestToken&&o("Unable to load oils catalog."),v}finally{d===n.requestToken&&(n.loading=!1,w())}}c.api={fetchCatalogPage:m}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.bulkOils=e.bulkOils||{},h=c.shared,N=c.render,Q=c.api;if(!h||!N||!Q)return;let{round:H,toNumber:$,clamp:L}=e.helpers,{toGrams:w,fromGrams:F}=e.units,O=e.state,{LOCAL_SORT_KEYS:k,SCROLL_FETCH_THRESHOLD:o,SEARCH_DEBOUNCE_MS:B,queueStateSave:m,showAlert:a,getRefs:n,ensureModalState:r,updateSelectionCounters:d,setSelection:i,removeSelection:v,getRecordByKey:E,serializeSelection:C,restoreState:y}=h,{applyClientOrdering:b,sortButtonsLabel:u,renderVisibleRecords:t}=N,{fetchCatalogPage:f}=Q,S=null,P=null;function A(){var q;let g=n();g.modalEl&&(!S&&((q=M.bootstrap)!=null&&q.Modal)&&(S=M.bootstrap.Modal.getOrCreateInstance(g.modalEl)),S&&S.hide())}function x(){return document.getElementById("oilRows")}function G(){return Array.from(document.querySelectorAll("#oilRows .oil-row"))}function W(g){return String(g||"").trim().toLowerCase()}function s(g){var q;return W((q=g==null?void 0:g.querySelector(".oil-typeahead"))==null?void 0:q.value)}function I(g){var V;let q=String(((V=g==null?void 0:g.querySelector(".oil-gi-id"))==null?void 0:V.value)||"").trim();return q||""}function p(g,q){let V=String(g||"").trim();if(!V)return null;let Z=G(),ee=Z.find(ce=>String(ce.dataset.bulkOilKey||"")===V);if(ee)return ee;let te=String((q==null?void 0:q.global_item_id)||"").trim();if(te&&(ee=Z.find(ce=>I(ce)===te),ee))return ee;let ue=W(q==null?void 0:q.name);return ue&&(ee=Z.find(ce=>s(ce)===ue),ee)?ee:null}function _(g,q){if(!g||!q)return;g.dataset.bulkOilKey=q.key||"";let V=g.querySelector(".oil-typeahead"),Z=g.querySelector(".oil-sap-koh"),ee=g.querySelector(".oil-iodine"),te=g.querySelector(".oil-fatty"),ue=g.querySelector(".oil-gi-id"),ce=g.querySelector(".oil-default-unit"),le=g.querySelector(".oil-category"),de=g.querySelector(".oil-grams"),pe=g.querySelector(".oil-percent");V&&(V.value=q.name||""),Z&&(Z.value=q.sap_koh>0?H(q.sap_koh,3):""),ee&&(ee.value=q.iodine>0?H(q.iodine,3):""),te&&(te.value=q.fatty_profile&&Object.keys(q.fatty_profile).length?JSON.stringify(q.fatty_profile):""),ue&&(ue.value=q.global_item_id||""),ce&&(ce.value=q.default_unit||""),le&&(le.value=q.ingredient_category_name||""),pe&&(pe.value=q.selected_pct>0?H(q.selected_pct,2):""),de&&(de.value=q.selected_weight_g>0?H(F(q.selected_weight_g),2):"")}function T(g){if(!g||!g.key)return null;let q=p(g.key,g),V=x();return!q&&V&&(q=e.oils.buildOilRow(),q&&V.appendChild(q)),_(q,g),q}function R(g,q){let V=p(g,q);V&&(O.lastOilEdit&&O.lastOilEdit.row===V&&(O.lastOilEdit=null,e.oils.clearSelectedOilProfile()),V.remove())}function D(){G().forEach(q=>{O.lastOilEdit&&O.lastOilEdit.row===q&&(O.lastOilEdit=null),q.remove()}),e.oils.clearSelectedOilProfile()}function Y(){e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}function z(g,q,V){let Z=String(V||"").trim();if(Z)return Z;let ee=String(q||"").trim();if(ee)return`global:${ee}`;let te=W(g);return te?`soapcalc:${te}`:""}function K(){let g={};return G().forEach(q=>{var Se,Ie,_e,Ce,be,qe,ae,ge,Ee;let V=String(((Se=q.querySelector(".oil-typeahead"))==null?void 0:Se.value)||"").trim(),Z=$((Ie=q.querySelector(".oil-sap-koh"))==null?void 0:Ie.value),ee=$((_e=q.querySelector(".oil-iodine"))==null?void 0:_e.value),te=String(((Ce=q.querySelector(".oil-gi-id"))==null?void 0:Ce.value)||"").trim(),ue=String(((be=q.querySelector(".oil-default-unit"))==null?void 0:be.value)||"gram"),ce=String(((qe=q.querySelector(".oil-category"))==null?void 0:qe.value)||""),le=L($((ae=q.querySelector(".oil-percent"))==null?void 0:ae.value),0,100),de=L(w((ge=q.querySelector(".oil-grams"))==null?void 0:ge.value),0),pe=String(((Ee=q.querySelector(".oil-fatty"))==null?void 0:Ee.value)||""),re={};if(pe)try{let Le=JSON.parse(pe);re=h.normalizeFattyProfile(Le)}catch{re={}}let ve=z(V,te,q.dataset.bulkOilKey);!ve||!(V||le>0||de>0||Z>0||ee>0||Object.keys(re).length>0)||(q.dataset.bulkOilKey=ve,g[ve]={key:ve,name:V||"Unnamed oil",sap_koh:Z,iodine:ee,fatty_profile:re,default_unit:ue||"gram",ingredient_category_name:ce,global_item_id:te?parseInt(te,10):null,source:te?"global":"soapcalc",is_basic:!te,selected_pct:le,selected_weight_g:de})}),g}function U(){let g=r();g.selection=K(),d()}function J(){let g=r(),q=Object.values(g.selection||{}),V=new Set(q.map(Z=>Z.key));G().forEach(Z=>{let ee=String(Z.dataset.bulkOilKey||"").trim();(!ee||!V.has(ee))&&Z.remove()}),q.slice().sort((Z,ee)=>String(Z.name||"").localeCompare(String(ee.name||""))).forEach(Z=>{T(Z)}),Y()}async function X(){var V;let g=n(),q=r();if(g.modalEl){U(),!S&&((V=M.bootstrap)!=null&&V.Modal)&&(S=M.bootstrap.Modal.getOrCreateInstance(g.modalEl)),g.searchInput&&(g.searchInput.value=q.query||""),g.modeToggle&&(g.modeToggle.checked=q.mode==="all"),g.viewSelectedToggle&&(g.viewSelectedToggle.checked=!!q.viewSelected),g.unitLabelEl&&(g.unitLabelEl.textContent=O.currentUnit||"g"),S&&S.show(),u(),d();try{await f({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}}function ne(g){let q=g.target;if(!(q instanceof HTMLElement))return;let V=q.closest("tr[data-record-key]");if(!V)return;let Z=V.dataset.recordKey||"",ee=E(Z);if(!ee)return;let te=V.querySelector(".bulk-oil-check"),ue=V.querySelector(".bulk-oil-pct"),ce=V.querySelector(".bulk-oil-weight"),le=L($(ue==null?void 0:ue.value),0,100),de=L(w(ce==null?void 0:ce.value),0),pe=le>0||de>0;if(!!(te!=null&&te.checked)||pe){te&&(te.checked=!0);let Se=i(ee,{selected_pct:le,selected_weight_g:de});T(Se)}else v(Z),R(Z,ee);let ve=r();k.has(ve.sortKey)||ve.viewSelected?(b(),t()):d(),Y(),m()}async function oe(g){let q=r();q.mode=g?"all":"basics",m();try{await f({reset:!0})}catch{a("danger","Unable to load bulk oils catalog right now.")}}function me(g){let q=r();q.viewSelected=!!g,b(),t(),m()}async function fe(g){let q=g.target instanceof HTMLElement?g.target.closest(".bulk-oil-sort"):null;if(!q)return;let V=q.getAttribute("data-sort-key")||"name",Z=r();if(Z.sortKey===V?Z.sortDir=Z.sortDir==="asc"?"desc":"asc":(Z.sortKey=V,Z.sortDir=V==="name"?"asc":"desc"),m(),k.has(Z.sortKey)){b(),t();return}try{await f({reset:!0})}catch{a("danger","Unable to load oils in that sort order.")}}function se(){let g=r();g.selection={},D(),(k.has(g.sortKey)||g.viewSelected)&&b(),t(),Y(),m()}async function ie(){let g=n(),q=r();if(!(!g.scrollEl||q.loading||!q.hasMore||!(g.scrollEl.scrollTop+g.scrollEl.clientHeight>=g.scrollEl.scrollHeight-o)))try{await f({reset:!1})}catch{a("danger","Unable to load more oils right now.")}}function ye(){P&&M.clearTimeout(P),P=M.setTimeout(async()=>{try{await f({reset:!0})}catch{a("danger","Unable to search oils right now.")}},B)}function he(){J(),m(),A()}function l(){var q;let g=n();g.unitLabelEl&&(g.unitLabelEl.textContent=O.currentUnit||"g"),(q=g.modalEl)!=null&&q.classList.contains("show")&&t()}function j(){let g=n();g.modalEl&&(g.openBtn&&g.openBtn.addEventListener("click",()=>{X()}),g.searchInput&&g.searchInput.addEventListener("input",()=>{let q=r();q.query=g.searchInput.value||"",m(),ye()}),g.modeToggle&&g.modeToggle.addEventListener("change",async()=>{await oe(!!g.modeToggle.checked)}),g.viewSelectedToggle&&g.viewSelectedToggle.addEventListener("change",()=>{me(!!g.viewSelectedToggle.checked)}),g.scrollEl&&g.scrollEl.addEventListener("scroll",ie),g.bodyEl&&(g.bodyEl.addEventListener("input",ne),g.bodyEl.addEventListener("change",ne)),g.modalEl.querySelectorAll(".bulk-oil-sort").forEach(q=>{q.addEventListener("click",fe)}),g.importBtn&&g.importBtn.addEventListener("click",()=>{he()}),g.clearBtn&&g.clearBtn.addEventListener("click",()=>{se()}),g.modalEl.addEventListener("shown.bs.modal",()=>{let q=n();q.searchInput&&q.searchInput.focus()}))}j(),d(),u(),e.bulkOilsModal={openModal:X,serializeSelection:C,restoreState:y,onUnitChanged:l}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c,round:h,clamp:N,buildSoapcalcSearchBuilder:Q}=e.helpers,{formatWeight:H,toGrams:$,fromGrams:L}=e.units,{FRAGRANCE_CATEGORY_SET:w}=e.constants,F=e.state;function O(b,u,t,f,S){var I;let P=document.getElementById(b),A=document.getElementById(u),x=f?document.getElementById(f):null,G=S?document.getElementById(S):null,W=(I=P==null?void 0:P.parentElement)==null?void 0:I.querySelector('[data-role="suggestions"]');if(!P||!W||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let s=Q();M.attachMergedInventoryGlobalTypeahead({inputEl:P,listEl:W,mode:"public",giHiddenEl:A,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:s,searchType:"ingredient",resultFilter:(p,_)=>{let T=y(p);return T?t.has(T):_==="inventory"},requireHidden:!1,onSelection:function(p){x&&(x.value=(p==null?void 0:p.default_unit)||""),G&&(G.value=(p==null?void 0:p.ingredient_category_name)||""),e.storage.queueStateSave()}}),P.addEventListener("input",function(){this.value.trim()||(x&&(x.value=""),G&&(G.value=""))})}function k({pctId:b,weightId:u}){var A,x,G;let t=document.getElementById(b),f=t==null?void 0:t.value;if(f!==""&&f!==null&&f!==void 0)return c(f);let S=N(((x=(A=e.oils)==null?void 0:A.getTotalOilsGrams)==null?void 0:x.call(A))||0,0);if(S<=0)return 0;let P=$((G=document.getElementById(u))==null?void 0:G.value);return P<=0?0:P/S*100}function o(){var b,u,t,f,S,P,A,x;return{lactatePct:k({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),sugarPct:k({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),saltPct:k({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),citricPct:k({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),lactateName:((u=(b=document.getElementById("additiveLactateName"))==null?void 0:b.value)==null?void 0:u.trim())||"Sodium Lactate",sugarName:((f=(t=document.getElementById("additiveSugarName"))==null?void 0:t.value)==null?void 0:f.trim())||"Sugar",saltName:((P=(S=document.getElementById("additiveSaltName"))==null?void 0:S.value)==null?void 0:P.trim())||"Salt",citricName:((x=(A=document.getElementById("additiveCitricName"))==null?void 0:A.value)==null?void 0:x.trim())||"Citric Acid"}}function B(){var u;return(((u=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:u.value)||"NaOH")==="NaOH"?"NaOH":"KOH"}function m(b){let u=N(c(b),0),t=N(k({pctId:"additiveLactatePct",weightId:"additiveLactateWeight"}),0),f=N(k({pctId:"additiveSugarPct",weightId:"additiveSugarWeight"}),0),S=N(k({pctId:"additiveSaltPct",weightId:"additiveSaltWeight"}),0),P=N(k({pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}),0),A=u*(t/100),x=u*(f/100),G=u*(S/100),W=u*(P/100),s=B()==="KOH"?.719:.624;return{lactatePct:t,sugarPct:f,saltPct:S,citricPct:P,lactateG:A,sugarG:x,saltG:G,citricG:W,citricLyeG:W*s}}function a({pctId:b,weightId:u,sourceField:t,totalOils:f}){let S=document.getElementById(b),P=document.getElementById(u);if(!S||!P)return;let A=N(c(f),0);if(A<=0)return;if(t==="weight"){let s=P.value;if(s===""||s===null||s===void 0){S.value="";return}let I=N($(s),0),p=I>0?I/A*100:0;S.value=p>0?h(p,2):"";return}let x=S.value;if(x===""||x===null||x===void 0){P.value="";return}let G=N(c(x),0),W=A*(G/100);P.value=W>0?h(L(W),2):""}function n(b){let u=(f,S)=>{let P=document.getElementById(f);if(P)if(P.tagName==="INPUT"){if(document.activeElement===P)return;P.value=S}else P.textContent=S},t=f=>f>0?h(L(f),2):"";u("additiveLactateWeight",t(c(b==null?void 0:b.lactateG))),u("additiveSugarWeight",t(c(b==null?void 0:b.sugarG))),u("additiveSaltWeight",t(c(b==null?void 0:b.saltG))),u("additiveCitricWeight",t(c(b==null?void 0:b.citricG))),u("additiveCitricLyeOut",H(c(b==null?void 0:b.citricLyeG)))}function r(b){let u=N(c(b),0),t=m(u);return n(t),t}function d(b){let u=b.querySelector(".fragrance-typeahead"),t=b.querySelector(".fragrance-gi-id"),f=b.querySelector(".fragrance-default-unit"),S=b.querySelector(".fragrance-category"),P=b.querySelector('[data-role="suggestions"]');if(!u||!P||typeof M.attachMergedInventoryGlobalTypeahead!="function")return;let A=Q();M.attachMergedInventoryGlobalTypeahead({inputEl:u,listEl:P,mode:"public",giHiddenEl:t,includeInventory:!1,includeGlobal:!0,ingredientFirst:!1,globalUrlBuilder:A,searchType:"ingredient",resultFilter:(x,G)=>{let W=y(x);return W?w.has(W):G==="inventory"},requireHidden:!1,onSelection:function(x){f&&(f.value=(x==null?void 0:x.default_unit)||""),S&&(S.value=(x==null?void 0:x.ingredient_category_name)||""),e.storage.queueStateSave()}}),u.addEventListener("input",function(){this.value.trim()||(f&&(f.value=""),S&&(S.value=""))})}function i(){var t,f;let b=document.getElementById("fragranceRowTemplate"),u=(f=(t=b==null?void 0:b.content)==null?void 0:t.querySelector(".fragrance-row"))==null?void 0:f.cloneNode(!0);return u?(u.querySelectorAll("input").forEach(S=>{S.value=""}),d(u),u.querySelectorAll(".unit-suffix").forEach(S=>{S.dataset.suffix=F.currentUnit}),u):document.createElement("div")}function v(b){let u=Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")),t=N(b||e.oils.getTotalOilsGrams()||0,0),f=0,S=0;u.forEach(x=>{let G=x.querySelector(".fragrance-grams"),W=x.querySelector(".fragrance-percent");if(!G||!W)return;let s=G.value,I=W.value,p=$(s),_=N(c(I),0),T=e.state.lastFragranceEdit,R=T&&T.row===x?T.field:null;t>0&&(R==="percent"?(p=t*(_/100),G.value=p>0?h(L(p),2):""):R==="grams"?(_=p/t*100,W.value=_>0?h(_,2):""):p>0?(_=p/t*100,document.activeElement!==W&&(W.value=h(_,2))):_>0&&(p=t*(_/100),document.activeElement!==G&&(G.value=h(L(p),2)))),p>0&&(f+=p),S+=_});let P=document.getElementById("fragrancePercentTotal");P&&(P.textContent=h(S,2));let A=document.getElementById("fragranceTotalComputed");return A&&(A.textContent=f>0?H(f):"--"),{totalGrams:f,totalPct:S}}function E(){let b=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(u=>{var G,W,s,I,p,_,T;let t=((W=(G=u.querySelector(".fragrance-typeahead"))==null?void 0:G.value)==null?void 0:W.trim())||"",f=((s=u.querySelector(".fragrance-grams"))==null?void 0:s.value)||"",S=((I=u.querySelector(".fragrance-percent"))==null?void 0:I.value)||"",P=((p=u.querySelector(".fragrance-gi-id"))==null?void 0:p.value)||"",A=((_=u.querySelector(".fragrance-default-unit"))==null?void 0:_.value)||"",x=((T=u.querySelector(".fragrance-category"))==null?void 0:T.value)||"";!t&&!f&&!S&&!P||b.push({name:t,grams:f,percent:S,gi:P,defaultUnit:A,categoryName:x})}),b}function C(b){let u=document.getElementById("soapVisualGuidanceList");if(!u)return;let t=Array.isArray(b==null?void 0:b.tips)&&b.tips.length?b.tips:["No visual flags detected for this formula."];u.innerHTML=t.map(f=>`<li>${f}</li>`).join("")}function y(b){return!b||typeof b!="object"?null:b.ingredient&&b.ingredient.ingredient_category_name||b.ingredient_category_name||b.ingredient_category&&b.ingredient_category.name||null}e.additives={attachAdditiveTypeahead:O,collectAdditiveSettings:o,syncAdditivePair:a,applyComputedOutputs:n,updateAdditivesOutput:r,updateVisualGuidance:C},e.fragrances={buildFragranceRow:i,updateFragranceTotals:v,collectFragranceData:E}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{toNumber:c}=e.helpers,{STAGE_CONFIGS:h}=e.constants;function N(L){var O;let w=h[L];if(!w)return;let F=document.getElementById(w.tabId);if(F){if((O=M.bootstrap)!=null&&O.Tab)bootstrap.Tab.getOrCreateInstance(F).show();else{document.querySelectorAll("#soapStageTabList .nav-link").forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-selected","false")}),document.querySelectorAll("#soapStageTabContent .tab-pane").forEach(o=>{o.classList.remove("show","active")}),F.classList.add("active"),F.setAttribute("aria-selected","true");let k=document.getElementById(w.paneId);k&&k.classList.add("show","active")}e.layout.scheduleStageHeightSync(),F.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}}function Q(L){var w,F;if(L===1){let O=document.getElementById("unitGrams");O&&(O.checked=!0),e.units.setUnit("g",{skipAutoCalc:!0}),document.getElementById("moldWaterWeight").value="",document.getElementById("moldOilPct").value="65",document.getElementById("oilTotalTarget").value="",document.getElementById("moldShape").value="loaf";let k=document.getElementById("moldCylinderCorrection");k&&(k.checked=!1),document.getElementById("moldCylinderFactor").value="0.85",e.mold.updateMoldShapeUI(),(w=e.mold)!=null&&w.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0)}if(L===2){let O=document.getElementById("oilRows");O&&(O.innerHTML="",O.appendChild(e.oils.buildOilRow())),e.oils.updateOilTotals()}if(L===3){let O=document.getElementById("lyeTypeNaoh");O&&(O.checked=!0);let k=document.getElementById("waterMethod");k&&(k.value="percent");let o=document.getElementById("lyeSuperfat");o&&(o.value="5");let B=document.getElementById("lyePurity");B&&(B.value="100");let m=document.getElementById("waterPct");m&&(m.value="33");let a=document.getElementById("lyeConcentration");a&&(a.value="33");let n=document.getElementById("waterRatio");n&&(n.value="2"),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())}if(L===4&&(document.getElementById("additiveLactatePct").value="1",document.getElementById("additiveSugarPct").value="1",document.getElementById("additiveSaltPct").value="0.5",document.getElementById("additiveCitricPct").value="0",["additiveLactateName","additiveSugarName","additiveSaltName","additiveCitricName"].forEach(O=>{let k=document.getElementById(O);k&&(k.value="")}),["additiveLactateGi","additiveSugarGi","additiveSaltGi","additiveCitricGi"].forEach(O=>{let k=document.getElementById(O);k&&(k.value="")}),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams())),L===5){let O=document.getElementById("fragranceRows");O&&(O.innerHTML="",(F=e.fragrances)!=null&&F.buildFragranceRow&&O.appendChild(e.fragrances.buildFragranceRow()));let k=document.getElementById("fragrancePercentTotal");k&&(k.textContent="0");let o=document.getElementById("fragranceTotalComputed");o&&(o.textContent="--")}e.storage.queueStateSave(),e.storage.queueAutoCalc(),$()}function H(L){var w;if(L===1){let F=c(document.getElementById("moldWaterWeight").value),O=c(document.getElementById("oilTotalTarget").value),k=c(document.getElementById("moldOilPct").value),B=!!document.querySelector('input[name="weight_unit"]:checked')&&(F>0||O>0)&&k>0;return{state:B?"complete":"incomplete",label:B?"Sized":"Needs target"}}if(L===2){let O=Array.from(document.querySelectorAll("#oilRows .oil-row")).some(k=>{var a,n,r,d;let o=(n=(a=k.querySelector(".oil-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),B=c((r=k.querySelector(".oil-grams"))==null?void 0:r.value),m=c((d=k.querySelector(".oil-percent"))==null?void 0:d.value);return o&&(B>0||m>0)});return{state:O?"complete":"incomplete",label:O?"Oils added":"Add oils"}}if(L===3){let F=c(document.getElementById("lyeSuperfat").value),O=(w=document.getElementById("waterMethod"))==null?void 0:w.value,o=!!document.querySelector('input[name="lye_type"]:checked')&&!!O&&F>=0;return{state:o?"complete":"incomplete",label:o?"Configured":"Set lye"}}return L===4?{state:"optional",label:["additiveLactatePct","additiveSugarPct","additiveSaltPct","additiveCitricPct"].some(O=>c(document.getElementById(O).value)>0)?"Added":"Optional"}:L===5?{state:"optional",label:Array.from(document.querySelectorAll("#fragranceRows .fragrance-row")).some(k=>{var a,n,r,d;let o=(n=(a=k.querySelector(".fragrance-typeahead"))==null?void 0:a.value)==null?void 0:n.trim(),B=c((r=k.querySelector(".fragrance-grams"))==null?void 0:r.value),m=c((d=k.querySelector(".fragrance-percent"))==null?void 0:d.value);return o||B>0||m>0})?"Added":"Optional"}:{state:"incomplete",label:"Incomplete"}}function $(){let L=document.getElementById("soapStageTabList");L&&L.querySelectorAll(".soap-stage-status").forEach(F=>F.remove());let w=document.getElementById("soapStageProgress");w&&(w.textContent="")}e.stages={openStageByIndex:N,resetStage:Q,updateStageStatuses:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h,clamp:N}=e.helpers,{computeFattyAcids:Q,computeQualities:H,computeOilQualityScores:$}=e.calc,{QUALITY_RANGES:L,QUALITY_HINTS:w,QUALITY_FEEL_HINTS:F,IODINE_RANGE:O,IODINE_SCALE_MAX:k,INS_RANGE:o,INS_SCALE_MAX:B,QUALITY_BASE:m,QUALITY_PRESETS:a,FATTY_BAR_COLORS:n,FATTY_DISPLAY_KEYS:r}=e.constants,{pulseValue:d,showSoapAlert:i}=e.ui;function v({barId:x,fillId:G,value:W,max:s,label:I}){let p=document.getElementById(x),_=document.getElementById(G);if(!p||!_)return null;let T=isFinite(W)?W:0,R=Math.max(0,Math.min(s,T)),D=s>0?R/s*100:0;return _.style.width=`${D}%`,p.setAttribute("aria-valuemin","0"),p.setAttribute("aria-valuemax",String(s)),p.setAttribute("aria-valuenow",R.toFixed(1)),I&&p.setAttribute("aria-label",I),{bar:p,fill:_,value:T}}function E(x,G,W){if(!(!x||!W)){if(x.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary"),!isFinite(G)){x.classList.add("bg-secondary");return}G<W[0]?x.classList.add("bg-warning"):G>W[1]?x.classList.add("bg-danger"):x.classList.add("bg-success")}}function C(x,G,W,s,I,p){let _=v({barId:x,fillId:G,value:W,max:I,label:p});_&&E(_.fill,W,s)}function y(){let x={hardness:{range:L.hardness,scale:100},cleansing:{range:L.cleansing,scale:100},conditioning:{range:L.conditioning,scale:100},bubbly:{range:L.bubbly,scale:100},creamy:{range:L.creamy,scale:100},iodine:{range:O,scale:k},ins:{range:o,scale:B}};Object.entries(x).forEach(([G,W])=>{let[s,I]=W.range,p=W.scale,_=G.charAt(0).toUpperCase()+G.slice(1),T=G==="iodine"?"iodineBar":G==="ins"?"insBar":`quality${_}Bar`,R=document.getElementById(`quality${_}Safe`);if(R){let K=Math.max(0,Math.min(100,s/p*100)),U=Math.max(0,Math.min(100,(I-s)/p*100));R.style.left=`${K}%`,R.style.width=`${U}%`,R.title=`Safe range ${c(s,0)}-${c(I,0)}`}let D=document.getElementById(T);D&&(D.dataset.safeRange=`${c(s,0)}-${c(I,0)}`);let Y=document.getElementById(`quality${_}RangeMin`),z=document.getElementById(`quality${_}RangeMax`);Y&&(Y.textContent=c(s,0)),z&&(z.textContent=c(I,0))})}function b(x,G){let W=N(x.hardness||0,0,100),s=N(x.bubbly||0,0,100),I=N(x.conditioning||0,0,100),p=N(I+(G||0)*3,0,100),_=document.getElementById("feelHardness"),T=document.getElementById("feelBubbly"),R=document.getElementById("feelConditioning"),D=document.getElementById("feelGreasy");_&&(_.value=c(W,1)),T&&(T.value=c(s,1)),R&&(R.value=c(I,1)),D&&(D.value=c(p,1))}function u(x){r.forEach(G=>{let W=document.getElementById(`fattyBar${G.charAt(0).toUpperCase()}${G.slice(1)}`);if(!W)return;let s=N(h(x[G]),0,100),I=s;W.style.width=`${I}%`,W.style.backgroundColor=n[G]||"var(--color-muted)",W.title=`${G.charAt(0).toUpperCase()}${G.slice(1)}: ${c(s,1)}%`})}function t(){var s;let x=((s=document.getElementById("qualityPreset"))==null?void 0:s.value)||"balanced",G=Array.from(document.querySelectorAll(".quality-focus:checked"));if(x==="none"&&!G.length)return null;let W=x==="none"?{...m}:a[x]?{...a[x]}:{...m};return G.forEach(I=>{let p=I.dataset.attr,_=I.dataset.direction,T=L[p];T&&(W[p]=_==="low"?T[0]:T[1])}),W}function f(){let x=t(),G={hardness:document.getElementById("qualityHardnessTarget"),cleansing:document.getElementById("qualityCleansingTarget"),conditioning:document.getElementById("qualityConditioningTarget"),bubbly:document.getElementById("qualityBubblyTarget"),creamy:document.getElementById("qualityCreamyTarget"),iodine:document.getElementById("iodineTarget"),ins:document.getElementById("insTarget")};Object.entries(G).forEach(([W,s])=>{if(!s)return;let I=document.getElementById(`${s.id}Label`);if(!x){s.classList.add("d-none"),I&&(I.textContent="");return}let p=h(x[W]);if(!isFinite(p)){s.classList.add("d-none"),I&&(I.textContent="");return}let _=W==="iodine"?k:W==="ins"?B:100,T=N(p,0,_);s.classList.remove("d-none"),s.style.left=`${T/_*100}%`,s.setAttribute("aria-label",`Apply ${W} target`),s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.title=`Target ${W}: ${c(p,1)}`,I&&(I.textContent=c(p,1))})}function S(){let x=t();if(!x){i("info","Select a quality target to nudge the blend.",{dismissible:!0,timeoutMs:5e3});return}let W=Array.from(document.querySelectorAll("#oilRows .oil-row")).map(U=>{var oe,me;let J=e.units.toGrams((oe=U.querySelector(".oil-grams"))==null?void 0:oe.value),X=((me=U.querySelector(".oil-fatty"))==null?void 0:me.value)||"",ne=null;if(X)try{ne=JSON.parse(X)}catch{ne=null}return{row:U,grams:J,fattyProfile:ne}}).filter(U=>U.grams>0);if(!W.length){i("warning","Add oils before nudging toward a target.",{dismissible:!0,timeoutMs:5e3});return}let s=Q(W.map(U=>({grams:U.grams,fattyProfile:U.fattyProfile}))),I=H(s.percent),p={hardness:N((x.hardness-I.hardness)/100,-1,1),cleansing:N((x.cleansing-I.cleansing)/100,-1,1),conditioning:N((x.conditioning-I.conditioning)/100,-1,1),bubbly:N((x.bubbly-I.bubbly)/100,-1,1),creamy:N((x.creamy-I.creamy)/100,-1,1)},_=W.reduce((U,J)=>U+J.grams,0),T=[],R=0,D=.8,Y=W.filter(U=>!U.fattyProfile||typeof U.fattyProfile!="object").length;if(Y===W.length){i("warning","None of the selected oils have fatty acid data, so targets cannot be applied.",{dismissible:!0,timeoutMs:6e3});return}if(Y&&i("info","Some oils are missing fatty acid data. The nudge will only use oils with profiles.",{dismissible:!0,timeoutMs:5e3}),W.forEach(U=>{let J=$(U.fattyProfile),X=p.hardness*J.hardness+p.cleansing*J.cleansing+p.conditioning*J.conditioning+p.bubbly*J.bubbly+p.creamy*J.creamy,ne=N(1+X*D,.2,1.8),oe=U.grams*ne;T.push({row:U.row,grams:oe}),R+=oe}),R<=0){i("warning","Unable to adjust blend with current data.",{dismissible:!0,timeoutMs:5e3});return}let z=_/R,K=e.oils.getOilTargetGrams()||_;T.forEach(U=>{let J=U.grams*z,X=U.row.querySelector(".oil-grams"),ne=U.row.querySelector(".oil-percent");if(X&&(X.value=J>0?c(e.units.fromGrams(J),2):""),ne&&K>0){let oe=J/K*100;ne.value=oe>0?c(oe,2):""}}),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc(),i("info","Blend nudged toward selected targets. Re-check results and adjust as needed.",{dismissible:!0,timeoutMs:6e3})}function P(x){let{qualities:G,fattyPercent:W,coveragePct:s,iodine:I,ins:p,sapAvg:_,superfat:T,warnings:R}=x,D=s>0;function Y(se,ie){var q,V;let ye=document.getElementById(`quality${se}Value`),he=document.getElementById(`quality${se}Hint`);if(!ye)return;ye.textContent=D&&isFinite(ie)?c(ie,1):"--",d(ye);let l=se.toLowerCase(),j=L[l],g=v({barId:`quality${se}Bar`,fillId:`quality${se}Fill`,value:D?ie:0,max:100,label:se});g&&j&&(E(g.fill,ie,j),D&&isFinite(ie)?g.bar.title=`${se}: ${c(ie,1)} (safe ${j[0]}-${j[1]}). ${w[l]||""}`.trim():g.bar.title=`${se}: -- (safe ${j[0]}-${j[1]}). ${w[l]||""}`.trim()),he&&j&&(!D||!isFinite(ie)?he.textContent="":ie<j[0]?he.textContent=((q=F[l])==null?void 0:q.low)||"":ie>j[1]?he.textContent=((V=F[l])==null?void 0:V.high)||"":he.textContent="")}Y("Hardness",G.hardness),Y("Cleansing",G.cleansing),Y("Conditioning",G.conditioning),Y("Bubbly",G.bubbly),Y("Creamy",G.creamy);let z=document.getElementById("fattyCoverageNote");z&&(z.textContent=s>0?`Fatty acid coverage: ${c(s,1)}% of oils`:"Fatty acid coverage: not enough data yet");let K=document.getElementById("iodineValue"),U=document.getElementById("insValue"),J=document.getElementById("sapAvgValue");K&&(K.textContent=I>0?c(I,1):"--",d(K)),U&&(U.textContent=p>0?c(p,1):"--",d(U)),J&&(J.textContent=_>0?c(_,1):"--",d(J)),C("iodineBar","iodineFill",I,O,k,"Iodine"),C("insBar","insFill",p,o,B,"INS");let X=(W.lauric||0)+(W.myristic||0)+(W.palmitic||0)+(W.stearic||0),ne=(W.ricinoleic||0)+(W.oleic||0)+(W.linoleic||0)+(W.linolenic||0),oe=document.getElementById("fattySatRatioResult");oe&&(oe.textContent=X+ne>0?`${c(X,0)}:${c(ne,0)}`:"--",d(oe)),r.forEach(se=>{let ie=`fatty${se.charAt(0).toUpperCase()}${se.slice(1)}`,ye=W[se];document.getElementById(ie).textContent=D&&ye?`${c(ye,1)}%`:"--"}),b(G,T||0),u(W),f();let me=Array.isArray(R)?R.slice():[],fe=document.getElementById("soapQualityWarnings");me.length?(fe.classList.remove("d-none"),fe.innerHTML=`<strong>Guidance & flags:</strong><ul class="mb-0">${me.map(se=>`<li>${se}</li>`).join("")}</ul>`):(fe.classList.add("d-none"),fe.textContent=""),e.layout.scheduleStageHeightSync()}function A(){var x;document.querySelectorAll(".soap-quality-help").forEach(G=>{let W=G.dataset.quality;w[W]&&G.setAttribute("title",w[W])}),(x=M.bootstrap)!=null&&x.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(G=>{bootstrap.Tooltip.getOrCreateInstance(G)})}e.quality={setQualityRangeBars:y,updateQualityTargets:f,applyQualityTargets:S,updateQualitiesDisplay:P,initQualityTooltips:A}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h,clamp:N}=e.helpers;function Q(o){let B=0,m=0;return(o||[]).forEach(a=>{let n=h(a==null?void 0:a.sapKoh),r=h(a==null?void 0:a.grams);n>0&&r>0&&(B+=n*r,m+=r)}),m>0?B/m:0}function H(o){var v,E,C,y,b,u,t,f,S,P,A,x;let B=o.qualityReport||{},m=B.fatty_acids_pct||{},a=B.qualities||{},n=isFinite(o.sapAvg)&&o.sapAvg>0?o.sapAvg:h(B.sap_avg_koh)||Q(o.oils||[]),r=h(B.iodine),d=h(B.ins)||(n&&r?n-r:0),i=e.mold.getMoldSettings();return{source:"soap_tool",schema_version:1,unit_display:e.state.currentUnit,input_mode:"mixed",quality_preset:((v=document.getElementById("qualityPreset"))==null?void 0:v.value)||"balanced",quality_focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(G=>G.id),mold:i,oils:(o.oils||[]).map(G=>({name:G.name||null,grams:c(G.grams||0,2),iodine:G.iodine||null,sap_koh:G.sapKoh||null,fatty_profile:G.fattyProfile||null,global_item_id:G.global_item_id||null,default_unit:G.default_unit||null,ingredient_category_name:G.ingredient_category_name||null})),totals:{total_oils_g:c(o.totalOils||0,2),batch_yield_g:c(o.batchYield||0,2),lye_pure_g:c(o.lyePure||0,2),lye_adjusted_g:c(o.lyeAdjusted||0,2),water_g:c(o.water||0,2)},lye:{lye_type:o.lyeType,superfat:o.superfat,purity:o.purity,water_method:o.waterMethod,water_pct:o.waterPct,lye_concentration:o.lyeConcentration,water_ratio:o.waterRatio},additives:{fragrance_pct:((E=o.additives)==null?void 0:E.fragrancePct)||0,lactate_pct:((C=o.additives)==null?void 0:C.lactatePct)||0,sugar_pct:((y=o.additives)==null?void 0:y.sugarPct)||0,salt_pct:((b=o.additives)==null?void 0:b.saltPct)||0,citric_pct:((u=o.additives)==null?void 0:u.citricPct)||0,fragrance_g:c(((t=o.additives)==null?void 0:t.fragranceG)||0,2),lactate_g:c(((f=o.additives)==null?void 0:f.lactateG)||0,2),sugar_g:c(((S=o.additives)==null?void 0:S.sugarG)||0,2),salt_g:c(((P=o.additives)==null?void 0:P.saltG)||0,2),citric_g:c(((A=o.additives)==null?void 0:A.citricG)||0,2),citric_lye_g:c(((x=o.additives)==null?void 0:x.citricLyeG)||0,2)},qualities:{hardness:c(a.hardness||0,1),cleansing:c(a.cleansing||0,1),conditioning:c(a.conditioning||0,1),bubbly:c(a.bubbly||0,1),creamy:c(a.creamy||0,1),iodine:c(r||0,1),ins:c(d||0,1),sap_avg:c(n||0,1)},fatty_acids:m,updated_at:new Date().toISOString()}}function $(o,B,m,a,n){var E,C,y,b,u;let r=(C=(E=document.getElementById(o))==null?void 0:E.value)==null?void 0:C.trim(),d=((y=document.getElementById(B))==null?void 0:y.value)||"",i=a&&((b=document.getElementById(a))==null?void 0:b.value)||"",v=n&&((u=document.getElementById(n))==null?void 0:u.value)||"";return{name:r||m,globalItemId:d?parseInt(d):void 0,defaultUnit:i||void 0,categoryName:v||void 0}}function L(o){let B=[],m=N(o||e.oils.getTotalOilsGrams()||0,0);return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(a=>{var b,u,t,f,S,P,A;let n=(u=(b=a.querySelector(".fragrance-typeahead"))==null?void 0:b.value)==null?void 0:u.trim(),r=((t=a.querySelector(".fragrance-gi-id"))==null?void 0:t.value)||"",d=((f=a.querySelector(".fragrance-default-unit"))==null?void 0:f.value)||"",i=((S=a.querySelector(".fragrance-category"))==null?void 0:S.value)||"",v=(P=a.querySelector(".fragrance-grams"))==null?void 0:P.value,E=(A=a.querySelector(".fragrance-percent"))==null?void 0:A.value,C=e.units.toGrams(v),y=N(h(E),0);C<=0&&y>0&&m>0&&(C=m*(y/100)),!(!n&&!r&&C<=0)&&B.push({name:n||"Fragrance/Essential Oils",globalItemId:r?parseInt(r):void 0,defaultUnit:d||void 0,categoryName:i||void 0,grams:C,pct:y})}),B}function w(o,B){let m=[];return document.querySelectorAll(`#${o} .row`).forEach(function(a){var E,C,y;let n=(C=(E=a.querySelector(".tool-typeahead"))==null?void 0:E.value)==null?void 0:C.trim(),r=((y=a.querySelector(".tool-gi-id"))==null?void 0:y.value)||"",d=a.querySelector(".tool-qty"),i=a.querySelector(".tool-unit"),v=d&&d.value!=="";!n&&!r||(B==="container"?m.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:v?parseFloat(d.value):1}):m.push({name:n||void 0,global_item_id:r?parseInt(r):void 0,quantity:v?parseFloat(d.value):0,unit:((i==null?void 0:i.value)||"").trim()||"gram"}))}),m}function F(o){let B=e.config.isAuthenticated?"member":"public",m=e.config.isAuthenticated?"recipe":"public";return buildToolLineRow(o,{context:B,mode:m,unitOptionsHtml:e.config.unitOptionsHtml})}function O(o,B){let m=F(o),a=m.querySelector(".tool-typeahead"),n=m.querySelector(".tool-qty");a&&(a.value=B),n&&o==="container"&&(n.value=1),o==="container"?document.getElementById("tool-containers").appendChild(m):o==="consumable"?document.getElementById("tool-consumables").appendChild(m):document.getElementById("tool-ingredients").appendChild(m)}function k(o){var r,d,i,v;let B=H(o),m=(o.oils||[]).map(E=>({name:E.name||void 0,global_item_id:E.global_item_id||void 0,quantity:E.grams,unit:"gram",default_unit:E.default_unit||void 0,ingredient_category_name:E.ingredient_category_name||void 0})),a=o.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)";if(o.lyeAdjusted>0&&m.push({name:a,quantity:c(o.lyeAdjusted,2),unit:"gram"}),o.water>0&&m.push({name:"Distilled Water",quantity:c(o.water,2),unit:"gram"}),L(o.totalOils||0).forEach(E=>{E.grams>0&&m.push({name:E.name,global_item_id:E.globalItemId,quantity:c(E.grams,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}),((r=o.additives)==null?void 0:r.lactateG)>0){let E=$("additiveLactateName","additiveLactateGi","Sodium Lactate","additiveLactateUnit","additiveLactateCategory");m.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.lactateG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((d=o.additives)==null?void 0:d.sugarG)>0){let E=$("additiveSugarName","additiveSugarGi","Sugar","additiveSugarUnit","additiveSugarCategory");m.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.sugarG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((i=o.additives)==null?void 0:i.saltG)>0){let E=$("additiveSaltName","additiveSaltGi","Salt","additiveSaltUnit","additiveSaltCategory");m.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.saltG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName})}if(((v=o.additives)==null?void 0:v.citricG)>0){let E=$("additiveCitricName","additiveCitricGi","Citric Acid","additiveCitricUnit","additiveCitricCategory");m.push({name:E.name,global_item_id:E.globalItemId,quantity:c(o.additives.citricG,2),unit:"gram",default_unit:E.defaultUnit,ingredient_category_name:E.categoryName}),m.push({name:"Extra Lye for Citric Acid",quantity:c(o.additives.citricLyeG,2),unit:"gram"})}return{name:"Soap (Draft)",instructions:"Draft from Soap Tools",predicted_yield:Math.round((o.batchYield||0)*100)/100,predicted_yield_unit:"gram",category_name:"Soaps",category_data:{soap_superfat:o.superfat,soap_lye_type:o.lyeType,soap_lye_purity:o.purity,soap_water_method:o.waterMethod,soap_water_pct:o.waterPct,soap_lye_concentration:o.lyeConcentration,soap_water_ratio:o.waterRatio,soap_oils_total_g:o.totalOils,soap_lye_g:o.lyeAdjusted,soap_water_g:o.water},ingredients:m.concat(w("tool-ingredients","ingredient")),consumables:w("tool-consumables","consumable"),containers:w("tool-containers","container"),notes:JSON.stringify(B)}}e.recipePayload={collectFragranceRows:L,collectDraftLines:w,buildLineRow:F,addStubLine:O,buildSoapRecipePayload:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h,clamp:N}=e.helpers,{formatWeight:Q,formatPercent:H}=e.units;function $(){var v;let a=((v=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:v.value)||"NaOH",n=document.getElementById("lyePurity"),r=n==null?void 0:n.value,d=h(n==null?void 0:n.value),i=a==="NaOH"?"NaOH":"KOH";return(r===""||r===null||r===void 0||!isFinite(d))&&(d=100),{selected:a,lyeType:i,purity:d}}function L(){let a=document.getElementById("lyePurity"),n=$();if(a)if(a.removeAttribute("readonly"),n.selected==="KOH90"){let r=document.getElementById("lyePurityHint");r&&(r.textContent="90% KOH selected. Safe default purity is 90%.")}else{let r=document.getElementById("lyePurityHint");r&&(r.textContent="Safe default is 100%.")}}function w(a){return a==="concentration"?"Concentration mode uses lye amount, so superfat and purity change water.":a==="ratio"?"Ratio mode uses lye amount, so superfat and purity change water.":"Percent mode uses oils total, so superfat changes lye but not water."}function F(a=null,n=null){var v;let r=document.getElementById("stageWaterOutput"),d=document.getElementById("stageWaterComputedHint"),i=n||(a==null?void 0:a.waterMethod)||((v=document.getElementById("waterMethod"))==null?void 0:v.value)||"percent";if(r){let E=a&&isFinite(a.waterG)&&a.waterG>0;r.textContent=E?Q(a.waterG):"--"}if(d){if(!a||!isFinite(a.totalOils)||a.totalOils<=0){d.textContent=`Set oils in Stage 2 to calculate water. ${w(i)}`;return}if(i==="concentration"){let E=a.lyeConcentrationInput||a.lyeConcentration||0;d.textContent=`Using ${c(E,1)}% lye concentration from ${Q(a.lyeAdjusted||0)} lye.`;return}if(i==="ratio"){let E=a.waterRatioInput||a.waterRatio||0;d.textContent=`Using ${c(E,2)} : 1 water-to-lye ratio from ${Q(a.lyeAdjusted||0)} lye.`;return}d.textContent=`Using ${c(a.waterPct||0,1)}% of total oils (${Q(a.totalOils)}).`}}function O(a=null,n=null){var P;let r=document.getElementById("lyeWaterPreviewAnchor"),d=document.getElementById("lyePreview"),i=document.getElementById("waterPreview"),v=document.getElementById("concPreview"),E=document.getElementById("ratioPreview");if(!r&&!d&&!i&&!v&&!E)return;let C=(A,x)=>{A&&(A.textContent=x)},y=n||(a==null?void 0:a.waterMethod)||((P=document.getElementById("waterMethod"))==null?void 0:P.value)||"percent",b=h(a==null?void 0:a.totalOils),u=h(a==null?void 0:a.lyeAdjusted),t=h(a==null?void 0:a.waterG);if(b<=0||u<=0){C(r,"Based on -- oils. All values update live as you change inputs."),C(d,"--"),C(i,"--"),C(v,"--"),C(E,"--");return}let f=h(a==null?void 0:a.lyeConcentration)>0?h(a==null?void 0:a.lyeConcentration):u+t>0?u/(u+t)*100:0,S=h(a==null?void 0:a.waterRatio)>0?h(a==null?void 0:a.waterRatio):u>0?t/u:0;if(C(r,`Based on ${Q(b)} oils. All values update live as you change inputs.`),C(d,Q(u)),C(i,Q(t)),C(v,f>0?H(f):"--"),C(E,S>0?`${c(S,2)} : 1`:"--"),y==="concentration"){let A=h(a==null?void 0:a.lyeConcentrationInput);A>0&&C(v,H(A))}if(y==="ratio"){let A=h(a==null?void 0:a.waterRatioInput);A>0&&C(E,`${c(A,2)} : 1`)}}function k(){var n;let a=((n=document.getElementById("waterMethod"))==null?void 0:n.value)||"percent";document.querySelectorAll(".water-input").forEach(r=>{r.classList.toggle("d-none",r.dataset.method!==a)}),F(null,a),O(null,a)}function o(){let a=e.oils.updateOilTotals(),n=a.totalWeight,r=a.totalPct,d=[],i=e.oils.collectOilData(),v=e.oils.getOilTargetGrams(),C=Array.from(document.querySelectorAll("#oilRows .oil-percent")).map(y=>N(h(y.value),0)).some(y=>y>0);return(!i.length||n<=0)&&d.push("Add at least one oil with a weight or percent."),!v&&n<=0&&C&&d.push("Enter a total oils target or weights to convert percentages."),v>0&&r>0&&Math.abs(r-100)>.5&&d.push("Oil percentages should total 100% (use Normalize to fix)."),v>0&&n>v+.01?d.push("Oil weights exceed the mold target."):!v&&r>100.01&&d.push("Oil percentages exceed 100%."),{ok:d.length===0,errors:d,totals:a,oils:i}}function B(){let a=document.getElementById("lyeSuperfat"),n=a==null?void 0:a.value,r=h(n);return(n===""||n===null||n===void 0||!isFinite(r))&&(r=5),r}function m(){var E,C,y,b;let n=$().purity;isFinite(n)||(n=100);let r=((E=document.getElementById("waterMethod"))==null?void 0:E.value)||"percent",d=h((C=document.getElementById("waterPct"))==null?void 0:C.value),i=h((y=document.getElementById("lyeConcentration"))==null?void 0:y.value),v=h((b=document.getElementById("waterRatio"))==null?void 0:b.value);return{purity:n,waterMethod:r,waterPct:d,lyeConcentration:i,waterRatio:v}}e.runnerInputs={getLyeSelection:$,applyLyeSelection:L,setWaterMethod:k,updateStageWaterSummary:F,updateLiveCalculationPreview:O,validateCalculation:o,readSuperfatInput:B,sanitizeLyeInputs:m}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{getStorage:c}=e.helpers;function h(){if(!e.config.calcLimit)return{count:0,date:null};let L=c();if(!L)return{count:0,date:null};try{let w=L.getItem("soap_calc_usage"),F=new Date().toISOString().slice(0,10);if(!w)return{count:0,date:F};let O=JSON.parse(w);return!O||O.date!==F?{count:0,date:F}:{count:Number(O.count)||0,date:F}}catch{return{count:0,date:null}}}function N(L){if(!e.config.calcLimit)return;let w=c();if(!w)return;let F=new Date().toISOString().slice(0,10);try{w.setItem("soap_calc_usage",JSON.stringify({count:L,date:F}))}catch{}}function Q(){return e.config.calcLimit&&h().count>=e.config.calcLimit?(e.ui.showSoapAlert("warning",`You have reached the ${e.config.calcLimit} calculation limit for ${e.config.calcTier} accounts. Create a free account or upgrade to keep calculating.`,{dismissible:!0}),!1):!0}function H(){if(!e.config.calcLimit)return;let w=h().count+1;N(w);let F=Math.max(0,e.config.calcLimit-w);F<=1&&e.ui.showSoapAlert("info",`You have ${F} calculation${F===1?"":"s"} left on the ${e.config.calcTier} tier today.`,{dismissible:!0,timeoutMs:6e3})}function $(L){if(!e.config.calcLimit||L===null||L>1)return;let w=document.getElementById("soapSignupModal");w&&(M.bootstrap&&M.bootstrap.Modal?M.bootstrap.Modal.getOrCreateInstance(w).show():e.ui.showSoapAlert("info","You are almost at the free limit. Create a free account to keep saving your work.",{dismissible:!0,timeoutMs:7e3}))}e.runnerQuota={canConsumeCalcQuota:Q,consumeCalcQuota:H,maybeShowSignupModal:$}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state;function h({oils:Q,selection:H,superfat:$,purity:L,waterMethod:w,waterPct:F,lyeConcentration:O,waterRatio:k,totalOils:o}){let B=e.additives.collectAdditiveSettings(),m=e.recipePayload.collectFragranceRows(o||0);return{oils:(Q||[]).map(a=>({name:a.name||null,grams:a.grams||0,sap_koh:a.sapKoh||0,iodine:a.iodine||0,fatty_profile:a.fattyProfile||null,global_item_id:a.global_item_id||null,default_unit:a.default_unit||null,ingredient_category_name:a.ingredient_category_name||null})),fragrances:m.map(a=>({name:a.name||"Fragrance/Essential Oils",grams:a.grams||0,pct:a.pct||0})),additives:{lactate_pct:B.lactatePct||0,sugar_pct:B.sugarPct||0,salt_pct:B.saltPct||0,citric_pct:B.citricPct||0,lactate_name:B.lactateName||"Sodium Lactate",sugar_name:B.sugarName||"Sugar",salt_name:B.saltName||"Salt",citric_name:B.citricName||"Citric Acid"},lye:{selected:(H==null?void 0:H.selected)||"NaOH",superfat:$,purity:L},water:{method:w,water_pct:F,lye_concentration:O,water_ratio:k},meta:{unit_display:c.currentUnit||"g"}}}async function N(Q){var w;let H=((w=document.querySelector('meta[name="csrf-token"]'))==null?void 0:w.getAttribute("content"))||"",$=new AbortController,L=M.setTimeout(()=>$.abort(),2500);try{let F=await fetch("/tools/api/soap/calculate",{method:"POST",signal:$.signal,headers:{"Content-Type":"application/json",...H?{"X-CSRFToken":H}:{}},body:JSON.stringify(Q||{})});if(!F.ok)return null;let O=await F.json();return!O||O.success!==!0||typeof O.result!="object"?null:O.result}catch{return null}finally{M.clearTimeout(L)}}e.runnerService={buildServicePayload:h,calculateWithSoapService:N}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{round:c,toNumber:h}=e.helpers,{formatWeight:N,formatPercent:Q}=e.units,H=e.state,$={lactateG:0,sugarG:0,saltG:0,citricG:0,citricLyeG:0,fragranceG:0,fragrancePct:0};function L(o){return(o||[]).map(B=>{var m;return{name:B.name||null,grams:h(B.grams),sapKoh:h((m=B.sap_koh)!=null?m:B.sapKoh),iodine:h(B.iodine),fattyProfile:B.fatty_profile||B.fattyProfile||null,global_item_id:B.global_item_id||null,default_unit:B.default_unit||null,ingredient_category_name:B.ingredient_category_name||null}})}function w(o,B){let m=document.getElementById(o);m&&(m.textContent=B)}function F({resultsCard:o,lyeAdjusted:B,waterData:m,batchYield:a,totalOils:n,superfat:r}){let d=document.getElementById("resultsCard");d&&(d.style.display="block");let i=h(o.water_lye_ratio)||m.waterRatio;w("lyeAdjustedOutput",N(h(o.lye_adjusted_g)||B)),w("waterOutput",N(h(o.water_g)||m.waterG)),w("batchYieldOutput",N(a)),w("lyeConcentrationOutput",Q(h(o.lye_concentration_pct)||m.lyeConcentration)),w("waterRatioOutput",isFinite(i)&&i>0?c(i,2).toString():"--"),w("totalOilsOutput",N(n)),w("superfatOutput",Q(r)),["lyeAdjustedOutput","waterOutput","batchYieldOutput","lyeConcentrationOutput","waterRatioOutput","totalOilsOutput","superfatOutput"].forEach(v=>e.ui.pulseValue(document.getElementById(v)))}function O({showAlerts:o,lyeTotals:B,purity:m,waterData:a}){if(!o)return;B.usedFallback&&e.ui.showSoapAlert("info","Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.",{dismissible:!0,timeoutMs:7e3}),m<100&&e.ui.showSoapAlert("info",`Lye purity is set to ${c(m,1)}%. Adjusting lye to match your real-world purity.`,{dismissible:!0,timeoutMs:6e3}),(a.lyeConcentration<25||a.lyeConcentration>45)&&e.ui.showSoapAlert("warning","Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.",{dismissible:!0,timeoutMs:7e3});let n=e.mold.getMoldSettings();n.shape==="cylinder"&&n.waterWeight>0&&!n.useCylinder&&e.ui.showSoapAlert("info","Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.",{dismissible:!0,timeoutMs:7e3})}function k({serviceResult:o,validation:B,selection:m,superfat:a,purity:n,waterMethod:r,waterPct:d,lyeConcentrationInput:i,waterRatioInput:v,showAlerts:E}){var Y;let C=o.lye_type||m.lyeType||"NaOH",y=h(o.total_oils_g)||B.totals.totalWeight,b=h(o.superfat_pct),u=isFinite(b)?b:a,t={sapAvg:h(o.sap_avg_koh),usedFallback:!!o.used_sap_fallback},f=h(o.lye_pure_g),S=h(o.lye_adjusted_g),P=h(o.lye_purity_pct)||n,A=o.water_method||r,x=h(o.water_pct)||d,G=h(o.lye_concentration_input_pct)||i,W=h(o.water_ratio_input)||v,s={waterG:h(o.water_g),lyeConcentration:h(o.lye_concentration_pct),waterRatio:h(o.water_lye_ratio)},I=o.results_card||{},p=o.quality_report||{},_=L(o.oils||B.oils),T={waterG:s.waterG,lyeAdjusted:S,totalOils:y,waterMethod:A,waterPct:x,lyeConcentrationInput:G,waterRatioInput:W,lyeConcentration:s.lyeConcentration,waterRatio:s.waterRatio};e.runnerInputs.updateStageWaterSummary(T),e.runnerInputs.updateLiveCalculationPreview(T);let R=o.additives||$;e.additives.applyComputedOutputs&&e.additives.applyComputedOutputs(R);let D=h(I.batch_yield_g)||y+S+s.waterG+R.fragranceG+R.lactateG+R.sugarG+R.saltG+R.citricG;return(Y=e.mold)!=null&&Y.updateWetBatterWarning&&e.mold.updateWetBatterWarning(D),F({resultsCard:I,lyeAdjusted:S,waterData:s,batchYield:D,totalOils:y,superfat:u}),e.ui.updateResultsWarnings(s),e.ui.updateResultsMeta(),e.quality.updateQualitiesDisplay({qualities:p.qualities||{},fattyPercent:p.fatty_acids_pct||{},coveragePct:h(p.coverage_pct),iodine:h(p.iodine),ins:h(p.ins),sapAvg:t.sapAvg,superfat:u,waterData:s,additives:R,oils:_,totalOils:y,warnings:p.warnings||[]}),e.additives.updateVisualGuidance({tips:p.visual_guidance||[]}),e.stages.updateStageStatuses(),O({showAlerts:E,lyeTotals:t,purity:P,waterData:s}),H.lastCalc={totalOils:y,oils:_,lyeType:C,superfat:u,purity:P,lyePure:f,lyeAdjusted:S,water:s.waterG,waterMethod:A,waterPct:x,lyeConcentration:s.lyeConcentration,waterRatio:s.waterRatio,sapAvg:t.sapAvg,usedSapFallback:t.usedFallback,additives:R,batchYield:D,qualityReport:p,export:o.export||null},H.lastCalc}e.runnerRender={applyServiceResult:k}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},c=e.state,h=e.runnerInputs,N=e.runnerQuota,Q=e.runnerService,H=e.runnerRender;async function $(L={}){var F;let w={consumeQuota:!1,showAlerts:!0,...L};try{w.showAlerts&&e.ui.clearSoapAlerts();let O=h.validateCalculation();if(!O.ok)return h.updateStageWaterSummary(null),h.updateLiveCalculationPreview(null),(F=e.mold)!=null&&F.updateWetBatterWarning&&e.mold.updateWetBatterWarning(0),w.showAlerts&&e.ui.showSoapAlert("warning",`<strong>Missing info:</strong><ul class="mb-0">${O.errors.map(d=>`<li>${d}</li>`).join("")}</ul>`,{dismissible:!0,persist:!0}),null;if(w.consumeQuota&&!N.canConsumeCalcQuota())return null;let k=h.readSuperfatInput(),o=h.getLyeSelection(),B=h.sanitizeLyeInputs(),m=(c.calcRequestSeq||0)+1;c.calcRequestSeq=m;let a=Q.buildServicePayload({oils:O.oils,selection:o,superfat:k,purity:B.purity,waterMethod:B.waterMethod,waterPct:B.waterPct,lyeConcentration:B.lyeConcentration,waterRatio:B.waterRatio,totalOils:O.totals.totalWeight}),n=await Q.calculateWithSoapService(a);if(m!==c.calcRequestSeq)return c.lastCalc;if(!n)return w.showAlerts&&e.ui.showSoapAlert("danger","Soap calculator service is unavailable. Please try again.",{dismissible:!0,timeoutMs:6e3}),null;let r=H.applyServiceResult({serviceResult:n,validation:O,selection:o,superfat:k,purity:B.purity,waterMethod:B.waterMethod,waterPct:B.waterPct,lyeConcentrationInput:B.lyeConcentration,waterRatioInput:B.waterRatio,showAlerts:w.showAlerts});return w.consumeQuota&&N.consumeCalcQuota(),r}catch{return w.showAlerts&&e.ui.showSoapAlert("danger","Unable to run the soap calculation right now. Please try again.",{dismissible:!0,timeoutMs:6e3}),null}}e.runner={getLyeSelection:(...L)=>h.getLyeSelection(...L),applyLyeSelection:(...L)=>h.applyLyeSelection(...L),setWaterMethod:(...L)=>h.setWaterMethod(...L),updateLiveCalculationPreview:(...L)=>h.updateLiveCalculationPreview(...L),calculateAll:$,buildSoapRecipePayload:(...L)=>e.recipePayload.buildSoapRecipePayload(...L),buildLineRow:(...L)=>e.recipePayload.buildLineRow(...L),addStubLine:(...L)=>e.recipePayload.addStubLine(...L),maybeShowSignupModal:(...L)=>N.maybeShowSignupModal(...L)}})(window);(function(M){"use strict";let e=M.SoapTool=M.SoapTool||{},{formatTime:c,getStorage:h}=e.helpers,N="soap_tool_state_v2";function Q(m,a){let n=[];return document.querySelectorAll(`#${m} .row`).forEach(d=>{var b,u,t;let i=(u=(b=d.querySelector(".tool-typeahead"))==null?void 0:b.value)==null?void 0:u.trim(),v=((t=d.querySelector(".tool-gi-id"))==null?void 0:t.value)||"",E=d.querySelector(".tool-qty"),C=d.querySelector(".tool-unit"),y=E&&E.value!==""?e.helpers.toNumber(E.value):null;!i&&!v||(a==="container"?n.push({name:i||"",global_item_id:v?parseInt(v):null,quantity:y&&y>0?y:1}):n.push({name:i||"",global_item_id:v?parseInt(v):null,quantity:y&&y>=0?y:0,unit:(C==null?void 0:C.value)||"gram"}))}),n}function H(){let m=[];return document.querySelectorAll("#oilRows .oil-row").forEach(a=>{var u,t,f,S,P,A,x,G,W,s;let n=((t=(u=a.querySelector(".oil-typeahead"))==null?void 0:u.value)==null?void 0:t.trim())||"",r=((f=a.querySelector(".oil-grams"))==null?void 0:f.value)||"",d=((S=a.querySelector(".oil-percent"))==null?void 0:S.value)||"",i=((P=a.querySelector(".oil-sap-koh"))==null?void 0:P.value)||"",v=((A=a.querySelector(".oil-iodine"))==null?void 0:A.value)||"",E=((x=a.querySelector(".oil-fatty"))==null?void 0:x.value)||"",C=((G=a.querySelector(".oil-gi-id"))==null?void 0:G.value)||"",y=((W=a.querySelector(".oil-default-unit"))==null?void 0:W.value)||"",b=((s=a.querySelector(".oil-category"))==null?void 0:s.value)||"";!n&&!r&&!d&&!C||m.push({name:n,grams:r,percent:d,sap:i,iodine:v,fattyRaw:E,gi:C,defaultUnit:y,categoryName:b})}),m}function $(){var a;if((a=e.fragrances)!=null&&a.collectFragranceData)return e.fragrances.collectFragranceData();let m=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(n=>{var y,b,u,t,f,S,P;let r=((b=(y=n.querySelector(".fragrance-typeahead"))==null?void 0:y.value)==null?void 0:b.trim())||"",d=((u=n.querySelector(".fragrance-grams"))==null?void 0:u.value)||"",i=((t=n.querySelector(".fragrance-percent"))==null?void 0:t.value)||"",v=((f=n.querySelector(".fragrance-gi-id"))==null?void 0:f.value)||"",E=((S=n.querySelector(".fragrance-default-unit"))==null?void 0:S.value)||"",C=((P=n.querySelector(".fragrance-category"))==null?void 0:P.value)||"";!r&&!d&&!i&&!v||m.push({name:r,grams:d,percent:i,gi:v,defaultUnit:E,categoryName:C})}),m}function L(m,a){let n=document.getElementById("oilRows");if(!n||!m)return;let r=e.oils.buildOilRow();r.querySelector(".oil-typeahead").value=m.name||"",r.querySelector(".oil-grams").value=m.grams||"",r.querySelector(".oil-percent").value=m.percent||"",r.querySelector(".oil-sap-koh").value=m.sap||"",r.querySelector(".oil-iodine").value=m.iodine||"",r.querySelector(".oil-fatty").value=m.fattyRaw||"",r.querySelector(".oil-gi-id").value=m.gi||"";let d=r.querySelector(".oil-default-unit");d&&(d.value=m.defaultUnit||"");let i=r.querySelector(".oil-category");i&&(i.value=m.categoryName||"");let v=Array.from(n.children);return a>=v.length?n.appendChild(r):n.insertBefore(r,v[a]),r}function w(){var n,r,d,i,v,E,C,y,b,u,t,f,S,P,A,x,G,W,s,I,p,_,T,R,D,Y,z;let m=h();if(!m)return;let a={version:2,unit:e.state.currentUnit,oil_total_target:document.getElementById("oilTotalTarget").value||"",oils:H(),lye_form:{superfat:((n=document.getElementById("lyeSuperfat"))==null?void 0:n.value)||"5",lye_type:((r=document.querySelector('input[name="lye_type"]:checked'))==null?void 0:r.value)||"NaOH",lye_purity:((d=document.getElementById("lyePurity"))==null?void 0:d.value)||"100",water_method:((i=document.getElementById("waterMethod"))==null?void 0:i.value)||"percent",water_pct:((v=document.getElementById("waterPct"))==null?void 0:v.value)||"",lye_concentration:((E=document.getElementById("lyeConcentration"))==null?void 0:E.value)||"",water_ratio:((C=document.getElementById("waterRatio"))==null?void 0:C.value)||""},additives:{fragrances:$(),lactate_pct:document.getElementById("additiveLactatePct").value||"1",lactate_name:((y=document.getElementById("additiveLactateName"))==null?void 0:y.value)||"",lactate_gi:((b=document.getElementById("additiveLactateGi"))==null?void 0:b.value)||"",lactate_unit:((u=document.getElementById("additiveLactateUnit"))==null?void 0:u.value)||"",lactate_category:((t=document.getElementById("additiveLactateCategory"))==null?void 0:t.value)||"",sugar_pct:document.getElementById("additiveSugarPct").value||"1",sugar_name:((f=document.getElementById("additiveSugarName"))==null?void 0:f.value)||"",sugar_gi:((S=document.getElementById("additiveSugarGi"))==null?void 0:S.value)||"",sugar_unit:((P=document.getElementById("additiveSugarUnit"))==null?void 0:P.value)||"",sugar_category:((A=document.getElementById("additiveSugarCategory"))==null?void 0:A.value)||"",salt_pct:document.getElementById("additiveSaltPct").value||"0.5",salt_name:((x=document.getElementById("additiveSaltName"))==null?void 0:x.value)||"",salt_gi:((G=document.getElementById("additiveSaltGi"))==null?void 0:G.value)||"",salt_unit:((W=document.getElementById("additiveSaltUnit"))==null?void 0:W.value)||"",salt_category:((s=document.getElementById("additiveSaltCategory"))==null?void 0:s.value)||"",citric_pct:document.getElementById("additiveCitricPct").value||"0",citric_name:((I=document.getElementById("additiveCitricName"))==null?void 0:I.value)||"",citric_gi:((p=document.getElementById("additiveCitricGi"))==null?void 0:p.value)||"",citric_unit:((_=document.getElementById("additiveCitricUnit"))==null?void 0:_.value)||"",citric_category:((T=document.getElementById("additiveCitricCategory"))==null?void 0:T.value)||""},mold:{water_weight:document.getElementById("moldWaterWeight").value||"",oil_pct:document.getElementById("moldOilPct").value||"65",shape:((R=document.getElementById("moldShape"))==null?void 0:R.value)||"loaf",cylinder_correction:!!((D=document.getElementById("moldCylinderCorrection"))!=null&&D.checked),cylinder_factor:((Y=document.getElementById("moldCylinderFactor"))==null?void 0:Y.value)||"0.85"},quality:{preset:((z=document.getElementById("qualityPreset"))==null?void 0:z.value)||"balanced",focus:Array.from(document.querySelectorAll(".quality-focus:checked")).map(K=>K.id)},lines:{ingredients:Q("tool-ingredients","ingredient"),consumables:Q("tool-consumables","consumable"),containers:Q("tool-containers","container")},bulk_oils:e.bulkOilsModal&&typeof e.bulkOilsModal.serializeSelection=="function"?e.bulkOilsModal.serializeSelection():{mode:"basics",selections:[]},updated_at:Date.now()};try{m.setItem(N,JSON.stringify(a));let K=document.getElementById("soapLastSaved");K&&(K.textContent=c(a.updated_at)),e.ui.showAutosaveToast()}catch{}}function F(){var i,v,E;let m=h();if(!m)return;let a=m.getItem(N);if(!a)return;let n=null;try{n=JSON.parse(a)}catch{return}if(!n||typeof n!="object")return;if(n.unit){let C=document.querySelector(`input[name="weight_unit"][value="${n.unit}"]`);C&&(C.checked=!0),e.units.setUnit(n.unit,{skipConvert:!0,skipAutoCalc:!0})}n.oil_total_target!==void 0&&(document.getElementById("oilTotalTarget").value=n.oil_total_target);let r=document.getElementById("oilRows");if(r&&(r.innerHTML="",(Array.isArray(n.oils)&&n.oils.length?n.oils:[{}]).forEach(y=>{let b=e.oils.buildOilRow();b.querySelector(".oil-typeahead").value=y.name||"",b.querySelector(".oil-grams").value=y.grams||"",b.querySelector(".oil-percent").value=y.percent||"",b.querySelector(".oil-sap-koh").value=y.sap||"",b.querySelector(".oil-iodine").value=y.iodine||"",b.querySelector(".oil-fatty").value=y.fattyRaw||"",b.querySelector(".oil-gi-id").value=y.gi||"";let u=b.querySelector(".oil-default-unit");u&&(u.value=y.defaultUnit||"");let t=b.querySelector(".oil-category");t&&(t.value=y.categoryName||""),r.appendChild(b)})),n.lye_form){let C=document.getElementById("lyeSuperfat");C&&(C.value=n.lye_form.superfat||"5");let y=document.querySelector(`input[name="lye_type"][value="${n.lye_form.lye_type||"NaOH"}"]`);y&&(y.checked=!0);let b=document.getElementById("lyePurity");b&&(b.value=n.lye_form.lye_purity||"100");let u=document.getElementById("waterMethod");u&&(u.value=n.lye_form.water_method||"percent");let t=document.getElementById("waterPct");t&&(t.value=n.lye_form.water_pct||"");let f=document.getElementById("lyeConcentration");f&&(f.value=n.lye_form.lye_concentration||"");let S=document.getElementById("waterRatio");S&&(S.value=n.lye_form.water_ratio||""),e.runner.applyLyeSelection()}if(n.additives){let C=document.getElementById("fragranceRows");if(C&&((i=e.fragrances)!=null&&i.buildFragranceRow)){C.innerHTML="";let R=Array.isArray(n.additives.fragrances)&&n.additives.fragrances.length?n.additives.fragrances:null;if(R)R.forEach(D=>{let Y=e.fragrances.buildFragranceRow();Y.querySelector(".fragrance-typeahead").value=D.name||"",Y.querySelector(".fragrance-grams").value=D.grams||"",Y.querySelector(".fragrance-percent").value=D.percent||"",Y.querySelector(".fragrance-gi-id").value=D.gi||"";let z=Y.querySelector(".fragrance-default-unit");z&&(z.value=D.defaultUnit||"");let K=Y.querySelector(".fragrance-category");K&&(K.value=D.categoryName||""),C.appendChild(Y)});else if(n.additives.fragrance_pct||n.additives.fragrance_name||n.additives.fragrance_gi){let D=e.fragrances.buildFragranceRow();D.querySelector(".fragrance-typeahead").value=n.additives.fragrance_name||"",D.querySelector(".fragrance-percent").value=n.additives.fragrance_pct||"3",D.querySelector(".fragrance-gi-id").value=n.additives.fragrance_gi||"",C.appendChild(D)}}document.getElementById("additiveLactatePct").value=n.additives.lactate_pct||"1";let y=document.getElementById("additiveLactateName");y&&(y.value=n.additives.lactate_name||"");let b=document.getElementById("additiveLactateGi");b&&(b.value=n.additives.lactate_gi||"");let u=document.getElementById("additiveLactateUnit");u&&(u.value=n.additives.lactate_unit||"");let t=document.getElementById("additiveLactateCategory");t&&(t.value=n.additives.lactate_category||""),document.getElementById("additiveSugarPct").value=n.additives.sugar_pct||"1";let f=document.getElementById("additiveSugarName");f&&(f.value=n.additives.sugar_name||"");let S=document.getElementById("additiveSugarGi");S&&(S.value=n.additives.sugar_gi||"");let P=document.getElementById("additiveSugarUnit");P&&(P.value=n.additives.sugar_unit||"");let A=document.getElementById("additiveSugarCategory");A&&(A.value=n.additives.sugar_category||""),document.getElementById("additiveSaltPct").value=n.additives.salt_pct||"0.5";let x=document.getElementById("additiveSaltName");x&&(x.value=n.additives.salt_name||"");let G=document.getElementById("additiveSaltGi");G&&(G.value=n.additives.salt_gi||"");let W=document.getElementById("additiveSaltUnit");W&&(W.value=n.additives.salt_unit||"");let s=document.getElementById("additiveSaltCategory");s&&(s.value=n.additives.salt_category||""),document.getElementById("additiveCitricPct").value=n.additives.citric_pct||"0";let I=document.getElementById("additiveCitricName");I&&(I.value=n.additives.citric_name||"");let p=document.getElementById("additiveCitricGi");p&&(p.value=n.additives.citric_gi||"");let _=document.getElementById("additiveCitricUnit");_&&(_.value=n.additives.citric_unit||"");let T=document.getElementById("additiveCitricCategory");T&&(T.value=n.additives.citric_category||"")}if(n.mold){document.getElementById("moldWaterWeight").value=n.mold.water_weight||"",document.getElementById("moldOilPct").value=n.mold.oil_pct||"65";let C=document.getElementById("moldShape");C&&(C.value=n.mold.shape||"loaf");let y=document.getElementById("moldCylinderCorrection");y&&(y.checked=!!n.mold.cylinder_correction);let b=document.getElementById("moldCylinderFactor");b&&(b.value=n.mold.cylinder_factor||"0.85");let u=document.getElementById("oilTotalTarget");(v=e.mold)!=null&&v.syncMoldPctFromTarget&&((E=e.mold)!=null&&E.syncTargetFromMold)&&(e.units.toGrams(u==null?void 0:u.value)>0?e.mold.syncMoldPctFromTarget():e.mold.syncTargetFromMold())}if(n.quality){let C=document.getElementById("qualityPreset");if(C){let y=n.quality.preset||"balanced",b=Array.from(C.options).find(u=>u.value===y);C.value=b?y:"balanced"}document.querySelectorAll(".quality-focus").forEach(y=>{y.checked=Array.isArray(n.quality.focus)&&n.quality.focus.includes(y.id)})}function d(C,y,b){let u=document.getElementById(C);u&&(u.innerHTML="",(y||[]).forEach(t=>{let f=e.runner.buildLineRow(b),S=f.querySelector(".tool-typeahead"),P=f.querySelector(".tool-gi-id"),A=f.querySelector(".tool-qty"),x=f.querySelector(".tool-unit");S&&(S.value=t.name||""),P&&(P.value=t.global_item_id||""),A&&t.quantity!==void 0&&t.quantity!==null&&(A.value=t.quantity),x&&t.unit&&Array.from(x.options).find(W=>W.value===t.unit)&&(x.value=t.unit),u.appendChild(f)}))}if(n.lines&&(d("tool-ingredients",n.lines.ingredients,"ingredient"),d("tool-consumables",n.lines.consumables,"consumable"),d("tool-containers",n.lines.containers,"container")),e.bulkOilsModal&&typeof e.bulkOilsModal.restoreState=="function"&&e.bulkOilsModal.restoreState(n.bulk_oils||null),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.updateQualityTargets(),e.oils.updateOilTotals(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.mold.updateMoldSuggested(),e.runner.calculateAll({consumeQuota:!1,showAlerts:!1}),n.updated_at){let C=document.getElementById("soapLastSaved");C&&(C.textContent=c(n.updated_at))}e.stages.updateStageStatuses(),e.ui.showSoapAlert("info","Restored your last soap tool session from this device.",{dismissible:!0,timeoutMs:5e3})}let O=null;function k(){O&&clearTimeout(O),O=setTimeout(w,350)}let o=null;function B(){o&&clearTimeout(o),o=setTimeout(()=>{e.runner.calculateAll({consumeQuota:!1,showAlerts:!1})},350)}e.storage={saveState:w,restoreState:F,serializeLines:Q,serializeOils:H,restoreOilRow:L,queueStateSave:k,queueAutoCalc:B}})(window);(function(M){"use strict";var ye,he;let e=M.SoapTool=M.SoapTool||{},{LACTATE_CATEGORY_SET:c,SUGAR_CATEGORY_SET:h,SALT_CATEGORY_SET:N,CITRIC_CATEGORY_SET:Q}=e.constants,{round:H,toNumber:$,clamp:L}=e.helpers,{formatWeight:w,formatPercent:F,toGrams:O}=e.units,k=e.state;async function o(){var j;let l=k.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});return l||((j=e.ui)!=null&&j.showSoapAlert&&e.ui.showSoapAlert("warning","Run a calculation before exporting or printing.",{dismissible:!0,timeoutMs:6e3}),null)}function B(l){let j=[];return document.querySelectorAll("#fragranceRows .fragrance-row").forEach(g=>{var ue,ce,le,de;let q=(ce=(ue=g.querySelector(".fragrance-typeahead"))==null?void 0:ue.value)==null?void 0:ce.trim(),V=(le=g.querySelector(".fragrance-grams"))==null?void 0:le.value,Z=(de=g.querySelector(".fragrance-percent"))==null?void 0:de.value,ee=O(V),te=L($(Z),0);ee<=0&&te>0&&l>0&&(ee=l*(te/100)),!(ee<=0&&te<=0&&!q)&&(!te&&ee>0&&l>0&&(te=ee/l*100),j.push({name:q||"Fragrance/Essential Oils",grams:ee,pct:te}))}),j}function m(l){var ee,te,ue,ce,le,de,pe,re;let j=[];if(!l)return j;let g=((te=(ee=document.getElementById("additiveLactateName"))==null?void 0:ee.value)==null?void 0:te.trim())||"Sodium Lactate",q=((ce=(ue=document.getElementById("additiveSugarName"))==null?void 0:ue.value)==null?void 0:ce.trim())||"Sugar",V=((de=(le=document.getElementById("additiveSaltName"))==null?void 0:le.value)==null?void 0:de.trim())||"Salt",Z=((re=(pe=document.getElementById("additiveCitricName"))==null?void 0:pe.value)==null?void 0:re.trim())||"Citric Acid";return l.lactateG>0&&j.push({name:g,grams:l.lactateG,pct:l.lactatePct}),l.sugarG>0&&j.push({name:q,grams:l.sugarG,pct:l.sugarPct}),l.saltG>0&&j.push({name:V,grams:l.saltG,pct:l.saltPct}),l.citricG>0&&j.push({name:Z,grams:l.citricG,pct:l.citricPct}),j}function a(l){var Z,ee;if(Array.isArray((Z=l==null?void 0:l.export)==null?void 0:Z.csv_rows)&&l.export.csv_rows.length)return l.export.csv_rows;let j=l.totalOils||0,g=[["section","name","quantity","unit","percent"]];return g.push(["Summary","Lye Type",l.lyeType||"","",""]),g.push(["Summary","Superfat",H(l.superfat||0,2),"%",""]),g.push(["Summary","Lye Purity",H(l.purity||0,1),"%",""]),g.push(["Summary","Water Method",l.waterMethod||"","",""]),g.push(["Summary","Water %",H(l.waterPct||0,1),"%",""]),g.push(["Summary","Lye Concentration",H(l.lyeConcentration||0,1),"%",""]),g.push(["Summary","Water Ratio",H(l.waterRatio||0,2),"",""]),g.push(["Summary","Total Oils",H(j,2),"gram",""]),g.push(["Summary","Batch Yield",H(l.batchYield||0,2),"gram",""]),(l.oils||[]).forEach(te=>{let ue=j>0?H(te.grams/j*100,2):"";g.push(["Oils",te.name||"Oil",H(te.grams||0,2),"gram",ue])}),l.lyeAdjusted>0&&g.push(["Lye",l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",H(l.lyeAdjusted,2),"gram",""]),l.water>0&&g.push(["Water","Distilled Water",H(l.water,2),"gram",""]),B(j).forEach(te=>{g.push(["Fragrance",te.name,H(te.grams||0,2),"gram",H(te.pct||0,2)])}),m(l.additives).forEach(te=>{g.push(["Additives",te.name,H(te.grams||0,2),"gram",H(te.pct||0,2)])}),((ee=l.additives)==null?void 0:ee.citricLyeG)>0&&g.push(["Additives","Extra Lye for Citric Acid",H(l.additives.citricLyeG,2),"gram",""]),g}function n(l){if(l==null)return"";let j=String(l);return/[",\n]/.test(j)?`"${j.replace(/"/g,'""')}"`:j}function r(l){return l.map(j=>j.map(n).join(",")).join(`
`)}function d(l,j){let g=new Blob([l],{type:"text/csv;charset=utf-8;"}),q=URL.createObjectURL(g),V=document.createElement("a");V.href=q,V.download=j,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(q)}function i(l){var de,pe;if(typeof((de=l==null?void 0:l.export)==null?void 0:de.sheet_html)=="string"&&l.export.sheet_html.trim())return l.export.sheet_html;let j=l.totalOils||0,g=(l.oils||[]).map(re=>({name:re.name||"Oil",grams:re.grams||0,pct:j>0?re.grams/j*100:0})),q=B(j),V=m(l.additives),Z=new Date().toLocaleString(),ee=g.length?g.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${w(re.grams)}</td>
            <td class="text-end">${F(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No oils added.</td></tr>',te=q.length?q.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${w(re.grams)}</td>
            <td class="text-end">${F(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No fragrances added.</td></tr>',ue=V.length?V.map(re=>`
          <tr>
            <td>${re.name}</td>
            <td class="text-end">${w(re.grams)}</td>
            <td class="text-end">${F(re.pct)}</td>
          </tr>`).join(""):'<tr><td colspan="3" class="text-muted">No additives added.</td></tr>',ce=l.lyeType==="KOH"?"Potassium Hydroxide (KOH)":"Sodium Hydroxide (NaOH)",le=((pe=l.additives)==null?void 0:pe.citricLyeG)>0?`<tr><td>Extra Lye for Citric Acid</td><td class="text-end">${w(l.additives.citricLyeG)}</td></tr>`:"";return`<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Soap Formula Sheet</title>
    <style>
      body { font-family: Arial, sans-serif; color: #111; margin: 24px; }
      h1 { font-size: 20px; margin-bottom: 4px; }
      h2 { font-size: 16px; margin-top: 20px; }
      .meta { font-size: 12px; color: #555; margin-bottom: 12px; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f3f4f6; text-align: left; }
      .text-end { text-align: right; }
      .summary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 16px; font-size: 12px; }
      .summary-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
      .text-muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Soap Formula Sheet</h1>
    <div class="meta">Generated ${Z}</div>
    <div class="summary-grid">
      <div class="summary-item"><span>Lye type</span><span>${l.lyeType||"--"}</span></div>
      <div class="summary-item"><span>Superfat</span><span>${F(l.superfat||0)}</span></div>
      <div class="summary-item"><span>Lye purity</span><span>${F(l.purity||0)}</span></div>
      <div class="summary-item"><span>Total oils</span><span>${w(j)}</span></div>
      <div class="summary-item"><span>Water</span><span>${w(l.water||0)}</span></div>
      <div class="summary-item"><span>Batch yield</span><span>${w(l.batchYield||0)}</span></div>
      <div class="summary-item"><span>Water method</span><span>${l.waterMethod||"--"}</span></div>
      <div class="summary-item"><span>Lye concentration</span><span>${F(l.lyeConcentration||0)}</span></div>
    </div>

    <h2>Oils</h2>
    <table>
      <thead>
        <tr><th>Oil</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ee}</tbody>
    </table>

    <h2>Lye & Water</h2>
    <table>
      <thead>
        <tr><th>Item</th><th class="text-end">Weight</th></tr>
      </thead>
      <tbody>
        <tr><td>${ce}</td><td class="text-end">${w(l.lyeAdjusted||0)}</td></tr>
        <tr><td>Distilled Water</td><td class="text-end">${w(l.water||0)}</td></tr>
        ${le}
      </tbody>
    </table>

    <h2>Fragrance & Essential Oils</h2>
    <table>
      <thead>
        <tr><th>Fragrance</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${te}</tbody>
    </table>

    <h2>Additives</h2>
    <table>
      <thead>
        <tr><th>Additive</th><th class="text-end">Weight</th><th class="text-end">Percent</th></tr>
      </thead>
      <tbody>${ue}</tbody>
    </table>
  </body>
</html>`}let v=document.getElementById("oilRows"),E=document.getElementById("addOil"),C=document.getElementById("normalizeOils");E&&v&&(E.dataset.bound="direct",E.addEventListener("click",function(){v.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),C&&(C.dataset.bound="direct",C.addEventListener("click",function(){e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})),v&&v.addEventListener("input",function(l){l.target.classList.contains("oil-grams")&&(k.lastOilEdit={row:l.target.closest(".oil-row"),field:"grams"}),l.target.classList.contains("oil-percent")&&(k.lastOilEdit={row:l.target.closest(".oil-row"),field:"percent"}),(l.target.classList.contains("oil-grams")||l.target.classList.contains("oil-percent")||l.target.classList.contains("oil-typeahead"))&&(l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row")),e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),v&&v.addEventListener("focusin",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.setSelectedOilProfileFromRow(l.target.closest(".oil-row"))}),v&&v.addEventListener("focusout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile(),l.target.classList.contains("oil-grams")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams"),l.target.classList.contains("oil-percent")&&e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")}),v&&v.addEventListener("keydown",function(l){l.key==="Enter"&&(l.target.classList.contains("oil-grams")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"grams")),l.target.classList.contains("oil-percent")&&(l.preventDefault(),e.oils.validateOilEntry(l.target.closest(".oil-row"),"percent")))}),v&&v.addEventListener("mouseover",function(l){if(!l.target.classList.contains("oil-typeahead"))return;let j=l.target.closest(".oil-row");!j||j===k.lastPreviewRow||(k.lastPreviewRow=j,e.oils.setSelectedOilProfileFromRow(j))}),v&&v.addEventListener("mouseout",function(l){l.target.classList.contains("oil-typeahead")&&e.oils.clearSelectedOilProfile()}),v&&v.addEventListener("click",function(l){let j=l.target.closest(".oil-profile-open");if(j){let q=j.closest(".oil-row");if(q){e.oils.setSelectedOilProfileFromRow(q);let V=document.getElementById("oilProfileModal");V&&M.bootstrap&&bootstrap.Modal.getOrCreateInstance(V).show()}return}let g=l.target.closest(".remove-oil");if(g){let q=g.closest(".oil-row");q&&(k.lastRemovedOil=e.oils.serializeOilRow(q),k.lastRemovedOilIndex=Array.from(q.parentElement.children).indexOf(q),e.ui.showUndoToast("Oil removed.")),q&&k.lastOilEdit&&k.lastOilEdit.row===q&&(k.lastOilEdit=null,e.oils.clearSelectedOilProfile()),q&&q.remove(),e.oils.updateOilTotals(),e.stages.updateStageStatuses(),e.storage.queueStateSave()}});let y=document.getElementById("fragranceRows"),b=document.getElementById("addFragrance");b&&y&&(b.dataset.bound="direct",b.addEventListener("click",function(){y.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave()})),y&&(y.addEventListener("input",function(l){l.target.classList.contains("fragrance-grams")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"grams"}),l.target.classList.contains("fragrance-percent")&&(e.state.lastFragranceEdit={row:l.target.closest(".fragrance-row"),field:"percent"}),(l.target.classList.contains("fragrance-grams")||l.target.classList.contains("fragrance-percent")||l.target.classList.contains("fragrance-typeahead"))&&(e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),y.addEventListener("click",function(l){var q;let j=l.target.closest(".remove-fragrance");if(!j)return;let g=j.closest(".fragrance-row");g&&((q=e.state.lastFragranceEdit)==null?void 0:q.row)===g&&(e.state.lastFragranceEdit=null),g&&g.remove(),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}));let u=document.getElementById("soapStageTabContent"),t=()=>{if(!u)return null;let l=u.querySelector(".tab-pane.active")||u.querySelector(".tab-pane.show.active");return l?l.querySelector(".soap-stage-body")||l:null},f=()=>{u&&u.addEventListener("wheel",l=>{let j=l.target;if(!(j instanceof HTMLElement))return;let g=j.closest('input[type="number"]');if(!(g instanceof HTMLInputElement))return;let q=t();if(!(q instanceof HTMLElement)||q.scrollHeight<=q.clientHeight+1)return;document.activeElement===g&&typeof g.blur=="function"&&g.blur();let V=q.scrollTop<=0,Z=q.scrollTop+q.clientHeight>=q.scrollHeight-1;l.deltaY<0&&V||l.deltaY>0&&Z||(q.scrollTop+=l.deltaY,l.preventDefault())},{passive:!1})};u&&(u.addEventListener("click",l=>{let j=l.target.closest("[data-stage-action]"),g=l.target.closest("[data-soap-action]");if(!j&&!g)return;if(l.preventDefault(),l.stopPropagation(),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur(),g){if(g.dataset.bound==="direct")return;let Z=g.dataset.soapAction;Z==="add-oil"&&v&&(v.appendChild(e.oils.buildOilRow()),e.stages.updateStageStatuses(),e.storage.queueStateSave()),Z==="normalize-oils"&&(e.oils.normalizeOils(),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()),Z==="add-fragrance"&&y&&(y.appendChild(e.fragrances.buildFragranceRow()),e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.queueStateSave());return}let q=j.dataset.stageAction,V=Number(j.dataset.stageIndex);Number.isNaN(V)||(q==="prev"&&e.stages.openStageByIndex(Math.max(0,V-1)),q==="next"&&e.stages.openStageByIndex(Math.min(e.constants.STAGE_CONFIGS.length-1,V+1)),q==="reset"&&e.stages.resetStage(V+1))}),f());let S=document.getElementById("soapStageTabList"),P=()=>{if(!S)return;S.querySelectorAll(".nav-item").forEach(j=>j.classList.remove("is-expanded"));let l=S.querySelector(".nav-link.active");l&&l.closest(".nav-item")&&l.closest(".nav-item").classList.add("is-expanded")};S&&(S.addEventListener("shown.bs.tab",()=>{P(),e.layout.scheduleStageHeightSync()}),P());let A=document.getElementById("resultsCardToggle"),x=document.getElementById("resultsCard");A&&x&&A.addEventListener("click",()=>{x.classList.toggle("is-collapsed");let l=x.classList.contains("is-collapsed");A.setAttribute("aria-expanded",(!l).toString());let j=l?"Expand formula details":"Collapse formula details";A.setAttribute("aria-label",j),A.setAttribute("title",j);let g=A.querySelector("i");g&&(g.classList.toggle("fa-chevron-down",l),g.classList.toggle("fa-chevron-up",!l))}),document.querySelectorAll('input[name="weight_unit"]').forEach(l=>{l.addEventListener("change",function(){e.units.setUnit(this.value),e.storage.queueStateSave()})});let G=()=>{var l;e.oils.scaleOilsToTarget(void 0,{force:!0}),e.oils.updateOilTotals(),(l=e.mold)!=null&&l.updateWetBatterWarning&&e.mold.updateWetBatterWarning(null)},W=document.getElementById("oilTotalTarget");W&&W.addEventListener("input",function(){e.mold.syncMoldPctFromTarget(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let s=document.getElementById("waterMethod");s&&s.addEventListener("change",function(){e.runner.setWaterMethod(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll('input[name="lye_type"]').forEach(l=>{l.addEventListener("change",function(){e.runner.applyLyeSelection(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),["lyeSuperfat","lyePurity","waterPct","lyeConcentration","waterRatio"].forEach(l=>{let j=document.getElementById(l);j&&["input","change"].forEach(g=>{j.addEventListener(g,()=>{e.storage.queueStateSave(),e.storage.queueAutoCalc()})})}),[{pctId:"additiveLactatePct",weightId:"additiveLactateWeight"},{pctId:"additiveSugarPct",weightId:"additiveSugarWeight"},{pctId:"additiveSaltPct",weightId:"additiveSaltWeight"},{pctId:"additiveCitricPct",weightId:"additiveCitricWeight"}].forEach(({pctId:l,weightId:j})=>{let g=document.getElementById(l),q=document.getElementById(j);g&&g.addEventListener("input",()=>{let V=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:j,sourceField:"pct",totalOils:V}),e.additives.updateAdditivesOutput(V),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),q&&q.addEventListener("input",()=>{let V=e.oils.getTotalOilsGrams();e.additives.syncAdditivePair({pctId:l,weightId:j,sourceField:"weight",totalOils:V}),e.additives.updateAdditivesOutput(V),e.stages.updateStageStatuses(),e.storage.queueStateSave(),e.storage.queueAutoCalc()})}),document.querySelectorAll(".additive-typeahead").forEach(l=>{l.addEventListener("input",()=>{e.storage.queueStateSave()})});let p=document.getElementById("qualityPreset");p&&p.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()}),document.querySelectorAll(".quality-focus").forEach(l=>{l.addEventListener("change",function(){e.quality.updateQualityTargets(),e.storage.queueStateSave()})});let _=document.getElementById("applyQualityTargets");_&&_.addEventListener("click",function(){e.quality.applyQualityTargets()}),document.querySelectorAll(".quality-target-marker").forEach(l=>{l.addEventListener("click",()=>e.quality.applyQualityTargets()),l.addEventListener("keydown",j=>{(j.key==="Enter"||j.key===" ")&&(j.preventDefault(),e.quality.applyQualityTargets())})});let T=document.getElementById("moldWaterWeight");T&&T.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let R=document.getElementById("moldOilPct");R&&R.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let D=document.getElementById("moldShape");D&&D.addEventListener("change",function(){e.mold.updateMoldShapeUI(),e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let Y=document.getElementById("moldCylinderCorrection");Y&&Y.addEventListener("change",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()});let z=document.getElementById("moldCylinderFactor");z&&z.addEventListener("input",function(){e.mold.syncTargetFromMold(),G(),e.storage.queueStateSave(),e.storage.queueAutoCalc()}),document.querySelectorAll(".stub-btn").forEach(l=>{l.addEventListener("click",function(){let j=this.dataset.stubKind,g=this.dataset.stubName;e.runner.addStubLine(j,g),e.storage.queueStateSave()})});let K=document.getElementById("soapToolPage");K&&(K.addEventListener("click",function(l){l.target.classList.contains("tool-remove")&&e.storage.queueStateSave()}),K.addEventListener("input",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses(),e.ui.flashStage(l.target.closest(".soap-stage-card")))}),K.addEventListener("change",function(l){l.target.matches("input, select, textarea")&&(e.storage.queueStateSave(),e.ui.validateNumericField(l.target),e.stages.updateStageStatuses())}));let U=document.getElementById("addToolIngredient");U&&U.addEventListener("click",function(){let l=document.getElementById("tool-ingredients");l&&l.appendChild(e.runner.buildLineRow("ingredient")),e.storage.queueStateSave()});let J=document.getElementById("addToolConsumable");J&&J.addEventListener("click",function(){let l=document.getElementById("tool-consumables");l&&l.appendChild(e.runner.buildLineRow("consumable")),e.storage.queueStateSave()});let X=document.getElementById("addToolContainer");X&&X.addEventListener("click",function(){let l=document.getElementById("tool-containers");l&&l.appendChild(e.runner.buildLineRow("container")),e.storage.queueStateSave()});let ne=document.getElementById("calcLyeBtn");ne&&ne.addEventListener("click",async function(){await e.runner.calculateAll({consumeQuota:!0,showAlerts:!0}),e.storage.queueStateSave()});let oe=document.getElementById("saveSoapTool");oe&&oe.addEventListener("click",async function(){try{let l=k.lastCalc||await e.runner.calculateAll({consumeQuota:!1,showAlerts:!0});if(!l)return;let j=e.runner.buildSoapRecipePayload(l);k.lastRecipePayload=j;try{let g=e.helpers.getStorage();g&&g.setItem("soap_recipe_payload",JSON.stringify(j))}catch{}M.SOAP_RECIPE_DTO=j,e.ui.showSoapAlert("info","Recipe payload is ready. Push is stubbed for now; no data has been sent.",{dismissible:!0,timeoutMs:7e3})}catch{e.ui.showSoapAlert("danger","Unable to prepare the recipe payload. Please try again.",{dismissible:!0,persist:!0})}});let me=document.getElementById("exportSoapCsv");me&&me.addEventListener("click",async function(){var q;let l=await o();if(!l)return;let j=a(l),g=typeof((q=l==null?void 0:l.export)==null?void 0:q.csv_text)=="string"&&l.export.csv_text?l.export.csv_text:r(j);d(g,"soap_formula.csv")});let fe=document.getElementById("printSoapSheet");fe&&fe.addEventListener("click",async function(){var q;let l=await o();if(!l)return;let j=i(l),g=M.open("","_blank","width=960,height=720");if(!g){(q=e.ui)!=null&&q.showSoapAlert&&e.ui.showSoapAlert("warning","Pop-up blocked. Allow pop-ups to print the sheet.",{dismissible:!0,timeoutMs:6e3});return}g.document.open(),g.document.write(j),g.document.close(),g.focus(),g.onload=()=>{g.print()}});let se=document.getElementById("soapUndoRemove");se&&se.addEventListener("click",()=>{k.lastRemovedOil&&(e.storage.restoreOilRow(k.lastRemovedOil,k.lastRemovedOilIndex||0),k.lastRemovedOil=null,k.lastRemovedOilIndex=null,e.oils.updateOilTotals(),e.storage.queueStateSave(),e.storage.queueAutoCalc())}),(()=>{let l=document.getElementById("soapMobileDrawer"),j=document.getElementById("soapMobileDrawerContent"),g=document.getElementById("soapMobileDrawerTitle"),q=document.getElementById("soapDrawerEmpty"),V=document.getElementById("soapDrawerClose"),Z=document.getElementById("soapQualityCard"),ee=document.getElementById("resultsCard");if(!l||!j||!g||!Z||!ee)return;let te=Z.parentElement,ue=ee.parentElement,ce=new Map,le=null,de=()=>M.matchMedia("(max-width: 767px)").matches,pe=ae=>ae==="quality"?Z:ee,re=ae=>ae==="quality"?te:ue,ve=ae=>ae==="quality"?"Display":"Results",Te=ae=>{let ge=ce.get(ae);ge||(ge=document.createElement("div"),ge.className="soap-card-placeholder",ce.set(ae,ge)),ge.style.height=`${ae.offsetHeight}px`,ae.parentElement&&ae.parentElement!==j&&!ge.parentElement&&ae.parentElement.insertBefore(ge,ae)},Se=ae=>{ae&&(Te(ae),j.appendChild(ae))},Ie=(ae,ge)=>{let Ee=ce.get(ae);Ee&&Ee.parentElement?Ee.replaceWith(ae):ge&&ae.parentElement!==ge&&ge.appendChild(ae)},_e=()=>{if(!q)return;let ae=le==="results",ge=getComputedStyle(ee).display!=="none";q.classList.toggle("d-none",!ae||ge)},Ce=ae=>{de()&&(le&&le!==ae&&Ie(pe(le),re(le)),Se(pe(ae)),g.textContent=ve(ae),le=ae,l.classList.add("is-open"),_e())},be=()=>{le&&(Ie(pe(le),re(le)),le=null,l.classList.remove("is-open"),_e())};l.querySelectorAll("[data-drawer-target]").forEach(ae=>{ae.addEventListener("click",()=>{let ge=ae.dataset.drawerTarget;ge&&(l.classList.contains("is-open")&&le===ge?be():Ce(ge))})}),V&&V.addEventListener("click",be),M.addEventListener("resize",()=>{!de()&&le&&be()}),new MutationObserver(()=>_e()).observe(ee,{attributes:!0,attributeFilter:["style","class"]})})(),M.addEventListener("resize",e.layout.scheduleStageHeightSync),M.addEventListener("load",e.layout.scheduleStageHeightSync),e.additives.attachAdditiveTypeahead("additiveLactateName","additiveLactateGi",c,"additiveLactateUnit","additiveLactateCategory"),e.additives.attachAdditiveTypeahead("additiveSugarName","additiveSugarGi",h,"additiveSugarUnit","additiveSugarCategory"),e.additives.attachAdditiveTypeahead("additiveSaltName","additiveSaltGi",N,"additiveSaltUnit","additiveSaltCategory"),e.additives.attachAdditiveTypeahead("additiveCitricName","additiveCitricGi",Q,"additiveCitricUnit","additiveCitricCategory"),e.ui.applyHelperVisibility(),e.quality.initQualityTooltips(),e.runner.applyLyeSelection(),e.runner.setWaterMethod(),e.mold.updateMoldShapeUI(),e.quality.setQualityRangeBars(),e.units.updateUnitLabels(),e.quality.updateQualityTargets(),e.additives.updateAdditivesOutput(e.oils.getTotalOilsGrams()),e.stages.updateStageStatuses(),e.storage.restoreState(),v&&!v.querySelector(".oil-row")&&v.appendChild(e.oils.buildOilRow()),y&&!y.querySelector(".fragrance-row")&&(ye=e.fragrances)!=null&&ye.buildFragranceRow&&y.appendChild(e.fragrances.buildFragranceRow()),(he=e.fragrances)!=null&&he.updateFragranceTotals&&e.fragrances.updateFragranceTotals(e.oils.getTotalOilsGrams()),e.layout.scheduleStageHeightSync()})(window);
