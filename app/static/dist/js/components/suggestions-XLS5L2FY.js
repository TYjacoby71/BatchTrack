(()=>{(function(H){"use strict";let O={inventory:"Inventory",global:"Global Library"},P={inventory:"bg-primary",global:"bg-info text-dark"},R={mode:"recipe",searchType:"ingredient",includeInventory:!0,includeGlobal:!0,ingredientFirst:!1,displayVariant:null,showSourceBadge:!0,globalUrlBuilder:null,resultFilter:null};function D(t,i){let n;return function(){let a=arguments;clearTimeout(n),n=setTimeout(()=>t.apply(null,a),i)}}function j(t){return(t||"").trim().toLowerCase()}function k(t){if(t)return t;let i=document.createElement("div");return i.className="list-group position-absolute w-100 d-none inventory-suggestions",i.style.zIndex="1050",i.style.maxHeight="300px",i.style.overflowY="auto",i}function w(t){return typeof t=="function"?t():t}function V(t){let i=new Set;return(t||[]).forEach(n=>{let a=n&&(n.global_item_id||n.id);a&&i.add(String(a))}),i}function Y(t){if(!t)return"";let i=O[t]||t;return`<span class="badge ${P[t]||"bg-secondary"} ms-2">${i}</span>`}function T(t,i,n,a){a=a||{},t.innerHTML="";let s=!1;if(i.forEach(l=>{!l.items||!l.items.length||(s=!0,l.items.forEach(e=>{let r=document.createElement("a");r.href="#",r.className="list-group-item list-group-item-action suggestion-item";let _=a.showSubtitle&&e.subtitle?`<div class="small text-muted mt-1">${e.subtitle}</div>`:"";r.innerHTML=`<div class="d-flex justify-content-between align-items-center gap-2">
          <span class="fw-semibold text-truncate">${e.text||e.display_name||e.name||""}</span>
          ${a.showSourceBadge?Y(l.source||e.source):""}
        </div>${_}`,r.addEventListener("click",function(g){g.preventDefault(),n(e,l.source||e.source),t.classList.add("d-none")}),t.appendChild(r)}))}),t.classList.toggle("d-none",!s),!s&&t.dataset.emptyMessage){let l=document.createElement("div");l.className="list-group-item text-muted small",l.textContent=t.dataset.emptyMessage,t.appendChild(l),t.classList.remove("d-none")}}function z(t,i,n){t.innerHTML="";let a=!1;i.forEach(s=>{if(!s.ingredients||!s.ingredients.length)return;a=!0;let l=document.createElement("div");l.className="list-group-item text-muted small fw-semibold",l.textContent=s.title,t.appendChild(l),s.ingredients.forEach(e=>{let r=document.createElement("div");r.className="list-group-item ingredient-result";let _=document.createElement("div");_.className="d-flex justify-content-between align-items-center ingredient-summary",_.setAttribute("role","button"),_.setAttribute("tabindex","0"),_.innerHTML=`<span class="fw-semibold">${e.name||"Ingredient"}</span>
          <span class="badge bg-light text-dark">${e.forms.length} option${e.forms.length===1?"":"s"}</span>`;let g=document.createElement("div");g.className="ingredient-form-options d-none mt-2 ps-3 border-start border-2",e.forms.forEach(d=>{let u=document.createElement("button");u.type="button",u.className="btn btn-sm btn-outline-primary w-100 text-start mb-2 ingredient-form-option suggestion-item",u.innerHTML=`<div class="fw-semibold">${d.text||d.display_name||d.name||"Form"}</div>`,u.addEventListener("click",function(){n(d,d.source||s.source),t.classList.add("d-none")}),g.appendChild(u)});function m(d){d.type==="keydown"&&d.key!=="Enter"&&d.key!==" "||(d.preventDefault(),g.classList.toggle("d-none"))}_.addEventListener("click",m),_.addEventListener("keydown",m),r.appendChild(_),r.appendChild(g),t.appendChild(r),e.forms.length===1&&g.classList.remove("d-none")})}),t.classList.toggle("d-none",!a)}function q(t,i,n){t.innerHTML="";let a=!1;if((i||[]).forEach(s=>{a=!0;let l=document.createElement("a");l.href="#",l.className="list-group-item list-group-item-action suggestion-item";let e=s.inci_name?`<div class="small text-muted">${s.inci_name}</div>`:"";l.innerHTML=`<div class="fw-semibold">${s.text||s.name}</div>${e}`,l.addEventListener("click",function(r){r.preventDefault(),n(s,"definition"),t.classList.add("d-none")}),t.appendChild(l)}),t.classList.toggle("d-none",!a),!a&&t.dataset.emptyMessage){let s=document.createElement("div");s.className="list-group-item text-muted small",s.textContent=t.dataset.emptyMessage,t.appendChild(s),t.classList.remove("d-none")}}function J(t){let i=[];return(t||[]).forEach(n=>{if(n&&Array.isArray(n.forms)&&n.forms.length){let a=n.ingredient&&n.ingredient.name||n.ingredient_name||null,s=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null,l=n.category_tags||[];n.forms.forEach(e=>{var g,m,d,u,v,L,E,S,I,b;let r=e.physical_form||{},_=e.display_name||e.text||e.name||(a&&e.physical_form_name?`${a}, ${e.physical_form_name}`:n.display_name||n.text||n.name||"");i.push({id:e.id,text:_,item_type:e.item_type||n.item_type,default_unit:e.default_unit||e.unit||n.default_unit||n.unit||null,source:"global",global_item_id:e.id,ingredient_id:e.ingredient_id||n.ingredient&&n.ingredient.id||n.ingredient_id||null,ingredient_name:e.ingredient_name||a,physical_form_id:e.physical_form_id||r&&r.id||null,physical_form_name:e.physical_form_name||r&&r.name||null,ingredient_category_name:s,category_tags:l,density:e.density||n.density||null,capacity:e.capacity||n.capacity||null,capacity_unit:e.capacity_unit||n.capacity_unit||null,container_material:e.container_material||n.container_material||null,container_type:e.container_type||n.container_type||null,container_style:e.container_style||n.container_style||null,container_color:e.container_color||n.container_color||null,default_is_perishable:(g=e.default_is_perishable)!=null?g:n.default_is_perishable,recommended_shelf_life_days:(m=e.recommended_shelf_life_days)!=null?m:n.recommended_shelf_life_days,saponification_value:(u=(d=e.saponification_value)!=null?d:n.saponification_value)!=null?u:null,iodine_value:(L=(v=e.iodine_value)!=null?v:n.iodine_value)!=null?L:null,fatty_acid_profile:(S=(E=e.fatty_acid_profile)!=null?E:n.fatty_acid_profile)!=null?S:null,melting_point_c:(b=(I=e.melting_point_c)!=null?I:n.melting_point_c)!=null?b:null})})}else if(n){let a=n.display_name||n.text||n.name||"",s=n.ingredient&&n.ingredient.ingredient_category_name||n.ingredient_category_name||n.ingredient_category&&n.ingredient_category.name||null;i.push({id:n.id,text:a,source:"global",item_type:n.item_type,global_item_id:n.id,ingredient_name:n.ingredient&&n.ingredient.name||n.ingredient_name||n.name,ingredient_category_name:s,category_tags:n.category_tags||[],physical_form_name:n.physical_form&&n.physical_form.name||n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,density:n.density||null,capacity:n.capacity||null,capacity_unit:n.capacity_unit||null,container_material:n.container_material||null,container_type:n.container_type||null,container_style:n.container_style||null,container_color:n.container_color||null,default_is_perishable:n.default_is_perishable,recommended_shelf_life_days:n.recommended_shelf_life_days,saponification_value:n.saponification_value||null,iodine_value:n.iodine_value||null,fatty_acid_profile:n.fatty_acid_profile||null,melting_point_c:n.melting_point_c||null})}}),i}function K(t){let i=new Map;return(t||[]).forEach(n=>{let a=n.ingredient_name||n.text||n.name||"",s=n.ingredient_id?`id:${n.ingredient_id}`:`name:${j(a)}`,l=i.get(s)||{ingredient_id:n.ingredient_id||null,name:a,forms:[]};l.forms.push({id:n.id,text:n.text||a,ingredient_name:a,physical_form_name:n.physical_form_name||null,default_unit:n.default_unit||n.unit||null,source:"inventory",global_item_id:n.global_item_id||null}),i.set(s,l)}),Array.from(i.values())}function Q(t,i){let n=[];return(t||[]).forEach(a=>{let s=(a.forms||[]).map(e=>({id:e.id,text:e.name||e.display_name||e.text,ingredient_name:e.ingredient_name||a.name||a.ingredient&&a.ingredient.name||"Ingredient",physical_form_name:e.physical_form_name||null,default_unit:e.default_unit||e.unit||null,source:"global",global_item_id:e.id,density:e.density||null,capacity:e.capacity||null,capacity_unit:e.capacity_unit||null,container_material:e.container_material||null,container_type:e.container_type||null,container_style:e.container_style||null,container_color:e.container_color||null,saponification_value:e.saponification_value||null,iodine_value:e.iodine_value||null,fatty_acid_profile:e.fatty_acid_profile||null,melting_point_c:e.melting_point_c||null})),l=i?s.filter(e=>!e.global_item_id||!i.has(String(e.global_item_id))):s;l.length&&n.push({ingredient_id:a.ingredient_id||a.id||null,name:a.name||a.ingredient&&a.ingredient.name||s[0]&&s[0].ingredient_name||"Ingredient",forms:l})}),n}function W(t){let i=new URLSearchParams({q:t});return fetch(`/api/ingredients/definitions/search?${i.toString()}`).then(n=>n.json()).catch(()=>({results:[]}))}function X(t){let i={...R,...t},n=i.inputEl,a=i.invHiddenEl,s=i.giHiddenEl,l=k(i.listEl),e=i.mode||"recipe",r=i.searchType||"ingredient",_=i.includeInventory,g=i.includeGlobal,m=i.ingredientFirst,d=i.displayVariant,u=typeof i.resultFilter=="function"?i.resultFilter:null,v=typeof i.onSelection=="function"?i.onSelection:null,L=i.globalUrlBuilder;if(!n||!a&&e==="recipe"||!s&&i.requireHidden!==!1)return;l&&!l.classList.contains("list-group")&&l.classList.add("list-group"),!l.parentNode&&n.parentNode&&n.parentNode.appendChild(l);function E(o,c){let h=new URLSearchParams({q:o});return c&&c!=="all"&&h.set("type",c),`/inventory/api/search?${h.toString()}`}function S(o,c,h){if(typeof L=="function")return L(o,c,h);let x=new URLSearchParams({q:o});return c&&c!=="all"&&x.set("type",c),c==="ingredient"&&h&&x.set("group","ingredient"),`${e==="public"?"/api/public/global-items/search":"/api/ingredients/global-items/search"}?${x.toString()}`}let I=D(function(){let o=(n.value||"").trim();if(!o){l.classList.add("d-none"),l.innerHTML="",a&&(a.value=""),s&&(s.value="");return}let c=(w(r)||"ingredient").toLowerCase(),h=w(_),x=w(g),C=c==="ingredient"&&!!w(m),Z=d||(C?"grouped":"compact");if(c==="ingredient_definition"||c==="definition"){W(o).then(y=>{let $=y&&y.results||[];q(l,$.map(f=>({id:f.id,text:f.name,name:f.name,inci_name:f.inci_name,slug:f.slug,ingredient_category_id:f.ingredient_category_id,ingredient_category_name:f.ingredient_category_name})),b)}).catch(()=>l.classList.add("d-none"));return}let nn=h!==!1?fetch(E(o,c)).then(y=>y.json()).catch(()=>({results:[]})):Promise.resolve({results:[]}),en=x!==!1?fetch(S(o,c,C)).then(y=>y.json()).catch(()=>({results:[]})):Promise.resolve({results:[]});Promise.all([nn,en]).then(y=>{let $=y[0]&&y[0].results||[],f=y[1]&&y[1].results||[],G=u?$.filter(p=>u(p,"inventory")):$,F=u?f.filter(p=>u(p,"global")):f,A=V(G),B=J(F).filter(p=>!p.global_item_id||!A.has(String(p.global_item_id))).filter(p=>u?u(p,"global"):!0);if(C){let p=K(G),U=Q(F,A),M=[];p.length&&M.push({title:"Your Inventory",source:"inventory",ingredients:p}),U.length&&M.push({title:"Global Library",source:"global",ingredients:U}),z(l,M,b);return}let N=[];G.length&&N.push({title:"Your Inventory",source:"inventory",items:G}),B.length&&N.push({title:"Global Library",source:"global",items:B}),T(l,N,b,{showSourceBadge:i.showSourceBadge!==!1,showSubtitle:Z==="detailed"})}).catch(()=>{l.classList.add("d-none")})},200);function b(o,c){n.value=o.text||o.display_name||o.name||"",c==="inventory"?(a&&(a.value=o.id_numeric||o.id||""),s&&(s.value=o.global_item_id||"")):(s&&(s.value=o.global_item_id||o.id||""),a&&(a.value="")),typeof v=="function"&&v(o,c)}n.addEventListener("input",function(){a&&(a.value=""),s&&(s.value=""),I()}),document.addEventListener("click",function(o){!l.contains(o.target)&&!n.contains(o.target)&&l.classList.add("d-none")})}H.attachMergedInventoryGlobalTypeahead=X,H.renderInventoryTypeaheadList=T})(window);})();
