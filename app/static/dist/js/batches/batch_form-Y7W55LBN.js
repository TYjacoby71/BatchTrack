(()=>{document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("finishBatchModal"),t=document.getElementById("finishBatchModalForm");e&&e.addEventListener("shown.bs.modal",function(){console.log("Batch form modal opened")}),t&&t.addEventListener("submit",function(n){return!0}),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(n=>new bootstrap.Tooltip(n))});function m(){if(confirm("Mark this batch as failed? This action cannot be undone.")){let e=window.location.pathname.split("/").pop(),t=document.createElement("form");t.method="POST",t.action=`/batches/finish-batch/${e}/fail`;let a=document.querySelector(".csrf-token").value,n=document.createElement("input");n.type="hidden",n.name="csrf_token",n.value=a,t.appendChild(n),document.body.appendChild(t),t.submit()}}function d(e){let t=e.closest(".extra-row"),a=e.options[e.selectedIndex].dataset.cost,n=e.options[e.selectedIndex].dataset.unit,o=t.querySelector(".cost"),c=t.querySelector(".unit");o&&(o.value=a||0),c&&n&&(c.value=n)}function f(e){let a=document.getElementById(`extra-${e}-template`).content.cloneNode(!0);document.getElementById("extra-ingredients-container").appendChild(a);let o=document.getElementById("extra-ingredients-container").lastElementChild.querySelector(".item-select");o&&d(o)}function p(){if(window.currentBatchId)return window.currentBatchId;let e=window.location.pathname.split("/");return e[e.length-1]}function h(){let e=document.querySelector(".csrf-token")||document.querySelector('input[name="csrf_token"]');return e?e.value:""}function l(e,t){alert(t==="error"?"Error: "+e:t==="success"?"Success: "+e:e)}function y(){let e=[],t=[],a=[];if(document.querySelectorAll(".extra-row").forEach(o=>{let c=o.dataset.type,r=o.querySelector(".item-select"),s=o.querySelector(".qty");if(!(!r||!s||!r.value||!s.value)){if(c==="ingredient"){let i=o.querySelector(".unit");e.push({item_id:parseInt(r.value),quantity:parseFloat(s.value),unit:i?i.value:""})}else if(c==="container"){let i=o.querySelector(".reason"),u=o.querySelector(".one-time");t.push({item_id:parseInt(r.value),quantity:parseInt(s.value),reason:i?i.value:"primary_packaging",one_time:u?u.checked:!1})}else if(c==="consumable"){let i=o.querySelector(".unit");a.push({item_id:parseInt(r.value),quantity:parseFloat(s.value),unit:i?i.value:"",reason:"extra_use"})}}}),e.length===0&&t.length===0&&a.length===0){l("No extra items to save","warning");return}let n=p();if(!n){l("Batch ID not found","error");return}fetch(`/batches/add-extra/${n}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":h()},body:JSON.stringify({extra_ingredients:e,extra_containers:t,extra_consumables:a})}).then(o=>o.json()).then(o=>{if(o.status==="success")l("Extra items saved successfully","success"),document.querySelectorAll(".extra-row").forEach(c=>c.remove()),typeof refreshContainerDisplay=="function"&&refreshContainerDisplay(),setTimeout(()=>{window.location.reload()},1e3);else{let c=o.errors?o.errors.map(r=>`${r.item}: ${r.message}`).join(`
`):"Error saving extra items";l(c,"error")}}).catch(o=>{console.error("Error saving extras:",o),l("Error saving extra items","error")})}function g(){let e=window.location.pathname.split("/").pop(),t=document.querySelector('textarea[name="notes"]').value,a=document.querySelector('input[name="tags"]').value,n=document.querySelector('input[name="csrf_token"]').value;return fetch(`/batches/${e}/update-notes`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({notes:t,tags:a})})}function v(){if(confirm("Cancel this batch? Ingredients will be returned to inventory.")){let e=window.location.pathname.split("/").pop(),t=document.createElement("form");t.method="POST",t.action=`/batches/cancel/${e}`;let a=document.querySelector('input[name="csrf_token"]').value,n=document.createElement("input");n.type="hidden",n.name="csrf_token",n.value=a,t.appendChild(n),document.body.appendChild(t),t.submit()}}typeof window!="undefined"&&Object.assign(window,{markBatchFailed:m,updateRowCost:d,addExtraItemRow:f,saveExtras:y,saveBatchNotes:g,cancelBatch:v});})();
