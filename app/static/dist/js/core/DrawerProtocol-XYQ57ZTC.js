var l=class{constructor(){this.activeDrawers=new Set,this.retryCallbacks=new Map,this.debugEnabled=window.location.search.includes("drawerDebug=true"),window.addEventListener("openDrawer",e=>{this.handleDrawerRequest(e.detail||{})})}log(...e){this.debugEnabled&&console.debug("[DrawerProtocol]",...e)}handleDrawerRequest(e){if(e){if(this.log("Handling drawer request",e),this.storeRetry(e),e.redirect_url){window.open(e.redirect_url,"_blank");return}if(!e.modal_url){e.error_message&&alert(e.error_message);return}this.openModal(e.modal_url,e.success_event,e)}}storeRetry(e){let r=e.success_event||e.error_type||"drawer",t=this.buildRetryKey(r,e);if(typeof e.retry_callback=="function"){this.retryCallbacks.set(t,e.retry_callback);return}if(e.retry&&e.retry.operation){this.retryCallbacks.set(t,()=>{this.executeRetryOperation(e.retry.operation,e.retry.data||{})});return}e.retry_operation&&e.retry_data&&this.retryCallbacks.set(t,()=>{this.executeRetryOperation(e.retry_operation,e.retry_data)})}buildRetryKey(e,r){return`${e||"drawer"}.${r.error_code||"generic"}.${r.correlation_id||"na"}`}async openModal(e,r,t){try{this.clearExistingDrawer();let n=await(await fetch(e)).json();if(!n.success)return console.error("DrawerProtocol: Failed to load modal",n.error),!1;let o=document.createElement("div");o.className="drawer-wrapper",o.innerHTML=n.modal_html,document.body.appendChild(o),this.rehydrateScripts(o);let s=o.querySelector(".modal");if(!s)return o.remove(),!1;let a=new bootstrap.Modal(s);return s.id&&this.activeDrawers.add(s.id),r&&window.addEventListener(r,i=>this.handleSuccess(r,i.detail),{once:!0}),s.addEventListener("hidden.bs.modal",()=>{s.id&&this.activeDrawers.delete(s.id),o.remove()},{once:!0}),a.show(),this.emitAnalyticsEvent("open",t),!0}catch(c){return console.error("DrawerProtocol: Error opening modal",c),!1}}clearExistingDrawer(){let e=document.querySelector(".drawer-wrapper");e&&e.remove()}rehydrateScripts(e){let r=e.querySelectorAll("script");console.log("\u{1F527} DRAWER PROTOCOL: Found",r.length,"scripts to rehydrate"),r.forEach((t,c)=>{var o,s;console.log("\u{1F527} DRAWER PROTOCOL: Rehydrating script",c,"with content length:",(o=t.textContent)==null?void 0:o.length),console.log("\u{1F527} DRAWER PROTOCOL: Script content preview:",(s=t.textContent)==null?void 0:s.substring(0,200));let n=document.createElement("script");for(let{name:a,value:i}of Array.from(t.attributes))n.setAttribute(a,i);n.textContent=t.textContent;try{t.replaceWith(n),console.log("\u{1F527} DRAWER PROTOCOL: Successfully rehydrated script",c)}catch(a){console.error("\u{1F527} DRAWER PROTOCOL: Error rehydrating script",c,a),console.log("\u{1F527} DRAWER PROTOCOL: Problematic script content:",t.textContent)}})}handleSuccess(e,r){let t=`${e}.`;for(let[n,o]of this.retryCallbacks.entries())if(n.startsWith(t)||n.includes(e)){this.invokeRetryCallback(n,o,r);return}let c=this.retryCallbacks.entries().next();if(!c.done){let[n,o]=c.value;this.invokeRetryCallback(n,o,r)}}invokeRetryCallback(e,r,t){try{r(t)}catch(c){console.error("DrawerProtocol: Retry callback failed",c)}finally{this.retryCallbacks.delete(e)}}async executeRetryOperation(e,r){switch(this.log("Executing retry operation",e,r),e){case"stock_check":window.stockChecker&&typeof window.stockChecker.performStockCheck=="function"?window.stockChecker.performStockCheck():console.warn("DrawerProtocol: Stock checker not available for retry");break;case"retention.refresh":window.location.reload();break;default:console.warn("DrawerProtocol: Unknown retry operation",e)}}emitAnalyticsEvent(e,r){try{window.dispatchEvent(new CustomEvent("drawer.analytics",{detail:{action:e,error_type:r==null?void 0:r.error_type,error_code:r==null?void 0:r.error_code,correlation_id:r==null?void 0:r.correlation_id}}))}catch(t){this.log("Analytics dispatch failed",t)}}hasActiveDrawers(){return this.activeDrawers.size>0}getActiveDrawerCount(){return this.activeDrawers.size}};window.drawerProtocol||(window.drawerProtocol=new l);
