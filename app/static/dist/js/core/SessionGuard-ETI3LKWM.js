var y="sessionGuard:draft:";var p="/auth/login",E=typeof window!="undefined"&&!!window.__IS_AUTHENTICATED__,d=!1;function m(){try{return window.localStorage}catch{return null}}function l(e){return window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(e):String(e).replace(/[^a-zA-Z0-9_\-]/g,"\\$&")}function f(){return`${y}${window.location.pathname}`}function A(){try{let e=m();if(!e)return null;let n=e.getItem(f());if(!n)return null;let t=JSON.parse(n);return!t||typeof t!="object"?null:Date.now()-(t.timestamp||0)>18e5?(e.removeItem(f()),null):t}catch(e){return console.warn("SessionGuard: unable to read draft",e),null}}function T(e){try{let n=m();if(!n)return;n.setItem(f(),JSON.stringify(e))}catch(n){console.warn("SessionGuard: unable to persist draft",n)}}function b(){try{let e=m();if(!e)return;e.removeItem(f())}catch(e){console.warn("SessionGuard: unable to remove draft",e)}}function L(e,n){if(!e||e.dataset.sessionGuard==="off")return null;let t=[];return Array.from(e.elements||[]).forEach(r=>{if(!r||r.disabled)return;let o=(r.tagName||"").toLowerCase(),i=(r.type||"").toLowerCase();if(!["input","select","textarea"].includes(o)||i==="password"||i==="hidden"||i==="file")return;let u=r.name||r.id;if(!u)return;let a;if(o==="select"&&r.multiple){if(a=Array.from(r.selectedOptions||[]).map(c=>c.value),!a.length)return}else if(i==="checkbox"){if(a=r.checked,a===r.defaultChecked)return}else if(i==="radio"){if(!r.checked)return;a=r.value}else{a=r.value;let c=r.defaultValue||"";if(!a&&!c||a===c)return}t.push({name:u,type:i,tag:o,value:a,selector:r.id?`#${l(r.id)}`:`[name="${l(r.name||r.id)}"]`})}),t.length?{id:e.id||null,name:e.getAttribute("name")||null,index:n,fields:t}:null}function S(){try{let e=Array.from(document.forms||[]),n=[];if(e.forEach((r,o)=>{let i=L(r,o);i&&n.push(i)}),!n.length)return null;let t=document.activeElement,s=t&&t.name?{name:t.name,id:t.id||null,formId:t.form&&t.form.id||null,formName:t.form&&t.form.getAttribute("name")||null}:null;return{url:window.location.pathname,timestamp:Date.now(),forms:n,active:s}}catch(e){return console.warn("SessionGuard: unable to snapshot forms",e),null}}function _(e){if(!e)return null;if(e.id){let t=document.getElementById(e.id);if(t)return t}if(e.name){let t=document.querySelector(`form[name="${l(e.name)}"]`);if(t)return t}let n=Array.from(document.forms||[]);return typeof e.index=="number"&&e.index>=0&&e.index<n.length?n[e.index]:null}function v(){let e=A();if(!e||!Array.isArray(e.forms))return;let n=!1;if(e.forms.forEach(t=>{let s=_(t);s&&t.fields.forEach(r=>{if(!(!r||!r.selector))try{if(r.type==="radio"){s.querySelectorAll(`[name="${l(r.name)}"]`).forEach(c=>{c.value===r.value&&(c.checked=!0)}),n=!0;return}let o=s.querySelector(r.selector);if(!o)return;let i=(o.tagName||"").toLowerCase(),u=(o.type||"").toLowerCase();if(i==="select"&&o.multiple&&Array.isArray(r.value)){let a=new Set(r.value.map(String));Array.from(o.options).forEach(c=>{c.selected=a.has(c.value)}),n=!0;return}if(u==="checkbox"){o.checked=!!r.value,n=!0;return}typeof r.value=="string"&&(o.value=r.value,n=!0)}catch(o){console.warn("SessionGuard: unable to restore field",r,o)}})}),n&&(b(),e.active)){let t=null;e.active.id&&(t=document.getElementById(e.active.id)),!t&&e.active.name&&(t=document.querySelector(`[name="${l(e.active.name)}"]`)),t&&typeof t.focus=="function"&&t.focus({preventScroll:!1})}}function I(){let e=`${window.location.pathname}${window.location.search}${window.location.hash}`,n=new URL(p,window.location.origin);return n.searchParams.has("next")||n.searchParams.set("next",e),n.toString()}function w(e){if(d)return;d=!0;let n=S();n&&T(n);try{window.dispatchEvent(new CustomEvent("session-expired",{detail:{source:e,timestamp:Date.now()}}))}catch(t){console.warn("SessionGuard: unable to dispatch event",t)}if(window.location.pathname.startsWith(p)){window.location.reload();return}window.location.assign(I())}function h(e){if(!e)return!1;try{return new URL(e,window.location.origin).pathname.startsWith(p)}catch{return!1}}function x(){if(typeof window.fetch!="function")return;let e=window.fetch.bind(window);window.fetch=async(...n)=>{try{let t=await e(...n);return d||(t.status===401||t.status===419||t.redirected&&h(t.url)||h(t.url))&&w("fetch"),t}catch(t){throw t}}}function R(){let{XMLHttpRequest:e}=window;if(!e||!e.prototype)return;let n=e.prototype.open,t=e.prototype.send;e.prototype.open=function(r,o,...i){return this.__sessionGuardRequestUrl=o,n.call(this,r,o,...i)},e.prototype.send=function(r){return this.addEventListener("load",function(){if(d)return;let i=this.status,u=this.responseURL||this.__sessionGuardRequestUrl;(i===401||i===419||h(u))&&w("xhr")}),this.addEventListener("error",function(){}),t.call(this,r)}}function G(){try{let e=m();if(!e)return;let n=[];for(let t=0;t<e.length;t+=1){let s=e.key(t);if(s&&s.startsWith(y)){let r=e.getItem(s);if(!r){n.push(s);continue}try{let o=JSON.parse(r);(!o||Date.now()-(o.timestamp||0)>18e5)&&n.push(s)}catch{n.push(s)}}}n.forEach(t=>e.removeItem(t))}catch(e){console.warn("SessionGuard: unable to cleanup drafts",e)}}function g(){G(),v(),x(),R()}E?document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g,{once:!0}):g():console.debug("SessionGuard: disabled for anonymous visitor");var C={snapshotForms:S,restoreDraft:v,triggerSessionExpired:w};export{C as default};
