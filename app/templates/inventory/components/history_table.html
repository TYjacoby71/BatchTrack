          <!-- History Table -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">History</h5>
            </div>
            <div class="card-body p-0">
              <div style="overflow-x: auto;">
                <table class="table table-hover table-sm mb-0" style="min-width: 1200px;">
                <thead>
                  <tr>
                    <th style="white-space: nowrap;">Date</th>
                    <th style="white-space: nowrap;">Change Type</th>
                    <th style="white-space: nowrap;">Quantity Change</th>
                    <th style="white-space: nowrap;">Remaining</th>
                    <th style="white-space: nowrap;">Cost per Unit</th>
                    <th style="white-space: nowrap;">Total Cost</th>
                    <th style="white-space: nowrap;">Used For</th>
                    <th style="white-space: nowrap;">Credited/Debited To</th>
                    <th style="white-space: nowrap;">FIFO ID</th>
                    <th style="white-space: nowrap;">Exp Date</th>
                    <th style="white-space: nowrap;">Quantity Used</th>
                    <th style="white-space: nowrap;">Created By</th> 
                      <i class="fas fa-info-circle text-muted ms-1" 
                         data-bs-toggle="popover" 
                         data-bs-placement="top"
                         data-bs-trigger="click"
                         data-bs-html="true"
                         data-bs-content="
                           <div class='fifo-prefix-guide'>
                             <h6 class='mb-2'>FIFO ID Prefixes</h6>
                             <div class='row'>
                               <div class='col-6'>
                                 <strong>RSK</strong> - Restock<br>
                                 <strong>BTC</strong> - Batch<br>
                                 <strong>SPL</strong> - Spoilage<br>
                                 <strong>TRS</strong> - Trash
                               </div>
                               <div class='col-6'>
                                 <strong>RCN</strong> - Recount<br>
                                 <strong>FIN</strong> - Finished Batch<br>
                                 <strong>REF</strong> - Refunded<br>
                                 <strong>CST</strong> - Cost Override
                               </div>
                             </div>
                           </div>"
                         title="FIFO ID Reference"
                         style="cursor: pointer;">
                      </i>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in history %}
                  {% set is_expired = entry.is_perishable and entry.expiration_date and entry.remaining_quantity and entry.remaining_quantity > 0 and entry.expiration_date.date() < now.date() %}
                  {% set is_expiring_soon = entry.is_perishable and entry.expiration_date and entry.remaining_quantity and entry.remaining_quantity > 0 and entry.expiration_date.date() >= now.date() and (entry.expiration_date.date() - now.date()).days <= 7 %}
                  <tr class="{% if is_expired %}table-danger{% elif is_expiring_soon %}table-warning{% endif %}" 
                      {% if is_expired %}style="background-color: #f8d7da !important; border-color: #f5c6cb !important;"{% elif is_expiring_soon %}style="background-color: #fff3cd !important; border-color: #ffeaa7 !important;"{% endif %}>
                    <td>{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                      {% if entry.change_type == 'finished_batch' %}
                        Finished Batch
                      {% else %}
                        {{ entry.change_type|title }}
                      {% endif %}
                    </td>
                    <td>{{ entry.quantity_change }}{% if item.type != 'container' %} {{ entry.unit }}{% endif %}</td>
                    <td>{{ "%.2f"|format(entry.remaining_quantity) if entry.remaining_quantity is not none and entry.change_type in ['restock', 'finished_batch'] else 'NA' }}</td>
                    <td>${{ "%.2f"|format(entry.unit_cost) if entry.unit_cost is not none else 'NA' }}</td>
                    <td>{% if entry.unit_cost is not none %}${{ "%.2f"|format(abs(entry.quantity_change) * entry.unit_cost) }}{% else %}NA{% endif %}</td>
                    <td>
                      {% if entry.used_for_batch %}
                        <a href="{{ url_for('batches.view_batch', batch_identifier=entry.used_for_batch.id) }}">{{ entry.used_for_batch.label_code }}</a>
                      {% elif entry.change_type in ['batch', 'spoil', 'trash', 'refunded'] and entry.batch %}
                        <a href="{{ url_for('batches.view_batch', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.fifo_reference_id %}
                        {% set ref_entry = history|selectattr('id', 'equalto', entry.fifo_reference_id)|first %}
                        {% if ref_entry and ref_entry.change_type == 'finished_batch' and ref_entry.batch %}
                          {% if ref_entry.batch.status == 'in_progress' %}
                            <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=ref_entry.batch.id) }}">{{ ref_entry.batch.label_code }}</a>
                          {% else %}
                            <a href="{{ url_for('batches.view_batch', batch_identifier=ref_entry.batch.id) }}">{{ ref_entry.batch.label_code }}</a>
                          {% endif %}
                        {% elif ref_entry %}
                          <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.fifo_reference_id }}">
                            {% if ref_entry.change_type == 'finished_batch' and ref_entry.batch %}
                              {{ ref_entry.batch.label_code }}
                            {% else %}
                              {{ get_change_type_prefix(ref_entry.change_type) }}-{{ int_to_base36(ref_entry.id).zfill(6) }}
                            {% endif %}
                          </a>
                        {% else %}
                          <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.fifo_reference_id }}">
                            {{ get_change_type_prefix('restock') }}-{{ int_to_base36(entry.fifo_reference_id).zfill(6) }}
                          </a>
                        {% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.change_type == 'finished_batch' and entry.batch %}
                        {% if entry.batch.status == 'in_progress' %}
                          <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
                        {% else %}
                          <a href="{{ url_for('batches.view_batch', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
                        {% endif %}
                      {% elif entry.change_type == 'restock' or entry.change_type == 'manual_addition' %}
                        {{ get_change_type_prefix(entry.change_type) }}-{{ int_to_base36(entry.id).zfill(6) }}
                      {% else %}
                        {{ get_change_type_prefix(entry.change_type) }}-{{ int_to_base36(entry.id).zfill(6) }}
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.expiration_date %}
                        {{ entry.expiration_date.strftime('%Y-%m-%d') }}
                        {% if is_expired %}
                          <span class="badge bg-danger ms-1">EXPIRED</span>
                        {% elif is_expiring_soon %}
                          <span class="badge bg-warning ms-1">EXPIRES SOON</span>
                        {% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ entry.quantity_used if entry.quantity_used is not none and entry.quantity_used != 0 else 'NA' }}</td>
                    <td>{% if entry.created_by %}{{ User.query.get(entry.created_by).username }}{% else %}-{% endif %}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                </table>
              </div>

              </div>
            {% if pagination.pages > 1 %}
            <div class="card-footer">
              <nav aria-label="History navigation">
                <ul class="pagination justify-content-center mb-0">
                  {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.prev_num) }}">&laquo;</a>
                  </li>
                  {% endif %}

                  {% for page in pagination.iter_pages() %}
                  {% if page %}
                  <li class="page-item {% if page == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=page) }}">{{ page }}</a>
                  </li>
                  {% else %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                  {% endfor %}

                  {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.next_num) }}">&raquo;</a>
                  </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
            {% endif %}
          </div>