<!-- History Table -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">History</h5>
            </div>
            <div class="card-body p-0">
              <div style="overflow-x: auto;">
                <table class="table table-hover table-sm mb-0" style="min-width: 1200px;">
                <thead>
                  <tr>
                    <th style="white-space: nowrap;">Date</th>
                    <th style="white-space: nowrap;">Change Type</th>
                    <th style="white-space: nowrap;">Quantity Change</th>
                    <th style="white-space: nowrap;">Remaining</th>
                    <th style="white-space: nowrap;">Cost per Unit</th>
                    <th style="white-space: nowrap;">Total Cost</th>
                    <th style="white-space: nowrap;">Used For</th>
                    <th style="white-space: nowrap;">Credited/Debited To</th>
                    <th style="white-space: nowrap;">Event Code</th>
                    <th style="white-space: nowrap;">Exp Date</th>
                    <th style="white-space: nowrap;">Quantity Used</th>
                    <th style="white-space: nowrap;">Created By</th>
                      <i class="fas fa-info-circle text-muted ms-1"
                         data-bs-toggle="popover"
                         data-bs-placement="top"
                         data-bs-trigger="click"
                         data-bs-html="true"
                         data-bs-content="
                           <div class='fifo-prefix-guide'>
                             <h6 class='mb-2'>FIFO ID Prefixes</h6>
                             <div class='row'>
                               <div class='col-6'>
                                 <strong>LOT</strong> - Inventory Lots<br>
                                 <strong>SLD</strong> - Sold<br>
                                 <strong>SHP</strong> - Shipped<br>
                                 <strong>SPL</strong> - Spoilage<br>
                                 <strong>TRS</strong> - Trash<br>
                                 <strong>DMG</strong> - Damaged<br>
                                 <strong>BCH</strong> - Batch<br>
                                 <strong>RCN</strong> - Recount
                               </div>
                               <div class='col-6'>
                                 <strong>REF</strong> - Refunded<br>
                                 <strong>RTN</strong> - Returned<br>
                                 <strong>CST</strong> - Cost Override<br>
                                 <strong>ADD</strong> - Manual Addition<br>
                                 <strong>TST</strong> - Tester<br>
                                 <strong>GFT</strong> - Gift<br>
                                 <strong>QFL</strong> - Quality Fail<br>
                                 <strong>Note:</strong> finished_batch shows batch label
                               </div>
                             </div>
                           </div>"
                         title="FIFO ID Reference"
                         style="cursor: pointer;">
                      </i>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in history %}
                  {% set lot_expired = entry.affected_lot and entry.affected_lot.expiration_date and entry.affected_lot.remaining_quantity > 0 and entry.affected_lot.expiration_date.date() < now.date() %}
                  {% set lot_expiring_soon = entry.affected_lot and entry.affected_lot.expiration_date and entry.affected_lot.remaining_quantity > 0 and entry.affected_lot.expiration_date.date() >= now.date() and (entry.affected_lot.expiration_date.date() - now.date()).days <= 7 %}
                  {% set is_expired = lot_expired %}
                  {% set is_expiring_soon = lot_expiring_soon %}
                  <tr class="{% if is_expired %}table-danger{% elif is_expiring_soon %}table-warning{% endif %}"
                      {% if is_expired %}style="background-color: var(--color-danger-bg) !important; border-color: var(--color-danger) !important;"{% elif is_expiring_soon %}style="background-color: var(--color-warning-bg) !important; border-color: var(--color-warning) !important;"{% endif %}>
                    <td>{{ TimezoneUtils.format_for_user(entry.timestamp, '%Y-%m-%d %H:%M') if entry.timestamp else 'N/A' }}</td>
                    <td>
                      {% if entry.change_type == 'finished_batch' %}
                        Finished Batch
                      {% else %}
                        {{ entry.change_type|title }}
                      {% endif %}
                    </td>
                    <td>{{ entry.quantity_change }}{% if item.type != 'container' %} {{ entry.unit }}{% endif %}</td>
                    <td>
                        {% set lot_creation_types = ['restock', 'manual_addition', 'finished_batch', 'initial_stock', 'returned', 'refunded'] %}
                        {% if entry.change_type in lot_creation_types and entry.affected_lot %}
                            {{ entry.affected_lot.remaining_quantity|round(2) }} {{ entry.unit }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.affected_lot_id and entry.affected_lot %}
                            ${{ entry.affected_lot.unit_cost|round(2) }}
                        {% elif entry.unit_cost %}
                            ${{ entry.unit_cost|round(2) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{% if entry.unit_cost is not none %}${{ "%.2f"|format(abs(entry.quantity_change) * entry.unit_cost) }}{% else %}NA{% endif %}</td>
                    <td>
                      {% if entry.quantity_change < 0 and entry.used_for_batch %}
                        {% if entry.used_for_batch.status == 'in_progress' %}
                          <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=entry.used_for_batch.id) }}">{{ entry.used_for_batch.label_code }}</a>
                        {% else %}
                          <a href="{{ url_for('batches.view_batch_record', batch_identifier=entry.used_for_batch.id) }}">{{ entry.used_for_batch.label_code }}</a>
                        {% endif %}
                      {% elif entry.quantity_change < 0 and entry.change_type in ['batch', 'spoil', 'trash', 'refunded'] and entry.batch %}
                        {% if entry.batch.status == 'in_progress' %}
                          <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
                        {% else %}
                          <a href="{{ url_for('batches.view_batch_record', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
                        {% endif %}
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.affected_lot and entry.affected_lot.fifo_code %}
                        {{ entry.affected_lot.fifo_code }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.fifo_code %}
                        <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.id }}" class="text-decoration-none">
                          {{ entry.fifo_code }}
                        </a>
                      {% elif entry.change_type == 'finished_batch' and entry.batch and entry.batch.label_code %}
                        <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.id }}" class="text-decoration-none">
                          {{ entry.batch.label_code }}
                        </a>
                      {% elif entry.affected_lot and entry.affected_lot.fifo_code %}
                        <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.id }}" class="text-decoration-none">
                          {{ entry.affected_lot.fifo_code }}
                        </a>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if entry.affected_lot and entry.affected_lot.expiration_date %}
                        {% set exp_date = TimezoneUtils.format_for_user(entry.affected_lot.expiration_date, '%Y-%m-%d') %}
                        {{ exp_date }}
                        {% if is_expired %}
                          <span class="badge bg-danger ms-1">EXPIRED</span>
                        {% elif is_expiring_soon %}
                          <span class="badge bg-warning ms-1">EXPIRES SOON</span>
                        {% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ entry.quantity_used if entry.quantity_used is not none and entry.quantity_used != 0 else 'NA' }}</td>
                    <td>{% if entry.created_by %}{{ User.query.get(entry.created_by).username }}{% else %}-{% endif %}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                </table>
              </div>

              </div>
            {% if pagination.pages > 1 %}
            <div class="card-footer">
              <nav aria-label="History navigation">
                <ul class="pagination justify-content-center mb-0">
                  {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.prev_num) }}">&laquo;</a>
                  </li>
                  {% endif %}

                  {% for page in pagination.iter_pages() %}
                  {% if page %}
                  <li class="page-item {% if page == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=page) }}">{{ page }}</a>
                  </li>
                  {% else %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                  {% endfor %}

                  {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.next_num) }}">&raquo;</a>
                  </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
            {% endif %}
          </div>