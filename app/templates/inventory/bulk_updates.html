{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h4 mb-1">Bulk Inventory Assistant</h2>
                    <p class="text-muted mb-0">
                        Draft high-volume restocks, spoils, or trash events in one place.
                        Drafts stay local to your browser until you submit or close the modal.
                    </p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('inventory.list_inventory') }}">
                        <i class="fas fa-warehouse me-2"></i>Inventory List
                    </a>
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                        <i class="fas fa-layer-group me-2"></i>Open Bulk Modal
                    </button>
                </div>
            </div>
        </div>
        <div class="alert alert-info">
            <strong>Tip:</strong> Batchley can pre-fill this modal for you. Ask it to “set up a bulk restock draft”
            and it will push line items here for review.
        </div>
    </div>
</div>

<div class="modal fade" id="bulkUpdateModal" tabindex="-1" aria-labelledby="bulkUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="bulkUpdateModalLabel">Bulk Inventory Update</h5>
                    <small class="text-muted">Create inventory, restock, spoil, or trash multiple items in a single run.</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                    <div>
                        <span class="fw-semibold">Drafts</span>
                        <span class="badge bg-secondary" id="draftCount">0</span>
                        <div id="draftList" class="mt-1 small text-muted"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" id="loadDraftBtn" disabled>Load Selected</button>
                        <button class="btn btn-outline-danger btn-sm" id="deleteDraftBtn" disabled>Delete Selected</button>
                    </div>
                </div>

                <div class="table-responsive mb-3">
                    <table class="table table-sm align-middle" id="bulkTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 140px;">Change Type</th>
                                <th>Inventory Item</th>
                                <th style="width: 140px;">Quantity</th>
                                <th style="width: 120px;">Unit</th>
                                <th style="width: 140px;">Cost/Unit</th>
                                <th>Notes</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-primary" id="addRowBtn">
                        <i class="fas fa-plus"></i> Add Row
                    </button>
                    <button class="btn btn-outline-danger" id="clearRowsBtn">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                    <button class="btn btn-outline-secondary ms-auto" id="saveDraftBtn">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button class="btn btn-primary" id="submitDraftBtn">
                        <i class="fas fa-paper-plane"></i> Submit
                    </button>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-semibold">Status</label>
                    <div id="bulkStatus" class="alert alert-secondary mb-0">No lines queued yet.</div>
                    <div class="small text-muted mt-2">
                        <span class="me-3">
                            <i class="fas fa-boxes-stacked me-1"></i>{{ inventory_items|length if inventory_items else 0 }} inventory items connected
                        </span>
                        <span>
                            <i class="fas fa-ruler-combined me-1"></i>{{ unit_options|length if unit_options else 0 }} unit options loaded
                        </span>
                    </div>
                    <div id="resultDetails" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<datalist id="inventorySuggestions">
    {% for item in inventory_items or [] %}
        <option value="{{ item.name }}"></option>
    {% endfor %}
</datalist>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function () {
    const storageKey = 'bt_bulk_inventory_drafts';
    const rawInventoryOptions = {{ (inventory_items or [])|tojson }};
    const rawUnitOptions = {{ (unit_options or [])|tojson }};
    const inventoryOptions = Array.isArray(rawInventoryOptions) ? rawInventoryOptions : [];
    const unitOptions = Array.isArray(rawUnitOptions) ? rawUnitOptions : [];
    const inventoryById = new Map(inventoryOptions.map(item => [Number(item.id), item]));
    const inventoryByName = new Map(inventoryOptions.map(item => [String(item.name || '').toLowerCase(), item]));
    const safeUnitOptions = unitOptions.length ? unitOptions : [{ name: 'count', symbol: null, unit_type: 'count' }];
    const unitOptionsMarkup = safeUnitOptions.map(unit => {
        const label = escapeHtml(unit.name || '');
        const suffix = unit.symbol ? ` (${escapeHtml(unit.symbol)})` : '';
        return `<option value="${label}">${label}${suffix}</option>`;
    }).join('');
    const defaultUnit = safeUnitOptions[0]?.name || '';
    const tableBody = document.querySelector('#bulkTable tbody');
    const draftCountEl = document.getElementById('draftCount');
    const draftListEl = document.getElementById('draftList');
    const statusEl = document.getElementById('bulkStatus');
    const resultsEl = document.getElementById('resultDetails');
    const loadBtn = document.getElementById('loadDraftBtn');
    const deleteBtn = document.getElementById('deleteDraftBtn');
    const modalEl = document.getElementById('bulkUpdateModal');
    let selectedDraftId = null;

    function escapeHtml(value) {
        if (value === undefined || value === null) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function helperCopy(match) {
        if (match) {
            const unitLabel = match.unit || 'unit';
            return `Linked to #${match.id} · ${unitLabel}`;
        }
        if (!inventoryOptions.length) {
            return 'Enter details to create inventory lines on submit.';
        }
        return 'Type an exact inventory name to link an existing item.';
    }

    function resolveInventoryMatch(descriptor = {}) {
        if (!inventoryOptions.length) {
            return null;
        }
        const idCandidate = descriptor.inventory_item_id ?? descriptor.id;
        const numericId = Number(idCandidate);
        if (!Number.isNaN(numericId) && numericId > 0 && inventoryById.has(numericId)) {
            return inventoryById.get(numericId);
        }
        const rawName = (descriptor.inventory_item_name || descriptor.name || '').trim().toLowerCase();
        if (rawName && inventoryByName.has(rawName)) {
            return inventoryByName.get(rawName);
        }
        return null;
    }

    function clearResults() {
        if (!resultsEl) return;
        resultsEl.style.display = 'none';
        resultsEl.innerHTML = '';
    }

    function renderResults(results) {
        if (!resultsEl) return;
        if (!Array.isArray(results) || !results.length) {
            clearResults();
            return;
        }
        const rows = results.map(entry => {
            const resolvedName = entry.item_name
                || (entry.item_id && inventoryById.get(Number(entry.item_id))?.name)
                || '—';
            return `
                <tr class="${entry.success ? 'table-success' : 'table-danger'}">
                    <td>${entry.line ?? '—'}</td>
                    <td>${escapeHtml(resolvedName)}</td>
                    <td class="text-capitalize">${escapeHtml(entry.change_type || '—')}</td>
                    <td>${escapeHtml(entry.message || '')}</td>
                </tr>
            `;
        }).join('');
        resultsEl.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Line</th>
                            <th>Item</th>
                            <th>Change</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
        resultsEl.style.display = 'block';
    }

    function getDrafts() {
        try {
            return JSON.parse(localStorage.getItem(storageKey) || '[]');
        } catch (err) {
            console.warn('Failed to parse drafts', err);
            return [];
        }
    }

    function saveDrafts(drafts) {
        localStorage.setItem(storageKey, JSON.stringify(drafts));
        renderDraftList();
    }

    function renderDraftList() {
        const drafts = getDrafts();
        draftCountEl.textContent = drafts.length;
        if (!drafts.length) {
            draftListEl.innerHTML = '<em>No saved drafts.</em>';
            loadBtn.disabled = true;
            deleteBtn.disabled = true;
            selectedDraftId = null;
            return;
        }
        const buttons = drafts.map((draft, idx) => `
            <button class="btn btn-sm btn-outline-secondary me-1 mb-1 draft-chip" data-draft="${idx}">
                ${escapeHtml(draft.name)}
            </button>
        `).join('');
        draftListEl.innerHTML = buttons;
        document.querySelectorAll('.draft-chip').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.draft-chip').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                selectedDraftId = Number(btn.dataset.draft);
                loadBtn.disabled = false;
                deleteBtn.disabled = false;
            });
        });
    }

    function attachRowEvents(row) {
        const nameInput = row.querySelector('.item-name');
        const idInput = row.querySelector('.item-id');
        const helperEl = row.querySelector('.item-helper');
        const unitSelect = row.querySelector('.unit');

        function applyMatch(match) {
            if (match) {
                idInput.value = match.id;
                helperEl.textContent = helperCopy(match);
                if (!row.dataset.unitTouched && match.unit) {
                    unitSelect.value = match.unit;
                }
            } else {
                idInput.value = '';
                helperEl.textContent = helperCopy(null);
            }
        }

        function lookupInventory() {
            const value = (nameInput.value || '').trim();
            if (!value) {
                applyMatch(null);
                return;
            }
            const cleanedNumeric = value.startsWith('#') ? value.slice(1) : value;
            if (/^\d+$/.test(cleanedNumeric)) {
                const numericId = Number(cleanedNumeric);
                if (inventoryById.has(numericId)) {
                    applyMatch(inventoryById.get(numericId));
                    return;
                }
            }
            const byName = inventoryByName.get(value.toLowerCase());
            applyMatch(byName || null);
        }

        if (nameInput) {
            nameInput.addEventListener('change', lookupInventory);
            nameInput.addEventListener('blur', lookupInventory);
            lookupInventory();
        }
        if (unitSelect) {
            unitSelect.addEventListener('change', () => {
                row.dataset.unitTouched = 'true';
            });
        }
    }

    function addRow(data = {}) {
        const match = resolveInventoryMatch(data);
        const displayName = data.inventory_item_name || match?.name || '';
        const helperText = helperCopy(match);
        const selectedUnit = data.unit || match?.unit || defaultUnit;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm change-type">
                    <option value="create"${data.change_type === 'create' ? ' selected' : ''}>Create</option>
                    <option value="restock"${data.change_type === 'restock' ? ' selected' : ''}>Restock</option>
                    <option value="spoil"${data.change_type === 'spoil' ? ' selected' : ''}>Spoil</option>
                    <option value="trash"${data.change_type === 'trash' ? ' selected' : ''}>Trash</option>
                </select>
            </td>
            <td>
                <div class="position-relative">
                    <input type="hidden" class="item-id" value="${data.inventory_item_id || ''}">
                    <input type="text" class="form-control form-control-sm item-name" list="inventorySuggestions"
                           placeholder="Item name or ID" value="${escapeHtml(displayName)}">
                    <div class="form-text item-helper">${escapeHtml(helperText)}</div>
                </div>
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm quantity" value="${data.quantity ?? ''}">
            </td>
            <td>
                <select class="form-select form-select-sm unit">
                    <option value="">Select unit</option>
                    ${unitOptionsMarkup}
                </select>
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm cost" value="${data.cost_per_unit ?? ''}">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm notes" value="${escapeHtml(data.notes || '')}">
            </td>
            <td>
                <button class="btn btn-link text-danger p-0 remove-row" aria-label="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        row.querySelector('.unit').value = selectedUnit || '';
        row.querySelector('.remove-row').addEventListener('click', () => {
            row.remove();
            updateStatus(undefined, { resetResults: true });
        });
        tableBody.appendChild(row);
        attachRowEvents(row);
        updateStatus();
    }

    function collectRows() {
        const rows = [];
        tableBody.querySelectorAll('tr').forEach(row => {
            const itemId = row.querySelector('.item-id').value;
            const nameValue = row.querySelector('.item-name').value.trim();
            const quantityInput = row.querySelector('.quantity').value;
            const costInput = row.querySelector('.cost').value;
            rows.push({
                change_type: row.querySelector('.change-type').value,
                inventory_item_id: itemId ? Number(itemId) : null,
                inventory_item_name: nameValue,
                quantity: quantityInput ? Number(quantityInput) : null,
                unit: row.querySelector('.unit').value.trim(),
                cost_per_unit: costInput ? Number(costInput) : null,
                notes: row.querySelector('.notes').value.trim(),
                allow_create: !itemId,
            });
        });
        return rows;
    }

    function loadDraft(index) {
        const drafts = getDrafts();
        const draft = drafts[index];
        if (!draft) return;
        tableBody.innerHTML = '';
        (draft.lines || []).forEach(line => addRow(line));
        updateStatus(`Loaded draft “${draft.name}”.`, { resetResults: true });
    }

    function deleteDraft(index) {
        const drafts = getDrafts();
        drafts.splice(index, 1);
        saveDrafts(drafts);
        loadBtn.disabled = true;
        deleteBtn.disabled = true;
        selectedDraftId = null;
        updateStatus('Draft deleted.', { resetResults: true });
    }

    function updateStatus(message, options = {}) {
        const { resetResults = false } = options;
        if (resetResults) {
            clearResults();
        }
        const rows = tableBody.querySelectorAll('tr').length;
        if (message) {
            statusEl.className = 'alert alert-info';
            statusEl.textContent = message;
            return;
        }
        if (!rows) {
            statusEl.className = 'alert alert-secondary';
            statusEl.textContent = 'No lines queued yet.';
        } else {
            const linkedCount = Array.from(tableBody.querySelectorAll('.item-id')).filter(input => input.value).length;
            statusEl.className = 'alert alert-primary';
            const linkedLabel = linkedCount ? ` · ${linkedCount} linked to inventory` : '';
            statusEl.textContent = `${rows} line(s) ready${linkedLabel}.`;
        }
    }

    document.getElementById('addRowBtn').addEventListener('click', () => {
        addRow();
    });

    document.getElementById('clearRowsBtn').addEventListener('click', () => {
        tableBody.innerHTML = '';
        updateStatus('All lines cleared.', { resetResults: true });
    });

    document.getElementById('saveDraftBtn').addEventListener('click', () => {
        const rows = collectRows();
        if (!rows.length) {
            updateStatus('Nothing to save.', { resetResults: false });
            return;
        }
        const name = prompt('Name this draft:', `Draft ${new Date().toLocaleString()}`);
        if (!name) return;
        const drafts = getDrafts();
        drafts.unshift({ name, lines: rows });
        saveDrafts(drafts);
        updateStatus(`Saved draft “${name}”.`);
    });

    document.getElementById('submitDraftBtn').addEventListener('click', () => {
        const rows = collectRows();
        if (!rows.length) {
            updateStatus('Add at least one row before submitting.', { resetResults: true });
            return;
        }
        clearResults();
        updateStatus('Submitting…');
        fetch('{{ url_for("inventory.api_bulk_inventory_adjustments") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ lines: rows })
        })
        .then(resp => resp.json().then(data => ({ status: resp.status, body: data })))
        .then(({ status, body }) => {
            const results = body.results || [];
            if (status >= 200 && status < 300 && body.success) {
                updateStatus('Bulk update submitted successfully.', { resetResults: false });
                renderResults(results);
                tableBody.innerHTML = '';
            } else {
                updateStatus(body.error || 'Bulk update failed.');
                renderResults(results);
            }
        })
        .catch(err => {
            console.error(err);
            updateStatus('Unexpected error submitting bulk update.', { resetResults: false });
        });
    });

    loadBtn.addEventListener('click', () => {
        if (selectedDraftId === null) return;
        loadDraft(selectedDraftId);
    });
    deleteBtn.addEventListener('click', () => {
        if (selectedDraftId === null) return;
        if (confirm('Delete this draft?')) {
            deleteDraft(selectedDraftId);
        }
    });

    modalEl.addEventListener('hide.bs.modal', () => {
        const rows = collectRows();
        if (!rows.length) {
            clearResults();
            return;
        }
        const save = confirm('Save this draft before closing?');
        if (save) {
            const name = prompt('Name this draft:', `Draft ${new Date().toLocaleString()}`) || `Draft ${new Date().toLocaleString()}`;
            const drafts = getDrafts();
            drafts.unshift({ name, lines: rows });
            saveDrafts(drafts);
            updateStatus(`Draft “${name}” saved.`);
        } else {
            tableBody.innerHTML = '';
            clearResults();
            updateStatus('Draft discarded.');
        }
    });

    renderDraftList();
    addRow();
})();
</script>
{% endblock %}
