{#
Synopsis:
Appearance settings controls for selecting and persisting user theme preference.

Glossary:
- System theme: Theme mode that follows the device/browser color-scheme preference.
- Theme storage key: Scoped localStorage key used for per-user/per-org persistence.
#}
<div class="row">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-palette"></i> Theme</h5>
      </div>
      <div class="card-body" x-data="(function(){
        const userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
        const storageKey = (window.BT_STORAGE && typeof window.BT_STORAGE.key === 'function')
          ? window.BT_STORAGE.key('theme')
          : (userId ? ('bt_theme:' + userId) : 'bt_theme');
        const hasServerTheme = {{ 'true' if theme_preference_scoped else 'false' }};
        const serverTheme = {{ theme_preference | tojson if theme_preference_scoped else 'null' }};
        const storedTheme = localStorage.getItem(storageKey);
        const resolvedServerTheme = (hasServerTheme && serverTheme) ? serverTheme : null;
        let initialTheme = resolvedServerTheme || storedTheme || 'light';

        if (resolvedServerTheme) {
          localStorage.setItem(storageKey, resolvedServerTheme);
        } else if (!storedTheme) {
          localStorage.setItem(storageKey, 'light');
        }

        return {
          themeStorageKey: storageKey,
          theme: initialTheme,
          async applyTheme(newTheme) {
            this.theme = newTheme;
            try {
              // Apply theme immediately to DOM and localStorage.
              const appliedTheme = newTheme || 'light';
              document.documentElement.setAttribute('data-theme', appliedTheme);
              localStorage.setItem(this.themeStorageKey, appliedTheme);

              // Try to persist to user preferences (may fail for anonymous users or developers)
              try {
                const res = await fetch('/settings/api/user-preferences', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                  },
                  body: JSON.stringify({ theme: newTheme })
                });

                if (!res.ok) {
                  console.log('Theme saved to localStorage only (user preferences not available)');
                }
              } catch (prefError) {
                console.log('Theme saved to localStorage only (user preferences not available)');
              }
            } catch (e) {
              console.warn('Theme application failed:', e);
            }
          }
        };
      })()">
        <div class="mb-3">
          <label class="form-label">Choose theme</label>
          <select class="form-select" x-model="theme" @change="applyTheme($event.target.value)">
            <option value="system">System Default</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="warm">Soft Pastels & Neutral</option>
          </select>
          <small class="text-muted">Changes apply immediately and save to your profile.</small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" @click="applyTheme('system')">System</button>
          <button class="btn btn-outline-secondary" @click="applyTheme('light')">Light</button>
          <button class="btn btn-outline-secondary" @click="applyTheme('dark')">Dark</button>
          <button class="btn btn-outline-secondary" @click="applyTheme('warm')">Warm</button>
        </div>
      </div>
    </div>
  </div>
</div>
