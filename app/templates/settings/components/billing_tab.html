
<div class="row">
    <div class="col-12">
        <div class="mb-3">
            <h5><i class="fas fa-credit-card"></i> Subscription Management</h5>
            <p class="text-muted">Manage your subscription plan and billing settings</p>
            
            <!-- Debug Info -->
            {% if config.get('DEBUG') %}
            <div class="alert alert-info">
                <strong>Debug Mode:</strong>
                <ul class="mb-0">
                    <li>Stripe Secret Key: {{ '✓ Configured' if config.get('STRIPE_SECRET_KEY') else '✗ Missing' }}</li>
                    <li>Webhook Secret: {{ '✓ Configured' if config.get('STRIPE_WEBHOOK_SECRET') else '✗ Missing (Dev Mode)' }}</li>
                    <li>Mode: {{ 'Production' if config.get('STRIPE_WEBHOOK_SECRET') else 'Development' }}</li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if current_user.user_type == 'developer' and session.get('dev_selected_org_id') %}
    {# Developer viewing as customer - get the selected organization #}
    {% set org = get_organization_by_id(session.get('dev_selected_org_id')) %}
{% else %}
    {# Regular customer user #}
    {% set org = current_user.organization %}
{% endif %}

{% if org %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Current Plan</h6>
            </div>
            <div class="card-body">
                <h5 class="text-primary">
                    {% set tier_name = org.get_tier_display_name() %}
                    {{ tier_name if tier_name else org.effective_subscription_tier.title() }}
                </h5>
                <p class="text-muted">{{ org.active_users_count }}/{{ org.get_max_users() }} users</p>

                <h6 class="mt-3">Available Features:</h6>
                <ul class="list-unstyled">
                    {% for feature in org.get_subscription_features() %}
                    <li><i class="fas fa-check text-success me-2"></i>{{ feature|replace('_', ' ')|title }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-arrow-up"></i> Upgrade Available</h6>
            </div>
            <div class="card-body">
                <p>Unlock more features and users with our premium plans.</p>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('billing.upgrade') }}" class="btn btn-light">View All Plans</a>
                    {% if org.subscription and org.subscription.stripe_customer_id %}
                    <a href="{{ url_for('billing.customer_portal') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog"></i> Manage Billing
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No organization context available for billing management.
        </div>
    </div>
</div>
{% endif %}
