
{% extends "layout.html" %}

{% block content %}
<div class="container-fluid" x-data="systemSettingsData()">
    <h2><i class="fas fa-cogs"></i> System Settings</h2>
    <p class="text-muted">Configure system-wide settings and preferences</p>

    <!-- Production Tools Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs text-primary"></i> Production Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Batch Management</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-timer-completion" 
                                       x-model="settings.batch_rules.require_timer_completion"
                                       @change="updateSetting('batch_rules', 'require_timer_completion', $event.target.checked)">
                                <label class="form-check-label" for="require-timer-completion">
                                    Require timer completion before finishing batch
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="allow-intermediate-tags"
                                       x-model="settings.batch_rules.allow_intermediate_tags"
                                       @change="updateSetting('batch_rules', 'allow_intermediate_tags', $event.target.checked)">
                                <label class="form-check-label" for="allow-intermediate-tags">
                                    Allow intermediate tags during batch
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="stuck-batch-hours" class="form-label">Mark batches as stuck after (hours)</label>
                                <input type="number" class="form-control" id="stuck-batch-hours" 
                                       x-model="settings.batch_rules.stuck_batch_hours"
                                       @change="updateSetting('batch_rules', 'stuck_batch_hours', $event.target.value)"
                                       min="1" max="168">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Recipe & Planning</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-variations" 
                                       x-model="settings.recipe_builder.enable_variations"
                                       @change="updateSetting('recipe_builder', 'enable_variations', $event.target.checked)">
                                <label class="form-check-label" for="enable-variations">
                                    Enable recipe variations
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-cost-breakdown"
                                       x-model="settings.recipe_builder.show_cost_breakdown"
                                       @change="updateSetting('recipe_builder', 'show_cost_breakdown', $event.target.checked)">
                                <label class="form-check-label" for="show-cost-breakdown">
                                    Show cost breakdown in recipes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes text-success"></i> Inventory Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Tracking Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-fifo-tracking"
                                       x-model="settings.inventory.enable_fifo_tracking"
                                       @change="updateSetting('inventory', 'enable_fifo_tracking', $event.target.checked)">
                                <label class="form-check-label" for="enable-fifo-tracking">
                                    Enable FIFO (First In, First Out) tracking
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-calculate-costs"
                                       x-model="settings.inventory.auto_calculate_costs"
                                       @change="updateSetting('inventory', 'auto_calculate_costs', $event.target.checked)">
                                <label class="form-check-label" for="auto-calculate-costs">
                                    Auto-calculate ingredient costs
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Advanced Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-bulk-operations"
                                       x-model="settings.inventory.enable_bulk_operations"
                                       @change="updateSetting('inventory', 'enable_bulk_operations', $event.target.checked)">
                                <label class="form-check-label" for="enable-bulk-operations">
                                    Enable bulk inventory operations
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools text-secondary"></i> System Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Management</h6>
                            <div class="list-group mb-3">
                                <a href="{{ url_for('conversion_bp.manage_units') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ruler text-info"></i> Unit Management
                                </a>
                                <a href="{{ url_for('tags.manage_tags') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-tags text-success"></i> Tag Management
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Display Preferences</h6>
                            <div class="mb-3">
                                <label for="items-per-page" class="form-label">Items per page</label>
                                <select class="form-select" id="items-per-page"
                                        x-model="settings.system.per_page"
                                        @change="updateSetting('system', 'per_page', $event.target.value)">
                                    <option value="10">10 items</option>
                                    <option value="20">20 items</option>
                                    <option value="25">25 items</option>
                                    <option value="50">50 items</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-csv-export"
                                       x-model="settings.system.enable_csv_export"
                                       @change="updateSetting('system', 'enable_csv_export', $event.target.checked)">
                                <label class="form-check-label" for="enable-csv-export">
                                    Enable CSV export functionality
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Changes -->
    <div class="row">
        <div class="col-12">
            <button type="button" class="btn btn-primary" @click="saveAllSettings()">
                <i class="fas fa-save"></i> Save All Settings
            </button>
        </div>
    </div>
</div>

<script>
function systemSettingsData() {
    return {
        settings: {
            batch_rules: {
                require_timer_completion: false,
                allow_intermediate_tags: true,
                stuck_batch_hours: 24
            },
            recipe_builder: {
                enable_variations: true,
                show_cost_breakdown: true
            },
            inventory: {
                enable_fifo_tracking: true,
                auto_calculate_costs: true,
                enable_bulk_operations: true
            },
            system: {
                per_page: 25,
                enable_csv_export: true
            }
        },

        async updateSetting(section, key, value) {
            try {
                const response = await fetch('/settings/update-system-setting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({ section, key, value })
                });

                const data = await response.json();
                if (data.success) {
                    this.settings[section][key] = value;
                    this.showMessage('Setting updated successfully');
                } else {
                    this.showMessage('Failed to update setting: ' + data.error, 'error');
                }
            } catch (error) {
                this.showMessage('Network error occurred', 'error');
            }
        },

        async saveAllSettings() {
            try {
                const response = await fetch('/settings/api/system-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify(this.settings)
                });

                const data = await response.json();
                if (data.success) {
                    this.showMessage('All settings saved successfully');
                } else {
                    this.showMessage('Failed to save settings: ' + data.error, 'error');
                }
            } catch (error) {
                this.showMessage('Network error occurred', 'error');
            }
        },

        showMessage(message, type = 'success') {
            // Simple alert for now - could be enhanced with toast notifications
            alert(message);
        },

        getCSRFToken() {
            const tokenMeta = document.querySelector('meta[name=csrf-token]');
            return tokenMeta ? tokenMeta.getAttribute('content') : '';
        }
    };
}
</script>
{% endblock %}
