{% extends "layout.html" %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" x-data="settingsData()">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-cogs"></i> Settings</h2>
                    <p class="text-muted mb-0">Manage your preferences and system configuration</p>
                </div>
                {% if is_org_owner and current_user.organization.tier and not current_user.organization.tier.is_billing_exempt %}
                <a href="{{ url_for('organization.dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-crown"></i> Organization Dashboard
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Settings Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                <i class="fas fa-user"></i> Profile
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab">
                <i class="fas fa-sliders-h"></i> Preferences
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
                <i class="fas fa-palette"></i> Appearance
            </button>
        </li>
        {% if has_permission(current_user, 'settings.edit') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                <i class="fas fa-server"></i> System
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                <i class="fas fa-boxes"></i> Inventory
            </button>
        </li>
        {% if current_user.is_organization_owner or current_user.user_type == 'developer' or has_permission(current_user, 'organization.manage_billing') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                <i class="fas fa-credit-card"></i> Billing
            </button>
        </li>
        {% endif %}

    </ul>

    <!-- Settings Content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- Profile Tab -->
        <div class="tab-pane fade show active" id="profile" role="tabpanel">
            {% include 'settings/components/profile_tab.html' %}
        </div>

        <!-- Preferences Tab -->
        <div class="tab-pane fade" id="preferences" role="tabpanel">
            {% include 'settings/components/preferences_tab.html' %}
        </div>

        <!-- Appearance Tab -->
        <div class="tab-pane fade" id="appearance" role="tabpanel">
            {% include 'settings/components/appearance_tab.html' %}
        </div>

        <!-- System Tab -->
        {% if has_permission(current_user, 'settings.edit') %}
        <div class="tab-pane fade" id="system" role="tabpanel">
            {% include 'settings/components/system_tab.html' %}
        </div>
        {% endif %}

        <!-- Inventory Tab -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            {% include 'settings/components/inventory_tab.html' %}
        </div>

        <!-- Billing Tab -->
        {% if current_user.is_organization_owner or current_user.user_type == 'developer' or has_permission(current_user, 'organization.manage_billing') %}
        <div class="tab-pane fade" id="billing" role="tabpanel">
            {% include 'settings/components/billing_tab.html' %}
        </div>
        {% endif %}


    </div>
</div>

<style>
.upgrade-option {
    padding: 15px;
    border: 1px solid var(--color-border);
    border-radius: 5px;
    text-align: center;
    height: 100%;
}

.upgrade-option h6 {
    color: var(--color-text);
    font-weight: bold;
    margin-bottom: 10px;
}

.upgrade-option ul {
    text-align: left;
    margin-bottom: 15px;
}
</style>

<script>
function settingsData() {
    return {
        userPrefs: {{ user_prefs | tojson }},
        systemSettings: {{ system_settings | tojson }},
        organization: {{ ({
            'id': organization.id if organization else None,
            'name': organization.name if organization else '',
            'inventory_cost_method': organization.inventory_cost_method if organization else 'fifo'
        }) | tojson }},
        profile: {
            first_name: {{ (current_user.first_name or "") | tojson }},
            last_name: {{ (current_user.last_name or "") | tojson }},
            email: {{ (current_user.email or "") | tojson }},
            phone: {{ (current_user.phone or "") | tojson }},
            timezone: {{ (current_user.timezone or "America/New_York") | tojson }}
        },
        password: {
            current: '',
            new: '',
            confirm: ''
        },
        backupPassword: {
            new: '',
            confirm: ''
        },
        backupPasswordSet: false,
        saving: false,

        async saveProfile() {
            if (this.saving) return;
            
            try {
                this.saving = true;
                
                // Validate required fields
                if (!this.profile.first_name || !this.profile.last_name || !this.profile.email) {
                    this.showToast('Please fill in all required fields', 'error');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(this.profile.email)) {
                    this.showToast('Please enter a valid email address', 'error');
                    return;
                }

                const response = await fetch('/settings/profile/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify(this.profile)
                });

                const result = await response.json();
                
                if (result.success) {
                    this.showToast('Profile updated successfully', 'success');
                    // Update the profile data with server response if available
                    if (result.user) {
                        Object.assign(this.profile, result.user);
                    }
                } else {
                    this.showToast(result.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                this.showToast('Error updating profile: ' + error.message, 'error');
                console.error('Profile save error:', error);
            } finally {
                this.saving = false;
            }
        },

        async changePassword() {
            if (this.password.new !== this.password.confirm) {
                this.showToast('New passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch('/settings/password/change', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify(this.password)
                });

                const result = await response.json();
                if (result.success) {
                    this.showToast('Password changed successfully', 'success');
                    // Clear password fields
                    this.password = { current: '', new: '', confirm: '' };
                } else {
                    this.showToast(result.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                this.showToast('Error changing password', 'error');
                console.error('Error:', error);
            }
        },

        async setBackupPassword() {
            if (this.backupPassword.new !== this.backupPassword.confirm) {
                this.showToast('Passwords do not match', 'error');
                return;
            }

            if (this.backupPassword.new.length < 8) {
                this.showToast('Password must be at least 8 characters', 'error');
                return;
            }

            try {
                this.saving = true;
                
                const response = await fetch('/settings/set-backup-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify({
                        password: this.backupPassword.new,
                        confirm_password: this.backupPassword.confirm
                    })
                });

                const result = await response.json();
                if (result.success) {
                    this.showToast('Backup password set successfully!', 'success');
                    this.backupPassword = { new: '', confirm: '' };
                    this.backupPasswordSet = true;
                } else {
                    this.showToast(result.error || 'Failed to set backup password', 'error');
                }
            } catch (error) {
                this.showToast('Error setting backup password', 'error');
                console.error('Error:', error);
            } finally {
                this.saving = false;
            }
        },

        async updatePreference(key, value) {
            try {
                const response = await fetch('/settings/update-user-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify({ key, value })
                });

                const result = await response.json();
                if (result.success) {
                    // Reload page to show flash message
                    window.location.reload();
                } else {
                    this.showToast(result.error || 'Failed to save preference', 'error');
                }
            } catch (error) {
                this.showToast('Error saving preference', 'error');
                console.error('Error:', error);
            }
        },

        async updateSystemSetting(section, key, value) {
            try {
                const response = await fetch('/settings/update-system-setting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify({ section, key, value })
                });

                const result = await response.json();
                if (result.success) {
                    // Reload page to show flash message
                    window.location.reload();
                } else {
                    this.showToast(result.error || 'Failed to save setting', 'error');
                }
            } catch (error) {
                this.showToast('Error saving setting', 'error');
                console.error('Error:', error);
            }
        },

        async saveAllPreferences() {
            try {
                const response = await fetch('/settings/api/user-preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify(this.userPrefs)
                });

                const result = await response.json();
                if (result.success) {
                    // Reload page to show flash message
                    window.location.reload();
                } else {
                    this.showToast(result.error || 'Failed to save preferences', 'error');
                }
            } catch (error) {
                this.showToast('Error saving preferences', 'error');
                console.error('Error:', error);
            }
        },

        async saveOrgCostMethod(method) {
            try {
                const response = await fetch('/organization/update-settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify({ inventory_cost_method: method })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.organization.inventory_cost_method = method;
                    this.showToast('Cost method updated successfully', 'success');
                } else {
                    this.showToast(result.error || 'Failed to update cost method', 'error');
                }
            } catch (error) {
                this.showToast('Error updating cost method', 'error');
                console.error('Error:', error);
            }
        },

        showToast(message, type = 'info') {
            // Use Bootstrap toast or simple alert
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                // Create Bootstrap toast
                const toastElement = document.createElement('div');
                toastElement.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
                toastElement.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                document.body.appendChild(toastElement);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
                setTimeout(() => toastElement.remove(), 5000);
            } else {
                alert(message);
            }
        }
    }
}
</script>
{% endblock %}