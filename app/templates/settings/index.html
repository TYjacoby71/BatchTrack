{% extends "layout.html" %}

{% block content %}
<div class="container-fluid" x-data="settingsData()">
    <!-- Flash Messages -->
    <div x-show="showMessage" x-transition class="alert" :class="messageType === 'success' ? 'alert-success' : 'alert-danger'">
        <span x-text="message"></span>
        <button type="button" class="btn-close" @click="showMessage = false"></button>
    </div>
    <h2><i class="fas fa-cog"></i> System Settings</h2>
    <p class="text-muted">Configure BatchTrack to match your workflow and preferences</p>

    <!-- Success/Error Messages -->
    <div x-show="showMessage" 
         x-transition.opacity.duration.300ms
         :class="messageType === 'success' ? 'alert alert-success' : 'alert alert-danger'"
         class="alert alert-dismissible fade show position-fixed"
         style="top: 20px; right: 20px; z-index: 1050; display: none;">
        <span x-text="message"></span>
        <button type="button" class="btn-close" @click="showMessage = false"></button>
    </div>

    <!-- Organization Management Section (Only for Org Owners) -->
    {% if is_org_owner %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building text-primary"></i> Organization Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Organization Details</h6>
                            <div class="mb-3">
                                <label class="form-label">Organization Name</label>
                                <input type="text" class="form-control" value="{{ current_user.organization.name }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subscription Tier</label>
                                <input type="text" class="form-control" value="{{ current_user.organization.subscription_tier }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Active Users</label>
                                <input type="text" class="form-control" value="{{ current_user.organization.active_users_count }}" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>User Management</h6>
                            <a href="{{ url_for('settings.organization_management') }}" class="btn btn-primary">
                                <i class="fas fa-users"></i> Manage Users
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- User Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-primary"></i> User Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Profile Information</h6>

                            <!-- Timezone Settings -->
                            <form method="POST" action="{{ url_for('settings.update_timezone') }}" class="mb-3">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Timezone</label>
                                    <select name="timezone" id="timezone" class="form-select">
                                        {% for tz in available_timezones %}
                                        <option value="{{ tz }}" {% if tz == current_user.timezone %}selected{% endif %}>
                                            {{ tz }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">All timestamps will be displayed in your selected timezone</div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Update Timezone</button>
                            </form>
                        </div>

                        <div class="col-md-6">
                            <h6>Profile Actions</h6>
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" 
                                       value="{{ current_user.first_name or '' }}"
                                       @change="updateProfile('first_name', $event.target.value)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" 
                                       value="{{ current_user.last_name or '' }}"
                                       @change="updateProfile('last_name', $event.target.value)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" 
                                       value="{{ current_user.email or '' }}"
                                       @change="updateProfile('email', $event.target.value)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" 
                                       value="{{ current_user.phone or '' }}"
                                       @change="updateProfile('phone', $event.target.value)">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Account Information</h6>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <input type="text" class="form-control" value="{{ current_user.user_role.name if current_user.user_role else 'No Role Assigned' }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Member Since</label>
                                <input type="text" class="form-control" 
                                       value="{{ current_user.created_at.strftime('%Y-%m-%d') if current_user.created_at else 'N/A' }}" readonly>
                            </div>

                            <h6 class="mt-4">Password Management</h6>
                            <button type="button" class="btn btn-outline-primary" @click="showPasswordModal = true">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Alert Service Settings -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning"></i> Dashboard Alert Service
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Alert Preferences</h6>
                            <div class="mb-3">
                                <label for="max-dashboard-alerts" class="form-label">
                                    Maximum alerts on dashboard
                                </label>
                                <select class="form-select" id="max-dashboard-alerts" 
                                        x-model="userPrefs.max_dashboard_alerts" 
                                        @change="updateUserPreference('max_dashboard_alerts', $event.target.value)">
                                    <option value="1">1 alert (minimal)</option>
                                    <option value="2">2 alerts (focused)</option>
                                    <option value="3">3 alerts (balanced)</option>
                                    <option value="5">5 alerts (detailed)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="expiration-warning-days" class="form-label">Expiration warning (days ahead)</label>
                                <input type="number" class="form-control" id="expiration-warning-days" 
                                       x-model="userPrefs.expiration_warning_days"
                                       @change="updateUserPreference('expiration_warning_days', $event.target.value)"
                                       min="1" max="30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Alert Types</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-expiration-alerts" 
                                       x-model="userPrefs.show_expiration_alerts"
                                       @change="updateUserPreference('show_expiration_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-expiration-alerts">
                                    Expiration alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-timer-alerts" 
                                       x-model="userPrefs.show_timer_alerts"
                                       @change="updateUserPreference('show_timer_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-timer-alerts">
                                    Timer alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-low-stock-alerts" 
                                       x-model="userPrefs.show_low_stock_alerts"
                                       @change="updateUserPreference('show_low_stock_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-low-stock-alerts">
                                    Low stock alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-batch-alerts"
                                       x-model="userPrefs.show_batch_alerts"
                                       @change="updateUserPreference('show_batch_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-batch-alerts">
                                    Batch alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-fault-alerts" 
                                       x-model="userPrefs.show_fault_alerts"
                                       @change="updateUserPreference('show_fault_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-fault-alerts">
                                    System fault alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-alert-badges" 
                                       x-model="userPrefs.show_alert_badges"
                                       @change="updateUserPreference('show_alert_badges', $event.target.checked)">
                                <label class="form-check-label" for="show-alert-badges">
                                    Show alert badges in navigation
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Tools Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs text-primary"></i> Production Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Batch Management</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-timer-completion" 
                                       x-model="systemSettings.batch_rules.require_timer_completion"
                                       @change="updateSystemSetting('batch_rules', 'require_timer_completion', $event.target.checked)">
                                <label class="form-check-label" for="require-timer-completion">
                                    Require timer completion before finishing batch
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="allow-intermediate-tags"
                                       x-model="systemSettings.batch_rules.allow_intermediate_tags"
                                       @change="updateSystemSetting('batch_rules', 'allow_intermediate_tags', $event.target.checked)">
                                <label class="form-check-label" for="allow-intermediate-tags">
                                    Allow intermediate tags during batch
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-finish-confirmation"
                                       x-model="systemSettings.batch_rules.require_finish_confirmation"
                                       @change="updateSystemSetting('batch_rules', 'require_finish_confirmation', $event.target.checked)">
                                <label class="form-check-label" for="require-finish-confirmation">
                                    Require confirmation before finishing batch
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="stuck-batch-hours" class="form-label">Mark batches as stuck after (hours)</label>
                                <input type="number" class="form-control" id="stuck-batch-hours" 
                                       x-model="systemSettings.batch_rules.stuck_batch_hours"
                                       @change="updateSystemSetting('batch_rules', 'stuck_batch_hours', $event.target.value)"
                                       min="1" max="168">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Recipe & Planning</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-variations" 
                                       x-model="systemSettings.recipe_builder.enable_variations"
                                       @change="updateSystemSetting('recipe_builder', 'enable_variations', $event.target.checked)">
                                <label class="form-check-label" for="enable-variations">
                                    Enable recipe variations
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-containers" 
                                       x-model="systemSettings.recipe_builder.enable_containers"
                                       @change="updateSystemSetting('recipe_builder', 'enable_containers', $event.target.checked)">
                                <label class="form-check-label" for="enable-containers">
                                    Enable container management
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-scale-recipes"
                                       x-model="systemSettings.recipe_builder.auto_scale_recipes"
                                       @change="updateSystemSetting('recipe_builder', 'auto_scale_recipes', $event.target.checked)">
                                <label class="form-check-label" for="auto-scale-recipes">
                                    Auto-scale recipes based on inventory
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-cost-breakdown"
                                       x-model="systemSettings.recipe_builder.show_cost_breakdown"
                                       @change="updateSystemSetting('recipe_builder', 'show_cost_breakdown', $event.target.checked)">
                                <label class="form-check-label" for="show-cost-breakdown">
                                    Show cost breakdown in recipes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes text-success"></i> Inventory Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Tracking Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-fifo-tracking"
                                       x-model="systemSettings.inventory.enable_fifo_tracking"
                                       @change="updateSystemSetting('inventory', 'enable_fifo_tracking', $event.target.checked)">
                                <label class="form-check-label" for="enable-fifo-tracking">
                                    Enable FIFO (First In, First Out) tracking
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-expiration-dates"
                                       x-model="systemSettings.inventory.show_expiration_dates"
                                       @change="updateSystemSetting('inventory', 'show_expiration_dates', $event.target.checked)">
                                <label class="form-check-label" for="show-expiration-dates">
                                    Show expiration dates in inventory
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-calculate-costs"
                                       x-model="systemSettings.inventory.auto_calculate_costs"
                                       @change="updateSystemSetting('inventory', 'auto_calculate_costs', $event.target.checked)">
                                <label class="form-check-label" for="auto-calculate-costs">
                                    Auto-calculate ingredient costs
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-supplier-info"
                                       x-model="systemSettings.inventory.show_supplier_info"
                                       @change="updateSystemSetting('inventory', 'show_supplier_info', $event.target.checked)">
                                <label class="form-check-label" for="show-supplier-info">
                                    Show supplier information
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Advanced Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-barcode-scanning"
                                       x-model="systemSettings.inventory.enable_barcode_scanning"
                                       @change="updateSystemSetting('inventory', 'enable_barcode_scanning', $event.target.checked)">
                                <label class="form-check-label" for="enable-barcode-scanning">
                                    Enable barcode scanning
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-bulk-operations"
                                       x-model="systemSettings.inventory.enable_bulk_operations"
                                       @change="updateSystemSetting('inventory', 'enable_bulk_operations', $event.target.checked)">
                                <label class="form-check-label" for="enable-bulk-operations">
                                    Enable bulk inventory operations
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-bag text-info"></i> Product Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Product Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-product-variants"
                                       x-model="systemSettings.products.enable_variants"
                                       @change="updateSystemSetting('products', 'enable_variants', $event.target.checked)">
                                <label class="form-check-label" for="enable-product-variants">
                                    Enable product variants
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-profit-margins"
                                       x-model="systemSettings.products.show_profit_margins"
                                       @change="updateSystemSetting('products', 'show_profit_margins', $event.target.checked)">
                                <label class="form-check-label" for="show-profit-margins">
                                    Show profit margins
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="track-production-costs"
                                       x-model="systemSettings.products.track_production_costs"
                                       @change="updateSystemSetting('products', 'track_production_costs', $event.target.checked)">
                                <label class="form-check-label" for="track-production-costs">
                                    Track production costs
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Product Display</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-product-images"
                                       x-model="systemSettings.products.enable_product_images"
                                       @change="updateSystemSetting('products', 'enable_product_images', $event.target.checked)">
                                <label class="form-check-label" for="enable-product-images">
                                    Enable product images
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-generate-skus"
                                       x-model="systemSettings.products.auto_generate_skus"
                                       @change="updateSystemSetting('products', 'auto_generate_skus', $event.target.checked)">
                                <label class="form-check-label" for="auto-generate-skus">
                                    Auto-generate SKU codes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools text-secondary"></i> System Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Management</h6>
                            <div class="list-group mb-3">
                                <a href="{{ url_for('conversion_bp.manage_units') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ruler text-info"></i> Unit Management
                                </a>
                                <a href="{{ url_for('tags.manage_tags') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-tags text-success"></i> Tag Management
                                </a>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-backup"
                                       x-model="systemSettings.system.auto_backup"
                                       @change="updateSystemSetting('system', 'auto_backup', $event.target.checked)">
                                <label class="form-check-label" for="auto-backup">
                                    Enable automatic backups
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Display Preferences</h6>
                            <div class="mb-3">
                                <label for="items-per-page" class="form-label">Items per page</label>
                                <select class="form-select" id="items-per-page"
                                        x-model="systemSettings.system.per_page"
                                        @change="updateSystemSetting('system', 'per_page', $event.target.value)">
                                    <option value="10">10 items</option>
                                    <option value="20">20 items</option>
                                    <option value="25">25 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-csv-export"
                                       x-model="systemSettings.system.enable_csv_export"
                                       @change="updateSystemSetting('system', 'enable_csv_export', $event.target.checked)">
                                <label class="form-check-label" for="enable-csv-export">
                                    Enable CSV export functionality
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-save-forms"
                                       x-model="systemSettings.system.auto_save_forms"
                                       @change="updateSystemSetting('system', 'auto_save_forms', $event.target.checked)">
                                <label class="form-check-label" for="auto-save-forms">
                                    Auto-save form progress
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Preferences Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-cog text-primary"></i> User Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dashboard Layout</h6>
                            <div class="mb-3">
                                <label for="dashboard-layout" class="form-label">Default dashboard view</label>
                                <select class="form-select" id="dashboard-layout"
                                        x-model="userPrefs.dashboard_layout"
                                        @change="updateUserPreference('dashboard_layout', $event.target.value)">
                                    <option value="compact">Compact (minimal information)</option>
                                    <option value="standard">Standard (balanced view)</option>
                                    <option value="detailed">Detailed (all information)</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-quick-actions"
                                       x-model="userPrefs.show_quick_actions"
                                       @change="updateUserPreference('show_quick_actions', $event.target.checked)">
                                <label class="form-check-label" for="show-quick-actions">
                                    Show quick action buttons
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="compact-view"
                                       x-model="userPrefs.compact_view"
                                       @change="updateUserPreference('compact_view', $event.target.checked)">
                                <label class="form-check-label" for="compact-view">
                                    Use compact view layouts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-envelope text-warning"></i> Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Notification Types</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="browser-notifications"
                                       x-model="systemSettings.notifications.browser_notifications"
                                       @change="updateSystemSetting('notifications', 'browser_notifications', $event.target.checked)">
                                <label class="form-check-label" for="browser-notifications">
                                    Browser notifications
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="email-alerts"
                                       x-model="systemSettings.notifications.email_alerts"
                                       @change="updateSystemSetting('notifications', 'email_alerts', $event.target.checked)">
                                <label class="form-check-label" for="email-alerts">
                                    Email alerts
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="alert-frequency" class="form-label">Alert frequency</label>
                                <select class="form-select" id="alert-frequency"
                                        x-model="systemSettings.notifications.alert_frequency"
                                        @change="updateSystemSetting('notifications', 'alert_frequency', $event.target.value)">
                                    <option value="real_time">Real time</option>
                                    <option value="hourly">Hourly digest</option>
                                    <option value="daily">Daily digest</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Quiet Hours</h6>
                            <div class="mb-3">
                                <label for="quiet-hours-start" class="form-label">Quiet hours start</label>
                                <input type="time" class="form-control" id="quiet-hours-start"
                                       x-model="systemSettings.notifications.quiet_hours_start"
                                       @change="updateSystemSetting('notifications', 'quiet_hours_start', $event.target.value)">
                            </div>

                            <div class="mb-3">
                                <label for="quiet-hours-end" class="form-label">Quiet hours end</label>
                                <input type="time" class="form-control" id="quiet-hours-end"
                                       x-model="systemSettings.notifications.quiet_hours_end"
                                       @change="updateSystemSetting('notifications', 'quiet_hours_end', $event.target.value)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div class="modal fade" x-show="showPasswordModal" x-transition tabindex="-1" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" @click="showPasswordModal = false"></button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="changePassword()">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <small class="text-muted">Password must be at least 6 characters</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @click="showPasswordModal = false">Cancel</button>
                <button type="button" class="btn btn-primary" @click="changePassword()">Change Password</button>
            </div>
        </div>
    </div>
</div>

<script>
function settingsData() {
    return {
        // Initialize with default values to prevent undefined errors
        userPrefs: {
            max_dashboard_alerts: {{ current_user_prefs.max_dashboard_alerts if current_user_prefs else 3 }},
            expiration_warning_days: {{ current_user_prefs.expiration_warning_days if current_user_prefs else 7 }},
            show_expiration_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_expiration_alerts else 'false' }},
            show_timer_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_timer_alerts else 'false' }},
            show_low_stock_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_low_stock_alerts else 'false' }},
            show_batch_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_batch_alerts else 'false' }},
            show_fault_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_fault_alerts else 'false' }},
            show_alert_badges: {{ 'true' if current_user_prefs and current_user_prefs.show_alert_badges else 'false' }},
            dashboard_layout: '{{ current_user_prefs.dashboard_layout if current_user_prefs else "standard" }}',
            show_quick_actions: {{ 'true' if current_user_prefs and current_user_prefs.show_quick_actions else 'true' }},
            compact_view: {{ 'true' if current_user_prefs and current_user_prefs.compact_view else 'false' }}
        },
        systemSettings: {
            batch_rules: {
                require_timer_completion: false,
                allow_intermediate_tags: true,
                require_finish_confirmation: true,
                stuck_batch_hours: 24
            },
            recipe_builder: {
                enable_variations: true,
                enable_containers: true,
                auto_scale_recipes: false,
                show_cost_breakdown: true
            },
            inventory: {
                enable_fifo_tracking: true,
                show_expiration_dates: true,
                auto_calculate_costs: false,
                show_supplier_info: true,
                enable_barcode_scanning: false,
                enable_bulk_operations: true
            },
            products: {
                enable_variants: true,
                show_profit_margins: false,
                track_production_costs: true,
                enable_product_images: true,
                auto_generate_skus: false
            },
            system: {
                auto_backup: false,
                per_page: 20,
                enable_csv_export: true,
                auto_save_forms: true
            },
            notifications: {
                browser_notifications: false,
                email_alerts: false,
                alert_frequency: 'immediate',
                quiet_hours_start: '22:00',
                quiet_hours_end: '06:00'
            }
        },
        showPasswordModal: false,
        showMessage: false,
        message: '',
        messageType: 'success',
        settings: {
            // User Preferences with defaults
            max_dashboard_alerts: {{ current_user_prefs.max_dashboard_alerts if current_user_prefs else 3 }},
            expiration_warning_days: {{ current_user_prefs.expiration_warning_days if current_user_prefs else 7 }},
            show_expiration_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_expiration_alerts else 'false' }},
            show_timer_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_timer_alerts else 'false' }},
            show_low_stock_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_low_stock_alerts else 'false' }},
            show_batch_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_batch_alerts else 'false' }},
            show_fault_alerts: {{ 'true' if current_user_prefs and current_user_prefs.show_fault_alerts else 'false' }},
            show_alert_badges: {{ 'true' if current_user_prefs and current_user_prefs.show_alert_badges else 'false' }},
            dashboard_layout: '{{ current_user_prefs.dashboard_layout if current_user_prefs else "standard" }}',
            show_quick_actions: {{ 'true' if current_user_prefs and current_user_prefs.show_quick_actions else 'true' }}rrent_user_prefs.show_quick_actions else 'false' }},
            compact_view: {{ 'true' if current_user_prefs and current_user_prefs.compact_view else 'false' }}
        },

        // Methods
        updateProfile(field, value) {
            fetch('/settings/update-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccessMessage('Profile updated successfully');
                } else {
                    this.showErrorMessage(data.message || 'Failed to update profile');
                }
            })
            .catch(() => {
                this.showErrorMessage('Error updating profile');
            });
        },

        updateUserPreference(key, value) {
            this.userPrefs[key] = value;
            this.saveUserPreferences();
        },

        updateSystemSetting(group, key, value) {
            this.systemSettings[group][key] = value;
            this.saveSystemSettings();
        },

        changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                this.showErrorMessage('New passwords do not match.');
                return;
            }

            fetch('/settings/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccessMessage('Password changed successfully');
                    this.showPasswordModal = false;
                } else {
                    this.showErrorMessage(data.message || 'Failed to change password');
                }
            })
            .catch(() => {
                this.showErrorMessage('Error changing password');
            });
        },

        saveUserPreferences() {
            fetch('/settings/update-user-preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
                },
                body: JSON.stringify(this.userPrefs)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccessMessage('User preferences updated successfully');
                } else {
                    this.showErrorMessage(data.message || 'Failed to update preferences');
                }
            })
            .catch(() => {
                this.showErrorMessage('Error updating preferences');
            });
        },

        saveSystemSettings() {
            fetch('/settings/update-system-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
                },
                body: JSON.stringify(this.systemSettings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showSuccessMessage('System settings updated successfully');
                } else {
                    this.showErrorMessage(data.message || 'Failed to update settings');
                }
            })
            .catch(() => {
                this.showErrorMessage('Error updating settings');
            });
        },

        showSuccessMessage(msg) {
            this.message = msg;
            this.messageType = 'success';
            this.showMessage = true;
            setTimeout(() => { this.showMessage = false; }, 3000);
        },

        showErrorMessage(msg) {
            this.message = msg;
            this.messageType = 'danger';
            this.showMessage = true;
            setTimeout(() => { this.showMessage = false; }, 5000);
        }
    }
}
</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}