{#
Synopsis:
Primary shell template for authenticated app pages and public-layout pages.

Glossary:
- Theme bootstrap: Early script that resolves and applies the page theme before paint.
- Public header mode: Guest navigation variant enabled by `show_public_header`.
#}
{% from 'components/shared/feedback_note_modal.html' import render_feedback_note_widget %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
      {% set resolved_title = page_title or "BatchTrack ‚Äî Production & Inventory" %}
      {% set resolved_description = page_description or "BatchTrack unifies batching, inventory, and the global item library for makers." %}
      {% set resolved_canonical = canonical_url or request.base_url %}
      {% set resolved_og_image = page_og_image or url_for('static', filename='images/og/batchtrack-default-og.svg', _external=True) %}
      {% set use_public_header = use_public_header if use_public_header is defined else (show_public_header if show_public_header is defined else false) %}
      {% set public_shell_mode = use_public_header and not current_user.is_authenticated %}
      {% set customer_feedback_bubble_enabled = is_feature_enabled('FEATURE_CUSTOMER_FEEDBACK_BUBBLE') and not (current_user.is_authenticated and current_user.user_type == 'developer') %}
      {% set requested_lightweight_public_shell = lightweight_public_shell if lightweight_public_shell is defined else false %}
      {% set lightweight_public_shell = requested_lightweight_public_shell and public_shell_mode %}
      {% set load_analytics = (load_analytics if load_analytics is defined else true) if public_shell_mode else true %}
      {% set load_fontawesome = (load_fontawesome if load_fontawesome is defined else true) if public_shell_mode else true %}
      {% set load_feedback_widget = (load_feedback_widget if load_feedback_widget is defined else customer_feedback_bubble_enabled) if public_shell_mode else customer_feedback_bubble_enabled %}
      {% set ga_measurement_id = (config.get('GOOGLE_ANALYTICS_MEASUREMENT_ID') or '').strip() %}
      {% set posthog_api_key = (config.get('POSTHOG_PROJECT_API_KEY') or '').strip() %}
      {% set posthog_host = (config.get('POSTHOG_HOST') or 'https://us.i.posthog.com').rstrip('/') %}
      {% set posthog_capture_pageview = config.get('POSTHOG_CAPTURE_PAGEVIEW', true) %}
      {% set posthog_capture_pageleave = config.get('POSTHOG_CAPTURE_PAGELEAVE', true) %}
      {% if not load_analytics %}
      {% set ga_measurement_id = '' %}
      {% set posthog_api_key = '' %}
      {% endif %}
      <title>{{ resolved_title }}</title>
      <meta name="description" content="{{ resolved_description }}">
      <link rel="canonical" href="{{ resolved_canonical }}">
      <meta property="og:type" content="website">
      <meta property="og:title" content="{{ resolved_title }}">
      <meta property="og:description" content="{{ resolved_description }}">
      <meta property="og:url" content="{{ resolved_canonical }}">
      <meta property="og:image" content="{{ resolved_og_image }}">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="{{ resolved_title }}">
      <meta name="twitter:description" content="{{ resolved_description }}">
      <meta name="twitter:image" content="{{ resolved_og_image }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('core.branding_app_tile') }}">
    <link rel="shortcut icon" href="{{ url_for('core.branding_app_tile') }}">
    <link rel="apple-touch-icon" href="{{ url_for('core.branding_app_tile') }}">
    {% if lightweight_public_shell %}
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" as="style" crossorigin onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin>
    </noscript>
    {% else %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {% endif %}
    {% if load_fontawesome %}
    {% if lightweight_public_shell %}
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" as="style" crossorigin onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" crossorigin>
    </noscript>
    {% else %}
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    {% endif %}
    {% endif %}
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ static_asset('style.css') }}">
    <link rel="stylesheet" href="{{ static_asset('css/theme.css') }}">
    {% if not lightweight_public_shell %}
    <link rel="stylesheet" href="{{ static_asset('css/filter_panels.css') }}">
    {% endif %}
    {% if load_feedback_widget %}
    <link rel="stylesheet" href="{{ static_asset('css/tools/feedback_note_modal.css') }}">
    {% endif %}
    {% if posthog_api_key %}
    <link rel="preconnect" href="{{ posthog_host }}" crossorigin>
    <link rel="dns-prefetch" href="{{ posthog_host|replace('https://', '//')|replace('http://', '//') }}">
    {% endif %}
    <script>
      // Minimal theme bootstrap: scope localStorage per user + org.
      (function() {
        try {
          var userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
          var orgId = {{ get_effective_org_id() if current_user.is_authenticated else 'null' }};
          var userKey = userId ? String(userId) : 'guest';
          var orgKey = orgId ? String(orgId) : 'public';
          var prefix = 'bt:' + userKey + ':' + orgKey + ':';
          window.BT_STORAGE = {
            userId: userId,
            orgId: orgId,
            prefix: prefix,
            key: function(baseKey) { return prefix + baseKey; }
          };
          window.BT_LIST_PREFERENCES = {{ (list_preferences_payload if list_preferences_payload is defined else {}) | tojson }};

          var storageKey = window.BT_STORAGE.key('theme');
          var hasServerTheme = {{ 'true' if theme_preference_scoped else 'false' }};
          var serverTheme = {{ theme_preference | tojson if theme_preference_scoped else 'null' }};
          var forcePublicLightTheme = {{ 'true' if public_shell_mode else 'false' }};
          var theme = null;

          if (forcePublicLightTheme) {
            theme = 'light';
            localStorage.setItem(storageKey, theme);
          } else if (hasServerTheme && serverTheme) {
            theme = serverTheme;
            localStorage.setItem(storageKey, theme);
          } else {
            theme = localStorage.getItem(storageKey) || 'light';
            localStorage.setItem(storageKey, theme);
          }

          document.documentElement.setAttribute('data-theme', theme || 'light');
        } catch (e) {}
      })();
    </script>
    {% if not lightweight_public_shell %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% endif %}
    {% if ga_measurement_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_measurement_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', {{ ga_measurement_id | tojson }}, {
        anonymize_ip: true
      });
    </script>
    {% endif %}
    {% if posthog_api_key %}
    <script>
      !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2===o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people"},o="capture identify alias group set_config reset register register_once unregister people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user pageleave".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
      posthog.init({{ posthog_api_key | tojson }}, {
        api_host: {{ posthog_host | tojson }},
        capture_pageview: {{ posthog_capture_pageview | tojson }},
        capture_pageleave: {{ posthog_capture_pageleave | tojson }},
        person_profiles: "identified_only"
      });
    </script>
    {% endif %}
    {% if load_analytics %}
    <script>
      (function() {
        var FIRST_LANDING_STORAGE_KEY = 'bt:first_landing_at';
        var FIRST_LANDING_COOKIE_KEY = 'bt_first_landing_at';

        function nowMs() {
          return Date.now ? Date.now() : new Date().getTime();
        }

        function parseInteger(value) {
          if (value === null || value === undefined || value === '') {
            return null;
          }
          var parsed = Number.parseInt(String(value), 10);
          return Number.isFinite(parsed) ? parsed : null;
        }

        function getCookie(name) {
          var escaped = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          var match = document.cookie.match(new RegExp('(?:^|; )' + escaped + '=([^;]*)'));
          return match ? decodeURIComponent(match[1]) : null;
        }

        function setCookie(name, value) {
          try {
            document.cookie = name + '=' + encodeURIComponent(String(value)) + '; path=/; max-age=31536000; SameSite=Lax';
          } catch (error) {}
        }

        function resolveFirstLandingAt() {
          var fromStorage = null;
          try {
            fromStorage = parseInteger(window.localStorage && window.localStorage.getItem(FIRST_LANDING_STORAGE_KEY));
          } catch (error) {}
          var fromCookie = parseInteger(getCookie(FIRST_LANDING_COOKIE_KEY));
          var first = fromStorage || fromCookie;
          if (!first) {
            first = nowMs();
          }
          try {
            if (window.localStorage) {
              window.localStorage.setItem(FIRST_LANDING_STORAGE_KEY, String(first));
            }
          } catch (error) {}
          setCookie(FIRST_LANDING_COOKIE_KEY, String(first));
          return first;
        }

        function canCapture() {
          return Boolean(
            window.posthog &&
            typeof window.posthog.capture === 'function'
          );
        }

        var firstLandingAt = resolveFirstLandingAt();
        var firstLandingRecordedKey = 'bt:first_landing_recorded_sent';

        window.BTAnalytics = window.BTAnalytics || {};
        window.BTAnalytics.getFirstLandingAt = function() {
          return firstLandingAt;
        };
        window.BTAnalytics.secondsSinceFirstLanding = function() {
          var elapsedMs = Math.max(0, nowMs() - firstLandingAt);
          return Math.round(elapsedMs / 1000);
        };
        window.BTAnalytics.capture = function(eventName, properties) {
          if (!eventName || !canCapture()) {
            return;
          }
          var payload = Object.assign(
            {
              seconds_since_first_landing: window.BTAnalytics.secondsSinceFirstLanding(),
              page_path: window.location.pathname,
              page_url: window.location.href
            },
            properties || {}
          );
          try {
            window.posthog.capture(eventName, payload);
          } catch (error) {}
        };

        document.addEventListener('DOMContentLoaded', function() {
          var body = document.body || null;
          var isAuthenticated = body ? body.getAttribute('data-authenticated') === 'true' : false;
          var userId = body ? body.getAttribute('data-user-id') : '';
          var orgId = body ? body.getAttribute('data-org-id') : '';
          var endpoint = body ? body.getAttribute('data-page-endpoint') : '';

          if (canCapture() && isAuthenticated && userId) {
            try {
              window.posthog.identify(String(userId), {
                organization_id: orgId || null,
                authenticated: true
              });
              if (orgId && typeof window.posthog.group === 'function') {
                window.posthog.group('organization', String(orgId));
              }
            } catch (error) {}
          }

          try {
            if (canCapture() && window.localStorage && !window.localStorage.getItem(firstLandingRecordedKey)) {
              window.BTAnalytics.capture('first_landing_recorded', {
                first_landing_at_ms: firstLandingAt
              });
              window.localStorage.setItem(firstLandingRecordedKey, '1');
            }
          } catch (error) {}

          window.BTAnalytics.capture('page_context_viewed', {
            page_endpoint: endpoint || '',
            authenticated: isAuthenticated
          });

          var pageEnteredAt = nowMs();
          var dwellSent = false;
          var sendDwell = function() {
            if (dwellSent) {
              return;
            }
            dwellSent = true;
            var dwellSeconds = Math.max(0, Math.round((nowMs() - pageEnteredAt) / 1000));
            window.BTAnalytics.capture('page_dwell_recorded', {
              page_endpoint: endpoint || '',
              seconds_on_page: dwellSeconds,
              authenticated: isAuthenticated
            });
          };
          window.addEventListener('pagehide', sendDwell, { once: true });
          document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
              sendDwell();
            }
          });

          document.addEventListener('click', function(event) {
            var anchor = event.target && event.target.closest ? event.target.closest('a[href]') : null;
            if (!anchor) {
              return;
            }
            var href = anchor.getAttribute('href') || '';
            if (!href || href.startsWith('#')) {
              return;
            }
            var url;
            try {
              url = new URL(href, window.location.origin);
            } catch (error) {
              return;
            }
            var path = url.pathname || '';
            if (path.includes('/auth/signup')) {
              window.BTAnalytics.capture('public_signup_cta_clicked', {
                cta_text: (anchor.textContent || '').trim().slice(0, 120),
                signup_source: url.searchParams.get('source') || null,
                destination_path: path
              });
            } else if (path.includes('/auth/login')) {
              window.BTAnalytics.capture('public_login_cta_clicked', {
                cta_text: (anchor.textContent || '').trim().slice(0, 120),
                destination_path: path
              });
            } else if (path === '/pricing') {
              window.BTAnalytics.capture('public_pricing_clicked', {
                cta_text: (anchor.textContent || '').trim().slice(0, 120)
              });
            }
          });
        });
      })();
    </script>
    {% endif %}
    {% block head %}{% endblock %}
    <style>
        input[type="hidden"][name="csrf_token"],
        input[type="hidden"][name="confirm_token"],
        .csrf-token,
        .confirm-token,
        .token-field,
        .csrf_token {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            pointer-events: none !important;
            overflow: hidden !important;
            clip: rect(0,0,0,0) !important;
            border: 0 !important;
            margin: -1px !important;
            padding: 0 !important;
        }
        .bot-trap-link,
        .bot-trap-field {
            display: block !important;
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            overflow: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            clip: rect(0,0,0,0) !important;
            border: 0 !important;
            margin: -1px !important;
            padding: 0 !important;
        }
        .app-container {
            max-width: 1200px; /* Adjust as needed */
            margin: 0 auto;
        }
        .app-container.public-shell {
            max-width: none;
            width: 100%;
            background: transparent;
            box-shadow: none;
            border-radius: 0;
            min-height: auto;
        }
        .public-marketing-nav {
            border-bottom: 1px solid #e9ecef;
        }
        .public-marketing-nav .navbar-brand {
            padding-top: 0;
            padding-bottom: 0;
        }
        .public-marketing-nav .brand-full-logo {
            height: 42px;
            width: 210px;
            aspect-ratio: 5 / 1;
            display: block;
        }
        .app-brand-logo {
            height: 42px;
            width: auto;
            display: block;
        }
        .public-marketing-nav .navbar-nav .nav-link {
            color: #6c757d !important;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .public-marketing-nav .navbar-nav .nav-link:hover {
            color: #0d6efd !important;
        }
        .public-marketing-nav .btn-cta {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border: none;
            border-radius: 999px;
            padding: 0.45rem 1.1rem;
            font-weight: 700;
            color: #ffffff !important;
            box-shadow: 0 6px 16px rgba(255, 165, 0, 0.28);
        }
        .public-marketing-nav .btn-cta:hover {
            filter: brightness(0.95);
            color: #ffffff !important;
        }
        .site-footer-legal {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.35rem;
        }
        .site-footer-legal-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            text-decoration: none;
        }
        .site-footer-legal-link:hover,
        .site-footer-legal-link:focus-visible {
            text-decoration: underline;
        }
    </style>
</head>
<body data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}"
      data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}"
      data-org-id="{{ get_effective_org_id() if current_user.is_authenticated else '' }}"
      data-page-endpoint="{{ request.endpoint or '' }}">
    <script>
        window.__IS_AUTHENTICATED__ = {{ 'true' if current_user.is_authenticated else 'false' }};
    </script>
    <div class="app-container{% if public_shell_mode %} public-shell{% endif %}">
    <nav class="navbar navbar-expand-lg {% if public_shell_mode %}public-marketing-nav navbar-light bg-white shadow-sm{% else %}navbar-light bg-light{% endif %}">
        <div class="{% if public_shell_mode %}container{% else %}container-fluid{% endif %} position-relative">
            {% if not public_shell_mode %}
            <a class="navbar-brand" href="{% if current_user.is_authenticated %}{% if current_user.user_type == 'developer' %}{{ url_for('developer.dashboard') }}{% else %}{{ url_for('app_routes.dashboard') }}{% endif %}{% else %}{{ url_for('core.index') }}{% endif %}" aria-label="BatchTrack home">
                <img src="{{ url_for('core.branding_full_logo_header') }}" alt="BatchTrack" class="app-brand-logo">
            </a>
            {% endif %}
            {% set marketplace_display_enabled = is_feature_enabled('FEATURE_RECIPE_MARKETPLACE_DISPLAY') %}
            {% set recipe_library_nav_enabled = is_feature_enabled('FEATURE_RECIPE_LIBRARY_NAV') and marketplace_display_enabled %}
            {% set global_library_enabled = is_feature_enabled('FEATURE_GLOBAL_ITEM_LIBRARY') or (current_user.is_authenticated and current_user.user_type == 'developer') %}
            {% set bulk_stock_check_enabled = is_feature_enabled('FEATURE_BULK_STOCK_CHECK') %}
            {% set bulk_inventory_updates_enabled = is_feature_enabled('FEATURE_BULK_INVENTORY_UPDATES') %}
            {% set show_recipe_library_link = (recipe_library_nav_enabled or (current_user.is_authenticated and current_user.user_type == 'developer')) and marketplace_display_enabled %}
            {% set customer_can_view_inventory = current_user.is_authenticated and has_permission(current_user, 'inventory.view') %}
            {% set customer_can_view_recipes = current_user.is_authenticated and has_permission(current_user, 'recipes.view') %}
            {% set customer_can_view_batches = current_user.is_authenticated and has_permission(current_user, 'batches.view') %}
            {% set customer_can_view_products = current_user.is_authenticated and has_permission(current_user, 'products.view') %}
            {% set tier_can_view_products = current_user.is_authenticated and has_tier_permission('products.view') %}
            {% set tier_can_adjust_inventory = current_user.is_authenticated and has_tier_permission('inventory.adjust') %}
            {% set recipes_ingredients_tier_nav = current_user.is_authenticated and current_user.user_type != 'developer' and has_tier_permission('recipes.view') and has_tier_permission('batches.finish') and not tier_can_view_products %}
            {% set has_nav_center = (navbar_center_title is defined and navbar_center_title) and not public_shell_mode %}
            {% if has_nav_center %}
            <div class="position-absolute top-50 start-50 translate-middle text-center">
                <span class="navbar-text fw-semibold">{{ navbar_center_title }}</span>
            </div>
            {% endif %}
            {% if current_user.is_authenticated %}
            {% if current_user.user_type == 'developer' %}
            <!-- Developer Navigation -->
            <div class="navbar-nav me-auto">
                <span class="navbar-text text-danger">
                    <i class="fas fa-shield-alt"></i> Developer Mode
                    {% if session.get('dev_selected_org_id') %}
                    {% set selected_org = get_organization_by_id(session.get('dev_selected_org_id')) %}
                    <small class="text-primary">| Viewing as Org Owner ({{ selected_org.get_tier_display_name() if selected_org else 'No Org' }})</small>
                    <a href="{{ url_for('developer.clear_organization_filter') }}" class="btn btn-sm btn-outline-secondary ms-2">
                        <i class="fas fa-times"></i> Clear Filter
                    </a>
                    {% endif %}
                </span>
            </div>
            <!-- Show both menus when developer is viewing an organization -->
            {% if session.get('dev_selected_org_id') %}
            {% if not has_nav_center %}
            <ul class="navbar-nav mx-auto d-none d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
            </ul>
            {% endif %}
            <div class="dropdown me-2">
                <button class="btn btn-light dropdown-toggle" type="button" id="customerDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user"></i> Customer Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="customerDropdown">
                    <!-- User Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Core Features -->
                    <li><h6 class="dropdown-header">Core Features</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Production Tools -->
                    <li><h6 class="dropdown-header">Production Tools</h6></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                            üßÆ Converter
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                            Expiration
                            <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                        </a>
                    </li>
                    <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                    {% if bulk_stock_check_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                    {% endif %}
                    {% if bulk_inventory_updates_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- Resources -->
                    <li><h6 class="dropdown-header">Resources</h6></li>
                    {% if global_library_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                    {% endif %}
                    {% if show_recipe_library_link %}
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Admin -->
                    <li><h6 class="dropdown-header">Admin</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
            {% endif %}
            <!-- Developer Menu (always available) -->
            <div class="dropdown ms-auto">
                <button class="btn btn-danger dropdown-toggle" type="button" id="devDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-code"></i> Developer Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="devDropdown">
                    <!-- Developer Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('developer.dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i> Developer Dashboard
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Organization Management -->
                    <li><h6 class="dropdown-header">Organization Management</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.create_organization') }}">
                        <i class="fas fa-plus"></i> Create Organization
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                        <i class="fas fa-building"></i> All Organizations
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.users') }}">
                        <i class="fas fa-users"></i> User Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_roles.manage_system_roles') }}">
                        <i class="fas fa-user-shield"></i> Role Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.manage_permissions') }}">
                        <i class="fas fa-key"></i> Permissions
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Global Library -->
                    <li><h6 class="dropdown-header">Global Library</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.global_items_admin') }}">
                        <i class="fas fa-boxes"></i> Global Items
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">
                        <i class="fas fa-book-open"></i> Recipe Library
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.product_categories') }}">
                        <i class="fas fa-tags"></i> Product Categories
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.reference_categories') }}">
                        <i class="fas fa-leaf"></i> Ingredient Categories
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.container_management') }}">
                        <i class="fas fa-box-open"></i> Container Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.manage_ingredient_attributes') }}">
                        <i class="fas fa-layer-group"></i> Physical Forms
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Analytics -->
                    <li><h6 class="dropdown-header">Analytics</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.analytics_catalog') }}">
                        <i class="fas fa-database"></i> Analytics Catalog
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.inventory_analytics_stub') }}">
                        <i class="fas fa-chart-line"></i> Inventory Analytics
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_statistics') }}">
                        <i class="fas fa-chart-bar"></i> System Statistics
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- AI & Automation -->
                    <li><h6 class="dropdown-header">AI & Automation</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.batchley_overview') }}">
                        <i class="fas fa-robot"></i> Batchley
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Billing -->
                    <li><h6 class="dropdown-header">Billing</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.subscription_tiers.manage_tiers') }}">
                        <i class="fas fa-layer-group text-primary"></i> Tier Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.addons.list_addons') }}">
                        <i class="fas fa-puzzle-piece"></i> Add-ons
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.billing_integration') }}">
                        <i class="fas fa-credit-card"></i> Billing Integration
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Marketing -->
                    <li><h6 class="dropdown-header">Marketing</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.marketing_admin') }}">
                        <i class="fas fa-bullhorn"></i> Marketing Admin
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.waitlist_statistics') }}">
                        <i class="fas fa-envelope"></i> Waitlist
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Customer Support -->
                    <li><h6 class="dropdown-header">Customer Support</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                        <i class="fas fa-headset"></i> Customer Support
                        {% if session.get('dev_selected_org_id') %}
                        <span class="badge bg-primary ms-1">Active</span>
                        {% endif %}
                    </a></li>
                    {% if session.get('dev_selected_org_id') %}
                    <li><a class="dropdown-item" href="{{ url_for('developer.clear_organization_filter') }}">
                        <i class="fas fa-times"></i> Clear Customer Filter
                    </a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- System -->
                    <li><h6 class="dropdown-header">System</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_settings') }}">
                        <i class="fas fa-cogs"></i> System Settings
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.integrations_checklist') }}">
                        <i class="fas fa-plug"></i> Integrations & Launch
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.feature_flags') }}">
                        <i class="fas fa-toggle-on"></i> Feature Flags
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a></li>
                </ul>
            </div>
            {% else %}
            <!-- Customer Navigation -->
            <div class="navbar-nav me-auto">
            </div>
            {% if not has_nav_center %}
            <ul class="navbar-nav mx-auto d-none d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools">
                        üîß Tools
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('help_routes.help_overview') }}">
                        ‚ùì Help
                    </a>
                </li>
                <li class="nav-item">
                    <div class="navbar-text">
                        <span id="header-clock" class="text-muted">üïê Loading...</span>
                    </div>
                </li>
            </ul>
            {% endif %}
            <div class="dropdown ms-auto">
                <button class="btn btn-light dropdown-toggle" type="button" id="directoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="directoryDropdown">
                    {% if not recipes_ingredients_tier_nav %}
                    <!-- User Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                    <li><hr class="dropdown-divider"></li>
                    {% endif %}
                    <!-- Core Features -->
                    <li><h6 class="dropdown-header">Core Features</h6></li>
                    {% if customer_can_view_inventory and (not recipes_ingredients_tier_nav or tier_can_adjust_inventory) %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                    {% elif recipes_ingredients_tier_nav %}
                    <li>
                        <button type="button"
                                class="dropdown-item d-flex justify-content-between align-items-center feature-locked-trigger"
                                data-bs-toggle="modal"
                                data-bs-target="#featureUpgradeModal"
                                data-feature-name="Inventory"
                                data-feature-description="Inventory management is available on upgraded plans.">
                            Inventory
                            <span class="badge bg-warning text-dark"><i class="fas fa-lock me-1"></i>Upgrade</span>
                        </button>
                    </li>
                    {% endif %}
                    {% if customer_can_view_recipes %}
                    <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                    {% endif %}
                    {% if customer_can_view_batches %}
                    <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                    {% endif %}
                    {% if customer_can_view_products %}
                    <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                    {% elif recipes_ingredients_tier_nav %}
                    <li>
                        <button type="button"
                                class="dropdown-item d-flex justify-content-between align-items-center feature-locked-trigger"
                                data-bs-toggle="modal"
                                data-bs-target="#featureUpgradeModal"
                                data-feature-name="Products"
                                data-feature-description="Product catalog and SKU outputs are available on upgraded plans.">
                            Products
                            <span class="badge bg-warning text-dark"><i class="fas fa-lock me-1"></i>Upgrade</span>
                        </button>
                    </li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    {% if recipes_ingredients_tier_nav %}
                    <!-- Free Tools -->
                    <li><h6 class="dropdown-header">Free Tools</h6></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                            üßÆ Converter
                        </a>
                    </li>
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Settings -->
                    <li><h6 class="dropdown-header">Settings</h6></li>
                    {% if current_user.is_authenticated %}
                    <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                    {% endif %}
                    {% else %}
                    <!-- Production Tools -->
                    <li><h6 class="dropdown-header">Production Tools</h6></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                            üßÆ Converter
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                            Expiration
                            <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                        </a>
                    </li>
                    {% if customer_can_view_batches %}
                    <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                    {% endif %}
                    {% if has_role('developer') or has_role('organization_owner') or has_permission(current_user, 'organization.manage') %}
                    <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                    {% endif %}
                    {% if customer_can_view_products and bulk_stock_check_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'inventory.edit') and bulk_inventory_updates_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- Resources -->
                    <li><h6 class="dropdown-header">Resources</h6></li>
                    {% if global_library_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                    {% endif %}
                    {% if show_recipe_library_link %}
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Admin -->
                    <li><h6 class="dropdown-header">Admin</h6></li>
                    {% if current_user.is_authenticated and has_permission(current_user, 'organization.view') %}
                    {% if current_user.user_type != 'developer' or session.get('dev_selected_org_id') %}
                    <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                    {% endif %}
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                    {% endif %}
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
            {% endif %}
            {% else %}
            {% if use_public_header %}
            {% set public_header_is_homepage = public_header_is_homepage if public_header_is_homepage is defined else false %}
            {% set public_header_signup_source = public_header_signup_source if public_header_signup_source is defined else 'public_header' %}
            {% include 'components/shared/public_marketing_header.html' %}
            {% else %}
            <div class="navbar-nav me-auto"></div>
            <div class="dropdown ms-auto">
                <button class="btn btn-light dropdown-toggle" type="button" id="publicMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="publicMenuDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('auth.signup') }}">Sign up</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Sign in</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    {% if global_library_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Library</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                </ul>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </nav>
    <main class="container-xl mt-4">
        <div class="section-spacing">
            {% if breadcrumb_items is defined and breadcrumb_items %}
            {% set breadcrumb_ns = namespace(last_url=None) %}
            {% for crumb in breadcrumb_items %}
                {% if crumb.url %}
                    {% set breadcrumb_ns.last_url = crumb.url %}
                {% endif %}
            {% endfor %}
            {% set resolved_breadcrumb_back_url = breadcrumb_back_url if breadcrumb_back_url is defined and breadcrumb_back_url else breadcrumb_ns.last_url %}
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                <nav aria-label="breadcrumb" class="mb-0">
                    <ol class="breadcrumb mb-0">
                        {% for crumb in breadcrumb_items %}
                            {% if crumb.url %}
                            <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.label }}</a></li>
                            {% else %}
                            <li class="breadcrumb-item active">{{ crumb.label }}</li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </nav>
                {% if resolved_breadcrumb_back_url %}
                <a href="{{ resolved_breadcrumb_back_url }}"
                   class="{{ breadcrumb_back_class if breadcrumb_back_class is defined and breadcrumb_back_class else 'btn btn-outline-secondary btn-sm' }}">
                    <i class="fas fa-arrow-left me-1"></i>{{ breadcrumb_back_label if breadcrumb_back_label is defined and breadcrumb_back_label else 'Back' }}
                </a>
                {% endif %}
            </div>
            {% endif %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% set hide_authenticated_generic_resend = current_user.is_authenticated and message == 'If an account with that email exists and is unverified, a verification email has been sent.' %}
                        {% if not hide_authenticated_generic_resend %}
                        {% set alert_class = 'info' %}
                        {% if category in ['error', 'danger'] %}
                            {% set alert_class = 'danger' %}
                        {% elif category == 'warning' %}
                            {% set alert_class = 'warning' %}
                        {% elif category == 'success' %}
                            {% set alert_class = 'success' %}
                        {% endif %}
                        <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% if current_user.is_authenticated and current_user.user_type != 'developer' and current_user.email and not current_user.email_verified %}
            <div class="alert alert-warning d-flex flex-wrap align-items-center justify-content-between gap-2" role="alert">
                <div>
                    <strong>Email verification needed.</strong>
                    Request a fresh verification email now if you did not receive the original link.
                </div>
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <form method="post" action="{{ url_for('auth.resend_verification') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="email" value="{{ current_user.email }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="btn btn-sm btn-warning">Resend verification email</button>
                    </form>
                    <a href="{{ url_for('settings.index') }}" class="btn btn-sm btn-outline-secondary py-1 px-2">Open settings</a>
                </div>
            </div>
            {% endif %}
            {% set verification_required_modal = session.pop('verification_required_modal', None) %}
            {% set TimezoneUtils = TimezoneUtils_global() %}
            {% block content %}{% endblock %}
        </div>
    </main>
    {% if not lightweight_public_shell %}
    {% include 'components/shared/unit_converter_modal.html' %}
    <div class="modal fade" id="featureUpgradeModal" tabindex="-1" aria-labelledby="featureUpgradeModalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featureUpgradeModalTitle">Upgrade required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="featureUpgradeModalBody" class="mb-0">
                        This feature is locked on your current plan.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="{{ url_for('billing.upgrade') }}" class="btn btn-primary">View upgrade options</a>
                </div>
            </div>
        </div>
    </div>
    {% if verification_required_modal %}
    <div class="modal fade" id="verificationRequiredModal" tabindex="-1" aria-labelledby="verificationRequiredModalTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="verificationRequiredModalTitle">Please verify your email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if verification_required_modal.sent %}
                    <p class="mb-0">
                        We sent a new verification email to <strong>{{ verification_required_modal.email }}</strong>.
                        Your account is {{ verification_required_modal.age_days }} days old and has passed the
                        {{ verification_required_modal.grace_days }}-day verification window. Please verify your email now.
                    </p>
                    {% else %}
                    <p class="mb-0">
                        Your account is {{ verification_required_modal.age_days }} days old and must be verified.
                        We could not send a verification email automatically. Click resend below after checking provider settings.
                    </p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('settings.index') }}" class="btn btn-outline-secondary">Open settings</a>
                    <form method="post" action="{{ url_for('auth.resend_verification') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="email" value="{{ verification_required_modal.email }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="btn btn-primary">Resend verification email</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if load_feedback_widget %}
    {{ render_feedback_note_widget(
      modal_id='globalFeedbackNoteModal',
      default_source=request.endpoint or request.path,
      source_options=None,
      lock_source_to_location=True,
      location_label=request.path,
      trigger_mode='floating',
      trigger_text='Feedback',
      title='Send feedback',
      subtitle='Question, missing feature, glitch, or bad preset data.',
      endpoint=url_for('tools_bp.tools_feedback_notes'),
      context=request.endpoint or request.path,
      default_flow='question',
      floating_bottom_offset='1.25rem'
    ) }}
    {% endif %}
    {% endif %}
    {% if not current_user.is_authenticated %}
    <a class="bot-trap-link" href="{{ url_for('public_api.public_bot_trap', source='layout') }}" rel="nofollow" aria-hidden="true" tabindex="-1">Continue</a>
    {% endif %}
    </div>
    <footer class="bg-light text-center text-muted py-3 mt-5">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <small class="d-block site-footer-copy">
                            &copy; {{ TimezoneUtils.utc_now().year }} BatchTrack. All rights reserved.
                        </small>
                        <nav class="site-footer-legal mt-1" aria-label="Legal">
                            <a href="{{ url_for('legal.privacy_policy') }}" class="text-muted site-footer-legal-link">Privacy Policy</a>
                            <a href="{{ url_for('legal.terms_of_service') }}" class="text-muted site-footer-legal-link">Terms of Service</a>
                            <a href="{{ url_for('legal.cookie_policy') }}" class="text-muted site-footer-legal-link">Cookie Policy</a>
                        </nav>
                    </div>
                </div>
            </div>
        </footer>
    {% if lightweight_public_shell %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% else %}
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom scripts - Load SessionGuard before other modules -->
    <script type="module" src="{{ static_asset('js/core/SessionGuard.js') }}"></script>
    <!-- Load DrawerProtocol and CacheManager before DrawerInterceptor as modules -->
    <script type="module" src="{{ static_asset('js/core/DrawerProtocol.js') }}"></script>
    <script type="module" src="{{ static_asset('js/core/DrawerInterceptor.js') }}"></script>
    <script type="module" src="{{ static_asset('js/main.js') }}"></script>
    <script src="{{ static_asset('js/utils/utils.js') }}"></script>
    <script src="{{ static_asset('js/list_preferences.js') }}"></script>
    <script src="{{ static_asset('js/inventory/inventory_adjust.js') }}"></script>
    <script src="{{ static_asset('js/conversion/unit_converter.js') }}"></script>
    <script type="module" src="{{ static_asset('js/drawers/drawer_cadence.js') }}"></script>
    <script src="{{ static_asset('js/drawers/container_unit_mismatch_drawer.js') }}"></script>
    {% if load_feedback_widget %}
    <script src="{{ static_asset('js/components/feedback_note_modal.js') }}"></script>
    {% endif %}
    {% endif %}
{% block scripts %}{% endblock %}
    {% if not lightweight_public_shell %}
    <script src="{{ static_asset('js/expiration_alerts.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const upgradeModal = document.getElementById('featureUpgradeModal');
            if (!upgradeModal) {
                const verificationRequiredModal = document.getElementById('verificationRequiredModal');
                if (verificationRequiredModal && typeof bootstrap !== 'undefined') {
                    new bootstrap.Modal(verificationRequiredModal).show();
                }
                return;
            }

            upgradeModal.addEventListener('show.bs.modal', function (event) {
                const trigger = event.relatedTarget;
                const featureName = trigger ? trigger.getAttribute('data-feature-name') : null;
                const featureDescription = trigger ? trigger.getAttribute('data-feature-description') : null;

                const modalTitle = document.getElementById('featureUpgradeModalTitle');
                const modalBody = document.getElementById('featureUpgradeModalBody');

                if (modalTitle) {
                    modalTitle.textContent = (featureName || 'Feature') + ' requires an upgrade';
                }
                if (modalBody) {
                    modalBody.textContent = featureDescription || 'This feature is locked on your current plan.';
                }
            });

            const verificationRequiredModal = document.getElementById('verificationRequiredModal');
            if (verificationRequiredModal && typeof bootstrap !== 'undefined') {
                new bootstrap.Modal(verificationRequiredModal).show();
            }
        });
    </script>

    <!-- Simple browser clock script -->
    <script>
        function updateClock() {
            const clockElement = document.getElementById('header-clock');
            if (clockElement) {
                const now = new Date();
                clockElement.textContent = `üïê ${now.toLocaleTimeString()}`;
            }
        }
        // Update clock every second and start immediately
        setInterval(updateClock, 1000);
        updateClock();
    </script>
    {% endif %}

    </body>
</html>
