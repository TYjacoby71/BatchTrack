{#
Synopsis:
Primary shell template for authenticated app pages and public-layout pages.

Glossary:
- Theme bootstrap: Early script that resolves and applies the page theme before paint.
- Public header mode: Guest navigation variant enabled by `show_public_header`.
#}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
      {% set resolved_title = page_title or "BatchTrack ‚Äî Production & Inventory" %}
      {% set resolved_description = page_description or "BatchTrack unifies batching, inventory, and the global item library for makers." %}
      {% set resolved_canonical = canonical_url or request.base_url %}
      {% set resolved_og_image = page_og_image or url_for('static', filename='images/og/batchtrack-default-og.svg', _external=True) %}
      {% set use_public_header = use_public_header if use_public_header is defined else (show_public_header if show_public_header is defined else false) %}
      {% set public_shell_mode = use_public_header and not current_user.is_authenticated %}
      <title>{{ resolved_title }}</title>
      <meta name="description" content="{{ resolved_description }}">
      <link rel="canonical" href="{{ resolved_canonical }}">
      <meta property="og:type" content="website">
      <meta property="og:title" content="{{ resolved_title }}">
      <meta property="og:description" content="{{ resolved_description }}">
      <meta property="og:url" content="{{ resolved_canonical }}">
      <meta property="og:image" content="{{ resolved_og_image }}">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="{{ resolved_title }}">
      <meta name="twitter:description" content="{{ resolved_description }}">
      <meta name="twitter:image" content="{{ resolved_og_image }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('branding_app_tile') }}">
    <link rel="shortcut icon" href="{{ url_for('branding_app_tile') }}">
    <link rel="apple-touch-icon" href="{{ url_for('branding_app_tile') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <script>
      // Minimal theme bootstrap: scope localStorage per user + org.
      (function() {
        try {
          var userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
          var orgId = {{ get_effective_org_id() if current_user.is_authenticated else 'null' }};
          var userKey = userId ? String(userId) : 'guest';
          var orgKey = orgId ? String(orgId) : 'public';
          var prefix = 'bt:' + userKey + ':' + orgKey + ':';
          window.BT_STORAGE = {
            userId: userId,
            orgId: orgId,
            prefix: prefix,
            key: function(baseKey) { return prefix + baseKey; }
          };

          var storageKey = window.BT_STORAGE.key('theme');
          var hasServerTheme = {{ 'true' if theme_preference_scoped else 'false' }};
          var serverTheme = {{ theme_preference | tojson if theme_preference_scoped else 'null' }};
          var forcePublicLightTheme = {{ 'true' if public_shell_mode else 'false' }};
          var theme = null;

          if (forcePublicLightTheme) {
            theme = 'light';
            localStorage.setItem(storageKey, theme);
          } else if (hasServerTheme && serverTheme) {
            theme = serverTheme;
            localStorage.setItem(storageKey, theme);
          } else {
            theme = localStorage.getItem(storageKey) || 'light';
            localStorage.setItem(storageKey, theme);
          }

          document.documentElement.setAttribute('data-theme', theme || 'light');
        } catch (e) {}
      })();
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% block head %}{% endblock %}
    <style>
        input[type="hidden"][name="csrf_token"],
        input[type="hidden"][name="confirm_token"],
        .csrf-token,
        .confirm-token,
        .token-field,
        .csrf_token {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            pointer-events: none !important;
            overflow: hidden !important;
            clip: rect(0,0,0,0) !important;
            border: 0 !important;
            margin: -1px !important;
            padding: 0 !important;
        }
        .bot-trap-link,
        .bot-trap-field {
            display: block !important;
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            overflow: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            clip: rect(0,0,0,0) !important;
            border: 0 !important;
            margin: -1px !important;
            padding: 0 !important;
        }
        .app-container {
            max-width: 1200px; /* Adjust as needed */
            margin: 0 auto;
        }
        .app-container.public-shell {
            max-width: none;
            width: 100%;
            background: transparent;
            box-shadow: none;
            border-radius: 0;
            min-height: auto;
        }
        .public-marketing-nav {
            border-bottom: 1px solid #e9ecef;
        }
        .public-marketing-nav .navbar-brand {
            padding-top: 0;
            padding-bottom: 0;
        }
        .public-marketing-nav .brand-full-logo {
            height: 40px;
            width: auto;
            display: block;
        }
        .app-brand-logo {
            height: 36px;
            width: auto;
            display: block;
        }
        .public-marketing-nav .navbar-nav .nav-link {
            color: #6c757d !important;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .public-marketing-nav .navbar-nav .nav-link:hover {
            color: #0d6efd !important;
        }
        .public-marketing-nav .btn-cta {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border: none;
            border-radius: 999px;
            padding: 0.45rem 1.1rem;
            font-weight: 700;
            color: #ffffff !important;
            box-shadow: 0 6px 16px rgba(255, 165, 0, 0.28);
        }
        .public-marketing-nav .btn-cta:hover {
            filter: brightness(0.95);
            color: #ffffff !important;
        }
    </style>
</head>
<body data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}"
      data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}"
      data-org-id="{{ get_effective_org_id() if current_user.is_authenticated else '' }}">
    <script>
        window.__IS_AUTHENTICATED__ = {{ 'true' if current_user.is_authenticated else 'false' }};
    </script>
    <div class="app-container{% if public_shell_mode %} public-shell{% endif %}">
    <nav class="navbar navbar-expand-lg {% if public_shell_mode %}public-marketing-nav navbar-light bg-white shadow-sm{% else %}navbar-light bg-light{% endif %}">
        <div class="{% if public_shell_mode %}container{% else %}container-fluid{% endif %} position-relative">
            {% if not public_shell_mode %}
            <a class="navbar-brand" href="{% if current_user.is_authenticated %}{% if current_user.user_type == 'developer' %}{{ url_for('developer.dashboard') }}{% else %}{{ url_for('app_routes.dashboard') }}{% endif %}{% else %}{{ url_for('index') }}{% endif %}" aria-label="BatchTrack home">
                <img src="{{ url_for('branding_full_logo') }}" alt="BatchTrack" class="app-brand-logo">
            </a>
            {% endif %}
            {% set marketplace_display_enabled = is_feature_enabled('FEATURE_RECIPE_MARKETPLACE_DISPLAY') %}
            {% set recipe_library_nav_enabled = is_feature_enabled('FEATURE_RECIPE_LIBRARY_NAV') and marketplace_display_enabled %}
            {% set global_library_enabled = is_feature_enabled('FEATURE_GLOBAL_ITEM_LIBRARY') or (current_user.is_authenticated and current_user.user_type == 'developer') %}
            {% set bulk_stock_check_enabled = is_feature_enabled('FEATURE_BULK_STOCK_CHECK') %}
            {% set bulk_inventory_updates_enabled = is_feature_enabled('FEATURE_BULK_INVENTORY_UPDATES') %}
            {% set show_recipe_library_link = (recipe_library_nav_enabled or (current_user.is_authenticated and current_user.user_type == 'developer')) and marketplace_display_enabled %}
            {% set has_nav_center = navbar_center_title is defined and navbar_center_title %}
            {% if has_nav_center %}
            <div class="position-absolute top-50 start-50 translate-middle text-center">
                <span class="navbar-text fw-semibold">{{ navbar_center_title }}</span>
            </div>
            {% endif %}
            {% if current_user.is_authenticated %}
            {% if current_user.user_type == 'developer' %}
            <!-- Developer Navigation -->
            <div class="navbar-nav me-auto">
                <span class="navbar-text text-danger">
                    <i class="fas fa-shield-alt"></i> Developer Mode
                    {% if session.get('dev_selected_org_id') %}
                    {% set selected_org = get_organization_by_id(session.get('dev_selected_org_id')) %}
                    <small class="text-primary">| Viewing as Org Owner ({{ selected_org.get_tier_display_name() if selected_org else 'No Org' }})</small>
                    <a href="{{ url_for('developer.clear_organization_filter') }}" class="btn btn-sm btn-outline-secondary ms-2">
                        <i class="fas fa-times"></i> Clear Filter
                    </a>
                    {% endif %}
                </span>
            </div>
            <!-- Show both menus when developer is viewing an organization -->
            {% if session.get('dev_selected_org_id') %}
            {% if not has_nav_center %}
            <ul class="navbar-nav mx-auto d-none d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
            </ul>
            {% endif %}
            <div class="dropdown me-2">
                <button class="btn btn-light dropdown-toggle" type="button" id="customerDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user"></i> Customer Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="customerDropdown">
                    <!-- User Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Core Features -->
                    <li><h6 class="dropdown-header">Core Features</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Production Tools -->
                    <li><h6 class="dropdown-header">Production Tools</h6></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                            üßÆ Converter
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                            Expiration
                            <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                        </a>
                    </li>
                    <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                    {% if bulk_stock_check_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                    {% endif %}
                    {% if bulk_inventory_updates_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- Resources -->
                    <li><h6 class="dropdown-header">Resources</h6></li>
                    {% if global_library_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                    {% endif %}
                    {% if show_recipe_library_link %}
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Admin -->
                    <li><h6 class="dropdown-header">Admin</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
            {% endif %}
            <!-- Developer Menu (always available) -->
            <div class="dropdown ms-auto">
                <button class="btn btn-danger dropdown-toggle" type="button" id="devDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-code"></i> Developer Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="devDropdown">
                    <!-- Developer Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('developer.dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i> Developer Dashboard
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Organization Management -->
                    <li><h6 class="dropdown-header">Organization Management</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.create_organization') }}">
                        <i class="fas fa-plus"></i> Create Organization
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                        <i class="fas fa-building"></i> All Organizations
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.users') }}">
                        <i class="fas fa-users"></i> User Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_roles.manage_system_roles') }}">
                        <i class="fas fa-user-shield"></i> Role Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.manage_permissions') }}">
                        <i class="fas fa-key"></i> Permissions
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Global Library -->
                    <li><h6 class="dropdown-header">Global Library</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.global_items_admin') }}">
                        <i class="fas fa-boxes"></i> Global Items
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">
                        <i class="fas fa-book-open"></i> Recipe Library
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.product_categories') }}">
                        <i class="fas fa-tags"></i> Product Categories
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.reference_categories') }}">
                        <i class="fas fa-leaf"></i> Ingredient Categories
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.container_management') }}">
                        <i class="fas fa-box-open"></i> Container Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.manage_ingredient_attributes') }}">
                        <i class="fas fa-layer-group"></i> Physical Forms
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Analytics -->
                    <li><h6 class="dropdown-header">Analytics</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.analytics_catalog') }}">
                        <i class="fas fa-database"></i> Analytics Catalog
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.inventory_analytics_stub') }}">
                        <i class="fas fa-chart-line"></i> Inventory Analytics
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_statistics') }}">
                        <i class="fas fa-chart-bar"></i> System Statistics
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- AI & Automation -->
                    <li><h6 class="dropdown-header">AI & Automation</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.batchley_overview') }}">
                        <i class="fas fa-robot"></i> Batchley
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Billing -->
                    <li><h6 class="dropdown-header">Billing</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.subscription_tiers.manage_tiers') }}">
                        <i class="fas fa-layer-group text-primary"></i> Tier Management
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.addons.list_addons') }}">
                        <i class="fas fa-puzzle-piece"></i> Add-ons
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.billing_integration') }}">
                        <i class="fas fa-credit-card"></i> Billing Integration
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Marketing -->
                    <li><h6 class="dropdown-header">Marketing</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.marketing_admin') }}">
                        <i class="fas fa-bullhorn"></i> Marketing Admin
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.waitlist_statistics') }}">
                        <i class="fas fa-envelope"></i> Waitlist
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Customer Support -->
                    <li><h6 class="dropdown-header">Customer Support</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                        <i class="fas fa-headset"></i> Customer Support
                        {% if session.get('dev_selected_org_id') %}
                        <span class="badge bg-primary ms-1">Active</span>
                        {% endif %}
                    </a></li>
                    {% if session.get('dev_selected_org_id') %}
                    <li><a class="dropdown-item" href="{{ url_for('developer.clear_organization_filter') }}">
                        <i class="fas fa-times"></i> Clear Customer Filter
                    </a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- System -->
                    <li><h6 class="dropdown-header">System</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.system_settings') }}">
                        <i class="fas fa-cogs"></i> System Settings
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.integrations_checklist') }}">
                        <i class="fas fa-plug"></i> Integrations & Launch
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('developer.feature_flags') }}">
                        <i class="fas fa-toggle-on"></i> Feature Flags
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a></li>
                </ul>
            </div>
            {% else %}
            <!-- Customer Navigation -->
            <div class="navbar-nav me-auto">
            </div>
            {% if not has_nav_center %}
            <ul class="navbar-nav mx-auto d-none d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools">
                        üîß Tools
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('help_routes.help_overview') }}">
                        ‚ùì Help
                    </a>
                </li>
                <li class="nav-item">
                    <div class="navbar-text">
                        <span id="header-clock" class="text-muted">üïê Loading...</span>
                    </div>
                </li>
            </ul>
            {% endif %}
            <div class="dropdown ms-auto">
                <button class="btn btn-light dropdown-toggle" type="button" id="directoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="directoryDropdown">
                    <!-- User Dashboard -->
                    <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Core Features -->
                    <li><h6 class="dropdown-header">Core Features</h6></li>
                    {% if current_user.is_authenticated and has_permission(current_user, 'inventory.view') %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'recipes.view') %}
                    <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'batches.view') %}
                    <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'products.view') %}
                    <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- Production Tools -->
                    <li><h6 class="dropdown-header">Production Tools</h6></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                            üßÆ Converter
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                            Expiration
                            <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                        </a>
                    </li>
                    {% if current_user.is_authenticated and has_permission(current_user, 'batches.view') %}
                    <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                    {% endif %}
                    {% if has_role('developer') or has_role('organization_owner') or has_permission(current_user, 'organization.manage') %}
                    <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'products.view') and bulk_stock_check_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and has_permission(current_user, 'inventory.edit') and bulk_inventory_updates_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <!-- Resources -->
                    <li><h6 class="dropdown-header">Resources</h6></li>
                    {% if global_library_enabled %}
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                    {% endif %}
                    {% if show_recipe_library_link %}
                    <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <!-- Admin -->
                    <li><h6 class="dropdown-header">Admin</h6></li>
                    {% if current_user.is_authenticated and has_permission(current_user, 'organization.view') %}
                    {% if current_user.user_type != 'developer' or session.get('dev_selected_org_id') %}
                    <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                    {% endif %}
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
            {% endif %}
            {% else %}
            {% if use_public_header %}
            {% set public_header_is_homepage = false %}
            {% set public_header_signup_source = 'public_header' %}
            {% include 'components/shared/public_marketing_header.html' %}
            {% else %}
            <div class="navbar-nav me-auto"></div>
            <div class="dropdown ms-auto">
                <button class="btn btn-light dropdown-toggle" type="button" id="publicMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="publicMenuDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('auth.signup') }}">Sign up</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Sign in</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Library</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                </ul>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </nav>
    <main class="container-xl mt-4">
        <div class="section-spacing">
            {% if breadcrumb_items is defined and breadcrumb_items %}
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    {% for crumb in breadcrumb_items %}
                        {% if crumb.url %}
                        <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.label }}</a></li>
                        {% else %}
                        <li class="breadcrumb-item active">{{ crumb.label }}</li>
                        {% endif %}
                    {% endfor %}
                </ol>
            </nav>
            {% endif %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% set alert_class = 'info' %}
                        {% if category in ['error', 'danger'] %}
                            {% set alert_class = 'danger' %}
                        {% elif category == 'warning' %}
                            {% set alert_class = 'warning' %}
                        {% elif category == 'success' %}
                            {% set alert_class = 'success' %}
                        {% endif %}
                        <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% set TimezoneUtils = TimezoneUtils_global() %}
            {% block content %}{% endblock %}
        </div>
    </main>
    {% include 'components/shared/unit_converter_modal.html' %}
    {% if not current_user.is_authenticated %}
    <a class="bot-trap-link" href="{{ url_for('public_api.public_bot_trap', source='layout') }}" rel="nofollow" aria-hidden="true" tabindex="-1">Continue</a>
    {% endif %}
    </div>
    <footer class="bg-light text-center text-muted py-3 mt-5">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <small>
                            &copy; {{ TimezoneUtils.utc_now().year }} BatchTrack. All rights reserved. |
                            <a href="{{ url_for('legal.privacy_policy') }}" class="text-muted">Privacy Policy</a> |
                            <a href="{{ url_for('legal.terms_of_service') }}" class="text-muted">Terms of Service</a> |
                            <a href="{{ url_for('legal.cookie_policy') }}" class="text-muted">Cookie Policy</a>
                        </small>
                    </div>
                </div>
            </div>
        </footer>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <!-- Custom scripts - Load SessionGuard before other modules -->
      <script type="module" src="{{ url_for('static', filename='js/core/SessionGuard.js') }}"></script>
      <!-- Load DrawerProtocol and CacheManager before DrawerInterceptor as modules -->
      <script type="module" src="{{ url_for('static', filename='js/core/DrawerProtocol.js') }}"></script>
      <script type="module" src="{{ url_for('static', filename='js/core/DrawerInterceptor.js') }}"></script>
      <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
      <script src="{{ url_for('static', filename='js/utils/utils.js') }}"></script>
      <script src="{{ url_for('static', filename='js/inventory/inventory_adjust.js') }}"></script>
      <script src="{{ url_for('static', filename='js/conversion/unit_converter.js') }}"></script>
      <script type="module" src="{{ url_for('static', filename='js/drawers/drawer_cadence.js') }}"></script>
      <script src="{{ url_for('static', filename='js/drawers/container_unit_mismatch_drawer.js') }}"></script>
{% block scripts %}{% endblock %}
    <script src="{{ url_for('static', filename='js/expiration_alerts.js') }}"></script>

    <!-- Simple browser clock script -->
    <script>
        function updateClock() {
            const clockElement = document.getElementById('header-clock');
            if (clockElement) {
                const now = new Date();
                clockElement.textContent = `üïê ${now.toLocaleTimeString()}`;
            }
        }
        // Update clock every second and start immediately
        setInterval(updateClock, 1000);
        updateClock();
    </script>

    </body>
</html>
