{#
Synopsis:
Primary shell template for authenticated app pages and public-layout pages.

Glossary:
- Theme bootstrap: Early script that resolves and applies the page theme before paint.
- Public header mode: Guest navigation variant enabled by `show_public_header`.
#}
{% from 'components/shared/feedback_note_modal.html' import render_feedback_note_widget %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
      {% set resolved_title = page_title or "BatchTrack | Batch Tracking for Makers" %}
      {% set resolved_description = page_description or "BatchTrack helps makers track recipes, inventory lots, and every batch from plan to finish." %}
      {% set resolved_canonical = canonical_url or request.base_url %}
      {% set resolved_og_image = page_og_image or url_for('static', filename='images/og/batchtrack-default-og.svg', _external=True) %}
      {% set resolved_robots = page_robots or "index, follow" %}
      {% set requested_public_header = use_public_header if use_public_header is defined else (show_public_header if show_public_header is defined else none) %}
      {% set use_public_header = requested_public_header if requested_public_header is not none else (not current_user.is_authenticated) %}
      {% set public_shell_mode = use_public_header and not current_user.is_authenticated %}
      {% set requested_public_full_bleed = public_shell_full_bleed if public_shell_full_bleed is defined else false %}
      {% set public_shell_full_bleed = requested_public_full_bleed and public_shell_mode %}
      {% set shell_main_id = shell_main_id if shell_main_id is defined else none %}
      {% set shell_main_extra_class = shell_main_extra_class if shell_main_extra_class is defined else '' %}
      {% set customer_feedback_bubble_enabled = is_feature_enabled('FEATURE_CUSTOMER_FEEDBACK_BUBBLE') and not (current_user.is_authenticated and current_user.user_type == 'developer') %}
      {% set requested_lightweight_public_shell = lightweight_public_shell if lightweight_public_shell is defined else false %}
      {% set lightweight_public_shell = requested_lightweight_public_shell and public_shell_mode %}
      {% set load_analytics = (load_analytics if load_analytics is defined else true) if public_shell_mode else true %}
      {% set load_fontawesome = (load_fontawesome if load_fontawesome is defined else true) if public_shell_mode else true %}
      {% set load_feedback_widget = (load_feedback_widget if load_feedback_widget is defined else customer_feedback_bubble_enabled) if public_shell_mode else customer_feedback_bubble_enabled %}
      {% set ga_measurement_id = (config.get('GOOGLE_ANALYTICS_MEASUREMENT_ID') or '').strip() %}
      {% set posthog_api_key = (config.get('POSTHOG_PROJECT_API_KEY') or '').strip() %}
      {% set posthog_host = (config.get('POSTHOG_HOST') or 'https://us.i.posthog.com').rstrip('/') %}
      {% set posthog_capture_pageview = config.get('POSTHOG_CAPTURE_PAGEVIEW', true) %}
      {% set posthog_capture_pageleave = config.get('POSTHOG_CAPTURE_PAGELEAVE', true) %}
      {% if not load_analytics %}
      {% set ga_measurement_id = '' %}
      {% set posthog_api_key = '' %}
      {% endif %}
      <title>{{ resolved_title }}</title>
      <meta name="description" content="{{ resolved_description }}">
      <meta name="robots" content="{{ resolved_robots }}">
      <link rel="canonical" href="{{ resolved_canonical }}">
      <meta property="og:type" content="website">
      <meta property="og:site_name" content="BatchTrack">
      <meta property="og:locale" content="en_US">
      <meta property="og:title" content="{{ resolved_title }}">
      <meta property="og:description" content="{{ resolved_description }}">
      <meta property="og:url" content="{{ resolved_canonical }}">
      <meta property="og:image" content="{{ resolved_og_image }}">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="{{ resolved_title }}">
      <meta name="twitter:description" content="{{ resolved_description }}">
      <meta name="twitter:image" content="{{ resolved_og_image }}">
    {% include 'components/layout/head_assets.html' %}
    {% block head %}{% endblock %}
    {% include 'components/layout/shell_styles.html' %}
</head>
<body{% if public_shell_mode %} class="public-shell-body"{% endif %}
      data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}"
      data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}"
      data-org-id="{{ get_effective_org_id() if current_user.is_authenticated else '' }}"
      data-page-endpoint="{{ request.endpoint or '' }}">
    <script>
        window.__IS_AUTHENTICATED__ = {{ 'true' if current_user.is_authenticated else 'false' }};
    </script>
    <div class="app-container{% if public_shell_mode %} public-shell{% endif %}">
    {% include 'components/layout/navbar.html' %}
    <main{% if shell_main_id %} id="{{ shell_main_id }}"{% endif %} class="{% if public_shell_mode %}{% if public_shell_full_bleed %}public-shell-main public-shell-main-bleed{% else %}container-xl public-shell-main{% endif %}{% else %}container-xl mt-4{% endif %}{% if shell_main_extra_class %} {{ shell_main_extra_class }}{% endif %}">
        {% include 'components/layout/content_chrome.html' %}
        {% set verification_required_modal = session.pop('verification_required_modal', None) %}
        {% set TimezoneUtils = TimezoneUtils_global() %}
        {% if not public_shell_full_bleed %}
        <div class="section-spacing{% if public_shell_mode %} public-shell-section{% endif %}">
        {% endif %}
            {% block content %}{% endblock %}
        {% if not public_shell_full_bleed %}
        </div>
        {% endif %}
    </main>
    {% include 'components/layout/overlay_modals.html' %}
    </div>
    {% include 'components/layout/footer.html' %}
    {% include 'components/layout/scripts_primary.html' %}
{% block scripts %}{% endblock %}
    {% include 'components/layout/scripts_secondary.html' %}

    </body>
</html>
