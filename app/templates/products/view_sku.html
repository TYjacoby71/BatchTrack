{% extends "layout.html" %}
{% block title %}{{ product.name }} - {{ variant }} - {{ size_label }}{% endblock %}

{% block scripts %}
<!-- Only include necessary scripts for this page -->
<script src="{{ url_for('static', filename='js/utils/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/products/product_inventory.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('products.product_list') }}">Products</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_product', product_id=product.id) }}">{{ product.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_variant', product_id=product.id, variation_id=1) }}">{{ variant }}</a></li>
                    <li class="breadcrumb-item active">{{ size_label }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ product.name }} - {{ variant }} - {{ size_label }}</h2>
                <div>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSkuModal">
                        Edit SKU
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Stock</h5>
                            <h3 class="text-primary">{{ "%.2f"|format(total_quantity) }}</h3>
                            <small class="text-muted">{{ fifo_entries[0].unit if fifo_entries else 'units' }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">FIFO Batches</h5>
                            <h3 class="text-info">{{ total_batches }}</h3>
                            <small class="text-muted">active batches</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">SKU Code</h5>
                            <h3 class="text-secondary">{{ fifo_entries[0].sku or 'Not Set' if fifo_entries else 'Not Set' }}</h3>
                            <small class="text-muted">product code</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FIFO Filter -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="fifoFilter" {{ 'checked' if fifo_filter else '' }} onchange="toggleFifoFilter()">
                        <label class="form-check-label" for="fifoFilter">
                            Show only active FIFO entries (with remaining quantity)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Unified History Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Product History</h5>
                </div>
                <div class="card-body">
                    {% if history %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Quantity Change</th>
                                    <th>Remaining</th>
                                    <th>Unit Cost</th>
                                    <th>Batch</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in history %}
                                <tr>
                                    <td>{{ moment.strftime(entry.timestamp, '%Y-%m-%d %H:%M') if entry.timestamp else 'N/A' }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if entry.change_type == 'batch_production' %}bg-success
                                            {% elif entry.change_type == 'sale' %}bg-primary
                                            {% elif entry.change_type == 'spoil' %}bg-danger
                                            {% elif entry.change_type == 'recount' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ entry.change_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="{% if entry.quantity_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if entry.quantity_change > 0 %}+{% endif %}{{ "%.2f"|format(entry.quantity_change) }}
                                        </span>
                                        {{ entry.unit }}
                                    </td>
                                    <td>
                                        {% if entry.remaining_quantity is not none %}
                                            {{ "%.2f"|format(entry.remaining_quantity) }} {{ entry.unit }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.unit_cost %}
                                            ${{ "%.2f"|format(entry.unit_cost) }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.batch_id %}
                                            <a href="{{ url_for('batches.view_batch', batch_id=entry.batch_id) }}" class="text-decoration-none">
                                                Batch #{{ entry.batch_id }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Manual</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ entry.note or '' }}</small>
                                    </td>
                                    <td>
                                        {% if entry.remaining_quantity and entry.remaining_quantity > 0 %}
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#adjustFifoModal"
                                                    data-inventory-id="{{ entry.product_inventory_id }}"
                                                    data-current-quantity="{{ entry.remaining_quantity }}"
                                                    data-unit="{{ entry.unit }}">
                                                Adjust
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if history_pagination.pages > 1 %}
                    <nav aria-label="History pagination">
                        <ul class="pagination justify-content-center">
                            {% if history_pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', product_id=product.id, variant=variant, size_label=size_label, page=history_pagination.prev_num, fifo=request.args.get('fifo')) }}">Previous</a>
                                </li>
                            {% endif %}

                            {% for page_num in history_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != history_pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('product_inventory.view_sku', product_id=product.id, variant=variant, size_label=size_label, page=page_num, fifo=request.args.get('fifo')) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if history_pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', product_id=product.id, variant=variant, size_label=size_label, page=history_pagination.next_num, fifo=request.args.get('fifo')) }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No history entries found for this SKU.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit SKU Modal -->
<div class="modal fade" id="editSkuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit SKU</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('product_inventory.edit_sku', product_id=product.id, variant=variant, size_label=size_label) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sku" class="form-label">SKU Code</label>
                        <input type="text" class="form-control" id="sku" name="sku" 
                               value="{{ fifo_entries[0].sku or '' if fifo_entries else '' }}"
                               placeholder="Enter SKU code">
                        <div class="form-text">Leave empty to remove SKU</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update SKU</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FIFO Adjustment Modal -->
<div class="modal fade" id="adjustFifoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust FIFO Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="adjustFifoForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="change_type" class="form-label">Adjustment Type</label>
                        <select class="form-select" id="change_type" name="change_type" required>
                            <option value="">Select adjustment type</option>
                            <option value="recount">Recount (set new total)</option>
                            <option value="sale">Sale</option>
                            <option value="spoil">Spoiled</option>
                            <option value="damage">Damaged</option>
                            <option value="trash">Trash</option>
                            <option value="gift">Gift/Tester</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               step="0.01" min="0.01" required>
                        <div class="form-text">
                            <span id="quantityHelp">For recount: enter new total quantity. For deductions: enter amount to remove.</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Adjustment</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}