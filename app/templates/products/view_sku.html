{% extends "layout.html" %}
{% block title %}{{ sku.product_name }} - {{ sku.variant_name }} - {{ sku.size_label }}{% endblock %}

{% block scripts %}
<!-- Only include necessary scripts for this page -->
<script src="{{ url_for('static', filename='js/utils/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/products/product_inventory.js') }}"></script>
{% endblock %}

{% block content %}
<style>
.variant-card {
    transition: transform 0.2s ease-in-out;
}

.variant-card:hover {
    transform: translateY(-2px);
}

.stat-box {
    padding: 0.5rem;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
}

/* Product history table styling */
.table-sm th,
.table-sm td {
    padding: 0.3rem;
    font-size: 0.875rem;
    vertical-align: top;
}

.badge-sm {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

.table-responsive {
    overflow-x: auto;
}

/* Compact column widths */
.table th:nth-child(1), .table td:nth-child(1) { width: 70px; } /* Date */
.table th:nth-child(2), .table td:nth-child(2) { width: 80px; } /* Type */
.table th:nth-child(3), .table td:nth-child(3) { width: 60px; } /* Qty Change */
.table th:nth-child(4), .table td:nth-child(4) { width: 60px; } /* Old Qty */
.table th:nth-child(5), .table td:nth-child(5) { width: 60px; } /* New Qty */
.table th:nth-child(6), .table td:nth-child(6) { width: 60px; } /* Remaining */
.table th:nth-child(7), .table td:nth-child(7) { width: 60px; } /* Original */
.table th:nth-child(8), .table td:nth-child(8) { width: 60px; } /* Unit Cost */
.table th:nth-child(9), .table td:nth-child(9) { width: 60px; } /* Sale Price */
.table th:nth-child(10), .table td:nth-child(10) { width: 80px; } /* Customer */
.table th:nth-child(11), .table td:nth-child(11) { width: 70px; } /* FIFO Code */
.table th:nth-child(12), .table td:nth-child(12) { width: 80px; } /* Batch/Lot */
.table th:nth-child(13), .table td:nth-child(13) { width: 80px; } /* Location */
.table th:nth-child(14), .table td:nth-child(14) { width: 80px; } /* Quality */
.table th:nth-child(15), .table td:nth-child(15) { width: 80px; } /* Order ID */
.table th:nth-child(16), .table td:nth-child(16) { min-width: 100px; } /* Notes */
.table th:nth-child(17), .table td:nth-child(17) { width: 60px; } /* Actions */
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('products.product_list') }}">Products</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_product', product_name=sku.product_name) }}">{{ sku.product_name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_variant', product_name=sku.product_name, variant_name=sku.variant_name) }}">{{ sku.variant_name }}</a></li>
                    <li class="breadcrumb-item active">{{ sku.size_label }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ sku.product_name }} - {{ sku.variant_name }} - {{ sku.size_label }}</h2>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Stock</h5>
                            <h3 class="text-primary">{{ "%.2f"|format(total_quantity) }}</h3>
                            <small class="text-muted">{{ sku.unit }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">SKU Code</h5>
                            <h3 class="text-secondary">{{ sku.sku_code or 'Not Set' }}</h3>
                            <small class="text-muted">product code</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Inventory Adjustment Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Inventory Actions</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('product_inventory.view_sku', sku_id=sku.id) }}" class="row g-3 align-items-end">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="col-md-3">
                            <label class="form-label">Action Type</label>
                            <select class="form-select" name="change_type" required>
                                <option value="sale">Sale</option>
                                <option value="restock">Restock</option>
                                <option value="adjustment">Adjustment</option>
                                <option value="damaged">Damaged</option>
                                <option value="return">Return</option>
                                <option value="spoil">Spoiled</option>
                                <option value="recount">Recount</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0.01" required>
                            <small class="text-muted">{{ sku.unit }}</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Notes (Optional)</label>
                            <input type="text" class="form-control" name="notes" placeholder="Reference, customer, etc.">
                        </div>

                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Record</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- FIFO Filter -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="fifoFilter" {{ 'checked' if fifo_filter else '' }} onchange="toggleFifoFilter()">
                        <label class="form-check-label" for="fifoFilter">
                            Show only active FIFO entries (with remaining quantity)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Unified History Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Product History</h5>
                </div>
                <div class="card-body">
                    {% if history %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Qty Change</th>
                                    <th>Old Qty</th>
                                    <th>New Qty</th>
                                    <th>Remaining</th>
                                    <th>Original</th>
                                    <th>Unit Cost</th>
                                    <th>Sale Price</th>
                                    <th>Customer</th>
                                    <th>FIFO Code</th>
                                    <th>Batch/Lot</th>
                                    <th>Location</th>
                                    <th>Quality</th>
                                    <th>Order ID</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in history %}
                                <tr>
                                    <td>{{ entry.timestamp.strftime('%m/%d %H:%M') if entry.timestamp else 'N/A' }}</td>
                                    <td>
                                        <span class="badge badge-sm
                                            {% if entry.change_type == 'batch_production' or entry.change_type == 'batch_addition' %}bg-success
                                            {% elif entry.change_type == 'sale' %}bg-primary
                                            {% elif entry.change_type == 'spoil' %}bg-danger
                                            {% elif entry.change_type == 'recount' %}bg-warning
                                            {% elif entry.change_type == 'reserved' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ entry.change_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="{% if entry.quantity_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if entry.quantity_change > 0 %}+{% endif %}{{ "%.1f"|format(entry.quantity_change) }}
                                        </span>
                                    </td>
                                    <td>{{ "%.1f"|format(entry.old_quantity) if entry.old_quantity is not none else 'N/A' }}</td>
                                    <td>{{ "%.1f"|format(entry.new_quantity) if entry.new_quantity is not none else 'N/A' }}</td>
                                    <td>
                                        {% if entry.remaining_quantity is not none %}
                                            {{ "%.1f"|format(entry.remaining_quantity) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.original_quantity is not none %}
                                            {{ "%.1f"|format(entry.original_quantity) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.unit_cost %}
                                            ${{ "%.2f"|format(entry.unit_cost) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.sale_price %}
                                            ${{ "%.2f"|format(entry.sale_price) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.customer %}
                                            <small>{{ entry.customer[:12] }}{% if entry.customer|length > 12 %}...{% endif %}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.fifo_code %}
                                            <small class="font-monospace">{{ entry.fifo_code[:8] }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.batch_id %}
                                            <a href="{{ url_for('batches.view_batch', batch_id=entry.batch_id) }}" class="text-decoration-none">
                                                <small>B{{ entry.batch_id }}</small>
                                            </a>
                                        {% endif %}
                                        {% if entry.batch_number %}
                                            <br><small class="text-muted">{{ entry.batch_number[:8] }}</small>
                                        {% endif %}
                                        {% if entry.lot_number %}
                                            <br><small class="text-info">L{{ entry.lot_number[:8] }}</small>
                                        {% endif %}
                                        {% if not entry.batch_id and not entry.batch_number and not entry.lot_number %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.location_name %}
                                            <small>{{ entry.location_name[:10] }}{% if entry.location_name|length > 10 %}...{% endif %}</small>
                                        {% elif entry.location_id %}
                                            <small class="text-muted">{{ entry.location_id[:8] }}</small>
                                        {% endif %}
                                        {% if entry.temperature_at_time %}
                                            <br><small class="text-info">{{ entry.temperature_at_time }}Â°</small>
                                        {% endif %}
                                        {% if not entry.location_name and not entry.location_id and not entry.temperature_at_time %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.quality_status %}
                                            <span class="badge badge-sm 
                                                {% if entry.quality_status == 'passed' %}bg-success
                                                {% elif entry.quality_status == 'failed' %}bg-danger
                                                {% elif entry.quality_status == 'quarantine' %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entry.quality_status.title() }}
                                            </span>
                                        {% endif %}
                                        {% if entry.compliance_status and entry.compliance_status != entry.quality_status %}
                                            <br><span class="badge badge-sm 
                                                {% if entry.compliance_status == 'compliant' %}bg-success
                                                {% elif entry.compliance_status == 'non_compliant' %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entry.compliance_status.replace('_', ' ').title() }}
                                            </span>
                                        {% endif %}
                                        {% if not entry.quality_status and not entry.compliance_status %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.order_id %}
                                            <small class="font-monospace">{{ entry.order_id[:8] }}{% if entry.order_id|length > 8 %}...{% endif %}</small>
                                        {% endif %}
                                        {% if entry.reservation_id %}
                                            <br><small class="text-info">R{{ entry.reservation_id[:6] }}</small>
                                        {% endif %}
                                        {% if entry.marketplace_order_id %}
                                            <br><small class="text-success">{{ entry.marketplace_source or 'MP' }}:{{ entry.marketplace_order_id[:6] }}</small>
                                        {% endif %}
                                        {% if not entry.order_id and not entry.reservation_id and not entry.marketplace_order_id %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set note_text = entry.notes or entry.note or '' %}
                                        {% if note_text %}
                                            <small class="text-muted" title="{{ note_text }}">{{ note_text[:15] }}{% if note_text|length > 15 %}...{% endif %}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.remaining_quantity and entry.remaining_quantity > 0 %}
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#adjustFifoModal"
                                                    data-inventory-id="{{ entry.id }}"
                                                    data-current-quantity="{{ entry.remaining_quantity }}"
                                                    data-unit="{{ entry.unit }}">
                                                Adj
                                            </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if history_pagination.pages > 1 %}
                    <nav aria-label="History pagination">
                        <ul class="pagination justify-content-center">
                            {% if history_pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=history_pagination.prev_num, fifo=request.args.get('fifo')) }}">Previous</a>
                                </li>
                            {% endif %}

                            {% for page_num in history_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != history_pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=page_num, fifo=request.args.get('fifo')) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if history_pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=history_pagination.next_num, fifo=request.args.get('fifo')) }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No history entries found for this SKU.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>



<!-- FIFO Adjustment Modal -->
<div class="modal fade" id="adjustFifoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust FIFO Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="adjustFifoForm" action="{{ url_for('product_inventory.view_sku', sku_id=sku.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="adjust_fifo">
                <input type="hidden" id="modalInventoryId" name="inventory_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="change_type" class="form-label">Adjustment Type</label>
                        <select name="change_type" id="change_type" class="form-select" required>
                  <option value="">Select adjustment type</option>
                  <option value="manual_addition">Manual Addition</option>
                  <option value="recount">Recount (Set Total)</option>
                  <option value="damaged">Damaged</option>
                  <option value="spoil">Spoiled</option>
                  <option value="trash">Trash</option>
                  <option value="sample">Sample</option>
                  <option value="sale">Manual Sale</option>
                  <option value="reserved">Reserve for Order</option>
                  <option value="unreserved">Release Reservation</option>
                </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               step="0.01" min="0.01" required>
                        <div class="form-text">
                            <span id="quantityHelp">For recount: enter new total quantity. For deductions: enter amount to remove.</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea name="notes" id="notes" class="form-control" rows="2"></textarea>
                </div>

                <!-- POS Integration Fields -->
                <div class="mb-3" id="orderIdGroup" style="display: none;">
                  <label for="order_id" class="form-label">Order ID (for sales/reservations)</label>
                  <input type="text" name="order_id" id="order_id" class="form-control" placeholder="External order ID (Shopify, Etsy, etc.)">
                </div>

                <div class="mb-3" id="reservationGroup" style="display: none;">
                  <label for="expiration_minutes" class="form-label">Reservation Duration (minutes)</label>
                  <input type="number" name="expiration_minutes" id="expiration_minutes" class="form-control" value="30" min="1" max="1440">
                  <small class="form-text text-muted">How long to hold this reservation (default: 30 minutes)</small>
                </div>
              </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Adjustment</button>
                </div>
            </form>
        </div>
    </div>
</div>



<script>
// Populate FIFO adjustment modal with data
document.addEventListener('DOMContentLoaded', function() {
    const adjustModal = document.getElementById('adjustFifoModal');
    if (adjustModal) {
        adjustModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const inventoryId = button.getAttribute('data-inventory-id');
            const currentQuantity = button.getAttribute('data-current-quantity');
            const unit = button.getAttribute('data-unit');

            // Set the inventory ID
            document.getElementById('modalInventoryId').value = inventoryId;

            // Update help text
            document.getElementById('quantityHelp').textContent = 
                `Current quantity: ${currentQuantity} ${unit}. For recount: enter new total quantity. For deductions: enter amount to remove.`;
        });
    }
});

function toggleFifoFilter() {
    const checkbox = document.getElementById('fifoFilter');
    const url = new URL(window.location);

    if (checkbox.checked) {
        url.searchParams.set('fifo', 'true');
    } else {
        url.searchParams.delete('fifo');
    }

    window.location.href = url.toString();
}
</script>

{% endblock %}