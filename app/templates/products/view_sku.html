{% extends "layout.html" %}
{% block title %}{{ sku.product_name }} - {{ sku.variant_name }} - {{ sku.size_label }}{% endblock %}

{% block scripts %}
<!-- Only include necessary scripts for this page -->
<script src="{{ url_for('static', filename='js/utils/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/products/product_inventory.js') }}"></script>
{% endblock %}

{% block content %}
<style>
.variant-card {
    transition: transform 0.2s ease-in-out;
}

.variant-card:hover {
    transform: translateY(-2px);
}

.stat-box {
    padding: 0.5rem;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
}

/* Product history table styling */
.table-sm th,
.table-sm td {
    padding: 0.3rem;
    font-size: 0.875rem;
    vertical-align: top;
}

.badge-sm {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

.table-responsive {
    overflow-x: auto;
}

/* Compact column widths */
.table th:nth-child(1), .table td:nth-child(1) { width: 70px; } /* Date */
.table th:nth-child(2), .table td:nth-child(2) { width: 80px; } /* Type */
.table th:nth-child(3), .table td:nth-child(3) { width: 60px; } /* Qty Change */
.table th:nth-child(4), .table td:nth-child(4) { width: 60px; } /* Old Qty */
.table th:nth-child(5), .table td:nth-child(5) { width: 60px; } /* New Qty */
.table th:nth-child(6), .table td:nth-child(6) { width: 60px; } /* Remaining */
.table th:nth-child(7), .table td:nth-child(7) { width: 60px; } /* Original */
.table th:nth-child(8), .table td:nth-child(8) { width: 60px; } /* Unit Cost */
.table th:nth-child(9), .table td:nth-child(9) { width: 60px; } /* Sale Price */
.table th:nth-child(10), .table td:nth-child(10) { width: 80px; } /* Customer */
.table th:nth-child(11), .table td:nth-child(11) { width: 70px; } /* FIFO Code */
.table th:nth-child(12), .table td:nth-child(12) { width: 80px; } /* Batch/Lot */
.table th:nth-child(13), .table td:nth-child(13) { width: 80px; } /* Location */
.table th:nth-child(14), .table td:nth-child(14) { width: 80px; } /* Quality */
.table th:nth-child(15), .table td:nth-child(15) { width: 80px; } /* Order ID */
.table th:nth-child(16), .table td:nth-child(16) { min-width: 100px; } /* Notes */
.table th:nth-child(17), .table td:nth-child(17) { width: 60px; } /* Actions */
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('products.product_list') }}">Products</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_product', product_name=sku.product_name) }}">{{ sku.product_name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('products.view_variant', product_name=sku.product_name, variant_name=sku.variant_name) }}">{{ sku.variant_name }}</a></li>
                    <li class="breadcrumb-item active">{{ sku.size_label }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ sku.product_name }} - {{ sku.variant_name }} - {{ sku.size_label }}</h2>
            </div>

            <!-- SKU Details Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">SKU Details</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editSkuModal">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Stock Level -->
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <h4 class="text-primary mb-1">{{ "%.2f"|format(total_quantity) }}</h4>
                                <small class="text-muted">Total Stock</small>
                                <br><small class="text-muted">{{ sku.unit }}</small>
                            </div>
                        </div>
                        
                        <!-- SKU Code -->
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <h6 class="text-secondary mb-1">{{ sku.sku_code or 'Not Set' }}</h6>
                                <small class="text-muted">SKU Code</small>
                            </div>
                        </div>
                        
                        <!-- Retail Price -->
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <h6 class="text-success mb-1">
                                    {% if sku.retail_price %}
                                        ${{ "%.2f"|format(sku.retail_price) }}
                                    {% else %}
                                        Not Set
                                    {% endif %}
                                </h6>
                                <small class="text-muted">Retail Price</small>
                            </div>
                        </div>
                        
                        <!-- Average Cost -->
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <h6 class="text-warning mb-1">
                                    {% if sku.unit_cost %}
                                        ${{ "%.2f"|format(sku.unit_cost) }}
                                    {% else %}
                                        Not Set
                                    {% endif %}
                                </h6>
                                <small class="text-muted">Avg Cost</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details Row -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <span class="badge {% if total_quantity <= 0 %}bg-danger{% elif total_quantity <= sku.low_stock_threshold %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ sku.stock_status }}
                                </span>
                                <br><small class="text-muted">Status</small>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <span class="text-muted">{{ sku.low_stock_threshold }}</span>
                                <br><small class="text-muted">Low Stock Alert</small>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                {% if sku.reserved_quantity and sku.reserved_quantity > 0 %}
                                    <span class="text-info">{{ "%.2f"|format(sku.reserved_quantity) }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                                <br><small class="text-muted">Reserved</small>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <span class="text-primary">{{ "%.2f"|format(sku.available_for_sale) }}</span>
                                <br><small class="text-muted">Available</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Actions Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Inventory Actions</h5>
                </div>
                <div class="card-body">
                    <!-- Action Selection -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Select Action Type</label>
                            <select class="form-select" id="actionType" onchange="showActionForm()">
                                <option value="">Choose an action...</option>
                                <option value="sale">Sale</option>
                                <option value="gift">Gift</option>
                                <option value="restock">Restock</option>
                                <option value="adjustment">Manual Adjustment</option>
                                <option value="damaged">Damaged/Loss</option>
                                <option value="return">Customer Return</option>
                                <option value="spoil">Spoiled</option>
                                <option value="recount">Inventory Recount</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dynamic Action Forms -->
                    <div id="actionFormContainer" style="display: none;">
                        <form method="POST" action="{{ url_for('product_inventory.view_sku', sku_id=sku.id) }}" id="inventoryActionForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="change_type" id="hiddenChangeType">
                            
                            <div class="row g-3" id="dynamicFormFields">
                                <!-- Fields will be populated by JavaScript -->
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Record Transaction</button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetActionForm()">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- FIFO Filter -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="fifoFilter" {{ 'checked' if fifo_filter else '' }} onchange="toggleFifoFilter()">
                        <label class="form-check-label" for="fifoFilter">
                            Show only active FIFO entries (with remaining quantity)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Unified History Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Product History</h5>
                </div>
                <div class="card-body">
                    {% if history %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Qty Change</th>
                                    <th>Old Qty</th>
                                    <th>New Qty</th>
                                    <th>Remaining</th>
                                    <th>Original</th>
                                    <th>Unit Cost</th>
                                    <th>Sale Price</th>
                                    <th>Customer</th>
                                    <th>FIFO Code</th>
                                    <th>Batch/Lot</th>
                                    <th>Location</th>
                                    <th>Quality</th>
                                    <th>Order ID</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in history %}
                                <tr>
                                    <td>{{ entry.timestamp.strftime('%m/%d %H:%M') if entry.timestamp else 'N/A' }}</td>
                                    <td>
                                        <span class="badge badge-sm
                                            {% if entry.change_type == 'batch_production' or entry.change_type == 'batch_addition' %}bg-success
                                            {% elif entry.change_type == 'sale' %}bg-primary
                                            {% elif entry.change_type == 'spoil' %}bg-danger
                                            {% elif entry.change_type == 'recount' %}bg-warning
                                            {% elif entry.change_type == 'reserved' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ entry.change_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="{% if entry.quantity_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if entry.quantity_change > 0 %}+{% endif %}{{ "%.1f"|format(entry.quantity_change) }}
                                        </span>
                                    </td>
                                    <td>{{ "%.1f"|format(entry.old_quantity) if entry.old_quantity is not none else 'N/A' }}</td>
                                    <td>{{ "%.1f"|format(entry.new_quantity) if entry.new_quantity is not none else 'N/A' }}</td>
                                    <td>
                                        {% if entry.remaining_quantity is not none %}
                                            {{ "%.1f"|format(entry.remaining_quantity) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.original_quantity is not none %}
                                            {{ "%.1f"|format(entry.original_quantity) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.unit_cost %}
                                            ${{ "%.2f"|format(entry.unit_cost) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.sale_price %}
                                            ${{ "%.2f"|format(entry.sale_price) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.customer %}
                                            <small>{{ entry.customer[:12] }}{% if entry.customer|length > 12 %}...{% endif %}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.fifo_code %}
                                            <small class="font-monospace">{{ entry.fifo_code[:8] }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.batch_id %}
                                            <a href="{{ url_for('batches.view_batch', batch_id=entry.batch_id) }}" class="text-decoration-none">
                                                <small>B{{ entry.batch_id }}</small>
                                            </a>
                                        {% endif %}
                                        {% if entry.batch_number %}
                                            <br><small class="text-muted">{{ entry.batch_number[:8] }}</small>
                                        {% endif %}
                                        {% if entry.lot_number %}
                                            <br><small class="text-info">L{{ entry.lot_number[:8] }}</small>
                                        {% endif %}
                                        {% if not entry.batch_id and not entry.batch_number and not entry.lot_number %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.location_name %}
                                            <small>{{ entry.location_name[:10] }}{% if entry.location_name|length > 10 %}...{% endif %}</small>
                                        {% elif entry.location_id %}
                                            <small class="text-muted">{{ entry.location_id[:8] }}</small>
                                        {% endif %}
                                        {% if entry.temperature_at_time %}
                                            <br><small class="text-info">{{ entry.temperature_at_time }}°</small>
                                        {% endif %}
                                        {% if not entry.location_name and not entry.location_id and not entry.temperature_at_time %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.quality_status %}
                                            <span class="badge badge-sm 
                                                {% if entry.quality_status == 'passed' %}bg-success
                                                {% elif entry.quality_status == 'failed' %}bg-danger
                                                {% elif entry.quality_status == 'quarantine' %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entry.quality_status.title() }}
                                            </span>
                                        {% endif %}
                                        {% if entry.compliance_status and entry.compliance_status != entry.quality_status %}
                                            <br><span class="badge badge-sm 
                                                {% if entry.compliance_status == 'compliant' %}bg-success
                                                {% elif entry.compliance_status == 'non_compliant' %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entry.compliance_status.replace('_', ' ').title() }}
                                            </span>
                                        {% endif %}
                                        {% if not entry.quality_status and not entry.compliance_status %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.order_id %}
                                            <small class="font-monospace">{{ entry.order_id[:8] }}{% if entry.order_id|length > 8 %}...{% endif %}</small>
                                        {% endif %}
                                        {% if entry.reservation_id %}
                                            <br><small class="text-info">R{{ entry.reservation_id[:6] }}</small>
                                        {% endif %}
                                        {% if entry.marketplace_order_id %}
                                            <br><small class="text-success">{{ entry.marketplace_source or 'MP' }}:{{ entry.marketplace_order_id[:6] }}</small>
                                        {% endif %}
                                        {% if not entry.order_id and not entry.reservation_id and not entry.marketplace_order_id %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set note_text = entry.notes or entry.note or '' %}
                                        {% if note_text %}
                                            <small class="text-muted" title="{{ note_text }}">{{ note_text[:15] }}{% if note_text|length > 15 %}...{% endif %}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.remaining_quantity and entry.remaining_quantity > 0 %}
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#adjustFifoModal"
                                                    data-inventory-id="{{ entry.id }}"
                                                    data-current-quantity="{{ entry.remaining_quantity }}"
                                                    data-unit="{{ entry.unit }}">
                                                Adj
                                            </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if history_pagination.pages > 1 %}
                    <nav aria-label="History pagination">
                        <ul class="pagination justify-content-center">
                            {% if history_pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=history_pagination.prev_num, fifo=request.args.get('fifo')) }}">Previous</a>
                                </li>
                            {% endif %}

                            {% for page_num in history_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != history_pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=page_num, fifo=request.args.get('fifo')) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if history_pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('product_inventory.view_sku', sku_id=sku.id, page=history_pagination.next_num, fifo=request.args.get('fifo')) }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No history entries found for this SKU.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit SKU Details Modal -->
<div class="modal fade" id="editSkuModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit SKU Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{{ url_for('product_inventory.edit_sku', sku_id=sku.id) }}" id="editSkuForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sku_code" class="form-label">SKU Code</label>
                                <input type="text" name="sku_code" class="form-control" value="{{ sku.sku_code or '' }}" 
                                       placeholder="Auto-generated if left blank">
                                <small class="text-muted">Leave blank to auto-generate from product/variant/size</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="size_label" class="form-label">Size Label</label>
                                <input type="text" name="size_label" class="form-control" value="{{ sku.size_label or '' }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="retail_price" class="form-label">Retail Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" min="0" name="retail_price" class="form-control" 
                                           value="{{ sku.retail_price or '' }}" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unit_cost" class="form-label">Unit Cost</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" min="0" name="unit_cost" id="modal_unit_cost" 
                                           class="form-control" value="{{ sku.unit_cost or '' }}" readonly>
                                    <div class="input-group-append">
                                        <div class="input-group-text">
                                            <input type="checkbox" id="override_unit_cost" name="override_unit_cost"> Override
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Calculated from FIFO entries. Check override to manually set.</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="low_stock_threshold" class="form-label">Low Stock Threshold</label>
                                <input type="number" step="0.01" min="0" name="low_stock_threshold" class="form-control" 
                                       value="{{ sku.low_stock_threshold or 0 }}">
                                <small class="text-muted">Alert when stock falls below this level</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unit" class="form-label">Unit</label>
                                <select name="unit" class="form-select" required>
                                    {% for unit in get_global_unit_list() %}
                                        <option value="{{ unit.name }}" {% if unit.name == sku.unit %}selected{% endif %}>
                                            {{ unit.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="is_active" class="form-check-input" id="is_active" 
                                           {% if sku.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">Active SKU</label>
                                </div>
                                <small class="text-muted">Inactive SKUs are hidden from most views</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="track_expiration" class="form-check-input" id="track_expiration" 
                                           {% if sku.track_expiration %}checked{% endif %}>
                                    <label class="form-check-label" for="track_expiration">Track Expiration</label>
                                </div>
                                <small class="text-muted">Enable expiration tracking for this SKU</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3" 
                                  placeholder="Optional description for this SKU">{{ sku.description or '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="barcode" class="form-label">Barcode/UPC</label>
                        <input type="text" name="barcode" class="form-control" value="{{ sku.barcode or '' }}" 
                               placeholder="UPC, EAN, or other barcode">
                        <small class="text-muted">For POS and inventory management integration</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editSkuForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- FIFO Adjustment Modal -->
<div class="modal fade" id="adjustFifoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust FIFO Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="adjustFifoForm" action="{{ url_for('product_inventory.view_sku', sku_id=sku.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="adjust_fifo">
                <input type="hidden" id="modalInventoryId" name="inventory_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="change_type" class="form-label">Adjustment Type</label>
                        <select name="change_type" id="change_type" class="form-select" required>
                  <option value="">Select adjustment type</option>
                  <option value="manual_addition">Manual Addition</option>
                  <option value="recount">Recount (Set Total)</option>
                  <option value="damaged">Damaged</option>
                  <option value="spoil">Spoiled</option>
                  <option value="trash">Trash</option>
                  <option value="sample">Sample</option>
                  <option value="sale">Manual Sale</option>
                  <option value="reserved">Reserve for Order</option>
                  <option value="unreserved">Release Reservation</option>
                </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               step="0.01" min="0.01" required>
                        <div class="form-text">
                            <span id="quantityHelp">For recount: enter new total quantity. For deductions: enter amount to remove.</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea name="notes" id="notes" class="form-control" rows="2"></textarea>
                </div>

                <!-- POS Integration Fields -->
                <div class="mb-3" id="orderIdGroup" style="display: none;">
                  <label for="order_id" class="form-label">Order ID (for sales/reservations)</label>
                  <input type="text" name="order_id" id="order_id" class="form-control" placeholder="External order ID (Shopify, Etsy, etc.)">
                </div>

                <div class="mb-3" id="reservationGroup" style="display: none;">
                  <label for="expiration_minutes" class="form-label">Reservation Duration (minutes)</label>
                  <input type="number" name="expiration_minutes" id="expiration_minutes" class="form-control" value="30" min="1" max="1440">
                  <small class="form-text text-muted">How long to hold this reservation (default: 30 minutes)</small>
                </div>
              </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Adjustment</button>
                </div>
            </form>
        </div>
    </div>
</div>



<script>
// SKU Inventory Actions - Dynamic Form Generation
const skuData = {
    retailPrice: {{ sku.retail_price or 0 }},
    unitCost: {{ sku.unit_cost or 0 }},
    currentQuantity: {{ total_quantity }},
    unit: '{{ sku.unit }}',
    availableQuantity: {{ sku.available_for_sale }}
};

function showActionForm() {
    const actionType = document.getElementById('actionType').value;
    const container = document.getElementById('actionFormContainer');
    const formFields = document.getElementById('dynamicFormFields');
    const hiddenChangeType = document.getElementById('hiddenChangeType');
    
    if (!actionType) {
        container.style.display = 'none';
        return;
    }
    
    hiddenChangeType.value = actionType;
    formFields.innerHTML = generateFormFields(actionType);
    container.style.display = 'block';
}

function generateFormFields(actionType) {
    let fields = '';
    
    // Common quantity field
    fields += `
        <div class="col-md-4">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" name="quantity" step="0.01" min="0.01" required>
            <small class="text-muted">${skuData.unit}</small>
        </div>
    `;
    
    // Action-specific fields
    switch(actionType) {
        case 'sale':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Sale Price</label>
                    <input type="number" class="form-control" name="sale_price" step="0.01" min="0" value="${skuData.retailPrice}">
                    <small class="text-muted">Per ${skuData.unit}</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Customer</label>
                    <input type="text" class="form-control" name="customer" placeholder="Customer name">
                </div>
                <div class="col-12">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-control" name="notes" placeholder="Order ID, payment method, etc.">
                </div>
            `;
            break;
            
        case 'gift':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Sale Price</label>
                    <input type="number" class="form-control" name="sale_price" value="0.00" readonly>
                    <small class="text-muted">Gifts have $0 sale price</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Recipient</label>
                    <input type="text" class="form-control" name="customer" placeholder="Gift recipient">
                </div>
                <div class="col-12">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-control" name="notes" placeholder="Reason for gift, event, etc.">
                </div>
            `;
            break;
            
        case 'restock':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Unit Cost</label>
                    <input type="number" class="form-control" name="unit_cost" step="0.01" min="0" value="${skuData.unitCost}">
                    <small class="text-muted">Cost per ${skuData.unit}</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Supplier</label>
                    <input type="text" class="form-control" name="supplier" placeholder="Supplier name">
                </div>
                <div class="col-12">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-control" name="notes" placeholder="Purchase order, batch info, etc.">
                </div>
            `;
            break;
            
        case 'damaged':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Damage Type</label>
                    <select class="form-select" name="damage_type">
                        <option value="broken">Broken/Cracked</option>
                        <option value="contaminated">Contaminated</option>
                        <option value="expired">Expired</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Unit Cost</label>
                    <input type="number" class="form-control" name="unit_cost" value="${skuData.unitCost}" readonly>
                    <small class="text-muted">Original cost tracked</small>
                </div>
                <div class="col-12">
                    <label class="form-label">Damage Description</label>
                    <input type="text" class="form-control" name="notes" placeholder="Describe what happened..." required>
                </div>
            `;
            break;
            
        case 'return':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Return Credit</label>
                    <input type="number" class="form-control" name="sale_price" step="0.01" min="0" value="${skuData.retailPrice}">
                    <small class="text-muted">Credit amount</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Customer</label>
                    <input type="text" class="form-control" name="customer" placeholder="Returning customer">
                </div>
                <div class="col-12">
                    <label class="form-label">Return Reason</label>
                    <input type="text" class="form-control" name="notes" placeholder="Reason for return..." required>
                </div>
            `;
            break;
            
        case 'spoil':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Spoilage Type</label>
                    <select class="form-select" name="spoil_type">
                        <option value="expired">Expired</option>
                        <option value="contaminated">Contaminated</option>
                        <option value="temperature">Temperature Issue</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Unit Cost</label>
                    <input type="number" class="form-control" name="unit_cost" value="${skuData.unitCost}" readonly>
                    <small class="text-muted">Loss tracked at cost</small>
                </div>
                <div class="col-12">
                    <label class="form-label">Spoilage Details</label>
                    <input type="text" class="form-control" name="notes" placeholder="What caused the spoilage?" required>
                </div>
            `;
            break;
            
        case 'recount':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">New Total Quantity</label>
                    <input type="number" class="form-control" name="quantity" step="0.01" min="0" placeholder="Enter actual count">
                    <small class="text-muted">Current: ${skuData.currentQuantity} ${skuData.unit}</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Count Method</label>
                    <select class="form-select" name="count_method">
                        <option value="physical">Physical Count</option>
                        <option value="system">System Adjustment</option>
                        <option value="audit">Audit Count</option>
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label">Recount Reason</label>
                    <input type="text" class="form-control" name="notes" placeholder="Why was this recount needed?" required>
                </div>
            `;
            break;
            
        case 'adjustment':
            fields += `
                <div class="col-md-4">
                    <label class="form-label">Adjustment Type</label>
                    <select class="form-select" name="adjustment_type">
                        <option value="increase">Increase Stock</option>
                        <option value="decrease">Decrease Stock</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Unit Cost</label>
                    <input type="number" class="form-control" name="unit_cost" step="0.01" min="0" value="${skuData.unitCost}">
                    <small class="text-muted">Cost per ${skuData.unit}</small>
                </div>
                <div class="col-12">
                    <label class="form-label">Adjustment Reason</label>
                    <input type="text" class="form-control" name="notes" placeholder="Reason for manual adjustment..." required>
                </div>
            `;
            break;
    }
    
    return fields;
}

function resetActionForm() {
    document.getElementById('actionType').value = '';
    document.getElementById('actionFormContainer').style.display = 'none';
    document.getElementById('dynamicFormFields').innerHTML = '';
}

// Populate FIFO adjustment modal with data
document.addEventListener('DOMContentLoaded', function() {
    const adjustModal = document.getElementById('adjustFifoModal');
    if (adjustModal) {
        adjustModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const inventoryId = button.getAttribute('data-inventory-id');
            const currentQuantity = button.getAttribute('data-current-quantity');
            const unit = button.getAttribute('data-unit');

            // Set the inventory ID
            document.getElementById('modalInventoryId').value = inventoryId;

            // Update help text
            document.getElementById('quantityHelp').textContent = 
                `Current quantity: ${currentQuantity} ${unit}. For recount: enter new total quantity. For deductions: enter amount to remove.`;
        });
    }
});

function toggleFifoFilter() {
    const checkbox = document.getElementById('fifoFilter');
    const url = new URL(window.location);

    if (checkbox.checked) {
        url.searchParams.set('fifo', 'true');
    } else {
        url.searchParams.delete('fifo');
    }

    window.location.href = url.toString();
}

// Handle unit cost override checkbox
document.addEventListener('DOMContentLoaded', function() {
    const overrideCheckbox = document.getElementById('override_unit_cost');
    const unitCostInput = document.getElementById('modal_unit_cost');
    
    if (overrideCheckbox && unitCostInput) {
        overrideCheckbox.addEventListener('change', function() {
            if (this.checked) {
                unitCostInput.removeAttribute('readonly');
                unitCostInput.focus();
            } else {
                unitCostInput.setAttribute('readonly', 'readonly');
                unitCostInput.value = '{{ sku.unit_cost or "" }}'; // Reset to original value
            }
        });
    }
});
</script>

{% endblock %}