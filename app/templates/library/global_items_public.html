{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Global Item Library</h2>
  {% if is_developer() %}
  <div>
    <a href="{{ url_for('developer.reference_categories') }}" class="btn btn-outline-primary me-2">
      <i class="fas fa-tags"></i> Manage Categories
    </a>
    <a href="{{ url_for('developer.create_global_item') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add Global Item
    </a>
  </div>
  {% endif %}
  

</div>

<div class="row mb-3">
  <div class="col-md-12">
    <form method="GET" class="row g-2">
      <div class="col-auto">
        <label for="searchInput" class="form-label">Search</label>
        <input type="text" id="searchInput" name="search" class="form-control" value="{{ search_query or '' }}" placeholder="Search by name or alias" onkeyup="handleSearchKeyup(event)">
      </div>

      <div class="col-auto">
        <label for="typeFilter" class="form-label">Item Type</label>
        <select id="typeFilter" name="type" class="form-select" onchange="applyFilters()">
          <option value="">All Types</option>
          <option value="ingredient" {% if selected_type == 'ingredient' %}selected{% endif %}>Ingredients</option>
          <option value="container" {% if selected_type == 'container' %}selected{% endif %}>Containers</option>
          <option value="packaging" {% if selected_type == 'packaging' %}selected{% endif %}>Packaging</option>
          <option value="consumable" {% if selected_type == 'consumable' %}selected{% endif %}>Consumables</option>
        </select>
      </div>

      <div class="col-auto" id="categoryFilterDiv" {% if selected_type != 'ingredient' %}style="display: none;"{% endif %}>
        <label for="categoryFilter" class="form-label">Ingredient Category</label>
        <select id="categoryFilter" name="category" class="form-select" onchange="applyFilters()">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto align-self-end">
        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">Clear</button>
      </div>
    </form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Ingredient</th>
          <th>Physical Form</th>
          <th>Category</th>
          <th>Density (g/ml)</th>
          <th>Capacity</th>
          <th>Perishable</th>
          {% if current_user.is_authenticated and current_user.user_type == 'developer' %}<th></th>{% endif %}
        </tr>
    </thead>
    <tbody>
      {% for gi in items %}
        <tr>
          <td>
            <a href="{{ url_for('global_library_bp.global_item_detail', item_id=gi.id, slug=slugify(gi.name)) }}"
               class="text-decoration-none js-open-global-item-stats"
               data-global-item-id="{{ gi.id }}">{{ gi.name }}</a>
          </td>
          <td><span class="badge bg-secondary">{{ gi.item_type }}</span></td>
          <td>{{ gi.ingredient.name if gi.ingredient else '-' }}</td>
          <td>{{ gi.physical_form.name if gi.physical_form else '-' }}</td>
          <td>{{ gi.ingredient_category.name if gi.ingredient_category else '-' }}</td>
          <td>
          {% if gi.density is not none %}
            {{ '%.3f'|format(gi.density) }}
            {% elif gi.ingredient_category and gi.ingredient_category.default_density is not none %}
              {{ '%.3f'|format(gi.ingredient_category.default_density) }}
            {% else %}-{% endif %}
          </td>
        <td>{{ gi.capacity or '-' }} {{ gi.capacity_unit or '' }}</td>
        <td>{{ 'Yes' if gi.default_is_perishable else 'No' }}</td>
        {% if is_developer() %}
        <td>
          <a href="{{ url_for('developer.global_item_detail', item_id=gi.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>

        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% with show_dev_link=is_developer() %}
  {% include 'components/drawer/global_item_stats_offcanvas.html' %}
{% endwith %}

{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
  const url = new URL(window.location);
  const type = document.getElementById('typeFilter').value;
  const category = document.getElementById('categoryFilter').value;
  const search = document.getElementById('searchInput').value;

  if (search.trim()) { url.searchParams.set('search', search.trim()); } else { url.searchParams.delete('search'); }
  if (type) { url.searchParams.set('type', type); } else { url.searchParams.delete('type'); }
  if (category && type === 'ingredient') { url.searchParams.set('category', category); } else { url.searchParams.delete('category'); }

  window.location.href = url.toString();
}

function handleSearchKeyup(event) {
  if (event.key === 'Enter') {
    applyFilters();
  } else {
    if (window.searchTimeout) clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(applyFilters, 400);
  }
}

function clearFilters() {
  window.location.href = window.location.pathname;
}

function formatShelfLifeNumber(value) {
  const rounded = Math.round(value * 10) / 10;
  if (Number.isFinite(rounded) && Math.abs(rounded - Math.round(rounded)) < 0.05) {
    return Math.round(rounded).toString();
  }
  return Number.isFinite(rounded) ? rounded.toString() : '';
}

function formatShelfLifeDays(days) {
  const numeric = Number(days);
  if (!Number.isFinite(numeric) || numeric <= 0) {
    return 'â€“';
  }
  if (numeric < 60) {
    return `${numeric} day${numeric === 1 ? '' : 's'}`;
  }
  if (numeric < 730) {
    const months = numeric / 30.4375;
    const display = formatShelfLifeNumber(months);
    const unit = display === '1' ? 'month' : 'months';
    return `${display} ${unit} (${numeric} days)`;
  }
  const years = numeric / 365;
  const display = formatShelfLifeNumber(years);
  const unit = display === '1' ? 'year' : 'years';
  return `${display} ${unit} (${numeric} days)`;
}

document.addEventListener('DOMContentLoaded', function(){
  const typeFilter = document.getElementById('typeFilter');
  const categoryDiv = document.getElementById('categoryFilterDiv');
  const categorySelect = document.getElementById('categoryFilter');
  const updateCategoryVisibility = function(){
    if (typeFilter.value === 'ingredient') {
      categoryDiv.style.display = '';
      categorySelect.disabled = false;
    } else {
      categoryDiv.style.display = 'none';
      categorySelect.disabled = true;
      categorySelect.value = '';
    }
  };
  typeFilter.addEventListener('change', updateCategoryVisibility);
  updateCategoryVisibility();
});
</script>
<script type="module">
  import { configureGlobalItemStats, bindGlobalItemStatTriggers } from "{{ url_for('static', filename='js/global_item_stats.js') }}";

  const developerLinkBase = {% if is_developer() %}"{{ url_for('developer.global_item_detail', item_id=0)[:-1] }}"{% else %}null{% endif %};

  configureGlobalItemStats({
    developerLinkBase
  });

  document.addEventListener('DOMContentLoaded', () => {
    bindGlobalItemStatTriggers('.js-open-global-item-stats');
  });
</script>
{% endblock %}