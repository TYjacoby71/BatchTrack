{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Global Inventory Library</h2>
</div>

<div class="row mb-3">
  <div class="col-md-12">
    <form method="GET" class="row g-2">
      <div class="col-auto">
        <label for="searchInput" class="form-label">Search</label>
        <input type="text" id="searchInput" name="search" class="form-control" value="{{ search_query or '' }}" placeholder="Search by name or alias" onkeyup="handleSearchKeyup(event)">
      </div>

      <div class="col-auto">
        <label for="typeFilter" class="form-label">Item Type</label>
        <select id="typeFilter" name="type" class="form-select" onchange="applyFilters()">
          <option value="">All Types</option>
          <option value="ingredient" {% if selected_type == 'ingredient' %}selected{% endif %}>Ingredients</option>
          <option value="container" {% if selected_type == 'container' %}selected{% endif %}>Containers</option>
          <option value="packaging" {% if selected_type == 'packaging' %}selected{% endif %}>Packaging</option>
          <option value="consumable" {% if selected_type == 'consumable' %}selected{% endif %}>Consumables</option>
        </select>
      </div>

      <div class="col-auto" id="categoryFilterDiv" {% if selected_type != 'ingredient' %}style="display: none;"{% endif %}>
        <label for="categoryFilter" class="form-label">Ingredient Category</label>
        <select id="categoryFilter" name="category" class="form-select" onchange="applyFilters()">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto align-self-end">
        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">Clear</button>
      </div>
    </form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Category</th>
        <th>Density (default if category)</th>
        <th>Capacity</th>
        <th>Perishable</th>
      </tr>
    </thead>
    <tbody>
      {% for gi in items %}
      <tr>
        <td>
          <a href="#" onclick="openItemDetails({{ gi.id }}); return false;">{{ gi.name }}</a>
        </td>
        <td><span class="badge bg-secondary">{{ gi.item_type }}</span></td>
        <td>{{ gi.ingredient_category.name if gi.ingredient_category else '-' }}</td>
        <td>
          {% if gi.density is not none %}
            {{ '%.3f'|format(gi.density) }}
          {% elif gi.ingredient_category and gi.ingredient_category.default_density is not none %}
            {{ '%.3f'|format(gi.ingredient_category.default_density) }}
          {% else %}-{% endif %}
        </td>
        <td>{{ gi.capacity or '-' }} {{ gi.capacity_unit or '' }}</td>
        <td>{{ 'Yes' if gi.default_is_perishable else 'No' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Item Detail Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="globalItemDetail" aria-labelledby="globalItemDetailLabel">
  <div class="offcanvas-header">
    <h5 id="globalItemDetailLabel">Global Item</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="giDetailLoading" class="text-center">Loading...</div>
    <div id="giDetailContent" style="display:none;">
      <div class="mb-2"><strong>Name:</strong> <span id="giName"></span></div>
      <div class="mb-2"><strong>Type:</strong> <span id="giType"></span></div>
      <div class="mb-2"><strong>Category:</strong> <span id="giCategory"></span></div>
      <div class="mb-2"><strong>Default Unit:</strong> <span id="giUnit"></span></div>
      <div class="mb-2"><strong>Density:</strong> <span id="giDensity"></span></div>
      <div class="mb-2"><strong>Capacity:</strong> <span id="giCapacity"></span></div>
      <div class="mb-2"><strong>Perishable:</strong> <span id="giPerishable"></span></div>
      <div class="mb-2"><strong>Shelf Life:</strong> <span id="giShelfLife"></span></div>
      <div id="giAliases" class="mb-2" style="display:none;"><strong>Also known as:</strong> <span id="giAliasText"></span></div>
      <hr>
      <h6>Community Usage Statistics</h6>
      <div id="giCostStats">Loading...</div>
      <small class="text-muted">Based on user inventory data across all organizations.</small>
      <hr>
      <div id="giAdoption">
        <h6>Adoption Metrics</h6>
        <div><strong>Organizations using:</strong> <span id="giOrgCount">-</span></div>
        <div><strong>Total inventory items:</strong> <span id="giItemCount">-</span></div>
      </div>
    </div>
  </div>
  <div class="offcanvas-footer p-3 border-top">
    <div class="d-flex justify-content-end gap-2">
      <a id="giDevLink" href="#" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" style="display:none;">Developer Details</a>
      <a id="giStoreLink" href="#" class="btn btn-sm btn-primary disabled" tabindex="-1" aria-disabled="true" style="display:none;">Store (coming soon)</a>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
  const url = new URL(window.location);
  const type = document.getElementById('typeFilter').value;
  const category = document.getElementById('categoryFilter').value;
  const search = document.getElementById('searchInput').value;

  if (search.trim()) { url.searchParams.set('search', search.trim()); } else { url.searchParams.delete('search'); }
  if (type) { url.searchParams.set('type', type); } else { url.searchParams.delete('type'); }
  if (category && type === 'ingredient') { url.searchParams.set('category', category); } else { url.searchParams.delete('category'); }

  window.location.href = url.toString();
}

function handleSearchKeyup(event) {
  if (event.key === 'Enter') {
    applyFilters();
  } else {
    if (window.searchTimeout) clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(applyFilters, 400);
  }
}

function clearFilters() {
  window.location.href = window.location.pathname;
}

document.addEventListener('DOMContentLoaded', function(){
  const typeFilter = document.getElementById('typeFilter');
  const categoryDiv = document.getElementById('categoryFilterDiv');
  const categorySelect = document.getElementById('categoryFilter');
  const updateCategoryVisibility = function(){
    if (typeFilter.value === 'ingredient') {
      categoryDiv.style.display = '';
      categorySelect.disabled = false;
    } else {
      categoryDiv.style.display = 'none';
      categorySelect.disabled = true;
      categorySelect.value = '';
    }
  };
  typeFilter.addEventListener('change', updateCategoryVisibility);
  updateCategoryVisibility();
});

async function openItemDetails(id){
  try {
    const offcanvasEl = document.getElementById('globalItemDetail');
    const oc = new bootstrap.Offcanvas(offcanvasEl);
    document.getElementById('giDetailLoading').style.display = '';
    document.getElementById('giDetailContent').style.display = 'none';
    oc.show();

    // Fetch item details from the public API
    const [itemRes, statsRes, adoptionRes] = await Promise.all([
      fetch(`/global-items/${id}`),
      fetch(`/global-items/${id}/stats`),
      fetch(`/api/global-items/${id}/adoption`)
    ]);

    const itemData = await itemRes.json();
    const stats = await statsRes.json();
    const adoption = adoptionRes.ok ? await adoptionRes.json() : { success: false };

    if (itemData.success) {
      const item = itemData.item;
      
      // Populate basic item info
      document.getElementById('giName').textContent = item.name;
      document.getElementById('giType').textContent = item.item_type.charAt(0).toUpperCase() + item.item_type.slice(1);
      document.getElementById('giCategory').textContent = item.category_name || '-';
      document.getElementById('giUnit').textContent = item.default_unit || '-';
      document.getElementById('giDensity').textContent = item.density ? `${item.density.toFixed(3)} g/ml` : '-';
      document.getElementById('giCapacity').textContent = item.capacity ? `${item.capacity} ${item.capacity_unit || 'units'}` : '-';
      document.getElementById('giPerishable').textContent = item.default_is_perishable ? 'Yes' : 'No';
      document.getElementById('giShelfLife').textContent = item.recommended_shelf_life_days ? `${item.recommended_shelf_life_days} days` : '-';
      
      // Show aliases if they exist
      if (item.aka_names && item.aka_names.length > 0) {
        document.getElementById('giAliasText').textContent = item.aka_names.join(', ');
        document.getElementById('giAliases').style.display = '';
      } else {
        document.getElementById('giAliases').style.display = 'none';
      }
    }

    // Populate stats
    if (stats && stats.success){
      const rollup = stats.rollup || {};
      const cost = stats.cost || {};
      
      let statsHtml = '';
      if (rollup.average_cost_per_unit) {
        statsHtml += `<div><strong>Average Cost:</strong> $${rollup.average_cost_per_unit.toFixed(3)}/unit</div>`;
      }
      if (rollup.average_stock_age_days) {
        statsHtml += `<div><strong>Average Stock Age:</strong> ${Math.round(rollup.average_stock_age_days)} days</div>`;
      }
      if (rollup.average_expired_quantity) {
        statsHtml += `<div><strong>Average Expired Quantity:</strong> ${rollup.average_expired_quantity.toFixed(2)}</div>`;
      }
      
      // Cost distribution
      if (cost.count && cost.count > 0){
        const mean = cost.mean_ex_outliers != null ? cost.mean_ex_outliers.toFixed(2) : '-';
        const low = cost.low != null ? cost.low.toFixed(2) : '-';
        const high = cost.high != null ? cost.high.toFixed(2) : '-';
        const minv = cost.min != null ? cost.min.toFixed(2) : '-';
        const maxv = cost.max != null ? cost.max.toFixed(2) : '-';
        if (statsHtml) statsHtml += '<hr>';
        statsHtml += `<strong>Price Range:</strong><br>Average: $${mean}<br>Range: $${low} - $${high}<br>Extremes: $${minv} - $${maxv}<br><small>(${cost.count} data points)</small>`;
      }
      
      document.getElementById('giCostStats').innerHTML = statsHtml || 'No usage data yet.';
    } else {
      document.getElementById('giCostStats').textContent = 'No usage data yet.';
    }

    // Populate adoption metrics
    if (adoption.success) {
      document.getElementById('giOrgCount').textContent = adoption.organization_count || '0';
      document.getElementById('giItemCount').textContent = adoption.inventory_item_count || '0';
    }

    // Show developer link if available
    const devLink = document.getElementById('giDevLink');
    if (devLink) {
      devLink.href = `/developer/global-items/${id}`;
      devLink.style.display = '';
    }

    document.getElementById('giDetailLoading').style.display = 'none';
    document.getElementById('giDetailContent').style.display = '';
  } catch (e) {
    console.error('Failed to load item details', e);
    document.getElementById('giDetailLoading').style.display = 'none';
    document.getElementById('giCostStats').textContent = 'Error loading item details.';
    document.getElementById('giDetailContent').style.display = '';
  }
}
</script>
{% endblock %}

