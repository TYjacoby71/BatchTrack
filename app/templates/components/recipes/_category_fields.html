<div class="card mb-4" id="categorySpecificCard" style="display:none;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-sliders-h"></i> Category Aids
    </h5>
  </div>
  <div class="card-body">
    <!-- Soap: lye and water calculators summary fields -->
    <div data-cat="Soaps" class="category-aid d-none">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small">Superfat (%)</label>
          <input type="number" class="form-control" id="soap_superfat" name="soap_superfat" placeholder="e.g., 5" min="0" max="20" step="0.1">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Water (% of oils)</label>
          <input type="number" class="form-control" id="soap_water_pct" name="soap_water_pct" placeholder="e.g., 33" min="10" max="50" step="0.1">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Lye Type</label>
          <select id="soap_lye_type" name="soap_lye_type" class="form-select">
            <option value="NaOH">NaOH</option>
            <option value="KOH">KOH</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Lye (g)</label>
          <input type="number" class="form-control" id="soap_lye_g" name="soap_lye_g" placeholder="auto" min="0" step="0.01">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Water:Lye Ratio</label>
          <input type="number" class="form-control" id="soap_ratio" name="soap_ratio" placeholder="e.g., 2.3" min="0" step="0.01">
        </div>
      </div>
      <small class="text-muted">Detailed per-oil SAP handled in Global Library; this is an aid.</small>
    </div>

    <!-- Candles: fragrance load -->
    <div data-cat="Candles" class="category-aid d-none">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small">Fragrance Load (%)</label>
          <input type="number" class="form-control" id="candle_fragrance_pct" name="candle_fragrance_pct" placeholder="e.g., 8" min="0" max="20" step="0.1">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Vessel Volume (ml)</label>
          <input type="number" class="form-control" id="candle_vessel_ml" name="candle_vessel_ml" placeholder="e.g., 240" min="0" step="1">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Vessel Fill (%)</label>
          <input type="number" class="form-control" id="candle_fill_pct" name="candle_fill_pct" placeholder="e.g., 90" min="1" max="100" step="0.1">
        </div>
      </div>
      <small class="text-muted">Advanced wick/vessel guidance coming soon.</small>
    </div>

    <!-- Cosmetics/Lotions: phases -->
    <div data-cat="Cosmetics" class="category-aid d-none">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small">Preservative (%)</label>
          <input type="number" class="form-control" id="cosm_preservative_pct" name="cosm_preservative_pct" placeholder="e.g., 0.8" min="0" max="5" step="0.1">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Emulsifier (%)</label>
          <input type="number" class="form-control" id="cosm_emulsifier_pct" name="cosm_emulsifier_pct" placeholder="e.g., 6" min="0" max="20" step="0.1">
        </div>
      </div>
      <small class="text-muted">Phase breakdown UI planned; using summary % for now.</small>
    </div>

    <!-- Baked Goods: baker's % -->
    <div data-cat="Baked Goods" class="category-aid d-none">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small">Flour (g)</label>
          <input type="number" class="form-control" id="baker_base_flour_g" name="baker_base_flour_g" placeholder="e.g., 1000" min="0" step="1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Water (%)</label>
          <input type="number" class="form-control" id="baker_water_pct" name="baker_water_pct" placeholder="e.g., 70" min="0" max="120" step="0.1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Salt (%)</label>
          <input type="number" class="form-control" id="baker_salt_pct" name="baker_salt_pct" placeholder="e.g., 2" min="0" max="5" step="0.1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Yeast (%)</label>
          <input type="number" class="form-control" id="baker_yeast_pct" name="baker_yeast_pct" placeholder="e.g., 1" min="0" max="5" step="0.1">
        </div>
      </div>
      <div class="mt-2 small text-muted" id="baker_result"></div>
      <small class="text-muted">Bakerâ€™s %: Flour = 100%. Enter any fields to derive batch size.</small>
    </div>

    <!-- Herbalist: tincture ratio -->
    <div data-cat="Herbal" class="category-aid d-none">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small">Tincture Ratio (g:ml)</label>
          <input type="text" class="form-control" id="herbal_ratio" name="herbal_ratio" placeholder="e.g., 1:5">
        </div>
      </div>
      <small class="text-muted">Basic ratio helper; full herbal profiles later.</small>
    </div>
  </div>
</div>

<script>
(function(){
  const categorySelect = document.getElementById('category_id');
  const card = document.getElementById('categorySpecificCard');
  const predictedYield = document.getElementById('predicted_yield');
  const predictedYieldUnit = document.getElementById('predicted_yield_unit');
  function applyUnitStepUp(total){
    if (!predictedYieldUnit || predictedYieldUnit.dataset.userChanged === 'true') return;
    const unit = (predictedYieldUnit.value||'').toLowerCase();
    if (!isFinite(total) || total<=0) return;
    // Weight defaults
    if (unit === '' || unit === 'gram' || unit === 'g'){
      if (total >= 2000 && hasOption('kg')) predictedYieldUnit.value = 'kg';
      return;
    }
    if (unit === 'oz'){
      if (total >= 32 && hasOption('lb')) predictedYieldUnit.value = 'lb';
      return;
    }
    // Volume defaults
    if (unit === 'ml'){
      if (total >= 1000 && hasOption('liter')) predictedYieldUnit.value = 'liter';
      return;
    }
    function hasOption(name){
      return Array.from(predictedYieldUnit.options||[]).some(o => (o.value||'').toLowerCase() === name);
    }
  }
  function currentCategory(){
    if (categorySelect) {
      return categorySelect.options[categorySelect.selectedIndex]?.text?.trim() || '';
    }
    if (window && window.RECIPE_CATEGORY_NAME) {
      return String(window.RECIPE_CATEGORY_NAME);
    }
    return '';
  }
  function round(v){ return Math.round(v*1000)/1000 }
  function deriveSoap(){
    const oil = parseFloat(document.getElementById('soap_oil_g')?.value||'0');
    const sf = parseFloat(document.getElementById('soap_superfat')?.value||'0');
    const lyeType = document.getElementById('soap_lye_type')?.value||'NaOH';
    const waterPctVal = parseFloat(document.getElementById('soap_water_pct')?.value||'0');
    const lyeInput = parseFloat(document.getElementById('soap_lye_g')?.value||'');
    const ratioInput = parseFloat(document.getElementById('soap_ratio')?.value||'');
    if (!(oil>0)) return;
    const SAP_NAOH = 0.138, SAP_KOH = 0.194; // average defaults
    let lye = isFinite(lyeInput) ? lyeInput : ( (lyeType==='KOH'? SAP_KOH: SAP_NAOH) * oil * (1 - sf/100) );
    let water;
    if (isFinite(ratioInput) && ratioInput>0){ water = lye * ratioInput; }
    else if (isFinite(waterPctVal) && waterPctVal>0){ water = oil * (waterPctVal/100); }
    else { water = oil * 0.33; }
    const ratio = lye>0 ? (water/lye) : '';
    if (!isFinite(lyeInput)) {
      const lyeEl = document.getElementById('soap_lye_g');
      if (lyeEl) lyeEl.value = String(round(lye));
    }
    if (!isFinite(ratioInput)){
      const rEl = document.getElementById('soap_ratio');
      if (rEl) rEl.value = String(round(ratio));
    }
    if (predictedYield){ const total = oil + water + lye; predictedYield.value = String(round(total)); applyUnitStepUp(total); }
    if (predictedYieldUnit && !predictedYieldUnit.value){ predictedYieldUnit.value = 'gram'; }
  }
  function deriveBaking(){
    const flour = parseFloat(document.getElementById('baker_base_flour_g')?.value||'');
    const wp = parseFloat(document.getElementById('baker_water_pct')?.value||'');
    const sp = parseFloat(document.getElementById('baker_salt_pct')?.value||'');
    const yp = parseFloat(document.getElementById('baker_yeast_pct')?.value||'');
    if (!(flour>0)) { document.getElementById('baker_result').textContent = ''; return; }
    const waterG = isFinite(wp)? flour*(wp/100):0;
    const saltG = isFinite(sp)? flour*(sp/100):0;
    const yeastG = isFinite(yp)? flour*(yp/100):0;
    const total = flour + waterG + saltG + yeastG;
    const res = document.getElementById('baker_result');
    if (res) res.textContent = `Water ${round(waterG)} g, Salt ${round(saltG)} g, Yeast ${round(yeastG)} g. Total ${round(total)} g`;
    if (predictedYield){ predictedYield.value = String(round(total)); applyUnitStepUp(total); }
    if (predictedYieldUnit && !predictedYieldUnit.value){ predictedYieldUnit.value = 'gram'; }
  }
  function syncAids(){
    const selected = currentCategory();
    const aids = document.querySelectorAll('.category-aid');
    let any=false;
    aids.forEach(div => {
      const match = (div.getAttribute('data-cat')||'').toLowerCase();
      const on = selected && match && selected.toLowerCase().includes(match);
      div.classList.toggle('d-none', !on);
      any = any || on;
    });
    if (card) card.style.display = any ? 'block' : 'none';
    // Recalculate when soap is visible
    if (selected.toLowerCase().includes('soap')) deriveSoap();
  }
  if (categorySelect){
    categorySelect.addEventListener('change', syncAids);
  }
  // Wire soap inputs for live derivation
  ['soap_oil_g','soap_superfat','soap_lye_type','soap_water_pct','soap_lye_g','soap_ratio'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){ el.addEventListener('input', deriveSoap); }
  });
  // Wire baking inputs
  ['baker_base_flour_g','baker_water_pct','baker_salt_pct','baker_yeast_pct'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){ el.addEventListener('input', deriveBaking); }
  });
  // If user changes the yield unit, freeze unit auto step-up
  if (predictedYieldUnit){ predictedYieldUnit.addEventListener('change', ()=>{ predictedYieldUnit.dataset.userChanged = 'true'; }); }
  syncAids();
})();
</script>
