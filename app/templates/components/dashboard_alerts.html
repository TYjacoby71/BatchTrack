
<!-- Unified Alert System -->
{% if alert_data.alerts %}
<div class="alert-container mb-4" id="alertContainer">
  {% for alert in alert_data.alerts %}
    <div class="alert alert-{{ 'danger' if alert.priority == 'CRITICAL' else 'warning' if alert.priority == 'HIGH' else 'info' }} 
                alert-dismissible fade show" 
         data-alert-type="{{ alert.type }}"
         id="alert-{{ alert.type }}">

      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h6 class="alert-heading mb-1">
            {% if alert.priority == 'CRITICAL' %}üö®{% elif alert.priority == 'HIGH' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}
            {{ alert.title }}
          </h6>
          <p class="mb-2">{{ alert.message }}</p>

          {% if alert.action_url %}
          <a href="{{ alert.action_url }}" class="btn btn-sm btn-outline-{{ 'danger' if alert.priority == 'CRITICAL' else 'warning' if alert.priority == 'HIGH' else 'info' }}">
            {{ alert.action_text }}
          </a>
          {% endif %}
        </div>

        {% if alert.dismissible %}
        <button type="button" class="btn-close" aria-label="Close"
                onclick="dismissAlert('{{ alert.type }}', this.closest('.alert'))"></button>
        {% endif %}
      </div>
    </div>
  {% endfor %}

  {% if alert_data.hidden_count > 0 %}
  <div class="alert alert-light text-center">
    <small class="text-muted">
      {{ alert_data.hidden_count }} more alerts available. 
      <a href="/settings" class="btn btn-sm btn-outline-secondary ms-2 text-decoration-none">
        Adjust alert settings
      </a>
    </small>
  </div>
  {% endif %}
</div>

<script>
let dismissedAlertsForSession = [];

function dismissAlert(alertType, alertElement) {
    if (!alertType || !alertElement) return;
    
    // Add to session dismissed list
    if (!dismissedAlertsForSession.includes(alertType)) {
        dismissedAlertsForSession.push(alertType);
    }
    
    // Hide the alert with animation
    alertElement.classList.remove('show');
    setTimeout(() => {
        if (alertElement.parentNode) {
            alertElement.remove();
        }
    }, 150);
    
    // Send dismiss request to server
    fetch('/api/dismiss-alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ alert_type: alertType })
    }).catch(error => {
        console.error('Failed to dismiss alert:', error);
    });
}

async function refreshDashboardAlerts() {
    try {
        const response = await fetch('/api/dashboard-alerts', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
            }
        });
        if (response.ok) {
            const alertData = await response.json();
            updateAlertContainer(alertData);
        } else {
            console.error('Failed to refresh alerts - response not ok');
        }
    } catch (error) {
        console.error('Error refreshing alerts:', error);
    }
}

function updateAlertContainer(alertData) {
    const container = document.getElementById('alertContainer');
    if (!container) return;

    // Only update if there are new alerts to show
    if (alertData.alerts && alertData.alerts.length > 0) {
        // Check if any alerts are already shown
        const currentAlerts = container.querySelectorAll('.alert[data-alert-type]');
        const currentTypes = Array.from(currentAlerts).map(el => el.dataset.alertType);
        const newTypes = alertData.alerts.map(alert => alert.type);

        // Add new alerts that aren't currently displayed
        alertData.alerts.forEach(alert => {
            if (!currentTypes.includes(alert.type)) {
                addAlertToContainer(alert, container);
            }
        });
    }
}

function addAlertToContainer(alert, container) {
    const priorityClass = alert.priority === 'CRITICAL' ? 'danger' : 
                         alert.priority === 'HIGH' ? 'warning' : 'info';
    
    const alertHtml = `
        <div class="alert alert-${priorityClass} alert-dismissible fade show" 
             data-alert-type="${alert.type}"
             id="alert-${alert.type}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1">
                        ${alert.priority === 'CRITICAL' ? 'üö®' : alert.priority === 'HIGH' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                        ${alert.title}
                    </h6>
                    <p class="mb-2">${alert.message}</p>
                    ${alert.action_url ? `<a href="${alert.action_url}" class="btn btn-sm btn-outline-${priorityClass}">${alert.action_text}</a>` : ''}
                </div>
                ${alert.dismissible ? `<button type="button" class="btn-close" aria-label="Close" onclick="dismissAlert('${alert.type}', this.closest('.alert'))"></button>` : ''}
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', alertHtml);
}

// Auto-refresh alerts every 5 minutes
setInterval(refreshDashboardAlerts, 300000);
</script>
{% endif %}
