
<!-- Dashboard Alerts Component -->
<div class="alert-container" id="dashboard-alerts-container">
  <!-- This will be populated by JavaScript -->
</div>

<script>
let dismissedAlertsForSession = [];

function dismissAlert(alertType, alertElement) {
    if (!alertType || !alertElement) return;
    
    // Add to session dismissed list
    if (!dismissedAlertsForSession.includes(alertType)) {
        dismissedAlertsForSession.push(alertType);
    }
    
    // Hide the alert with animation
    alertElement.classList.remove('show');
    setTimeout(() => {
        if (alertElement.parentNode) {
            alertElement.remove();
        }
    }, 150);
    
    // Send dismiss request to server
    fetch('/api/dismiss-alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ alert_type: alertType })
    }).catch(error => {
        console.error('Failed to dismiss alert:', error);
    });
}

async function refreshDashboardAlerts() {
    try {
        const response = await fetch('/api/dashboard-alerts', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
            }
        });
        
        if (response.ok) {
            const alertData = await response.json();
            updateAlertContainer(alertData);
        } else {
            console.error('Failed to refresh alerts - response not ok:', response.status);
        }
    } catch (error) {
        console.error('Error refreshing dashboard alerts:', error);
    }
}

function updateAlertContainer(alertData) {
    const container = document.getElementById('dashboard-alerts-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (alertData.success && alertData.alerts && alertData.alerts.length > 0) {
        alertData.alerts.forEach(alert => {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${getPriorityClass(alert.priority)} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="fas fa-${getPriorityIcon(alert.priority)} me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <strong>${alert.title}</strong>
                        <div>${alert.message}</div>
                        ${alert.action_url ? `<a href="${alert.action_url}" class="btn btn-sm btn-outline-${getPriorityClass(alert.priority)} mt-2">${alert.action_text || 'View'}</a>` : ''}
                    </div>
                    ${alert.dismissible ? `<button type="button" class="btn-close" onclick="dismissAlert('${alert.type}', this.closest('.alert'))"></button>` : ''}
                </div>
            `;
            container.appendChild(alertDiv);
        });
        
        // Show hidden count if applicable
        if (alertData.hidden_count > 0) {
            const hiddenDiv = document.createElement('div');
            hiddenDiv.className = 'alert alert-light text-center';
            hiddenDiv.innerHTML = `
                <small class="text-muted">
                    ${alertData.hidden_count} more alerts available. 
                    <a href="/settings" class="btn btn-sm btn-outline-secondary ms-2 text-decoration-none">
                        Adjust alert settings
                    </a>
                </small>
            `;
            container.appendChild(hiddenDiv);
        }
    }
}

function getPriorityClass(priority) {
    switch(priority) {
        case 'CRITICAL': return 'danger';
        case 'HIGH': return 'warning';
        case 'MEDIUM': return 'info';
        case 'LOW': return 'light';
        default: return 'secondary';
    }
}

function getPriorityIcon(priority) {
    switch(priority) {
        case 'CRITICAL': return 'exclamation-triangle';
        case 'HIGH': return 'exclamation-circle';
        case 'MEDIUM': return 'info-circle';
        case 'LOW': return 'bell';
        default: return 'bell';
    }
}

// Load alerts when page loads
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboardAlerts();
});

// Refresh alerts every 5 minutes
setInterval(refreshDashboardAlerts, 5 * 60 * 1000);
</script>
</div>
