<div x-data="{ 
  showTimerForm: false,
  showTimerList: true,
  name: '',
  hours: '',
  minutes: '',
  statusMessage: '',
  showStatus: false,
  statusType: 'success',
  seconds: '',
  csrfToken: document.querySelector('input[name=csrf_token]').value,
  calculateTotalSeconds() {
    return (parseInt(this.hours || 0) * 3600) + 
           (parseInt(this.minutes || 0) * 60) + 
           parseInt(this.seconds || 0);
  },
  async createTimer() {
    const totalSeconds = this.calculateTotalSeconds();
    if (totalSeconds < 1) {
      alert('Please enter a valid duration');
      return;
    }

    const response = await fetch('/timers/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.csrfToken
      },
      body: JSON.stringify({
        name: this.name,
        batch_id: {{ batch.id }},
        duration_seconds: totalSeconds
      })
    });

    const result = await response.json();
    if (result.status === 'success') {
      this.statusType = 'success';
      this.statusMessage = 'Timer created successfully!';
      this.showStatus = true;
      setTimeout(() => {
        this.showStatus = false;
        window.location.reload();
      }, 1000);
    } else {
      this.statusType = 'danger';
      this.statusMessage = 'Failed to create timer';
      this.showStatus = true;
      setTimeout(() => this.showStatus = false, 3000);
    }
  }
}">
  <div x-show="showStatus" x-transition.duration.500ms class="alert" :class="statusType === 'success' ? 'alert-success' : 'alert-danger'" x-text="statusMessage"></div>
<div class="d-flex align-items-center gap-2">
    <button type="button" @click="showTimerForm = !showTimerForm" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-plus"></i> Add Timer
    </button>
  </div>

  <div x-show="showTimerList" class="mt-3" x-transition>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Label</th>
            <th>Duration</th>
            <th>Time Left</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if timers %}
            {% for timer in timers %}
            <tr>
              <td>{{ timer.name or 'Timer' }}</td>
              <td>{{ (timer.duration_seconds // 60) }}:{{ '%02d'|format(timer.duration_seconds % 60) }}</td>
              <td>
                {% if timer.start_time %}
                  {% if timer.status == 'completed' %}
                    {% if timer.end_time and (timer.end_time - timer.start_time).total_seconds() < timer.duration_seconds %}
                      User Ended
                    {% else %}
                      Expired
                    {% endif %}
                  {% else %}
                    {% set remaining_seconds = ((timer.start_time + timedelta(seconds=timer.duration_seconds)) - now).total_seconds()|int %}
                    {% if remaining_seconds <= 0 %}
                      Expired
                    {% else %}
                      {{ (remaining_seconds // 60) }}:{{ '%02d'|format(remaining_seconds % 60) }}
                    {% endif %}
                  {% endif %}
                {% else %}
                  Not Started
                {% endif %}
              </td>
              <td>
                {% if timer.status == 'active' %}
                  {% set remaining_seconds = ((timer.start_time + timedelta(seconds=timer.duration_seconds)) - now).total_seconds()|int %}
                  {% if remaining_seconds <= 0 %}
                    <span class="badge bg-danger">Expired</span>
                  {% else %}
                    <span class="badge bg-success">Active</span>
                  {% endif %}
                {% elif timer.status == 'completed' %}
                  <span class="badge bg-secondary">Completed</span>
                {% else %}
                  <span class="badge bg-warning">{{ timer.status|title }}</span>
                {% endif %}
              </td>
              <td>
                {% if timer.status == 'active' %}
                  <button class="btn btn-sm btn-success me-1" onclick="completeTimer({{ timer.id }})">Complete</button>
                {% endif %}
                <button class="btn btn-sm btn-danger" onclick="deleteTimer({{ timer.id }})">Delete</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No timers found for this batch
                {% if batch %}
                  <small class="d-block text-muted">Batch ID: {{ batch.id }}, Org: {{ batch.organization_id }}</small>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div x-show="showTimerForm" class="card mt-3">
    <div class="card-body">
      <div class="timer-form">
        <div class="mb-3">
          <label class="form-label">Timer Label</label>
          <input type="text" class="form-control" x-model="name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (H:M:S)</label>
          <div class="d-flex gap-2">
            <input type="number" class="form-control" x-model="hours" placeholder="H" min="0">
            <input type="number" class="form-control" x-model="minutes" placeholder="M" min="0">
            <input type="number" class="form-control" x-model="seconds" placeholder="S" min="0">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" @click="createTimer" class="btn btn-success">Create Timer</button>
          <button type="button" @click="showTimerForm = false" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>