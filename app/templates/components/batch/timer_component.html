
<div x-data="{ 
  showTimerForm: false,
  showTimerList: true,
  name: '',
  hours: '',
  minutes: '',
  statusMessage: '',
  showStatus: false,
  statusType: 'success',
  seconds: '',
  csrfToken: document.querySelector('input[name=csrf_token]').value,
  calculateTotalSeconds() {
    return (parseInt(this.hours || 0) * 3600) + 
           (parseInt(this.minutes || 0) * 60) + 
           parseInt(this.seconds || 0);
  },
  async createTimer() {
    const totalSeconds = this.calculateTotalSeconds();
    if (totalSeconds < 1) {
      alert('Please enter a valid duration');
      return;
    }

    const response = await fetch('/timers/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.csrfToken
      },
      body: JSON.stringify({
        name: this.name,
        batch_id: {{ batch.id }},
        duration_seconds: totalSeconds
      })
    });

    const result = await response.json();
    if (result.status === 'success') {
      this.statusType = 'success';
      this.statusMessage = 'Timer created successfully!';
      this.showStatus = true;
      setTimeout(() => {
        this.showStatus = false;
        window.location.reload();
      }, 1000);
    } else {
      this.statusType = 'danger';
      this.statusMessage = 'Failed to create timer';
      this.showStatus = true;
      setTimeout(() => this.showStatus = false, 3000);
    }
  }
}">
  <div x-show="showStatus" x-transition.duration.500ms class="alert" :class="statusType === 'success' ? 'alert-success' : 'alert-danger'" x-text="statusMessage"></div>
<div class="d-flex align-items-center gap-2">
    <button type="button" @click="showTimerForm = !showTimerForm" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-plus"></i> Add Timer
    </button>
  </div>

  <div x-show="showTimerList" class="mt-3" x-transition>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Label</th>
            <th>Duration</th>
            <th>Time Left</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for timer in timers %}
          {% if timer.batch_id == batch.id and timer.status in ['active', 'completed'] %}
          <tr>
            <td>{{ timer.name }}</td>
            <td>{{ timer.duration_seconds // 60 }}m {{ timer.duration_seconds % 60 }}s</td>
            <td>
              {% if timer.start_time %}
                {% if timer.status == 'completed' %}
                  {% if timer.end_time and (timer.end_time - timer.start_time).total_seconds() < timer.duration_seconds %}
                    User Ended
                  {% else %}
                    Expired
                  {% endif %}
                {% else %}
                  {{ ((timer.start_time + timedelta(seconds=timer.duration_seconds)) - now).total_seconds()|int }}s
                {% endif %}
              {% else %}
                Not Started
              {% endif %}
            </td>
            <td>
              <span class="badge {% if timer.status == 'completed' %}bg-success{% else %}bg-primary{% endif %}">
                {{ timer.status|title }}
              </span>
            </td>
            <td>
              {% if timer.status != 'completed' %}
              <form method="POST" action="{{ safe_url_for('timers.complete_timer', timer_id=timer.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-success">Complete</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div x-show="showTimerForm" class="card mt-3">
    <div class="card-body">
      <div class="timer-form">
        <div class="mb-3">
          <label class="form-label">Timer Label</label>
          <input type="text" class="form-control" x-model="name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (H:M:S)</label>
          <div class="d-flex gap-2">
            <input type="number" class="form-control" x-model="hours" placeholder="H" min="0">
            <input type="number" class="form-control" x-model="minutes" placeholder="M" min="0">
            <input type="number" class="form-control" x-model="seconds" placeholder="S" min="0">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" @click="createTimer" class="btn btn-success">Create Timer</button>
          <button type="button" @click="showTimerForm = false" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>
