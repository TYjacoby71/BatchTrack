<script>
// Global variables
let containerBreakdown = [];
let allowedContainers = [];

// Load variants when product is selected
function loadVariants() {
  const productSelect = document.getElementById('product_id');
  const variantSelect = document.getElementById('variant_id');

  if (!productSelect || !variantSelect) {
    console.log('Product or variant dropdown not found');
    return;
  }

  const productId = productSelect.value;
  console.log('Loading variants for product ID:', productId);

  // Reset variant dropdown
  variantSelect.innerHTML = '<option value="">Loading variants...</option>';
  variantSelect.disabled = true;

  if (!productId) {
    variantSelect.innerHTML = '<option value="">Select product first...</option>';
    return;
  }

  // Fetch variants from API
  fetch(`/products/${productId}/variants`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'success') {
      variantSelect.innerHTML = '';

      if (data.variants && data.variants.length > 0) {
        data.variants.forEach(variant => {
          const option = document.createElement('option');
          option.value = variant.id;
          option.textContent = variant.name;
          variantSelect.appendChild(option);
        });
        variantSelect.disabled = false;
      } else {
        variantSelect.innerHTML = '<option value="">No variants available</option>';
      }
    } else {
      throw new Error(data.message || 'Failed to load variants');
    }
  })
  .catch(error => {
    console.error('Error loading variants:', error);
    variantSelect.innerHTML = '<option value="">Error loading variants</option>';
  });
}

// Load container breakdown from API
function loadContainers() {
  const batchId = getCurrentBatchId();
  if (!batchId) return;

  fetch(`/api/containers/available/${batchId}`)
    .then(response => response.json())
    .then(data => {
      console.log('Container API response:', data);
      if (data.available) {
        allowedContainers = data.available;
        console.log('Allowed containers:', allowedContainers);
        updateContainerSummary();
      }
    })
    .catch(error => {
      console.error('Error loading containers:', error);
    });
}

function toggleShelfLife() {
  const isPerishable = document.getElementById('is_perishable');
  const shelfLifeField = document.getElementById('shelfLifeField');

  if (isPerishable && shelfLifeField) {
    const showShelfLife = isPerishable.checked;
    shelfLifeField.style.display = showShelfLife ? 'block' : 'none';

    const shelfLifeInput = document.getElementById('shelf_life_days');
    if (shelfLifeInput) {
      shelfLifeInput.required = showShelfLife;
      if (!showShelfLife) {
        shelfLifeInput.value = '';
        const expDateInput = document.getElementById('expiration_date');
        const expDateDisplay = document.getElementById('expiration_date_display');
        if (expDateInput) expDateInput.value = '';
        if (expDateDisplay) expDateDisplay.value = '';
      }
    }
  }
}

function validateYield() {
  const finalQuantityInput = document.getElementById('final_quantity');
  const alertsContainer = document.getElementById('yield-validation-alerts');
  const hasContainers = false;

  if (!finalQuantityInput) {
    return;
  }

  const finalQuantity = parseFloat(finalQuantityInput.value);

  if (!finalQuantity || finalQuantity <= 0) {
    if (alertsContainer) {
      alertsContainer.innerHTML = '';
    }
    updateContainerSummary();
    return;
  }

  // Update display with current yield
  const finalYieldDisplay = document.getElementById('finalYieldDisplay');
  if (finalYieldDisplay) {
    finalYieldDisplay.textContent = finalQuantity.toFixed(2);
  }

  if (!hasContainers) {
    console.log('No containers in batch - all yield goes to bulk');
    updateUncontainedYield(finalQuantity);
    return;
  }

  // Update container summary
  updateContainerSummary();
}

function updateContainerTable(containers, finalQuantity) {
  const tbody = document.getElementById('containerTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  containers.forEach(container => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${container.name}</td>
      <td>${container.storage_amount} ${container.storage_unit}</td>
      <td>${container.quantity_used || 0}</td>
      <td>${(container.quantity_used || 0) * container.storage_amount} ${container.storage_unit}</td>
    `;
    tbody.appendChild(row);
  });

  updateContainerSummary();
}

function updateContainerSummary() {
  // Update container summary display
  const summaryElement = document.getElementById('container-summary');
  if (summaryElement) {
    // Calculate totals from container table
    const tbody = document.getElementById('containerTableBody');
    if (tbody) {
      const rows = tbody.querySelectorAll('tr');
      let totalContainers = 0;
      let totalVolume = 0;

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
          totalContainers += parseInt(cells[2].textContent) || 0;
          totalVolume += parseFloat(cells[3].textContent) || 0;
        }
      });

      summaryElement.innerHTML = `
        <strong>Container Summary:</strong> ${totalContainers} containers, ${totalVolume.toFixed(2)} total volume
      `;
    }
  }
}

function updateUncontainedYield(finalQuantity) {
  const uncontainedDisplay = document.getElementById('uncontained-yield-display');
  if (uncontainedDisplay) {
    uncontainedDisplay.textContent = `${finalQuantity.toFixed(2)} bulk units`;
  }
}

// Utility functions
function getCurrentBatchId() {
  if (window.currentBatchId) {
    return window.currentBatchId;
  }

  const pathParts = window.location.pathname.split('/');
  return pathParts[pathParts.length - 1];
}

function getCSRFToken() {
  const token = document.querySelector('input[name="csrf_token"]')?.value ||
                document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  return token || '';
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Set up event listeners
  const isPerishableCheckbox = document.getElementById('is_perishable');
  if (isPerishableCheckbox) {
    isPerishableCheckbox.addEventListener('change', toggleShelfLife);
    // Initialize state
    toggleShelfLife();
  }

  const finalQuantityInput = document.getElementById('final_quantity');
  if (finalQuantityInput) {
    finalQuantityInput.addEventListener('input', validateYield);
    finalQuantityInput.addEventListener('change', validateYield);
    // Initialize
    validateYield();
  }

  const modal = document.getElementById('finishBatchModal');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function () {
      console.log('Modal opened, initializing...');

      // Load variants if product fields exist
      const productSelect = document.getElementById('product_id');
      if (productSelect) {
        loadVariants();
      }

      // Load container data if needed
      loadContainers();

      // Add event listeners to container inputs
      const containerInputs = document.querySelectorAll('.container-final-input');
      containerInputs.forEach(input => {
        input.addEventListener('input', updateContainerSummary);
      });
    });
  }
});
</script>