<script>
// Finish Batch Modal JavaScript Functions

function updateExpirationDate() {
  const shelfLifeElement = document.getElementById('shelf_life_days');
  if (!shelfLifeElement) return;

  const shelfLife = shelfLifeElement.value;
  if (shelfLife && parseInt(shelfLife) > 0) {
    const expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + parseInt(shelfLife));
    const dateString = expirationDate.toISOString().split('T')[0];

    const expDateElement = document.getElementById('expiration_date');
    const expDateDisplayElement = document.getElementById('expiration_date_display');

    if (expDateElement) expDateElement.value = dateString;
    if (expDateDisplayElement) expDateDisplayElement.value = dateString;
  }
}

function toggleShelfLife() {
  const isPerishableElement = document.getElementById('is_perishable');
  if (!isPerishableElement) return;

  const isPerishable = isPerishableElement.checked;
  const shelfLifeField = document.getElementById('shelfLifeField');

  if (shelfLifeField) {
    shelfLifeField.style.display = isPerishable ? 'block' : 'none';
    const shelfLifeInput = document.getElementById('shelf_life_days');
    if (shelfLifeInput) {
      shelfLifeInput.required = isPerishable;
      if (!isPerishable) {
        shelfLifeInput.value = '';
        const expDateElement = document.getElementById('expiration_date');
        const expDateDisplayElement = document.getElementById('expiration_date_display');
        if (expDateElement) expDateElement.value = '';
        if (expDateDisplayElement) expDateDisplayElement.value = '';
      }
    }
  }
}

function loadVariants() {
  const productSelect = document.getElementById('product_id');
  const variantSelect = document.getElementById('variant_id');

  if (!productSelect || !variantSelect) return;

  const productId = productSelect.value;

  // Clear existing variants
  variantSelect.innerHTML = '<option value="">Select a variant...</option>';

  if (!productId) {
    variantSelect.disabled = true;
    return;
  }

  // Fetch variants for selected product
  fetch(`/api/products/${productId}/variants`)
    .then(response => response.json())
    .then(data => {
      if (data.variants && data.variants.length > 0) {
        data.variants.forEach(variant => {
          const option = document.createElement('option');
          option.value = variant.id;
          option.textContent = variant.name;
          variantSelect.appendChild(option);
        });
        variantSelect.disabled = false;
      } else {
        variantSelect.disabled = true;
      }
    })
    .catch(error => {
      console.error('Error loading variants:', error);
      variantSelect.disabled = true;
    });
}

function validateContainerInput(inputElement) {
  const row = inputElement.closest('tr');
  if (!row) return true;

  const originalUsed = parseFloat(row.dataset.originalUsed || 0);
  const currentValue = parseFloat(inputElement.value || 0);

  if (currentValue < 0) {
    alert('Container quantity cannot be negative');
    inputElement.value = originalUsed;
    return false;
  }

  if (currentValue > originalUsed * 1.5) {
    if (!confirm(`Using ${currentValue} containers is significantly more than originally used (${originalUsed}). Continue?`)) {
      inputElement.value = originalUsed;
      return false;
    }
  }

  return true;
}

function validateYield() {
  const finalQuantityElement = document.getElementById('final_quantity');
  if (!finalQuantityElement) return;

  const finalQuantity = parseFloat(finalQuantityElement.value);
  const alertsContainer = document.getElementById('yield-validation-alerts');

  if (alertsContainer) {
    alertsContainer.innerHTML = '';
  }

  if (finalQuantity <= 0) {
    if (alertsContainer) {
      alertsContainer.innerHTML = '<div class="alert alert-danger">Final quantity must be greater than 0</div>';
    }
    return false;
  }

  return true;
}

function updateTotals() {
  const containerInputs = document.querySelectorAll('input[name^="container_"]');
  let totalContainerCapacity = 0;

  containerInputs.forEach(input => {
    const row = input.closest('tr');
    if (row) {
      const capacity = parseFloat(row.dataset.capacity || 0);
      const quantity = parseFloat(input.value || 0);
      totalContainerCapacity += capacity * quantity;
    }
  });

  const finalQuantityElement = document.getElementById('final_quantity');
  const finalQuantity = finalQuantityElement ? parseFloat(finalQuantityElement.value || 0) : 0;

  validateContainerAllocation(finalQuantity, totalContainerCapacity);
  updateUncontainedYield(finalQuantity, totalContainerCapacity);
}

function validateContainerAllocation(finalQuantity, totalContainerCapacity) {
  const alertsContainer = document.getElementById('yield-validation-alerts');
  if (!alertsContainer) return;

  let alertHtml = '';

  if (totalContainerCapacity > 0) {
    const fillPercentage = (finalQuantity / totalContainerCapacity) * 100;

    if (fillPercentage > 100) {
      alertHtml += '<div class="alert alert-warning">⚠️ Product quantity exceeds container capacity. Consider bulk storage.</div>';
    } else if (fillPercentage < 50) {
      alertHtml += '<div class="alert alert-info">ℹ️ Containers are less than 50% full. Consider using fewer or smaller containers.</div>';
    }
  }

  alertsContainer.innerHTML = alertHtml;
}

function updateContainerTable() {
  const containerInputs = document.querySelectorAll('input[name^="container_"]');
  containerInputs.forEach(input => {
    input.addEventListener('input', function() {
      if (validateContainerInput(this)) {
        updateTotals();
      }
    });
  });
}

function updateContainerSummary() {
  // Update container summary display if needed
  updateTotals();
}

function updateUncontainedYield(finalQuantity, totalContainerCapacity) {
  const uncontainedElement = document.getElementById('uncontained_yield');
  if (uncontainedElement && totalContainerCapacity > 0) {
    const uncontained = Math.max(0, finalQuantity - totalContainerCapacity);
    uncontainedElement.textContent = uncontained.toFixed(2);
  }
}

function getCSRFToken() {
  const csrfElement = document.querySelector('input[name="csrf_token"]');
  return csrfElement ? csrfElement.value : '';
}

// Initialize when modal is shown
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('finishBatchModal');
  const form = document.getElementById('finishBatchModalForm');

  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      updateContainerTable();

      // Set up product change listener
      const productSelect = document.getElementById('product_id');
      if (productSelect) {
        productSelect.addEventListener('change', loadVariants);
      }

      // Set up shelf life listeners
      const shelfLifeInput = document.getElementById('shelf_life_days');
      if (shelfLifeInput) {
        shelfLifeInput.addEventListener('input', updateExpirationDate);
      }

      const isPerishableCheckbox = document.getElementById('is_perishable');
      if (isPerishableCheckbox) {
        isPerishableCheckbox.addEventListener('change', toggleShelfLife);
      }

      // Set up final quantity listener
      const finalQuantityInput = document.getElementById('final_quantity');
      if (finalQuantityInput) {
        finalQuantityInput.addEventListener('input', function() {
          validateYield();
          updateTotals();
        });
      }
    });
  }

  if (form) {
    form.addEventListener('submit', function(e) {
      // Validate final quantity
      if (!validateYield()) {
        e.preventDefault();
        return false;
      }

      // Validate container inputs
      const containerInputs = document.querySelectorAll('input[name^="container_"]');
      for (let input of containerInputs) {
        if (!validateContainerInput(input)) {
          e.preventDefault();
          return false;
        }
      }

      // Check if product is selected and final quantity is valid
      const productSelect = document.getElementById('product_id');
      const finalQuantityInput = document.getElementById('final_quantity');

      if (productSelect && productSelect.value) {
        const finalQuantity = parseFloat(finalQuantityInput.value || 0);
        if (finalQuantity <= 0) {
          alert('Final quantity must be greater than 0 when creating a product');
          e.preventDefault();
          return false;
        }
      }

      return true;
    });
  }
});
</script>