<div class="modal fade" id="quickAddContainerModal" tabindex="-1" aria-labelledby="quickAddContainerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickAddContainerModalLabel">Quick Add Container</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="quickAddContainerForm" method="POST" action="{{ url_for('inventory.add_inventory') }}">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="type" value="container">
          <input type="hidden" name="quantity" value="0">
          <input type="hidden" name="cost_per_unit" value="0">
          <input type="hidden" name="low_stock_threshold" value="0">
          <input type="hidden" name="unit" value="">

          <div class="mb-3">
            <label for="containerName" class="form-label">Container Name</label>
            <input type="text" class="form-control" id="containerName" name="name" required>
          </div>

          <div class="mb-3">
            <label for="containerStorageAmount" class="form-label">Storage Amount</label>
            <input type="number" class="form-control" id="containerStorageAmount" name="storage_amount" step="0.01" required>
          </div>

          <div class="mb-3">
            <label for="containerStorageUnit" class="form-label">Storage Unit</label>
            <select class="form-select" id="containerStorageUnit" name="storage_unit" required>
              <option value="">Select unit...</option>
              {% for unit in get_global_unit_list() %}
              <option value="{{ unit.name }}">{{ unit.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Container</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const containerForm = document.getElementById('quickAddContainerForm');
  if (!containerForm) return;

  containerForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(containerForm);
    const submitBtn = containerForm.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    fetch(containerForm.action, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.redirected) {
        // Success - container was added and redirected
        showContainerAlert('success', 'Container added successfully!');

        // Add to container dropdowns if they exist
        const newContainerName = formData.get('name');
        const storageAmount = formData.get('storage_amount');
        const storageUnit = formData.get('storage_unit');

        // Find container selects and add the new option
        document.querySelectorAll('select[name="allowed_containers[]"]').forEach(select => {
          if (select) {
            const option = document.createElement('option');
            option.value = 'temp-' + Date.now(); // Temporary ID until page refresh
            option.textContent = `${newContainerName} (${storageAmount} ${storageUnit})`;
            select.appendChild(option);
          }
        });

        // Reset form and close modal
        containerForm.reset();
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddContainerModal'));
        if (modal) {
          modal.hide();
        }
      } else {
        return response.text().then(text => {
          if (text.includes('error') || text.includes('already exists')) {
            throw new Error('Container name already exists or validation error');
          }
          throw new Error('Unexpected response');
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showContainerAlert('error', error.message || 'Failed to add container');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Container';
    });
  });
});

function showContainerAlert(type, message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  // Insert at top of main content area
  const container = document.querySelector('.container-fluid') || document.body;
  container.insertBefore(alertDiv, container.firstChild);

  // Auto dismiss after 5 seconds
  setTimeout(() => {
    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
    if (alert) {
      alert.close();
    }
  }, 5000);
}
</script>