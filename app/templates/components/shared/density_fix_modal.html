<div class="modal fade" id="densityFixModal" tabindex="-1" aria-labelledby="densityFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="densityFixModalLabel">
                    <i class="fas fa-weight-hanging"></i>
                    Set Density for {{ ingredient.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Density Required:</strong> To convert between weight and volume units, we need the density of {{ ingredient.name }}.
                </div>

                <form id="densityFixForm">
                    <div class="mb-3">
                        <label for="densityInput" class="form-label">
                            Density (g/ml or g/cm³)
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="densityInput" 
                               step="0.001" 
                               min="0.001"
                               value="{{ suggested_density or ingredient.density or '' }}"
                               placeholder="e.g., 1.0 for water">
                        <div class="form-text">
                            {% if suggested_density %}
                                <i class="fas fa-lightbulb text-warning"></i>
                                Suggested density based on category: {{ suggested_density }} g/ml
                            {% endif %}
                        </div>
                    </div>

                    {% if ingredient.category %}
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-tag"></i>
                            Category: {{ ingredient.category.name }}
                            {% if ingredient.category.default_density %}
                                (Default: {{ ingredient.category.default_density }} g/ml)
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveDensityBtn">
                    <i class="fas fa-save"></i>
                    Save Density
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('densityFixModal');
    const form = document.getElementById('densityFixForm');
    const saveBtn = document.getElementById('saveDensityBtn');
    const densityInput = document.getElementById('densityInput');

    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            const density = parseFloat(densityInput.value);

            if (!density || density <= 0) {
                alert('Please enter a valid density greater than 0');
                return;
            }

            // Save density via API
            fetch(`/api/drawer-actions/conversion/density-modal/{{ ingredient.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    density: density
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and trigger callback if provided
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();

                    // Dispatch custom event for parent to handle
                    window.dispatchEvent(new CustomEvent('densityUpdated', {
                        detail: {
                            ingredientId: {{ ingredient.id }},
                            newDensity: density,
                            ingredientName: '{{ ingredient.name }}'
                        }
                    }));

                    // Show success message
                    if (typeof showToast === 'function') {
                        showToast('success', data.message);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating density:', error);
                alert('Failed to update density');
            });
        });
    }
});
</script>
</div>
<!-- Density Fix Modal -->
<div class="modal fade" id="densityFixModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Ingredient Density</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>To convert between volume and weight units for <strong>{{ ingredient.name }}</strong>, we need to know its density.</p>
                
                <div class="mb-3">
                    <label for="densityInput" class="form-label">Density (g/ml):</label>
                    <input type="number" 
                           class="form-control" 
                           id="densityInput" 
                           step="0.01" 
                           min="0.01"
                           value="{{ ingredient.density or '' }}"
                           placeholder="e.g., 0.96 for beeswax">
                    <div class="form-text">
                        Common densities: Water = 1.0, Oils ≈ 0.9, Waxes ≈ 0.95, Honey ≈ 1.4
                    </div>
                </div>
                
                <div id="densityError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDensityBtn">Save Density</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('densityFixModal');
    const saveBtn = document.getElementById('saveDensityBtn');
    const densityInput = document.getElementById('densityInput');
    const errorDiv = document.getElementById('densityError');
    
    if (saveBtn) {
        saveBtn.addEventListener('click', async function() {
            const density = parseFloat(densityInput.value);
            
            if (!density || density <= 0) {
                showError('Please enter a valid density value greater than 0');
                return;
            }
            
            try {
                const response = await fetch('/api/drawer-actions/conversion/density-modal/{{ ingredient.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ density: density })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Trigger success event for drawer protocol
                    window.dispatchEvent(new CustomEvent('densityUpdated', {
                        detail: {
                            ingredient_id: {{ ingredient.id }},
                            density: density,
                            ingredient_name: '{{ ingredient.name }}'
                        }
                    }));
                    
                    // Close modal
                    bootstrap.Modal.getInstance(modal).hide();
                } else {
                    showError(result.error || 'Failed to save density');
                }
            } catch (error) {
                console.error('Error saving density:', error);
                showError('Network error occurred');
            }
        });
    }
    
    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }
});
</script>
