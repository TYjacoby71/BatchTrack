
<div class="modal fade" id="densityFixModal" tabindex="-1" aria-labelledby="densityFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <meta name="csrf-token" content="{{ csrf_token }}">
            <div class="modal-header">
                <h5 class="modal-title" id="densityFixModalLabel">
                    <i class="fas fa-balance-scale text-warning"></i>
                    Fix Missing Density
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Density Required:</strong> To convert between volume and weight units for 
                    <strong>{{ ingredient.name }}</strong>, we need its density value.
                </div>
                
                <form id="densityFixForm">
                    <div class="mb-3">
                        <label for="densityInput" class="form-label">
                            Density (g/ml):
                            <small class="text-muted">How many grams per milliliter</small>
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="densityInput" 
                               step="0.001" 
                               min="0.001" 
                               max="50"
                               placeholder="e.g., 0.96 for beeswax"
                               required>
                        <div class="form-text">
                            Common densities: Water (1.0), Oil (0.91), Honey (1.42), Beeswax (0.96)
                        </div>
                    </div>
                </form>
                
                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="openDensityReference()">
                            <i class="fas fa-book"></i> Reference
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDensityBtn">
                            <i class="fas fa-save"></i> Save Density
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('densityFixModal');
    const form = document.getElementById('densityFixForm');
    const saveBtn = document.getElementById('saveDensityBtn');
    const densityInput = document.getElementById('densityInput');
    
    console.log('ðŸ”§ DENSITY MODAL: DOM loaded, elements found:', {
        modal: !!modal,
        form: !!form,
        saveBtn: !!saveBtn,
        densityInput: !!densityInput
    });
    
    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ðŸ”§ DENSITY MODAL: Save button clicked');
            
            const density = parseFloat(densityInput.value);
            console.log('ðŸ”§ DENSITY MODAL: Density value:', density);
            
            if (!density || density <= 0) {
                alert('Please enter a valid density greater than 0');
                return;
            }
            
            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            console.log('ðŸ”§ DENSITY MODAL: Sending POST to /api/drawer-actions/conversion/density-modal/{{ ingredient.id }}');
            
            // Save density via API
            fetch('/api/drawer-actions/conversion/density-modal/{{ ingredient.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    density: density
                })
            })
            .then(response => {
                console.log('ðŸ”§ DENSITY MODAL: Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ðŸ”§ DENSITY MODAL: Response data:', data);
                
                if (data.success) {
                    // Close modal and trigger callback
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    // Dispatch custom event for parent to retrigger conversion
                    console.log('ðŸ”§ DENSITY MODAL: Dispatching conversion.density.updated event');
                    window.dispatchEvent(new CustomEvent('conversion.density.updated', {
                        detail: {
                            ingredient_id: {{ ingredient.id }},
                            ingredient_name: '{{ ingredient.name }}',
                            density: density,
                            message: data.message,
                            retrigger: true
                        }
                    }));
                } else {
                    alert('Error: ' + (data.error || 'Failed to save density'));
                }
            })
            .catch(error => {
                console.error('ðŸ”§ DENSITY MODAL: Error saving density:', error);
                alert('Failed to save density. Please try again.');
            })
            .finally(() => {
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Density';
            });
        });
    }
});

function openDensityReference() {
    // Open the density reference data instead of unit manager
    window.open('/api/density-reference', '_blank');
}
</script>
