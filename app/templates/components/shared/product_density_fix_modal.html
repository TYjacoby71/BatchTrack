<div class="modal fade" id="productDensityFixModal" tabindex="-1" aria-labelledby="productDensityFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDensityFixModalLabel">
                    <i class="fas fa-balance-scale text-primary"></i>
                    Set Product Density
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    To convert between volume and weight for <strong>{{ recipe.name }}</strong>, specify the product density.
                </div>

                <form id="productDensityForm">
                    <div class="mb-3">
                        <label for="productDensityInput" class="form-label">
                            Product Density (g/ml)
                            <small class="text-muted">grams per milliliter</small>
                        </label>
                        <input type="number"
                               class="form-control"
                               id="productDensityInput"
                               step="0.001"
                               min="0.001"
                               max="50"
                               placeholder="e.g., 1.00 for water"
                               required>
                        <div class="form-text">
                            Common densities: Water (1.00), Oil (0.91), Honey (1.42)
                        </div>
                    </div>
                </form>

                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductDensityBtn">
                        <i class="fas fa-save"></i> Use Density
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('productDensityFixModal');
    const saveBtn = document.getElementById('saveProductDensityBtn');
    const input = document.getElementById('productDensityInput');

    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            const density = parseFloat(input.value);
            if (!density || density <= 0) {
                alert('Please enter a valid density greater than 0');
                return;
            }

            fetch('/api/drawer-actions/containers/product-density-modal/{{ recipe.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ density: density })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const instance = bootstrap.Modal.getInstance(modal);
                    instance.hide();

                    // Notify global listener to retry container auto-fill
                    window.dispatchEvent(new CustomEvent('containers.product_density.updated', {
                        detail: {
                            recipe_id: {{ recipe.id }},
                            density: density,
                            message: data.message
                        }
                    }));
                } else {
                    alert('Error: ' + (data.error || 'Failed to set density'));
                }
            })
            .catch(err => {
                console.error('Failed to submit product density', err);
                alert('Failed to submit product density. Please try again.');
            });
        });
    }
});
</script>
