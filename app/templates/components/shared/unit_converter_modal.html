{# Enhanced Unit Converter Modal Component #}
<div class="modal fade" id="unitConverterModal" tabindex="-1" aria-labelledby="unitConverterLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unitConverterLabel">
          <i class="fas fa-exchange-alt text-primary"></i> Unit Converter
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Convert between different units. For volume/weight conversions, select an ingredient with density data.
        </div>

        <!-- Main Conversion Interface -->
        <div class="row align-items-center mb-4">
          <!-- From Section -->
          <div class="col-md-5">
            <label class="form-label fw-bold">From</label>
            <div class="mb-2">
              <input type="number" 
                     id="fromAmount" 
                     class="form-control form-control-lg text-center" 
                     placeholder="Enter amount" 
                     step="any" 
                     min="0">
            </div>
            <select id="fromUnit" class="form-select">
              <option value="">Select unit...</option>
              {% for unit in global_units %}
                <option value="{{ unit.name }}" data-type="{{ unit.unit_type }}">{{ unit.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Convert Arrow/Button -->
          <div class="col-md-2 text-center">
            <button type="button" id="convertButton" class="btn btn-primary btn-lg rounded-circle" style="width: 60px; height: 60px;">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>

          <!-- To Section -->
          <div class="col-md-5">
            <label class="form-label fw-bold">To</label>
            <div class="mb-2">
              <input type="text" 
                     id="toAmount" 
                     class="form-control form-control-lg text-center bg-light" 
                     placeholder="Result" 
                     readonly>
            </div>
            <select id="toUnit" class="form-select">
              <option value="">Select unit...</option>
              {% for unit in global_units %}
                <option value="{{ unit.name }}" data-type="{{ unit.unit_type }}">{{ unit.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Ingredient Selection (shown when needed for density) -->
        <div id="ingredientSelectionSection" class="card border-warning" style="display: none;">
          <div class="card-header bg-warning bg-opacity-10">
            <h6 class="mb-0">
              <i class="fas fa-flask text-warning"></i>
              Ingredient Selection Required
            </h6>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">
              Converting between volume and weight requires density data. Select an ingredient:
            </p>

            <!-- Ingredient Search and Selection -->
            <div class="row">
              <div class="col-md-8">
                <input type="text" 
                       id="ingredientSearch" 
                       class="form-control" 
                       placeholder="Search ingredients...">
                <div id="ingredientDropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
              </div>
              <div class="col-md-4">
                <button type="button" id="selectFromGlobalBtn" class="btn btn-outline-secondary w-100">
                  <i class="fas fa-flask"></i> Select Ingredient
                </button>
              </div>
            </div>

            <div id="selectedIngredient" class="mt-3" style="display: none;">
              <div class="alert alert-success">
                <strong>Selected:</strong> <span id="selectedIngredientName"></span>
                <br><small>Density: <span id="selectedIngredientDensity"></span> g/ml</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Conversion Result Display -->
        <div id="conversionResult" class="mt-4" style="display: none;">
          <div class="card border-success">
            <div class="card-body text-center">
              <h5 class="text-success mb-0" id="resultText"></h5>
              <button type="button" id="copyResultBtn" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="fas fa-copy"></i> Copy Result
              </button>
            </div>
          </div>
        </div>

        <!-- Error Display -->
        <div id="conversionError" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('conversion_bp.manage_units') }}" class="btn btn-outline-secondary">
          <i class="fas fa-cogs"></i> Unit Manager
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Global Item Selection Modal -->
<div class="modal fade" id="globalItemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Ingredient from Global Library</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="globalItemSearch" class="form-control mb-3" placeholder="Search global ingredients...">
        <div id="globalItemList" style="max-height: 400px; overflow-y: auto;">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fromAmount = document.getElementById('fromAmount');
    const fromUnit = document.getElementById('fromUnit');
    const toAmount = document.getElementById('toAmount');
    const toUnit = document.getElementById('toUnit');
    const convertButton = document.getElementById('convertButton');
    const ingredientSection = document.getElementById('ingredientSelectionSection');
    const ingredientSearch = document.getElementById('ingredientSearch');
    const ingredientDropdown = document.getElementById('ingredientDropdown');
    const selectedIngredient = document.getElementById('selectedIngredient');
    const conversionResult = document.getElementById('conversionResult');
    const conversionError = document.getElementById('conversionError');
    const selectFromGlobalBtn = document.getElementById('selectFromGlobalBtn');
    const copyResultBtn = document.getElementById('copyResultBtn');

    let currentSelectedIngredient = null;
    let availableIngredients = [];

    // Load available ingredients
    async function loadIngredients() {
        try {
            const response = await fetch('/api/ingredients');
            if (response.ok) {
                availableIngredients = await response.json();
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading ingredients:', error);
            showError('Failed to load ingredient data.');
        }
    }

    // Check if conversion needs density
    function needsDensity() {
        const fromType = fromUnit.selectedOptions[0]?.dataset.type;
        const toType = toUnit.selectedOptions[0]?.dataset.type;

        return fromType && toType && 
               ((fromType === 'volume' && toType === 'weight') || 
                (fromType === 'weight' && toType === 'volume'));
    }

    // Show/hide ingredient selection
    function updateIngredientSection() {
        if (needsDensity()) {
            ingredientSection.style.display = 'block';
        } else {
            ingredientSection.style.display = 'none';
            currentSelectedIngredient = null;
            selectedIngredient.style.display = 'none'; // Hide selected ingredient display
        }
    }

    // Filter and display ingredients
    function filterIngredients(searchTerm) {
        const filtered = availableIngredients.filter(ing => 
            ing.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
            ing.type === 'ingredient'
        );

        ingredientDropdown.innerHTML = '';
        filtered.slice(0, 10).forEach(ing => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `
                ${ing.name} 
                ${ing.density ? `<small class="text-muted">(${ing.density} g/ml)</small>` : '<small class="text-warning">(no density)</small>'}
            `;
            item.addEventListener('click', (e) => {
                e.preventDefault();
                selectIngredient(ing);
            });
            ingredientDropdown.appendChild(item);
        });

        ingredientDropdown.classList.toggle('show', filtered.length > 0);
    }

    function selectIngredient(ingredient) {
        currentSelectedIngredient = ingredient;
        document.getElementById('selectedIngredientName').textContent = ingredient.name;
        document.getElementById('selectedIngredientDensity').textContent = ingredient.density || 'Not set';
        selectedIngredient.style.display = 'block';
        ingredientDropdown.classList.remove('show');
        ingredientSearch.value = ''; // Clear search input
        // Optionally, hide the ingredient section if it was only for selection
        // if (!needsDensity()) { ingredientSection.style.display = 'none'; }
    }

    // Perform conversion
    async function performConversion() {
        const amount = parseFloat(fromAmount.value);
        const from = fromUnit.value;
        const to = toUnit.value;

        if (!amount || !from || !to) {
            showError('Please fill in amount and select both units');
            return;
        }

        if (needsDensity() && (!currentSelectedIngredient || !currentSelectedIngredient.density)) {
            showError('Please select an ingredient with density data for volume/weight conversion');
            return;
        }

        try {
            const url = `/conversion/convert/${amount}/${from}/${to}${currentSelectedIngredient ? `?ingredient_id=${currentSelectedIngredient.id}` : ''}`;
            const response = await fetch(url);

            if (!response.ok) {
                // Try to parse error message from response body
                let errorMsg = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error_data?.message || errorMsg;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMsg = response.statusText || errorMsg;
                }
                throw new Error(errorMsg);
            }

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Received non-JSON response from server.');
            }

            const data = await response.json();

            if (data.success !== false && data.converted_value !== null) {
                toAmount.value = data.converted_value;
                document.getElementById('resultText').textContent = `${amount} ${from} = ${data.converted_value} ${to}`;
                conversionResult.style.display = 'block';
                conversionError.style.display = 'none';
            } else {
                showError(data.error_data?.message || 'Conversion failed');
            }
        } catch (error) {
            showError('Error performing conversion: ' + error.message);
        }
    }

    function showError(message) {
        conversionError.textContent = message;
        conversionError.style.display = 'block';
        conversionResult.style.display = 'none';
    }

    // Event listeners
    fromUnit.addEventListener('change', updateIngredientSection);
    toUnit.addEventListener('change', updateIngredientSection);
    convertButton.addEventListener('click', performConversion);

    ingredientSearch.addEventListener('input', (e) => {
        if (e.target.value.length > 0) {
            filterIngredients(e.target.value);
        } else {
            ingredientDropdown.classList.remove('show');
        }
    });

    // Global library modal
    selectFromGlobalBtn.addEventListener('click', () => {
        const globalModal = new bootstrap.Modal(document.getElementById('globalItemModal'));
        globalModal.show();
        loadGlobalItems();
    });

    async function loadGlobalItems() {
        try {
            const response = await fetch('/density-reference/options');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const categories = await response.json();
            const globalItemList = document.getElementById('globalItemList');

            globalItemList.innerHTML = '';
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-3';
                categoryDiv.innerHTML = `
                    <h6 class="text-primary">${category.name}</h6>
                    <div class="list-group">
                        ${category.items.map(item => `
                            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                               data-name="${item.name}" data-density="${item.density_g_per_ml || ''}">
                                <span>${item.name}</span>
                                <small class="text-muted">${item.density_g_per_ml ? item.density_g_per_ml + ' g/ml' : 'No density'}</small>
                            </a>
                        `).join('')}
                    </div>
                `;
                globalItemList.appendChild(categoryDiv);
            });

            // Add click handlers for global items
            globalItemList.querySelectorAll('.list-group-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const name = e.currentTarget.dataset.name;
                    const density = parseFloat(e.currentTarget.dataset.density);

                    if (density) {
                        selectIngredient({
                            name: name,
                            density: density,
                            id: null // Global item, no specific ID needed
                        });
                        bootstrap.Modal.getInstance(document.getElementById('globalItemModal')).hide();
                    } else {
                        showError(`'${name}' does not have density data.`);
                    }
                });
            });
        } catch (error) {
            console.error('Error loading global items:', error);
            showError('Failed to load global ingredient library.');
        }
    }

    // Copy result
    copyResultBtn.addEventListener('click', () => {
        const resultTextElement = document.getElementById('resultText');
        if (resultTextElement) {
            const resultText = resultTextElement.textContent;
            navigator.clipboard.writeText(resultText).then(() => {
                copyResultBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyResultBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Result';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                // Optionally provide user feedback that copy failed
            });
        }
    });

    // Load ingredients on modal open
    const unitConverterModal = document.getElementById('unitConverterModal');
    unitConverterModal.addEventListener('shown.bs.modal', loadIngredients);

    // Clear form when modal closes
    unitConverterModal.addEventListener('hidden.bs.modal', () => {
        fromAmount.value = '';
        fromUnit.value = '';
        toAmount.value = '';
        toUnit.value = '';
        currentSelectedIngredient = null;
        ingredientSection.style.display = 'none';
        selectedIngredient.style.display = 'none';
        conversionResult.style.display = 'none';
        conversionError.style.display = 'none';
        ingredientDropdown.classList.remove('show');
        ingredientSearch.value = ''; // Clear search input on close
    });
});
</script>