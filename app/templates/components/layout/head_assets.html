{#
Synopsis:
Shared head asset links and runtime bootstraps for app/public shells.

Glossary:
- Lightweight shell: Public route mode that avoids loading heavy app assets.
- Analytics bootstrap: Shared client telemetry helpers for page events.
#}
<link rel="icon" type="image/svg+xml" href="{{ url_for('core.branding_app_tile') }}">
<link rel="shortcut icon" href="{{ url_for('core.branding_app_tile') }}">
<link rel="apple-touch-icon" href="{{ url_for('core.branding_app_tile') }}">
{% if lightweight_public_shell %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" as="style" crossorigin onload="this.onload=null;this.rel='stylesheet'">
<noscript>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin>
</noscript>
{% else %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% endif %}
{% if load_fontawesome %}
{% if lightweight_public_shell %}
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" as="style" crossorigin onload="this.onload=null;this.rel='stylesheet'">
<noscript>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" crossorigin>
</noscript>
{% else %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
{% endif %}
{% endif %}
<!-- Custom CSS -->
<link rel="stylesheet" href="{{ static_asset('style.css') }}">
<link rel="stylesheet" href="{{ static_asset('css/theme.css') }}">
{% if not lightweight_public_shell %}
<link rel="stylesheet" href="{{ static_asset('css/filter_panels.css') }}">
{% endif %}
{% if load_feedback_widget %}
<link rel="stylesheet" href="{{ static_asset('css/tools/feedback_note_modal.css') }}">
{% endif %}
{% if posthog_api_key %}
<link rel="preconnect" href="{{ posthog_host }}" crossorigin>
<link rel="dns-prefetch" href="{{ posthog_host|replace('https://', '//')|replace('http://', '//') }}">
{% endif %}
<script>
  // Minimal theme bootstrap: scope localStorage per user + org.
  (function() {
    try {
      var userId = {{ current_user.id if current_user.is_authenticated else 'null' }};
      var orgId = {{ get_effective_org_id() if current_user.is_authenticated else 'null' }};
      var userKey = userId ? String(userId) : 'guest';
      var orgKey = orgId ? String(orgId) : 'public';
      var prefix = 'bt:' + userKey + ':' + orgKey + ':';
      window.BT_STORAGE = {
        userId: userId,
        orgId: orgId,
        prefix: prefix,
        key: function(baseKey) { return prefix + baseKey; }
      };
      window.BT_LIST_PREFERENCES = {{ (list_preferences_payload if list_preferences_payload is defined else {}) | tojson }};

      var storageKey = window.BT_STORAGE.key('theme');
      var hasServerTheme = {{ 'true' if theme_preference_scoped else 'false' }};
      var serverTheme = {{ theme_preference | tojson if theme_preference_scoped else 'null' }};
      var forcePublicLightTheme = {{ 'true' if public_shell_mode else 'false' }};
      var theme = null;

      if (forcePublicLightTheme) {
        theme = 'light';
        localStorage.setItem(storageKey, theme);
      } else if (hasServerTheme && serverTheme) {
        theme = serverTheme;
        localStorage.setItem(storageKey, theme);
      } else {
        theme = localStorage.getItem(storageKey) || 'light';
        localStorage.setItem(storageKey, theme);
      }

      document.documentElement.setAttribute('data-theme', theme || 'light');
    } catch (e) {}
  })();
</script>
{% if not lightweight_public_shell %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endif %}
{% if ga_measurement_id %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_measurement_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', {{ ga_measurement_id | tojson }}, {
    anonymize_ip: true
  });
</script>
{% endif %}
{% if posthog_api_key %}
<script>
  !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2===o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people"},o="capture identify alias group set_config reset register register_once unregister people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user pageleave".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
  posthog.init({{ posthog_api_key | tojson }}, {
    api_host: {{ posthog_host | tojson }},
    capture_pageview: {{ posthog_capture_pageview | tojson }},
    capture_pageleave: {{ posthog_capture_pageleave | tojson }},
    person_profiles: "identified_only"
  });
</script>
{% endif %}
{% if load_analytics %}
<script>
  (function() {
    var FIRST_LANDING_STORAGE_KEY = 'bt:first_landing_at';
    var FIRST_LANDING_COOKIE_KEY = 'bt_first_landing_at';

    function nowMs() {
      return Date.now ? Date.now() : new Date().getTime();
    }

    function parseInteger(value) {
      if (value === null || value === undefined || value === '') {
        return null;
      }
      var parsed = Number.parseInt(String(value), 10);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function getCookie(name) {
      var escaped = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      var match = document.cookie.match(new RegExp('(?:^|; )' + escaped + '=([^;]*)'));
      return match ? decodeURIComponent(match[1]) : null;
    }

    function setCookie(name, value) {
      try {
        document.cookie = name + '=' + encodeURIComponent(String(value)) + '; path=/; max-age=31536000; SameSite=Lax';
      } catch (error) {}
    }

    function resolveFirstLandingAt() {
      var fromStorage = null;
      try {
        fromStorage = parseInteger(window.localStorage && window.localStorage.getItem(FIRST_LANDING_STORAGE_KEY));
      } catch (error) {}
      var fromCookie = parseInteger(getCookie(FIRST_LANDING_COOKIE_KEY));
      var first = fromStorage || fromCookie;
      if (!first) {
        first = nowMs();
      }
      try {
        if (window.localStorage) {
          window.localStorage.setItem(FIRST_LANDING_STORAGE_KEY, String(first));
        }
      } catch (error) {}
      setCookie(FIRST_LANDING_COOKIE_KEY, String(first));
      return first;
    }

    function canCapture() {
      return Boolean(
        window.posthog &&
        typeof window.posthog.capture === 'function'
      );
    }

    var firstLandingAt = resolveFirstLandingAt();
    var firstLandingRecordedKey = 'bt:first_landing_recorded_sent';

    window.BTAnalytics = window.BTAnalytics || {};
    window.BTAnalytics.getFirstLandingAt = function() {
      return firstLandingAt;
    };
    window.BTAnalytics.secondsSinceFirstLanding = function() {
      var elapsedMs = Math.max(0, nowMs() - firstLandingAt);
      return Math.round(elapsedMs / 1000);
    };
    window.BTAnalytics.capture = function(eventName, properties) {
      if (!eventName || !canCapture()) {
        return;
      }
      var payload = Object.assign(
        {
          seconds_since_first_landing: window.BTAnalytics.secondsSinceFirstLanding(),
          page_path: window.location.pathname,
          page_url: window.location.href
        },
        properties || {}
      );
      try {
        window.posthog.capture(eventName, payload);
      } catch (error) {}
    };

    document.addEventListener('DOMContentLoaded', function() {
      var body = document.body || null;
      var isAuthenticated = body ? body.getAttribute('data-authenticated') === 'true' : false;
      var userId = body ? body.getAttribute('data-user-id') : '';
      var orgId = body ? body.getAttribute('data-org-id') : '';
      var endpoint = body ? body.getAttribute('data-page-endpoint') : '';

      if (canCapture() && isAuthenticated && userId) {
        try {
          window.posthog.identify(String(userId), {
            organization_id: orgId || null,
            authenticated: true
          });
          if (orgId && typeof window.posthog.group === 'function') {
            window.posthog.group('organization', String(orgId));
          }
        } catch (error) {}
      }

      try {
        if (canCapture() && window.localStorage && !window.localStorage.getItem(firstLandingRecordedKey)) {
          window.BTAnalytics.capture('first_landing_recorded', {
            first_landing_at_ms: firstLandingAt
          });
          window.localStorage.setItem(firstLandingRecordedKey, '1');
        }
      } catch (error) {}

      window.BTAnalytics.capture('page_context_viewed', {
        page_endpoint: endpoint || '',
        authenticated: isAuthenticated
      });

      var pageEnteredAt = nowMs();
      var dwellSent = false;
      var sendDwell = function() {
        if (dwellSent) {
          return;
        }
        dwellSent = true;
        var dwellSeconds = Math.max(0, Math.round((nowMs() - pageEnteredAt) / 1000));
        window.BTAnalytics.capture('page_dwell_recorded', {
          page_endpoint: endpoint || '',
          seconds_on_page: dwellSeconds,
          authenticated: isAuthenticated
        });
      };
      window.addEventListener('pagehide', sendDwell, { once: true });
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
          sendDwell();
        }
      });

      document.addEventListener('click', function(event) {
        var anchor = event.target && event.target.closest ? event.target.closest('a[href]') : null;
        if (!anchor) {
          return;
        }
        var href = anchor.getAttribute('href') || '';
        if (!href || href.startsWith('#')) {
          return;
        }
        var url;
        try {
          url = new URL(href, window.location.origin);
        } catch (error) {
          return;
        }
        var path = url.pathname || '';
        if (path.includes('/auth/signup')) {
          window.BTAnalytics.capture('public_signup_cta_clicked', {
            cta_text: (anchor.textContent || '').trim().slice(0, 120),
            signup_source: url.searchParams.get('source') || null,
            destination_path: path
          });
        } else if (path.includes('/auth/login')) {
          window.BTAnalytics.capture('public_login_cta_clicked', {
            cta_text: (anchor.textContent || '').trim().slice(0, 120),
            destination_path: path
          });
        } else if (path === '/pricing') {
          window.BTAnalytics.capture('public_pricing_clicked', {
            cta_text: (anchor.textContent || '').trim().slice(0, 120)
          });
        }
      });
    });
  })();
</script>
{% endif %}
