{#
Synopsis:
Primary navbar for authenticated app shell and guest public-header modes.
#}
<nav class="navbar navbar-expand-lg {% if public_shell_mode %}public-marketing-nav navbar-light bg-white shadow-sm{% else %}navbar-light bg-light{% endif %}">
    <div class="{% if public_shell_mode %}container{% else %}container-fluid{% endif %} position-relative">
        {% if not public_shell_mode %}
        <a class="navbar-brand" href="{% if current_user.is_authenticated %}{% if current_user.user_type == 'developer' %}{{ url_for('developer.dashboard') }}{% else %}{{ url_for('app_routes.dashboard') }}{% endif %}{% else %}{{ url_for('core.index') }}{% endif %}" aria-label="BatchTrack home">
            <img src="{{ url_for('core.branding_full_logo_header') }}" alt="BatchTrack" class="app-brand-logo">
        </a>
        {% endif %}
        {% set marketplace_display_enabled = is_feature_enabled('FEATURE_RECIPE_MARKETPLACE_DISPLAY') %}
        {% set recipe_library_nav_enabled = is_feature_enabled('FEATURE_RECIPE_LIBRARY_NAV') and marketplace_display_enabled %}
        {% set global_library_enabled = is_feature_enabled('FEATURE_GLOBAL_ITEM_LIBRARY') or (current_user.is_authenticated and current_user.user_type == 'developer') %}
        {% set bulk_stock_check_enabled = is_feature_enabled('FEATURE_BULK_STOCK_CHECK') %}
        {% set bulk_inventory_updates_enabled = is_feature_enabled('FEATURE_BULK_INVENTORY_UPDATES') %}
        {% set show_recipe_library_link = (recipe_library_nav_enabled or (current_user.is_authenticated and current_user.user_type == 'developer')) and marketplace_display_enabled %}
        {% set customer_can_view_inventory = current_user.is_authenticated and has_permission(current_user, 'inventory.view') %}
        {% set customer_can_view_recipes = current_user.is_authenticated and has_permission(current_user, 'recipes.view') %}
        {% set customer_can_view_batches = current_user.is_authenticated and has_permission(current_user, 'batches.view') %}
        {% set customer_can_view_products = current_user.is_authenticated and has_permission(current_user, 'products.view') %}
        {% set tier_can_view_products = current_user.is_authenticated and has_tier_permission('products.view') %}
        {% set tier_can_adjust_inventory = current_user.is_authenticated and has_tier_permission('inventory.adjust') %}
        {% set recipes_ingredients_tier_nav = current_user.is_authenticated and current_user.user_type != 'developer' and has_tier_permission('recipes.view') and has_tier_permission('batches.finish') and not tier_can_view_products %}
        {% set has_nav_center = (navbar_center_title is defined and navbar_center_title) and not public_shell_mode %}
        {% if has_nav_center %}
        <div class="position-absolute top-50 start-50 translate-middle text-center">
            <span class="navbar-text fw-semibold">{{ navbar_center_title }}</span>
        </div>
        {% endif %}
        {% if current_user.is_authenticated %}
        {% if current_user.user_type == 'developer' %}
        <!-- Developer Navigation -->
        <div class="navbar-nav me-auto">
            <span class="navbar-text text-danger">
                <i class="fas fa-shield-alt"></i> Developer Mode
                {% if session.get('dev_selected_org_id') %}
                {% set selected_org = get_organization_by_id(session.get('dev_selected_org_id')) %}
                <small class="text-primary">| Viewing as Org Owner ({{ selected_org.get_tier_display_name() if selected_org else 'No Org' }})</small>
                <a href="{{ url_for('developer.clear_organization_filter') }}" class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="fas fa-times"></i> Clear Filter
                </a>
                {% endif %}
            </span>
        </div>
        <!-- Show both menus when developer is viewing an organization -->
        {% if session.get('dev_selected_org_id') %}
        {% if not has_nav_center %}
        <ul class="navbar-nav mx-auto d-none d-md-flex">
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                    üßÆ Converter
                </a>
            </li>
        </ul>
        {% endif %}
        <div class="dropdown me-2">
            <button class="btn btn-light dropdown-toggle" type="button" id="customerDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user"></i> Customer Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="customerDropdown">
                <!-- User Dashboard -->
                <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Core Features -->
                <li><h6 class="dropdown-header">Core Features</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Production Tools -->
                <li><h6 class="dropdown-header">Production Tools</h6></li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
                <li>
                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                        Expiration
                        <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                    </a>
                </li>
                <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                {% if bulk_stock_check_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                {% endif %}
                {% if bulk_inventory_updates_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <!-- Resources -->
                <li><h6 class="dropdown-header">Resources</h6></li>
                {% if global_library_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                {% endif %}
                {% if show_recipe_library_link %}
                <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                {% endif %}
                <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Admin -->
                <li><h6 class="dropdown-header">Admin</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
            </ul>
        </div>
        {% endif %}
        <!-- Developer Menu (always available) -->
        <div class="dropdown ms-auto">
            <button class="btn btn-danger dropdown-toggle" type="button" id="devDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-code"></i> Developer Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="devDropdown">
                <!-- Developer Dashboard -->
                <li><a class="dropdown-item" href="{{ url_for('developer.dashboard') }}">
                    <i class="fas fa-tachometer-alt"></i> Developer Dashboard
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Organization Management -->
                <li><h6 class="dropdown-header">Organization Management</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.create_organization') }}">
                    <i class="fas fa-plus"></i> Create Organization
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                    <i class="fas fa-building"></i> All Organizations
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.users') }}">
                    <i class="fas fa-users"></i> User Management
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.system_roles.manage_system_roles') }}">
                    <i class="fas fa-user-shield"></i> Role Management
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('auth.manage_permissions') }}">
                    <i class="fas fa-key"></i> Permissions
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Global Library -->
                <li><h6 class="dropdown-header">Global Library</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.global_items_admin') }}">
                    <i class="fas fa-boxes"></i> Global Items
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">
                    <i class="fas fa-book-open"></i> Recipe Library
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.product_categories') }}">
                    <i class="fas fa-tags"></i> Product Categories
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.reference_categories') }}">
                    <i class="fas fa-leaf"></i> Ingredient Categories
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.container_management') }}">
                    <i class="fas fa-box-open"></i> Container Management
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.manage_ingredient_attributes') }}">
                    <i class="fas fa-layer-group"></i> Physical Forms
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Analytics -->
                <li><h6 class="dropdown-header">Analytics</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.analytics_catalog') }}">
                    <i class="fas fa-database"></i> Analytics Catalog
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.inventory_analytics_stub') }}">
                    <i class="fas fa-chart-line"></i> Inventory Analytics
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.system_statistics') }}">
                    <i class="fas fa-chart-bar"></i> System Statistics
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- AI & Automation -->
                <li><h6 class="dropdown-header">AI & Automation</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.batchley_overview') }}">
                    <i class="fas fa-robot"></i> Batchley
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Billing -->
                <li><h6 class="dropdown-header">Billing</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.subscription_tiers.manage_tiers') }}">
                    <i class="fas fa-layer-group text-primary"></i> Tier Management
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.addons.list_addons') }}">
                    <i class="fas fa-puzzle-piece"></i> Add-ons
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.billing_integration') }}">
                    <i class="fas fa-credit-card"></i> Billing Integration
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Marketing -->
                <li><h6 class="dropdown-header">Marketing</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.marketing_admin') }}">
                    <i class="fas fa-bullhorn"></i> Marketing Admin
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.waitlist_statistics') }}">
                    <i class="fas fa-envelope"></i> Waitlist
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Customer Support -->
                <li><h6 class="dropdown-header">Customer Support</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.organizations') }}">
                    <i class="fas fa-headset"></i> Customer Support
                    {% if session.get('dev_selected_org_id') %}
                    <span class="badge bg-primary ms-1">Active</span>
                    {% endif %}
                </a></li>
                {% if session.get('dev_selected_org_id') %}
                <li><a class="dropdown-item" href="{{ url_for('developer.clear_organization_filter') }}">
                    <i class="fas fa-times"></i> Clear Customer Filter
                </a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <!-- System -->
                <li><h6 class="dropdown-header">System</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.system_settings') }}">
                    <i class="fas fa-cogs"></i> System Settings
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.integrations_checklist') }}">
                    <i class="fas fa-plug"></i> Integrations & Launch
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.feature_flags') }}">
                    <i class="fas fa-toggle-on"></i> Feature Flags
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a></li>
            </ul>
        </div>
        {% else %}
        <!-- Customer Navigation -->
        <div class="navbar-nav me-auto">
        </div>
        {% if not has_nav_center %}
        <ul class="navbar-nav mx-auto d-none d-md-flex">
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                    üßÆ Converter
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/tools">
                    üîß Tools
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('help_routes.help_overview') }}">
                    ‚ùì Help
                </a>
            </li>
            <li class="nav-item">
                <div class="navbar-text">
                    <span id="header-clock" class="text-muted">üïê Loading...</span>
                </div>
            </li>
        </ul>
        {% endif %}
        <div class="dropdown ms-auto">
            <button class="btn btn-light dropdown-toggle" type="button" id="directoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-bars"></i> Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="directoryDropdown">
                {% if not recipes_ingredients_tier_nav %}
                <!-- User Dashboard -->
                <li><a class="dropdown-item" href="{{ url_for('app_routes.dashboard') }}">User Dashboard</a></li>
                <li><hr class="dropdown-divider"></li>
                {% endif %}
                <!-- Core Features -->
                <li><h6 class="dropdown-header">Core Features</h6></li>
                {% if customer_can_view_inventory and (not recipes_ingredients_tier_nav or tier_can_adjust_inventory) %}
                <li><a class="dropdown-item" href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
                {% elif recipes_ingredients_tier_nav %}
                <li>
                    <button type="button"
                            class="dropdown-item d-flex justify-content-between align-items-center feature-locked-trigger"
                            data-bs-toggle="modal"
                            data-bs-target="#featureUpgradeModal"
                            data-feature-name="Inventory"
                            data-feature-description="Inventory management is available on upgraded plans.">
                        Inventory
                        <span class="badge bg-warning text-dark"><i class="fas fa-lock me-1"></i>Upgrade</span>
                    </button>
                </li>
                {% endif %}
                {% if customer_can_view_recipes %}
                <li><a class="dropdown-item" href="{{ url_for('recipes.list_recipes') }}">Recipes</a></li>
                {% endif %}
                {% if customer_can_view_batches %}
                <li><a class="dropdown-item" href="{{ url_for('batches.list_batches') }}">Batches</a></li>
                {% endif %}
                {% if customer_can_view_products %}
                <li><a class="dropdown-item" href="{{ url_for('products.list_products') }}">Products</a></li>
                {% elif recipes_ingredients_tier_nav %}
                <li>
                    <button type="button"
                            class="dropdown-item d-flex justify-content-between align-items-center feature-locked-trigger"
                            data-bs-toggle="modal"
                            data-bs-target="#featureUpgradeModal"
                            data-feature-name="Products"
                            data-feature-description="Product catalog and SKU outputs are available on upgraded plans.">
                        Products
                        <span class="badge bg-warning text-dark"><i class="fas fa-lock me-1"></i>Upgrade</span>
                    </button>
                </li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                {% if recipes_ingredients_tier_nav %}
                <!-- Free Tools -->
                <li><h6 class="dropdown-header">Free Tools</h6></li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
                <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Settings -->
                <li><h6 class="dropdown-header">Settings</h6></li>
                {% if current_user.is_authenticated %}
                <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                {% endif %}
                {% else %}
                <!-- Production Tools -->
                <li><h6 class="dropdown-header">Production Tools</h6></li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#unitConverterModal">
                        üßÆ Converter
                    </a>
                </li>
                <li>
                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('expiration.alerts') }}">
                        Expiration
                        <span id="expiration-badge" class="badge bg-danger" style="display: none;">0</span>
                    </a>
                </li>
                {% if customer_can_view_batches %}
                <li><a class="dropdown-item" href="{{ url_for('timers.list_timers') }}">Timers</a></li>
                {% endif %}
                {% if has_role('developer') or has_role('organization_owner') or has_permission(current_user, 'organization.manage') %}
                <li><a class="dropdown-item" href="{{ url_for('reservation.list_reservations') }}">Reservations</a></li>
                {% endif %}
                {% if customer_can_view_products and bulk_stock_check_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('bulk_stock.bulk_stock_check') }}">Bulk Stock Check</a></li>
                {% endif %}
                {% if current_user.is_authenticated and has_permission(current_user, 'inventory.edit') and bulk_inventory_updates_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('inventory.bulk_inventory_updates') }}">Bulk Inventory Updates</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <!-- Resources -->
                <li><h6 class="dropdown-header">Resources</h6></li>
                {% if global_library_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Inventory Library</a></li>
                {% endif %}
                {% if show_recipe_library_link %}
                <li><a class="dropdown-item" href="{{ url_for('recipe_library_bp.recipe_library') }}">Recipe Library</a></li>
                {% endif %}
                <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Admin -->
                <li><h6 class="dropdown-header">Admin</h6></li>
                {% if current_user.is_authenticated and has_permission(current_user, 'organization.view') %}
                {% if current_user.user_type != 'developer' or session.get('dev_selected_org_id') %}
                <li><a class="dropdown-item" href="{{ url_for('organization.dashboard') }}">Organization Dashboard</a></li>
                {% endif %}
                {% endif %}
                {% if current_user.is_authenticated %}
                <li><a class="dropdown-item" href="{{ url_for('settings.index') }}">Settings</a></li>
                {% endif %}
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
            </ul>
        </div>
        {% endif %}
        {% else %}
        {% if use_public_header %}
        {% set public_header_is_homepage = public_header_is_homepage if public_header_is_homepage is defined else false %}
        {% set public_header_signup_source = public_header_signup_source if public_header_signup_source is defined else 'public_header' %}
        {% include 'components/shared/public_marketing_header.html' %}
        {% else %}
        <div class="navbar-nav me-auto"></div>
        <div class="dropdown ms-auto">
            <button class="btn btn-light dropdown-toggle" type="button" id="publicMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-bars"></i> Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="publicMenuDropdown">
                <li><a class="dropdown-item" href="{{ url_for('auth.signup') }}">Sign up</a></li>
                <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Sign in</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/tools">üîß Tools</a></li>
                {% if global_library_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('global_library_bp.global_library') }}">Global Library</a></li>
                {% endif %}
                <li><a class="dropdown-item" href="{{ url_for('help_routes.help_overview') }}">‚ùì Help</a></li>
            </ul>
        </div>
        {% endif %}
        {% endif %}
    </div>
</nav>
