<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0">Inventory Actions</h5>
  </div>
  <div class="card-body">
    <!-- Add Existing Inventory Form -->
    <form id="addExistingInventoryForm" method="POST" action="{{ url_for('products.adjust_sku', sku_id=sku.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Action Type</label>
          <select name="change_type" class="form-select" required>
            <option value="">Select action</option>
            <option value="restock" selected>Add Stock</option>
            <option value="spoil">Mark as Spoiled</option>
            <option value="trash">Dispose/Trash</option>
            <option value="sold">Manual Sale</option>
            <option value="gift">Gift/Sample</option>
            <option value="recount">Recount (Set Total)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantity</label>
          <input type="number" name="quantity" class="form-control" step="0.01" min="0.01" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Unit</label>
          {% if sku.size_label == 'Bulk' %}
          <input type="text" name="input_unit" class="form-control" value="{{ sku.product.base_unit }}" readonly>
          {% else %}
          <input type="text" name="input_unit" class="form-control" value="count" readonly>
          {% endif %}
        </div>
        <div class="col-md-2">
          <label class="form-label">Cost per Unit</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" name="unit_cost" class="form-control" step="0.01" min="0" placeholder="Optional" value="{{ sku.unit_cost or '' }}">
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Notes</label>
          <input type="text" name="notes" class="form-control" placeholder="Reason for adjustment">
        </div>
      </div>

      <!-- Perishable Section -->
      <div class="row mt-3">
        <div class="col-md-12">
          <div class="form-check">
            <input type="checkbox" id="is_perishable" name="is_perishable" class="form-check-input" onchange="toggleShelfLifeSection()">
            <label class="form-check-label" for="is_perishable">
              This inventory is perishable
            </label>
          </div>
        </div>
      </div>

      <!-- Shelf Life Section (hidden by default) -->
      <div id="shelfLifeSection" class="row mt-3" style="display: none;">
        <div class="col-md-4">
          <label class="form-label">Shelf Life (days)</label>
          <input type="number" id="shelf_life_days" name="shelf_life_days" class="form-control" min="1" placeholder="Enter days">
        </div>
        <div class="col-md-4">
          <label class="form-label">Expiration Date</label>
          <input type="date" id="expiration_date_display" class="form-control" readonly>
          <input type="hidden" id="expiration_date" name="expiration_date">
        </div>
        <div class="col-md-4">
          <label class="form-label">Entry Date</label>
          <input type="date" id="entry_date" name="entry_date" class="form-control" value="">
        </div>
      </div>

      <!-- Submit Button -->
      <div class="row mt-3">
        <div class="col-md-12">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Existing Inventory
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
function toggleShelfLifeSection() {
  const checkbox = document.getElementById('is_perishable');
  const shelfLifeSection = document.getElementById('shelfLifeSection');
  const shelfLifeDaysInput = document.getElementById('shelf_life_days');

  if (checkbox.checked) {
    shelfLifeSection.style.display = 'block';
    shelfLifeDaysInput.required = true;
  } else {
    shelfLifeSection.style.display = 'none';
    shelfLifeDaysInput.required = false;
    shelfLifeDaysInput.value = '';
    document.getElementById('expiration_date_display').value = '';
    document.getElementById('expiration_date').value = '';
  }
}

// Update expiration date when shelf life changes
document.getElementById('shelf_life_days').addEventListener('input', function() {
  updateExpirationDate();
});

document.getElementById('entry_date').addEventListener('change', function() {
  updateExpirationDate();
});

function updateExpirationDate() {
  const shelfLifeDays = parseInt(document.getElementById('shelf_life_days').value);
  const entryDate = document.getElementById('entry_date').value;

  if (shelfLifeDays && entryDate) {
    const entry = new Date(entryDate);
    const expiration = new Date(entry.getTime() + (shelfLifeDays * 24 * 60 * 60 * 1000));

    const expirationStr = expiration.toISOString().split('T')[0];
    document.getElementById('expiration_date_display').value = expirationStr;
    document.getElementById('expiration_date').value = expirationStr;
  }
}

// Initialize with current date
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  const entryDateInput = document.getElementById('entry_date');
  if (entryDateInput) {
    entryDateInput.value = today;
  }
});
</script>
</div>
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-tools"></i> Inventory Actions
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-success" onclick="showInventoryModal('sale')">
                        <i class="fas fa-cash-register"></i> Record Sale
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-info" onclick="showInventoryModal('gift')">
                        <i class="fas fa-gift"></i> Record Gift
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-warning" onclick="showInventoryModal('damage')">
                        <i class="fas fa-exclamation-triangle"></i> Record Damage
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" onclick="showInventoryModal('manual')">
                        <i class="fas fa-edit"></i> Manual Adjust
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-secondary" onclick="showInventoryModal('recount')">
                        <i class="fas fa-count"></i> Physical Count
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSkuModal">
                        <i class="fas fa-cog"></i> Edit Details
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inventory Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="inventoryForm" action="{{ url_for('product_inventory.adjust_sku_inventory', sku_id=sku.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action_type" id="actionType" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" step="0.01" required>
                        <div class="form-text">Current stock: {{ sku.current_quantity or 0 }} {{ sku.unit }}</div>
                    </div>
                    <div class="mb-3" id="salePriceDiv" style="display: none;">
                        <label for="salePrice" class="form-label">Sale Price ($)</label>
                        <input type="number" class="form-control" id="salePrice" name="sale_price" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitInventoryAdjustment()">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>
