<!-- Edit SKU Details Modal -->
<div class="modal fade" id="editSkuModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit SKU Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('sku.edit_sku', inventory_item_id=sku.inventory_item_id) }}" id="editSkuForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">SKU Code</label>
                            <input type="text" name="sku_code" class="form-control" value="{{ sku.sku_code or '' }}" placeholder="Enter SKU code">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Size Label</label>
                            <input type="text" name="size_label" class="form-control" value="{{ sku.size_label or '' }}" placeholder="e.g., 8oz, Large, Standard">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Retail Price ($)</label>
                            <input type="number" name="retail_price" class="form-control" value="{{ sku.retail_price or '' }}" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Low Stock Threshold</label>
                            <input type="number" name="low_stock_threshold" class="form-control" 
                                   value="{{ sku.low_stock_threshold or '' }}" step="0.01" min="0" placeholder="Minimum stock level">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <input type="text" name="location_name" class="form-control" value="{{ sku.location_name or '' }}" placeholder="Storage location">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit Cost ($)</label>
                            <div class="input-group">
                                <input type="number" name="unit_cost" id="edit_unit_cost" class="form-control" value="{{ sku.inventory_item.cost_per_unit if sku.inventory_item else sku.unit_cost or '' }}" step="0.01" min="0" readonly>
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" id="override_edit_unit_cost" name="override_unit_cost">
                                    <label class="form-check-label ms-1" for="override_edit_unit_cost">Override</label>
                                </div>
                            </div>
                            <small class="text-muted">Check override to manually set unit cost</small>
                        </div>

                        <!-- Shelf Life Management -->
                        <div class="col-12">
                            <hr>
                            <h6 class="mb-3">Shelf Life Management</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_perishable" name="is_perishable" {{ 'checked' if sku.is_perishable else '' }}>
                                <label class="form-check-label" for="is_perishable">
                                    This SKU is perishable
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6" id="shelfLifeGroup" style="{{ 'display: none;' if not sku.is_perishable else '' }}">
                            <label class="form-label">Shelf Life (days)</label>
                            <input type="number" name="shelf_life_days" id="shelf_life_days" class="form-control" value="{{ sku.shelf_life_days or '' }}" min="1" placeholder="Number of days">
                            <small class="text-muted">Will update all active FIFO entries</small>
                        </div>
                    </div>

                    <!-- Recount Section -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <hr>
                            <h6>Inventory Recount</h6>
                            <p class="text-muted small">Use this to correct inventory based on physical count</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Actual Quantity Found</label>
                            <input type="number" id="recount_quantity" name="recount_quantity" class="form-control" 
                                   step="0.001" min="0" placeholder="Enter actual count">
                            <div class="form-text">Current system quantity: {{ sku.current_quantity }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Recount Notes</label>
                            <textarea name="recount_notes" class="form-control" rows="2" 
                                      placeholder="Reason for discrepancy..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FIFO Adjustment Modal -->
<div class="modal fade" id="adjustFifoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ProductSKU Adjustment Modal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="adjustFifoForm" action="{{ url_for('product_inventory.adjust_sku_inventory', inventory_item_id=sku.inventory_item_id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="adjust_fifo">
                <input type="hidden" id="modalInventoryId" name="inventory_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="change_type" class="form-label">Adjustment Type</label>
                        <select name="change_type" id="change_type" class="form-select" required>
                            <option value="">Select adjustment type</option>
                            <!-- Business Deductions -->
                            <optgroup label="Business Deductions" id="businessGroup" style="display: none;">
                                <option value="sale">Sale</option>
                                <option value="gift">Gift</option>
                                <option value="sample">Tester/Sample</option>
                            </optgroup>
                            <!-- Loss/Waste -->
                            <optgroup label="Loss/Waste" id="lossGroup" style="display: none;">
                                <option value="damaged">Damage</option>
                                <option value="spoil">Spoilage</option>
                                <option value="trash">Trash</option>
                                <option value="expired">Expired</option>
                            </optgroup>
                            <!-- Manual Adjustments -->
                            <optgroup label="Manual Adjustments" id="manualGroup" style="display: none;">
                                <option value="manual_addition">Add Existing Stock</option>
                                <option value="recount">Recount (Set Total)</option>
                                <option value="reserved">Reserve for Order</option>
                                <option value="unreserved">Release Reservation</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3" id="quantityGroup">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               step="any" min="0" required>
                        <div class="form-text">
                            <span id="quantityHelp">Select an adjustment type to see quantity instructions.</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea name="notes" id="notes" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- POS Integration Fields -->
                    <div class="mb-3" id="orderIdGroup" style="display: none;">
                        <label for="order_id" class="form-label">Order ID</label>
                        <input type="text" name="order_id" id="order_id" class="form-control" placeholder="Required for reservations" required>
                        <small class="form-text text-muted">Required to track and manage reservations</small>
                    </div>

                    <div class="mb-3" id="salePriceGroup" style="display: none;">
                        <label for="sale_price" class="form-label">Sale Price ($)</label>
                        <input type="number" name="sale_price" id="sale_price" class="form-control" step="0.01" min="0" placeholder="Enter sale price">
                        <small class="form-text text-muted">Price for this sale transaction</small>
                    </div>

                    <div class="mb-3" id="restockCostGroup" style="display: none;">
                        <label for="restock_cost" class="form-label">Cost Per Unit ($)</label>
                        <input type="number" name="restock_cost" id="restock_cost" class="form-control" step="0.01" min="0" placeholder="Enter cost per unit">
                        <small class="form-text text-muted">Cost per unit for this restock (affects weighted average cost)</small>
                    </div>

                    <div class="mb-3" id="reservationGroup" style="display: none;">
                        <label for="expiration_minutes" class="form-label">Reservation Duration (minutes)</label>
                        <input type="number" name="expiration_minutes" id="expiration_minutes" class="form-control" value="30" min="1" max="1440">
                        <small class="form-text text-muted">How long to hold this reservation (default: 30 minutes)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Adjustment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Recount Modal -->
<div class="modal fade" id="recountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Recount Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('product_inventory.adjust_sku_inventory', inventory_item_id=sku.inventory_item_id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="change_type" value="recount">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Available Quantity</label>
                            <input type="number" name="available_quantity" class="form-control" step="0.01" min="0" 
                                   value="{{ sku.available_quantity_for_sale }}" required>
                            <small class="text-muted">Current: {{ "%.2f"|format(sku.available_quantity_for_sale) }}</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reserved Quantity</label>
                            <input type="number" name="reserved_quantity" class="form-control" step="0.01" min="0" 
                                   value="{{ sku.reserved_quantity }}" required>
                            <small class="text-muted">Current: {{ "%.2f"|format(sku.reserved_quantity) }}</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">Total Quantity</label>
                            <input type="text" class="form-control" id="totalQuantityDisplay" readonly>
                            <small class="text-muted">Available + Reserved = Total</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">Recount Notes</label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="Reason for discrepancy..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle unit cost override in edit modal
document.addEventListener('DOMContentLoaded', function() {
    const overrideCheckbox = document.getElementById('override_edit_unit_cost');
    const unitCostInput = document.getElementById('edit_unit_cost');

    if (overrideCheckbox && unitCostInput) {
        overrideCheckbox.addEventListener('change', function() {
            if (this.checked) {
                unitCostInput.removeAttribute('readonly');
                unitCostInput.focus();
            } else {
                unitCostInput.setAttribute('readonly', 'readonly');
                unitCostInput.value = '{{ sku.inventory_item.cost_per_unit if sku.inventory_item else sku.unit_cost or "" }}';
            }
        });
    }

    // Handle perishable checkbox
    const perishableCheckbox = document.getElementById('is_perishable');
    const shelfLifeGroup = document.getElementById('shelfLifeGroup');

    if (perishableCheckbox && shelfLifeGroup) {
        perishableCheckbox.addEventListener('change', function() {
            if (this.checked) {
                shelfLifeGroup.style.display = 'block';
            } else {
                shelfLifeGroup.style.display = 'none';
                document.getElementById('shelf_life_days').value = '';
            }
        });
    }

    // Handle FIFO adjustment type changes
    const changeTypeSelect = document.getElementById('change_type');
    const orderIdGroup = document.getElementById('orderIdGroup');
    const salePriceGroup = document.getElementById('salePriceGroup');
    const restockCostGroup = document.getElementById('restockCostGroup');
    const reservationGroup = document.getElementById('reservationGroup');

    if (changeTypeSelect) {
        changeTypeSelect.addEventListener('change', function() {
            const value = this.value;
            const quantityHelp = document.getElementById('quantityHelp');

            // Get quantity group for hiding/showing
            const quantityGroup = document.getElementById('quantityGroup');
            const quantityInput = document.getElementById('quantity');

            // Update quantity help text and visibility based on adjustment type
            if (quantityHelp) {
                switch(value) {
                    case 'sale':
                    case 'gift':
                    case 'sample':
                        quantityHelp.textContent = 'Enter the quantity sold/given away.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                        break;
                    case 'damaged':
                    case 'spoil':
                    case 'trash':
                    case 'expired':
                        quantityHelp.textContent = 'Enter the quantity lost/damaged/expired.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                        break;
                    case 'manual_addition':
                        quantityHelp.textContent = 'Enter the quantity to add to existing stock.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                        break;
                    case 'recount':
                        quantityHelp.textContent = 'Enter the new total quantity after recount.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                        break;
                    case 'reserved':
                        quantityHelp.textContent = 'Enter the quantity to reserve for this order.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                        break;
                    case 'unreserved':
                        quantityHelp.textContent = 'All reservations for this order will be released.';
                        quantityGroup.style.display = 'none';
                        quantityInput.required = false;
                        quantityInput.value = '';
                        break;
                    default:
                        quantityHelp.textContent = 'Select an adjustment type to see quantity instructions.';
                        quantityGroup.style.display = 'block';
                        quantityInput.required = true;
                }
            }

            // Show/hide order ID field for sales, reservations, and unreserve
            if (value === 'sale' || value === 'reserved' || value === 'unreserved') {
                orderIdGroup.style.display = 'block';
                // Make order ID required for reservations and unreserve
                const orderIdInput = document.getElementById('order_id');
                if (value === 'reserved' || value === 'unreserved') {
                    orderIdInput.required = true;
                    if (value === 'unreserved') {
                        orderIdInput.placeholder = 'Enter order ID to release all reservations';
                    } else {
                        orderIdInput.placeholder = 'Required for reservations';
                    }
                } else {
                    orderIdInput.required = false;
                    orderIdInput.placeholder = 'Optional order reference';
                }
            } else {
                orderIdGroup.style.display = 'none';
                document.getElementById('order_id').required = false;
            }

            // Show sale price field only for sales
            if (value === 'sale') {
                salePriceGroup.style.display = 'block';
                // Pre-populate with retail price if available
                const salePriceInput = document.getElementById('sale_price');
                if (salePriceInput && !salePriceInput.value) {
                    salePriceInput.value = '{{ sku.retail_price or "" }}';
                }
            } else {
                salePriceGroup.style.display = 'none';
            }

            // Show restock cost field for restock and manual addition operations
            if (value === 'restock' || value === 'manual_addition') {
                restockCostGroup.style.display = 'block';
                // Pre-populate with current unit cost if available
                const restockCostInput = document.getElementById('restock_cost');
                if (restockCostInput && !restockCostInput.value) {
                    restockCostInput.value = '{{ sku.inventory_item.cost_per_unit if sku.inventory_item else sku.unit_cost or "" }}';
                }
            } else {
                restockCostGroup.style.display = 'none';
            }

            // Show reservation duration only for reservations
            if (value === 'reserved') {
                reservationGroup.style.display = 'block';
            } else {
                reservationGroup.style.display = 'none';
            }
        });
    }
});

// Function for opening FIFO adjustment modal with specific action categories
window.openInventoryActionModal = function(action) {
    const modal = document.getElementById('adjustFifoModal');
    const modalTitle = modal.querySelector('.modal-title');
    const changeTypeSelect = document.getElementById('change_type');

    if (modal && changeTypeSelect) {
        // Hide all optgroups first
        const allGroups = ['businessGroup', 'lossGroup', 'manualGroup'];
        allGroups.forEach(groupId => {
            const group = document.getElementById(groupId);
            if (group) group.style.display = 'none';
        });

        // Clear previous selection
        changeTypeSelect.value = '';

        // Show appropriate group and set modal title based on action
        switch(action) {
            case 'business':
                modalTitle.textContent = 'Business Deductions';
                document.getElementById('businessGroup').style.display = 'block';
                break;
            case 'loss':
                modalTitle.textContent = 'Record Loss/Waste';
                document.getElementById('lossGroup').style.display = 'block';
                break;
            case 'manual':
                modalTitle.textContent = 'Manual Adjustments';
                document.getElementById('manualGroup').style.display = 'block';
                break;
        }

        // Trigger change event to show/hide relevant fields
        changeTypeSelect.dispatchEvent(new Event('change'));
        new bootstrap.Modal(modal).show();
    }
};

// Recount modal total calculation
document.addEventListener('DOMContentLoaded', function() {
    const availableInput = document.querySelector('input[name="available_quantity"]');
    const reservedInput = document.querySelector('input[name="reserved_quantity"]');
    const totalDisplay = document.getElementById('totalQuantityDisplay');

    function updateTotal() {
        if (availableInput && reservedInput && totalDisplay) {
            const available = parseFloat(availableInput.value) || 0;
            const reserved = parseFloat(reservedInput.value) || 0;
            const total = available + reserved;
            totalDisplay.value = total.toFixed(2);
        }
    }

    if (availableInput && reservedInput) {
        availableInput.addEventListener('input', updateTotal);
        reservedInput.addEventListener('input', updateTotal);

        // Calculate initial total
        updateTotal();
    }
});
</script>