<div class="modal fade" id="quickAddIngredientModal" tabindex="-1" aria-labelledby="quickAddIngredientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickAddIngredientModalLabel">Quick Add Ingredient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="quickAddIngredientForm" method="POST" action="{{ url_for('inventory.add_inventory') }}">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="type" value="ingredient">
          <input type="hidden" name="quantity" value="0">
          <input type="hidden" name="cost_per_unit" value="0">
          <input type="hidden" name="low_stock_threshold" value="0">

          <div class="mb-3">
            <label for="ingredientName" class="form-label">Ingredient Name</label>
            <input type="text" class="form-control" id="ingredientName" name="name" required>
          </div>

          <div class="mb-3">
            <label for="ingredientUnit" class="form-label">Unit</label>
            <select class="form-select" id="ingredientUnit" name="unit" required>
              <option value="">Select unit...</option>
              {% for unit in get_global_unit_list() %}
              <option value="{{ unit.name }}">{{ unit.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Ingredient</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ingredientForm = document.getElementById('quickAddIngredientForm');
  if (!ingredientForm) return;

  ingredientForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(ingredientForm);
    const submitBtn = ingredientForm.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    fetch(ingredientForm.action, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.redirected) {
        // Success - inventory was added and redirected
        showIngredientAlert('success', 'Ingredient added successfully!');

        // Add to ingredient dropdowns if they exist
        const newIngredientName = formData.get('name');
        const newIngredientUnit = formData.get('unit');

        // Find all ingredient selects and add the new option
        document.querySelectorAll('select[name="ingredient_ids[]"]').forEach(select => {
          if (select) {
            const option = document.createElement('option');
            option.value = 'temp-' + Date.now(); // Temporary ID until page refresh
            option.textContent = newIngredientName;
            option.dataset.unit = newIngredientUnit;
            option.dataset.type = 'ingredient';
            select.appendChild(option);
          }
        });

        // Reset form and close modal
        ingredientForm.reset();
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddIngredientModal'));
        modal.hide();
      } else {
        return response.text().then(text => {
          // Check if response contains error message
          if (text.includes('error') || text.includes('already exists')) {
            throw new Error('Ingredient name already exists or validation error');
          }
          throw new Error('Unexpected response');
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showIngredientAlert('error', error.message || 'Failed to add ingredient');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Ingredient';
    });
  });
});

function showIngredientAlert(type, message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  // Insert at top of main content area
  const container = document.querySelector('.container-fluid') || document.body;
  container.insertBefore(alertDiv, container.firstChild);

  // Auto dismiss after 5 seconds
  setTimeout(() => {
    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
    alert.close();
  }, 5000);
}
</script>