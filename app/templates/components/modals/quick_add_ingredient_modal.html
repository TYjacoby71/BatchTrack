
<div class="modal fade" id="quickAddIngredientModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Ingredient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddIngredientForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label for="new-ingredient-name" class="form-label">Name</label>
            <input type="text" class="form-control" id="new-ingredient-name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="new-ingredient-unit" class="form-label">Unit</label>
            <div class="input-group">
              <select class="form-control" id="new-ingredient-unit" name="unit" required>
                {% for unit in units %}
                  <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-outline-secondary" onclick="openUnitModalFromIngredient()">
                Add Unit
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Ingredient</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Function to open unit modal from ingredient modal
function openUnitModalFromIngredient() {
  // Set context so unit modal knows to return here
  window.quickAddReturnContext = 'ingredient';
  
  // Hide ingredient modal
  const ingredientModalElement = document.getElementById('quickAddIngredientModal');
  const ingredientModal = bootstrap.Modal.getInstance(ingredientModalElement);
  ingredientModal.hide();
  
  // Open unit modal
  setTimeout(() => {
    const unitModalElement = document.getElementById('quickAddUnitModal');
    const unitModal = new bootstrap.Modal(unitModalElement);
    unitModal.show();
  }, 150);
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('quickAddIngredientForm');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    fetch('/quick-add/ingredient', {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrf_token'),
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
      }
      return response.json();
    })
    .then(data => {
      // Add to any ingredient dropdowns on the page
      document.querySelectorAll('select[name="ingredient_ids[]"], select[name*="ingredient"]').forEach(select => {
        const option = new Option(data.name, data.id);
        option.dataset.unit = data.unit;
        option.dataset.type = 'ingredient';
        select.add(option);
      });

      // Show success message
      showIngredientAlert('success', data.message || 'Ingredient added successfully!');
      
      // Reset form
      form.reset();
      
      // Hide modal
      const modalElement = document.getElementById('quickAddIngredientModal');
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      modalInstance.hide();
      
      // If we're in ingredient context and have a return context, add ingredient line
      if (window.ingredientReturnContext === 'main' && typeof addIngredient === 'function') {
        // Add ingredient line and preselect the new ingredient
        setTimeout(() => {
          const newEntry = addIngredient(data.id);
          if (newEntry) {
            newEntry.scrollIntoView({ behavior: 'smooth' });
          }
        }, 300);
      }
    })
    .catch(error => {
      console.log('Error:', error);
      showIngredientAlert('danger', error.error || 'Failed to add ingredient');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Ingredient';
    });
  });
});

function showIngredientAlert(type, message) {
  // Create alert element
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Insert at top of main content area
  const container = document.querySelector('.container-fluid') || document.body;
  container.insertBefore(alertDiv, container.firstChild);
  
  // Auto dismiss after 5 seconds
  setTimeout(() => {
    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
    alert.close();
  }, 5000);
}
</script>
