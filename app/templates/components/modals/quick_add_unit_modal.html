<div class="modal fade" id="quickAddUnitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Unit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUnitForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label for="unitName" class="form-label">Unit Name</label>
            <input type="text" class="form-control" id="unitName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="unitType" class="form-label">Type</label>
            <select class="form-select" id="unitType" name="type" required>
              <option value="count">Count</option>
              <option value="volume">Volume</option>
              <option value="weight">Weight</option>
              <option value="length">Length</option>
              <option value="area">Area</option>
            </select>
          </div>
          <div class="mb-3">
            <small class="form-text text-muted">
              Custom units will be organization-specific and require mapping to work with recipes.
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelQuickUnit">Cancel</button>
        <button type="submit" class="btn btn-primary" form="quickAddUnitForm">Add Unit</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('quickAddUnitForm');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]') || document.querySelector('button[form="quickAddUnitForm"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    // Convert FormData to regular object for JSON
    const data = {
      name: formData.get('name'),
      type: formData.get('type')
    };

    console.log('Creating unit:', data.name + ' (' + data.type + ')');

    fetch('/quick-add/unit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': formData.get('csrf_token'),
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
      }
      return response.json();
    })
    .then(data => {
      console.log('Unit created successfully:', data);

      // Add to all unit dropdowns on the page
      document.querySelectorAll('select[name="units[]"], select[name*="unit"], select[name="predicted_yield_unit"]').forEach(select => {
        const option = new Option(data.name, data.name);
        option.dataset.type = data.type;
        option.dataset.symbol = data.symbol;
        select.add(option);ymbol;
        select.add(option);
      });

      // Clear form and close modal
      document.getElementById('quickAddUnitForm').reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddUnitModal'));
      modal.hide();

      // Show success message
      showAlert('success', `Unit "${data.name}" created successfully!`);

      // Handle return context
      if (window.quickAddReturnContext === 'ingredient') {
        // Reopen ingredient modal after short delay
        setTimeout(() => {
          const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
          ingredientModal.show();

          // Set the new unit as selected in ingredient modal
          const ingredientUnitSelect = document.querySelector('#quickAddIngredientModal select[name="unit"]');
          if (ingredientUnitSelect) {
            ingredientUnitSelect.value = data.name;
          }
        }, 300);
      }

      // Reset context
      window.quickAddReturnContext = null;
    })
    .catch(error => {
      console.error('Error:', error);
      alert(error.error || 'Failed to add unit');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Unit';
    });
  });

  // Handle cancel button - return to ingredient modal if that's where we came from
  document.getElementById('cancelQuickUnit').addEventListener('click', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddUnitModal'));
    modal.hide();

    if (window.quickAddReturnContext === 'ingredient') {
      setTimeout(() => {
        const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
        ingredientModal.show();
      }, 150);
    }
  });
});
</script>