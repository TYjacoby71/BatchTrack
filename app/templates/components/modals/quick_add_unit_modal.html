<div class="modal fade" id="quickAddUnitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Unit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUnitForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label for="unitName" class="form-label">Unit Name</label>
            <input type="text" class="form-control" id="unitName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="unitType" class="form-label">Type</label>
            <select class="form-select" id="unitType" name="type" required>
              <option value="count">Count</option>
              <option value="volume">Volume</option>
              <option value="weight">Weight</option>
              <option value="length">Length</option>
              <option value="area">Area</option>
            </select>
          </div>
          <div class="mb-3">
            <small class="form-text text-muted">
              Custom units will be organization-specific and require mapping to work with recipes.
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelQuickUnit">Cancel</button>
        <button type="submit" class="btn btn-primary" form="quickAddUnitForm">Add Unit</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('quickAddUnitForm');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    fetch('/quick-add/unit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: formData.get('name'),
        type: formData.get('type')
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
      }
      return response.json();
    })
    .then(data => {
      // Add to all unit dropdowns
      document.querySelectorAll('select[name*="unit"], select[id*="unit"]').forEach(select => {
        const option = new Option(data.name, data.name);
        select.add(option);
      });

      // Show success message
      showUnitAlert('success', 'Unit added successfully!');

      // Reset form
      form.reset();

      // Hide modal
      const modalElement = document.getElementById('quickAddUnitModal');
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      modalInstance.hide();

      // Return to ingredient modal if that's the context
      if (window.quickAddReturnContext === 'ingredient') {
        setTimeout(() => {
          const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
          ingredientModal.show();
        }, 150);
      }
    })
    .catch(error => {
      console.log('Error:', error);
      showUnitAlert('danger', error.error || 'Failed to add unit');
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Unit';
    });
  });

  // Handle cancel button
  document.getElementById('cancelQuickUnit')?.addEventListener('click', function() {
    const modalElement = document.getElementById('quickAddUnitModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    modalInstance.hide();

    if (window.quickAddReturnContext === 'ingredient') {
      setTimeout(() => {
        const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
        ingredientModal.show();
      }, 150);
    }
  });
});
</script>