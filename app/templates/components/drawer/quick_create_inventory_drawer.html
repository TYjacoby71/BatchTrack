<div class="modal fade" id="quickCreateInventoryModal" tabindex="-1" aria-labelledby="quickCreateInventoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickCreateInventoryLabel">
                    <i class="fas fa-bolt text-primary"></i>
                    Quick Create Inventory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickCreateInventoryForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="qcInvName" placeholder="Search global or enter custom..." autocomplete="off">
                                <div id="qcInvSuggestions" class="list-group position-absolute w-100 d-none" data-empty-message="Start typing to search your inventory and the global library." style="z-index: 1050; max-height: 260px; overflow-y: auto;"></div>
                            </div>
                            <div class="form-text">Start typing to search your inventory and the global library. Selecting a global item will be added to your inventory.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="qcInvType">
                                <option value="ingredient">Ingredient</option>
                                <option value="container">Container</option>
                                <option value="consumable">Consumable</option>
                                <option value="packaging">Packaging</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit</label>
                            <select class="form-select" id="qcInvUnit">
                                {% for unit in inventory_units %}
                                <option value="{{ unit.name }}">{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 d-none" id="qcContainerFields">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">Capacity</label>
                                    <input type="number" step="0.01" class="form-control" id="qcInvCapacity" placeholder="0.00">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Capacity Unit</label>
                                    <select class="form-select" id="qcInvCapacityUnit">
                                        {% for unit in inventory_units %}
                                        <option value="{{ unit.name }}">{{ unit.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-4">
                                    <label class="form-label">Material</label>
                                    <input type="text" class="form-control" id="qcInvMaterial" placeholder="Glass / Plastic / Metal">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Type</label>
                                    <input type="text" class="form-control" id="qcInvTypeName" placeholder="Jar / Bottle / Tin">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Style</label>
                                    <input type="text" class="form-control" id="qcInvStyle" placeholder="Boston Round / Straight Sided">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Color</label>
                                    <input type="text" class="form-control" id="qcInvColor" placeholder="Amber / Clear / White">
                                </div>
                            </div>
                            <div class="form-text">Containers are counted in "count". Capacity helps planning.</div>
                        </div>
                        <div class="col-md-12">
                            <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#qcAdvanced" aria-expanded="false">
                                Advanced
                            </button>
                            <div class="collapse mt-2" id="qcAdvanced">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Base Category</label>
                                        <select class="form-select" id="qcInvCategory">
                                            <option value="">None</option>
                                            {% for cat in categories %}
                                            <option value="{{ cat.id }}" data-density="{{ '%.3f'|format(cat.default_density or 0) }}">{{ cat.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Density (g/ml)</label>
                                        <input type="number" step="0.001" min="0" class="form-control" id="qcInvDensity" placeholder="Auto from category or global">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="qcInvGlobalItemId" value="">
                </form>
                <div class="mt-2 small text-muted" id="qcGlobalHint" style="display:none;">
                    <i class="fas fa-info-circle"></i> This global item will be added to your inventory and inserted into the recipe.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="qcInvSubmit">
                    <i class="fas fa-save"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const init = function(){
        const nameInput = document.getElementById('qcInvName');
        const typeSelect = document.getElementById('qcInvType');
        const unitSelect = document.getElementById('qcInvUnit');
        const catSelect = document.getElementById('qcInvCategory');
        const densityInput = document.getElementById('qcInvDensity');
        const capacityWrap = document.getElementById('qcContainerFields');
        const capInput = document.getElementById('qcInvCapacity');
        const capUnit = document.getElementById('qcInvCapacityUnit');
        const globalIdField = document.getElementById('qcInvGlobalItemId');
        const matInput = document.getElementById('qcInvMaterial');
        const typeNameInput = document.getElementById('qcInvTypeName');
        const styleInput = document.getElementById('qcInvStyle');
        const colorInput = document.getElementById('qcInvColor');
        const submitBtn = document.getElementById('qcInvSubmit');
        const globalHint = document.getElementById('qcGlobalHint');

        const modalEl = document.getElementById('quickCreateInventoryModal');
        if (!modalEl) return;

        function updateTypeVisibility(){
            const isContainer = typeSelect ? (typeSelect.value === 'container') : false;
            if (capacityWrap) {
                if (isContainer) {
                    capacityWrap.classList.remove('d-none');
                } else {
                    capacityWrap.classList.add('d-none');
                }
            }
        }
        if (typeSelect) {
            typeSelect.addEventListener('change', function(){
                updateTypeVisibility();
                if (nameInput && nameInput.value.trim()) {
                    nameInput.dispatchEvent(new Event('input'));
                }
            });
            updateTypeVisibility();
        }

        // Category default density autofill and lock behavior
        if (catSelect && densityInput) {
            catSelect.addEventListener('change', function(){
                const opt = catSelect.options[catSelect.selectedIndex];
                const d = parseFloat(opt && opt.dataset && opt.dataset.density || '0');
                if (catSelect.value !== '') {
                    if (d > 0) {
                        densityInput.value = d.toFixed(3);
                    }
                    densityInput.readOnly = true;
                    densityInput.disabled = true;
                } else {
                    densityInput.readOnly = false;
                    densityInput.disabled = false;
                }
            });
            // Initialize lock state on open
            (function(){
                const opt = catSelect.options[catSelect.selectedIndex];
                const d = parseFloat(opt && opt.dataset && opt.dataset.density || '0');
                if (catSelect.value !== '') {
                    if (d > 0) {
                        densityInput.value = d.toFixed(3);
                    }
                    densityInput.readOnly = true;
                    densityInput.disabled = true;
                }
            })();
        }

        if (nameInput && globalIdField && typeof window.attachMergedInventoryGlobalTypeahead === 'function') {
            const suggestionList = document.getElementById('qcInvSuggestions');
            const populateContainerFields = (picked) => {
                if (!picked) return;
                const setValue = (el, value) => {
                    if (el && value !== undefined && value !== null && value !== '') {
                        el.value = value;
                    }
                };
                setValue(capInput, picked.capacity);
                setValue(capUnit, picked.capacity_unit);
                setValue(matInput, picked.container_material);
                setValue(typeNameInput, picked.container_type);
                setValue(styleInput, picked.container_style);
                setValue(colorInput, picked.container_color);
            };

            window.attachMergedInventoryGlobalTypeahead({
                inputEl: nameInput,
                giHiddenEl: globalIdField,
                listEl: suggestionList,
                mode: 'quick_create_inventory',
                searchType: () => (typeSelect ? typeSelect.value : 'ingredient'),
                includeInventory: true,
                includeGlobal: true,
                ingredientFirst: () => (typeSelect && typeSelect.value === 'ingredient'),
                onSelection: function(picked, source){
                    if (unitSelect && picked && picked.default_unit) {
                        unitSelect.value = picked.default_unit;
                    }
                    if (typeSelect && typeSelect.value === 'container') {
                        populateContainerFields(picked || {});
                    }
                    if (globalHint) {
                        globalHint.style.display = 'block';
                        globalHint.textContent = source === 'global'
                          ? 'This global item will be added to your inventory.'
                          : 'You already have this item. Creating will restock it.';
                    }
                }
            });

            nameInput.addEventListener('input', function(){
                if (!this.value.trim()) {
                    globalIdField.value = '';
                    if (globalHint) globalHint.style.display = 'none';
                }
            });
        }

        if (submitBtn) {
            submitBtn.addEventListener('click', async function(){
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                try {
                    const payload = {
                        name: nameInput ? nameInput.value.trim() : '',
                        type: typeSelect ? typeSelect.value : 'ingredient',
                        unit: unitSelect ? unitSelect.value : 'count',
                        category_id: catSelect ? (catSelect.value || '') : '',
                        density: densityInput ? (densityInput.value || '') : ''
                    };
                    if (globalIdField && globalIdField.value) payload.global_item_id = globalIdField.value;
                    if (typeSelect && typeSelect.value === 'container') {
                        if (capInput && capInput.value) payload.capacity = capInput.value;
                        if (capUnit && capUnit.value) payload.capacity_unit = capUnit.value;
                        if (matInput && matInput.value) payload.container_material = matInput.value;
                        if (typeNameInput && typeNameInput.value) payload.container_type = typeNameInput.value;
                        if (styleInput && styleInput.value) payload.container_style = styleInput.value;
                        if (colorInput && colorInput.value) payload.container_color = colorInput.value;
                    }

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const res = await fetch('/inventory/api/quick-create', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!data || !data.success) throw new Error(data && data.error || 'Create failed');

                // Emit event for inline insert
                window.dispatchEvent(new CustomEvent('inventory.quickCreated', { detail: { item: data.item } }));

                // Close modal
                    const instance = bootstrap.Modal.getInstance(modalEl);
                    if (instance) instance.hide();
                } catch (e) {
                    alert(e.message || 'Failed to create');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Create';
                }
            });
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
        init();
    }
})();
</script>