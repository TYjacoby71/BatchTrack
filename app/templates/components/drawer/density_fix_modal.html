<div class="modal fade" id="densityFixModal" tabindex="-1" aria-labelledby="densityFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="densityFixModalLabel">
                    <i class="fas fa-balance-scale text-warning"></i>
                    Fix Missing Density
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Density Required:</strong> To convert between volume and weight units for 
                    <strong>{{ ingredient.name }}</strong>, we need its density value.
                </div>

                <form id="densityFixForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="densitySearchInput" class="form-label">Search Reference Guide</label>
                        <input type="text" 
                               class="form-control" 
                               id="densitySearchInput" 
                               placeholder="Search for specific ingredient or category..."
                               value="{% if ingredient.reference_item_name %}{{ ingredient.reference_item_name }}{% endif %}">
                        <div class="form-text">Search for your ingredient in our comprehensive density reference guide</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Density Options</label>
                        <div id="densityOptionsContainer" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="form-text">Select a specific ingredient or category default</div>
                    </div>

                    <input type="hidden" id="selectedDensityType" value="">
                    <input type="hidden" id="selectedDensityValue" value="">
                    <input type="hidden" id="selectedReferenceItem" value="">
                    <input type="hidden" id="selectedCategoryName" value="">
                    <div class="mb-3">
                        <label for="densityInput" class="form-label">
                            Density (g/ml):
                            <small class="text-muted">How many grams per milliliter</small>
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="densityInput" 
                               name="density"
                               step="0.001" 
                               min="0.001" 
                               max="50"
                               placeholder="e.g., 0.96 for beeswax"
                               value="{% if ingredient.density %}{{ '%.3f'|format(ingredient.density) }}{% elif ingredient.category and ingredient.category.default_density %}{{ '%.3f'|format(ingredient.category.default_density) }}{% else %}{% endif %}"
                               {% if ingredient.category_id and (not ingredient.density) %}disabled{% endif %}>
                        <div class="form-text">
                            Common densities: Water (1.0), Oil (0.91), Honey (1.42), Beeswax (0.96)
                        </div>
                    </div>
                </form>

                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="openDensityReference()">
                            <i class="fas fa-book"></i> Reference
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDensityBtn">
                            <i class="fas fa-save"></i> Save Density
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const init = function() {
    console.log('ðŸ”§ DENSITY MODAL: Initializing density modal (DOM ready or injected)...');

    // Check for modal conflicts
    const allDensityModals = document.querySelectorAll('[id*="density"], [id*="Density"]');
    console.log('ðŸ”§ DENSITY MODAL: Found modals with density in ID:', allDensityModals);

    const modal = document.getElementById('densityFixModal');
    const form = document.getElementById('densityFixForm');
    const saveBtn = document.getElementById('saveDensityBtn');
    const densityInput = document.getElementById('densityInput');
    const categorySelect = document.getElementById('drawerCategorySelect');

    console.log('ðŸ”§ DENSITY MODAL: Elements found:', {
        modal: !!modal,
        form: !!form,
        saveBtn: !!saveBtn,
        densityInput: !!densityInput
    });

    if (!modal) {
        console.error('ðŸ”§ DENSITY MODAL: Modal not found!');
        return;
    }

    // Store ingredient data as data attributes on the modal
    modal.setAttribute('data-ingredient-id', '{{ ingredient.id }}');
    modal.setAttribute('data-ingredient-name', '{{ ingredient.name }}');

    // Get ingredient data from modal attributes
    const ingredientId = parseInt(modal.getAttribute('data-ingredient-id'));
    const ingredientName = modal.getAttribute('data-ingredient-name');

    console.log('ðŸ”§ DENSITY MODAL: DOM loaded for ingredient:', ingredientId, ingredientName);
    console.log('ðŸ”§ DENSITY MODAL: This is the INGREDIENT density modal (not product density)');

    if (saveBtn) {
        console.log('ðŸ”§ DENSITY MODAL: Save button found and attaching listener');

        // Initialize density options
        let densityOptions = [];

        // Load density options from server
        fetch('/api/ingredients/global-library/density-options')
            .then(response => response.json())
            .then(data => {
                densityOptions = data;
                renderDensityOptions(densityOptions);
            })
            .catch(error => {
                console.error('Failed to load density options:', error);
            });

        const searchInput = document.getElementById('densitySearchInput');
        const optionsContainer = document.getElementById('densityOptionsContainer');

          function renderDensityOptions(options, searchTerm = '') {
              if (!optionsContainer) return;

              optionsContainer.innerHTML = '';

              options.forEach(category => {
                  const categoryName = (category.name || '').toString();
                  const normalizedSearch = searchTerm.toLowerCase();

                  // Filter items based on search
                  let filteredItems = Array.isArray(category.items) ? [...category.items] : [];
                  if (normalizedSearch) {
                      filteredItems = filteredItems.filter(item => {
                          const itemName = (item.name || '').toLowerCase();
                          const aliases = Array.isArray(item.aliases) ? item.aliases : [];
                          return itemName.includes(normalizedSearch) ||
                              aliases.some(alias => alias.toLowerCase().includes(normalizedSearch));
                      });
                  }

                  const categoryMatches = categoryName.toLowerCase().includes(normalizedSearch);
                  if (filteredItems.length === 0 && normalizedSearch && !categoryMatches) {
                      return; // Skip category if no matches
                  }

                  const categoryDiv = document.createElement('div');
                  categoryDiv.className = 'mb-2';

                  const hasDefaultDensity = typeof category.default_density === 'number' && !Number.isNaN(category.default_density);
                  const defaultDensityDisplay = hasDefaultDensity ? Number(category.default_density).toFixed(3) : null;

                  let categoryHeader = `<h6 class="text-primary mb-1">${categoryName}</h6>`;
                  if (hasDefaultDensity) {
                      categoryHeader += `
                          <div class="form-check mb-1">
                              <input class="form-check-input density-option" type="radio" name="densityOption" 
                                     value="category-default" 
                                     data-density="${defaultDensityDisplay}"
                                     data-category="${categoryName}"
                                     id="cat-${categoryName.replace(/\s+/g, '-')}">
                              <label class="form-check-label" for="cat-${categoryName.replace(/\s+/g, '-')}">
                                  <strong>${categoryName} (Default)</strong> - ${defaultDensityDisplay} g/ml
                              </label>
                          </div>
                      `;
                  }

                  categoryDiv.innerHTML = categoryHeader;

                  // Add specific items
                  filteredItems.forEach(item => {
                      if (typeof item.density_g_per_ml !== 'number' || Number.isNaN(item.density_g_per_ml)) {
                          return;
                      }
                      const densityDisplay = Number(item.density_g_per_ml).toFixed(3);
                      const itemId = `item-${item.name.replace(/\s+/g, '-')}`;
                      const aliases = Array.isArray(item.aliases) ? item.aliases : [];
                      const aliasMarkup = aliases.length > 0 ? `<small class="text-muted">(${aliases.join(', ')})</small>` : '';

                      const itemDiv = document.createElement('div');
                      itemDiv.className = 'form-check ms-3 mb-1';
                      itemDiv.innerHTML = `
                          <input class="form-check-input density-option" type="radio" name="densityOption" 
                                 value="reference-item" 
                                 data-density="${densityDisplay}"
                                 data-reference-item="${item.name}"
                                 id="${itemId}">
                          <label class="form-check-label" for="${itemId}">
                              ${item.name} - ${densityDisplay} g/ml
                              ${aliasMarkup}
                          </label>
                      `;
                      categoryDiv.appendChild(itemDiv);
                  });

                  optionsContainer.appendChild(categoryDiv);
              });

            // Add manual option at the end
            const manualDiv = document.createElement('div');
            manualDiv.className = 'mt-3 pt-2 border-top';
            manualDiv.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input density-option" type="radio" name="densityOption" 
                           value="manual" id="manual-density">
                    <label class="form-check-label" for="manual-density">
                        <strong>Manual Entry</strong> - Enter custom density
                    </label>
                </div>
            `;
            optionsContainer.appendChild(manualDiv);

            // Handle density option selection
            document.querySelectorAll('.density-option').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        const type = this.value;
                        document.getElementById('selectedDensityType').value = type;

                        if (type === 'reference-item') {
                            const density = this.dataset.density;
                            const referenceItem = this.dataset.referenceItem;
                            document.getElementById('selectedDensityValue').value = density;
                            document.getElementById('selectedReferenceItem').value = referenceItem;
                            densityInput.value = density;
                            densityInput.disabled = true;
                        } else if (type === 'category-default') {
                            const density = this.dataset.density;
                            const categoryName = this.dataset.category;
                            document.getElementById('selectedDensityValue').value = density;
                            document.getElementById('selectedCategoryName').value = categoryName;
                            densityInput.value = density;
                            densityInput.disabled = true;
                        } else if (type === 'manual') {
                            document.getElementById('selectedDensityValue').value = '';
                            document.getElementById('selectedReferenceItem').value = '';
                            document.getElementById('selectedCategoryName').value = '';
                            densityInput.disabled = false;
                            densityInput.focus();
                        }
                    }
                });
            });
        }

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                renderDensityOptions(densityOptions, searchTerm);
            });
        }

        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ðŸ”§ DENSITY MODAL: Save button clicked for ingredient:', ingredientId, ingredientName);
            console.log('ðŸ”§ DENSITY MODAL: Button element:', saveBtn);
            console.log('ðŸ”§ DENSITY MODAL: Input element:', densityInput);
            console.log('ðŸ”§ DENSITY MODAL: Modal element:', modal);

            const selectedCategoryId = categorySelect ? categorySelect.value : '';
            const isCustomCategory = !selectedCategoryId;
            const selectedOption = categorySelect ? categorySelect.options[categorySelect.selectedIndex] : null;
            const defaultDensity = selectedOption ? parseFloat(selectedOption.dataset.density || '0') : 0;
            const density = isCustomCategory ? parseFloat(densityInput.value) : defaultDensity;
            console.log('ðŸ”§ DENSITY MODAL: Raw input value:', densityInput.value);
            console.log('ðŸ”§ DENSITY MODAL: Parsed density value:', density);

            // Validate only when custom category
            if (isCustomCategory) {
                if (!density || density <= 0) {
                    console.error('ðŸ”§ DENSITY MODAL: Invalid density value');
                    alert('Please enter a valid density greater than 0');
                    return;
                }
            }

            console.log('ðŸ”§ DENSITY MODAL: Starting save process...');

            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            console.log('ðŸ”§ DENSITY MODAL: Button disabled and showing spinner');

            // Build form data for inventory edit route
            const formData = new FormData(form);
            if (selectedCategoryId) {
                formData.set('category_id', selectedCategoryId);
                // Persist category's default density to resolve zero/None edge cases
                if (defaultDensity && defaultDensity > 0) {
                    formData.set('density', String(defaultDensity));
                } else {
                    formData.delete('density');
                }
            } else {
                formData.set('density', String(density));
            }

            // Submit to existing inventory edit route
            const url = `/inventory/edit/${ingredientId}`;
            console.log('ðŸ”§ DENSITY MODAL: Submitting to', url);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData,
                redirect: 'follow'
            })
            .then(async (response) => {
                console.log('ðŸ”§ DENSITY MODAL: Response received', response.status, response.ok);
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                // Consider any 2xx/redirect-followed 200 as success
                try {
                    // Try to parse JSON if available (not required)
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('ðŸ”§ DENSITY MODAL: JSON response', data);
                    }
                } catch (err) {
                    console.log('ðŸ”§ DENSITY MODAL: Non-JSON response (expected on redirect)');
                }

                // Close modal
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) instance.hide();

                // Dispatch success event for DrawerProtocol retry
                const eventDetail = { ingredient_id: ingredientId, density };
                console.log('ðŸ”§ DENSITY MODAL: Dispatching success event conversion.density.updated with detail', eventDetail);
                window.dispatchEvent(new CustomEvent('conversion.density.updated', { detail: eventDetail }));

                // Reset button
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Density';
            })
            .catch((error) => {
                console.error('ðŸš¨ DENSITY MODAL: Save failed', error);
                alert('Failed to save density. Please try again.');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Density';
            });
        });

        console.log('ðŸ”§ DENSITY MODAL: Click listener added to save button');
    } else {
        console.error('ðŸ”§ DENSITY MODAL: Save button not found during initialization');
    }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
        init();
    }
})();

function openDensityReference() {
    window.open('/global-items?type=ingredient', '_blank');
}
</script>