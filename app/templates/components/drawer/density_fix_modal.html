
<div class="modal fade" id="densityFixModal" tabindex="-1" aria-labelledby="densityFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="densityFixModalLabel">
                    <i class="fas fa-balance-scale text-warning"></i>
                    Fix Missing Density
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Density Required:</strong> To convert between volume and weight units for 
                    <strong>{{ ingredient.name }}</strong>, we need its density value.
                </div>

                <form id="densityFixForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="densityInput" class="form-label">
                            Density (g/ml):
                            <small class="text-muted">How many grams per milliliter</small>
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="densityInput" 
                               name="density"
                               step="0.001" 
                               min="0.001" 
                               max="50"
                               placeholder="e.g., 0.96 for beeswax"
                               required>
                        <div class="form-text">
                            Common densities: Water (1.0), Oil (0.91), Honey (1.42), Beeswax (0.96)
                        </div>
                    </div>
                </form>

                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="openDensityReference()">
                            <i class="fas fa-book"></i> Reference
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDensityBtn">
                            <i class="fas fa-save"></i> Save Density
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent duplicate modals
    const existingModal = document.querySelector('#densityFixModal');
    if (existingModal && bootstrap.Modal.getInstance(existingModal)) {
        console.log('ðŸ”§ DENSITY MODAL: Modal already exists, skipping initialization');
        return;
    }

    const modal = document.getElementById('densityFixModal');
    const form = document.getElementById('densityFixForm');
    const saveBtn = document.getElementById('saveDensityBtn');
    const densityInput = document.getElementById('densityInput');

    // Store ingredient data as data attributes on the modal
    modal.setAttribute('data-ingredient-id', '{{ ingredient.id }}');
    modal.setAttribute('data-ingredient-name', '{{ ingredient.name }}');

    // Get ingredient data from modal attributes
    const ingredientId = parseInt(modal.getAttribute('data-ingredient-id'));
    const ingredientName = modal.getAttribute('data-ingredient-name');

    console.log('ðŸ”§ DENSITY MODAL: DOM loaded for ingredient:', ingredientId, ingredientName);
    console.log('ðŸ”§ DENSITY MODAL: Modal element:', modal);
    console.log('ðŸ”§ DENSITY MODAL: Save button:', saveBtn);
    console.log('ðŸ”§ DENSITY MODAL: Density input:', densityInput);

    if (saveBtn) {
        console.log('ðŸ”§ DENSITY MODAL: Adding click listener to save button');
        
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ðŸ”§ DENSITY MODAL: ==================== SAVE BUTTON CLICKED ====================');
            console.log('ðŸ”§ DENSITY MODAL: Event object:', e);
            console.log('ðŸ”§ DENSITY MODAL: Target button:', e.target);
            console.log('ðŸ”§ DENSITY MODAL: Button disabled state:', saveBtn.disabled);

            const density = parseFloat(densityInput.value);
            console.log('ðŸ”§ DENSITY MODAL: Raw input value:', densityInput.value);
            console.log('ðŸ”§ DENSITY MODAL: Parsed density value:', density);
            console.log('ðŸ”§ DENSITY MODAL: Density validation - isNaN:', isNaN(density), 'density <= 0:', density <= 0);

            if (!density || density <= 0 || isNaN(density)) {
                console.error('ðŸ”§ DENSITY MODAL: Invalid density value provided');
                alert('Please enter a valid density greater than 0');
                return;
            }

            // Disable button during save
            console.log('ðŸ”§ DENSITY MODAL: Disabling save button and showing spinner');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const apiUrl = `/inventory/edit/${ingredientId}`;
            console.log('ðŸ”§ DENSITY MODAL: Target API URL:', apiUrl);
            console.log('ðŸ”§ DENSITY MODAL: Ingredient ID:', ingredientId, 'Name:', ingredientName);

            // Get CSRF token from meta tag or form
            const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const csrfTokenForm = document.querySelector('input[name="csrf_token"]')?.value;
            const csrfToken = csrfTokenMeta || csrfTokenForm;
            
            console.log('ðŸ”§ DENSITY MODAL: CSRF token from meta:', csrfTokenMeta);
            console.log('ðŸ”§ DENSITY MODAL: CSRF token from form:', csrfTokenForm);
            console.log('ðŸ”§ DENSITY MODAL: Final CSRF token:', csrfToken);

            // Prepare form data like the regular inventory form
            const formData = new FormData();
            formData.append('density', density);
            formData.append('csrf_token', csrfToken);
            
            console.log('ðŸ”§ DENSITY MODAL: FormData prepared:');
            for (let [key, value] of formData.entries()) {
                console.log('ðŸ”§ DENSITY MODAL: FormData -', key + ':', value);
            }

            console.log('ðŸ”§ DENSITY MODAL: Starting fetch request...');
            
            fetch(apiUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'  // Mark as AJAX request
                }
            })
            .then(response => {
                console.log('ðŸ”§ DENSITY MODAL: ==================== FETCH RESPONSE ====================');
                console.log('ðŸ”§ DENSITY MODAL: Response status:', response.status);
                console.log('ðŸ”§ DENSITY MODAL: Response statusText:', response.statusText);
                console.log('ðŸ”§ DENSITY MODAL: Response headers:', Object.fromEntries(response.headers.entries()));
                console.log('ðŸ”§ DENSITY MODAL: Response ok:', response.ok);
                console.log('ðŸ”§ DENSITY MODAL: Response redirected:', response.redirected);
                console.log('ðŸ”§ DENSITY MODAL: Response URL:', response.url);
                
                // For inventory edit route, a redirect (3xx) or success (2xx) means it worked
                if (response.ok || (response.status >= 300 && response.status < 400)) {
                    console.log('ðŸ”§ DENSITY MODAL: ==================== SUCCESS RESPONSE ====================');
                    console.log('ðŸ”§ DENSITY MODAL: Density updated successfully');
                    console.log('ðŸ”§ DENSITY MODAL: Attempting to close modal...');

                    // Close modal
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    console.log('ðŸ”§ DENSITY MODAL: Modal instance:', modalInstance);
                    
                    if (modalInstance) {
                        modalInstance.hide();
                        console.log('ðŸ”§ DENSITY MODAL: Modal hide() called');
                    } else {
                        console.warn('ðŸ”§ DENSITY MODAL: No modal instance found, trying alternative close');
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                    }

                    // Dispatch success event for retry mechanism
                    const eventDetail = {
                        ingredient_id: ingredientId,
                        ingredient_name: ingredientName,
                        density: density,
                        message: `Density updated to ${density} g/ml for ${ingredientName}`,
                        retrigger: true
                    };
                    
                    console.log('ðŸ”§ DENSITY MODAL: ==================== DISPATCHING SUCCESS EVENT ====================');
                    console.log('ðŸ”§ DENSITY MODAL: Event detail:', eventDetail);
                    console.log('ðŸ”§ DENSITY MODAL: Event name: conversion.density.updated');
                    
                    const customEvent = new CustomEvent('conversion.density.updated', {
                        detail: eventDetail
                    });
                    
                    console.log('ðŸ”§ DENSITY MODAL: Custom event created:', customEvent);
                    window.dispatchEvent(customEvent);
                    console.log('ðŸ”§ DENSITY MODAL: Success event dispatched to window');
                    
                    return;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .catch(error => {
                console.error('ðŸ”§ DENSITY MODAL: ==================== ERROR OCCURRED ====================');
                console.error('ðŸ”§ DENSITY MODAL: Error object:', error);
                console.error('ðŸ”§ DENSITY MODAL: Error message:', error.message);
                console.error('ðŸ”§ DENSITY MODAL: Error stack:', error.stack);
                alert('Failed to save density: ' + error.message);
            })
            .finally(() => {
                console.log('ðŸ”§ DENSITY MODAL: ==================== CLEANUP ====================');
                console.log('ðŸ”§ DENSITY MODAL: Re-enabling save button');
                
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Density';
                
                console.log('ðŸ”§ DENSITY MODAL: Save button re-enabled');
            });
        });
        
        console.log('ðŸ”§ DENSITY MODAL: Click listener added to save button');
    } else {
        console.error('ðŸ”§ DENSITY MODAL: Save button not found during initialization');
    }
});

function openDensityReference() {
    // Open the density reference data instead of unit manager
    window.open('/api/density-reference', '_blank');
}
</script>
