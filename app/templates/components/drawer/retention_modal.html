{#
Retention Drawer Modal

Blocking notice for data at risk of deletion per tier retention policy.
Offers: Upgrade, Manage in Billing, Export CSV/JSON, Acknowledge to queue deletion (retention + 15d).
Only non batch-linked recipes appear. Nothing is deleted until user acknowledges.
#}
<div class="modal fade" id="retentionDrawerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Data Retention Notice</h5>
      </div>
      <div class="modal-body">
        <p>Some experimental recipes have reached your plan's data retention limit. You must choose an action below. If you do nothing, the items will be permanently deleted after 15 days.</p>
        <div class="alert alert-light border">
          <strong>{{ items|length }} recipe(s)</strong> are at risk of deletion.
        </div>
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
          <table class="table table-sm align-middle">
            <thead><tr><th>Name</th><th>Created</th><th>Yield</th></tr></thead>
            <tbody>
            {% for r in items %}
              <tr>
                <td>{{ r.name }}</td>
                <td>{{ r.created_at.strftime('%Y-%m-%d') if r.created_at else '' }}</td>
                <td>{{ r.predicted_yield }} {{ r.predicted_yield_unit }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="d-flex gap-2 mt-3">
          <a href="/billing/upgrade" target="_blank" class="btn btn-primary"><i class="fas fa-crown"></i> Upgrade Plan</a>
          <a href="/settings#billing" class="btn btn-outline-secondary"><i class="fas fa-credit-card"></i> Manage in Billing</a>
          <div class="ms-auto">
            <a href="/retention/api/export?format=csv" class="btn btn-outline-secondary"><i class="fas fa-file-csv"></i> Export CSV</a>
            <a href="/retention/api/export?format=json" class="btn btn-outline-secondary"><i class="fas fa-file-code"></i> Export JSON</a>
            <button class="btn btn-danger ms-2" id="acknowledgeBtn"><i class="fas fa-check"></i> Acknowledge</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
document.getElementById('acknowledgeBtn').addEventListener('click', async function() {
  try {
    const res = await fetch('/retention/api/acknowledge', { method: 'POST', headers: {'Content-Type':'application/json','X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')}, body: JSON.stringify({ acknowledge: true }) });
    const data = await res.json();
    if (data.success) {
      const modalEl = document.getElementById('retentionDrawerModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
      window.dispatchEvent(new CustomEvent('retention.acknowledged', { detail: { queued: data.queued } }));
    } else {
      alert('Error: ' + (data.error || 'Failed to acknowledge'));
    }
  } catch (e) {
    alert('Network error');
  }
});
setTimeout(() => {
  const el = document.getElementById('retentionDrawerModal');
  if (el) { const modal = new bootstrap.Modal(el); modal.show(); }
}, 0);
</script>

