{# File: templates/dashboard.html
   Synopsis: Main dashboard with start batch flow modal.
   Glossary: Start flow = recipe selection modal; Variation = optional recipe branch. #}
{% extends 'layout.html' %}
{% block content %}

<div class="text-center mb-4">
  <h2>Hi {{ current_user.first_name or current_user.username or 'there' }}, what do you want to do?</h2>
</div>

<div class="text-center mb-4">
  <div class="d-inline-flex gap-3">
    {% if active_batch %}
      <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=active_batch.id) }}" class="btn btn-warning">Continue Batch</a>
    {% endif %}
    <button id="openStartBatchButton" type="button" class="btn btn-primary">Start Batch</button>
  </div>
</div>

<!-- Unified Dashboard Alerts -->
    <!-- This section is replaced by the change below -->

    <!-- If no alerts component exists, create inline -->
    <div id="fallback-dashboard-alerts">
        <!-- This will be populated by JavaScript if the component above doesn't work -->
    </div>

<!-- Recipe Selection Modal -->
<div id="startFlowModal" class="position-fixed top-50 start-50 translate-middle" style="display:none; z-index: 1050; width: 90%; max-width: 500px;">
  <div class="card shadow-lg">
    <div class="card-header">
      <h5 class="card-title mb-0 text-center">Start New Batch</h5>
    </div>
    <div class="card-body">
      <div id="recipeLoadingState" class="alert alert-info d-flex align-items-center mb-3">
        <i class="fas fa-spinner fa-spin me-2"></i>
        <div>Loading your recipes…</div>
      </div>
      <div id="recipeErrorState" class="alert alert-danger d-none"></div>

      <!-- Empty State Message -->
      <div class="text-center py-4 d-none" id="recipeEmptyState">
        <i class="fas fa-book fa-4x text-muted mb-4"></i>
        <h4 class="text-muted mb-3">No Recipes Yet</h4>
        <p class="text-muted mb-4">Create your first recipe to start tracking batches and managing production!</p>
        <div class="d-flex gap-3 justify-content-center mb-3">
          <a href="{{ url_for('recipes.new_recipe') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Your First Recipe
          </a>
          <a href="{{ url_for('inventory.list_inventory') }}" class="btn btn-outline-primary">
            <i class="fas fa-boxes"></i> Add Ingredients
          </a>
        </div>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>

      <form id="recipeForm" method="get" action="#" class="d-none">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label for="recipe_id" class="form-label">Select Master Recipe:</label>
          <select class="form-select" id="recipe_id" name="recipe_id" required disabled>
            <option value="">Choose a recipe...</option>
          </select>
        </div>

        <!-- Variant Selection (hidden by default) -->
        <div id="variantSection" class="mb-3" style="display: none;">
          <label for="variant_id" class="form-label">Select Variation (optional):</label>
          <select class="form-select" id="variant_id" name="variant_id">
            <option value="">Use master only</option>
          </select>
        </div>

        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="goToPlanProduction()">Start Planning</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div id="modalBackdrop" class="position-fixed top-0 start-0 w-100 h-100 bg-dark" style="display:none; z-index: 1040; opacity: 0.5;"></div>

<script>
(function() {
  const modal = document.getElementById('startFlowModal');
  const backdrop = document.getElementById('modalBackdrop');
  const recipeSelect = document.getElementById('recipe_id');
  const variantSection = document.getElementById('variantSection');
  const variantSelect = document.getElementById('variant_id');
  const recipeForm = document.getElementById('recipeForm');
  const loadingState = document.getElementById('recipeLoadingState');
  const errorState = document.getElementById('recipeErrorState');
  const emptyState = document.getElementById('recipeEmptyState');
  const startBatchBtn = document.getElementById('openStartBatchButton');
  const bootstrapRecipesUrl = "{{ url_for('api.bootstrap_recipes') }}";
  let recipesCache = null;
  let recipeFetchPromise = null;
  const recipeVariantMap = new Map();

  function openModal() {
    modal.style.display = 'block';
    backdrop.style.display = 'block';
  }

  function fetchRecipes() {
    if (recipesCache) {
      return Promise.resolve(recipesCache);
    }
    if (recipeFetchPromise) {
      return recipeFetchPromise;
    }
    recipeFetchPromise = fetch(bootstrapRecipesUrl, {
      headers: { 'Accept': 'application/json' }
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to load recipes (${response.status})`);
        }
        return response.json();
      })
      .then(data => {
        recipesCache = data.recipes || [];
        recipeVariantMap.clear();
        recipesCache.forEach(recipe => {
          recipeVariantMap.set(String(recipe.id), recipe.variations || []);
        });
        return recipesCache;
      })
      .catch(error => {
        recipeFetchPromise = null;
        throw error;
      });
    return recipeFetchPromise;
  }

  function populateRecipeSelect(recipes) {
    recipeSelect.innerHTML = '<option value="">Choose a recipe...</option>';
    recipes
      .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
      .forEach(recipe => {
        const option = document.createElement('option');
        option.value = recipe.id;
        option.textContent = recipe.name || `Recipe #${recipe.id}`;
        recipeSelect.appendChild(option);
      });
    recipeSelect.disabled = recipes.length === 0;
  }

  function updateVariantSection(recipeId) {
    const variants = recipeVariantMap.get(String(recipeId)) || [];
    if (variants.length === 0) {
      variantSection.style.display = 'none';
      variantSelect.innerHTML = '<option value="">Use master only</option>';
      return;
    }
    variantSection.style.display = 'block';
    variantSelect.innerHTML = '<option value="">Use master only</option>';
    variants.forEach(variant => {
      const option = document.createElement('option');
      option.value = variant.id;
      option.textContent = variant.name || `Variation #${variant.id}`;
      variantSelect.appendChild(option);
    });
  }

  function ensureRecipesLoaded() {
    loadingState.classList.remove('d-none');
    errorState.classList.add('d-none');
    emptyState.classList.add('d-none');
    recipeForm.classList.add('d-none');

    fetchRecipes()
      .then(recipes => {
        loadingState.classList.add('d-none');
        if (recipes.length === 0) {
          emptyState.classList.remove('d-none');
        } else {
          populateRecipeSelect(recipes);
          recipeForm.classList.remove('d-none');
        }
      })
      .catch(error => {
        loadingState.classList.add('d-none');
        errorState.textContent = error.message || 'Unable to load recipes. Please try again.';
        errorState.classList.remove('d-none');
      });
  }

  window.closeModal = function() {
    modal.style.display = 'none';
    backdrop.style.display = 'none';
  };

  window.goToPlanProduction = function() {
    const selectedRecipeId = recipeSelect.value;
    const selectedVariantId = variantSelect && variantSelect.value;
    const targetId = selectedVariantId || selectedRecipeId;
    if (targetId) {
      window.location.href = `/production-planning/recipe/${targetId}/plan`;
    } else {
      alert('Please select a recipe first.');
    }
  };

  if (startBatchBtn) {
    startBatchBtn.addEventListener('click', () => {
      openModal();
      ensureRecipesLoaded();
    });
  }

  if (backdrop) {
    backdrop.addEventListener('click', closeModal);
  }

  if (recipeSelect) {
    recipeSelect.addEventListener('change', (event) => {
      const recipeId = event.target.value;
      if (recipeId) {
        updateVariantSection(recipeId);
      } else {
        variantSection.style.display = 'none';
        variantSelect.innerHTML = '<option value="">Use master only</option>';
      }
    });
  }
})();
</script>

<!-- Unified Dashboard Alerts -->
{% include 'components/dashboard_alerts.html' %}

{% if alert %}
<div class="alert alert-warning mt-3">
  ⚠️ <strong>{{ alert }}</strong>
</div>
{% endif %}

{% endblock %}