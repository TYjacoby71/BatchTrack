{% extends "layout.html" %}

{% block title %}Select Recipes to Keep - Downgrade{% endblock %}

{% block content %}
<div class="container py-4">
  <h2>Confirm Downgrade</h2>
  <p class="text-muted">
    You are downgrading to <strong>{{ target_tier.name }}</strong>. This tier allows
    up to <strong>{{ limit }}</strong> active recipes. Please choose exactly
    <strong>{{ required_count }}</strong> recipes to keep active. All others will be archived.
  </p>

  <div class="alert alert-warning">
    <i class="fas fa-info-circle"></i>
    Recipes with active marketplace listings must be kept unless you deactivate the listing first.
  </div>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">Active Recipes</h6>
      </div>
      <div class="card-body">
        <div class="list-group">
          {% for recipe in active_recipes %}
            {% set is_locked = recipe.id in locked_ids %}
            <label class="list-group-item d-flex align-items-center justify-content-between {% if is_locked %}list-group-item-warning{% endif %}">
              <div class="d-flex align-items-center gap-2">
                <input class="form-check-input me-2 recipe-select"
                       type="checkbox"
                       name="keep_recipe_ids"
                       value="{{ recipe.id }}"
                       {% if is_locked %}checked disabled{% endif %}>
                {% if is_locked %}
                  <input type="hidden" name="keep_recipe_ids" value="{{ recipe.id }}">
                {% endif %}
                <div>
                  <strong>{{ recipe.name }}</strong>
                  {% if recipe.is_master %}
                    <span class="badge bg-dark ms-1">Master</span>
                  {% else %}
                    <span class="badge bg-info ms-1">Variation</span>
                  {% endif %}
                  {% if recipe.test_sequence %}
                    <span class="badge bg-info text-dark ms-1">Test {{ recipe.test_sequence }}</span>
                  {% endif %}
                  {% if recipe.is_public and recipe.marketplace_status == 'listed' %}
                    <span class="badge bg-warning text-dark ms-1">Marketplace Listing</span>
                  {% endif %}
                </div>
              </div>
              {% if is_locked %}
                <button type="submit"
                        class="btn btn-sm btn-outline-warning"
                        formaction="{{ url_for('recipes.unlist_recipe_route', recipe_id=recipe.id, next=request.path) }}"
                        formmethod="post">
                  <i class="fas fa-store-slash"></i> Deactivate Listing
                </button>
              {% endif %}
            </label>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <a href="{{ url_for('billing.upgrade') }}" class="btn btn-outline-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary" id="confirmDowngradeButton">Confirm Downgrade</button>
    </div>
  </form>
</div>

<script>
  (function() {
    const requiredCount = {{ required_count | int }};
    const button = document.getElementById('confirmDowngradeButton');
    const checkboxes = document.querySelectorAll('.recipe-select');
    function updateButton() {
      let count = 0;
      checkboxes.forEach(cb => { if (cb.checked) count += 1; });
      button.disabled = (count !== requiredCount);
    }
    checkboxes.forEach(cb => cb.addEventListener('change', updateButton));
    updateButton();
  })();
</script>
{% endblock %}
