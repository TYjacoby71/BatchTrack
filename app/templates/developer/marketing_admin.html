{% extends "layout.html" %}

{% block content %}
<div class="container mt-4" x-data="marketingAdmin()">
  <h2><i class="fas fa-bullhorn"></i> Marketing Admin</h2>
  <p class="text-muted">Manage homepage reviews, spotlights, and review-ask messages (day 1/3/5).</p>

  <div class="card mb-4">
    <div class="card-header"><strong>Reviews</strong></div>
    <div class="card-body">
      <template x-for="(r, idx) in reviews" :key="idx">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-2"><input class="form-control" placeholder="Name" x-model="r.name"></div>
          <div class="col-md-2"><input class="form-control" placeholder="Title" x-model="r.title"></div>
          <div class="col-md-5"><input class="form-control" placeholder="Quote" x-model="r.quote"></div>
          <div class="col-md-2"><input class="form-control" placeholder="Logo URL" x-model="r.logo"></div>
          <div class="col-md-1 text-end"><button class="btn btn-sm btn-danger" @click="removeReview(idx)" aria-label="Remove review"><i class="fas fa-times"></i></button></div>
        </div>
      </template>
      <button class="btn btn-sm btn-outline-primary" @click="addReview()"><i class="fas fa-plus"></i> Add Review</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header"><strong>Business Spotlights</strong></div>
    <div class="card-body">
      <template x-for="(s, idx) in spotlights" :key="idx">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-3"><input class="form-control" placeholder="Business Name" x-model="s.business_name"></div>
          <div class="col-md-3"><input class="form-control" placeholder="URL" x-model="s.url"></div>
          <div class="col-md-3"><input class="form-control" placeholder="Logo URL" x-model="s.logo"></div>
          <div class="col-md-2"><input class="form-control" placeholder="Blurb" x-model="s.blurb"></div>
          <div class="col-md-1 form-check"><input class="form-check-input" type="checkbox" x-model="s.approved"> <label class="form-check-label">Approved</label></div>
        </div>
      </template>
      <button class="btn btn-sm btn-outline-primary" @click="addSpotlight()"><i class="fas fa-plus"></i> Add Spotlight</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header"><strong>Review Ask Messages</strong></div>
    <div class="card-body">
      <div class="row g-2 mb-2">
        <div class="col-md-4"><input class="form-control" placeholder="Day 1 message" x-model="messages.day_1"></div>
        <div class="col-md-4"><input class="form-control" placeholder="Day 3 message" x-model="messages.day_3"></div>
        <div class="col-md-4"><input class="form-control" placeholder="Day 5 message" x-model="messages.day_5"></div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header"><strong>Promo Codes & Demo</strong></div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Demo Link (Whop or Video Page)</label>
        <input class="form-control" placeholder="https://..." x-model="demo_url">
      </div>
      <div class="mb-3">
        <label class="form-label">Promo Codes (reference only)</label>
        <template x-for="(p, idx) in promo_codes" :key="idx">
          <div class="row g-2 mb-2">
            <div class="col-md-4"><input class="form-control" placeholder="Code" x-model="p.code"></div>
            <div class="col-md-3"><input class="form-control" placeholder="Description" x-model="p.description"></div>
            <div class="col-md-3"><input class="form-control" placeholder="Stripe price/lookup" x-model="p.lookup"></div>
            <div class="col-md-2 text-end"><button class="btn btn-sm btn-danger" @click="promo_codes.splice(idx,1)" aria-label="Remove promo code"><i class="fas fa-times"></i></button></div>
          </div>
        </template>
        <button class="btn btn-sm btn-outline-primary" @click="promo_codes.push({code:'',description:'',lookup:''})"><i class="fas fa-plus"></i> Add Promo</button>
      </div>
    </div>
  </div>

  <div class="text-end">
    <button class="btn btn-primary" @click="saveAll()" :disabled="saving">
      <span x-show="!saving"><i class="fas fa-save"></i> Save Changes</span>
      <span x-show="saving"><i class="fas fa-spinner fa-spin"></i> Saving...</span>
    </button>
  </div>
</div>

<script>
function marketingAdmin() {
  return {
    reviews: {{ reviews|tojson }},
    spotlights: {{ spotlights|tojson }},
    messages: {{ messages|tojson }},
    promo_codes: {{ promo_codes|tojson }},
    demo_url: {{ demo_url|tojson }},
    demo_videos: {{ demo_videos|tojson }},
    saving: false,
    addReview() { this.reviews.push({name:'', title:'', quote:'', logo:'', photo:''}); },
    removeReview(i) { this.reviews.splice(i,1); },
    addSpotlight() { this.spotlights.push({business_name:'', url:'', logo:'', blurb:'', approved:false}); },
    async saveAll() {
      if (this.saving) return; this.saving = true;
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        const res = await fetch('{{ url_for('developer.marketing_admin_save') }}', {
          method: 'POST', 
          headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': csrfToken || ''
          },
          body: JSON.stringify({
            reviews: this.reviews, 
            spotlights: this.spotlights, 
            messages: this.messages, 
            promo_codes: this.promo_codes, 
            demo_url: this.demo_url, 
            demo_videos: this.demo_videos
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const out = await res.json();
        if (!out.success) {
          throw new Error(out.error || 'Save failed');
        }
        
        alert('✅ Marketing content saved successfully');
      } catch (e) { 
        console.error('Marketing admin save error:', e);
        alert(`❌ Save failed: ${e.message}`); 
      }
      this.saving = false;
    }
  }
}
</script>
{% endblock %}
