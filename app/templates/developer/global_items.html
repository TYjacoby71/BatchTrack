{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
      <h2 class="mb-1">Global Item Library</h2>
      <p class="text-muted mb-0">Manage the canonical inventory items that power both the customer and developer views.</p>
    </div>
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" id="globalActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-toolbox me-1"></i> Global library actions
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="globalActionsDropdown">
        <li><a class="dropdown-item" href="{{ url_for('developer.create_global_item') }}"><i class="fas fa-plus me-2"></i>Add global item</a></li>
        <li><a class="dropdown-item" href="{{ url_for('developer.reference_categories') }}"><i class="fas fa-tags me-2"></i>Manage ingredient categories</a></li>
        <li><a class="dropdown-item" href="{{ url_for('developer.manage_physical_forms') }}"><i class="fas fa-layer-group me-2"></i>Manage physical forms</a></li>
        <li><a class="dropdown-item" href="{{ url_for('developer.container_management') }}"><i class="fas fa-box-open me-2"></i>Manage container attributes</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('developer.inventory_analytics_stub') }}"><i class="fas fa-chart-line me-2"></i>Inventory analytics</a></li>
        <li><a class="dropdown-item" href="{{ url_for('developer.analytics_catalog') }}"><i class="fas fa-database me-2"></i>Analytics catalog</a></li>
      </ul>
    </div>
  </div>

  <ul class="nav nav-pills mb-3">
    {% for scope, label in scope_labels.items() %}
      {% set scope_params = base_query_params.copy() %}
      {% set _ = scope_params.update({'scope': scope}) %}
      <li class="nav-item">
        <a class="nav-link {% if active_scope == scope %}active{% endif %}" href="{{ url_for('developer.global_items_admin', **scope_params) }}">
          {{ label }}
          {% if active_scope == scope %}<span class="badge bg-white text-primary ms-2">{{ pagination.total }}</span>{% endif %}
        </a>
      </li>
    {% endfor %}
  </ul>

  <form method="GET" class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <input type="hidden" name="scope" value="{{ active_scope }}">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4">
          <label for="searchInput" class="form-label">Search</label>
          <input type="text" id="searchInput" name="search" class="form-control" placeholder="Name or alias" value="{{ search_query }}">
        </div>
        <div class="col-lg-3 {% if active_scope != 'ingredient' %}d-none{% endif %}" id="categoryFilterWrapper">
          <label for="categoryFilter" class="form-label">Ingredient category</label>
          <select id="categoryFilter" name="category" class="form-select" {% if active_scope != 'ingredient' %}disabled{% endif %}>
            <option value="">All categories</option>
            {% for category in categories %}
              <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg-2">
          <label for="pageSize" class="form-label">Rows per page</label>
          <select id="pageSize" name="page_size" class="form-select">
            {% for size in per_page_options %}
              <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 d-flex flex-wrap gap-2">
          <input type="hidden" name="page" value="1">
          <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i>Apply filters</button>
          <a href="{{ url_for('developer.global_items_admin', scope=active_scope) }}" class="btn btn-outline-secondary">Clear</a>
          <small class="text-muted ms-auto">Showing {{ first_item_index }}-{{ last_item_index }} of {{ pagination.total }} {{ scope_labels[active_scope]|lower }}</small>
        </div>
      </div>
    </div>
  </form>

  {% if active_scope == 'ingredient' %}
    {% if grouped_items %}
      <div class="d-flex flex-column gap-3">
        {% for bucket in grouped_items %}
          {% set ingredient = bucket['ingredient'] %}
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
              <div>
                <div class="d-flex gap-2 align-items-center">
                  <h5 class="mb-0">{{ ingredient.name if ingredient else 'Unlinked ingredient' }}</h5>
                  {% if ingredient and ingredient.inci_name %}
                    <span class="badge bg-secondary text-uppercase">INCI</span>
                  {% endif %}
                  {% if ingredient and ingredient.ingredient_category_name %}
                    <span class="badge bg-info text-dark">{{ ingredient.ingredient_category_name }}</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  {% if ingredient and ingredient.inci_name %}{{ ingredient.inci_name }}{% endif %}
                  {% if ingredient and ingredient.cas_number %}<span class="ms-2">CAS {{ ingredient.cas_number }}</span>{% endif %}
                </div>
              </div>
              <div class="d-flex gap-2">
                {% if ingredient %}
                  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('developer.create_global_item', ingredient_id=ingredient.id) }}">
                    <i class="fas fa-plus me-1"></i>Add physical form
                  </a>
                {% endif %}
                {% if ingredient %}<span class="text-muted small">#{{ ingredient.id }}</span>{% endif %}
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Item name</th>
                      <th scope="col">Physical form</th>
                      <th scope="col">Default unit</th>
                      <th scope="col">Density (g/ml)</th>
                      <th scope="col">Perishable</th>
                      <th scope="col" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for gi in bucket['items'] %}
                      <tr>
                        <td>
                          <div class="fw-semibold">{{ gi.name }}</div>
                          <div class="small text-muted">#{{ gi.id }}</div>
                        </td>
                        <td>{{ gi.physical_form.name if gi.physical_form else '—' }}</td>
                        <td>{{ gi.default_unit or '—' }}</td>
                        <td>{{ '%.3f'|format(gi.density) if gi.density is not none else '—' }}</td>
                        <td>
                          {% if gi.default_is_perishable %}
                            <span class="badge bg-warning text-dark">Perishable</span>
                          {% else %}
                            <span class="text-muted">No</span>
                          {% endif %}
                        </td>
                        <td class="text-end">
                          <button class="btn btn-outline-primary btn-sm js-open-global-item-stats" data-global-item-id="{{ gi.id }}" title="Open side card">
                            <i class="fas fa-eye"></i>
                          </button>
                          <a href="{{ url_for('developer.global_item_detail', item_id=gi.id) }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-edit"></i>
                          </a>
                          <button class="btn btn-outline-danger btn-sm" onclick="deleteGlobalItem({{ gi.id }}, '{{ gi.name }}')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light text-center shadow-sm">
        <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
        No ingredient definitions found for this filter.
      </div>
    {% endif %}
  {% else %}
    <div class="card border-0 shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Material / Unit</th>
              <th scope="col">Capacity</th>
              <th scope="col">Perishable</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if items %}
              {% for gi in items %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ gi.name }}</div>
                    <div class="small text-muted">#{{ gi.id }}</div>
                  </td>
                  <td>
                    {% if gi.item_type == 'container' %}
                      {{ gi.container_material or '—' }}
                    {% else %}
                      {{ gi.default_unit or 'count' }}
                    {% endif %}
                  </td>
                  <td>
                    {% if gi.capacity %}
                      {{ gi.capacity }} {{ gi.capacity_unit or '' }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if gi.default_is_perishable %}
                      <span class="badge bg-warning text-dark">Perishable</span>
                    {% else %}
                      <span class="text-muted">No</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <button class="btn btn-outline-primary btn-sm js-open-global-item-stats" data-global-item-id="{{ gi.id }}">
                      <i class="fas fa-eye"></i>
                    </button>
                    <a href="{{ url_for('developer.global_item_detail', item_id=gi.id) }}" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteGlobalItem({{ gi.id }}, '{{ gi.name }}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                  <i class="fas fa-box-open fa-2x d-block mb-2"></i>
                  No {{ scope_labels[active_scope]|lower }} matched this filter.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if pagination.pages > 1 %}
    {% set window_start = pagination.page - 2 if pagination.page - 2 > 1 else 1 %}
    {% set window_end = pagination.page + 2 if pagination.page + 2 < pagination.pages else pagination.pages %}
    <nav class="mt-4" aria-label="Global items pagination">
      <ul class="pagination justify-content-center flex-wrap gap-2">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ build_page_url(pagination.prev_num) if pagination.has_prev else '#' }}">&laquo; Prev</a>
        </li>
        {% if window_start > 1 %}
          <li class="page-item {% if pagination.page == 1 %}active{% endif %}">
            <a class="page-link" href="{{ build_page_url(1) }}">1</a>
          </li>
          {% if window_start > 2 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endif %}
        {% for page_num in range(window_start, window_end + 1) %}
          <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
            <a class="page-link" href="{{ build_page_url(page_num) }}">{{ page_num }}</a>
          </li>
        {% endfor %}
        {% if window_end < pagination.pages %}
          {% if window_end < pagination.pages - 1 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
          <li class="page-item">
            <a class="page-link" href="{{ build_page_url(pagination.pages) }}">{{ pagination.pages }}</a>
          </li>
        {% endif %}
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ build_page_url(pagination.next_num) if pagination.has_next else '#' }}">Next &raquo;</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}

{% with show_dev_link=True %}
  {% include 'components/drawer/global_item_stats_offcanvas.html' %}
{% endwith %}

<div class="modal fade" id="deleteGlobalItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Global Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Warning:</strong> You are about to delete the global item
          <strong id="deleteItemName"></strong>.
        </div>
        <div class="mb-3">
          <label for="confirmItemName" class="form-label">Type the item name to confirm deletion:</label>
          <input type="text" id="confirmItemName" class="form-control" placeholder="Enter item name">
        </div>
        <div id="deleteConfirmationSection" style="display: none;">
          <div class="alert alert-info">
            <strong>Impact:</strong> This item is connected to <span id="connectedItemsCount"></span> inventory items across the following organizations:
            <br><strong>Organizations:</strong> <span id="affectedOrganizations"></span>
            <br><br>
            These inventory items will be disconnected and become organization-owned.
          </div>
          <div class="form-check">
            <input type="checkbox" id="forceDelete" class="form-check-input">
            <label for="forceDelete" class="form-check-label">I understand the impact and want to proceed with deletion</label>
          </div>
        </div>
        <input type="hidden" id="deleteItemId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteGlobalItem()">Delete Item</button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
document.getElementById('pageSize')?.addEventListener('change', function() {
  this.form?.submit();
});

function deleteGlobalItem(itemId, itemName) {
  const modal = new bootstrap.Modal(document.getElementById('deleteGlobalItemModal'));
  document.getElementById('deleteItemId').value = itemId;
  document.getElementById('deleteItemName').textContent = itemName;
  document.getElementById('confirmItemName').value = '';
  document.getElementById('forceDelete').checked = false;
  document.getElementById('deleteConfirmationSection').style.display = 'none';
  modal.show();
}

function confirmDeleteGlobalItem() {
  const itemId = document.getElementById('deleteItemId').value;
  const confirmName = document.getElementById('confirmItemName').value;
  const forceDelete = document.getElementById('forceDelete').checked;

  if (!confirmName) {
    alert('Please enter the item name to confirm deletion');
    return;
  }

  fetch(`/developer/global-items/${itemId}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({ confirm_name: confirmName, force_delete: forceDelete })
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      bootstrap.Modal.getInstance(document.getElementById('deleteGlobalItemModal')).hide();
      window.location.reload();
    } else if (result.requires_confirmation) {
      document.getElementById('deleteConfirmationSection').style.display = 'block';
      document.getElementById('connectedItemsCount').textContent = result.connected_count;
      document.getElementById('affectedOrganizations').textContent = result.organizations.join(', ');
    } else {
      alert(result.error || 'Unknown error occurred');
    }
  })
  .catch(error => {
    console.error('Error deleting global item:', error);
    alert('Failed to delete global item');
  });
}
</script>
<script type="module">
  import { configureGlobalItemStats, bindGlobalItemStatTriggers } from "{{ url_for('static', filename='js/global_item_stats.js') }}";
  configureGlobalItemStats({
    developerLinkBase: "{{ url_for('developer.global_item_detail', item_id=0)[:-1] }}"
  });
  document.addEventListener('DOMContentLoaded', () => {
    bindGlobalItemStatTriggers('.js-open-global-item-stats');
  });
</script>
{% endblock %}
