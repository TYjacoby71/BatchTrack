{% extends 'layout.html' %}

{% block head %}
{{ super() }}
<style>
    .details-toggle .expanded { display: none; }
    .details-toggle:not(.collapsed) .expanded { display: inline; }
    .details-toggle:not(.collapsed) .collapsed { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h2 class="mb-1">Global Item Library</h2>
            <p class="text-muted mb-0">Canonical inventory objects shared across every organization</p>
        </div>
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="globalActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-toolbox me-1"></i> Global library actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="globalActionsDropdown">
                <li><a class="dropdown-item" href="{{ url_for('developer.create_global_item') }}"><i class="fas fa-plus me-2"></i>Add global item</a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.reference_categories') }}"><i class="fas fa-tags me-2"></i>Manage ingredient categories</a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.container_management') }}"><i class="fas fa-box-open me-2"></i>Manage container attributes</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.inventory_analytics_stub') }}"><i class="fas fa-chart-line me-2"></i>Inventory analytics</a></li>
                <li><a class="dropdown-item" href="{{ url_for('developer.analytics_catalog') }}"><i class="fas fa-database me-2"></i>Analytics catalog</a></li>
            </ul>
        </div>
    </div>

    <!-- Filters -->
    <form method="GET" class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="text" id="searchInput" name="search" class="form-control" placeholder="Name or alias" value="{{ search_query }}">
                </div>
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">Item type</label>
                    <select id="typeFilter" name="type" class="form-select">
                        <option value="">All types</option>
                        <option value="ingredient" {% if selected_type == 'ingredient' %}selected{% endif %}>Ingredients</option>
                        <option value="container" {% if selected_type == 'container' %}selected{% endif %}>Containers</option>
                        <option value="packaging" {% if selected_type == 'packaging' %}selected{% endif %}>Packaging</option>
                        <option value="consumable" {% if selected_type == 'consumable' %}selected{% endif %}>Consumables</option>
                    </select>
                </div>
                <div class="col-md-3 {% if selected_type != 'ingredient' %}d-none{% endif %}" id="categoryFilterWrapper">
                    <label for="categoryFilter" class="form-label">Ingredient category</label>
                    <select id="categoryFilter" name="category" class="form-select" {% if selected_type != 'ingredient' %}disabled{% endif %}>
                        <option value="">All categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="pageSize" class="form-label">Rows per page</label>
                    <select id="pageSize" name="page_size" class="form-select" onchange="this.form.submit()">
                        {% for size in per_page_options %}
                        <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 d-flex flex-wrap gap-2">
                    <input type="hidden" name="page" value="1">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Apply filters</button>
                    <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">Clear</a>
                    <small class="text-muted ms-auto">Showing {{ first_item_index }}-{{ last_item_index }} of {{ pagination.total }} items</small>
                </div>
            </div>
        </div>
    </form>

    <!-- Table -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col" class="text-nowrap">Type</th>
                            <th scope="col">Density (g/ml)</th>
                            <th scope="col">Capacity</th>
                            <th scope="col">Actions</th>
                            <th scope="col" class="text-end">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if items %}
                        {% for gi in items %}
                        <tr>
                            <td>
                                <div class="fw-semibold">{{ gi.name }}</div>
                                <div class="small text-muted">ID #{{ gi.id }}</div>
                            </td>
                            <td>
                                <span class="badge bg-secondary text-uppercase">{{ gi.item_type }}</span>
                            </td>
                            <td>
                                {% if gi.density is not none %}
                                    {{ '%.3f'|format(gi.density) }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if gi.capacity %}
                                    {{ gi.capacity }} {{ gi.capacity_unit or '' }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary js-open-global-item-stats" data-global-item-id="{{ gi.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{{ url_for('developer.global_item_detail', item_id=gi.id) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-outline-danger" onclick="deleteGlobalItem({{ gi.id }}, '{{ gi.name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-link btn-sm text-decoration-none details-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gi-details-{{ gi.id }}" aria-expanded="false" aria-controls="gi-details-{{ gi.id }}">
                                    <span class="collapsed"><i class="fas fa-chevron-down me-1"></i>Expand</span>
                                    <span class="expanded"><i class="fas fa-chevron-up me-1"></i>Hide</span>
                                </button>
                            </td>
                        </tr>
                        <tr class="collapse bg-light" id="gi-details-{{ gi.id }}">
                            <td colspan="6" class="border-top">
                                <div class="p-3">
                                    <div class="row g-3 small">
                                        <div class="col-md-4">
                                            <div class="text-muted text-uppercase">Category</div>
                                            <div>{{ gi.ingredient_category.name if gi.ingredient_category else '—' }}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-muted text-uppercase">Perishable</div>
                                            <div>{{ 'Yes' if gi.default_is_perishable else 'No' }}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-muted text-uppercase">Default unit</div>
                                            <div>{{ gi.default_unit or '—' }}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-muted text-uppercase">Shelf life (days)</div>
                                            <div>{{ gi.recommended_shelf_life_days or '—' }}</div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="text-muted text-uppercase">Aliases</div>
                                            <div>
                                                {% if gi.aliases %}
                                                    {% if gi.aliases is string %}
                                                        {{ gi.aliases }}
                                                    {% elif gi.aliases is iterable %}
                                                        {{ gi.aliases | join(', ') }}
                                                    {% else %}
                                                        {{ gi.aliases }}
                                                    {% endif %}
                                                {% else %}
                                                    —
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-box-open fa-2x d-block mb-2"></i>
                                No global items matched this filter.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    {% set window_start = pagination.page - 2 if pagination.page - 2 > 1 else 1 %}
    {% set window_end = pagination.page + 2 if pagination.page + 2 < pagination.pages else pagination.pages %}
    <nav class="mt-4" aria-label="Global items pagination">
        <ul class="pagination justify-content-center flex-wrap gap-2">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ build_page_url(pagination.prev_num) if pagination.has_prev else '#' }}" tabindex="{% if pagination.has_prev %}0{% else %}-1{% endif %}">
                    &laquo; Prev
                </a>
            </li>
            {% if window_start > 1 %}
            <li class="page-item {% if pagination.page == 1 %}active{% endif %}">
                <a class="page-link" href="{{ build_page_url(1) }}">1</a>
            </li>
            {% if window_start > 2 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
            {% endif %}
            {% for page_num in range(window_start, window_end + 1) %}
            <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
                <a class="page-link" href="{{ build_page_url(page_num) }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            {% if window_end < pagination.pages %}
            {% if window_end < pagination.pages - 1 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="{{ build_page_url(pagination.pages) }}">{{ pagination.pages }}</a>
            </li>
            {% endif %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ build_page_url(pagination.next_num) if pagination.has_next else '#' }}" tabindex="{% if pagination.has_next %}0{% else %}-1{% endif %}">
                    Next &raquo;
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% with show_dev_link=True %}
  {% include 'components/drawer/global_item_stats_offcanvas.html' %}
{% endwith %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteGlobalItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Global Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> You are about to delete the global item <strong id="deleteItemName"></strong>.
                </div>

                <div class="mb-3">
                    <label for="confirmItemName" class="form-label">Type the item name to confirm deletion:</label>
                    <input type="text" id="confirmItemName" class="form-control" placeholder="Enter item name">
                </div>

                <div id="deleteConfirmationSection" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Impact:</strong> This item is connected to <span id="connectedItemsCount"></span> inventory items across the following organizations:
                        <br><strong>Organizations:</strong> <span id="affectedOrganizations"></span>
                        <br><br>
                        These inventory items will be disconnected and become organization-owned.
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="forceDelete" class="form-check-input">
                        <label for="forceDelete" class="form-check-label">
                            I understand the impact and want to proceed with deletion
                        </label>
                    </div>
                </div>

                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteGlobalItem()">Delete Item</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
(function() {
    const typeFilter = document.getElementById('typeFilter');
    const categoryWrapper = document.getElementById('categoryFilterWrapper');
    const categorySelect = document.getElementById('categoryFilter');

    function toggleCategory() {
        const isIngredient = typeFilter.value === 'ingredient';
        categoryWrapper.classList.toggle('d-none', !isIngredient);
        categorySelect.disabled = !isIngredient;
        if (!isIngredient) {
            categorySelect.value = '';
        }
    }

    if (typeFilter && categoryWrapper && categorySelect) {
        toggleCategory();
        typeFilter.addEventListener('change', () => {
            toggleCategory();
            if (!categoryWrapper.classList.contains('d-none')) {
                categorySelect.focus();
            }
        });
    }
})();

function deleteGlobalItem(itemId, itemName) {
    try {
        const modal = new bootstrap.Modal(document.getElementById('deleteGlobalItemModal'));
        document.getElementById('deleteItemId').value = itemId;
        document.getElementById('deleteItemName').textContent = itemName;
        document.getElementById('confirmItemName').value = '';
        document.getElementById('forceDelete').checked = false;
        document.getElementById('deleteConfirmationSection').style.display = 'none';
        modal.show();
    } catch (error) {
        console.error('Error showing delete modal:', error);
        alert('Failed to show delete modal');
    }
}

function confirmDeleteGlobalItem() {
    try {
        const itemId = document.getElementById('deleteItemId').value;
        const itemName = document.getElementById('deleteItemName').textContent;
        const confirmName = document.getElementById('confirmItemName').value;
        const forceDelete = document.getElementById('forceDelete').checked;

        if (!confirmName) {
            alert('Please enter the item name to confirm deletion');
            return;
        }

        const data = {
            confirm_name: confirmName,
            force_delete: forceDelete
        };

        fetch(`/developer/global-items/${itemId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteGlobalItemModal'));
                if (modalInstance) modalInstance.hide();
                location.reload();
            } else if (result.requires_confirmation) {
                document.getElementById('deleteConfirmationSection').style.display = 'block';
                document.getElementById('connectedItemsCount').textContent = result.connected_count;
                document.getElementById('affectedOrganizations').textContent = result.organizations.join(', ');
            } else {
                alert(result.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error deleting global item:', error);
            alert('Failed to delete global item: ' + error.message);
        });
    } catch (error) {
        console.error('Error in confirmDeleteGlobalItem:', error);
        alert('An unexpected error occurred');
    }
}

function getCSRFToken() {
    try {
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        if (csrfInput && csrfInput.value) {
            return csrfInput.value;
        }
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    } catch (error) {
        console.error('Error getting CSRF token:', error);
        return '';
    }
}
</script>
<script type="module">
    import { configureGlobalItemStats, bindGlobalItemStatTriggers } from "{{ url_for('static', filename='js/global_item_stats.js') }}";

    configureGlobalItemStats({
        developerLinkBase: "{{ url_for('developer.global_item_detail', item_id=0)[:-1] }}"
    });

    document.addEventListener('DOMContentLoaded', () => {
        bindGlobalItemStatTriggers('.js-open-global-item-stats');
    });
</script>
{% endblock %}
