{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Global Items</h2>
  <div>
    <a href="{{ url_for('developer.reference_categories') }}" class="btn btn-outline-primary me-2">
      <i class="fas fa-tags"></i> Manage Categories
    </a>
    <a href="{{ url_for('developer.create_global_item') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add Global Item
    </a>
  </div>
</div>

<!-- Filter Controls -->
<div class="row mb-3">
  <div class="col-md-6">
    <form method="GET" class="row g-2">
      <div class="col-auto">
        <label for="typeFilter" class="form-label">Item Type:</label>
        <select name="type" id="typeFilter" class="form-select" onchange="this.form.submit()">
          <option value="">All Types</option>
          <option value="ingredient" {% if selected_type == 'ingredient' %}selected{% endif %}>Ingredients</option>
          <option value="container" {% if selected_type == 'container' %}selected{% endif %}>Containers</option>
          <option value="packaging" {% if selected_type == 'packaging' %}selected{% endif %}>Packaging</option>
          <option value="consumable" {% if selected_type == 'consumable' %}selected{% endif %}>Consumables</option>
        </select>
      </div>

      <div class="col-auto" id="categoryFilterDiv" {% if selected_type != 'ingredient' %}style="display: none;"{% endif %}>
        <label for="categoryFilter" class="form-label">Category:</label>
        <select name="category" id="categoryFilter" class="form-select" onchange="this.form.submit()">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label">&nbsp;</label>
        <div>
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary btn-sm">Clear</a>
        </div>
      </div>

      <!-- Preserve category filter when changing type -->
      {% if selected_category %}
      <input type="hidden" name="category" value="{{ selected_category }}">
      {% endif %}
    </form>
  </div>
  <div class="col-md-6 text-end">
    <small class="text-muted">Showing {{ items|length }} items</small>
  </div>
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Category</th>
      <th>Density</th>
      <th>Capacity</th>
      <th>Perishable</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for gi in items %}
    <tr>
      <td>{{ gi.name }}</td>
      <td>
        <span class="badge bg-secondary">{{ gi.item_type }}</span>
      </td>
      <td>{{ gi.ingredient_category.name if gi.ingredient_category else '-' }}</td>
      <td>{{ gi.density or '-' }}</td>
      <td>{{ gi.capacity or '-' }} {{ gi.capacity_unit or '' }}</td>
      <td>{{ 'Yes' if gi.default_is_perishable else 'No' }}</td>
      <td>
      <a href="{{ url_for('developer.global_item_detail', item_id=gi.id) }}" class="btn btn-sm btn-outline-primary">View</a>
      <button class="btn btn-sm btn-outline-danger ms-1" onclick="confirmDelete({{ gi.id }}, '{{ gi.name }}')">Delete</button>
    </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteGlobalItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Global Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> You are about to delete the global item <strong id="deleteItemName"></strong>.
                </div>

                <div class="mb-3">
                    <label for="confirmItemName" class="form-label">Type the item name to confirm deletion:</label>
                    <input type="text" id="confirmItemName" class="form-control" placeholder="Enter item name">
                </div>

                <div id="deleteConfirmationSection" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Impact:</strong> This item is connected to <span id="connectedItemsCount"></span> inventory items across the following organizations:
                        <br><strong>Organizations:</strong> <span id="affectedOrganizations"></span>
                        <br><br>
                        These inventory items will be disconnected and become organization-owned.
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="forceDelete" class="form-check-input">
                        <label for="forceDelete" class="form-check-label">
                            I understand the impact and want to proceed with deletion
                        </label>
                    </div>
                </div>

                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteGlobalItem()">Delete Item</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function deleteGlobalItem(itemId, itemName) {
    try {
        const modal = new bootstrap.Modal(document.getElementById('deleteGlobalItemModal'));
        document.getElementById('deleteItemId').value = itemId;
        document.getElementById('deleteItemName').textContent = itemName;
        document.getElementById('confirmItemName').value = '';
        document.getElementById('forceDelete').checked = false;
        document.getElementById('deleteConfirmationSection').style.display = 'none';
        modal.show();
    } catch (error) {
        console.error('Error showing delete modal:', error);
        alert('Failed to show delete modal');
    }
}

function confirmDeleteGlobalItem() {
    try {
        const itemId = document.getElementById('deleteItemId').value;
        const itemName = document.getElementById('deleteItemName').textContent;
        const confirmName = document.getElementById('confirmItemName').value;
        const forceDelete = document.getElementById('forceDelete').checked;

        if (!confirmName) {
            alert('Please enter the item name to confirm deletion');
            return;
        }

        const data = {
            confirm_name: confirmName,
            force_delete: forceDelete
        };

        fetch(`/developer/global-items/${itemId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteGlobalItemModal'));
                if (modalInstance) modalInstance.hide();
                location.reload();
            } else if (result.requires_confirmation) {
                // Show additional confirmation info
                document.getElementById('deleteConfirmationSection').style.display = 'block';
                document.getElementById('connectedItemsCount').textContent = result.connected_count;
                document.getElementById('affectedOrganizations').textContent = result.organizations.join(', ');
            } else {
                alert(result.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error deleting global item:', error);
            alert('Failed to delete global item: ' + error.message);
        });
    } catch (error) {
        console.error('Error in confirmDeleteGlobalItem:', error);
        alert('An unexpected error occurred');
    }
}

function getCSRFToken() {
    try {
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        return csrfInput ? csrfInput.value : '';
    } catch (error) {
        console.error('Error getting CSRF token:', error);
        return '';
    }
}

// Add search functionality
function filterItems() {
    try {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    } catch (error) {
        console.error('Error filtering items:', error);
    }
}

// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Add any initialization code here if needed
        console.log('Global items page loaded successfully');
    } catch (error) {
        console.error('Error initializing page:', error);
    }
});
</script>
<script>
function applyFilters() {
    const typeFilter = document.getElementById('typeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchInput = document.getElementById('searchInput').value;

    // Enable/disable category filter based on type selection
    const categorySelect = document.getElementById('categoryFilter');
    if (typeFilter === 'ingredient') {
        categorySelect.disabled = false;
    } else {
        categorySelect.disabled = true;
        categorySelect.value = '';
    }

    // Build URL with filters
    const url = new URL(window.location);

    if (searchInput.trim()) {
        url.searchParams.set('search', searchInput.trim());
    } else {
        url.searchParams.delete('search');
    }

    if (typeFilter) {
        url.searchParams.set('type', typeFilter);
    } else {
        url.searchParams.delete('type');
    }

    if (categoryFilter && typeFilter === 'ingredient') {
        url.searchParams.set('category', categoryFilter);
    } else {
        url.searchParams.delete('category');
    }

    window.location.href = url.toString();
}

function handleSearchKeyup(event) {
    // Apply search on Enter key or after a short delay
    if (event.key === 'Enter') {
        applyFilters();
    } else {
        // Clear any existing timeout
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
        }

        // Set a new timeout to search after 500ms of no typing
        window.searchTimeout = setTimeout(() => {
            applyFilters();
        }, 500);
    }
}

function clearFilters() {
    // Clear all filter inputs
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('categoryFilter').value = '';

    // Redirect to base URL without filters
    window.location.href = window.location.pathname;
}

async function openItemDetails(id){
  try {
    const offcanvasEl = document.getElementById('globalItemDetail');
    const oc = new bootstrap.Offcanvas(offcanvasEl);
    const loadingEl = document.getElementById('giDetailLoading');
    const contentEl = document.getElementById('giDetailContent');

    loadingEl.style.display = '';
    contentEl.style.display = 'none';
    oc.show();

    const statsRes = await fetch(`/developer/global-items/${id}/stats`);
    if (!statsRes.ok) {
      throw new Error(`HTTP error! status: ${statsRes.status}`);
    }

    const payload = await statsRes.json();
    if (!payload.success) {
      throw new Error(`API error: ${payload.error}`);
    }

    if (payload && payload.success && payload.item) {
      const it = payload.item;
      document.getElementById('giName').textContent = it.name || `#${id}`;
      document.getElementById('giType').textContent = it.item_type || '';
      document.getElementById('giCategory').textContent = it.ingredient_category_name || '';
      document.getElementById('giUnit').textContent = it.default_unit || '';
      document.getElementById('giDensity').textContent = (it.density != null) ? Number(it.density).toFixed(3) : '';

      // Container meta
      const isContainer = it.item_type === 'container' || it.item_type === 'packaging';
      const metaDiv = document.getElementById('giContainerMeta');
      if (isContainer) {
        metaDiv.style.display = '';
        document.getElementById('giMaterial').textContent = it.container_material || '';
        const typeStyle = [it.container_type || '', it.container_style ? `(${it.container_style})` : ''].join(' ').trim();
        document.getElementById('giTypeStyle').textContent = typeStyle;
        document.getElementById('giColor').textContent = it.container_color || '';
      } else {
        metaDiv.style.display = 'none';
      }

      // Ingredient property visibility
      const propsDiv = document.getElementById('giIngredientStats');
      const grid = document.getElementById('giPropsGrid');
      grid.innerHTML = '';
      const vis = payload.category_visibility || {};
      const addProp = (label, value, show) => {
        if (!show) return;
        const v = (value == null || value === '') ? '-' : value;
        const col = document.createElement('div');
        col.innerHTML = `<div><strong>${label}:</strong> ${v}</div>`;
        grid.appendChild(col);
      };
      const isIngredient = it.item_type === 'ingredient';
      propsDiv.style.display = isIngredient ? '' : 'none';
      if (isIngredient) {
        addProp('Saponification', it.saponification_value, vis.show_saponification_value);
        addProp('Iodine', it.iodine_value, vis.show_iodine_value);
        addProp('Melting Point (°C)', it.melting_point_c, vis.show_melting_point);
        addProp('Flash Point (°C)', it.flash_point_c, vis.show_flash_point);
        addProp('pH', it.ph_value, vis.show_ph_value);
        addProp('Moisture %', it.moisture_content_percent, vis.show_moisture_content);
        addProp('Shelf Life (months)', it.shelf_life_months, vis.show_shelf_life_months);
        addProp('Comedogenic', it.comedogenic_rating, vis.show_comedogenic_rating);
      }
    }

    if (payload && payload.success) {
      const c = payload.cost || {};
      if (c.count && c.count > 0) {
        const mean = c.mean_ex_outliers != null ? c.mean_ex_outliers.toFixed(2) : '-';
        const low = c.low != null ? c.low.toFixed(2) : '-';
        const high = c.high != null ? c.high.toFixed(2) : '-';
        const minv = c.min != null ? c.min.toFixed(2) : '-';
        const maxv = c.max != null ? c.max.toFixed(2) : '-';
        document.getElementById('giCostStats').innerHTML = `Average: $${mean} (excluding outliers)<br>Low/High: $${low} – $${high}<br>Extremes: $${minv} – $${maxv} (n=${c.count})`;
      } else {
        document.getElementById('giCostStats').textContent = 'No cost data yet.';
      }
    } else {
      document.getElementById('giCostStats').textContent = 'No cost data yet.';
    }

    // Show developer link if user is a developer
    const devLink = document.getElementById('giDevLink');
    if (id) {
      devLink.href = `/developer/global-items/${id}`;
      devLink.style.display = '';
    } else {
      devLink.style.display = 'none';
    }

    loadingEl.style.display = 'none';
    contentEl.style.display = '';
  } catch (e) {
    console.error('Failed to load item details:', e);
    const loadingEl = document.getElementById('giDetailLoading');
    if (loadingEl) {
      loadingEl.innerHTML = `<div class="alert alert-danger">Failed to load item details: ${e.message}<br><small>Check console for more details</small></div>`;
    }
    const contentEl = document.getElementById('giDetailContent');
    if (contentEl) {
      contentEl.style.display = 'none';
    }
  }
}
</script>
{% endblock %}