{# File: developer/create_tier.html
   Synopsis: Create a subscription tier with limits, permissions, and add-ons.
   Glossary: Allowed add-on = purchasable; Included add-on = auto-granted. #}
{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Create New Subscription Tier</h2>
                <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Tiers
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Tier Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                    <div class="form-text">Display name for this subscription tier (e.g., "Solo Plan", "Team Plan")</div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="user_limit" class="form-label">User Limit</label>
                                    <input type="number" class="form-control" id="user_limit" name="user_limit" 
                                           value="1" min="-1" step="1" required>
                                    <div class="form-text">Set to -1 for unlimited users</div>
                                </div>

                                <div class="mb-3">
                                    <label for="fallback_price" class="form-label">Display Price</label>
                                    <input type="text" class="form-control" id="fallback_price" name="fallback_price" 
                                           value="$0" placeholder="$0">
                                </div>

                                <div class="mb-3">
                                    <label for="retention_policy" class="form-label">Data Retention</label>
                                    <select class="form-select" id="retention_policy" name="retention_policy" onchange="toggleRetentionFields()">
                                        <option value="one_year" selected>1 year</option>
                                        <option value="subscribed">Subscribed</option>
                                    </select>
                                    <div class="form-text">All-or-nothing: 1 year or unlimited while subscribed.</div>
                                </div>
                                <div class="mb-3" id="retention_days_field" style="display:none;">
                                    <label for="data_retention_days" class="form-label">Data Retention (days)</label>
                                    <input type="number" class="form-control" id="data_retention_days" name="data_retention_days" 
                                           min="0" placeholder="365">
                                </div>

                                <div class="mb-3">
                                    <label for="retention_notice_days" class="form-label">Notice Period (days)</label>
                                    <input type="number" class="form-control" id="retention_notice_days" name="retention_notice_days" 
                                           min="0" placeholder="e.g., 30">
                                    <div class="form-text">How many days before deletion to start notifying users.</div>
                                </div>


                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Visibility</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_customer_facing" 
                                               name="is_customer_facing" checked>
                                        <label class="form-check-label" for="is_customer_facing">
                                            Show to customers
                                        </label>
                                        <div class="form-text">Unchecked tiers are hidden from public view</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="billing_provider" class="form-label">Billing Provider *</label>
                                    <select class="form-select" id="billing_provider" name="billing_provider" 
                                            onchange="toggleBillingFields()" required>
                                        <option value="exempt">Exempt (No Billing)</option>
                                        <option value="stripe">Stripe</option>
                                        <option value="whop">Whop</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_billing_exempt" 
                                               name="is_billing_exempt" onchange="toggleBillingFields()">
                                        <label class="form-check-label" for="is_billing_exempt">
                                            <strong>Billing Exempt Override</strong>
                                        </label>
                                        <div class="form-text">Check to bypass all billing requirements</div>
                                    </div>
                                </div>

                                <div id="stripe_fields" class="mb-3" style="display: none;">
                                    <label for="stripe_lookup_key" class="form-label">Stripe Lookup Key *</label>
                                    <input type="text" class="form-control" id="stripe_lookup_key" name="stripe_lookup_key" 
                                           placeholder="batchtrack_team_monthly">
                                    <div class="form-text">Must match a Stripe price lookup key</div>
                                </div>



                                <div id="whop_fields" class="mb-3" style="display: none;">
                                    <label for="whop_product_key" class="form-label">Whop Product Key *</label>
                                    <input type="text" class="form-control" id="whop_product_key" name="whop_product_key" 
                                           placeholder="whop_product_123">
                                    <div class="form-text">Must match a Whop product identifier</div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="row">
                                {% for permission in all_permissions %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" 
                                               id="perm_{{ permission.id }}" name="permissions" value="{{ permission.id }}">
                                        <label class="form-check-label" for="perm_{{ permission.id }}">
                                            {{ permission.display_name or permission.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if addon_permissions %}
                            <div class="mt-3">
                                <label class="form-label">Add-on Permissions (read-only)</label>
                                <div class="row">
                                    {% for addon in all_addons %}
                                        {% set perm = addon_permissions.get(addon.id) %}
                                        {% if perm %}
                                        <div class="col-md-4 mb-2 addon-permission" data-addon-id="{{ addon.id }}" style="display: none;">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" checked disabled>
                                                <input type="hidden"
                                                       class="addon-permission-input"
                                                       data-addon-id="{{ addon.id }}"
                                                       name="permissions"
                                                       value="{{ perm.id }}"
                                                       disabled>
                                                <label class="form-check-label">
                                                    {{ perm.display_name or perm.name }}
                                                    <small class="text-muted">(via {{ addon.name }})</small>
                                                </label>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="form-text">Add-on permissions appear only when the add-on is selected.</div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Allowed Add-ons (Purchasable via Stripe)</label>
                            <div class="row">
                                {% for addon in all_addons %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               id="allowed_addon_{{ addon.id }}" name="allowed_addons" value="{{ addon.id }}">
                                        <label class="form-check-label" for="allowed_addon_{{ addon.id }}">
                                            {{ addon.name }}{% if addon.permission_name %} (perm: {{ addon.permission_name }}){% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Customers on this tier can purchase these add-ons.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Included Add-ons (Stripe-bypassed)</label>
                            <div class="row">
                                {% for addon in all_addons %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               id="included_addon_{{ addon.id }}" name="included_addons" value="{{ addon.id }}">
                                        <label class="form-check-label" for="included_addon_{{ addon.id }}">
                                            {{ addon.name }} (included)
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">These add-ons are granted on this tier without purchase.</div>
                        </div>

                        <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_recipes" class="form-label">Max Recipes (Total)</label>
                                            <input type="number" class="form-control" id="max_recipes" name="max_recipes" placeholder="Enter number or -1 for unlimited" min="-1">
                                            <div class="form-text">Total recipes allowed. Use -1 for unlimited.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_products" class="form-label">Max Products (Total)</label>
                                            <input type="number" class="form-control" id="max_products" name="max_products" placeholder="Enter number or -1 for unlimited" min="-1">
                                            <div class="form-text">Total products allowed. Use -1 for unlimited.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_batchbot_requests" class="form-label">Max BatchBot Requests (Monthly)</label>
                                            <input type="number" class="form-control" id="max_batchbot_requests" name="max_batchbot_requests" placeholder="Enter number or -1 for unlimited" min="-1">
                                            <div class="form-text">AI requests per month. Use -1 for unlimited.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_monthly_batches" class="form-label">Max Monthly Batches</label>
                                            <input type="number" class="form-control" id="max_monthly_batches" name="max_monthly_batches" placeholder="Enter number or -1 for unlimited" min="-1">
                                            <div class="form-text">Batches per month. Use -1 for unlimited.</div>
                                        </div>
                                    </div>
                                </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Create Tier</button>
                            <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleBillingFields() {
    const provider = document.getElementById('billing_provider').value;
    const isExempt = document.getElementById('is_billing_exempt').checked;

    const stripeFields = document.getElementById('stripe_fields');

    const whopFields = document.getElementById('whop_fields');

    // Hide all fields by default
    stripeFields.style.display = 'none';

    whopFields.style.display = 'none';

    // Show relevant fields if not exempt
    if (!isExempt) {
        if (provider === 'stripe') {
            stripeFields.style.display = 'block';
        } else if (provider === 'whop') {
            whopFields.style.display = 'block';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', toggleBillingFields);

function toggleRetentionFields() {
    const policy = document.getElementById('retention_policy')?.value;
    const daysField = document.getElementById('retention_days_field');
    if (!policy || !daysField) return;
    if (policy === 'one_year') {
        daysField.style.display = 'none';
        const input = document.getElementById('data_retention_days');
        if (input) input.value = 365;
    } else if (policy === 'subscribed') {
        daysField.style.display = 'none';
        const input = document.getElementById('data_retention_days');
        if (input) input.value = '';
    } else {
        daysField.style.display = 'block';
    }
}
document.addEventListener('DOMContentLoaded', toggleRetentionFields);

function syncAddonPermissions() {
    const selected = new Set();
    document.querySelectorAll('input[name="allowed_addons"]:checked, input[name="included_addons"]:checked')
        .forEach((el) => selected.add(el.value));
    document.querySelectorAll('.addon-permission').forEach((el) => {
        const addonId = el.getAttribute('data-addon-id');
        const enabled = selected.has(addonId);
        el.style.display = enabled ? '' : 'none';
        const hiddenInput = el.querySelector('.addon-permission-input');
        if (hiddenInput) {
            hiddenInput.disabled = !enabled;
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="allowed_addons"], input[name="included_addons"]')
        .forEach((el) => el.addEventListener('change', syncAddonPermissions));
    syncAddonPermissions();
});
</script>
{% endblock %}