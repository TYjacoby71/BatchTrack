{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Create New Subscription Tier</h2>
                <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Tiers
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        {{ csrf_token() }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="key" class="form-label">Tier Key *</label>
                                    <input type="text" class="form-control" id="key" name="key" required>
                                    <div class="form-text">Unique identifier (e.g., "team", "enterprise")</div>
                                </div>

                                <div class="mb-3">
                                    <label for="name" class="form-label">Display Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="user_limit" class="form-label">User Limit</label>
                                    <input type="number" class="form-control" id="user_limit" name="user_limit" 
                                           value="1" min="1" required>
                                    <div class="form-text">Set to -1 for unlimited users</div>
                                </div>

                                <div class="mb-3">
                                    <label for="fallback_price" class="form-label">Display Price</label>
                                    <input type="text" class="form-control" id="fallback_price" name="fallback_price" 
                                           value="$0" placeholder="$0">
                                </div>

                                <div class="mb-3">
                                    <label for="data_retention_days" class="form-label">Data Retention (days)</label>
                                    <input type="number" class="form-control" id="data_retention_days" name="data_retention_days" 
                                           min="0" placeholder="e.g., 365 for 1 year (leave blank for indefinite)">
                                    <div class="form-text">How long to retain long-term data before hard delete. Blank = indefinite.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="retention_notice_days" class="form-label">Notice Period (days)</label>
                                    <input type="number" class="form-control" id="retention_notice_days" name="retention_notice_days" 
                                           min="0" placeholder="e.g., 30">
                                    <div class="form-text">How many days before deletion to start notifying users.</div>
                                </div>

                                
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Visibility</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_customer_facing" 
                                               name="is_customer_facing" checked>
                                        <label class="form-check-label" for="is_customer_facing">
                                            Show to customers
                                        </label>
                                        <div class="form-text">Unchecked tiers are hidden from public view</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="billing_provider" class="form-label">Billing Provider *</label>
                                    <select class="form-select" id="billing_provider" name="billing_provider" 
                                            onchange="toggleBillingFields()" required>
                                        <option value="exempt">Exempt (No Billing)</option>
                                        <option value="stripe">Stripe</option>
                                        <option value="whop">Whop</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_billing_exempt" 
                                               name="is_billing_exempt" onchange="toggleBillingFields()">
                                        <label class="form-check-label" for="is_billing_exempt">
                                            <strong>Billing Exempt Override</strong>
                                        </label>
                                        <div class="form-text">Check to bypass all billing requirements</div>
                                    </div>
                                </div>

                                <div id="stripe_fields" class="mb-3" style="display: none;">
                                    <label for="stripe_lookup_key" class="form-label">Stripe Lookup Key *</label>
                                    <input type="text" class="form-control" id="stripe_lookup_key" name="stripe_lookup_key" 
                                           placeholder="batchtrack_team_monthly">
                                    <div class="form-text">Must match a Stripe price lookup key</div>
                                </div>

                                

                                <div id="whop_fields" class="mb-3" style="display: none;">
                                    <label for="whop_product_key" class="form-label">Whop Product Key *</label>
                                    <input type="text" class="form-control" id="whop_product_key" name="whop_product_key" 
                                           placeholder="whop_product_123">
                                    <div class="form-text">Must match a Whop product identifier</div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="row">
                                {% for permission in all_permissions %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" 
                                               id="perm_{{ permission.id }}" name="permissions" value="{{ permission.id }}">
                                        <label class="form-check-label" for="perm_{{ permission.id }}">
                                            {{ permission.display_name or permission.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Allowed Add-ons</label>
                            <div class="row">
                                {% for addon in all_addons %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               id="addon_{{ addon.id }}" name="allowed_addons" value="{{ addon.id }}">
                                        <label class="form-check-label" for="addon_{{ addon.id }}">
                                            {{ addon.name }}{% if addon.permission_name %} (perm: {{ addon.permission_name }}){% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Only add-ons checked here can be purchased on this tier.</div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Create Tier</button>
                            <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleBillingFields() {
    const provider = document.getElementById('billing_provider').value;
    const isExempt = document.getElementById('is_billing_exempt').checked;

    const stripeFields = document.getElementById('stripe_fields');
    
    const whopFields = document.getElementById('whop_fields');

    // Hide all fields by default
    stripeFields.style.display = 'none';
    
    whopFields.style.display = 'none';

    // Show relevant fields if not exempt
    if (!isExempt) {
        if (provider === 'stripe') {
            stripeFields.style.display = 'block';
        } else if (provider === 'whop') {
            whopFields.style.display = 'block';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', toggleBillingFields);
</script>
{% endblock %}