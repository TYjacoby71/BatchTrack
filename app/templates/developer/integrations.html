{% extends 'layout.html' %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Integrations & Launch Checklist</h2>
  <p class="text-muted">Use this page as a checklist to prepare for launch. Items marked in green are configured; items in red need attention.</p>

  <hr>
  <h4>1) Email (Transactional)</h4>
  <p>Provider: <strong>{{ email_provider|upper }}</strong> ‚Äî Status: {% if email_configured %}<span class="text-success">Configured</span>{% else %}<span class="text-danger">Not configured</span>{% endif %}</p>
  <ul>
    <li>SMTP: {{ 'OK' if email_keys.SMTP else 'Missing' }}</li>
    <li>SendGrid API key: {{ 'OK' if email_keys.SendGrid else 'Missing' }}</li>
    <li>Postmark Server Token: {{ 'OK' if email_keys.Postmark else 'Missing' }}</li>
    <li>Mailgun API/Domain: {{ 'OK' if email_keys.Mailgun else 'Missing' }}</li>
  </ul>
  
  <!-- Email Configuration Instructions -->
  <div class="accordion mb-3" id="emailAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#emailInstructions">
          üìß Email Provider Setup Instructions
        </button>
      </h2>
      <div id="emailInstructions" class="accordion-collapse collapse" data-bs-parent="#emailAccordion">
        <div class="accordion-body">
          <h6>EMAIL_PROVIDER</h6>
          <p><strong>What it does:</strong> Selects which email service to use for sending transactional emails (verification, password reset, notifications).</p>
          <p><strong>Valid options:</strong> <code>smtp</code>, <code>sendgrid</code>, <code>postmark</code>, <code>mailgun</code></p>
          <p><strong>What you need to do:</strong> Set to your chosen provider, e.g., <code>EMAIL_PROVIDER=sendgrid</code></p>
          
          <hr>
          <h6>SMTP Configuration (Generic)</h6>
          <div class="row">
            <div class="col-md-6">
              <p><strong>MAIL_SERVER:</strong> Your SMTP server hostname (e.g., <code>smtp.gmail.com</code>)</p>
              <p><strong>MAIL_PORT:</strong> Port number (587 for TLS, 465 for SSL, 25 for unencrypted)</p>
              <p><strong>MAIL_USE_TLS:</strong> Enable STARTTLS encryption. Set to <code>true</code> for port 587</p>
            </div>
            <div class="col-md-6">
              <p><strong>MAIL_USE_SSL:</strong> Enable implicit SSL. Set to <code>true</code> for port 465, <code>false</code> otherwise</p>
              <p><strong>MAIL_USERNAME:</strong> Your SMTP login username</p>
              <p><strong>MAIL_PASSWORD:</strong> Your SMTP password or app-specific password</p>
            </div>
          </div>
          
          <hr>
          <h6>Provider-Specific Setup</h6>
          <div class="row">
            <div class="col-md-3">
              <strong>SendGrid</strong>
              <p><code>SENDGRID_API_KEY</code>: API key from SendGrid dashboard</p>
              <p>DNS: Add SPF/DKIM records to your domain</p>
            </div>
            <div class="col-md-3">
              <strong>Postmark</strong>
              <p><code>POSTMARK_SERVER_TOKEN</code>: Server token from Postmark</p>
              <p>DNS: Verify domain ownership and DKIM</p>
            </div>
            <div class="col-md-3">
              <strong>Mailgun</strong>
              <p><code>MAILGUN_API_KEY</code>: Private API key</p>
              <p><code>MAILGUN_DOMAIN</code>: Your verified domain</p>
              <p>DNS: Add MX, TXT records as shown</p>
            </div>
            <div class="col-md-3">
              <strong>All Providers</strong>
              <p><code>MAIL_DEFAULT_SENDER</code>: From address for all emails</p>
              <p>Must be verified/authorized with your provider</p>
            </div>
          </div>
          
          <div class="alert alert-warning mt-3">
            <strong>Important:</strong> Always verify your sending domain with SPF and DKIM records to avoid emails going to spam.
          </div>
        </div>
      </div>
    </div>
  </div>
  <form method="post" action="{{ url_for('developer.integrations_test_email') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="btn btn-sm btn-primary" type="submit" {% if not email_configured %}disabled{% endif %}>Send Test Email</button>
  </form>

  <hr>
  <h4>2) Billing (Stripe)</h4>
  <p>Status:
    <span class="badge {% if stripe_status.secret_key_present %}bg-success{% else %}bg-danger{% endif %}">Secret Key</span>
    <span class="badge {% if stripe_status.publishable_key_present %}bg-success{% else %}bg-danger{% endif %}">Publishable Key</span>
    <span class="badge {% if stripe_status.webhook_secret_present %}bg-success{% else %}bg-danger{% endif %}">Webhook Secret</span>
    <span class="badge {% if stripe_status.tiers_configured %}bg-success{% else %}bg-danger{% endif %}">Tiers</span>
  </p>
  
  <!-- Stripe Configuration Instructions -->
  <div class="accordion mb-3" id="stripeAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stripeInstructions">
          üí≥ Stripe Billing Setup Instructions
        </button>
      </h2>
      <div id="stripeInstructions" class="accordion-collapse collapse" data-bs-parent="#stripeAccordion">
        <div class="accordion-body">
          <h6>STRIPE_SECRET_KEY</h6>
          <p><strong>What it does:</strong> Authenticates your app with Stripe's API for creating customers, subscriptions, and processing payments.</p>
          <p><strong>Format:</strong> <code>sk_test_...</code> for development, <code>sk_live_...</code> for production</p>
          <p><strong>Where to find:</strong> Stripe Dashboard ‚Üí Developers ‚Üí API keys ‚Üí Secret key</p>
          <p><strong>Security:</strong> Keep this secret! Never expose in client-side code.</p>
          
          <hr>
          <h6>STRIPE_PUBLISHABLE_KEY</h6>
          <p><strong>What it does:</strong> Used in frontend JavaScript for Stripe Elements and Checkout sessions.</p>
          <p><strong>Format:</strong> <code>pk_test_...</code> for development, <code>pk_live_...</code> for production</p>
          <p><strong>Where to find:</strong> Stripe Dashboard ‚Üí Developers ‚Üí API keys ‚Üí Publishable key</p>
          <p><strong>Note:</strong> Safe to expose in frontend code, but still treat as sensitive.</p>
          
          <hr>
          <h6>STRIPE_WEBHOOK_SECRET</h6>
          <p><strong>What it does:</strong> Verifies that webhook events actually came from Stripe (prevents spoofing).</p>
          <p><strong>Format:</strong> <code>whsec_...</code></p>
          <p><strong>Setup steps:</strong></p>
          <ol>
            <li>In Stripe Dashboard ‚Üí Developers ‚Üí Webhooks</li>
            <li>Click "Add endpoint"</li>
            <li>Set URL to: <code>https://yourdomain.com/billing/webhooks/stripe</code></li>
            <li>Select events: <code>customer.subscription.*</code>, <code>checkout.session.completed</code>, <code>invoice.payment_succeeded</code>, <code>invoice.payment_failed</code></li>
            <li>Save and copy the "Signing secret" to this environment variable</li>
          </ol>
          
          <hr>
          <h6>Products & Pricing Setup</h6>
          <p><strong>What you need to do:</strong></p>
          <ol>
            <li>Create Products in Stripe Dashboard ‚Üí Products</li>
            <li>For each product, create Prices with <strong>lookup keys</strong>:
              <ul>
                <li><code>batchtrack_solo_monthly</code></li>
                <li><code>batchtrack_team_monthly</code></li>
                <li><code>batchtrack_enterprise_monthly</code></li>
              </ul>
            </li>
            <li>Ensure your database subscription tiers have matching <code>stripe_lookup_key</code> values</li>
          </ol>
          
          <div class="alert alert-warning mt-3">
            <strong>Test vs Live Mode:</strong> Use test keys during development. Switch to live keys only when ready to charge real customers.
          </div>
        </div>
      </div>
    </div>
  </div>
  <form method="post" action="{{ url_for('developer.integrations_test_stripe') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="btn btn-sm btn-primary" type="submit" {% if not stripe_status.secret_key_present %}disabled{% endif %}>Test Stripe Connectivity</button>
  </form>
  <div class="mt-2">
    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="loadStripeEvents()">Show Recent Webhook Events</button>
    <pre id="stripeEvents" class="mt-2" style="white-space: pre-wrap;"></pre>
    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="checkWebhook()">Check Webhook Endpoint Reachability</button>
    <pre id="webhookCheck" class="mt-2" style="white-space: pre-wrap;"></pre>
  </div>

  <hr>
  <h4>3) Feature Flags & System Toggles</h4>
  <p>Features are broad functional areas. Permissions control specific actions within those features.</p>

  <!-- Feature Flags Instructions -->
  <div class="accordion mb-3" id="flagsAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flagsInstructions">
          üö© Feature Flags Guide - What Each Flag Does
        </button>
      </h2>
      <div id="flagsInstructions" class="accordion-collapse collapse" data-bs-parent="#flagsAccordion">
        <div class="accordion-body">
          <p><strong>How Feature Flags Work:</strong> These control which features are available to users. When enabled, the functionality appears in menus and UI. When disabled, it's hidden.</p>
          
          <h6>Core Business Features</h6>
          <ul>
            <li><strong>FIFO Tracking:</strong> First-in-first-out inventory cost calculation. Disable if you want average cost only.</li>
            <li><strong>Barcode Scanning:</strong> QR/barcode integration (not yet implemented). Enable for future use.</li>
            <li><strong>Product Variants:</strong> Multiple SKUs per product (size, color variations). Core feature.</li>
            <li><strong>Auto-generate SKUs:</strong> Automatic SKU code creation. Disable for manual SKU entry only.</li>
            <li><strong>Recipe Variations:</strong> Parent/child recipe relationships. Enables recipe families.</li>
            <li><strong>Cost Tracking:</strong> Profit margin calculations and costing engine. Essential for pricing.</li>
            <li><strong>Expiration Tracking:</strong> Lot-based expiry dates and alerts. Critical for compliance.</li>
            <li><strong>Bulk Operations:</strong> Bulk inventory adjustments. Disable for single-item-only workflows.</li>
          </ul>
          
          <h6>Notification Systems</h6>
          <ul>
            <li><strong>Email Notifications:</strong> System-generated email alerts. Requires email provider setup.</li>
            <li><strong>Browser Push:</strong> Real-time browser notifications (not implemented yet).</li>
          </ul>
          
          <h6>Public Tools Availability</h6>
          <ul>
            <li><strong>Soap Making Tools:</strong> Saponification calculators, lye calculations.</li>
            <li><strong>Candle Making:</strong> Fragrance load calculators, wick sizing.</li>
            <li><strong>Lotions & Cosmetics:</strong> Emulsifier ratios, preservative calculations.</li>
            <li><strong>Herbalist Tools:</strong> Tincture ratios, extraction calculations.</li>
            <li><strong>Baking Tools:</strong> Baker's percentage calculators, hydration ratios.</li>
          </ul>
          
          <div class="alert alert-info">
            <strong>Recommendation:</strong> Keep core business features enabled. Disable only specific tools your users don't need.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div id="flagSaveStatus" class="alert alert-success d-none" role="alert">
      ‚úÖ Feature flags updated successfully
    </div>
    <h6 class="mt-3">Core Business Features</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_fifo_tracking" {% if feature_flags.get('FEATURE_FIFO_TRACKING', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_fifo_tracking">
        FIFO Inventory Tracking 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">First-in-first-out inventory tracking via inventory_adjustment service</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_barcode_scanning" {% if feature_flags.get('FEATURE_BARCODE_SCANNING', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_barcode_scanning">
        Barcode Scanning 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Barcode scanning for inventory management - not implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_product_variants" {% if feature_flags.get('FEATURE_PRODUCT_VARIANTS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_product_variants">
        Product Variants System 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Working products system with variants via ProductService</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_auto_sku_generation" {% if feature_flags.get('FEATURE_AUTO_SKU_GENERATION', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_auto_sku_generation">
        Auto-generate SKUs 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Implemented in ProductService for automatic SKU code generation</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_recipe_variations" {% if feature_flags.get('FEATURE_RECIPE_VARIATIONS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_recipe_variations">
        Recipe Variations 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Working recipe system with parent/child variation relationships</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_cost_tracking" {% if feature_flags.get('FEATURE_COST_TRACKING', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_cost_tracking">
        Cost Tracking & Profit Margins 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Implemented in costing_engine and inventory with FIFO/average costing</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_expiration_tracking" {% if feature_flags.get('FEATURE_EXPIRATION_TRACKING', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_expiration_tracking">
        Expiration Date Tracking 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Working expiration system with services and lot-based tracking</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_bulk_operations" {% if feature_flags.get('FEATURE_BULK_OPERATIONS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_bulk_operations">
        Bulk Inventory Operations 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Implemented in bulk_stock routes for bulk inventory operations</small></div>
    </div>

    <h6 class="mt-3">Developer & Advanced Features</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_analytics" {% if feature_flags.FEATURE_INVENTORY_ANALYTICS %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_analytics">
        Inventory Analytics (developer only) 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Developer feature for advanced inventory analytics and reporting</small></div>
    </div>
    {% if config['DEBUG'] %}
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_debug_mode" {% if feature_flags.get('FEATURE_DEBUG_MODE', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_debug_mode">
        Debug Mode 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Enables detailed logging and debugging information for development purposes</small></div>
    </div>
    {% endif %}
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_auto_backup" {% if feature_flags.get('FEATURE_AUTO_BACKUP', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_auto_backup">
        Auto-backup System 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Automated backup of system data and configurations - not yet implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_csv_export" {% if feature_flags.get('FEATURE_CSV_EXPORT', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_csv_export">
        CSV Export 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Functionality to export data and reports to CSV format</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_advanced_reports" {% if feature_flags.get('FEATURE_ADVANCED_REPORTS', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_advanced_reports">
        Advanced Reports 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Complex reporting features beyond standard reports - not implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_global_item_library" {% if feature_flags.get('FEATURE_GLOBAL_ITEM_LIBRARY', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_global_item_library">
        Global Item Library Access 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Access to a shared library of items across multiple locations or systems</small></div>
    </div>

    <h6 class="mt-3">Notification Systems</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_email_notifications" {% if feature_flags.get('FEATURE_EMAIL_NOTIFICATIONS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_email_notifications">
        Email Notifications 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">System for sending email notifications to users and administrators</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_browser_notifications" {% if feature_flags.get('FEATURE_BROWSER_NOTIFICATIONS', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_browser_notifications">
        Browser Push Notifications 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Real-time push notifications to the browser - not implemented</small></div>
    </div>

    <h6 class="mt-3">Integration Features</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_shopify_integration" {% if feature_flags.get('FEATURE_SHOPIFY_INTEGRATION', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_shopify_integration">
        Shopify Integration (stubbed) 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Integration with Shopify for e-commerce synchronization - currently a placeholder</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_api_access" {% if feature_flags.get('FEATURE_API_ACCESS', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_api_access">
        REST API Access 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Enables access to the system via a RESTful API - not implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_oauth_providers" {% if feature_flags.get('FEATURE_OAUTH_PROVIDERS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_oauth_providers">
        OAuth Login Providers 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Support for authentication via OAuth 2.0 providers (e.g., Google, Facebook)</small></div>
    </div>

    <h6 class="mt-3">AI Features (Premium)</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_ai_recipe_optimization" {% if feature_flags.get('FEATURE_AI_RECIPE_OPTIMIZATION', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_ai_recipe_optimization">
        AI Recipe Optimization 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">Utilizes AI for optimizing recipes and ingredient usage - not implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_ai_demand_forecasting" {% if feature_flags.get('FEATURE_AI_DEMAND_FORECASTING', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_ai_demand_forecasting">
        AI Demand Forecasting 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">AI-powered demand forecasting for inventory management - not implemented</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="ff_ai_quality_insights" {% if feature_flags.get('FEATURE_AI_QUALITY_INSIGHTS', False) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="ff_ai_quality_insights">
        AI Quality Insights 
        <span class="badge bg-danger ms-1">STUB</span>
      </label>
      <div><small class="text-muted">AI analysis for quality control and insights - not implemented</small></div>
    </div>

    <h6 class="mt-3">Public Tools Availability</h6>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="tools_soap" {% if feature_flags.get('TOOLS_SOAP', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="tools_soap">
        Soap Making Tools 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Tools and calculators for soap making recipes and processes</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="tools_candles" {% if feature_flags.get('TOOLS_CANDLES', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="tools_candles">
        Candle Making Tools 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Tools and calculators for candle making recipes and processes</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="tools_lotions" {% if feature_flags.get('TOOLS_LOTIONS', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="tools_lotions">
        Lotion & Cosmetic Tools 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Tools for creating lotions, creams, and other cosmetic products</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="tools_herbal" {% if feature_flags.get('TOOLS_HERBAL', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="tools_herbal">
        Herbalist Tools 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Tools for herbalists, including tincture calculators and formulation aids</small></div>
    </div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="tools_baking" {% if feature_flags.get('TOOLS_BAKING', True) %}checked{% endif %} onchange="saveFlags()">
      <label class="form-check-label" for="tools_baking">
        Baking Tools 
        <span class="badge bg-success ms-1">WIRED</span>
      </label>
      <div><small class="text-muted">Tools for bakers, including recipe scaling and ingredient conversions</small></div>
    </div>

    <small class="text-muted">Features control broad functionality. Permissions (managed via subscription tiers) control specific actions within features. Changes update the running app and persist to settings.json.</small>
  </div>

  <hr>
  <h4>4) POS/Shopify</h4>
  <p>Status: <span class="badge bg-secondary">{{ shopify_status.status|capitalize }}</span></p>
  
  <!-- POS/Shopify Instructions -->
  <div class="accordion mb-3" id="shopifyAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shopifyInstructions">
          üõçÔ∏è POS/Shopify Integration (Coming Soon)
        </button>
      </h2>
      <div id="shopifyInstructions" class="accordion-collapse collapse" data-bs-parent="#shopifyAccordion">
        <div class="accordion-body">
          <p><strong>Current Status:</strong> This integration is currently stubbed and not yet implemented.</p>
          
          <h6>When Available, You'll Need:</h6>
          <ul>
            <li><strong>SHOPIFY_API_KEY:</strong> Your app's API key from Shopify Partners dashboard</li>
            <li><strong>SHOPIFY_API_SECRET:</strong> Your app's secret key (never expose publicly)</li>
            <li><strong>SHOPIFY_WEBHOOK_SECRET:</strong> For verifying webhook authenticity</li>
            <li><strong>SHOPIFY_SCOPES:</strong> Permissions your app needs (read_products, write_inventory, etc.)</li>
          </ul>
          
          <h6>Planned Features:</h6>
          <ul>
            <li>Two-way inventory sync</li>
            <li>Product catalog synchronization</li>
            <li>Order fulfillment updates</li>
            <li>Real-time stock level updates</li>
            <li>Webhook event processing</li>
          </ul>
          
          <h6>Setup Steps (Future):</h6>
          <ol>
            <li>Create a Shopify Partner account</li>
            <li>Create a new app in the Partner dashboard</li>
            <li>Configure OAuth scopes and webhook URLs</li>
            <li>Install the app on your Shopify store</li>
            <li>Configure sync preferences in BatchTrack</li>
          </ol>
          
          <div class="alert alert-info">
            <strong>Interested in this feature?</strong> Contact support to be notified when Shopify integration is available.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="alert alert-secondary">
    POS/Shopify is currently stubbed. When ready, we will add a provider adapter (webhooks and API client) and expose configuration here.
  </div>

  <hr>
  <h4>5) Logging & Security</h4>
  <ul>
    <li>LOG_LEVEL: <code>{{ logging_status.LOG_LEVEL }}</code></li>
    <li>PII Redaction: {% if logging_status.LOG_REDACT_PII %}<span class="text-success">On</span>{% else %}<span class="text-danger">Off</span>{% endif %}</li>
  </ul>
  
  <!-- Logging & Security Instructions -->
  <div class="accordion mb-3" id="loggingAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#loggingInstructions">
          üìä Logging & Security Configuration Guide
        </button>
      </h2>
      <div id="loggingInstructions" class="accordion-collapse collapse" data-bs-parent="#loggingAccordion">
        <div class="accordion-body">
          <h6>LOG_LEVEL</h6>
          <p><strong>What it controls:</strong> How much detail appears in your application logs.</p>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Available levels (most to least verbose):</strong></p>
              <ul>
                <li><code>DEBUG</code> - Everything including variable dumps</li>
                <li><code>INFO</code> - General operational messages</li>
                <li><code>WARNING</code> - Warnings and recoverable errors</li>
                <li><code>ERROR</code> - Errors and exceptions only</li>
                <li><code>CRITICAL</code> - Only critical failures</li>
              </ul>
            </div>
            <div class="col-md-6">
              <p><strong>Recommendations:</strong></p>
              <ul>
                <li><strong>Development:</strong> <code>DEBUG</code> or <code>INFO</code></li>
                <li><strong>Staging:</strong> <code>INFO</code></li>
                <li><strong>Production:</strong> <code>WARNING</code> or <code>ERROR</code></li>
              </ul>
              <p><strong>Performance note:</strong> DEBUG logging can slow down your app significantly.</p>
            </div>
          </div>
          
          <hr>
          <h6>LOG_REDACT_PII</h6>
          <p><strong>What it does:</strong> Automatically removes personally identifiable information from logs (emails, names, addresses).</p>
          <p><strong>When enabled:</strong> <code>user@example.com</code> becomes <code>[REDACTED_EMAIL]</code></p>
          <p><strong>When to use:</strong></p>
          <ul>
            <li><strong>Always enable in production</strong> - Required for GDPR/CCPA compliance</li>
            <li><strong>Enable in staging</strong> - If using real user data</li>
            <li><strong>Optional in development</strong> - Can disable for easier debugging</li>
          </ul>
          
          <hr>
          <h6>Security Headers</h6>
          <p><strong>ENABLE_PROXY_FIX:</strong> Set to <code>true</code> when behind load balancers (Cloudflare, AWS ALB, etc.)</p>
          <p><strong>DISABLE_SECURITY_HEADERS:</strong> Emergency kill-switch. Only use if headers break your app.</p>
          
          <div class="alert alert-danger">
            <strong>Security Warning:</strong> Never disable PII redaction in production environments with real customer data!
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>Recommendation:</strong> Keep PII redaction enabled in production. Use DEBUG only in secure development environments.
  </div>

  <hr>
  <h4>6) Pre-Launch Checklist (Quick View)</h4>
  <ul>
    <li>Email provider configured: {% if email_configured %}<span class="text-success">Yes</span>{% else %}<span class="text-danger">No</span>{% endif %}</li>
    <li>Stripe keys present: {% if stripe_status.secret_key_present and stripe_status.webhook_secret_present %}<span class="text-success">Yes</span>{% else %}<span class="text-danger">No</span>{% endif %}</li>
    <li>Tiers configured in DB: {% if tiers_count > 0 %}<span class="text-success">Yes</span>{% else %}<span class="text-danger">No</span>{% endif %}</li>
    <li>Feature flags set appropriately: <span class="text-muted">Review above</span></li>
  </ul>
  <hr>
<h4>7) Core Environment</h4>
<p class="text-muted">Work through every launch-critical environment variable and secret below. Entries auto-check when detected from the runtime, and you can tick them manually while you deploy.</p>

  <div class="alert alert-warning">
    <strong>Environment switch:</strong> Set <code>FLASK_ENV=production</code> (and leave <code>FLASK_DEBUG</code> unset/false) in every live deployment. Local development should use <code>FLASK_ENV=development</code>. All runtime behavior‚Äîdebug panels, logging verbosity, session security, and rate limits‚Äînow keys off this single variable.
  </div>

<!-- Environment Variables Instructions -->
<div class="accordion mb-3" id="envAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#envInstructions">
        ‚öôÔ∏è Environment Variables & Secrets - Complete Setup Guide
      </button>
    </h2>
    <div id="envInstructions" class="accordion-collapse collapse" data-bs-parent="#envAccordion">
      <div class="accordion-body">
        <h6>How to Set Environment Variables</h6>
        <div class="row">
          <div class="col-md-4">
            <strong>Replit (Secrets)</strong>
            <ol>
              <li>Click lock icon üîí in sidebar</li>
              <li>Add key-value pairs</li>
              <li>Secrets are encrypted at rest</li>
            </ol>
          </div>
          <div class="col-md-4">
            <strong>Local Development</strong>
            <ol>
              <li>Create <code>.env</code> file</li>
              <li>Add: <code>KEY=value</code></li>
              <li>Never commit <code>.env</code> to git</li>
            </ol>
          </div>
          <div class="col-md-4">
            <strong>Production Servers</strong>
            <ol>
              <li>Use your host's env var system</li>
              <li>Docker: <code>-e KEY=value</code></li>
              <li>Or export in shell: <code>export KEY=value</code></li>
            </ol>
          </div>
        </div>
        
        <hr>
        <h6>Critical Security Variables</h6>
        <div class="row">
          <div class="col-md-6">
            <p><strong>FLASK_SECRET_KEY</strong><br>
            <span class="text-danger">üîê CRITICAL SECRET</span><br>
            Must be 32+ random characters. Used for session signing, CSRF protection, password resets.<br>
            <strong>Generate with:</strong> <code>python -c "import secrets; print(secrets.token_hex(32))"</code></p>
            
            <p><strong>DATABASE_INTERNAL_URL / DATABASE_URL</strong><br>
            <span class="text-warning">üîê SECRET</span><br>
            Connection string with username/password. Format: <code>postgresql://user:pass@host:5432/db</code></p>
          </div>
          <div class="col-md-6">
            <p><strong>REDIS_URL</strong><br>
            <span class="text-warning">üîê SECRET</span><br>
            For sessions, rate limiting, caching. Format: <code>redis://user:pass@host:6379/0</code></p>
            
            <p><strong>Stripe Keys</strong><br>
            <span class="text-danger">üîê SECRET</span><br>
            Never expose secret keys in frontend. Webhook secret verifies Stripe's identity.</p>
          </div>
        </div>
        
        <hr>
        <h6>Production vs Development</h6>
        <div class="alert alert-warning">
          <strong>FLASK_ENV=production</strong> changes everything:
          <ul class="mb-0">
            <li>Disables debug mode and stack traces</li>
            <li>Requires Redis for sessions (memory sessions disabled)</li>
            <li>Enables security headers and proxy trust</li>
            <li>Changes logging levels and error handling</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% for section in launch_env_sections %}
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="mb-0">{{ section.title }}</h5>
    </div>
    {% if section.note %}
      <div class="alert alert-secondary small mb-2">{{ section.note }}</div>
    {% endif %}
    <div class="list-group">
      {% for item in section.section_items %}
        <label class="list-group-item d-flex align-items-start gap-3">
          <input class="form-check-input mt-1" type="checkbox" id="env_{{ item.key }}" {% if item.present %}checked{% endif %}>
          <div>
            <div class="fw-semibold">
              {{ item.key }}
              {% if not item.required %}<span class="badge bg-secondary ms-2">Optional</span>{% endif %}
              {% if item.is_secret %}<span class="badge bg-warning text-dark ms-2">Secret</span>{% endif %}
            </div>
            <div class="small text-muted">{{ item.description }}</div>
            <div class="small {% if item.present %}text-success{% else %}text-danger{% endif %}">
              {% if item.present %}
                Detected via {{ 'environment' if item.source == 'env' else 'configuration' }}
              {% else %}
                Not detected
              {% endif %}
              {% if item.recommended %}<span class="text-muted ms-2">Recommended: {{ item.recommended }}</span>{% endif %}
            </div>
            {% if item.note %}
              <div class="small text-muted">{{ item.note }}</div>
            {% endif %}
          </div>
        </label>
      {% endfor %}
    </div>
  </div>
{% endfor %}

  <div class="alert alert-info">
    <strong>Redis provisioning:</strong> Before launch, create a managed Redis instance (Render Redis, Upstash, AWS ElastiCache, etc.). Copy the connection URL into <code>REDIS_URL</code> and mirror it into <code>RATELIMIT_STORAGE_URI</code>. The app now refuses to start in production without Redis-backed sessions, caching, and rate limiting.
  </div>

<ul>
  <li>Environment: <code>{{ env_core.FLASK_ENV }}</code></li>
  <li>Replit Deployment: <code>{{ env_core.REPLIT_DEPLOYMENT }}</code></li>
  <li>SECRET_KEY present: {% if env_core.SECRET_KEY_present %}<span class="text-success">Yes</span>{% else %}<span class="text-danger">No</span>{% endif %}</li>
</ul>
<div class="alert alert-info">
  <strong>Database backend:</strong> <span class="text-uppercase">{{ db_info.backend }}</span> via <code>{{ db_info.source }}</code>. Ensure migrations run before flip to production.
</div>
  <div class="card p-3">
    <h6>Database Configuration</h6>
    <div>Current URI: <code>{{ db_info.uri }}</code></div>
    <div>Detected source: <code>{{ db_info.source }}</code></div>
    <div class="text-muted small">Set <code>DATABASE_INTERNAL_URL</code> or <code>DATABASE_URL</code> for Postgres; falls back to SQLite for local dev.</div>
  </div>

  <div class="card p-3 mt-3">
    <h6>Domain Event Dispatcher</h6>
    <p class="small text-muted mb-2">
      The app writes every significant action into the <code>domain_event</code> outbox table. To push those events to downstream integrations, run the dispatcher alongside your web workers.
    </p>
    <ol class="small mb-2">
      <li>Provision any HTTP endpoint that should receive events (or leave the webhook unset to mark events processed without delivery).</li>
      <li>Set <code>DOMAIN_EVENT_WEBHOOK_URL=https://your-endpoint</code> (optional if you only want local logging).</li>
      <li>Run the worker: <code>flask dispatch-domain-events</code> (use <code>--once</code> for ad-hoc batches, or keep it running as a background process/sidecar).</li>
      <li>Monitor logs for retries; events exceeding the retry limit are marked with <code>_dispatch_errors</code> in the payload.</li>
    </ol>
  </div>


    <div class="alert alert-secondary">
      For detailed requirements and status, see <a href="{{ url_for('developer.dashboard') }}">Developer Dashboard</a> and <a href="/docs/todo/CRITICAL_PRELAUNCH.md" target="_blank">CRITICAL_PRELAUNCH.md</a>.
  </div>

</div>

<script>
async function loadStripeEvents() {
  try {
    const resp = await fetch('{{ url_for('developer.integrations_stripe_events') }}');
    const data = await resp.json();
    document.getElementById('stripeEvents').textContent = JSON.stringify(data, null, 2);
  } catch (e) {
    document.getElementById('stripeEvents').textContent = 'Error loading events';
  }
}

async function saveFlags() {
  // Get all feature flag checkboxes
  const flags = {};

  // Core business features
  flags.FEATURE_FIFO_TRACKING = document.getElementById('ff_fifo_tracking').checked;
  flags.FEATURE_BARCODE_SCANNING = document.getElementById('ff_barcode_scanning').checked;
  flags.FEATURE_PRODUCT_VARIANTS = document.getElementById('ff_product_variants').checked;
  flags.FEATURE_AUTO_SKU_GENERATION = document.getElementById('ff_auto_sku_generation').checked;
  flags.FEATURE_RECIPE_VARIATIONS = document.getElementById('ff_recipe_variations').checked;
  flags.FEATURE_COST_TRACKING = document.getElementById('ff_cost_tracking').checked;
  flags.FEATURE_EXPIRATION_TRACKING = document.getElementById('ff_expiration_tracking').checked;
  flags.FEATURE_BULK_OPERATIONS = document.getElementById('ff_bulk_operations').checked;

  // Developer & advanced features
  flags.FEATURE_INVENTORY_ANALYTICS = document.getElementById('ff_analytics').checked;
  flags.FEATURE_DEBUG_MODE = document.getElementById('ff_debug_mode').checked;
  flags.FEATURE_AUTO_BACKUP = document.getElementById('ff_auto_backup').checked;
  flags.FEATURE_CSV_EXPORT = document.getElementById('ff_csv_export').checked;
  flags.FEATURE_ADVANCED_REPORTS = document.getElementById('ff_advanced_reports').checked;
  flags.FEATURE_GLOBAL_ITEM_LIBRARY = document.getElementById('ff_global_item_library').checked;

  // Notification systems
  flags.FEATURE_EMAIL_NOTIFICATIONS = document.getElementById('ff_email_notifications').checked;
  flags.FEATURE_BROWSER_NOTIFICATIONS = document.getElementById('ff_browser_notifications').checked;

  // Integration features
  flags.FEATURE_SHOPIFY_INTEGRATION = document.getElementById('ff_shopify_integration').checked;
  flags.FEATURE_API_ACCESS = document.getElementById('ff_api_access').checked;
  flags.FEATURE_OAUTH_PROVIDERS = document.getElementById('ff_oauth_providers').checked;

  // AI features
  flags.FEATURE_AI_RECIPE_OPTIMIZATION = document.getElementById('ff_ai_recipe_optimization').checked;
  flags.FEATURE_AI_DEMAND_FORECASTING = document.getElementById('ff_ai_demand_forecasting').checked;
  flags.FEATURE_AI_QUALITY_INSIGHTS = document.getElementById('ff_ai_quality_insights').checked;

  // Public tools
  flags.TOOLS_SOAP = document.getElementById('tools_soap').checked;
  flags.TOOLS_CANDLES = document.getElementById('tools_candles').checked;
  flags.TOOLS_LOTIONS = document.getElementById('tools_lotions').checked;
  flags.TOOLS_HERBAL = document.getElementById('tools_herbal').checked;
  flags.TOOLS_BAKING = document.getElementById('tools_baking').checked;

  const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
  const resp = await fetch('{{ url_for('developer.integrations_set_feature_flags') }}', {
    method: 'POST', 
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify(flags)
  });

  if (resp.ok) {
    // Show success feedback
    const result = await resp.json();
    console.log('Feature flags updated successfully');
    
    // Show visual confirmation
    const statusDiv = document.getElementById('flagSaveStatus');
    statusDiv.className = 'alert alert-success';
    statusDiv.style.display = 'block';
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  } else {
    console.error('Failed to update feature flags');
    
    // Show error feedback
    const statusDiv = document.getElementById('flagSaveStatus');
    statusDiv.className = 'alert alert-danger';
    statusDiv.innerHTML = '‚ùå Failed to update feature flags';
    statusDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 5000);
  }
}

async function checkWebhook() {
  try {
    const resp = await fetch('{{ url_for('developer.integrations_check_webhook') }}');
    const data = await resp.json();
    document.getElementById('webhookCheck').textContent = JSON.stringify(data, null, 2);
  } catch (e) {
    document.getElementById('webhookCheck').textContent = 'Error checking webhook';
  }
}
</script>
{% endblock %}