{% extends 'layout.html' %}

{% block title %}Edit Subscription Tier - Developer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-edit text-primary"></i> Edit Subscription Tier: {{ tier.name }}
                    </h3>
                    <p class="text-muted mb-0">Tier Key: <strong>{{ tier_key }}</strong></p>
                </div>
            </div>
        </div>
    </div>

    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="row mt-4">
            <!-- Basic Information -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="tier_name" class="form-label">Display Name *</label>
                            <input type="text" class="form-control" id="tier_name" name="tier_name" 
                                   value="{{ tier.name }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="user_limit" class="form-label">User Limit</label>
                            <input type="number" class="form-control" id="user_limit" name="user_limit" 
                                   value="{{ tier.user_limit }}" min="-1"
                                   placeholder="Use -1 for unlimited users">
                            <small class="form-text text-muted">
                                {% if tier_key == 'exempt' %}
                                    Use -1 for unlimited users (exempt tier only)
                                {% else %}
                                    Enter maximum number of users for this tier (use -1 for unlimited)
                                {% endif %}
                            </small>
                        </div>

                        <!-- Visibility Controls -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_customer_facing" name="is_customer_facing"
                                       {% if tier.get('is_customer_facing', True) %}checked{% endif %}>
                                <label class="form-check-label" for="is_customer_facing">
                                    Customer Facing (visible to customers)
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_available" name="is_available"
                                       {% if tier.get('is_available', True) %}checked{% endif %}>
                                <label class="form-check-label" for="is_available">
                                    Available (tier is active)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stripe Configuration -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Stripe Integration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stripe_lookup_key" class="form-label">Stripe Lookup Key</label>
                            <input type="text" class="form-control" id="stripe_lookup_key" name="stripe_lookup_key"
                                   value="{{ tier.stripe_lookup_key or '' }}" 
                                   placeholder="e.g., solo-plan, team-plan">
                            <small class="form-text text-muted">
                                This should match the lookup key in your Stripe product configuration.
                                <br>Used to sync pricing and features from Stripe.
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Stripe Configuration</h6>
                            <p class="mb-2">Configure your Stripe secrets in the <a href="/secrets" target="_blank">Secrets tab</a>:</p>
                            <ul class="mb-0">
                                <li><code>STRIPE_SECRET_KEY</code> - Your Stripe secret key</li>
                                <li><code>STRIPE_PUBLISHABLE_KEY</code> - Your Stripe publishable key</li>
                            </ul>
                        </div>

                        <div class="mt-3">
                            <h6>Current Stripe Data:</h6>
                            <p><strong>Monthly Price:</strong> {{ tier.stripe_price_monthly or 'Not synced' }}</p>
                            <p><strong>Yearly Price:</strong> {{ tier.stripe_price_yearly or 'Not synced' }}</p>
                            <p><strong>Last Synced:</strong> {{ tier.last_synced or 'Never' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permissions and Features Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Permissions and Features</h5>
                    </div>
                    <div class="card-body">
                        <!-- Tier Permissions -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-key text-primary"></i> Tier Permissions
                            </label>
                            <div class="form-text mb-3">
                                Select all permissions that should be included in this subscription tier. 
                                Users with this tier will have access to these specific features and actions.
                            </div>

                            <!-- Permission Categories -->
                            <div class="permissions-container">
                                {% set permission_categories = {} %}
                                {% for permission in permissions %}
                                    {% set category = permission.category or 'general' %}
                                    {% if category not in permission_categories %}
                                        {% set _ = permission_categories.update({category: []}) %}
                                    {% endif %}
                                    {% set _ = permission_categories[category].append(permission) %}
                                {% endfor %}

                                <div class="row">
                                    {% for category, perms in permission_categories.items() %}
                                    <div class="col-lg-4 col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-header py-2">
                                                <h6 class="mb-0 text-capitalize">
                                                    <i class="fas fa-folder-open text-secondary me-1"></i>
                                                    {{ category.replace('_', ' ').title() }} 
                                                    <small class="text-muted">({{ perms|length }})</small>
                                                </h6>
                                            </div>
                                            <div class="card-body py-2" style="max-height: 300px; overflow-y: auto;">
                                                {% for permission in perms %}
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" name="permissions" 
                                                           value="{{ permission.name }}" id="perm_{{ permission.id }}"
                                                           {% if permission.name in tier.get('permissions', []) %}checked{% endif %}>
                                                    <label class="form-check-label small" for="perm_{{ permission.id }}">
                                                        <strong>{{ permission.name }}</strong>
                                                        {% if permission.description %}
                                                        <br><small class="text-muted">{{ permission.description }}</small>
                                                        {% endif %}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Feature Groups -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-layer-group text-success"></i> Feature Groups
                            </label>
                            <div class="form-text mb-2">Select high-level feature groups for organizational purposes.</div>
                            {% set available_feature_groups = [
                                'basic_dashboard',
                                'full_dashboard', 
                                'limited_inventory',
                                'full_inventory',
                                'batch_production',
                                'recipe_management',
                                'product_catalog',
                                'team_management',
                                'basic_reports',
                                'advanced_reports',
                                'api_access',
                                'integrations',
                                'system_admin'
                            ] %}
                            <div class="row">
                                {% for feature_group in available_feature_groups %}
                                <div class="col-md-4 col-lg-3 mb-1">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="feature_groups" 
                                               value="{{ feature_group }}" id="fg_{{ loop.index }}"
                                               {% if feature_group in tier.get('feature_groups', []) %}checked{% endif %}>
                                        <label class="form-check-label small" for="fg_{{ loop.index }}">
                                            {{ feature_group.replace('_', ' ').title() }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Stripe Features -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-credit-card text-info"></i> Stripe Features
                            </label>
                            {% if tier.stripe_features %}
                                <ul class="list-group">
                                    {% for feature in tier.stripe_features %}
                                        <li class="list-group-item py-1 small">{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                                <small class="form-text text-muted">These features are synced from Stripe product configuration.</small>
                            {% else %}
                                <p class="text-muted">No features synced from Stripe. Check your Stripe product configuration.</p>
                            {% endif %}
                        </div>

                        <!-- Fallback Features -->
                        <div class="mb-3">
                            <label for="fallback_features" class="form-label">
                                <i class="fas fa-list text-warning"></i> Fallback Features (Local Override)
                            </label>
                            <textarea class="form-control" id="fallback_features" name="fallback_features" rows="4">{{ tier.fallback_features | join('\n') if tier.fallback_features else '' }}</textarea>
                            <small class="form-text text-muted">Used only if Stripe sync fails. One feature per line.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-end">
                        <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary me-2">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Tier
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

<script>
function selectAllPermissions() {
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
}

function deselectAllPermissions() {
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
}

function toggleCategoryPermissions(categoryName) {
    const categoryCheckboxes = document.querySelectorAll(`.permission-checkbox[data-category="${categoryName}"]`);
    const allChecked = Array.from(categoryCheckboxes).every(checkbox => checkbox.checked);

    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
}

function updatePricing() {
    // Placeholder for pricing update functionality
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// Feature group to permissions mapping
</script>