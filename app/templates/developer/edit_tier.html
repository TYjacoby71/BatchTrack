
{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Edit Subscription Tier: {{ tier.name }}</h2>
                <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Tiers
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Tier Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ tier.name }}" required>
                                    <div class="form-text">This is both the display name and identifier</div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3">{{ tier.description or '' }}</textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="user_limit" class="form-label">User Limit</label>
                                    <input type="number" class="form-control" id="user_limit" name="user_limit" 
                                           value="{{ tier.user_limit }}" min="-1" step="1" required>
                                    <div class="form-text">Set to -1 for unlimited users</div>
                                </div>

                                <div class="mb-3">
                                    <label for="tier_type" class="form-label">Tier Type</label>
                                    <select class="form-select" id="tier_type" name="tier_type">
                                        <option value="monthly" {{ 'selected' if tier.tier_type == 'monthly' else '' }}>Monthly</option>
                                        <option value="yearly" {{ 'selected' if tier.tier_type == 'yearly' else '' }}>Yearly</option>
                                        <option value="promotion" {{ 'selected' if tier.tier_type == 'promotion' else '' }}>Promotion</option>
                                    </select>
                                    <div class="form-text">Used for organizing and sorting tiers</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_recipes" class="form-label">Max Recipes</label>
                                            <input type="number" class="form-control" id="max_recipes" name="max_recipes" value="{{ tier.max_recipes or '' }}" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_batches" class="form-label">Max Batches</label>
                                            <input type="number" class="form-control" id="max_batches" name="max_batches" value="{{ tier.max_batches or '' }}" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_products" class="form-label">Max Products</label>
                                            <input type="number" class="form-control" id="max_products" name="max_products" value="{{ tier.max_products or '' }}" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_batchbot_requests" class="form-label">Max BatchBot Requests</label>
                                            <input type="number" class="form-control" id="max_batchbot_requests" name="max_batchbot_requests" value="{{ tier.max_batchbot_requests or '' }}" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_monthly_batches" class="form-label">Max Monthly Batches</label>
                                            <input type="number" class="form-control" id="max_monthly_batches" name="max_monthly_batches" value="{{ tier.max_monthly_batches or '' }}" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Visibility</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_customer_facing" 
                                               name="is_customer_facing" {{ 'checked' if tier.is_customer_facing else '' }}>
                                        <label class="form-check-label" for="is_customer_facing">
                                            Show to customers
                                        </label>
                                        <div class="form-text">Unchecked tiers are hidden from public view</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="billing_provider" class="form-label">Billing Provider</label>
                                    <select class="form-select" id="billing_provider" name="billing_provider" onchange="toggleBillingFields()">
                                        <option value="exempt" {{ 'selected' if tier.billing_provider == 'exempt' else '' }}>Exempt (No Billing)</option>
                                        <option value="stripe" {{ 'selected' if tier.billing_provider == 'stripe' else '' }}>Stripe</option>
                                        <option value="whop" {{ 'selected' if tier.billing_provider == 'whop' else '' }}>Whop</option>
                                    </select>
                                    <div class="form-text">Use Stripe for discounts and promotions</div>
                                </div>

                                <div id="stripe_fields" class="mb-3" style="display: none;">
                                    <label for="stripe_lookup_key" class="form-label">Stripe Lookup Key</label>
                                    <input type="text" class="form-control" id="stripe_lookup_key" name="stripe_lookup_key" 
                                           value="{{ tier.stripe_lookup_key or '' }}" placeholder="batchtrack_team_monthly">
                                </div>

                                <div id="whop_fields" class="mb-3" style="display: none;">
                                    <label for="whop_product_key" class="form-label">Whop Product Key</label>
                                    <input type="text" class="form-control" id="whop_product_key" name="whop_product_key" 
                                           value="{{ tier.whop_product_key or '' }}" placeholder="whop_product_123">
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="retention_policy" class="form-label">Data Retention</label>
                                    <select class="form-select" id="retention_policy" name="retention_policy" onchange="toggleRetentionFields()">
                                        <option value="one_year" {{ 'selected' if tier.retention_policy == 'one_year' else '' }}>1 year</option>
                                        <option value="subscribed" {{ 'selected' if tier.retention_policy == 'subscribed' else '' }}>Subscribed</option>
                                    </select>
                                    <div class="form-text">All-or-nothing policy: 1 year or unlimited while subscribed.</div>
                                </div>
                                <div class="mb-3" id="retention_days_field" style="display:none;">
                                    <label for="data_retention_days" class="form-label">Data Retention (days)</label>
                                    <input type="number" class="form-control" id="data_retention_days" name="data_retention_days" value="{{ tier.data_retention_days or '' }}" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="retention_notice_days" class="form-label">Notice Period (days)</label>
                                    <input type="number" class="form-control" id="retention_notice_days" name="retention_notice_days" value="{{ tier.retention_notice_days or '' }}" min="0">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="row">
                                {% for permission in all_permissions %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" 
                                               id="perm_{{ permission.id }}" name="permissions" value="{{ permission.id }}"
                                               {{ 'checked' if permission in tier.permissions else '' }}>
                                        <label class="form-check-label" for="perm_{{ permission.id }}">
                                            {{ permission.display_name or permission.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Allowed Add-ons (Purchasable via Stripe)</label>
                            <div class="row">
                                {% for addon in all_addons %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               id="allowed_addon_{{ addon.id }}" name="allowed_addons" value="{{ addon.id }}"
                                               {{ 'checked' if addon in tier.allowed_addons else '' }}>
                                        <label class="form-check-label" for="allowed_addon_{{ addon.id }}">
                                            {{ addon.name }}{% if addon.permission_name %} (perm: {{ addon.permission_name }}){% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Customers on this tier can purchase these add-ons.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Included Add-ons (Stripe-bypassed)</label>
                            <div class="row">
                                {% for addon in all_addons %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               id="included_addon_{{ addon.id }}" name="included_addons" value="{{ addon.id }}"
                                               {{ 'checked' if addon in tier.included_addons else '' }}>
                                        <label class="form-check-label" for="included_addon_{{ addon.id }}">
                                            {{ addon.name }} (included)
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">These add-ons are granted on this tier without purchase.</div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Update Tier</button>
                            <a href="{{ url_for('developer.subscription_tiers.manage_tiers') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleBillingFields() {
    const provider = document.getElementById('billing_provider').value;
    
    const stripeFields = document.getElementById('stripe_fields');
    const whopFields = document.getElementById('whop_fields');
    
    // Hide all fields by default
    stripeFields.style.display = 'none';
    whopFields.style.display = 'none';
    
    // Show relevant fields based on provider
    if (provider === 'stripe') {
        stripeFields.style.display = 'block';
    } else if (provider === 'whop') {
        whopFields.style.display = 'block';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', toggleBillingFields);

function toggleRetentionFields() {
    const policy = document.getElementById('retention_policy').value;
    const daysField = document.getElementById('retention_days_field');
    // Show legacy days field only when not strictly one_year/subscribed
    if (policy === 'one_year') {
        daysField.style.display = 'none';
        document.getElementById('data_retention_days').value = 365;
    } else if (policy === 'subscribed') {
        daysField.style.display = 'none';
        document.getElementById('data_retention_days').value = '';
    } else {
        daysField.style.display = 'block';
    }
}
document.addEventListener('DOMContentLoaded', toggleRetentionFields);
</script>
{% endblock %}
