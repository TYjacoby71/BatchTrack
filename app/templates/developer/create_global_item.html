{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('developer.dashboard') }}">Developer</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('developer.global_items_admin') }}">Global Items</a></li>
        <li class="breadcrumb-item active" aria-current="page">Create or Edit Global Item</li>
      </ol>
    </nav>
    <h2 class="mt-2">Create Global Item</h2>
    <p class="text-muted mb-0">Global ingredients now require a two-layer definition: the ingredient itself plus one or more physical-form items. This wizard guides you through that process.</p>
  </div>
  <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Back to Global Items
  </a>
</div>

<div class="card">
  <div class="card-body">
    <div class="mb-4">
      <label class="form-label">Item Type</label>
      <select id="globalItemTypeSelect" class="form-select">
        <option value="ingredient" selected>Ingredient</option>
        <option value="container">Container</option>
        <option value="packaging">Packaging</option>
        <option value="consumable">Consumable</option>
      </select>
      <small class="text-muted">Only developer accounts can add or modify global items. Select “Ingredient” to use the layered workflow below.</small>
    </div>

    <form method="post" id="ingredientItemForm" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="form_variant" value="ingredient">
      <input type="hidden" name="item_type" value="ingredient">
      {% if existing_item %}
      <input type="hidden" name="existing_global_item_id" value="{{ existing_item.id }}">
      {% endif %}

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Step 1 — Ingredient Definition</h5>
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="ingredient_mode" id="ingredientModeExisting" value="existing" {% if selected_ingredient %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="ingredientModeExisting">
              Use existing ingredient definition
            </label>
          </div>
          <div class="ingredient-existing-fields ms-4 mt-3">
            <div class="row g-2 align-items-center">
              <div class="col-lg-7">
                <select name="existing_ingredient_id" id="existingIngredientSelect" class="form-select">
                  <option value="">Select Ingredient</option>
                  {% for ingredient in ingredient_definitions %}
                    <option value="{{ ingredient.id }}" {% if selected_ingredient and ingredient.id == selected_ingredient.id %}selected{% endif %}>
                      {{ ingredient.name }}{% if ingredient.slug %} ({{ ingredient.slug }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-lg-5 small text-muted">
                {% if selected_ingredient %}
                  <div><strong>INCI:</strong> {{ selected_ingredient.inci_name or '—' }}</div>
                  <div><strong>CAS:</strong> {{ selected_ingredient.cas_number or '—' }}</div>
                  <div><strong>Category:</strong> {{ selected_ingredient.category.name if selected_ingredient.category else '—' }}</div>
                {% else %}
                  Select an ingredient to review its metadata and existing physical forms.
                {% endif %}
              </div>
            </div>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="radio" name="ingredient_mode" id="ingredientModeNew" value="new" {% if not selected_ingredient %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="ingredientModeNew">
              Define a new ingredient
            </label>
          </div>
          <div class="ingredient-new-fields ms-4 mt-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Ingredient Name *</label>
                <input type="text" name="new_ingredient_name" class="form-control" placeholder="e.g. Lavender" value="">
              </div>
              <div class="col-md-6">
                <label class="form-label">Slug (optional)</label>
                <input type="text" name="new_ingredient_slug" class="form-control" placeholder="e.g. lavender">
                <small class="text-muted">Leave blank to auto-generate from the name.</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">INCI Name</label>
                <input type="text" name="new_ingredient_inci" class="form-control" placeholder="e.g. Calendula Officinalis Flower">
              </div>
              <div class="col-md-6">
                <label class="form-label">CAS Number</label>
                <input type="text" name="new_ingredient_cas" class="form-control" placeholder="e.g. 8008-79-5">
              </div>
              <div class="col-12">
                <label class="form-label">Ingredient Description</label>
                <textarea name="new_ingredient_description" rows="2" class="form-control" placeholder="Short description or sourcing notes"></textarea>
              </div>
            </div>
          </div>

          <div class="row g-3 align-items-end mt-4">
            <div class="col-md-6">
              <label class="form-label">Ingredient Category {% if selected_ingredient %}(updating applies to the base definition){% endif %}</label>
              <select name="ingredient_category_id" id="ingredientCategorySelect" class="form-select">
                <option value="">Select Category</option>
                {% for category in global_ingredient_categories %}
                  <option value="{{ category.id }}"
                    {% if selected_ingredient and selected_ingredient.ingredient_category_id == category.id %}selected{% endif %}>
                    {{ category.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <a href="{{ url_for('developer.reference_categories') }}" class="btn btn-outline-secondary mt-3 mt-md-0">
                <i class="fas fa-tags me-1"></i> Manage Reference Categories
              </a>
            </div>
          </div>
        </div>
      </div>

      {% if selected_ingredient and existing_items %}
      <div class="alert alert-info small shadow-sm mb-4">
        <div class="fw-semibold">Existing forms for {{ selected_ingredient.name }}:</div>
        <ul class="mb-0 ps-3">
          {% for item in existing_items %}
            <li>
              {{ item.physical_form.name if item.physical_form else 'Unknown form' }}
              — <a href="{{ url_for('developer.create_global_item', ingredient_id=selected_ingredient.id, physical_form_id=item.physical_form_id) }}" class="link-dark text-decoration-underline">Edit</a>
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Step 2 — Physical Form</h5>
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="physical_form_mode" id="physicalFormExisting" value="existing" {% if selected_physical_form %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="physicalFormExisting">
              Link to existing physical form
            </label>
          </div>
          <div class="physical-form-existing-fields ms-4 mt-3">
            <div class="row g-2 align-items-center">
              <div class="col-lg-7">
                <select name="existing_physical_form_id" id="existingPhysicalFormSelect" class="form-select">
                  <option value="">Select Physical Form</option>
                  {% for form in physical_forms %}
                    <option value="{{ form.id }}" {% if selected_physical_form and form.id == selected_physical_form.id %}selected{% endif %}>
                      {{ form.name }}{% if form.slug %} ({{ form.slug }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-lg-5 small text-muted">
                Select a form to load an existing item or to start a new variant under that form.
              </div>
            </div>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="radio" name="physical_form_mode" id="physicalFormNew" value="new" {% if not selected_physical_form %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="physicalFormNew">
              Define a new physical form
            </label>
          </div>
          <div class="physical-form-new-fields ms-4 mt-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Physical Form Name *</label>
                <input type="text" name="new_physical_form_name" class="form-control" placeholder="e.g. Whole Bud" value="">
              </div>
              <div class="col-md-6">
                <label class="form-label">Slug (optional)</label>
                <input type="text" name="new_physical_form_slug" class="form-control" placeholder="e.g. whole-bud">
                <small class="text-muted">Used in API responses; leave blank to auto-generate.</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Step 3 — Ingredient Item Details</h5>
          {% if existing_item %}
            <span class="badge bg-warning text-dark">Editing existing item</span>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Item Name *</label>
              <input type="text" name="item_name" class="form-control" placeholder="e.g. Lavender Buds" value="{{ existing_item.name if existing_item else '' }}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Default Unit</label>
              <select name="item_default_unit" class="form-select">
                <option value="">Select Unit</option>
                {% for unit in get_global_unit_list() %}
                  <option value="{{ unit.name }}" {% if existing_item and existing_item.default_unit == unit.name %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Density (g/ml)</label>
              <input type="number" step="0.001" name="item_density" class="form-control" placeholder="e.g. 0.920" value="{{ '%.3f'|format(existing_item.density) if existing_item and existing_item.density is not none else '' }}">
            </div>
            <div class="col-md-3">
              <div class="form-check mt-4">
                <input type="checkbox" class="form-check-input" id="itemDefaultPerishable" name="item_default_is_perishable" {% if existing_item and existing_item.default_is_perishable %}checked{% endif %}>
                <label for="itemDefaultPerishable" class="form-check-label">Perishable by default</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check mt-4">
                <input type="checkbox" class="form-check-input" id="itemIsActive" name="item_is_active_ingredient" {% if existing_item and existing_item.is_active_ingredient %}checked{% endif %}>
                <label for="itemIsActive" class="form-check-label">Active ingredient</label>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Recommended Shelf Life (days)</label>
              <input type="number" name="item_recommended_shelf_life_days" class="form-control" placeholder="e.g. 365" value="{{ existing_item.recommended_shelf_life_days if existing_item and existing_item.recommended_shelf_life_days is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Recommended Usage Rate</label>
              <input type="text" name="item_recommended_usage_rate" class="form-control" placeholder="e.g. 0.5% - 2%" value="{{ existing_item.recommended_usage_rate if existing_item else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fragrance Load %</label>
              <input type="text" name="item_recommended_fragrance_load_pct" class="form-control" placeholder="e.g. 6% - 10%" value="{{ existing_item.recommended_fragrance_load_pct if existing_item else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">INCI Name Override</label>
              <input type="text" name="item_inci_name" class="form-control" placeholder="Inherit from ingredient unless specified" value="{{ existing_item.inci_name if existing_item else '' }}">
              <small class="text-muted">Leave blank to inherit {{ selected_ingredient.inci_name if selected_ingredient else 'the ingredient-level value' }}.</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">Aliases (comma-separated)</label>
              <input type="text" name="item_aliases" class="form-control" placeholder="Alternative names" value="{% if existing_item and existing_item.aliases %}{{ existing_item.aliases | join(', ') }}{% endif %}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Certifications (comma-separated)</label>
              <input type="text" name="item_certifications" class="form-control" placeholder="e.g. Organic, Fair Trade" value="{% if existing_item and existing_item.certifications %}{{ existing_item.certifications | join(', ') }}{% endif %}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Function Tags</label>
              <input type="text" name="item_function_tags" class="form-control" placeholder="e.g. Humectant, Emulsifier" value="{% if existing_item and existing_item.functions %}{{ existing_item.functions | map(attribute='name') | join(', ') }}{% endif %}">
              <small class="text-muted">Comma-separated functions for ingredient behavior.</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">Application Tags</label>
              <input type="text" name="item_application_tags" class="form-control" placeholder="e.g. Cold Process Soap, Lotion" value="{% if existing_item and existing_item.applications %}{{ existing_item.applications | map(attribute='name') | join(', ') }}{% endif %}">
              <small class="text-muted">Comma-separated uses or product types.</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">Category Tags</label>
              <input type="text" name="item_category_tags" class="form-control" placeholder="Override default category tags" value="{% if existing_item and existing_item.category_tags %}{{ existing_item.category_tags | map(attribute='name') | join(', ') }}{% endif %}">
              <small class="text-muted">Defaults to reference category when left blank.</small>
            </div>
          </div>

          <hr>

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Saponification Value</label>
              <input type="number" step="0.1" name="item_saponification_value" class="form-control" value="{{ existing_item.saponification_value if existing_item and existing_item.saponification_value is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Iodine Value</label>
              <input type="number" step="0.1" name="item_iodine_value" class="form-control" value="{{ existing_item.iodine_value if existing_item and existing_item.iodine_value is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Melting Point (°C)</label>
              <input type="number" step="0.1" name="item_melting_point_c" class="form-control" value="{{ existing_item.melting_point_c if existing_item and existing_item.melting_point_c is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Flash Point (°C)</label>
              <input type="number" step="0.1" name="item_flash_point_c" class="form-control" value="{{ existing_item.flash_point_c if existing_item and existing_item.flash_point_c is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">pH Value</label>
              <input type="text" name="item_ph_value" class="form-control" placeholder="e.g. 6.5-7.0" value="{{ existing_item.ph_value if existing_item else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Moisture Content (%)</label>
              <input type="number" step="0.1" name="item_moisture_content_percent" class="form-control" value="{{ existing_item.moisture_content_percent if existing_item and existing_item.moisture_content_percent is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Comedogenic Rating</label>
              <select name="item_comedogenic_rating" class="form-select">
                <option value="">Select Rating</option>
                {% for rating in range(6) %}
                <option value="{{ rating }}" {% if existing_item and existing_item.comedogenic_rating is not none and existing_item.comedogenic_rating == rating %}selected{% endif %}>
                  {{ rating }} - {% if rating == 0 %}Non-comedogenic{% elif rating == 1 %}Very low{% elif rating == 2 %}Low{% elif rating == 3 %}Moderate{% elif rating == 4 %}High{% else %}Very high{% endif %}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Protein Content (%)</label>
              <input type="number" step="0.01" name="item_protein_content_pct" class="form-control" value="{{ existing_item.protein_content_pct if existing_item and existing_item.protein_content_pct is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Brewing Color (SRM)</label>
              <input type="number" step="0.1" name="item_brewing_color_srm" class="form-control" value="{{ existing_item.brewing_color_srm if existing_item and existing_item.brewing_color_srm is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Brewing Potential (SG)</label>
              <input type="number" step="0.001" name="item_brewing_potential_sg" class="form-control" value="{{ existing_item.brewing_potential_sg if existing_item and existing_item.brewing_potential_sg is not none else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Diastatic Power (Lintner)</label>
              <input type="number" step="0.1" name="item_brewing_diastatic_power_lintner" class="form-control" value="{{ existing_item.brewing_diastatic_power_lintner if existing_item and existing_item.brewing_diastatic_power_lintner is not none else '' }}">
            </div>
            <div class="col-12">
              <label class="form-label">Fatty Acid Profile (JSON)</label>
              <textarea name="item_fatty_acid_profile" rows="3" class="form-control" placeholder='{"oleic": 40, "linoleic": 8}'>{% if existing_item and existing_item.fatty_acid_profile %}{{ existing_item.fatty_acid_profile | tojson }}{% endif %}</textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> {% if existing_item %}Save Changes{% else %}Save Item{% endif %}
        </button>
      </div>
    </form>

    <form method="post" id="genericGlobalItemForm" novalidate style="display:none;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="form_variant" value="generic">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Global Item Details</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name *</label>
              <input type="text" name="name" class="form-control" placeholder="Enter item name" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Item Type *</label>
              <select name="item_type" id="genericItemTypeSelect" class="form-select" required>
                <option value="container">Container</option>
                <option value="packaging">Packaging</option>
                <option value="consumable">Consumable</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Reference Category (optional)</label>
              <select name="ingredient_category_id" class="form-select">
                <option value="">Unassigned</option>
                {% for category in global_ingredient_categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Default Unit</label>
              <select name="default_unit" class="form-select">
                <option value="">Select Unit</option>
                {% for unit in get_global_unit_list() %}
                  <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Density (g/ml)</label>
              <input type="number" step="0.001" name="density" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Capacity</label>
              <input type="number" step="0.01" name="capacity" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Capacity Unit</label>
              <input type="text" name="capacity_unit" class="form-control" placeholder="e.g. ml, oz">
            </div>
            <div class="col-md-3">
              <div class="form-check mt-4">
                <input type="checkbox" class="form-check-input" id="genericPerishable" name="default_is_perishable">
                <label for="genericPerishable" class="form-check-label">Perishable by default</label>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Recommended Shelf Life (days)</label>
              <input type="number" name="recommended_shelf_life_days" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Recommended Usage Rate</label>
              <input type="text" name="recommended_usage_rate" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fragrance Load %</label>
              <input type="text" name="recommended_fragrance_load_pct" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">INCI Name</label>
              <input type="text" name="inci_name" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Protein Content (%)</label>
              <input type="number" step="0.01" name="protein_content_pct" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Brewing Color (SRM)</label>
              <input type="number" step="0.1" name="brewing_color_srm" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Brewing Potential (SG)</label>
              <input type="number" step="0.001" name="brewing_potential_sg" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Diastatic Power (Lintner)</label>
              <input type="number" step="0.1" name="brewing_diastatic_power_lintner" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Aliases (comma-separated)</label>
              <input type="text" name="aliases" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Certifications (comma-separated)</label>
              <input type="text" name="certifications" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Fatty Acid Profile (JSON)</label>
              <textarea name="fatty_acid_profile" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Container Material</label>
              <input type="text" name="container_material" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Container Type</label>
              <input type="text" name="container_type" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Container Style</label>
              <input type="text" name="container_style" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Container Color</label>
              <input type="text" name="container_color" class="form-control">
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Save Item
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const typeSelect = document.getElementById('globalItemTypeSelect');
  const ingredientForm = document.getElementById('ingredientItemForm');
  const genericForm = document.getElementById('genericGlobalItemForm');
  const genericTypeSelect = document.getElementById('genericItemTypeSelect');

  function syncForms() {
    const selected = typeSelect ? typeSelect.value : 'ingredient';
    if (selected === 'ingredient') {
      ingredientForm.style.display = '';
      if (genericForm) genericForm.style.display = 'none';
    } else {
      ingredientForm.style.display = 'none';
      if (genericForm) {
        genericForm.style.display = '';
        if (genericTypeSelect) genericTypeSelect.value = selected;
      }
    }
  }
  if (typeSelect) {
    syncForms();
    typeSelect.addEventListener('change', syncForms);
  }

  const ingredientModeRadios = document.querySelectorAll('input[name="ingredient_mode"]');
  const ingredientExistingSection = document.querySelector('.ingredient-existing-fields');
  const ingredientNewSection = document.querySelector('.ingredient-new-fields');

  function toggleIngredientMode() {
    const mode = document.querySelector('input[name="ingredient_mode"]:checked')?.value || 'existing';
    if (mode === 'existing') {
      ingredientExistingSection.classList.remove('d-none');
      ingredientExistingSection.querySelectorAll('select, input').forEach(el => el.disabled = false);
      ingredientNewSection.classList.add('d-none');
      ingredientNewSection.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
    } else {
      ingredientExistingSection.classList.add('d-none');
      ingredientExistingSection.querySelectorAll('select, input').forEach(el => el.disabled = true);
      ingredientNewSection.classList.remove('d-none');
      ingredientNewSection.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
    }
  }
  toggleIngredientMode();
  ingredientModeRadios.forEach(radio => radio.addEventListener('change', toggleIngredientMode));

  const physicalModeRadios = document.querySelectorAll('input[name="physical_form_mode"]');
  const physicalExistingSection = document.querySelector('.physical-form-existing-fields');
  const physicalNewSection = document.querySelector('.physical-form-new-fields');

  function togglePhysicalMode() {
    const mode = document.querySelector('input[name="physical_form_mode"]:checked')?.value || 'existing';
    if (mode === 'existing') {
      physicalExistingSection.classList.remove('d-none');
      physicalExistingSection.querySelectorAll('select, input').forEach(el => el.disabled = false);
      physicalNewSection.classList.add('d-none');
      physicalNewSection.querySelectorAll('input').forEach(el => el.disabled = true);
    } else {
      physicalExistingSection.classList.add('d-none');
      physicalExistingSection.querySelectorAll('select, input').forEach(el => el.disabled = true);
      physicalNewSection.classList.remove('d-none');
      physicalNewSection.querySelectorAll('input').forEach(el => el.disabled = false);
    }
  }
  togglePhysicalMode();
  physicalModeRadios.forEach(radio => radio.addEventListener('change', togglePhysicalMode));

  const existingIngredientSelect = document.getElementById('existingIngredientSelect');
  if (existingIngredientSelect) {
    existingIngredientSelect.addEventListener('change', () => {
      const value = existingIngredientSelect.value;
      const url = new URL(window.location.href);
      if (value) {
        url.searchParams.set('ingredient_id', value);
        url.searchParams.delete('physical_form_id');
      } else {
        url.searchParams.delete('ingredient_id');
        url.searchParams.delete('physical_form_id');
      }
      window.location.href = url.toString();
    });
  }

  const existingPhysicalFormSelect = document.getElementById('existingPhysicalFormSelect');
  if (existingPhysicalFormSelect) {
    existingPhysicalFormSelect.addEventListener('change', () => {
      const ingredientId = existingIngredientSelect ? existingIngredientSelect.value : '';
      const formId = existingPhysicalFormSelect.value;
      if (ingredientId && formId) {
        const url = new URL(window.location.href);
        url.searchParams.set('ingredient_id', ingredientId);
        url.searchParams.set('physical_form_id', formId);
        window.location.href = url.toString();
      }
    });
  }
})();
</script>
{% endblock %}
