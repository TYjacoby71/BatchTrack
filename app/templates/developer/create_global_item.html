
{% extends 'layout.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('developer.dashboard') }}">Developer</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('developer.global_items_admin') }}">Global Items</a></li>
        <li class="breadcrumb-item active" aria-current="page">Create New Item</li>
      </ol>
    </nav>
    <h2 class="mt-2">Create Global Item</h2>
  </div>
  <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Back to Global Items
  </a>
</div>

<div class="row">
  <div class="col-lg-10">
    <div class="card">
      <div class="card-body">
        <form method="post" id="createGlobalItemForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <div class="row g-3">
            <!-- Name and Type - Always visible -->
            <div class="col-md-6">
              <label class="form-label">Name *</label>
              <input type="text" name="name" class="form-control" required placeholder="Enter item name">
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Item Type *</label>
              <select name="item_type" id="itemType" class="form-select" required>
                <option value="ingredient">Ingredient</option>
                <option value="container">Container</option>
                <option value="packaging">Packaging</option>
                <option value="consumable">Consumable</option>
              </select>
            </div>

            <!-- Ingredient Category - Only for ingredients -->
            <div class="col-md-6" id="ingredientCategorySection" style="display: block;">
              <label class="form-label">Ingredient Category</label>
              <div class="input-group">
                <select name="ingredient_category_id" id="ingredientCategorySelect" class="form-select">
                  <option value="">Select Category</option>
                  {% for category in global_ingredient_categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
                <a href="{{ url_for('developer.reference_categories') }}" class="btn btn-outline-secondary" title="Manage Global Categories">
                  <i class="fas fa-cog"></i>
                </a>
              </div>
            </div>

            <!-- Default Unit - For ingredients, packaging, consumables -->
            <div class="col-md-3" id="defaultUnitSection" style="display: block;">
              <label class="form-label">Default Unit</label>
              <select name="default_unit" class="form-select">
                <option value="">Select Unit</option>
                {% for unit in get_global_unit_list() %}
                  <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Density - Only for ingredients -->
            <div class="col-md-3" id="densitySection" style="display: block;">
              <label class="form-label">Density (g/ml)</label>
              <input type="number" step="0.001" name="density" class="form-control" placeholder="e.g. 0.920">
            </div>

            <!-- Container-specific fields -->
            <div id="containerFields" style="display: none;">
              <div class="col-12"><hr><h5 class="text-muted">Container Properties</h5></div>
              
              <div class="col-md-3">
                <label class="form-label">Material</label>
                <select name="container_material" id="containerMaterial" class="form-select">
                  <option value="">Select Material</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Capacity</label>
                <input type="number" step="0.01" name="capacity" class="form-control" placeholder="e.g. 120">
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Capacity Unit</label>
                <input type="text" name="capacity_unit" class="form-control" placeholder="e.g. ml, oz, count">
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Container Type</label>
                <select name="container_type" id="containerType" class="form-select">
                  <option value="">Select Type</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Container Style</label>
                <select name="container_style" id="containerStyle" class="form-select">
                  <option value="">Select Style</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label class="form-label">Container Color (optional)</label>
                <select name="container_color" id="containerColor" class="form-select">
                  <option value="">Select Color</option>
                </select>
              </div>
            </div>

            <!-- Perishable - For ingredients and containers -->
            <div class="col-md-3" id="perishableSection" style="display: block;">
              <div class="form-check mt-4">
                <input type="checkbox" class="form-check-input" id="default_is_perishable" name="default_is_perishable">
                <label for="default_is_perishable" class="form-check-label">Perishable by default</label>
              </div>
            </div>
            
            <div class="col-md-3" id="shelfLifeSection" style="display: none;">
              <label class="form-label">Recommended Shelf Life (days)</label>
              <input type="number" name="recommended_shelf_life_days" class="form-control" placeholder="e.g. 365">
            </div>

            <!-- Ingredient-specific properties based on category -->
            <div id="ingredientProperties" style="display: block;">
              <div class="col-12"><hr><h5 class="text-muted">Ingredient Properties</h5></div>
              
              <div class="col-md-3" id="saponificationSection" style="display: none;">
                <label class="form-label">Saponification Value</label>
                <input type="number" step="0.1" name="saponification_value" class="form-control" placeholder="e.g. 189">
              </div>
              
              <div class="col-md-3" id="iodineSection" style="display: none;">
                <label class="form-label">Iodine Value</label>
                <input type="number" step="0.1" name="iodine_value" class="form-control" placeholder="e.g. 125">
              </div>
              
              <div class="col-md-3" id="meltingPointSection" style="display: none;">
                <label class="form-label">Melting Point (°C)</label>
                <input type="number" step="0.1" name="melting_point_c" class="form-control" placeholder="e.g. 25">
              </div>
              
              <div class="col-md-3" id="flashPointSection" style="display: none;">
                <label class="form-label">Flash Point (°C)</label>
                <input type="number" step="0.1" name="flash_point_c" class="form-control" placeholder="e.g. 200">
              </div>
              
              <div class="col-md-3" id="phSection" style="display: none;">
                <label class="form-label">pH Value</label>
                <input type="number" step="0.1" name="ph_value" class="form-control" placeholder="e.g. 7.0">
              </div>
              
              <div class="col-md-3" id="moistureSection" style="display: none;">
                <label class="form-label">Moisture Content (%)</label>
                <input type="number" step="0.1" name="moisture_content_percent" class="form-control" placeholder="e.g. 2.5">
              </div>
              
              
              
              <div class="col-md-3" id="comedogenicSection" style="display: none;">
                <label class="form-label">Comedogenic Rating</label>
                <select name="comedogenic_rating" class="form-select">
                  <option value="">Select Rating</option>
                  {% for rating in range(6) %}
                  <option value="{{ rating }}">{{ rating }} - {% if rating == 0 %}Non-comedogenic{% elif rating == 1 %}Very low{% elif rating == 2 %}Low{% elif rating == 3 %}Moderate{% elif rating == 4 %}High{% else %}Very high{% endif %}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Synonyms - Always visible -->
            <div class="col-12">
              <label class="form-label">Synonyms (comma-separated)</label>
              <input type="text" name="aka_names" class="form-control" placeholder="Alternative names for this item">
            </div>
          </div>

          <!-- Form Actions -->
          <div class="mt-4 d-flex justify-content-between">
            <a href="{{ url_for('developer.global_items_admin') }}" class="btn btn-outline-secondary">
              <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Create Item
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const itemTypeSelect = document.getElementById('itemType');
  const ingredientCategorySelect = document.getElementById('ingredientCategorySelect');
  const perishableCheckbox = document.getElementById('default_is_perishable');
  const shelfLifeSection = document.getElementById('shelfLifeSection');
  
  // Category visibility cache
  let categoryVisibilityCache = {};
  
  // Container options cache
  let containerOptionsCache = null;

  function updateFormBasedOnType() {
    const selectedType = itemTypeSelect.value;
    
    // Hide all conditional sections first
    document.getElementById('ingredientCategorySection').style.display = 'none';
    document.getElementById('defaultUnitSection').style.display = 'none';
    document.getElementById('densitySection').style.display = 'none';
    document.getElementById('containerFields').style.display = 'none';
    document.getElementById('perishableSection').style.display = 'none';
    document.getElementById('ingredientProperties').style.display = 'none';
    
    // Show sections based on type
    switch(selectedType) {
      case 'ingredient':
        document.getElementById('ingredientCategorySection').style.display = 'block';
        document.getElementById('defaultUnitSection').style.display = 'block';
        document.getElementById('densitySection').style.display = 'block';
        document.getElementById('perishableSection').style.display = 'block';
        document.getElementById('ingredientProperties').style.display = 'block';
        updateIngredientPropertiesVisibility();
        break;
        
      case 'container':
        document.getElementById('containerFields').style.display = 'block';
        document.getElementById('perishableSection').style.display = 'block';
        // Load container options when container type is selected
        loadContainerOptions();
        break;
        
      case 'packaging':
        document.getElementById('defaultUnitSection').style.display = 'block';
        document.getElementById('containerFields').style.display = 'block';
        // Packaging also uses container-like fields
        loadContainerOptions();
        break;
        
      case 'consumable':
        document.getElementById('defaultUnitSection').style.display = 'block';
        break;
    }
    
    // Update shelf life visibility based on perishable checkbox
    updateShelfLifeVisibility();
  }

  async function loadContainerOptions() {
    if (containerOptionsCache) return; // Already loaded
    
    try {
      const response = await fetch('/developer/api/container-options');
      const data = await response.json();
      
      if (data.success) {
        containerOptionsCache = data.options;
        populateContainerDropdowns();
      } else {
        console.warn('Failed to load container options:', data.error);
      }
    } catch (error) {
      console.error('Error loading container options:', error);
    }
  }

  function populateContainerDropdowns() {
    if (!containerOptionsCache) return;
    
    // Populate materials
    const materialSelect = document.getElementById('containerMaterial');
    materialSelect.innerHTML = '<option value="">Select Material</option>';
    containerOptionsCache.materials.forEach(material => {
      const option = document.createElement('option');
      option.value = material;
      option.textContent = material;
      materialSelect.appendChild(option);
    });
    
    // Populate types
    const typeSelect = document.getElementById('containerType');
    typeSelect.innerHTML = '<option value="">Select Type</option>';
    containerOptionsCache.types.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      typeSelect.appendChild(option);
    });
    
    // Populate styles
    const styleSelect = document.getElementById('containerStyle');
    styleSelect.innerHTML = '<option value="">Select Style</option>';
    containerOptionsCache.styles.forEach(style => {
      const option = document.createElement('option');
      option.value = style;
      option.textContent = style;
      styleSelect.appendChild(option);
    });
    
    // Populate colors
    const colorSelect = document.getElementById('containerColor');
    colorSelect.innerHTML = '<option value="">Select Color</option>';
    containerOptionsCache.colors.forEach(color => {
      const option = document.createElement('option');
      option.value = color;
      option.textContent = color;
      colorSelect.appendChild(option);
    });
  }

  async function updateIngredientPropertiesVisibility() {
    const categoryId = ingredientCategorySelect.value;
    
    // Hide all ingredient property sections first
    ['saponificationSection', 'iodineSection', 'meltingPointSection', 'flashPointSection', 
     'phSection', 'moistureSection', 'comedogenicSection'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
    
    if (!categoryId) return;
    
    try {
      // Check cache first
      if (!categoryVisibilityCache[categoryId]) {
        const response = await fetch(`/developer/api/category-visibility/${categoryId}`);
        const data = await response.json();
        
        if (data.success) {
          categoryVisibilityCache[categoryId] = data.visibility;
        } else {
          console.warn('Failed to load category visibility:', data.error);
          return;
        }
      }
      
      const visibility = categoryVisibilityCache[categoryId];
      
      // Show fields based on category visibility settings
      if (visibility.show_saponification_value) {
        document.getElementById('saponificationSection').style.display = 'block';
      }
      if (visibility.show_iodine_value) {
        document.getElementById('iodineSection').style.display = 'block';
      }
      if (visibility.show_melting_point) {
        document.getElementById('meltingPointSection').style.display = 'block';
      }
      if (visibility.show_flash_point) {
        document.getElementById('flashPointSection').style.display = 'block';
      }
      if (visibility.show_ph_value) {
        document.getElementById('phSection').style.display = 'block';
      }
      if (visibility.show_moisture_content) {
        document.getElementById('moistureSection').style.display = 'block';
      }
      
      if (visibility.show_comedogenic_rating) {
        document.getElementById('comedogenicSection').style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading category visibility:', error);
    }
  }

  function updateShelfLifeVisibility() {
    if (perishableCheckbox && shelfLifeSection) {
      shelfLifeSection.style.display = perishableCheckbox.checked ? 'block' : 'none';
    }
  }

  // Event listeners
  itemTypeSelect.addEventListener('change', updateFormBasedOnType);
  ingredientCategorySelect.addEventListener('change', updateIngredientPropertiesVisibility);
  
  if (perishableCheckbox) {
    perishableCheckbox.addEventListener('change', updateShelfLifeVisibility);
  }

  // Initialize form state
  updateFormBasedOnType();
});
</script>
{% endblock %}
