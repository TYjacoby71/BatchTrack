
{% extends 'layout.html' %}

{% block title %}Container Management - Developer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('developer.dashboard') }}">Developer Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Container Management</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-box-open text-primary"></i> Container Management
                    </h3>
                    <p class="text-muted mb-0">Manage the master lists that populate all container dropdowns across the system</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Type Tabs -->
    <div class="mb-3">
        <ul class="nav nav-tabs" id="containerManagementTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-type="materials">
                    <i class="fas fa-cube"></i> Materials <span class="badge bg-primary ms-1">{{ curated_materials|length }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-type="types">
                    <i class="fas fa-shapes"></i> Types <span class="badge bg-success ms-1">{{ curated_types|length }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-type="styles">
                    <i class="fas fa-palette"></i> Styles <span class="badge bg-info ms-1">{{ curated_styles|length }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-type="colors">
                    <i class="fas fa-paint-brush"></i> Colors <span class="badge bg-warning ms-1">{{ curated_colors|length }}</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="container-sections">
        <!-- Materials Section -->
        <div class="section" id="section-materials">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Materials</h5>
                    <span class="badge bg-primary">{{ curated_materials|length }} items</span>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Master list of container materials available in dropdowns</p>
                    <div id="materialsList">
                        {% for material in curated_materials %}
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                            <span class="fw-medium">{{ material }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('materials', '{{ material }}')" aria-label="Remove material {{ material }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="newMaterialInput" placeholder="Add new material...">
                        <button class="btn btn-success" onclick="addItem('materials')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Types Section -->
        <div class="section" id="section-types" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Types</h5>
                    <span class="badge bg-success">{{ curated_types|length }} items</span>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Master list of container types available in dropdowns</p>
                    <div id="typesList">
                        {% for type in curated_types %}
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                            <span class="fw-medium">{{ type }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('types', '{{ type }}')" aria-label="Remove type {{ type }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="newTypeInput" placeholder="Add new type...">
                        <button class="btn btn-success" onclick="addItem('types')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Styles Section -->
        <div class="section" id="section-styles" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Styles</h5>
                    <span class="badge bg-info">{{ curated_styles|length }} items</span>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Master list of container styles available in dropdowns</p>
                    <div id="stylesList">
                        {% for style in curated_styles %}
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                            <span class="fw-medium">{{ style }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('styles', '{{ style }}')" aria-label="Remove style {{ style }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="newStyleInput" placeholder="Add new style...">
                        <button class="btn btn-success" onclick="addItem('styles')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colors Section -->
        <div class="section" id="section-colors" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Colors</h5>
                    <span class="badge bg-warning">{{ curated_colors|length }} items</span>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Master list of container colors available in dropdowns</p>
                    <div id="colorsList">
                        {% for color in curated_colors %}
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                            <span class="fw-medium">{{ color }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('colors', '{{ color }}')" aria-label="Remove color {{ color }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="newColorInput" placeholder="Add new color...">
                        <button class="btn btn-success" onclick="addItem('colors')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Changes Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button class="btn btn-primary btn-lg me-3" onclick="saveMasterLists()">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-undo"></i> Reset Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <a href="{{ url_for('developer.global_items_admin', type='container') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-boxes"></i> View Container Items
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <a href="{{ url_for('developer.create_global_item') }}" class="btn btn-outline-success">
                                    <i class="fas fa-plus"></i> Add New Container
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-info" onclick="exportContainerData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store current master lists
let masterLists = {
    materials: {{ curated_materials|tojson }},
    types: {{ curated_types|tojson }},
    styles: {{ curated_styles|tojson }},
    colors: {{ curated_colors|tojson }}
};

// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('#containerManagementTabs .nav-link');
    const sections = document.querySelectorAll('.container-sections .section');

    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Hide all sections
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show corresponding section
            const type = this.getAttribute('data-type');
            const section = document.getElementById('section-' + type);
            if (section) {
                section.style.display = 'block';
            }
        });
    });

    // Set up Enter key handlers for inputs
    const inputs = ['newMaterialInput', 'newTypeInput', 'newStyleInput', 'newColorInput'];
    const listTypes = ['materials', 'types', 'styles', 'colors'];

    inputs.forEach((inputId, index) => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addItem(listTypes[index]);
                }
            });
        }
    });
});

function addItem(listType) {
    const inputId = `new${listType.charAt(0).toUpperCase() + listType.slice(0, -1)}Input`;
    const input = document.getElementById(inputId);
    const value = input.value.trim();

    if (!value) {
        alert('Please enter a value');
        return;
    }

    if (masterLists[listType].includes(value)) {
        alert('This item already exists in the list');
        return;
    }

    masterLists[listType].push(value);
    masterLists[listType].sort(); // Keep lists alphabetically sorted
    input.value = '';
    renderList(listType);
    updateTabBadge(listType);
}

function removeItem(listType, item) {
    const index = masterLists[listType].indexOf(item);
    if (index > -1) {
        masterLists[listType].splice(index, 1);
        renderList(listType);
        updateTabBadge(listType);
    }
}

function renderList(listType) {
    const listId = `${listType}List`;
    const container = document.getElementById(listId);

    container.innerHTML = '';

    masterLists[listType].forEach(item => {
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
        div.innerHTML = `
            <span class="fw-medium">${item}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('${listType}', '${item}')" aria-label="Remove ${item}">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
    });

    // Update count badge in section header
    const badge = document.querySelector(`#section-${listType} .badge`);
    if (badge) {
        badge.textContent = `${masterLists[listType].length} items`;
    }
}

function updateTabBadge(listType) {
    const tab = document.querySelector(`[data-type="${listType}"] .badge`);
    if (tab) {
        tab.textContent = masterLists[listType].length;
    }
}

function saveMasterLists() {
    const saveBtn = document.querySelector('button[onclick="saveMasterLists()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    fetch('/developer/container-management/save-curated', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            curated_lists: masterLists
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Master lists saved successfully!');
            location.reload();
        } else {
            alert('Error saving master lists: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving master lists');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function exportContainerData() {
    const data = {
        master_lists: masterLists,
        export_date: new Date().toISOString()
    };

    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'container_master_lists.json';
    link.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
