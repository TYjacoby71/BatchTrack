{% extends 'layout.html' %}
{% block content %}
{% set tool_enabled = tool_enabled if tool_enabled is defined else True %}
<div class="py-1">
  <h2 class="mb-3 d-flex align-items-center gap-2">
    Soap Maker Tools
    {% if not tool_enabled %}
    <span class="badge bg-secondary">Coming Soon</span>
    {% endif %}
  </h2>
  {% if not tool_enabled %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="fas fa-hourglass-half me-2"></i>
    Public drafting is in previewâ€”feel free to explore the layout while we finish the live calculators.
  </div>
  {% endif %}
  <script>window.RECIPE_CATEGORY_NAME = 'Soaps';</script>
  <p class="text-muted">Use grams by default. Convert as needed with the unit engine.</p>

  <div class="card mb-4">
    <div class="card-header">Lye Calculator</div>
    <div class="card-body">
      <div class="mb-3">
        <h6>Oil Blend (per batch)</h6>
        <div id="oilRows">
          <div class="row g-2 align-items-end oil-row mb-2">
            <div class="col-md-6">
              <label class="form-label">Oil</label>
              <div class="position-relative">
                <input type="text" class="form-control oil-typeahead" placeholder="Search oils...">
                <input type="hidden" class="oil-sap-koh">
                <input type="hidden" class="oil-gi-id">
                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index:1050"></div>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Weight (g)</label>
              <input type="number" class="form-control oil-grams" min="0" step="0.1">
            </div>
            <div class="col-md-3 d-grid">
              <button class="btn btn-outline-danger remove-oil" type="button">Remove</button>
            </div>
          </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" id="addOil">Add Oil</button>
      </div>

      <div class="accordion mb-3" id="soapExtrasAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="soapExtrasHeading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapExtrasCollapse">
              Optional add-ons (ingredients, consumables, containers)
            </button>
          </h2>
          <div id="soapExtrasCollapse" class="accordion-collapse collapse" data-bs-parent="#soapExtrasAccordion">
            <div class="accordion-body">
              <div class="mb-3">
                <h6>Ingredients</h6>
                <div id="tool-ingredients"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" id="addToolIngredient">Add Ingredient</button>
              </div>
              <div class="mb-3">
                <h6>Consumables</h6>
                <div id="tool-consumables"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" id="addToolConsumable">Add Consumable</button>
              </div>
              <div class="mb-3">
                <h6>Containers</h6>
                <div id="tool-containers"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" id="addToolContainer">Add Container</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <form id="lyeForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Computed total oils (g)</label>
          <input type="number" class="form-control" name="oil_weight_g" min="0" step="0.1" required readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Superfat (%)</label>
          <input type="number" class="form-control" name="superfat" min="0" max="20" step="0.1" value="5" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Lye type</label>
          <select class="form-select" name="lye_type">
            <option value="NaOH">NaOH (bar soap)</option>
            <option value="KOH">KOH (liquid soap)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Water as % of oils</label>
          <input type="number" class="form-control" name="water_pct" min="20" max="50" step="0.1" value="33">
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-primary" id="calcLyeBtn">Calculate</button>
        </div>
      </form>
      <div class="mt-3" id="lyeResult" style="display:none;">
        <div class="alert alert-info mb-2" id="lyeNumbers"></div>
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
          <button class="btn btn-success" id="saveSoapTool">Push to Recipes</button>
          <span class="small text-muted">Draft your recipe to finish in BatchTrack.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="soapUtilitiesAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="soapUtilitiesHeading">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapUtilitiesCollapse">
          Quick Unit Conversion
        </button>
      </h2>
      <div id="soapUtilitiesCollapse" class="accordion-collapse collapse" data-bs-parent="#soapUtilitiesAccordion">
        <div class="accordion-body">
          <form id="convForm" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" name="amount" step="0.001" min="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">From</label>
              <input type="text" class="form-control" name="from" placeholder="g, ml, oz">
            </div>
            <div class="col-md-3">
              <label class="form-label">To</label>
              <input type="text" class="form-control" name="to" placeholder="g, ml, oz">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button type="button" class="btn btn-outline-secondary w-100" id="convBtn">Convert</button>
            </div>
          </form>
          <div class="mt-2 small text-muted" id="convResult"></div>
        </div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="soapExportsHeading">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapExportsCollapse">
          Exports
        </button>
      </h2>
      <div id="soapExportsCollapse" class="accordion-collapse collapse" data-bs-parent="#soapUtilitiesAccordion">
        <div class="accordion-body">
          <a class="btn btn-outline-secondary" href="{{ url_for('exports.soap_inci_tool') }}">View INCI Summary</a>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="{{ url_for('static', filename='js/components/suggestions.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/tool_lines.js') }}"></script>
<script>
(function(){
  function round(v){ return Math.round(v*1000)/1000 }
  const TOOL_UNIT_OPTIONS_HTML = `{% for unit in global_units %}<option value="{{ unit.name }}">{{ unit.name }}</option>{% endfor %}`;
  function attachOilTypeahead(row){
    const input = row.querySelector('.oil-typeahead');
    const hiddenSap = row.querySelector('.oil-sap-koh');
    const hiddenGi = row.querySelector('.oil-gi-id');
    const list = row.querySelector('[data-role="suggestions"]');
    if (!input || !list || typeof window.attachMergedInventoryGlobalTypeahead !== 'function') {
      return;
    }
    window.attachMergedInventoryGlobalTypeahead({
      inputEl: input,
      listEl: list,
      mode: 'public',
      giHiddenEl: hiddenGi,
      includeInventory: false,
      includeGlobal: true,
      ingredientFirst: true,
      searchType: 'ingredient',
      requireHidden: false,
      onSelection: function(picked){
        if (hiddenSap) {
          hiddenSap.value = picked?.saponification_value || '';
        }
      }
    });
    input.addEventListener('input', function(){
      if (!this.value.trim() && hiddenSap) {
        hiddenSap.value = '';
      }
      if (!this.value.trim() && hiddenGi) {
        hiddenGi.value = '';
      }
    });
  }

  function computeTotalOils(){
    let sum=0; document.querySelectorAll('#oilRows .oil-grams').forEach(i=>{ const v=parseFloat(i.value||'0'); if(v>0) sum+=v; });
    document.querySelector('#lyeForm [name="oil_weight_g"]').value = round(sum);
    return sum;
  }
  function computeLyeBySAP(lyeType, superfat){
    // Sum oil grams * SAP factor per oil; saponification_value is mg KOH / g oil
    // g KOH per g oil = SAP_KOH/1000; g NaOH per g = SAP_KOH * 0.713 / 1000
    let lyeTotal=0; let totalG=0;
    document.querySelectorAll('#oilRows .oil-row').forEach(row=>{
      const g = parseFloat(row.querySelector('.oil-grams').value||'0');
      const sapKOH = parseFloat(row.querySelector('.oil-sap-koh').value||'0');
      if (g>0){
        totalG += g;
        if (sapKOH>0){
          const perG = (lyeType==='KOH') ? (sapKOH/1000.0) : (sapKOH*0.713/1000.0);
          lyeTotal += g * perG;
        }
      }
    });
    if (lyeTotal>0) return lyeTotal * (1 - (superfat/100));
    // Fallback to average SAP if no per-oil values provided
    const sapAvgNaOH = 0.138, sapAvgKOH = 0.194;
    const sap = (lyeType==='KOH')? sapAvgKOH : sapAvgNaOH;
    return totalG * sap * (1 - (superfat/100));
  }

  function collectOilLines(){
    const oils = [];
    document.querySelectorAll('#oilRows .oil-row').forEach(row => {
      const name = row.querySelector('.oil-typeahead')?.value?.trim();
      const gi = row.querySelector('.oil-gi-id')?.value || '';
      const grams = parseFloat(row.querySelector('.oil-grams')?.value || '0');
      if (!(grams > 0)) return;
      if (!name && !gi) return;
      oils.push({
        name: name || undefined,
        global_item_id: gi ? parseInt(gi) : undefined,
        quantity: grams,
        unit: 'gram'
      });
    });
    return oils;
  }

  document.getElementById('addOil').addEventListener('click', function(){
    const container = document.getElementById('oilRows');
    const row = document.createElement('div'); row.className='row g-2 align-items-end oil-row mb-2';
    row.innerHTML = `
      <div class="col-md-6">
        <label class="form-label">Oil</label>
        <div class="position-relative">
          <input type="text" class="form-control oil-typeahead" placeholder="Search oils...">
          <input type="hidden" class="oil-sap-koh">
          <input type="hidden" class="oil-gi-id">
          <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index:1050"></div>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Weight (g)</label>
        <input type="number" class="form-control oil-grams" min="0" step="0.1">
      </div>
      <div class="col-md-3 d-grid">
        <button class="btn btn-outline-danger remove-oil" type="button">Remove</button>
      </div>`;
    container.appendChild(row);
    attachOilTypeahead(row);
  });
  document.getElementById('oilRows').addEventListener('input', function(e){ if(e.target.classList.contains('oil-grams')) computeTotalOils(); });
  document.getElementById('oilRows').addEventListener('click', function(e){ if(e.target.classList.contains('remove-oil')){ e.target.closest('.oil-row').remove(); computeTotalOils(); }});
  // attach for initial row
  attachOilTypeahead(document.querySelector('#oilRows .oil-row'));

  function buildLineRow(kind){
    return buildToolLineRow(kind, { context: 'public', unitOptionsHtml: TOOL_UNIT_OPTIONS_HTML });
  }

  document.getElementById('addToolIngredient').addEventListener('click', function(){
    document.getElementById('tool-ingredients').appendChild(buildLineRow('ingredient'));
  });
  document.getElementById('addToolConsumable').addEventListener('click', function(){
    document.getElementById('tool-consumables').appendChild(buildLineRow('consumable'));
  });
  document.getElementById('addToolContainer').addEventListener('click', function(){
    document.getElementById('tool-containers').appendChild(buildLineRow('container'));
  });

  document.getElementById('calcLyeBtn').addEventListener('click', async function(){
    const f = document.getElementById('lyeForm');
    const oilG = computeTotalOils();
    const superfat = parseFloat(f.superfat.value||'0');
    const lyeType = f.lye_type.value;
    const waterPct = parseFloat(f.water_pct.value||'33');
    if (!(oilG>0)) { alert('Enter oil weight in grams'); return; }

    const lyeAfterSuperfat = computeLyeBySAP(lyeType, superfat);
    const waterG = oilG * (waterPct/100);

    const out = `Lye (${lyeType}): ${round(lyeAfterSuperfat)} g, Water: ${round(waterG)} g`;
    document.getElementById('lyeNumbers').textContent = out;
    document.getElementById('lyeResult').style.display = 'block';
  });

  document.getElementById('convBtn').addEventListener('click', async function(){
    const f = document.getElementById('convForm');
    const amount = parseFloat(f.amount.value||'0');
    const fromU = (f.from.value||'').trim();
    const toU = (f.to.value||'').trim();
    if (!(amount>0) || !fromU || !toU) { return; }
    try {
      const r = await fetch('/api/public/convert-units', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ quantity: amount, from_unit: fromU, to_unit: toU })});
      const data = await r.json();
      if (data && data.success && data.data && data.data.success) {
        document.getElementById('convResult').textContent = `${amount} ${fromU} = ${data.data.converted_value} ${toU}`;
      } else {
        const msg = (data && data.data && data.data.error_data && data.data.error_data.message) || (data && data.error) || 'Conversion failed';
        document.getElementById('convResult').textContent = msg;
      }
    } catch(e){ document.getElementById('convResult').textContent = 'Conversion error'; }
  });

  document.getElementById('saveSoapTool').addEventListener('click', async function(){
    let redirectTo = '/recipes/new';
    try {
      const f = document.getElementById('lyeForm');
      const oilG = parseFloat(f.oil_weight_g.value||'0');
      const superfat = parseFloat(f.superfat.value||'0');
      const lyeType = f.lye_type.value;
      const waterPct = parseFloat(f.water_pct.value||'33');
      const lyeAfterSuperfat = computeLyeBySAP(lyeType, superfat);
      const waterG = oilG * (waterPct/100);
      const oils = collectOilLines();
      const lyeName = lyeType === 'KOH' ? 'Potassium Hydroxide (KOH)' : 'Sodium Hydroxide (NaOH)';
      const baseIngredients = [...oils];
      if (lyeAfterSuperfat > 0) {
        baseIngredients.push({ name: lyeName, quantity: round(lyeAfterSuperfat), unit: 'gram' });
      }
      if (waterG > 0) {
        baseIngredients.push({ name: 'Distilled Water', quantity: round(waterG), unit: 'gram' });
      }
      // Collect selected lines for draft persistence
      function collectLines(wrapperId, kind){
        const out = [];
        document.querySelectorAll(`#${wrapperId} .row`).forEach(function(row){
          const name = row.querySelector('.tool-typeahead')?.value?.trim();
          const gi = row.querySelector('.tool-gi-id')?.value || '';
          const qtyEl = row.querySelector('.tool-qty');
          const unitEl = row.querySelector('.tool-unit');
          const hasQty = qtyEl && qtyEl.value !== '';
          if (!name && !gi) return;
          if (kind === 'container'){
            out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 1 });
          } else {
            out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 0, unit: (unitEl?.value || '').trim() || 'gram' });
          }
        });
        return out;
      }

      const payload = {
        name: 'Soap (Draft)',
        instructions: 'Draft from Soap Tools',
        predicted_yield: Math.round((oilG + waterG + lyeAfterSuperfat)*100)/100,
        predicted_yield_unit: 'gram',
        category_name: 'Soaps',
        category_data: {
          soap_superfat: superfat,
          soap_water_pct: waterPct,
          soap_lye_type: lyeType
        },
        ingredients: baseIngredients.concat(collectLines('tool-ingredients', 'ingredient')),
        consumables: collectLines('tool-consumables', 'consumable'),
        containers: collectLines('tool-containers', 'container')
      };
      const response = await fetch('/tools/draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await response.json();
      if (data && data.redirect) {
        redirectTo = data.redirect;
      }
    } catch(_) {}
    window.location.assign(redirectTo);
  });
})();
</script>
{% endblock %}