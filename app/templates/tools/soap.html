{% extends 'layout.html' %}
{% block content %}
{% set tool_enabled = tool_enabled if tool_enabled is defined else True %}
<div class="py-1" id="soapToolPage">
  <h2 class="mb-3 d-flex align-items-center gap-2">
    Soap Maker Tools
    {% if not tool_enabled %}
    <span class="badge bg-secondary">Coming Soon</span>
    {% endif %}
  </h2>
  {% if not tool_enabled %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="fas fa-hourglass-half me-2"></i>
    Public drafting is in preview—feel free to explore the layout while we finish the live calculators.
  </div>
  {% endif %}
  <script>
    window.RECIPE_CATEGORY_NAME = 'Soaps';
    window.SOAP_CALC_LIMIT = {{ calc_limit|tojson if calc_limit is defined else 'null' }};
    window.SOAP_CALC_TIER = {{ calc_tier|tojson if calc_tier is defined else '"guest"' }};
  </script>
  <div id="soapAlertStack" class="mb-3"></div>
  <style>
    #soapToolPage .soap-data-sticky { position: sticky; top: 1rem; }
    #soapToolPage .soap-quality-row {
      display: grid;
      grid-template-columns: 90px 1fr;
      gap: 0.75rem;
      align-items: center;
    }
    #soapToolPage .soap-stage-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(280px, 420px);
      gap: 1rem;
      align-items: start;
    }
    #soapToolPage .soap-quality-row .progress { height: 10px; }
    #soapToolPage .quality-target-marker {
      position: absolute;
      top: -6px;
      bottom: -6px;
      border-left: 2px dashed #198754;
      width: 0;
    }
    #soapToolPage .quality-target-label {
      position: absolute;
      top: -18px;
      left: 0;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #198754;
      background: #fff;
      padding: 0 2px;
    }
    #soapToolPage .soap-oil-profile td {
      padding: 0.2rem 0.35rem;
    }
    #soapToolPage .soap-stage-note {
      font-size: 0.78rem;
    }
    #soapToolPage .oil-profile-float {
      position: absolute;
      right: 0;
      top: 0;
      width: 260px;
      max-width: 45%;
      z-index: 1040;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }
    @media (max-width: 991px) {
      #soapToolPage .soap-stage-layout {
        grid-template-columns: 1fr;
      }
      #soapToolPage .oil-profile-float {
        position: static;
        width: 100%;
        max-width: 100%;
      }
    }
  </style>

  <div class="card mb-3" id="soapConfigCard">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label"><span class="badge bg-secondary me-1">1</span>Lye type</label>
          <div class="btn-group w-100" role="group" aria-label="Lye type">
            <input type="radio" class="btn-check" name="lye_type" id="lyeTypeNaoh" value="NaOH" checked>
            <label class="btn btn-outline-secondary" for="lyeTypeNaoh">NaOH</label>
            <input type="radio" class="btn-check" name="lye_type" id="lyeTypeKoh" value="KOH">
            <label class="btn btn-outline-secondary" for="lyeTypeKoh">KOH</label>
            <input type="radio" class="btn-check" name="lye_type" id="lyeTypeKoh90" value="KOH90">
            <label class="btn btn-outline-secondary" for="lyeTypeKoh90">90% KOH</label>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label"><span class="badge bg-secondary me-1">2</span>Units</label>
          <div class="btn-group w-100" role="group" aria-label="Weight units">
            <input type="radio" class="btn-check" name="weight_unit" id="unitGrams" value="g" checked>
            <label class="btn btn-outline-secondary" for="unitGrams">g</label>
            <input type="radio" class="btn-check" name="weight_unit" id="unitOunces" value="oz">
            <label class="btn btn-outline-secondary" for="unitOunces">oz</label>
            <input type="radio" class="btn-check" name="weight_unit" id="unitPounds" value="lb">
            <label class="btn btn-outline-secondary" for="unitPounds">lb</label>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label"><span class="badge bg-secondary me-1">3</span>Water method</label>
          <select class="form-select" id="waterMethod" name="water_method">
            <option value="percent">Water as % of oils</option>
            <option value="concentration">Lye concentration %</option>
            <option value="ratio">Water : Lye ratio</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><span class="badge bg-secondary me-1">4</span>Superfat (%)</label>
          <input type="number" class="form-control" id="lyeSuperfat" name="superfat" min="0" max="20" step="0.1" value="5">
          <div class="form-text">5% is a balanced default.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="soap-stage-layout">
    <div class="soap-stage-column">
      <div class="accordion" id="soapStageAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage1Heading">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage1Collapse">
              Stage 1 — Mold sizing & batch target
            </button>
          </h2>
          <div id="soapStage1Collapse" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Mold water weight (<span class="unit-label">g</span>)</label>
                  <input type="number" class="form-control" id="moldWaterWeight" min="0" step="0.1" placeholder="e.g., 1200">
                  <div class="form-text">Fill the mold with water and weigh it.</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Oils % of mold</label>
                  <input type="number" class="form-control" id="moldOilPct" min="0" max="100" step="0.1" value="65" title="Normal range is 50-80%.">
                  <div class="form-text soap-stage-note">Normal range is 50-80%.</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Total oils target (<span class="unit-label">g</span>)</label>
                  <input type="number" class="form-control" id="oilTotalTarget" min="0" step="0.1" placeholder="Auto from mold or enter manually">
                  <div class="form-text soap-stage-note" id="oilTargetHint">Auto-fills when mold sizing is set.</div>
                </div>
              </div>
              <div class="row g-3 mt-2">
                <div class="col-md-4">
                  <label class="form-label">Mold shape</label>
                  <select class="form-select" id="moldShape">
                    <option value="loaf">Loaf / rectangular</option>
                    <option value="cylinder">Cylinder / pipe</option>
                  </select>
                </div>
                <div class="col-md-8">
                  <div class="mt-2 d-none" id="moldCylinderOptions">
                    <div class="alert alert-warning small mb-2" id="moldCylinderAlert">
                      Cylinder mold selected. Use a correction if you want headspace for pouring or overflow control.
                    </div>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="moldCylinderCorrection">
                          <label class="form-check-label" for="moldCylinderCorrection">Apply cylinder correction</label>
                        </div>
                        <div class="form-text soap-stage-note">Use this when you want to leave headspace or avoid spill risk.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Cylinder fill factor</label>
                        <input type="number" class="form-control" id="moldCylinderFactor" min="0.5" max="1" step="0.05" value="0.85">
                        <div class="form-text soap-stage-note">0.85 means fill to 85% of measured capacity.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="small text-muted mt-2" id="moldSuggestionNote">Target oils are capped to the mold size above.</div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage2Heading">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage2Collapse">
              Stage 2 — Oils, fats & waxes
            </button>
          </h2>
          <div id="soapStage2Collapse" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <div class="position-relative">
                <div class="row g-3">
                  <div class="col-12">
                    <div id="oilRows">
                    <div class="row g-2 align-items-end oil-row mb-2">
                      <div class="col-md-6">
                        <label class="form-label">Oil, fat, or wax</label>
                        <div class="position-relative">
                          <input type="text" class="form-control oil-typeahead" placeholder="Search oils, butters, waxes...">
                          <input type="hidden" class="oil-sap-koh">
                          <input type="hidden" class="oil-iodine">
                          <input type="hidden" class="oil-fatty">
                          <input type="hidden" class="oil-gi-id">
                          <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index:1050"></div>
                        </div>
                        <div class="form-text small text-muted">Filtered to oils, butters, and waxes.</div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Weight (<span class="unit-label">g</span>)</label>
                        <input type="number" class="form-control oil-grams" min="0" step="0.1">
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">%</label>
                        <input type="number" class="form-control oil-percent" min="0" step="0.1">
                      </div>
                      <div class="col-md-1 d-grid">
                        <button class="btn btn-outline-danger remove-oil" type="button">Remove</button>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
                    <button class="btn btn-sm btn-outline-primary" id="addOil" type="button">Add Oil</button>
                    <button class="btn btn-sm btn-outline-secondary" id="normalizeOils" type="button">Normalize to 100%</button>
                    <div class="small text-muted">Total %: <span id="oilPercentTotal">0</span>%</div>
                    <div class="small text-muted">Current oils: <span id="oilTotalComputed">--</span></div>
                  </div>
                  <div class="alert alert-warning small mt-2 d-none" id="oilLimitWarning"></div>
                  <div class="alert alert-light border small mt-3 d-none" id="oilBlendTips"></div>
                  <div class="small text-muted mt-2">Select or hover an oil to preview its profile.</div>
                </div>
              </div>
              <div class="card oil-profile-float d-none" id="oilProfileFloat">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <strong class="small">Selected oil profile</strong>
                      <span class="small text-muted" id="selectedOilName">Pick an oil to preview</span>
                    </div>
                    <div class="small text-muted">SAP (KOH): <span id="selectedOilSap">--</span> · Iodine: <span id="selectedOilIodine">--</span></div>
                    <div class="mt-2">
                      <div class="small text-muted">Qualities</div>
                      <div class="d-flex justify-content-between"><span>Hardness</span><span id="selectedOilHardness">--</span></div>
                      <div class="d-flex justify-content-between"><span>Cleansing</span><span id="selectedOilCleansing">--</span></div>
                      <div class="d-flex justify-content-between"><span>Conditioning</span><span id="selectedOilConditioning">--</span></div>
                      <div class="d-flex justify-content-between"><span>Bubbly</span><span id="selectedOilBubbly">--</span></div>
                      <div class="d-flex justify-content-between"><span>Creamy</span><span id="selectedOilCreamy">--</span></div>
                    </div>
                    <div class="mt-2">
                      <div class="small text-muted">Fatty acids</div>
                      <div class="table-responsive">
                        <table class="table table-sm soap-oil-profile mb-0">
                          <tbody>
                            <tr><td>Lauric</td><td class="text-end" id="selectedOilLauric">--</td></tr>
                            <tr><td>Myristic</td><td class="text-end" id="selectedOilMyristic">--</td></tr>
                            <tr><td>Palmitic</td><td class="text-end" id="selectedOilPalmitic">--</td></tr>
                            <tr><td>Stearic</td><td class="text-end" id="selectedOilStearic">--</td></tr>
                            <tr><td>Ricinoleic</td><td class="text-end" id="selectedOilRicinoleic">--</td></tr>
                            <tr><td>Oleic</td><td class="text-end" id="selectedOilOleic">--</td></tr>
                            <tr><td>Linoleic</td><td class="text-end" id="selectedOilLinoleic">--</td></tr>
                            <tr><td>Linolenic</td><td class="text-end" id="selectedOilLinolenic">--</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage3Heading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage3Collapse">
              Stage 3 — Lye & water details
            </button>
          </h2>
          <div id="soapStage3Collapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Lye purity (%)</label>
                  <input type="number" class="form-control" id="lyePurity" min="90" max="100" step="0.1" value="100">
                  <div class="form-text soap-stage-note" id="lyePurityHint">Most calculators assume 100%.</div>
                </div>
                <div class="col-md-4 water-input" data-method="percent">
                  <label class="form-label">Water % of oils</label>
                  <input type="number" class="form-control" id="waterPct" min="20" max="50" step="0.1" value="33">
                </div>
                <div class="col-md-4 water-input d-none" data-method="concentration">
                  <label class="form-label">Lye concentration %</label>
                  <input type="number" class="form-control" id="lyeConcentration" min="20" max="50" step="0.1" value="33">
                </div>
                <div class="col-md-4 water-input d-none" data-method="ratio">
                  <label class="form-label">Water : Lye ratio</label>
                  <input type="number" class="form-control" id="waterRatio" min="1" max="4" step="0.05" value="2">
                </div>
              </div>
              <div class="form-text mt-2">
                Water settings change batch yield and cure time. Auto-updates as you type.
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="calcLyeBtn">Recalculate (optional)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage4Heading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage4Collapse">
              Stage 4 — Additives & helpers
            </button>
          </h2>
          <div id="soapStage4Collapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Sodium lactate %</label>
                  <input type="number" class="form-control" id="additiveLactatePct" min="0" max="5" step="0.1" value="1">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Sugar %</label>
                  <input type="number" class="form-control" id="additiveSugarPct" min="0" max="5" step="0.1" value="1">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Salt %</label>
                  <input type="number" class="form-control" id="additiveSaltPct" min="0" max="5" step="0.1" value="0.5">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Citric acid %</label>
                  <input type="number" class="form-control" id="additiveCitricPct" min="0" max="5" step="0.1" value="0">
                  <div class="form-text soap-stage-note">Adds extra lye when used.</div>
                </div>
              </div>
              <div class="row g-3 mt-1">
                <div class="col-md-6">
                  <label class="form-label">Sodium lactate item</label>
                  <div class="position-relative">
                    <input type="text" class="form-control additive-typeahead" id="additiveLactateName" placeholder="Link sodium lactate (optional)">
                    <input type="hidden" id="additiveLactateGi">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sugar item</label>
                  <div class="position-relative">
                    <input type="text" class="form-control additive-typeahead" id="additiveSugarName" placeholder="Link sugar (optional)">
                    <input type="hidden" id="additiveSugarGi">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Salt item</label>
                  <div class="position-relative">
                    <input type="text" class="form-control additive-typeahead" id="additiveSaltName" placeholder="Link salt (optional)">
                    <input type="hidden" id="additiveSaltGi">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Citric acid item</label>
                  <div class="position-relative">
                    <input type="text" class="form-control additive-typeahead" id="additiveCitricName" placeholder="Link citric acid (optional)">
                    <input type="hidden" id="additiveCitricGi">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
                  </div>
                </div>
              </div>
              <div class="row g-3 mt-3">
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Sodium lactate</div>
                    <div class="fw-semibold" id="additiveLactateOut">--</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Sugar</div>
                    <div class="fw-semibold" id="additiveSugarOut">--</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Salt</div>
                    <div class="fw-semibold" id="additiveSaltOut">--</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Citric acid</div>
                    <div class="fw-semibold" id="additiveCitricOut">--</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Extra lye for citric</div>
                    <div class="fw-semibold" id="additiveCitricLyeOut">--</div>
                  </div>
                </div>
              </div>
              <div class="small text-muted mt-2">All additive grams are based on total oil weight.</div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage5Heading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage5Collapse">
              Stage 5 — Fragrance & essential oils
            </button>
          </h2>
          <div id="soapStage5Collapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Fragrance/EO %</label>
                  <input type="number" class="form-control" id="additiveFragrancePct" min="0" max="6" step="0.1" value="3">
                  <div class="form-text soap-stage-note">Above 3% can accelerate trace.</div>
                </div>
                <div class="col-md-8">
                  <label class="form-label">Fragrance/EO selection</label>
                  <div class="position-relative">
                    <input type="text" class="form-control additive-typeahead" id="additiveFragranceName" placeholder="Link fragrance or EO (optional)">
                    <input type="hidden" id="additiveFragranceGi">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
                  </div>
                </div>
              </div>
              <div class="row g-3 mt-3">
                <div class="col-md-4">
                  <div class="border rounded p-2 h-100">
                    <div class="small text-muted">Fragrance/EO</div>
                    <div class="fw-semibold" id="additiveFragranceOut">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage6Heading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage6Collapse">
              Stage 6 — Glossary & reference
            </button>
          </h2>
          <div id="soapStage6Collapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-lg-6">
                  <h6>Core terms</h6>
                  <dl class="small">
                    <dt>Saponification (SAP)</dt>
                    <dd>Reaction where oils + lye turn into soap + glycerin.</dd>
                    <dt>Superfat</dt>
                    <dd>Extra oils left unsaponified for gentler bars.</dd>
                    <dt>Lye concentration</dt>
                    <dd>Percent lye in your solution (higher = faster trace).</dd>
                    <dt>Trace</dt>
                    <dd>When batter thickens enough to leave a trail on the surface.</dd>
                    <dt>Cure</dt>
                    <dd>Resting time for hardness and mildness (4-6 weeks).</dd>
                  </dl>
                </div>
                <div class="col-lg-6">
                  <h6>Ingredient categories</h6>
                  <ul class="small">
                    <li><strong>Hard oils/butters:</strong> Coconut, palm, cocoa butter, tallow, lard</li>
                    <li><strong>Conditioning hard:</strong> Shea, mango, kokum, sal butter</li>
                    <li><strong>Soft oils:</strong> Olive, avocado, sunflower, rice bran</li>
                    <li><strong>Additives:</strong> Honey, milk, clays, charcoal, botanicals</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="soapStage7Heading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage7Collapse">
              Stage 7 — Ingredients, consumables & containers
            </button>
          </h2>
          <div id="soapStage7Collapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <h6>Quick stubs</h6>
                <div class="d-flex flex-wrap gap-2" id="ingredientStubButtons">
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Honey">Honey</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Goat Milk">Goat Milk</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Activated Charcoal">Activated Charcoal</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Kaolin Clay">Kaolin Clay</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Sodium Lactate">Sodium Lactate</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Fragrance Oil">Fragrance Oil</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Essential Oil Blend">Essential Oil Blend</button>
                </div>
              </div>
              <div class="mb-3">
                <h6>Ingredients</h6>
                <div id="tool-ingredients"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolIngredient">Add Ingredient</button>
              </div>
              <div class="mb-3">
                <h6>Consumables</h6>
                <div class="d-flex flex-wrap gap-2 mb-2">
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Nitrile Gloves">Nitrile Gloves</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Safety Goggles">Safety Goggles</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Freezer Paper">Freezer Paper</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Paper Towels">Paper Towels</button>
                </div>
                <div id="tool-consumables"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolConsumable">Add Consumable</button>
              </div>
              <div class="mb-3">
                <h6>Containers</h6>
                <div class="d-flex flex-wrap gap-2 mb-2">
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Loaf Mold">Loaf Mold</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Silicone Cavity Mold">Silicone Cavity Mold</button>
                  <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Wax Paper Lined Box">Wax Paper Lined Box</button>
                </div>
                <div id="tool-containers"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolContainer">Add Container</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="soap-sidebar-column">
      <div class="soap-data-sticky">
        <div class="card" id="soapQualityCard">
          <div class="card-header">
            <div class="d-flex flex-column gap-2">
              <div class="d-flex align-items-center justify-content-between">
                <strong>Soap qualities & fatty acids</strong>
              </div>
              <div class="d-flex flex-wrap gap-2 align-items-end">
                <div class="flex-grow-1">
                  <label class="form-label mb-1 small">Quality preset</label>
                  <select class="form-select form-select-sm" id="qualityPreset">
                    <option value="none">No targets</option>
                    <option value="balanced" selected>Balanced All-Purpose</option>
                    <option value="bubbly">Bubbly Lather</option>
                    <option value="creamy">Creamy Conditioning</option>
                    <option value="hard">Hard / Durable</option>
                    <option value="gentle">Gentle / Moisturizing</option>
                    <option value="castile">Castile-Style</option>
                    <option value="shampoo">Shampoo Bar</option>
                    <option value="utility">Utility / Laundry</option>
                    <option value="luxury">Luxury Butter-Rich</option>
                    <option value="palmFree">Palm-Free Vegan</option>
                  </select>
                </div>
                <button class="btn btn-sm btn-link text-decoration-none px-0" type="button" id="applyQualityTargets">Match preset</button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Hardness</div>
                <div class="fw-semibold" id="qualityHardnessValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="qualityHardnessBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="qualityHardnessTarget"><span class="quality-target-label" id="qualityHardnessTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Cleansing</div>
                <div class="fw-semibold" id="qualityCleansingValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="qualityCleansingBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="qualityCleansingTarget"><span class="quality-target-label" id="qualityCleansingTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Conditioning</div>
                <div class="fw-semibold" id="qualityConditioningValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="qualityConditioningBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="qualityConditioningTarget"><span class="quality-target-label" id="qualityConditioningTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Bubbly</div>
                <div class="fw-semibold" id="qualityBubblyValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="qualityBubblyBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="qualityBubblyTarget"><span class="quality-target-label" id="qualityBubblyTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Creamy</div>
                <div class="fw-semibold" id="qualityCreamyValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="qualityCreamyBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="qualityCreamyTarget"><span class="quality-target-label" id="qualityCreamyTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">Iodine</div>
                <div class="fw-semibold" id="iodineValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="iodineBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="iodineTarget"><span class="quality-target-label" id="iodineTargetLabel"></span></span>
              </div>
            </div>
            <div class="soap-quality-row mb-2">
              <div>
                <div class="small text-muted">INS</div>
                <div class="fw-semibold" id="insValue">--</div>
              </div>
              <div class="progress position-relative">
                <div class="progress-bar" id="insBar" role="progressbar"></div>
                <span class="quality-target-marker d-none" id="insTarget"><span class="quality-target-label" id="insTargetLabel"></span></span>
              </div>
            </div>
            <div class="small text-muted" id="fattyCoverageNote">Fatty acid coverage: --</div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div>
                <div class="small text-muted">Saturated:Unsaturated</div>
                <div class="fw-semibold" id="fattySatRatio">--</div>
              </div>
              <div>
                <div class="small text-muted">Avg SAP (KOH)</div>
                <div class="fw-semibold" id="sapAvgValue">--</div>
              </div>
            </div>
            <div class="mt-3">
              <div class="small text-muted mb-1">Fatty acid breakdown</div>
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <tbody>
                    <tr><td>Lauric</td><td class="text-end" id="fattyLauric">--</td></tr>
                    <tr><td>Myristic</td><td class="text-end" id="fattyMyristic">--</td></tr>
                    <tr><td>Palmitic</td><td class="text-end" id="fattyPalmitic">--</td></tr>
                    <tr><td>Stearic</td><td class="text-end" id="fattyStearic">--</td></tr>
                    <tr><td>Ricinoleic</td><td class="text-end" id="fattyRicinoleic">--</td></tr>
                    <tr><td>Oleic</td><td class="text-end" id="fattyOleic">--</td></tr>
                    <tr><td>Linoleic</td><td class="text-end" id="fattyLinoleic">--</td></tr>
                    <tr><td>Linolenic</td><td class="text-end" id="fattyLinolenic">--</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4" id="resultsCard" style="display:none;">
    <div class="card-header"><strong>Results</strong></div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Lye with purity</div>
            <div class="fs-5" id="lyeAdjustedOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Water</div>
            <div class="fs-5" id="waterOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Batch yield</div>
            <div class="fs-5" id="batchYieldOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Lye concentration</div>
            <div class="fs-5" id="lyeConcentrationOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Water : Lye</div>
            <div class="fs-5" id="waterRatioOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Total oils</div>
            <div class="fs-5" id="totalOilsOutput">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2 h-100">
            <div class="small text-muted">Superfat</div>
            <div class="fs-5" id="superfatOutput">--</div>
          </div>
        </div>
      </div>
      <div class="alert alert-info mt-3 mb-2">
        Always add lye to water (never water to lye) and wear protective gear.
      </div>
      <div class="alert alert-warning mt-3 d-none" id="soapQualityWarnings"></div>
      <div class="border rounded p-2 mt-3">
        <div class="small text-muted mb-1">Visual guidance</div>
        <ul class="small mb-0" id="soapVisualGuidanceList"></ul>
      </div>
      <div class="small text-muted mt-2">
        Batch yield includes water and additives; expect weight loss during cure.
      </div>
      <div class="d-flex flex-wrap gap-2 mt-3 align-items-center">
        <button class="btn btn-success" id="saveSoapTool" type="button">Push to Recipes</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('exports.soap_inci_tool') }}">Export INCI</a>
      </div>
    </div>
  </div>

  <div class="modal fade" id="soapSignupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Keep your recipes saved</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You are almost at the free calculation limit. Create a free account to save recipes and keep calculating.
        </div>
        <div class="modal-footer">
          <a class="btn btn-primary" href="{{ url_for('auth.quick_signup') }}">Create free account</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('auth.login') }}">Sign in</a>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="{{ url_for('static', filename='js/components/suggestions.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/tool_lines.js') }}"></script>
<script>
(function(){
  const TOOL_UNIT_OPTIONS_HTML = `{% for unit in global_units %}<option value="{{ unit.name }}">{{ unit.name }}</option>{% endfor %}`;
  const QUALITY_RANGES = {
    hardness: [29, 54],
    cleansing: [12, 22],
    conditioning: [44, 69],
    bubbly: [14, 46],
    creamy: [16, 48],
  };
  const QUALITY_HINTS = {
    hardness: 'Durable bar that resists mush.',
    cleansing: 'Higher values feel more stripping.',
    conditioning: 'Silky, moisturizing feel.',
    bubbly: 'Fluffy lather and big bubbles.',
    creamy: 'Stable, creamy lather.',
  };
  const QUALITY_FEEL_HINTS = {
    hardness: {
      low: 'Soft bar, slower unmold.',
      ok: 'Balanced hardness for daily use.',
      high: 'Very hard bar, can feel brittle.',
    },
    cleansing: {
      low: 'Very mild cleansing.',
      ok: 'Balanced cleansing.',
      high: 'Strong cleansing, can be drying.',
    },
    conditioning: {
      low: 'Less conditioning feel.',
      ok: 'Smooth and conditioning.',
      high: 'Very conditioning, may feel oily.',
    },
    bubbly: {
      low: 'Low bubbly lather.',
      ok: 'Balanced bubbly lather.',
      high: 'Very bubbly, big foam.',
    },
    creamy: {
      low: 'Light creamy lather.',
      ok: 'Creamy and stable.',
      high: 'Dense creamy lather.',
    },
  };
  const IODINE_RANGE = [41, 70];
  const IODINE_SCALE_MAX = 100;
  const INS_RANGE = [136, 170];
  const INS_SCALE_MAX = 250;
  const QUALITY_BASE = {
    hardness: (QUALITY_RANGES.hardness[0] + QUALITY_RANGES.hardness[1]) / 2,
    cleansing: (QUALITY_RANGES.cleansing[0] + QUALITY_RANGES.cleansing[1]) / 2,
    conditioning: (QUALITY_RANGES.conditioning[0] + QUALITY_RANGES.conditioning[1]) / 2,
    bubbly: (QUALITY_RANGES.bubbly[0] + QUALITY_RANGES.bubbly[1]) / 2,
    creamy: (QUALITY_RANGES.creamy[0] + QUALITY_RANGES.creamy[1]) / 2,
  };
  const QUALITY_PRESETS = {
    balanced: {
      hardness: 40,
      cleansing: 15,
      conditioning: 55,
      bubbly: 25,
      creamy: 25,
      iodine: 55,
      ins: 160,
    },
    bubbly: {
      hardness: 35,
      cleansing: 20,
      conditioning: 50,
      bubbly: 35,
      creamy: 25,
      iodine: 60,
      ins: 150,
    },
    creamy: {
      hardness: 45,
      cleansing: 12,
      conditioning: 60,
      bubbly: 20,
      creamy: 35,
      iodine: 50,
      ins: 155,
    },
    hard: {
      hardness: 50,
      cleansing: 18,
      conditioning: 48,
      bubbly: 22,
      creamy: 28,
      iodine: 45,
      ins: 165,
    },
    gentle: {
      hardness: 35,
      cleansing: 10,
      conditioning: 65,
      bubbly: 15,
      creamy: 20,
      iodine: 65,
      ins: 140,
    },
    castile: {
      hardness: 20,
      cleansing: 5,
      conditioning: 75,
      bubbly: 10,
      creamy: 15,
      iodine: 80,
      ins: 110,
    },
    shampoo: {
      hardness: 30,
      cleansing: 22,
      conditioning: 50,
      bubbly: 30,
      creamy: 25,
      iodine: 60,
      ins: 145,
    },
    utility: {
      hardness: 70,
      cleansing: 50,
      conditioning: 20,
      bubbly: 50,
      creamy: 20,
      iodine: 10,
      ins: 250,
    },
    luxury: {
      hardness: 55,
      cleansing: 10,
      conditioning: 55,
      bubbly: 15,
      creamy: 40,
      iodine: 50,
      ins: 150,
    },
    palmFree: {
      hardness: 42,
      cleansing: 16,
      conditioning: 58,
      bubbly: 22,
      creamy: 28,
      iodine: 55,
      ins: 155,
    },
  };
  const FATTY_BAR_COLORS = {
    lauric: '#0d6efd',
    myristic: '#6f42c1',
    palmitic: '#ffc107',
    stearic: '#adb5bd',
    ricinoleic: '#20c997',
    oleic: '#198754',
    linoleic: '#fd7e14',
    linolenic: '#dc3545',
  };
  const FATTY_DISPLAY_KEYS = [
    'lauric',
    'myristic',
    'palmitic',
    'stearic',
    'ricinoleic',
    'oleic',
    'linoleic',
    'linolenic',
  ];
  const OIL_TIP_RULES = [
    { match: /coconut|palm kernel|babassu|murumuru/i, tip: 'High lauric oils trace fast and feel cleansing; keep superfat >= 5%.' },
    { match: /olive|avocado|rice bran|canola|sunflower|safflower|almond|apricot|macadamia|camellia|grapeseed|hazelnut/i, tip: 'High-oleic liquid oils trace slowly and stay softer early on; allow a longer cure.' },
    { match: /castor/i, tip: 'Castor boosts lather but can feel sticky above 10-15%.' },
    { match: /cocoa|shea|mango|kokum|sal|illipe|tallow|lard|palm|stearic/i, tip: 'Hard fats/butters set up quickly; melt fully and keep batter warm for a smooth pour.' },
    { match: /beeswax|candelilla|carnauba|wax/i, tip: 'Waxes harden fast and can seize; keep usage low and add hot.' },
    { match: /hemp|flax|linseed|evening primrose|borage|rosehip|black currant|chia|pomegranate/i, tip: 'High-PUFA oils shorten shelf life; keep low and add antioxidant.' },
  ];
  const state = { lastCalc: null, lastOilEdit: null, selectedOilProfile: null, wasCapped: false, lastPreviewRow: null };
  const alertStack = document.getElementById('soapAlertStack');
  const STATE_STORAGE_KEY = 'soap_tool_state_v2';
  const CALC_LIMIT = Number.isFinite(window.SOAP_CALC_LIMIT) ? window.SOAP_CALC_LIMIT : null;
  const CALC_LIMIT_TIER = window.SOAP_CALC_TIER || 'guest';
  const UNIT_FACTORS = { g: 1, oz: 28.3495, lb: 453.592 };
  let currentUnit = 'g';
  const IS_AUTHENTICATED = window.__IS_AUTHENTICATED__ === true;
  const OIL_CATEGORY_SET = new Set(['Oils (Carrier & Fixed)', 'Butters & Solid Fats', 'Waxes']);
  const FRAGRANCE_CATEGORY_SET = new Set(['Essential Oils', 'Fragrance Oils']);
  const LACTATE_CATEGORY_SET = new Set(['Aqueous Solutions & Blends', 'Preservatives & Additives']);
  const SUGAR_CATEGORY_SET = new Set(['Sugars & Syrups']);
  const SALT_CATEGORY_SET = new Set(['Salts & Minerals']);
  const CITRIC_CATEGORY_SET = new Set(['Preservatives & Additives', 'Salts & Minerals', 'Aqueous Solutions & Blends']);

  const ALERT_ICONS = {
    info: 'fa-info-circle',
    warning: 'fa-exclamation-triangle',
    danger: 'fa-times-circle',
    success: 'fa-check-circle'
  };

  function showSoapAlert(type, message, options = {}){
    if (!alertStack) return;
    const icon = ALERT_ICONS[type] || ALERT_ICONS.info;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} d-flex align-items-start gap-2`;
    alert.innerHTML = `
      <i class="fas ${icon} mt-1"></i>
      <div class="flex-grow-1">${message}</div>
      ${options.dismissible ? '<button type="button" class="btn-close" data-role="dismiss"></button>' : ''}
    `;
    if (options.dismissible) {
      alert.querySelector('[data-role="dismiss"]')?.addEventListener('click', () => alert.remove());
    }
    alertStack.prepend(alert);
    if (!options.persist) {
      setTimeout(() => {
        if (alert.parentNode) alert.remove();
      }, options.timeoutMs || 4500);
    }
  }

  function clearSoapAlerts(){
    if (!alertStack) return;
    alertStack.querySelectorAll('.alert').forEach(el => el.remove());
  }

  function round(value, decimals = 3){
    if (!isFinite(value)) return 0;
    const factor = Math.pow(10, decimals);
    return Math.round(value * factor) / factor;
  }

  function toNumber(value){
    let cleaned = value;
    if (typeof cleaned === 'string') {
      cleaned = cleaned.replace(/,/g, '').trim();
    }
    const num = parseFloat(cleaned);
    return isFinite(num) ? num : 0;
  }

  function clamp(value, min, max){
    if (!isFinite(value)) return min;
    if (value < min) return min;
    if (max !== undefined && max !== null && value > max) return max;
    return value;
  }

  function toGrams(value){
    return clamp(toNumber(value), 0) * (UNIT_FACTORS[currentUnit] || 1);
  }

  function fromGrams(value){
    const grams = clamp(value, 0);
    return grams / (UNIT_FACTORS[currentUnit] || 1);
  }

  function updateUnitLabels(){
    document.querySelectorAll('.unit-label').forEach(el => {
      el.textContent = currentUnit;
    });
  }

  function setUnit(unit, options = {}){
    if (!unit) return;
    if (unit === currentUnit) {
      updateUnitLabels();
      return;
    }
    const prevUnit = currentUnit;
    currentUnit = unit;
    updateUnitLabels();
    if (options.skipConvert) return;
    const ratio = (UNIT_FACTORS[prevUnit] || 1) / (UNIT_FACTORS[unit] || 1);
    document.querySelectorAll('.oil-grams').forEach(input => {
      const value = toNumber(input.value);
      if (value > 0) input.value = round(value * ratio, 2);
    });
    const oilTarget = document.getElementById('oilTotalTarget');
    if (oilTarget && oilTarget.value) {
      const value = toNumber(oilTarget.value);
      if (value > 0) oilTarget.value = round(value * ratio, 2);
    }
    const moldWater = document.getElementById('moldWaterWeight');
    if (moldWater && moldWater.value) {
      const value = toNumber(moldWater.value);
      if (value > 0) moldWater.value = round(value * ratio, 2);
    }
    updateOilTotals();
    updateMoldSuggested();
    updateAdditivesOutput(getTotalOilsGrams());
    if (!options.skipAutoCalc) {
      calculateAll({ consumeQuota: false, showAlerts: false });
    }
  }

  function formatWeight(value){
    if (!isFinite(value) || value <= 0) return '--';
    return `${round(fromGrams(value), 2)} ${currentUnit}`;
  }

  function getTotalOilsGrams(){
    return state.totalOilsGrams || 0;
  }

  function formatPercent(value){
    if (!isFinite(value)) return '--';
    return `${round(value, 1)}%`;
  }

  function getItemCategoryName(item){
    if (!item || typeof item !== 'object') return null;
    return (item.ingredient && item.ingredient.ingredient_category_name)
      || item.ingredient_category_name
      || (item.ingredient_category && item.ingredient_category.name)
      || null;
  }

  function matchesCategory(item, allowedSet, source){
    const category = getItemCategoryName(item);
    if (!category) {
      return source === 'inventory';
    }
    return allowedSet.has(category);
  }

  function getLyeSelection(){
    const selected = document.querySelector('input[name="lye_type"]:checked')?.value || 'NaOH';
    const purityInput = document.getElementById('lyePurity');
    let purity = toNumber(purityInput?.value);
    const lyeType = selected === 'NaOH' ? 'NaOH' : 'KOH';
    if (selected === 'KOH90') {
      purity = 90;
    }
    return { selected, lyeType, purity };
  }

  function applyLyeSelection(){
    const purityInput = document.getElementById('lyePurity');
    if (!purityInput) return;
    const selection = getLyeSelection();
    if (selection.selected === 'KOH90') {
      purityInput.value = '90';
      purityInput.setAttribute('readonly', 'readonly');
      const hint = document.getElementById('lyePurityHint');
      if (hint) hint.textContent = '90% KOH selected (purity locked).';
    } else {
      purityInput.removeAttribute('readonly');
      const hint = document.getElementById('lyePurityHint');
      if (hint) hint.textContent = 'Most calculators assume 100%.';
    }
  }

  function attachOilTypeahead(row){
    const input = row.querySelector('.oil-typeahead');
    const hiddenSap = row.querySelector('.oil-sap-koh');
    const hiddenIodine = row.querySelector('.oil-iodine');
    const hiddenFatty = row.querySelector('.oil-fatty');
    const hiddenGi = row.querySelector('.oil-gi-id');
    const list = row.querySelector('[data-role="suggestions"]');
    if (!input || !list || typeof window.attachMergedInventoryGlobalTypeahead !== 'function') {
      return;
    }
    window.attachMergedInventoryGlobalTypeahead({
      inputEl: input,
      listEl: list,
      mode: IS_AUTHENTICATED ? 'recipe' : 'public',
      giHiddenEl: hiddenGi,
      includeInventory: IS_AUTHENTICATED,
      includeGlobal: true,
      ingredientFirst: true,
      searchType: 'ingredient',
      resultFilter: (item, source) => matchesCategory(item, OIL_CATEGORY_SET, source),
      requireHidden: false,
      onSelection: function(picked){
        if (hiddenSap) {
          hiddenSap.value = picked?.saponification_value || '';
        }
        if (hiddenIodine) {
          hiddenIodine.value = picked?.iodine_value || '';
        }
        if (hiddenFatty) {
          hiddenFatty.value = picked?.fatty_acid_profile ? JSON.stringify(picked.fatty_acid_profile) : '';
        }
        setSelectedOilProfile(picked);
        updateOilTotals();
        queueStateSave();
        queueAutoCalc();
      }
    });
    input.addEventListener('input', function(){
      if (!this.value.trim()) {
        if (hiddenSap) hiddenSap.value = '';
        if (hiddenIodine) hiddenIodine.value = '';
        if (hiddenFatty) hiddenFatty.value = '';
        if (hiddenGi) hiddenGi.value = '';
        clearSelectedOilProfile();
      }
    });
  }

  function attachAdditiveTypeahead(inputId, hiddenId, categorySet){
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const list = input?.parentElement?.querySelector('[data-role="suggestions"]');
    if (!input || !list || typeof window.attachMergedInventoryGlobalTypeahead !== 'function') return;
    window.attachMergedInventoryGlobalTypeahead({
      inputEl: input,
      listEl: list,
      mode: IS_AUTHENTICATED ? 'recipe' : 'public',
      giHiddenEl: hidden,
      includeInventory: IS_AUTHENTICATED,
      includeGlobal: true,
      ingredientFirst: false,
      searchType: 'ingredient',
      resultFilter: (item, source) => matchesCategory(item, categorySet, source),
      requireHidden: false,
      onSelection: function(){
        queueStateSave();
      }
    });
  }

  function buildOilRow(){
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end oil-row mb-2';
    row.innerHTML = `
      <div class="col-md-6">
        <label class="form-label">Oil, fat, or wax</label>
        <div class="position-relative">
          <input type="text" class="form-control oil-typeahead" placeholder="Search oils, butters, waxes...">
          <input type="hidden" class="oil-sap-koh">
          <input type="hidden" class="oil-iodine">
          <input type="hidden" class="oil-fatty">
          <input type="hidden" class="oil-gi-id">
          <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index:1050"></div>
        </div>
        <div class="form-text small text-muted">Filtered to oils, butters, and waxes.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Weight (<span class="unit-label">g</span>)</label>
        <input type="number" class="form-control oil-grams" min="0" step="0.1">
      </div>
      <div class="col-md-2">
        <label class="form-label">%</label>
        <input type="number" class="form-control oil-percent" min="0" step="0.1">
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-outline-danger remove-oil" type="button">Remove</button>
      </div>`;
    attachOilTypeahead(row);
    row.querySelectorAll('.unit-label').forEach(el => {
      el.textContent = currentUnit;
    });
    return row;
  }

  function getOilTargetGrams(){
    const mold = getMoldSettings();
    if (mold.targetOils > 0) return mold.targetOils;
    return toGrams(document.getElementById('oilTotalTarget').value);
  }

  function deriveTargetFromRows(rows){
    const derived = [];
    rows.forEach(row => {
      const grams = toGrams(row.querySelector('.oil-grams')?.value);
      const pct = clamp(toNumber(row.querySelector('.oil-percent')?.value), 0);
      if (grams > 0 && pct > 0) {
        derived.push(grams / (pct / 100));
      }
    });
    if (!derived.length) return 0;
    const sum = derived.reduce((acc, value) => acc + value, 0);
    return sum / derived.length;
  }

  function enforceOilTargetCap(rows, target){
    if (!state.lastOilEdit || !state.lastOilEdit.row) return false;
    const lastRow = state.lastOilEdit.row;
    const otherTotal = rows.reduce((acc, row) => {
      if (row === lastRow) return acc;
      return acc + toGrams(row.querySelector('.oil-grams')?.value);
    }, 0);
    const allowed = Math.max(0, target - otherTotal);
    const gramsInput = lastRow.querySelector('.oil-grams');
    const pctInput = lastRow.querySelector('.oil-percent');
    if (!gramsInput || !pctInput) return false;
    gramsInput.value = allowed > 0 ? round(fromGrams(allowed), 2) : '';
    pctInput.value = allowed > 0 ? round((allowed / target) * 100, 2) : '';
    state.wasCapped = true;
    return true;
  }

  function updateOilLimitWarning({ totalWeight, totalPct, target, capped }){
    const warning = document.getElementById('oilLimitWarning');
    if (!warning) return;
    const messages = [];
    if (capped) {
      messages.push('Oil total hit the mold cap and was adjusted.');
    }
    if (target > 0 && totalWeight > target + 0.01) {
      const over = totalWeight - target;
      messages.push(`Oil weights exceed the target by ${round(fromGrams(over), 2)} ${currentUnit}.`);
    }
    if (totalPct > 100.01) {
      messages.push(`Oil percentages are over 100% by ${round(totalPct - 100, 2)}%.`);
    }
    if (messages.length) {
      warning.classList.remove('d-none');
      warning.innerHTML = `${messages.join(' ')} Adjust oils or mold % to continue.`;
    } else {
      warning.classList.add('d-none');
      warning.textContent = '';
    }
  }

  function updateOilTotals(options = {}){
    if (!options.skipEnforce) {
      state.wasCapped = false;
    }
    const rows = Array.from(document.querySelectorAll('#oilRows .oil-row'));
    const mold = getMoldSettings();
    let target = getOilTargetGrams();
    if (!target && !mold.targetOils) {
      const derived = deriveTargetFromRows(rows);
      if (derived > 0) {
        target = derived;
        const targetInput = document.getElementById('oilTotalTarget');
        if (targetInput && !targetInput.value) {
          targetInput.value = round(fromGrams(derived), 2);
        }
      }
    }

    let totalWeight = 0;
    let totalPct = 0;

    rows.forEach(row => {
      const gramsInput = row.querySelector('.oil-grams');
      const pctInput = row.querySelector('.oil-percent');
      let grams = toGrams(gramsInput?.value);
      let pct = clamp(toNumber(pctInput?.value), 0);
      if (target > 0) {
        if (state.lastOilEdit && state.lastOilEdit.row === row && state.lastOilEdit.field === 'percent') {
          grams = pct > 0 ? target * (pct / 100) : 0;
          gramsInput.value = pct > 0 ? round(fromGrams(grams), 2) : '';
        } else {
          if (grams > 0) {
            pct = (grams / target) * 100;
            pctInput.value = round(pct, 2);
          } else if (pct > 0) {
            grams = target * (pct / 100);
            gramsInput.value = round(fromGrams(grams), 2);
          }
        }
        totalPct += pct;
      }
      if (grams > 0) totalWeight += grams;
    });

    if (target <= 0) {
      if (totalWeight > 0) {
        totalPct = 0;
        rows.forEach(row => {
          const gramsInput = row.querySelector('.oil-grams');
          const pctInput = row.querySelector('.oil-percent');
          const grams = toGrams(gramsInput?.value);
          if (grams > 0) {
            const pct = (grams / totalWeight) * 100;
            pctInput.value = round(pct, 2);
            totalPct += pct;
          }
        });
      } else {
        totalPct = rows.reduce((sum, row) => sum + clamp(toNumber(row.querySelector('.oil-percent')?.value), 0), 0);
      }
    }

    if (!options.skipEnforce && mold.targetOils > 0 && totalWeight > mold.targetOils + 0.01) {
      if (enforceOilTargetCap(rows, mold.targetOils)) {
        return updateOilTotals({ skipEnforce: true });
      }
    }

    state.totalOilsGrams = totalWeight;
    const totalLabel = document.getElementById('oilTotalComputed');
    if (totalLabel) {
      totalLabel.textContent = totalWeight > 0 ? `${round(fromGrams(totalWeight), 2)} ${currentUnit}` : '--';
    }
    document.getElementById('oilPercentTotal').textContent = round(totalPct, 2);
    updateOilLimitWarning({ totalWeight, totalPct, target, capped: state.wasCapped });
    updateAdditivesOutput(totalWeight);
    updateMoldSuggested();
    updateOilTips();
    return { totalWeight, totalPct, target };
  }

  function normalizeOils(){
    const rows = Array.from(document.querySelectorAll('#oilRows .oil-row'));
    if (!rows.length) return;
    const target = getOilTargetGrams();
    let totalPct = rows.reduce((sum, row) => sum + clamp(toNumber(row.querySelector('.oil-percent')?.value), 0), 0);
    if (!totalPct && target > 0) {
      totalPct = rows.reduce((sum, row) => {
        const grams = toGrams(row.querySelector('.oil-grams')?.value);
        return sum + (grams > 0 ? (grams / target) * 100 : 0);
      }, 0);
    }
    if (totalPct <= 0) return;
    rows.forEach(row => {
      const pctInput = row.querySelector('.oil-percent');
      const gramsInput = row.querySelector('.oil-grams');
      const pct = clamp(toNumber(pctInput.value), 0);
      const nextPct = (pct / totalPct) * 100;
      pctInput.value = round(nextPct, 2);
      if (target > 0) {
        gramsInput.value = nextPct > 0 ? round(fromGrams(target * (nextPct / 100)), 2) : '';
      }
    });
    updateOilTotals();
  }

  function collectOilData(){
    const oils = [];
    document.querySelectorAll('#oilRows .oil-row').forEach(row => {
      const name = row.querySelector('.oil-typeahead')?.value?.trim();
      const grams = toGrams(row.querySelector('.oil-grams')?.value);
      const sapKoh = toNumber(row.querySelector('.oil-sap-koh')?.value);
      const iodine = toNumber(row.querySelector('.oil-iodine')?.value);
      const fattyRaw = row.querySelector('.oil-fatty')?.value || '';
      const gi = row.querySelector('.oil-gi-id')?.value || '';
      let fattyProfile = null;
      if (fattyRaw) {
        try {
          fattyProfile = JSON.parse(fattyRaw);
        } catch (_) {
          fattyProfile = null;
        }
      }
      if (grams <= 0) return;
      oils.push({
        name: name || null,
        grams,
        sapKoh,
        iodine,
        fattyProfile,
        global_item_id: gi ? parseInt(gi) : null,
      });
    });
    return oils;
  }

  function updateSelectedOilProfileDisplay({ name, sapKoh, iodine, fattyProfile } = {}){
    const floatCard = document.getElementById('oilProfileFloat');
    const nameEl = document.getElementById('selectedOilName');
    if (nameEl) nameEl.textContent = name || 'Pick an oil to preview';
    if (floatCard) {
      floatCard.classList.toggle('d-none', !name);
    }
    const sapEl = document.getElementById('selectedOilSap');
    const iodineEl = document.getElementById('selectedOilIodine');
    if (sapEl) sapEl.textContent = sapKoh > 0 ? round(sapKoh, 1) : '--';
    if (iodineEl) iodineEl.textContent = iodine > 0 ? round(iodine, 1) : '--';

    const qualities = fattyProfile ? computeQualities(fattyProfile) : {};
    const setValue = (id, value) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = isFinite(value) && value > 0 ? round(value, 1) : '--';
    };
    setValue('selectedOilHardness', qualities.hardness);
    setValue('selectedOilCleansing', qualities.cleansing);
    setValue('selectedOilConditioning', qualities.conditioning);
    setValue('selectedOilBubbly', qualities.bubbly);
    setValue('selectedOilCreamy', qualities.creamy);

    const fattyKeys = ['lauric', 'myristic', 'palmitic', 'stearic', 'ricinoleic', 'oleic', 'linoleic', 'linolenic'];
    fattyKeys.forEach(key => {
      const el = document.getElementById(`selectedOil${key.charAt(0).toUpperCase()}${key.slice(1)}`);
      if (!el) return;
      const value = fattyProfile ? toNumber(fattyProfile[key]) : 0;
      el.textContent = value > 0 ? round(value, 1) : '--';
    });
  }

  function setSelectedOilProfile(picked){
    if (!picked) {
      clearSelectedOilProfile();
      return;
    }
    state.selectedOilProfile = picked;
    let fattyProfile = picked.fatty_acid_profile || null;
    if (typeof fattyProfile === 'string') {
      try {
        fattyProfile = JSON.parse(fattyProfile);
      } catch (_) {
        fattyProfile = null;
      }
    }
    updateSelectedOilProfileDisplay({
      name: picked.text || picked.display_name || picked.name,
      sapKoh: toNumber(picked.saponification_value),
      iodine: toNumber(picked.iodine_value),
      fattyProfile,
    });
  }

  function setSelectedOilProfileFromRow(row){
    if (!row) return;
    const name = row.querySelector('.oil-typeahead')?.value?.trim();
    const sapKoh = toNumber(row.querySelector('.oil-sap-koh')?.value);
    const iodine = toNumber(row.querySelector('.oil-iodine')?.value);
    const fattyRaw = row.querySelector('.oil-fatty')?.value || '';
    let fattyProfile = null;
    if (fattyRaw) {
      try {
        fattyProfile = JSON.parse(fattyRaw);
      } catch (_) {
        fattyProfile = null;
      }
    }
    updateSelectedOilProfileDisplay({
      name,
      sapKoh,
      iodine,
      fattyProfile,
    });
  }

  function clearSelectedOilProfile(){
    state.selectedOilProfile = null;
    state.lastPreviewRow = null;
    updateSelectedOilProfileDisplay();
  }

  function updateOilTips(){
    const tipBox = document.getElementById('oilBlendTips');
    if (!tipBox) return;
    const oils = collectOilData().filter(oil => oil.grams > 0 || oil.percent > 0);
    if (!oils.length) {
      tipBox.classList.add('d-none');
      tipBox.textContent = '';
      return;
    }
    const tips = new Set();
    oils.forEach(oil => {
      const name = (oil.name || '').toLowerCase();
      if (name) {
        OIL_TIP_RULES.forEach(rule => {
          if (rule.match.test(name)) tips.add(rule.tip);
        });
      }
      if (oil.fattyProfile && typeof oil.fattyProfile === 'object') {
        const lauric = toNumber(oil.fattyProfile.lauric);
        const myristic = toNumber(oil.fattyProfile.myristic);
        const palmitic = toNumber(oil.fattyProfile.palmitic);
        const stearic = toNumber(oil.fattyProfile.stearic);
        const ricinoleic = toNumber(oil.fattyProfile.ricinoleic);
        const oleic = toNumber(oil.fattyProfile.oleic);
        const linoleic = toNumber(oil.fattyProfile.linoleic);
        const linolenic = toNumber(oil.fattyProfile.linolenic);
        if (lauric + myristic >= 30) {
          tips.add(`${oil.name || 'This oil'} is high in lauric/myristic; expect faster trace and stronger cleansing.`);
        }
        if (palmitic + stearic >= 40) {
          tips.add(`${oil.name || 'This oil'} is high in palmitic/stearic; expect a harder bar and quicker set-up.`);
        }
        if (oleic >= 60) {
          tips.add(`${oil.name || 'This oil'} is high oleic; trace may be slow and bars may start softer.`);
        }
        if (linoleic + linolenic >= 20) {
          tips.add(`${oil.name || 'This oil'} is high in PUFAs; keep the % lower to reduce DOS risk.`);
        }
        if (ricinoleic >= 60) {
          tips.add(`${oil.name || 'This oil'} boosts lather but can feel tacky; keep under 10-15%.`);
        }
      }
    });
    const tipList = Array.from(tips).slice(0, 6);
    if (!tipList.length) {
      tipBox.classList.add('d-none');
      tipBox.textContent = '';
      return;
    }
    tipBox.classList.remove('d-none');
    tipBox.innerHTML = `<strong>Blend behavior tips:</strong><ul class="mb-0">${tipList.map(tip => `<li>${tip}</li>`).join('')}</ul>`;
  }

  function computeLyeTotals(oils, lyeType){
    let lyeTotal = 0;
    let sapWeighted = 0;
    let sapWeightG = 0;
    let totalWeight = 0;
    oils.forEach(oil => {
      totalWeight += oil.grams;
      if (oil.sapKoh > 0) {
        const perG = lyeType === 'KOH'
          ? (oil.sapKoh / 1000)
          : (oil.sapKoh * 0.713 / 1000);
        lyeTotal += oil.grams * perG;
        sapWeighted += oil.sapKoh * oil.grams;
        sapWeightG += oil.grams;
      }
    });
    const sapAvg = sapWeightG > 0 ? sapWeighted / sapWeightG : 0;
    const usedFallback = lyeTotal <= 0 && totalWeight > 0;
    if (usedFallback) {
      const fallbackPerG = lyeType === 'KOH' ? 0.194 : 0.138;
      lyeTotal = totalWeight * fallbackPerG;
    }
    return { lyeTotal, sapAvg, usedFallback };
  }

  function computeWater(lyeAdjusted, totalOils, method, waterPct, lyeConcentration, waterRatio){
    let waterG = 0;
    if (lyeAdjusted <= 0) {
      return { waterG: 0, lyeConcentration: 0, waterRatio: 0 };
    }
    if (method === 'concentration') {
      const conc = lyeConcentration > 0 ? lyeConcentration : 33;
      waterG = lyeAdjusted * ((100 - conc) / conc);
    } else if (method === 'ratio') {
      const ratio = waterRatio > 0 ? waterRatio : 2;
      waterG = lyeAdjusted * ratio;
    } else {
      const pct = waterPct > 0 ? waterPct : 33;
      waterG = totalOils * (pct / 100);
    }
    const lyeConc = waterG + lyeAdjusted > 0 ? (lyeAdjusted / (lyeAdjusted + waterG)) * 100 : 0;
    const ratio = lyeAdjusted > 0 ? (waterG / lyeAdjusted) : 0;
    return { waterG, lyeConcentration: lyeConc, waterRatio: ratio };
  }

  function computeIodine(oils){
    let totalWeight = 0;
    let weighted = 0;
    oils.forEach(oil => {
      if (oil.iodine > 0) {
        totalWeight += oil.grams;
        weighted += oil.iodine * oil.grams;
      }
    });
    return {
      iodine: totalWeight > 0 ? weighted / totalWeight : 0,
      coverageWeight: totalWeight,
    };
  }

  function computeFattyAcids(oils){
    const totals = {};
    let coveredWeight = 0;
    oils.forEach(oil => {
      if (!oil.fattyProfile || typeof oil.fattyProfile !== 'object') {
        return;
      }
      coveredWeight += oil.grams;
      Object.entries(oil.fattyProfile).forEach(([key, pct]) => {
        const value = toNumber(pct);
        if (value > 0) {
          totals[key] = (totals[key] || 0) + oil.grams * (value / 100);
        }
      });
    });
    const percent = {};
    if (coveredWeight > 0) {
      Object.entries(totals).forEach(([key, grams]) => {
        percent[key] = (grams / coveredWeight) * 100;
      });
    }
    return { percent, coveredWeight };
  }

  function computeQualities(fattyPercent){
    const get = key => fattyPercent[key] || 0;
    return {
      hardness: get('lauric') + get('myristic') + get('palmitic') + get('stearic'),
      cleansing: get('lauric') + get('myristic'),
      conditioning: get('oleic') + get('linoleic') + get('linolenic') + get('ricinoleic'),
      bubbly: get('lauric') + get('myristic') + get('ricinoleic'),
      creamy: get('palmitic') + get('stearic') + get('ricinoleic'),
    };
  }

  function setProgress(id, value, label){
    const bar = document.getElementById(id);
    if (!bar) return;
    if (!isFinite(value)) {
      bar.style.width = '0%';
      return;
    }
    const clamped = Math.max(0, Math.min(100, value));
    bar.style.width = `${clamped}%`;
    bar.setAttribute('aria-valuemin', '0');
    bar.setAttribute('aria-valuemax', '100');
    bar.setAttribute('aria-valuenow', clamped.toFixed(1));
    if (label) {
      bar.setAttribute('aria-label', label);
    }
  }

  function setQualityRangeBars(){
    Object.entries(QUALITY_RANGES).forEach(([key, range]) => {
      const [min, max] = range;
      const name = key.charAt(0).toUpperCase() + key.slice(1);
      const start = document.getElementById(`quality${name}RangeStart`);
      const ideal = document.getElementById(`quality${name}RangeIdeal`);
      const end = document.getElementById(`quality${name}RangeEnd`);
      if (!start || !ideal || !end) return;
      const startPct = Math.max(0, Math.min(100, min));
      const idealPct = Math.max(0, Math.min(100, max - min));
      const endPct = Math.max(0, 100 - max);
      start.style.width = `${startPct}%`;
      ideal.style.width = `${idealPct}%`;
      end.style.width = `${endPct}%`;
    });
  }

  function setQualityBarColor(bar, value, range){
    if (!bar || !range) return;
    bar.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');
    if (!isFinite(value)) {
      bar.classList.add('bg-secondary');
      return;
    }
    if (value < range[0]) {
      bar.classList.add('bg-warning');
    } else if (value > range[1]) {
      bar.classList.add('bg-danger');
    } else {
      bar.classList.add('bg-success');
    }
  }

  function setScaledBar(id, value, range, max, label){
    const bar = document.getElementById(id);
    if (!bar) return;
    const safeValue = isFinite(value) ? value : 0;
    const clamped = Math.max(0, Math.min(max, safeValue));
    const width = max > 0 ? (clamped / max) * 100 : 0;
    bar.style.width = `${width}%`;
    bar.setAttribute('aria-valuemin', '0');
    bar.setAttribute('aria-valuemax', String(max));
    bar.setAttribute('aria-valuenow', clamped.toFixed(1));
    if (label) {
      bar.setAttribute('aria-label', label);
    }
    setQualityBarColor(bar, safeValue, range);
  }

  function toggleQualitySliders(){
    const wrap = document.getElementById('qualitySliderWrap');
    const toggle = document.getElementById('qualitySliderToggle');
    if (!wrap || !toggle) return;
    wrap.classList.toggle('d-none', !toggle.checked);
  }

  function updateQualitySliders(qualities, superfat){
    const hardness = clamp(qualities.hardness || 0, 0, 100);
    const bubbly = clamp(qualities.bubbly || 0, 0, 100);
    const conditioning = clamp(qualities.conditioning || 0, 0, 100);
    const greasyScore = clamp(conditioning + (superfat || 0) * 3, 0, 100);
    const hardEl = document.getElementById('feelHardness');
    const bubblyEl = document.getElementById('feelBubbly');
    const conditioningEl = document.getElementById('feelConditioning');
    const greasyEl = document.getElementById('feelGreasy');
    if (hardEl) hardEl.value = round(hardness, 1);
    if (bubblyEl) bubblyEl.value = round(bubbly, 1);
    if (conditioningEl) conditioningEl.value = round(conditioning, 1);
    if (greasyEl) greasyEl.value = round(greasyScore, 1);
  }

  function updateFattyBar(fattyPercent){
    const totals = {};
    let total = 0;
    FATTY_DISPLAY_KEYS.forEach(key => {
      const value = clamp(toNumber(fattyPercent[key]), 0, 100);
      totals[key] = value;
      total += value;
    });
    FATTY_DISPLAY_KEYS.forEach(key => {
      const el = document.getElementById(`fattyBar${key.charAt(0).toUpperCase()}${key.slice(1)}`);
      if (!el) return;
      const width = total > 0 ? (totals[key] / total) * 100 : 0;
      el.style.width = `${width}%`;
      el.style.backgroundColor = FATTY_BAR_COLORS[key] || '#6c757d';
      el.title = `${key.charAt(0).toUpperCase()}${key.slice(1)}: ${round(totals[key], 1)}%`;
    });
  }

  function getQualityTargets(){
    const preset = document.getElementById('qualityPreset')?.value || 'balanced';
    const focusEls = Array.from(document.querySelectorAll('.quality-focus:checked'));
    if (preset === 'none' && !focusEls.length) return null;
    const base = preset === 'none'
      ? { ...QUALITY_BASE }
      : (QUALITY_PRESETS[preset] ? { ...QUALITY_PRESETS[preset] } : { ...QUALITY_BASE });
    focusEls.forEach(el => {
      const attr = el.dataset.attr;
      const direction = el.dataset.direction;
      const range = QUALITY_RANGES[attr];
      if (!range) return;
      base[attr] = direction === 'low' ? range[0] : range[1];
    });
    return base;
  }

  function updateQualityTargets(){
    const targets = getQualityTargets();
    const markers = {
      hardness: document.getElementById('qualityHardnessTarget'),
      cleansing: document.getElementById('qualityCleansingTarget'),
      conditioning: document.getElementById('qualityConditioningTarget'),
      bubbly: document.getElementById('qualityBubblyTarget'),
      creamy: document.getElementById('qualityCreamyTarget'),
      iodine: document.getElementById('iodineTarget'),
      ins: document.getElementById('insTarget'),
    };
    Object.entries(markers).forEach(([key, marker]) => {
      if (!marker) return;
      const labelEl = document.getElementById(`${marker.id}Label`);
      if (!targets) {
        marker.classList.add('d-none');
        if (labelEl) labelEl.textContent = '';
        return;
      }
      const value = toNumber(targets[key]);
      if (!isFinite(value)) {
        marker.classList.add('d-none');
        if (labelEl) labelEl.textContent = '';
        return;
      }
      const scaleMax = key === 'iodine' ? IODINE_SCALE_MAX : (key === 'ins' ? INS_SCALE_MAX : 100);
      const clamped = clamp(value, 0, scaleMax);
      marker.classList.remove('d-none');
      marker.style.left = `${(clamped / scaleMax) * 100}%`;
      marker.setAttribute('aria-label', `Apply ${key} target`);
      marker.setAttribute('role', 'button');
      marker.setAttribute('tabindex', '0');
      marker.title = `Target ${key}: ${round(value, 1)}`;
      if (labelEl) {
        labelEl.textContent = round(value, 1);
      }
    });
  }

  function computeOilQualityScores(fattyProfile){
    if (!fattyProfile || typeof fattyProfile !== 'object') {
      return {
        hardness: 0,
        cleansing: 0,
        conditioning: 0,
        bubbly: 0,
        creamy: 0,
      };
    }
    const profile = {
      lauric: toNumber(fattyProfile.lauric),
      myristic: toNumber(fattyProfile.myristic),
      palmitic: toNumber(fattyProfile.palmitic),
      stearic: toNumber(fattyProfile.stearic),
      ricinoleic: toNumber(fattyProfile.ricinoleic),
      oleic: toNumber(fattyProfile.oleic),
      linoleic: toNumber(fattyProfile.linoleic),
      linolenic: toNumber(fattyProfile.linolenic),
    };
    const qualities = computeQualities(profile);
    return {
      hardness: (qualities.hardness || 0) / 100,
      cleansing: (qualities.cleansing || 0) / 100,
      conditioning: (qualities.conditioning || 0) / 100,
      bubbly: (qualities.bubbly || 0) / 100,
      creamy: (qualities.creamy || 0) / 100,
    };
  }

  function applyQualityTargets(){
    const targets = getQualityTargets();
    if (!targets) {
      showSoapAlert('info', 'Select a quality target to nudge the blend.', { dismissible: true, timeoutMs: 5000 });
      return;
    }
    const rows = Array.from(document.querySelectorAll('#oilRows .oil-row'));
    const oils = rows.map(row => {
      const grams = toGrams(row.querySelector('.oil-grams')?.value);
      const fattyRaw = row.querySelector('.oil-fatty')?.value || '';
      let fattyProfile = null;
      if (fattyRaw) {
        try {
          fattyProfile = JSON.parse(fattyRaw);
        } catch (_) {
          fattyProfile = null;
        }
      }
      return { row, grams, fattyProfile };
    }).filter(item => item.grams > 0);

    if (!oils.length) {
      showSoapAlert('warning', 'Add oils before nudging toward a target.', { dismissible: true, timeoutMs: 5000 });
      return;
    }

    const fatty = computeFattyAcids(oils.map(oil => ({
      grams: oil.grams,
      fattyProfile: oil.fattyProfile,
    })));
    const currentQualities = computeQualities(fatty.percent);
    const deltas = {
      hardness: clamp((targets.hardness - currentQualities.hardness) / 100, -1, 1),
      cleansing: clamp((targets.cleansing - currentQualities.cleansing) / 100, -1, 1),
      conditioning: clamp((targets.conditioning - currentQualities.conditioning) / 100, -1, 1),
      bubbly: clamp((targets.bubbly - currentQualities.bubbly) / 100, -1, 1),
      creamy: clamp((targets.creamy - currentQualities.creamy) / 100, -1, 1),
    };

    const totalOils = oils.reduce((sum, oil) => sum + oil.grams, 0);
    const adjusted = [];
    let totalAdjusted = 0;
    const strength = 0.8;
    const missingFatty = oils.filter(oil => !oil.fattyProfile || typeof oil.fattyProfile !== 'object').length;
    if (missingFatty === oils.length) {
      showSoapAlert('warning', 'None of the selected oils have fatty acid data, so targets cannot be applied.', { dismissible: true, timeoutMs: 6000 });
      return;
    }
    if (missingFatty) {
      showSoapAlert('info', 'Some oils are missing fatty acid data. The nudge will only use oils with profiles.', { dismissible: true, timeoutMs: 5000 });
    }

    oils.forEach(oil => {
      const scores = computeOilQualityScores(oil.fattyProfile);
      const adjustment = (deltas.hardness * scores.hardness)
        + (deltas.cleansing * scores.cleansing)
        + (deltas.conditioning * scores.conditioning)
        + (deltas.bubbly * scores.bubbly)
        + (deltas.creamy * scores.creamy);
      const factor = clamp(1 + adjustment * strength, 0.2, 1.8);
      const next = oil.grams * factor;
      adjusted.push({ row: oil.row, grams: next });
      totalAdjusted += next;
    });

    if (totalAdjusted <= 0) {
      showSoapAlert('warning', 'Unable to adjust blend with current data.', { dismissible: true, timeoutMs: 5000 });
      return;
    }

    const scale = totalOils / totalAdjusted;
    const target = getOilTargetGrams() || totalOils;
    adjusted.forEach(item => {
      const grams = item.grams * scale;
      const gramsInput = item.row.querySelector('.oil-grams');
      const pctInput = item.row.querySelector('.oil-percent');
      if (gramsInput) gramsInput.value = grams > 0 ? round(fromGrams(grams), 2) : '';
      if (pctInput && target > 0) {
        const percent = (grams / target) * 100;
        pctInput.value = percent > 0 ? round(percent, 2) : '';
      }
    });

    updateOilTotals();
    queueStateSave();
    queueAutoCalc();
    showSoapAlert('info', 'Blend nudged toward selected targets. Re-check results and adjust as needed.', { dismissible: true, timeoutMs: 6000 });
  }

  function buildSoapNotesBlob(calc){
    const iodineData = computeIodine(calc.oils || []);
    const fatty = computeFattyAcids(calc.oils || []);
    const qualities = computeQualities(fatty.percent || {});
    const lyeTotals = computeLyeTotals(calc.oils || [], calc.lyeType);
    const ins = (lyeTotals.sapAvg && iodineData.iodine) ? (lyeTotals.sapAvg - iodineData.iodine) : 0;
    const mold = getMoldSettings();
    return {
      source: 'soap_tool',
      schema_version: 1,
      unit_display: currentUnit,
      input_mode: 'mixed',
      quality_preset: document.getElementById('qualityPreset')?.value || 'balanced',
      quality_focus: Array.from(document.querySelectorAll('.quality-focus:checked')).map(el => el.id),
      mold,
      oils: (calc.oils || []).map(oil => ({
        name: oil.name || null,
        grams: round(oil.grams || 0, 2),
        iodine: oil.iodine || null,
        sap_koh: oil.sapKoh || null,
        fatty_profile: oil.fattyProfile || null,
        global_item_id: oil.global_item_id || null,
      })),
      totals: {
        total_oils_g: round(calc.totalOils || 0, 2),
        batch_yield_g: round(calc.batchYield || 0, 2),
        lye_pure_g: round(calc.lyePure || 0, 2),
        lye_adjusted_g: round(calc.lyeAdjusted || 0, 2),
        water_g: round(calc.water || 0, 2),
      },
      lye: {
        lye_type: calc.lyeType,
        superfat: calc.superfat,
        purity: calc.purity,
        water_method: calc.waterMethod,
        water_pct: calc.waterPct,
        lye_concentration: calc.lyeConcentration,
        water_ratio: calc.waterRatio,
      },
      additives: {
        fragrance_pct: calc.additives?.fragrancePct || 0,
        lactate_pct: calc.additives?.lactatePct || 0,
        sugar_pct: calc.additives?.sugarPct || 0,
        salt_pct: calc.additives?.saltPct || 0,
        citric_pct: calc.additives?.citricPct || 0,
        fragrance_g: round(calc.additives?.fragranceG || 0, 2),
        lactate_g: round(calc.additives?.lactateG || 0, 2),
        sugar_g: round(calc.additives?.sugarG || 0, 2),
        salt_g: round(calc.additives?.saltG || 0, 2),
        citric_g: round(calc.additives?.citricG || 0, 2),
        citric_lye_g: round(calc.additives?.citricLyeG || 0, 2),
      },
      qualities: {
        hardness: round(qualities.hardness || 0, 1),
        cleansing: round(qualities.cleansing || 0, 1),
        conditioning: round(qualities.conditioning || 0, 1),
        bubbly: round(qualities.bubbly || 0, 1),
        creamy: round(qualities.creamy || 0, 1),
        iodine: round(iodineData.iodine || 0, 1),
        ins: round(ins || 0, 1),
        sap_avg: round(lyeTotals.sapAvg || 0, 1),
      },
      fatty_acids: fatty.percent || {},
      updated_at: new Date().toISOString(),
    };
  }

  function getAdditiveItem(nameId, giId, fallbackName){
    const name = document.getElementById(nameId)?.value?.trim();
    const giRaw = document.getElementById(giId)?.value || '';
    return {
      name: name || fallbackName,
      globalItemId: giRaw ? parseInt(giRaw) : undefined,
    };
  }

  function buildSoapRecipePayload(calc){
    const notesBlob = buildSoapNotesBlob(calc);
    const baseIngredients = (calc.oils || []).map(oil => ({
      name: oil.name || undefined,
      global_item_id: oil.global_item_id || undefined,
      quantity: oil.grams,
      unit: 'gram',
    }));
    const lyeName = calc.lyeType === 'KOH' ? 'Potassium Hydroxide (KOH)' : 'Sodium Hydroxide (NaOH)';
    if (calc.lyeAdjusted > 0) {
      baseIngredients.push({ name: lyeName, quantity: round(calc.lyeAdjusted, 2), unit: 'gram' });
    }
    if (calc.water > 0) {
      baseIngredients.push({ name: 'Distilled Water', quantity: round(calc.water, 2), unit: 'gram' });
    }
    if (calc.additives?.fragranceG > 0) {
      const item = getAdditiveItem('additiveFragranceName', 'additiveFragranceGi', 'Fragrance/Essential Oils');
      baseIngredients.push({ name: item.name, global_item_id: item.globalItemId, quantity: round(calc.additives.fragranceG, 2), unit: 'gram' });
    }
    if (calc.additives?.lactateG > 0) {
      const item = getAdditiveItem('additiveLactateName', 'additiveLactateGi', 'Sodium Lactate');
      baseIngredients.push({ name: item.name, global_item_id: item.globalItemId, quantity: round(calc.additives.lactateG, 2), unit: 'gram' });
    }
    if (calc.additives?.sugarG > 0) {
      const item = getAdditiveItem('additiveSugarName', 'additiveSugarGi', 'Sugar');
      baseIngredients.push({ name: item.name, global_item_id: item.globalItemId, quantity: round(calc.additives.sugarG, 2), unit: 'gram' });
    }
    if (calc.additives?.saltG > 0) {
      const item = getAdditiveItem('additiveSaltName', 'additiveSaltGi', 'Salt');
      baseIngredients.push({ name: item.name, global_item_id: item.globalItemId, quantity: round(calc.additives.saltG, 2), unit: 'gram' });
    }
    if (calc.additives?.citricG > 0) {
      const item = getAdditiveItem('additiveCitricName', 'additiveCitricGi', 'Citric Acid');
      baseIngredients.push({ name: item.name, global_item_id: item.globalItemId, quantity: round(calc.additives.citricG, 2), unit: 'gram' });
      baseIngredients.push({ name: 'Extra Lye for Citric Acid', quantity: round(calc.additives.citricLyeG, 2), unit: 'gram' });
    }
    return {
      name: 'Soap (Draft)',
      instructions: 'Draft from Soap Tools',
      predicted_yield: Math.round((calc.batchYield || 0) * 100) / 100,
      predicted_yield_unit: 'gram',
      category_name: 'Soaps',
      category_data: {
        soap_superfat: calc.superfat,
        soap_lye_type: calc.lyeType,
        soap_lye_purity: calc.purity,
        soap_water_method: calc.waterMethod,
        soap_water_pct: calc.waterPct,
        soap_lye_concentration: calc.lyeConcentration,
        soap_water_ratio: calc.waterRatio,
        soap_oils_total_g: calc.totalOils,
        soap_lye_g: calc.lyeAdjusted,
        soap_water_g: calc.water,
      },
      ingredients: baseIngredients.concat(collectDraftLines('tool-ingredients', 'ingredient')),
      consumables: collectDraftLines('tool-consumables', 'consumable'),
      containers: collectDraftLines('tool-containers', 'container'),
      notes: JSON.stringify(notesBlob),
    };
  }

  function applySectionOrder(order){
    const container = document.getElementById('soapAdvancedAccordion');
    if (!container || !Array.isArray(order)) return;
    const items = Array.from(container.querySelectorAll('.accordion-item'));
    const map = new Map(items.map(item => [item.dataset.section, item]));
    order.forEach(key => {
      const item = map.get(key);
      if (item) container.appendChild(item);
    });
    items.forEach(item => {
      if (!order.includes(item.dataset.section)) {
        container.appendChild(item);
      }
    });
  }

  function enableAccordionReorder(){
    const container = document.getElementById('soapAdvancedAccordion');
    if (!container) return;
    let dragged = null;
    container.querySelectorAll('.accordion-header').forEach(header => {
      header.setAttribute('draggable', 'true');
      header.style.cursor = 'grab';
      header.addEventListener('dragstart', event => {
        dragged = header.closest('.accordion-item');
        event.dataTransfer.effectAllowed = 'move';
      });
      header.addEventListener('dragend', () => {
        dragged = null;
      });
    });
    container.addEventListener('dragover', event => {
      event.preventDefault();
      const targetItem = event.target.closest('.accordion-item');
      if (!dragged || !targetItem || targetItem === dragged) return;
      const rect = targetItem.getBoundingClientRect();
      const after = (event.clientY - rect.top) > rect.height / 2;
      container.insertBefore(dragged, after ? targetItem.nextSibling : targetItem);
    });
    container.addEventListener('drop', () => {
      queueStateSave();
    });
  }

  function collectDraftLines(wrapperId, kind){
    const out = [];
    document.querySelectorAll(`#${wrapperId} .row`).forEach(function(row){
      const name = row.querySelector('.tool-typeahead')?.value?.trim();
      const gi = row.querySelector('.tool-gi-id')?.value || '';
      const qtyEl = row.querySelector('.tool-qty');
      const unitEl = row.querySelector('.tool-unit');
      const hasQty = qtyEl && qtyEl.value !== '';
      if (!name && !gi) return;
      if (kind === 'container'){
        out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 1 });
      } else {
        out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 0, unit: (unitEl?.value || '').trim() || 'gram' });
      }
    });
    return out;
  }

  function updateQualitiesDisplay(data){
    const {
      qualities,
      fattyPercent,
      coveragePct,
      iodine,
      ins,
      sapAvg,
      superfat,
      waterData,
      additives,
      oils,
      totalOils,
    } = data;

    const hasCoverage = coveragePct > 0;

    function setQuality(name, value){
      const label = document.getElementById(`quality${name}Value`);
      const bar = document.getElementById(`quality${name}Bar`);
      const hintEl = document.getElementById(`quality${name}Hint`);
      if (!label) return;
      label.textContent = hasCoverage && isFinite(value) ? round(value, 1) : '--';
      setProgress(`quality${name}Bar`, hasCoverage ? value : 0, name);
      const rangeKey = name.toLowerCase();
      const range = QUALITY_RANGES[rangeKey];
      if (bar && range) {
        setQualityBarColor(bar, value, range);
        if (hasCoverage && isFinite(value)) {
          bar.title = `${name}: ${round(value, 1)} (ideal ${range[0]}-${range[1]}). ${QUALITY_HINTS[rangeKey] || ''}`.trim();
        } else {
          bar.title = `${name}: -- (ideal ${range[0]}-${range[1]}). ${QUALITY_HINTS[rangeKey] || ''}`.trim();
        }
      }
      if (hintEl && range) {
        if (!hasCoverage || !isFinite(value)) {
          hintEl.textContent = 'Add oils to preview feel.';
        } else if (value < range[0]) {
          hintEl.textContent = QUALITY_FEEL_HINTS[rangeKey]?.low || '';
        } else if (value > range[1]) {
          hintEl.textContent = QUALITY_FEEL_HINTS[rangeKey]?.high || '';
        } else {
          hintEl.textContent = QUALITY_FEEL_HINTS[rangeKey]?.ok || '';
        }
      }
    }

    setQuality('Hardness', qualities.hardness);
    setQuality('Cleansing', qualities.cleansing);
    setQuality('Conditioning', qualities.conditioning);
    setQuality('Bubbly', qualities.bubbly);
    setQuality('Creamy', qualities.creamy);

    document.getElementById('fattyCoverageNote').textContent = coveragePct > 0
      ? `Fatty acid coverage: ${round(coveragePct, 1)}% of oils`
      : 'Fatty acid coverage: not enough data yet';

    document.getElementById('iodineValue').textContent = iodine > 0 ? round(iodine, 1) : '--';
    document.getElementById('insValue').textContent = ins > 0 ? round(ins, 1) : '--';
    document.getElementById('sapAvgValue').textContent = sapAvg > 0 ? round(sapAvg, 1) : '--';
    setScaledBar('iodineBar', iodine, IODINE_RANGE, IODINE_SCALE_MAX, 'Iodine');
    setScaledBar('insBar', ins, INS_RANGE, INS_SCALE_MAX, 'INS');

    const sat = (fattyPercent.lauric || 0) + (fattyPercent.myristic || 0) + (fattyPercent.palmitic || 0) + (fattyPercent.stearic || 0);
    const unsat = (fattyPercent.ricinoleic || 0) + (fattyPercent.oleic || 0) + (fattyPercent.linoleic || 0) + (fattyPercent.linolenic || 0);
    const ratioEl = document.getElementById('fattySatRatio');
    if (ratioEl) {
      ratioEl.textContent = (sat + unsat) > 0 ? `${round(sat, 0)}:${round(unsat, 0)}` : '--';
    }

    FATTY_DISPLAY_KEYS.forEach(key => {
      const id = `fatty${key.charAt(0).toUpperCase()}${key.slice(1)}`;
      const value = fattyPercent[key];
      document.getElementById(id).textContent = hasCoverage && value ? `${round(value, 1)}%` : '--';
    });
    updateQualitySliders(qualities, superfat || 0);
    updateFattyBar(fattyPercent);
    updateQualityTargets();

    const warnings = [];
    const pufa = (fattyPercent.linoleic || 0) + (fattyPercent.linolenic || 0);
    const lauricMyristic = (fattyPercent.lauric || 0) + (fattyPercent.myristic || 0);
    const concentration = waterData?.lyeConcentration || 0;

    if (iodine > 70) warnings.push('High iodine value can mean softer bars or faster rancidity.');
    if (ins > 0 && ins < 136) warnings.push('INS is low (below 136); bars may be soft or have shorter shelf life.');
    if (ins > 170) warnings.push('INS is high; bars may be brittle or overly cleansing.');
    if (hasCoverage && pufa > 15) warnings.push('High linoleic/linolenic (PUFA) increases DOS risk; consider antioxidant or more stable oils.');
    if (hasCoverage && isFinite(qualities.hardness) && qualities.hardness < QUALITY_RANGES.hardness[0]) warnings.push('Hardness looks low; bars may be soft or slow to unmold.');
    if (hasCoverage && isFinite(qualities.cleansing) && qualities.cleansing > QUALITY_RANGES.cleansing[1]) warnings.push('Cleansing is high; consider more conditioning oils.');
    if (hasCoverage && isFinite(qualities.bubbly) && qualities.bubbly < QUALITY_RANGES.bubbly[0]) warnings.push('Bubbly lather is low; add 5-10% castor or coconut for more foam.');
    if (hasCoverage && lauricMyristic > 35) warnings.push('High lauric/myristic (coconut/palm kernel/babassu) can be drying or crumbly; cut warm and keep superfat at least 5%.');
    if (superfat !== undefined && superfat >= 15) warnings.push('Superfat is high (15%+); bars can be softer/greasy and may have shorter shelf life.');
    if (concentration > 0 && concentration < 27) warnings.push('Very high water: slower trace and more shrinkage/ash. Consider a higher lye concentration for a firmer bar sooner.');
    if (concentration > 40) warnings.push('Low water: faster trace and more heat. Work quickly and avoid overheating.');
    if (additives?.fragrancePct > 3) warnings.push('Fragrance load above 3% can accelerate trace; follow supplier usage rates.');
    if (additives?.citricPct > 0) warnings.push('Citric acid consumes lye; extra lye has been added. Recheck if you also use vinegar or other acids.');
    if (Array.isArray(oils) && totalOils > 0) {
      const positiveOils = oils.filter(oil => oil.grams > 0);
      if (positiveOils.length === 1) {
        warnings.push('Single-oil recipe; consider blending for balanced hardness, cleansing, and longevity.');
      } else if (positiveOils.length > 1) {
        const maxShare = Math.max(...positiveOils.map(oil => (oil.grams / totalOils) * 100));
        if (maxShare >= 90) warnings.push('One oil is over 90% of the formula; consider blending for balance.');
      }
    }
    const warningBox = document.getElementById('soapQualityWarnings');
    if (warnings.length) {
      warningBox.classList.remove('d-none');
      warningBox.innerHTML = `<strong>Guidance & flags:</strong><ul class="mb-0">${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
    } else {
      warningBox.classList.add('d-none');
      warningBox.textContent = '';
    }
  }

  function updateVisualGuidance(data){
    const list = document.getElementById('soapVisualGuidanceList');
    if (!list) return;
    const tips = [];
    const waterConc = data?.waterData?.lyeConcentration || 0;
    const additives = data?.additives || {};
    const fattyPercent = data?.fattyPercent || {};
    const lauricMyristic = (fattyPercent.lauric || 0) + (fattyPercent.myristic || 0);

    if (waterConc > 0 && waterConc < 28) {
      tips.push('High water can cause soda ash, warping, or glycerin rivers; keep temps even or use less water.');
    }
    if (waterConc > 40) {
      tips.push('Low water (strong lye) can overheat or crack; soap cooler and watch for volcanoing.');
    }
    if (additives.sugarPct > 1) {
      tips.push('Sugars add heat; soap cooler to avoid cracking or glycerin rivers.');
    }
    if (additives.saltPct > 1) {
      tips.push('Salt can make bars brittle; cut sooner than usual.');
    }
    if (lauricMyristic > 35) {
      tips.push('High lauric oils can crumble if cut cold; cut warm for clean edges.');
    }
    if (!tips.length) {
      tips.push('No visual flags detected for this formula.');
    }

    list.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
  }

  function computeAdditives(totalOils, lyeType){
    const baseOils = clamp(totalOils, 0);
    const fragrancePct = clamp(toNumber(document.getElementById('additiveFragrancePct').value), 0, 100);
    const lactatePct = clamp(toNumber(document.getElementById('additiveLactatePct').value), 0, 100);
    const sugarPct = clamp(toNumber(document.getElementById('additiveSugarPct').value), 0, 100);
    const saltPct = clamp(toNumber(document.getElementById('additiveSaltPct').value), 0, 100);
    const citricPct = clamp(toNumber(document.getElementById('additiveCitricPct').value), 0, 100);
    const fragranceG = baseOils * (fragrancePct / 100);
    const lactateG = baseOils * (lactatePct / 100);
    const sugarG = baseOils * (sugarPct / 100);
    const saltG = baseOils * (saltPct / 100);
    const citricG = baseOils * (citricPct / 100);
    const citricLyeFactor = lyeType === 'KOH' ? 0.719 : 0.624;
    const citricLyeG = citricG * citricLyeFactor;
    return {
      fragrancePct,
      lactatePct,
      sugarPct,
      saltPct,
      citricPct,
      fragranceG,
      lactateG,
      sugarG,
      saltG,
      citricG,
      citricLyeG,
    };
  }

  function updateAdditivesOutput(totalOils){
    const lyeType = getLyeSelection().lyeType || 'NaOH';
    const outputs = computeAdditives(totalOils || 0, lyeType);
    document.getElementById('additiveFragranceOut').textContent = formatWeight(outputs.fragranceG);
    document.getElementById('additiveLactateOut').textContent = formatWeight(outputs.lactateG);
    document.getElementById('additiveSugarOut').textContent = formatWeight(outputs.sugarG);
    document.getElementById('additiveSaltOut').textContent = formatWeight(outputs.saltG);
    document.getElementById('additiveCitricOut').textContent = formatWeight(outputs.citricG);
    document.getElementById('additiveCitricLyeOut').textContent = formatWeight(outputs.citricLyeG);
    return outputs;
  }

  function updateMoldSuggested(){
    const settings = getMoldSettings();
    const targetInput = document.getElementById('oilTotalTarget');
    const targetHint = document.getElementById('oilTargetHint');
    if (settings.targetOils > 0 && targetInput) {
      targetInput.value = round(fromGrams(settings.targetOils), 2);
      targetInput.setAttribute('readonly', 'readonly');
      if (targetHint) targetHint.textContent = 'Derived from mold sizing.';
    } else if (targetInput) {
      targetInput.removeAttribute('readonly');
      if (targetHint) targetHint.textContent = 'Auto-fills when mold sizing is set.';
    }
    const note = document.getElementById('moldSuggestionNote');
    if (note) {
      let message = 'Target oils are capped to the mold size above.';
      if (settings.shape === 'cylinder' && settings.waterWeight > 0) {
        if (settings.useCylinder) {
          message = `Cylinder correction applied (${round(settings.cylinderFactor * 100, 0)}% of capacity).`;
        } else {
          message = 'Cylinder mold selected. Apply a correction if you want headspace or a smaller fill.';
        }
      }
      note.textContent = message;
    }
  }

  function getMoldSettings(){
    const waterWeight = toGrams(document.getElementById('moldWaterWeight').value);
    const oilPct = clamp(toNumber(document.getElementById('moldOilPct').value), 0, 100);
    const shape = document.getElementById('moldShape')?.value || 'loaf';
    const useCylinder = !!document.getElementById('moldCylinderCorrection')?.checked;
    const cylinderFactor = clamp(toNumber(document.getElementById('moldCylinderFactor')?.value), 0.5, 1);
    const effectiveCapacity = waterWeight > 0 ? waterWeight * (useCylinder ? cylinderFactor : 1) : 0;
    const targetOils = effectiveCapacity > 0 ? effectiveCapacity * (oilPct / 100) : 0;
    return {
      waterWeight,
      oilPct,
      shape,
      useCylinder,
      cylinderFactor,
      effectiveCapacity,
      targetOils,
    };
  }

  function updateMoldShapeUI(){
    const shape = document.getElementById('moldShape')?.value || 'loaf';
    const options = document.getElementById('moldCylinderOptions');
    if (options) {
      options.classList.toggle('d-none', shape !== 'cylinder');
    }
    updateMoldSuggested();
  }

  function setWaterMethod(){
    const method = document.getElementById('waterMethod').value;
    document.querySelectorAll('.water-input').forEach(el => {
      el.classList.toggle('d-none', el.dataset.method !== method);
    });
  }

  function getStorage(){
    try {
      return window.localStorage;
    } catch (_) {
      return null;
    }
  }

  function readCalcUsage(){
    if (!CALC_LIMIT) return { count: 0, date: null };
    const storage = getStorage();
    if (!storage) return { count: 0, date: null };
    try {
      const raw = storage.getItem('soap_calc_usage');
      const today = new Date().toISOString().slice(0, 10);
      if (!raw) return { count: 0, date: today };
      const data = JSON.parse(raw);
      if (!data || data.date !== today) {
        return { count: 0, date: today };
      }
      return { count: Number(data.count) || 0, date: today };
    } catch (_) {
      return { count: 0, date: null };
    }
  }

  function writeCalcUsage(count){
    if (!CALC_LIMIT) return;
    const storage = getStorage();
    if (!storage) return;
    const today = new Date().toISOString().slice(0, 10);
    try {
      storage.setItem('soap_calc_usage', JSON.stringify({ count, date: today }));
    } catch (_) {}
  }

  function canConsumeCalcQuota(){
    if (!CALC_LIMIT) return true;
    const usage = readCalcUsage();
    if (usage.count >= CALC_LIMIT) {
      showSoapAlert('warning', `You have reached the ${CALC_LIMIT} calculation limit for ${CALC_LIMIT_TIER} accounts. Create a free account or upgrade to keep calculating.`, { dismissible: true });
      return false;
    }
    return true;
  }

  function consumeCalcQuota(){
    if (!CALC_LIMIT) return;
    const usage = readCalcUsage();
    const nextCount = usage.count + 1;
    writeCalcUsage(nextCount);
    const remaining = Math.max(0, CALC_LIMIT - nextCount);
    if (remaining <= 1) {
      showSoapAlert('info', `You have ${remaining} calculation${remaining === 1 ? '' : 's'} left on the ${CALC_LIMIT_TIER} tier today.`, { dismissible: true, timeoutMs: 6000 });
    }
  }

  function getCalcRemaining(){
    if (!CALC_LIMIT) return null;
    const usage = readCalcUsage();
    return Math.max(0, CALC_LIMIT - usage.count);
  }

  function maybeShowSignupModal(remaining){
    if (!CALC_LIMIT || remaining === null || remaining > 1) return;
    const modalEl = document.getElementById('soapSignupModal');
    if (!modalEl) return;
    if (window.bootstrap && window.bootstrap.Modal) {
      const modal = window.bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    } else {
      showSoapAlert('info', 'You are almost at the free limit. Create a free account to keep saving your work.', { dismissible: true, timeoutMs: 7000 });
    }
  }

  function validateCalculation(){
    const totals = updateOilTotals();
    const totalOils = totals.totalWeight;
    const totalPct = totals.totalPct;
    const errors = [];
    const oils = collectOilData();
    const target = getOilTargetGrams();
    const percentInputs = Array.from(document.querySelectorAll('#oilRows .oil-percent'))
      .map(input => clamp(toNumber(input.value), 0));
    const hasPercent = percentInputs.some(value => value > 0);

    if (!oils.length || totalOils <= 0) {
      errors.push('Add at least one oil with a weight or percent.');
    }
    if (!target && totalOils <= 0 && hasPercent) {
      errors.push('Enter a total oils target or weights to convert percentages.');
    }
    if (target > 0 && totalPct > 0 && Math.abs(totalPct - 100) > 0.5) {
      errors.push('Oil percentages should total 100% (use Normalize to fix).');
    }
    if (target > 0 && totalOils > target + 0.01) {
      errors.push('Oil weights exceed the mold target.');
    } else if (!target && totalPct > 100.01) {
      errors.push('Oil percentages exceed 100%.');
    }
    return { ok: errors.length === 0, errors, totals, oils };
  }

  function sanitizeLyeInputs(){
    const selection = getLyeSelection();
    const purityInput = document.getElementById('lyePurity');
    let purity = selection.purity;
    if (!purity || purity <= 0) {
      purity = 100;
    }
    purity = Math.min(100, Math.max(90, purity));
    if (selection.selected === 'KOH90') {
      purity = 90;
    }
    if (purityInput) {
      purityInput.value = round(purity, 1);
    }

    const waterMethod = document.getElementById('waterMethod')?.value || 'percent';
    let waterPct = toNumber(document.getElementById('waterPct')?.value);
    let lyeConcentration = toNumber(document.getElementById('lyeConcentration')?.value);
    let waterRatio = toNumber(document.getElementById('waterRatio')?.value);

    if (waterMethod === 'percent') {
      if (!waterPct || waterPct <= 0) {
        waterPct = 33;
      }
      waterPct = clamp(waterPct, 20, 50);
      const input = document.getElementById('waterPct');
      if (input) input.value = round(waterPct, 1);
    }
    if (waterMethod === 'concentration') {
      if (!lyeConcentration || lyeConcentration <= 0) {
        lyeConcentration = 33;
      }
      lyeConcentration = clamp(lyeConcentration, 20, 50);
      const input = document.getElementById('lyeConcentration');
      if (input) input.value = round(lyeConcentration, 1);
    }
    if (waterMethod === 'ratio') {
      if (!waterRatio || waterRatio <= 0) {
        waterRatio = 2;
      }
      waterRatio = clamp(waterRatio, 1, 4);
      const input = document.getElementById('waterRatio');
      if (input) input.value = round(waterRatio, 2);
    }

    return { purity, waterMethod, waterPct, lyeConcentration, waterRatio };
  }

  function calculateAll(options = {}){
    const settings = {
      consumeQuota: false,
      showAlerts: true,
      ...options
    };
    if (settings.showAlerts) {
      clearSoapAlerts();
    }
    const validation = validateCalculation();
    if (!validation.ok) {
      if (settings.showAlerts) {
        showSoapAlert('warning', `<strong>Missing info:</strong><ul class="mb-0">${validation.errors.map(err => `<li>${err}</li>`).join('')}</ul>`, { dismissible: true, persist: true });
      }
      return null;
    }
    if (settings.consumeQuota && !canConsumeCalcQuota()) {
      return null;
    }
    const superfatInput = document.getElementById('lyeSuperfat');
    const superfatRaw = superfatInput?.value;
    let superfat = toNumber(superfatRaw);
    if (superfatRaw === '' || superfatRaw === null || superfatRaw === undefined) {
      superfat = 5;
    }
    superfat = clamp(superfat, 0, 20);
    if (superfatInput) superfatInput.value = round(superfat, 1);
    const selection = getLyeSelection();
    const lyeType = selection.lyeType || 'NaOH';
    const sanitized = sanitizeLyeInputs();
    const purity = sanitized.purity;
    const waterMethod = sanitized.waterMethod;
    const waterPct = sanitized.waterPct;
    const lyeConcentration = sanitized.lyeConcentration;
    const waterRatio = sanitized.waterRatio;

    let oils = validation.oils;
    let totalOils = validation.totals.totalWeight;
    const lyeTotals = computeLyeTotals(oils, lyeType);
    const lyePure = lyeTotals.lyeTotal * (1 - superfat / 100);
    const lyeAdjusted = purity > 0 ? lyePure / (purity / 100) : lyePure;
    const waterData = computeWater(lyeAdjusted, totalOils, waterMethod, waterPct, lyeConcentration, waterRatio);
    const additives = updateAdditivesOutput(totalOils);
    const batchYield = totalOils + lyeAdjusted + waterData.waterG + additives.fragranceG + additives.lactateG + additives.sugarG + additives.saltG + additives.citricG;

    document.getElementById('resultsCard').style.display = 'block';
    document.getElementById('lyeAdjustedOutput').textContent = formatWeight(lyeAdjusted);
    document.getElementById('waterOutput').textContent = formatWeight(waterData.waterG);
    document.getElementById('batchYieldOutput').textContent = formatWeight(batchYield);
    document.getElementById('lyeConcentrationOutput').textContent = formatPercent(waterData.lyeConcentration);
    document.getElementById('waterRatioOutput').textContent = isFinite(waterData.waterRatio) && waterData.waterRatio > 0
      ? round(waterData.waterRatio, 2).toString()
      : '--';
    document.getElementById('totalOilsOutput').textContent = formatWeight(totalOils);
    document.getElementById('superfatOutput').textContent = formatPercent(superfat);

    const iodineData = computeIodine(oils);
    const fatty = computeFattyAcids(oils);
    const qualities = computeQualities(fatty.percent);
    const ins = (lyeTotals.sapAvg && iodineData.iodine) ? (lyeTotals.sapAvg - iodineData.iodine) : 0;
    const coveragePct = totalOils > 0 ? (fatty.coveredWeight / totalOils) * 100 : 0;
    updateQualitiesDisplay({
      qualities,
      fattyPercent: fatty.percent,
      coveragePct,
      iodine: iodineData.iodine,
      ins,
      sapAvg: lyeTotals.sapAvg,
      superfat,
      waterData,
      additives,
      oils,
      totalOils,
    });
    updateVisualGuidance({
      fattyPercent: fatty.percent,
      waterData,
      additives,
    });

    if (settings.showAlerts) {
      if (lyeTotals.usedFallback) {
        showSoapAlert('info', 'Some oils are missing SAP values, so an average SAP was used. Select oils with SAP data for the most accurate lye calculation.', { dismissible: true, timeoutMs: 7000 });
      }
      if (purity < 100) {
        showSoapAlert('info', `Lye purity is set to ${round(purity, 1)}%. Adjusting lye to match your real-world purity.`, { dismissible: true, timeoutMs: 6000 });
      }
      if (waterData.lyeConcentration < 25 || waterData.lyeConcentration > 45) {
        showSoapAlert('warning', 'Your lye concentration is outside the common 25-45% range. Expect slower or faster trace.', { dismissible: true, timeoutMs: 7000 });
      }
      const mold = getMoldSettings();
      if (mold.shape === 'cylinder' && mold.waterWeight > 0 && !mold.useCylinder) {
        showSoapAlert('info', 'Cylinder mold selected. Enable the cylinder correction if you want to leave headspace or reduce spill risk.', { dismissible: true, timeoutMs: 7000 });
      }
    }

    state.lastCalc = {
      totalOils,
      oils,
      lyeType,
      superfat,
      purity,
      lyePure,
      lyeAdjusted,
      water: waterData.waterG,
      waterMethod,
      waterPct,
      lyeConcentration: waterData.lyeConcentration,
      waterRatio: waterData.waterRatio,
      additives,
      batchYield,
    };
    if (settings.consumeQuota) {
      consumeCalcQuota();
    }
    return state.lastCalc;
  }

  function buildLineRow(kind){
    const context = IS_AUTHENTICATED ? 'member' : 'public';
    const mode = IS_AUTHENTICATED ? 'recipe' : 'public';
    return buildToolLineRow(kind, { context, mode, unitOptionsHtml: TOOL_UNIT_OPTIONS_HTML });
  }

  function addStubLine(kind, name){
    const row = buildLineRow(kind);
    const input = row.querySelector('.tool-typeahead');
    const qty = row.querySelector('.tool-qty');
    if (input) {
      input.value = name;
    }
    if (qty && kind === 'container') {
      qty.value = 1;
    }
    if (kind === 'container') {
      document.getElementById('tool-containers').appendChild(row);
    } else if (kind === 'consumable') {
      document.getElementById('tool-consumables').appendChild(row);
    } else {
      document.getElementById('tool-ingredients').appendChild(row);
    }
  }

  function serializeLines(wrapperId, kind){
    const out = [];
    const rows = document.querySelectorAll(`#${wrapperId} .row`);
    rows.forEach(row => {
      const name = row.querySelector('.tool-typeahead')?.value?.trim();
      const gi = row.querySelector('.tool-gi-id')?.value || '';
      const qtyEl = row.querySelector('.tool-qty');
      const unitEl = row.querySelector('.tool-unit');
      const qty = qtyEl && qtyEl.value !== '' ? toNumber(qtyEl.value) : null;
      if (!name && !gi) return;
      if (kind === 'container') {
        out.push({
          name: name || '',
          global_item_id: gi ? parseInt(gi) : null,
          quantity: qty && qty > 0 ? qty : 1,
        });
      } else {
        out.push({
          name: name || '',
          global_item_id: gi ? parseInt(gi) : null,
          quantity: qty && qty >= 0 ? qty : 0,
          unit: unitEl?.value || 'gram',
        });
      }
    });
    return out;
  }

  function serializeOils(){
    const oils = [];
    document.querySelectorAll('#oilRows .oil-row').forEach(row => {
      const name = row.querySelector('.oil-typeahead')?.value?.trim() || '';
      const grams = row.querySelector('.oil-grams')?.value || '';
      const percent = row.querySelector('.oil-percent')?.value || '';
      const sap = row.querySelector('.oil-sap-koh')?.value || '';
      const iodine = row.querySelector('.oil-iodine')?.value || '';
      const fattyRaw = row.querySelector('.oil-fatty')?.value || '';
      const gi = row.querySelector('.oil-gi-id')?.value || '';
      if (!name && !grams && !percent && !gi) return;
      oils.push({
        name,
        grams,
        percent,
        sap,
        iodine,
        fattyRaw,
        gi,
      });
    });
    return oils;
  }

  function saveState(){
    const storage = getStorage();
    if (!storage) return;
    const payload = {
      version: 2,
      unit: currentUnit,
      oil_total_target: document.getElementById('oilTotalTarget').value || '',
      oils: serializeOils(),
      lye_form: {
        superfat: document.getElementById('lyeSuperfat')?.value || '5',
        lye_type: document.querySelector('input[name="lye_type"]:checked')?.value || 'NaOH',
        lye_purity: document.getElementById('lyePurity')?.value || '100',
        water_method: document.getElementById('waterMethod')?.value || 'percent',
        water_pct: document.getElementById('waterPct')?.value || '33',
        lye_concentration: document.getElementById('lyeConcentration')?.value || '33',
        water_ratio: document.getElementById('waterRatio')?.value || '2',
      },
      additives: {
        fragrance_pct: document.getElementById('additiveFragrancePct').value || '3',
        fragrance_name: document.getElementById('additiveFragranceName')?.value || '',
        fragrance_gi: document.getElementById('additiveFragranceGi')?.value || '',
        lactate_pct: document.getElementById('additiveLactatePct').value || '1',
        lactate_name: document.getElementById('additiveLactateName')?.value || '',
        lactate_gi: document.getElementById('additiveLactateGi')?.value || '',
        sugar_pct: document.getElementById('additiveSugarPct').value || '1',
        sugar_name: document.getElementById('additiveSugarName')?.value || '',
        sugar_gi: document.getElementById('additiveSugarGi')?.value || '',
        salt_pct: document.getElementById('additiveSaltPct').value || '0.5',
        salt_name: document.getElementById('additiveSaltName')?.value || '',
        salt_gi: document.getElementById('additiveSaltGi')?.value || '',
        citric_pct: document.getElementById('additiveCitricPct').value || '0',
        citric_name: document.getElementById('additiveCitricName')?.value || '',
        citric_gi: document.getElementById('additiveCitricGi')?.value || '',
      },
      mold: {
        water_weight: document.getElementById('moldWaterWeight').value || '',
        oil_pct: document.getElementById('moldOilPct').value || '65',
        shape: document.getElementById('moldShape')?.value || 'loaf',
        cylinder_correction: !!document.getElementById('moldCylinderCorrection')?.checked,
        cylinder_factor: document.getElementById('moldCylinderFactor')?.value || '0.85',
      },
      quality: {
        preset: document.getElementById('qualityPreset')?.value || 'balanced',
        focus: Array.from(document.querySelectorAll('.quality-focus:checked')).map(el => el.id),
      },
      lines: {
        ingredients: serializeLines('tool-ingredients', 'ingredient'),
        consumables: serializeLines('tool-consumables', 'consumable'),
        containers: serializeLines('tool-containers', 'container'),
      },
      updated_at: Date.now(),
    };
    try {
      storage.setItem(STATE_STORAGE_KEY, JSON.stringify(payload));
    } catch (_) {}
  }

  function restoreState(){
    const storage = getStorage();
    if (!storage) return;
    const raw = storage.getItem(STATE_STORAGE_KEY);
    if (!raw) return;
    let data = null;
    try {
      data = JSON.parse(raw);
    } catch (_) {
      return;
    }
    if (!data || typeof data !== 'object') return;

    if (data.unit) {
      const unitInput = document.querySelector(`input[name="weight_unit"][value="${data.unit}"]`);
      if (unitInput) unitInput.checked = true;
      setUnit(data.unit, { skipConvert: true, skipAutoCalc: true });
    }

    if (data.oil_total_target !== undefined) {
      document.getElementById('oilTotalTarget').value = data.oil_total_target;
    }

    const oilRows = document.getElementById('oilRows');
    if (oilRows) {
      oilRows.innerHTML = '';
      const oils = Array.isArray(data.oils) && data.oils.length ? data.oils : [{}];
      oils.forEach(oil => {
        const row = buildOilRow();
        row.querySelector('.oil-typeahead').value = oil.name || '';
        row.querySelector('.oil-grams').value = oil.grams || '';
        row.querySelector('.oil-percent').value = oil.percent || '';
        row.querySelector('.oil-sap-koh').value = oil.sap || '';
        row.querySelector('.oil-iodine').value = oil.iodine || '';
        row.querySelector('.oil-fatty').value = oil.fattyRaw || '';
        row.querySelector('.oil-gi-id').value = oil.gi || '';
        oilRows.appendChild(row);
      });
    }

    if (data.lye_form) {
      const superfat = document.getElementById('lyeSuperfat');
      if (superfat) superfat.value = data.lye_form.superfat || '5';
      const lyeType = document.querySelector(`input[name="lye_type"][value="${data.lye_form.lye_type || 'NaOH'}"]`);
      if (lyeType) lyeType.checked = true;
      const purity = document.getElementById('lyePurity');
      if (purity) purity.value = data.lye_form.lye_purity || '100';
      const waterMethod = document.getElementById('waterMethod');
      if (waterMethod) waterMethod.value = data.lye_form.water_method || 'percent';
      const waterPct = document.getElementById('waterPct');
      if (waterPct) waterPct.value = data.lye_form.water_pct || '33';
      const lyeConcentration = document.getElementById('lyeConcentration');
      if (lyeConcentration) lyeConcentration.value = data.lye_form.lye_concentration || '33';
      const waterRatio = document.getElementById('waterRatio');
      if (waterRatio) waterRatio.value = data.lye_form.water_ratio || '2';
      applyLyeSelection();
    }

    if (data.additives) {
      document.getElementById('additiveFragrancePct').value = data.additives.fragrance_pct || '3';
      const fragranceName = document.getElementById('additiveFragranceName');
      if (fragranceName) fragranceName.value = data.additives.fragrance_name || '';
      const fragranceGi = document.getElementById('additiveFragranceGi');
      if (fragranceGi) fragranceGi.value = data.additives.fragrance_gi || '';
      document.getElementById('additiveLactatePct').value = data.additives.lactate_pct || '1';
      const lactateName = document.getElementById('additiveLactateName');
      if (lactateName) lactateName.value = data.additives.lactate_name || '';
      const lactateGi = document.getElementById('additiveLactateGi');
      if (lactateGi) lactateGi.value = data.additives.lactate_gi || '';
      document.getElementById('additiveSugarPct').value = data.additives.sugar_pct || '1';
      const sugarName = document.getElementById('additiveSugarName');
      if (sugarName) sugarName.value = data.additives.sugar_name || '';
      const sugarGi = document.getElementById('additiveSugarGi');
      if (sugarGi) sugarGi.value = data.additives.sugar_gi || '';
      document.getElementById('additiveSaltPct').value = data.additives.salt_pct || '0.5';
      const saltName = document.getElementById('additiveSaltName');
      if (saltName) saltName.value = data.additives.salt_name || '';
      const saltGi = document.getElementById('additiveSaltGi');
      if (saltGi) saltGi.value = data.additives.salt_gi || '';
      document.getElementById('additiveCitricPct').value = data.additives.citric_pct || '0';
      const citricName = document.getElementById('additiveCitricName');
      if (citricName) citricName.value = data.additives.citric_name || '';
      const citricGi = document.getElementById('additiveCitricGi');
      if (citricGi) citricGi.value = data.additives.citric_gi || '';
    }

    if (data.mold) {
      document.getElementById('moldWaterWeight').value = data.mold.water_weight || '';
      document.getElementById('moldOilPct').value = data.mold.oil_pct || '65';
      const moldShape = document.getElementById('moldShape');
      if (moldShape) moldShape.value = data.mold.shape || 'loaf';
      const cylCorrection = document.getElementById('moldCylinderCorrection');
      if (cylCorrection) cylCorrection.checked = !!data.mold.cylinder_correction;
      const cylFactor = document.getElementById('moldCylinderFactor');
      if (cylFactor) cylFactor.value = data.mold.cylinder_factor || '0.85';
    }
    if (data.quality) {
      const preset = document.getElementById('qualityPreset');
      if (preset) {
        const desired = data.quality.preset || 'balanced';
        const option = Array.from(preset.options).find(opt => opt.value === desired);
        preset.value = option ? desired : 'balanced';
      }
      document.querySelectorAll('.quality-focus').forEach(el => {
        el.checked = Array.isArray(data.quality.focus) && data.quality.focus.includes(el.id);
      });
    }

    function restoreLines(wrapperId, items, kind){
      const wrapper = document.getElementById(wrapperId);
      if (!wrapper) return;
      wrapper.innerHTML = '';
      (items || []).forEach(item => {
        const row = buildLineRow(kind);
        const input = row.querySelector('.tool-typeahead');
        const giHidden = row.querySelector('.tool-gi-id');
        const qtyEl = row.querySelector('.tool-qty');
        const unitEl = row.querySelector('.tool-unit');
        if (input) input.value = item.name || '';
        if (giHidden) giHidden.value = item.global_item_id || '';
        if (qtyEl && item.quantity !== undefined && item.quantity !== null) qtyEl.value = item.quantity;
        if (unitEl && item.unit) {
          const option = Array.from(unitEl.options).find(opt => opt.value === item.unit);
          if (option) unitEl.value = item.unit;
        }
        wrapper.appendChild(row);
      });
    }

    if (data.lines) {
      restoreLines('tool-ingredients', data.lines.ingredients, 'ingredient');
      restoreLines('tool-consumables', data.lines.consumables, 'consumable');
      restoreLines('tool-containers', data.lines.containers, 'container');
    }

    setWaterMethod();
    updateMoldShapeUI();
    updateQualityTargets();
    updateOilTotals();
    updateAdditivesOutput(getTotalOilsGrams());
    updateMoldSuggested();
    calculateAll({ consumeQuota: false, showAlerts: false });
    showSoapAlert('info', 'Restored your last soap tool session from this device.', { dismissible: true, timeoutMs: 5000 });
  }

  let saveStateTimer = null;
  function queueStateSave(){
    if (saveStateTimer) clearTimeout(saveStateTimer);
    saveStateTimer = setTimeout(saveState, 350);
  }

  let autoCalcTimer = null;
  function queueAutoCalc(){
    if (autoCalcTimer) clearTimeout(autoCalcTimer);
    autoCalcTimer = setTimeout(() => {
      calculateAll({ consumeQuota: false, showAlerts: false });
    }, 350);
  }

  document.getElementById('addOil').addEventListener('click', function(){
    document.getElementById('oilRows').appendChild(buildOilRow());
    queueStateSave();
  });

  document.getElementById('normalizeOils').addEventListener('click', function(){
    normalizeOils();
    queueStateSave();
    queueAutoCalc();
  });

  document.getElementById('oilRows').addEventListener('input', function(e){
    if (e.target.classList.contains('oil-grams')) {
      state.lastOilEdit = { row: e.target.closest('.oil-row'), field: 'grams' };
    }
    if (e.target.classList.contains('oil-percent')) {
      state.lastOilEdit = { row: e.target.closest('.oil-row'), field: 'percent' };
    }
    if (e.target.classList.contains('oil-grams')
      || e.target.classList.contains('oil-percent')
      || e.target.classList.contains('oil-typeahead')) {
      if (e.target.classList.contains('oil-typeahead')) {
        setSelectedOilProfileFromRow(e.target.closest('.oil-row'));
      }
      updateOilTotals();
      queueStateSave();
      queueAutoCalc();
    }
  });

  document.getElementById('oilRows').addEventListener('focusin', function(e){
    if (e.target.classList.contains('oil-typeahead')) {
      setSelectedOilProfileFromRow(e.target.closest('.oil-row'));
    }
  });

  document.getElementById('oilRows').addEventListener('focusout', function(e){
    if (e.target.classList.contains('oil-typeahead')) {
      clearSelectedOilProfile();
    }
  });

  document.getElementById('oilRows').addEventListener('mouseover', function(e){
    if (!e.target.classList.contains('oil-typeahead')) return;
    const row = e.target.closest('.oil-row');
    if (!row || row === state.lastPreviewRow) return;
    state.lastPreviewRow = row;
    setSelectedOilProfileFromRow(row);
  });

  document.getElementById('oilRows').addEventListener('mouseout', function(e){
    if (e.target.classList.contains('oil-typeahead')) {
      clearSelectedOilProfile();
    }
  });

  document.getElementById('oilRows').addEventListener('click', function(e){
    if (e.target.classList.contains('remove-oil')) {
      const row = e.target.closest('.oil-row');
      if (row && state.lastOilEdit && state.lastOilEdit.row === row) {
        state.lastOilEdit = null;
        clearSelectedOilProfile();
      }
      if (row) row.remove();
      updateOilTotals();
      queueStateSave();
    }
  });

  document.querySelectorAll('input[name="weight_unit"]').forEach(el => {
    el.addEventListener('change', function(){
      setUnit(this.value);
      queueStateSave();
    });
  });

  document.getElementById('oilTotalTarget').addEventListener('input', function(){
    updateOilTotals();
    queueStateSave();
    queueAutoCalc();
  });

  document.getElementById('waterMethod').addEventListener('change', function(){
    setWaterMethod();
    queueStateSave();
    queueAutoCalc();
  });

  document.querySelectorAll('input[name="lye_type"]').forEach(el => {
    el.addEventListener('change', function(){
      applyLyeSelection();
      updateAdditivesOutput(getTotalOilsGrams());
      queueStateSave();
      queueAutoCalc();
    });
  });

  ['lyeSuperfat', 'lyePurity', 'waterPct', 'lyeConcentration', 'waterRatio'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    ['input', 'change'].forEach(eventName => {
      el.addEventListener(eventName, () => {
        queueStateSave();
        queueAutoCalc();
      });
    });
  });

  ['additiveFragrancePct', 'additiveLactatePct', 'additiveSugarPct', 'additiveSaltPct', 'additiveCitricPct']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        updateAdditivesOutput(getTotalOilsGrams());
        queueStateSave();
        queueAutoCalc();
      });
    });

  document.querySelectorAll('.additive-typeahead').forEach(input => {
    input.addEventListener('input', () => {
      queueStateSave();
    });
  });

  const qualityPreset = document.getElementById('qualityPreset');
  if (qualityPreset) {
    qualityPreset.addEventListener('change', function(){
      updateQualityTargets();
      queueStateSave();
    });
  }
  document.querySelectorAll('.quality-focus').forEach(el => {
    el.addEventListener('change', function(){
      updateQualityTargets();
      queueStateSave();
    });
  });
  const applyQualityBtn = document.getElementById('applyQualityTargets');
  if (applyQualityBtn) {
    applyQualityBtn.addEventListener('click', function(){
      applyQualityTargets();
    });
  }
  document.querySelectorAll('.quality-target-marker').forEach(marker => {
    marker.addEventListener('click', () => applyQualityTargets());
    marker.addEventListener('keydown', event => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        applyQualityTargets();
      }
    });
  });

  document.getElementById('moldWaterWeight').addEventListener('input', function(){
    updateMoldSuggested();
    updateOilTotals();
    queueStateSave();
    queueAutoCalc();
  });
  document.getElementById('moldOilPct').addEventListener('input', function(){
    updateMoldSuggested();
    updateOilTotals();
    queueStateSave();
    queueAutoCalc();
  });
  const moldShape = document.getElementById('moldShape');
  if (moldShape) {
    moldShape.addEventListener('change', function(){
      updateMoldShapeUI();
      updateOilTotals();
      queueStateSave();
      queueAutoCalc();
    });
  }
  const moldCylinderCorrection = document.getElementById('moldCylinderCorrection');
  if (moldCylinderCorrection) {
    moldCylinderCorrection.addEventListener('change', function(){
      updateMoldSuggested();
      updateOilTotals();
      queueStateSave();
      queueAutoCalc();
    });
  }
  const moldCylinderFactor = document.getElementById('moldCylinderFactor');
  if (moldCylinderFactor) {
    moldCylinderFactor.addEventListener('input', function(){
      updateMoldSuggested();
      updateOilTotals();
      queueStateSave();
      queueAutoCalc();
    });
  }

  document.querySelectorAll('.stub-btn').forEach(btn => {
    btn.addEventListener('click', function(){
      const kind = this.dataset.stubKind;
      const name = this.dataset.stubName;
      addStubLine(kind, name);
      queueStateSave();
    });
  });

  const soapRoot = document.getElementById('soapToolPage');
  if (soapRoot) {
    soapRoot.addEventListener('click', function(e){
      if (e.target.classList.contains('tool-remove')) {
        queueStateSave();
      }
    });
    soapRoot.addEventListener('input', function(e){
      if (e.target.matches('input, select, textarea')) {
        queueStateSave();
      }
    });
    soapRoot.addEventListener('change', function(e){
      if (e.target.matches('input, select, textarea')) {
        queueStateSave();
      }
    });
  }

  document.getElementById('addToolIngredient').addEventListener('click', function(){
    document.getElementById('tool-ingredients').appendChild(buildLineRow('ingredient'));
    queueStateSave();
  });
  document.getElementById('addToolConsumable').addEventListener('click', function(){
    document.getElementById('tool-consumables').appendChild(buildLineRow('consumable'));
    queueStateSave();
  });
  document.getElementById('addToolContainer').addEventListener('click', function(){
    document.getElementById('tool-containers').appendChild(buildLineRow('container'));
    queueStateSave();
  });

  document.getElementById('calcLyeBtn').addEventListener('click', function(){
    calculateAll({ consumeQuota: true, showAlerts: true });
    queueStateSave();
  });

  document.getElementById('saveSoapTool').addEventListener('click', async function(){
    try {
      const calc = state.lastCalc || calculateAll({ consumeQuota: false, showAlerts: true });
      if (!calc) return;
      const payload = buildSoapRecipePayload(calc);
      state.lastRecipePayload = payload;
      try {
        const storage = getStorage();
        if (storage) {
          storage.setItem('soap_recipe_payload', JSON.stringify(payload));
        }
      } catch (_) {}
      window.SOAP_RECIPE_DTO = payload;
      showSoapAlert('info', 'Recipe payload is ready. Push is stubbed for now; no data has been sent.', { dismissible: true, timeoutMs: 7000 });
    } catch(_) {
      showSoapAlert('danger', 'Unable to prepare the recipe payload. Please try again.', { dismissible: true, persist: true });
    }
  });
  const initialOilRow = document.querySelector('#oilRows .oil-row');
  if (initialOilRow) {
    attachOilTypeahead(initialOilRow);
  }
  attachAdditiveTypeahead('additiveFragranceName', 'additiveFragranceGi', FRAGRANCE_CATEGORY_SET);
  attachAdditiveTypeahead('additiveLactateName', 'additiveLactateGi', LACTATE_CATEGORY_SET);
  attachAdditiveTypeahead('additiveSugarName', 'additiveSugarGi', SUGAR_CATEGORY_SET);
  attachAdditiveTypeahead('additiveSaltName', 'additiveSaltGi', SALT_CATEGORY_SET);
  attachAdditiveTypeahead('additiveCitricName', 'additiveCitricGi', CITRIC_CATEGORY_SET);
  applyLyeSelection();
  setWaterMethod();
  updateMoldShapeUI();
  setQualityRangeBars();
  updateUnitLabels();
  updateQualityTargets();
  updateAdditivesOutput(getTotalOilsGrams());
  restoreState();
})();
</script>
{% endblock %}