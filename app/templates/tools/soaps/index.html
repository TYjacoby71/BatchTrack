{% extends 'layout.html' %}
{% set tool_enabled = tool_enabled if tool_enabled is defined else True %}
{% set navbar_center_title = 'Soap Formulator' %}
{% set page_title = "BatchTrack.com | Soap Formulator & Batch Calculator" %}
{% set page_description = "Free soap formulator: build recipes with lye, oils, superfat, quality targets, and FIFO lot tracking. Calm and neurodivergent-friendly." %}
{% from 'components/shared/feedback_note_modal.html' import render_feedback_note_widget %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ static_asset('css/tools/soaps.css') }}">
<link rel="stylesheet" href="{{ static_asset('css/tools/feedback_note_modal.css') }}">
{% endblock %}

{% block content %}
<div class="py-1" id="soapToolPage">
  <h1 class="visually-hidden">Soap Formulator</h1>
  {% if not tool_enabled %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="fas fa-hourglass-half me-2"></i>
    Public drafting is in previewâ€”feel free to explore the layout while we finish the live calculators.
  </div>
  {% endif %}
  <script>
    window.RECIPE_CATEGORY_NAME = 'Soaps';
    window.SOAP_CALC_LIMIT = {{ calc_limit|tojson if calc_limit is defined else 'null' }};
    window.SOAP_CALC_TIER = {{ calc_tier|tojson if calc_tier is defined else '"guest"' }};
    window.soapToolConfig = {
      unitOptionsHtml: `{% for unit in global_units %}<option value="{{ unit.name }}">{{ unit.name }}</option>{% endfor %}`,
      useCsvPrimary: {{ is_feature_enabled('TOOLS_SOAP_CSV_PRIMARY')|tojson }}
    };
  </script>
  <div id="soapAlertStack" class="mb-3"></div>

  {% include 'tools/soaps/_results_card.html' %}

  <div class="row mt-2 g-2" id="soapStageQualityRow">
    <div class="col-lg-6 soap-stage-col">
      <div class="soap-stage-pane" id="soapStagePane">
        {% include 'tools/soaps/_stages.html' %}
      </div>
    </div>

    <div class="col-lg-6 soap-quality-col">
      {% include 'tools/soaps/_quality_card.html' %}
    </div>
  </div>

  {% include 'tools/soaps/_results_actions_card.html' %}

  {% include 'tools/soaps/_mobile_drawer.html' %}

  {% include 'tools/soaps/_modals.html' %}
  {% include 'tools/soaps/_toasts.html' %}

  {% set soap_feedback_sources = [
    {'value': 'soap_formulator', 'label': 'Soap Formulator'},
    {'value': 'soap_bulk_oils_picker', 'label': 'Soap Bulk Oils Picker'},
    {'value': 'soap_quality_targets', 'label': 'Soap Quality Targets'},
    {'value': 'tools_public_shell', 'label': 'Tools Public Shell'},
  ] %}
  {{ render_feedback_note_widget(
    modal_id='soapFeedbackNoteModal',
    default_source='soap_formulator',
    source_options=soap_feedback_sources,
    trigger_mode='floating',
    trigger_text='Leave a note',
    title='Soap Formulator notes',
    subtitle='Questions, missing features, glitches, or bad preset data.',
    endpoint=url_for('tools_bp.tools_feedback_notes'),
    context='tools.soap',
    default_flow='question',
    floating_bottom_offset='5.25rem'
  ) }}

</div>

<script type="module" src="{{ static_asset('js/tools/soaps/soap_tool_bundle_entry.js') }}"></script>
<script src="{{ static_asset('js/components/feedback_note_modal.js') }}"></script>
{% endblock %}
