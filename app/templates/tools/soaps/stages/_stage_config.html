{% set soap_defaults = soap_policy.default_inputs if soap_policy is defined and soap_policy.default_inputs is defined else {} %}
<div class="tab-pane fade" id="soapStage3Pane" role="tabpanel" aria-labelledby="soapStage3Tab">
  <div class="soap-stage-body p-3" data-stage-index="2">
    <div class="row g-3 align-items-start soap-stage-form-row soap-config-row soap-stage-grid">
      <div class="col-12 soap-field-stack">
        <label class="form-label">Lye type</label>
        <div class="btn-group w-100" role="group" aria-label="Lye type">
          <input type="radio" class="btn-check" name="lye_type" id="lyeTypeNaoh" value="NaOH" checked>
          <label class="btn btn-outline-secondary" for="lyeTypeNaoh">NaOH</label>
          <input type="radio" class="btn-check" name="lye_type" id="lyeTypeKoh" value="KOH">
          <label class="btn btn-outline-secondary" for="lyeTypeKoh">KOH</label>
          <input type="radio" class="btn-check" name="lye_type" id="lyeTypeKoh90" value="KOH90">
          <label class="btn btn-outline-secondary" for="lyeTypeKoh90">90% KOH</label>
        </div>
      </div>
    </div>
    <div class="row g-2 align-items-start soap-stage-form-row soap-config-row soap-stage-grid mt-2">
      <div class="col-lg-6 col-md-12 soap-field-stack">
        <label class="form-label">Water method</label>
        <select class="form-select" id="waterMethod" name="water_method">
          <option value="percent">Water as % of oils</option>
          <option value="concentration">Lye concentration %</option>
          <option value="ratio">Water : Lye ratio</option>
        </select>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="soap-field-stack water-input" data-method="percent">
          <label class="form-label">Water of oils</label>
          <div class="soap-input-suffix" data-suffix="%">
            <input type="number" class="form-control" id="waterPct" step="0.1" placeholder="e.g. 33">
          </div>
          <div class="form-text soap-stage-note">Normal range is about 25-40% of oils.</div>
        </div>
        <div class="soap-field-stack water-input d-none" data-method="concentration">
          <label class="form-label">Lye concentration</label>
          <div class="soap-input-suffix" data-suffix="%">
            <input type="number" class="form-control" id="lyeConcentration" step="0.1" placeholder="e.g. 33">
          </div>
          <div class="form-text soap-stage-note">Normal range is about 20-50%.</div>
        </div>
        <div class="soap-field-stack water-input d-none" data-method="ratio">
          <label class="form-label">Water : Lye ratio</label>
          <input type="number" class="form-control" id="waterRatio" step="0.05" placeholder="e.g. 2.0">
          <div class="form-text soap-stage-note">Normal range is about 1.0-4.0 : 1.</div>
        </div>
      </div>
    </div>
    <div class="row g-2 align-items-start soap-stage-form-row soap-config-row soap-stage-grid mt-2">
      <div class="col-lg-6 col-md-12 soap-field-stack">
        <label class="form-label">Lye purity</label>
        <div class="soap-input-suffix" data-suffix="%">
          <input type="number" class="form-control" id="lyePurity" step="0.1" value="{{ soap_defaults.lye_purity_pct|default(100) }}" placeholder="Safe default: 100">
        </div>
        <div class="form-text soap-stage-note">Safe default is 100%.</div>
      </div>
      <div class="col-lg-6 col-md-12 soap-field-stack">
        <label class="form-label">Superfat</label>
        <div class="soap-input-suffix" data-suffix="%">
          <input type="number" class="form-control" id="lyeSuperfat" name="superfat" step="0.1" value="{{ soap_defaults.superfat_pct|default(5) }}" placeholder="Safe default: 5">
        </div>
        <div class="form-text soap-stage-note">Safe default is 5%.</div>
      </div>
    </div>
    <div class="row g-2 align-items-start soap-stage-form-row soap-config-row soap-stage-grid mt-2">
      <div class="col-12">
        <div class="soap-output-tile">
          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Calculated water</div>
            <div class="fw-semibold soap-animate-number" id="stageWaterOutput">--</div>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-2 align-items-start soap-stage-form-row soap-config-row soap-stage-grid mt-2">
      <div class="col-12">
        <div class="alert alert-light mb-0">
          <div class="fw-semibold">Live calculation preview</div>
          <div class="small text-muted" id="lyeWaterPreviewAnchor">Based on -- oils. All values update live as you change inputs.</div>
          <div class="small mt-1">Lye needed: <span id="lyePreview">--</span></div>
          <div class="small">Water amount: <span id="waterPreview">--</span></div>
          <div class="small">Lye concentration: <span id="concPreview">--</span></div>
          <div class="small">Water : Lye ratio: <span id="ratioPreview">--</span></div>
        </div>
      </div>
    </div>
    {% set stage_index = 2 %}
    {% include 'tools/soaps/stages/_stage_actions.html' %}
  </div>
</div>
