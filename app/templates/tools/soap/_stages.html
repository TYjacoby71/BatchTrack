<div class="accordion" id="soapStageAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage1Heading">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage1Collapse">
        Stage 1 — Mold sizing & batch target
      </button>
    </h2>
    <div id="soapStage1Collapse" class="accordion-collapse collapse show" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Mold water weight <span class="badge rounded-pill soap-unit-chip unit-label">g</span></label>
            <input type="number" class="form-control" id="moldWaterWeight" min="0" step="0.1" placeholder="e.g., 1200">
            <div class="form-text">Fill the mold with water and weigh it.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Oils % of mold</label>
            <input type="number" class="form-control" id="moldOilPct" min="0" max="100" step="0.1" value="65" title="Normal range is 50-80%.">
            <div class="form-text soap-stage-note">Normal range is 50-80%.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Total oils target <span class="badge rounded-pill soap-unit-chip unit-label">g</span></label>
            <input type="number" class="form-control" id="oilTotalTarget" min="0" step="0.1" placeholder="Auto from mold or enter manually">
            <div class="form-text soap-stage-note" id="oilTargetHint">Auto-fills when mold sizing is set.</div>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">Mold shape</label>
            <select class="form-select" id="moldShape">
              <option value="loaf">Loaf / rectangular</option>
              <option value="cylinder">Cylinder / pipe</option>
            </select>
          </div>
          <div class="col-md-8">
            <div class="mt-2 d-none" id="moldCylinderOptions">
              <div class="alert alert-warning small mb-2" id="moldCylinderAlert">
                Cylinder mold selected. Use a correction if you want headspace for pouring or overflow control.
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="moldCylinderCorrection">
                    <label class="form-check-label" for="moldCylinderCorrection">Apply cylinder correction</label>
                  </div>
                  <div class="form-text soap-stage-note">Use this when you want to leave headspace or avoid spill risk.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Cylinder fill factor</label>
                  <input type="number" class="form-control" id="moldCylinderFactor" min="0.5" max="1" step="0.05" value="0.85">
                  <div class="form-text soap-stage-note">0.85 means fill to 85% of measured capacity.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="small text-muted mt-2" id="moldSuggestionNote">Target oils are capped to the mold size above.</div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage2Heading">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage2Collapse">
        Stage 2 — Oils, fats & waxes
      </button>
    </h2>
    <div id="soapStage2Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="position-relative">
          <div class="row g-3">
            <div class="col-12">
              <div id="oilRows">
                <div class="row g-2 align-items-end oil-row mb-2">
                <div class="col-md-6">
                  <label class="form-label">Oil, fat, or wax</label>
                  <div class="position-relative">
                    <input type="text" class="form-control oil-typeahead" placeholder="Search oils, butters, waxes...">
                    <input type="hidden" class="oil-sap-koh">
                    <input type="hidden" class="oil-iodine">
                    <input type="hidden" class="oil-fatty">
                    <input type="hidden" class="oil-gi-id">
                    <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index:1050"></div>
                  </div>
                  <div class="form-text small text-muted">Filtered to oils, butters, and waxes.</div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Weight <span class="badge rounded-pill soap-unit-chip unit-label">g</span></label>
                  <input type="number" class="form-control oil-grams" min="0" step="0.1">
                </div>
                <div class="col-md-2">
                  <label class="form-label">%</label>
                  <input type="number" class="form-control oil-percent" min="0" step="0.1">
                </div>
                <div class="col-md-1 d-grid">
                  <button class="btn btn-outline-danger remove-oil" type="button">Remove</button>
                </div>
                </div>
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
              <button class="btn btn-sm btn-outline-primary" id="addOil" type="button">Add Oil</button>
              <button class="btn btn-sm btn-outline-secondary" id="normalizeOils" type="button">Normalize to 100%</button>
              <div class="small text-muted">Total %: <span id="oilPercentTotal">0</span>%</div>
              <div class="small text-muted">Current oils: <span id="oilTotalComputed">--</span></div>
            </div>
            <div class="alert alert-warning small mt-2 d-none" id="oilLimitWarning"></div>
            <div class="alert alert-light border small mt-3 d-none" id="oilBlendTips"></div>
            <div class="small text-muted mt-2">Select or hover an oil to preview its profile.</div>
          </div>
        </div>
        <div class="card oil-profile-float d-none" id="oilProfileFloat">
          <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong class="small">Selected oil profile</strong>
                <span class="small text-muted" id="selectedOilName">Pick an oil to preview</span>
              </div>
              <div class="small text-muted">SAP (KOH): <span id="selectedOilSap">--</span> · Iodine: <span id="selectedOilIodine">--</span></div>
              <div class="mt-2">
                <div class="small text-muted">Qualities</div>
                <div class="d-flex justify-content-between"><span>Hardness</span><span id="selectedOilHardness">--</span></div>
                <div class="d-flex justify-content-between"><span>Cleansing</span><span id="selectedOilCleansing">--</span></div>
                <div class="d-flex justify-content-between"><span>Conditioning</span><span id="selectedOilConditioning">--</span></div>
                <div class="d-flex justify-content-between"><span>Bubbly</span><span id="selectedOilBubbly">--</span></div>
                <div class="d-flex justify-content-between"><span>Creamy</span><span id="selectedOilCreamy">--</span></div>
              </div>
              <div class="mt-2">
                <div class="small text-muted">Fatty acids</div>
                <div class="table-responsive">
                  <table class="table table-sm soap-oil-profile mb-0">
                    <tbody>
                      <tr><td>Lauric</td><td class="text-end" id="selectedOilLauric">--</td></tr>
                      <tr><td>Myristic</td><td class="text-end" id="selectedOilMyristic">--</td></tr>
                      <tr><td>Palmitic</td><td class="text-end" id="selectedOilPalmitic">--</td></tr>
                      <tr><td>Stearic</td><td class="text-end" id="selectedOilStearic">--</td></tr>
                      <tr><td>Ricinoleic</td><td class="text-end" id="selectedOilRicinoleic">--</td></tr>
                      <tr><td>Oleic</td><td class="text-end" id="selectedOilOleic">--</td></tr>
                      <tr><td>Linoleic</td><td class="text-end" id="selectedOilLinoleic">--</td></tr>
                      <tr><td>Linolenic</td><td class="text-end" id="selectedOilLinolenic">--</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage3Heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage3Collapse">
        Stage 3 — Lye & water details
      </button>
    </h2>
    <div id="soapStage3Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="row g-3 align-items-start soap-stage-form-row">
          <div class="col-md-4">
            <label class="form-label">Lye purity (%)</label>
            <input type="number" class="form-control" id="lyePurity" min="90" max="100" step="0.1" value="100">
            <div class="form-text soap-stage-note" id="lyePurityHint">Most calculators assume 100%.</div>
          </div>
          <div class="col-md-4 water-input" data-method="percent">
            <label class="form-label">Water % of oils</label>
            <input type="number" class="form-control" id="waterPct" min="20" max="50" step="0.1" value="33">
          </div>
          <div class="col-md-4 water-input d-none" data-method="concentration">
            <label class="form-label">Lye concentration %</label>
            <input type="number" class="form-control" id="lyeConcentration" min="20" max="50" step="0.1" value="33">
          </div>
          <div class="col-md-4 water-input d-none" data-method="ratio">
            <label class="form-label">Water : Lye ratio</label>
            <input type="number" class="form-control" id="waterRatio" min="1" max="4" step="0.05" value="2">
          </div>
        </div>
        <div class="form-text mt-2">
          Water settings change batch yield and cure time. Auto-updates as you type.
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="calcLyeBtn">Recalculate (optional)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage4Heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage4Collapse">
        Stage 4 — Additives & helpers
      </button>
    </h2>
    <div id="soapStage4Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Sodium lactate %</label>
            <input type="number" class="form-control" id="additiveLactatePct" min="0" max="5" step="0.1" value="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">Sugar %</label>
            <input type="number" class="form-control" id="additiveSugarPct" min="0" max="5" step="0.1" value="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">Salt %</label>
            <input type="number" class="form-control" id="additiveSaltPct" min="0" max="5" step="0.1" value="0.5">
          </div>
          <div class="col-md-3">
            <label class="form-label">Citric acid %</label>
            <input type="number" class="form-control" id="additiveCitricPct" min="0" max="5" step="0.1" value="0">
            <div class="form-text soap-stage-note">Adds extra lye when used.</div>
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label class="form-label">Sodium lactate item</label>
            <div class="position-relative">
              <input type="text" class="form-control additive-typeahead" id="additiveLactateName" placeholder="Link sodium lactate (optional)">
              <input type="hidden" id="additiveLactateGi">
              <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sugar item</label>
            <div class="position-relative">
              <input type="text" class="form-control additive-typeahead" id="additiveSugarName" placeholder="Link sugar (optional)">
              <input type="hidden" id="additiveSugarGi">
              <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Salt item</label>
            <div class="position-relative">
              <input type="text" class="form-control additive-typeahead" id="additiveSaltName" placeholder="Link salt (optional)">
              <input type="hidden" id="additiveSaltGi">
              <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Citric acid item</label>
            <div class="position-relative">
              <input type="text" class="form-control additive-typeahead" id="additiveCitricName" placeholder="Link citric acid (optional)">
              <input type="hidden" id="additiveCitricGi">
              <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
            </div>
          </div>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Sodium lactate</div>
              <div class="fw-semibold" id="additiveLactateOut">--</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Sugar</div>
              <div class="fw-semibold" id="additiveSugarOut">--</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Salt</div>
              <div class="fw-semibold" id="additiveSaltOut">--</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Citric acid</div>
              <div class="fw-semibold" id="additiveCitricOut">--</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Extra lye for citric</div>
              <div class="fw-semibold" id="additiveCitricLyeOut">--</div>
            </div>
          </div>
        </div>
        <div class="small text-muted mt-2">All additive grams are based on total oil weight.</div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage5Heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage5Collapse">
        Stage 5 — Fragrance & essential oils
      </button>
    </h2>
    <div id="soapStage5Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="row g-3 align-items-start soap-stage-form-row">
          <div class="col-md-4">
            <label class="form-label">Fragrance/EO %</label>
            <input type="number" class="form-control" id="additiveFragrancePct" min="0" max="6" step="0.1" value="3">
            <div class="form-text soap-stage-note">Above 3% can accelerate trace.</div>
          </div>
          <div class="col-md-8">
            <label class="form-label">Fragrance/EO selection</label>
            <div class="position-relative">
              <input type="text" class="form-control additive-typeahead" id="additiveFragranceName" placeholder="Link fragrance or EO (optional)">
              <input type="hidden" id="additiveFragranceGi">
              <div class="list-group position-absolute w-100 d-none" data-role="suggestions"></div>
            </div>
          </div>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <div class="border rounded p-2 h-100">
              <div class="small text-muted">Fragrance/EO</div>
              <div class="fw-semibold" id="additiveFragranceOut">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage6Heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage6Collapse">
        Stage 6 — Glossary & reference
      </button>
    </h2>
    <div id="soapStage6Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="row g-3">
          <div class="col-lg-6">
            <h6>Core terms</h6>
            <dl class="small">
              <dt>Saponification (SAP)</dt>
              <dd>Reaction where oils + lye turn into soap + glycerin.</dd>
              <dt>Superfat</dt>
              <dd>Extra oils left unsaponified for gentler bars.</dd>
              <dt>Lye concentration</dt>
              <dd>Percent lye in your solution (higher = faster trace).</dd>
              <dt>Trace</dt>
              <dd>When batter thickens enough to leave a trail on the surface.</dd>
              <dt>Cure</dt>
              <dd>Resting time for hardness and mildness (4-6 weeks).</dd>
            </dl>
          </div>
          <div class="col-lg-6">
            <h6>Ingredient categories</h6>
            <ul class="small">
              <li><strong>Hard oils/butters:</strong> Coconut, palm, cocoa butter, tallow, lard</li>
              <li><strong>Conditioning hard:</strong> Shea, mango, kokum, sal butter</li>
              <li><strong>Soft oils:</strong> Olive, avocado, sunflower, rice bran</li>
              <li><strong>Additives:</strong> Honey, milk, clays, charcoal, botanicals</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="soapStage7Heading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#soapStage7Collapse">
        Stage 7 — Ingredients, consumables & containers
      </button>
    </h2>
    <div id="soapStage7Collapse" class="accordion-collapse collapse" data-bs-parent="#soapStageAccordion">
      <div class="accordion-body">
        <div class="mb-3">
          <h6>Quick stubs</h6>
          <div class="d-flex flex-wrap gap-2" id="ingredientStubButtons">
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Honey">Honey</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Goat Milk">Goat Milk</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Activated Charcoal">Activated Charcoal</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Kaolin Clay">Kaolin Clay</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Sodium Lactate">Sodium Lactate</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Fragrance Oil">Fragrance Oil</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="ingredient" data-stub-name="Essential Oil Blend">Essential Oil Blend</button>
          </div>
        </div>
        <div class="mb-3">
          <h6>Ingredients</h6>
          <div id="tool-ingredients"></div>
          <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolIngredient">Add Ingredient</button>
        </div>
        <div class="mb-3">
          <h6>Consumables</h6>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Nitrile Gloves">Nitrile Gloves</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Safety Goggles">Safety Goggles</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Freezer Paper">Freezer Paper</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="consumable" data-stub-name="Paper Towels">Paper Towels</button>
          </div>
          <div id="tool-consumables"></div>
          <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolConsumable">Add Consumable</button>
        </div>
        <div class="mb-3">
          <h6>Containers</h6>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Loaf Mold">Loaf Mold</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Silicone Cavity Mold">Silicone Cavity Mold</button>
            <button class="btn btn-sm btn-outline-secondary stub-btn" type="button" data-stub-kind="container" data-stub-name="Wax Paper Lined Box">Wax Paper Lined Box</button>
          </div>
          <div id="tool-containers"></div>
          <button class="btn btn-sm btn-outline-primary mt-2" type="button" id="addToolContainer">Add Container</button>
        </div>
      </div>
    </div>
  </div>
</div>
