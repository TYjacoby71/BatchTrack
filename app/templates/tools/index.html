{% extends 'layout.html' %}

{% block head %}
{{ super() }}
<script>
// Handle theme for anonymous users on public tools
document.addEventListener('DOMContentLoaded', function() {
  // Apply saved theme immediately
  const savedTheme = localStorage.getItem('bt_theme');
  if (savedTheme && savedTheme !== 'system') {
    document.documentElement.setAttribute('data-theme', savedTheme);
  }

  // Add theme switcher for public tools
  const themeControls = document.createElement('div');
  themeControls.className = 'theme-switcher-public position-fixed top-0 end-0 m-3';
  themeControls.style.zIndex = '1050';
  themeControls.innerHTML = `
    <div class="dropdown">
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-palette"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item theme-option" data-theme="system">System</button></li>
        <li><button class="dropdown-item theme-option" data-theme="light">Light</button></li>
        <li><button class="dropdown-item theme-option" data-theme="dark">Dark</button></li>
        <li><button class="dropdown-item theme-option" data-theme="warm">Warm</button></li>
      </ul>
    </div>
  `;

  document.body.appendChild(themeControls);

  // Handle theme switching for anonymous users
  document.querySelectorAll('.theme-option').forEach(button => {
    button.addEventListener('click', function() {
      const theme = this.dataset.theme;

      if (theme === 'system') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.removeItem('bt_theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('bt_theme', theme);
      }
    });
  });
});
</script>
{% endblock %}

{% macro waitlist_cta(waitlist_key, label) %}
<div class="mt-3 pt-3 border-top">
  <form class="tool-waitlist-form" data-waitlist-key="{{ waitlist_key }}">
    <label class="form-label small mb-1 text-muted">{{ label }}</label>
    <div class="input-group input-group-sm">
      <input type="email" class="form-control" name="email" placeholder="you@example.com" required>
      <button class="btn btn-outline-secondary" type="submit">
        <span class="label-default"><i class="fas fa-paper-plane me-1"></i>Notify me</span>
        <span class="label-loading d-none"><i class="fas fa-spinner fa-spin me-1"></i>Sending</span>
      </button>
    </div>
    <div class="small text-muted mt-1" data-role="helper">No spam. We'll email when this tool opens.</div>
    <div class="small text-success mt-1 d-none" data-role="success">You're on the list!</div>
    <div class="small text-danger mt-1 d-none" data-role="error">Something went wrong. Try again?</div>
  </form>
</div>
{% endmacro %}
{% block content %}
<div class="py-1">
  <h1 class="mb-4">Maker Tools</h1>
  <p class="text-muted">Free calculators and converters. Create your first export, then save to BatchTrack.</p>

    <div class="row g-3">
    <div class="col-md-6 col-lg-4">
        {% if tool_flags.soap %}
      <a class="card h-100 text-decoration-none" href="/tools/soap">
        <div class="card-body">
          <h5 class="card-title">Soap Tools</h5>
          <p class="card-text small">Lye calculator, superfat, water %, oil profiles.</p>
        </div>
      </a>
        {% else %}
        <div class="card h-100 border-dashed">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              Soap Tools
              <span class="badge bg-secondary">Coming Soon</span>
            </h5>
            <p class="card-text small">Preview the calculator layout and join the waitlist for early access.</p>
            {{ waitlist_cta('tools.soap', 'Soap tools waitlist') }}
          </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6 col-lg-4">
        {% if tool_flags.candles %}
      <a class="card h-100 text-decoration-none" href="/tools/candles">
        <div class="card-body">
          <h5 class="card-title">Candle Tools</h5>
          <p class="card-text small">Fragrance load, wax blend %, vessel sizing.</p>
        </div>
      </a>
        {% else %}
        <div class="card h-100 border-dashed">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              Candle Tools
              <span class="badge bg-secondary">Coming Soon</span>
            </h5>
            <p class="card-text small">See what’s shipping next—calculate fragrance load and wax ratios soon.</p>
            {{ waitlist_cta('tools.candles', 'Candle tools waitlist') }}
          </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6 col-lg-4">
        {% if tool_flags.lotions %}
      <a class="card h-100 text-decoration-none" href="/tools/lotions">
        <div class="card-body">
          <h5 class="card-title">Lotion & Cosmetic Tools</h5>
          <p class="card-text small">Phase % calculator, preservative %, temps.</p>
        </div>
      </a>
        {% else %}
        <div class="card h-100 border-dashed">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              Lotion & Cosmetic Tools
              <span class="badge bg-secondary">Coming Soon</span>
            </h5>
            <p class="card-text small">Phase calculators and preservative planners arrive shortly.</p>
            {{ waitlist_cta('tools.lotions', 'Lotion & cosmetics waitlist') }}
          </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6 col-lg-4">
        {% if tool_flags.herbal %}
      <a class="card h-100 text-decoration-none" href="/tools/herbal">
        <div class="card-body">
          <h5 class="card-title">Herbalist Tools</h5>
          <p class="card-text small">Tincture ratios, oil infusions, dilutions.</p>
        </div>
      </a>
        {% else %}
        <div class="card h-100 border-dashed">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              Herbalist Tools
              <span class="badge bg-secondary">Coming Soon</span>
            </h5>
            <p class="card-text small">Tincture ratios and infusion helpers are in preview.</p>
            {{ waitlist_cta('tools.herbal', 'Herbal tools waitlist') }}
          </div>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6 col-lg-4">
        {% if tool_flags.baker %}
      <a class="card h-100 text-decoration-none" href="/tools/baker">
        <div class="card-body">
          <h5 class="card-title">Baker Tools</h5>
          <p class="card-text small">Baker’s %, hydration, preferments, scaling.</p>
        </div>
      </a>
        {% else %}
        <div class="card h-100 border-dashed">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              Baker Tools
              <span class="badge bg-secondary">Coming Soon</span>
            </h5>
            <p class="card-text small">Formula scaling and hydration helpers launch soon.</p>
            {{ waitlist_cta('tools.baker', 'Baker tools waitlist') }}
          </div>
        </div>
        {% endif %}
    </div>
  </div>
</div>
<script>
(function(){
  function toggleState(form, state){
    const btn = form.querySelector('button[type="submit"]');
    const helper = form.querySelector('[data-role="helper"]');
    const success = form.querySelector('[data-role="success"]');
    const error = form.querySelector('[data-role="error"]');
    const defaultLabel = form.querySelector('.label-default');
    const loadingLabel = form.querySelector('.label-loading');

    if (state === 'loading'){
      btn.disabled = true;
      defaultLabel.classList.add('d-none');
      loadingLabel.classList.remove('d-none');
      success.classList.add('d-none');
      error.classList.add('d-none');
      helper.classList.remove('d-none');
    } else {
      btn.disabled = false;
      defaultLabel.classList.remove('d-none');
      loadingLabel.classList.add('d-none');
    }

    if (state === 'success'){
      helper.classList.add('d-none');
      success.classList.remove('d-none');
      error.classList.add('d-none');
    } else if (state === 'error'){
      helper.classList.add('d-none');
      success.classList.add('d-none');
      error.classList.remove('d-none');
    } else if (state === 'idle'){
      helper.classList.remove('d-none');
      success.classList.add('d-none');
      error.classList.add('d-none');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.tool-waitlist-form').forEach(function(form){
      form.addEventListener('submit', async function(ev){
        ev.preventDefault();
        const emailInput = form.querySelector('input[name="email"]');
        const waitlistKey = form.dataset.waitlistKey || 'public_tools';
        if (!emailInput.value){
          return;
        }
        toggleState(form, 'loading');
        try{
          const response = await fetch('/api/waitlist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              email: emailInput.value,
              waitlist_key: waitlistKey,
              source: waitlistKey,
              context: 'tools_page',
              notes: `tools_index:${waitlistKey}`
            })
          });
          if (!response.ok){
            throw new Error('Failed request');
          }
          toggleState(form, 'success');
          emailInput.value = '';
        }catch(err){
          console.error('Waitlist error', err);
          toggleState(form, 'error');
        }finally{
          setTimeout(() => toggleState(form, 'idle'), 1500);
        }
      });
    });
  });
})();
</script>
{% endblock %}