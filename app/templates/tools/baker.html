{% extends 'layout.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Baker Tools</h2>
  <script>window.RECIPE_CATEGORY_NAME = 'Baked Goods';</script>
  <p class="text-muted">Baker’s percentage with flour as 100%. Use grams.</p>

  <div class="card">
    <div class="card-header">Baker’s % Calculator</div>
    <div class="card-body">
      {% include 'components/recipes/_category_fields.html' %}
      <div class="mb-3">
        <h6>Ingredients</h6>
        <div id="tool-ingredients"></div>
        <button class="btn btn-sm btn-outline-primary mt-2" id="addToolIngredient">Add Ingredient</button>
      </div>
      <div class="mb-3">
        <h6>Consumables</h6>
        <div id="tool-consumables"></div>
        <button class="btn btn-sm btn-outline-primary mt-2" id="addToolConsumable">Add Consumable</button>
      </div>
      <div class="mb-3">
        <h6>Containers</h6>
        <div id="tool-containers"></div>
        <button class="btn btn-sm btn-outline-primary mt-2" id="addToolContainer">Add Container</button>
      </div>
      <form id="bakerForm" class="row g-3">
        <div class="col-md-3"><label class="form-label">Base Flour (g)</label><input type="number" name="flour_g" class="form-control" min="0" step="1"></div>
        <div class="col-md-3"><label class="form-label">Water (%)</label><input type="number" name="water_pct" class="form-control" min="0" max="120" step="0.1" value="70"></div>
        <div class="col-md-3"><label class="form-label">Salt (%)</label><input type="number" name="salt_pct" class="form-control" min="0" max="5" step="0.1" value="2"></div>
        <div class="col-md-3 d-flex align-items-end"><button type="button" id="calcBakerBtn" class="btn btn-primary w-100">Calculate</button></div>
      </form>
      <div class="mt-3" id="bakerResult" style="display:none;">
        <div id="bakerNumbers" class="alert alert-info mb-2"></div>
        <button class="btn btn-success" id="saveBakerTool">Save to BatchTrack</button>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">Exports</div>
  <div class="card-body">
    <a class="btn btn-outline-secondary" href="{{ url_for('exports._baker_sheet_tool') }}">View Baker Sheet</a>
  </div>
</div>
<script>
(function(){
  function round(v){ return Math.round(v*1000)/1000 }
  function buildLineRow(kind){
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end mb-2';
    row.innerHTML = `
      <div class=\"col-md-6\"> 
        <label class=\"form-label\">${kind === 'container' ? 'Container' : (kind === 'consumable' ? 'Consumable' : 'Ingredient')}</label>
        <div class=\"position-relative\">
          <input type=\"text\" class=\"form-control tool-typeahead\" placeholder=\"Search global...\" autocomplete=\"off\">
          <input type=\"hidden\" class=\"tool-gi-id\">
          <div class=\"list-group position-absolute w-100 d-none\" data-role=\"suggestions\"></div>
        </div>
      </div>
      <div class=\"col-md-3 ${kind==='container'?'d-none':''}\">
        <label class=\"form-label\">Quantity</label>
        <input type=\"number\" step=\"0.01\" min=\"0\" class=\"form-control tool-qty\">
      </div>
      <div class=\"col-md-3 ${kind==='container'?'d-none':''}\">
        <label class=\"form-label\">Unit</label>
        <select class=\"form-select tool-unit\">
          <option value=\"gram\">gram</option>
          <option value=\"milliliter\">milliliter</option>
          <option value=\"oz\">oz</option>
          <option value=\"count\">count</option>
        </select>
      </div>
      <div class=\"col-md-3 ${kind!=='container'?'d-none':''}\">
        <label class=\"form-label\">Count</label>
        <input type=\"number\" min=\"1\" step=\"1\" class=\"form-control tool-qty\">
      </div>
      <div class=\"col-md-2 d-grid\">
        <button type=\"button\" class=\"btn btn-outline-danger tool-remove\">Remove</button>
      </div>`;
    const input = row.querySelector('.tool-typeahead');
    const giHidden = row.querySelector('.tool-gi-id');
    const list = row.querySelector('[data-role="suggestions"]');
    const itemType = (kind==='container')? 'container' : (kind==='consumable' ? 'consumable' : 'ingredient');
    attachPublicGlobalTypeahead({ inputEl: input, giHiddenEl: giHidden, listEl: list, itemType });
    row.querySelector('.tool-remove').addEventListener('click', function(){ row.remove(); });
    return row;
  }
  document.getElementById('addToolIngredient').addEventListener('click', function(){
    document.getElementById('tool-ingredients').appendChild(buildLineRow('ingredient'));
  });
  document.getElementById('addToolConsumable').addEventListener('click', function(){
    document.getElementById('tool-consumables').appendChild(buildLineRow('consumable'));
  });
  document.getElementById('addToolContainer').addEventListener('click', function(){
    document.getElementById('tool-containers').appendChild(buildLineRow('container'));
  });
  document.getElementById('calcBakerBtn').addEventListener('click', function(){
    const f = document.getElementById('bakerForm');
    const flour = parseFloat(f.flour_g.value||'0');
    const water = parseFloat(f.water_pct.value||'0');
    const salt = parseFloat(f.salt_pct.value||'0');
    if (!(flour>0)) { alert('Enter flour grams'); return; }
    const waterG = flour * (water/100);
    const saltG = flour * (salt/100);
    const out = `Water: ${round(waterG)} g, Salt: ${round(saltG)} g`;
    document.getElementById('bakerNumbers').textContent = out;
    document.getElementById('bakerResult').style.display = 'block';
  });
  document.getElementById('saveBakerTool').addEventListener('click', async function(){
    try {
      const f = document.getElementById('bakerForm');
      const flour = parseFloat(f.flour_g.value||'0');
      const water = parseFloat(f.water_pct.value||'0');
      const overlay = {
        baker_base_flour_g: flour,
        baker_water_pct: water,
        baker_salt_pct: parseFloat(f.salt_pct.value||'0')
      };
      const salt = parseFloat(f.salt_pct.value||'0');
      const batch = flour + (flour*(water/100)) + (flour*(salt/100));
      function collectLines(wrapperId, kind){
        const out = [];
        document.querySelectorAll(`#${wrapperId} .row`).forEach(function(row){
          const name = row.querySelector('.tool-typeahead')?.value?.trim();
          const gi = row.querySelector('.tool-gi-id')?.value || '';
          const qtyEl = row.querySelector('.tool-qty');
          const unitEl = row.querySelector('.tool-unit');
          const hasQty = qtyEl && qtyEl.value !== '';
          if (!name && !gi) return;
          if (kind === 'container'){
            out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 1 });
          } else {
            out.push({ name: name || undefined, global_item_id: gi ? parseInt(gi) : undefined, quantity: hasQty ? parseFloat(qtyEl.value) : 0, unit: (unitEl?.value || '').trim() || 'gram' });
          }
        });
        return out;
      }
      const payload = {
        name: 'Bread (Draft)',
        instructions: 'Draft from Baker Tools',
        predicted_yield: batch || 0,
        predicted_yield_unit: 'gram',
        category_name: 'Baked Goods',
        category_data: overlay,
        ingredients: collectLines('tool-ingredients', 'ingredient'),
        consumables: collectLines('tool-consumables', 'consumable'),
        containers: collectLines('tool-containers', 'container')
      };
      await fetch('/tools/draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    } catch(_) {}
    const modalHtml = `
      <div class="modal fade" id="savePrompt" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Save to BatchTrack</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p>Create a free account to store this as a recipe.</p></div>
        <div class="modal-footer">
          <a class="btn btn-primary" href="{{ url_for('auth.signup') }}">Sign Up</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('auth.login') }}">Log In</a>
        </div>
      </div></div></div>`;
    const div = document.createElement('div'); div.innerHTML = modalHtml; document.body.appendChild(div.firstChild);
    const modal = new bootstrap.Modal(document.getElementById('savePrompt')); modal.show();
  });
})();
</script>
{% endblock %}
