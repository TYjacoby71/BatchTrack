{% extends 'layout.html' %}

{% block title %}Sign Up - BatchTrack{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0">
                                <i class="fas fa-user-plus"></i> 
                                {{ current_offer.name if current_offer else "Create Account" }}
                            </h4>
                        </div>
                        <div class="col-auto">
                            {% if current_offer %}
                            <span class="badge bg-success fs-6">
                                {{ current_offer.days }} Days FREE
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Trial Offer Banner -->
                    {% if current_offer %}
                    <div class="alert alert-success mb-4">
                        <div class="row align-items-center">
                            <div class="col">
                                <i class="fas fa-gift me-2"></i>
                                <strong>{{ current_offer.name }}:</strong> 
                                {{ current_offer.days }} days of full access to your chosen plan.
                                {% if current_offer.requires_billing %}
                                A payment method is required but you won't be charged until your trial ends.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Tier Selection -->
                    <div class="mb-4">
                        <h5 class="text-muted mb-3">
                            <i class="fas fa-star me-2"></i>Choose Your Plan
                            <small class="text-success">({{ current_offer.days if current_offer else 14 }} days free)</small>
                        </h5>
                        <div class="row" id="tier-selection">
                            <div class="col-md-4 mb-3">
                                <div class="card tier-option" data-tier="solo">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Solo</h6>
                                        <div class="h4 text-primary mb-2">$19<small class="text-muted">/mo</small></div>
                                        <ul class="list-unstyled small text-muted">
                                            <li>✓ 1 user</li>
                                            <li>✓ Full batch tracking</li>
                                            <li>✓ Recipe management</li>
                                            <li>✓ Email support</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card tier-option border-primary" data-tier="team">
                                    <div class="card-header bg-primary text-white text-center py-1">
                                        <small><i class="fas fa-star"></i> Most Popular</small>
                                    </div>
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Team</h6>
                                        <div class="h4 text-primary mb-2">$29<small class="text-muted">/mo</small></div>
                                        <ul class="list-unstyled small text-muted">
                                            <li>✓ Up to 10 users</li>
                                            <li>✓ Advanced reports</li>
                                            <li>✓ User roles</li>
                                            <li>✓ Priority support</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card tier-option" data-tier="enterprise">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Enterprise</h6>
                                        <div class="h4 text-primary mb-2">$99<small class="text-muted">/mo</small></div>
                                        <ul class="list-unstyled small text-muted">
                                            <li>✓ Unlimited users</li>
                                            <li>✓ API access</li>
                                            <li>✓ Custom integrations</li>
                                            <li>✓ Phone support</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="selected_tier" id="selected_tier" value="team">
                    </div>

                    <form method="POST" id="signupForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <!-- Hidden fields for tracking -->
                        <input type="hidden" name="signup_source" value="{{ signup_source }}">
                        {% if referral_code %}
                        <input type="hidden" name="referral_code" value="{{ referral_code }}">
                        {% endif %}

                        <!-- Hidden field for selected tier -->
                        <input type="hidden" name="selected_tier" id="selectedTier" value="team">

                        <!-- Name fields -->
                        <div class="row mb-3"></div>

                        <div class="row mb-3">
                            <!-- Left Column - Organization & Account -->
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <h5 class="text-muted">Organization Details</h5>
                                    <div class="mb-3">
                                        <label for="org_name" class="form-label">Organization Name *</label>
                                        <input type="text" class="form-control" id="org_name" name="org_name" required 
                                               value="{{ form_data.org_name if form_data else '' }}"
                                               placeholder="Your Company Name">
                                    </div>
                                </div>

                                <hr class="my-4">
                                <h5 class="text-muted">Your Account Details</h5>

                                <div class="mb-3">
                                    <label for="username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="username" name="username" required
                                           value="{{ form_data.username if form_data else '' }}"
                                           placeholder="Choose a username">
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="email" name="email" required
                                           value="{{ form_data.email if form_data else '' }}"
                                           placeholder="your@email.com">
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="first_name" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="first_name" name="first_name"
                                                   value="{{ form_data.first_name if form_data else '' }}"
                                                   placeholder="First Name">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="last_name" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="last_name" name="last_name"
                                                   value="{{ form_data.last_name if form_data else '' }}"
                                                   placeholder="Last Name">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Password *</label>
                                            <input type="password" class="form-control" id="password" name="password" required
                                                   placeholder="Create a secure password">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="confirm_password" class="form-label">Confirm Password *</label>
                                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                                                   placeholder="Confirm your password">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone"
                                           value="{{ form_data.phone if form_data else '' }}"
                                           placeholder="Your phone number">
                                </div>
                            </div>

                            <!-- Right Column - Billing Information -->
                            <div class="col-md-6">
                                {% if current_offer and current_offer.requires_billing %}
                                <div class="mb-4">
                                    <h5 class="text-muted">
                                        <i class="fas fa-credit-card me-2"></i>Payment Information
                                    </h5>
                                    <div class="alert alert-warning small">
                                        <i class="fas fa-lock me-1"></i>
                                        Required for trial. You won't be charged until {{ current_offer.days }} days from now.
                                    </div>

                                    <div class="mb-3">
                                        <label for="card_number" class="form-label">Card Number *</label>
                                        <input type="text" class="form-control" id="card_number" name="card_number" required
                                               placeholder="1234 5678 9012 3456" maxlength="19"
                                               oninput="formatCardNumber(this)">
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="card_exp_month" class="form-label">Month *</label>
                                                <select class="form-select" id="card_exp_month" name="card_exp_month" required>
                                                    <option value="">MM</option>
                                                    {% for i in range(1, 13) %}
                                                    <option value="{{ '%02d'|format(i) }}">{{ '%02d'|format(i) }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="card_exp_year" class="form-label">Year *</label>
                                                <select class="form-select" id="card_exp_year" name="card_exp_year" required>
                                                    <option value="">YYYY</option>
                                                    {% for year in range(2024, 2035) %}
                                                    <option value="{{ year }}">{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="card_cvc" class="form-label">CVC *</label>
                                                <input type="text" class="form-control" id="card_cvc" name="card_cvc" required
                                                       placeholder="123" maxlength="4">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="billing_name" class="form-label">Name on Card *</label>
                                        <input type="text" class="form-control" id="billing_name" name="billing_name" required
                                               value="{{ form_data.billing_name if form_data else '' }}"
                                               placeholder="Full name as it appears on card">
                                    </div>

                                    <hr class="my-3">
                                    <h6 class="text-muted">Billing Address</h6>

                                    <div class="mb-3">
                                        <label for="billing_address" class="form-label">Street Address</label>
                                        <input type="text" class="form-control" id="billing_address" name="billing_address"
                                               value="{{ form_data.billing_address if form_data else '' }}"
                                               placeholder="123 Main Street">
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="billing_city" class="form-label">City</label>
                                                <input type="text" class="form-control" id="billing_city" name="billing_city"
                                                       value="{{ form_data.billing_city if form_data else '' }}"
                                                       placeholder="Your City">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="billing_state" class="form-label">State/Province</label>
                                                <input type="text" class="form-control" id="billing_state" name="billing_state"
                                                       value="{{ form_data.billing_state if form_data else '' }}"
                                                       placeholder="State">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="billing_zip" class="form-label">ZIP/Postal Code</label>
                                                <input type="text" class="form-control" id="billing_zip" name="billing_zip"
                                                       value="{{ form_data.billing_zip if form_data else '' }}"
                                                       placeholder="12345">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="billing_country" class="form-label">Country</label>
                                                <select class="form-select" id="billing_country" name="billing_country">
                                                    <option value="US" selected>United States</option>
                                                    <option value="CA">Canada</option>
                                                    <option value="GB">United Kingdom</option>
                                                    <option value="AU">Australia</option>
                                                    <!-- Add more countries as needed -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Terms and Submit -->
                        <hr class="my-4">
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="terms_agreed" required>
                                    <label class="form-check-label small" for="terms_agreed">
                                        I agree to the <a href="/terms" target="_blank">Terms of Service</a> and 
                                        <a href="/privacy" target="_blank">Privacy Policy</a>. 
                                        {% if current_offer and current_offer.requires_billing %}
                                        I understand my trial will automatically convert to a paid subscription after {{ current_offer.days }} days.
                                        {% endif %}
                                    </label>
                                </div>

                                <div class="d-flex gap-2 justify-content-between">
                                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-sign-in-alt"></i> Already have an account? Login
                                    </a>

                    <button type="submit" class="btn btn-success btn-lg px-4" {% if not available_tiers %}disabled{% endif %}>
                        Continue to Payment
                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function formatCardNumber(input) {
    let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
    input.value = formattedValue;
}

function validatePromoCode() {
    const promoCode = document.getElementById('promo_code').value.trim().toUpperCase();
    const messageDiv = document.getElementById('promoMessage');

    if (!promoCode) {
        messageDiv.innerHTML = '';
        return;
    }

    // Simple validation - in production, this would be an AJAX call
    const validCodes = {
        'WELCOME20': '20% off for 3 months',
        'TRIAL30': '30% off first month', 
        'WEBINAR50': '50% off first 2 months',
        'PARTNER25': '25% off for 6 months'
    };

    if (validCodes[promoCode]) {
        messageDiv.innerHTML = `<div class="alert alert-success small"><i class="fas fa-check-circle me-1"></i> Valid! ${validCodes[promoCode]}</div>`;
    } else {
        messageDiv.innerHTML = `<div class="alert alert-danger small"><i class="fas fa-exclamation-circle me-1"></i> Invalid promo code</div>`;
    }
}

// Auto-validate promo code on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('promo_code').value) {
        validatePromoCode();
    }
});
</script>
{% endblock %}


<script>
// Tier selection handling
document.addEventListener('DOMContentLoaded', function() {
    const tierOptions = document.querySelectorAll('.tier-option');
    const selectedTierInput = document.getElementById('selected_tier');

    tierOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all
            tierOptions.forEach(opt => opt.classList.remove('border-success', 'bg-light'));

            // Add active class to selected
            this.classList.add('border-success', 'bg-light');

            // Update hidden input
            selectedTierInput.value = this.dataset.tier;

            // Update payment visibility
            updatePaymentSection();
        });
    });

    // Set initial selection (team is pre-selected)
    const defaultTier = document.querySelector('[data-tier="team"]');
    if (defaultTier) {
        defaultTier.classList.add('border-success', 'bg-light');
    }

    function updatePaymentSection() {
        const tier = selectedTierInput.value;
        const paymentSection = document.querySelector('.col-md-6:has(h5:contains("Payment"))');

        // All tiers except free require payment
        if (paymentSection) {
            paymentSection.style.display = tier === 'free' ? 'none' : 'block';
        }
    }
});

function formatCardNumber(input) {
    let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
    input.value = formattedValue;
}

function validatePromoCode() {
    const promoCode = document.getElementById('promo_code').value.trim().toUpperCase();
    const messageDiv = document.getElementById('promoMessage');

    if (!promoCode) {
        messageDiv.innerHTML = '';
        return;
    }

    // Simple validation - in production, this would be an AJAX call
    const validCodes = {
        'WELCOME20': '20% off for 3 months',
        'TRIAL30': '30% off first month', 
        'WEBINAR50': '50% off first 2 months',
        'PARTNER25': '25% off for 6 months'
    };

    if (validCodes[promoCode]) {
        messageDiv.innerHTML = `<div class="alert alert-success small"><i class="fas fa-check-circle me-1"></i> Valid! ${validCodes[promoCode]}</div>`;
    } else {
        messageDiv.innerHTML = `<div class="alert alert-danger small"><i class="fas fa-exclamation-circle me-1"></i> Invalid promo code</div>`;
    }
}

// Auto-validate promo code on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('promo_code').value) {
        validatePromoCode();
    }
});
</script>