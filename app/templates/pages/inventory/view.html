{% extends "layout.html" %}
{% set global_library_enabled = is_feature_enabled('FEATURE_GLOBAL_ITEM_LIBRARY') or is_developer() %}

{% block content %}
<div>
  <div class="row">
    <div class="col-12">
      

      <!-- Pending Unit Change Alert -->
      {% if session.get('pending_unit_change') and session['pending_unit_change'].item_id == item.id %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <h5>Unit Change Pending Confirmation</h5>
        <p>You are changing the unit from <strong>{{ session['pending_unit_change'].old_unit }}</strong> to <strong>{{ session['pending_unit_change'].new_unit }}</strong>.</p>
        <p>Click "Edit Details" to confirm your choice about inventory conversion.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endif %}

      {% if not item.is_tracked or item.quantity > 0 or history|length > 0 %}
        {% include "inventory/components/item_summary_card.html" %}

        <!-- Expired Inventory Section -->
        {% if expired_entries and expired_entries|length > 0 %}
        <div class="card mb-3 border-warning">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Expired Inventory (Physically Remove)
              <span class="badge bg-dark ms-2">{{ expired_total }} {{ item.unit or 'count' }}</span>
            </h6>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <strong>Action Required:</strong> These expired entries are still counted in your digital inventory but should be physically removed from storage and marked as spoiled.
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>FIFO Entry</th>
                    <th>Quantity</th>
                    <th>Expired</th>
                    <th>Days Overdue</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in expired_entries %}
                  {% set days_overdue = (now.date() - entry.expiration_date.date()).days %}
                  <tr>
                    <td>#{{ entry.id }}</td>
                    <td>{{ entry.remaining_quantity }} {{ entry.unit }}</td>
                    <td>{{ entry.expiration_date | user_date }}</td>
                    <td>
                      <span class="badge bg-danger">{{ days_overdue }} day{{ 's' if days_overdue != 1 else '' }}</span>
                    </td>
                    <td>
                      <button class="btn btn-outline-danger btn-sm" onclick="markAsExpired('fifo', {{ entry.id }})">
                        <i class="fas fa-clock"></i> Mark Expired
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}

        {% include "inventory/components/adjustment_form.html" %}

        <!-- Active Lots Toggle -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Transaction History</h5>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="fifoFilter" onchange="toggleFifoFilter()" {% if fifo_filter %}checked{% endif %}>
                <label class="form-check-label" for="fifoFilter">
                  Show Active Lots
                </label>
              </div>
            </div>
          </div>
        </div>

        {% if fifo_filter %}
          {% include "inventory/components/lots_table.html" %}
        {% else %}
          {% include "inventory/components/history_table.html" %}
        {% endif %}
      {% else %}
        <div class="alert alert-warning text-center">
          <h5>Initial Inventory Setup Required</h5>
          <p>This item needs an initial inventory entry before you can view its details.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% include "inventory/components/edit_details_modal.html" %}
{% include "inventory/components/modals.html" %}

<!-- Initial Inventory Modal for Empty FIFO -->
{% if item.is_tracked and item.quantity == 0 and history|length == 0 %}
<div class="modal fade" id="initialInventoryModal" tabindex="-1" aria-labelledby="initialInventoryModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="initialInventoryModalLabel">Initial Inventory Required</h5>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <h6>This item has no current inventory.</h6>
          <p>Please make the initial stock entry to begin tracking this item. This will create your first FIFO entry and allow you to manage inventory properly.</p>
        </div>

        <form id="initialInventoryForm" method="POST" action="{{ url_for('inventory.adjust_inventory', item_id=item.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="change_type" value="restock">

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_quantity" class="form-label">Initial Quantity *</label>
                <input type="number" 
                       class="form-control" 
                       id="initial_quantity" 
                       name="quantity" 
                       min="0.01" 
                       step="0.01" 
                       required>
              </div>
            </div>
            {% if item.type != 'container' %}
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_unit" class="form-label">Unit</label>
                <select class="form-control" id="initial_unit" name="input_unit">
                  <option value="{{ item.unit }}">{{ item.unit or 'count' }}</option>
                  {% for unit in get_global_unit_list() %}
                    {% if unit.name != item.unit %}
                      <option value="{{ unit.name }}">{{ unit.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            {% else %}
            <input type="hidden" name="input_unit" value="count">
            {% endif %}
          </div>

          {% if item.type != 'container' %}
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_cost_per_unit" class="form-label">Cost Per Unit</label>
                <input type="number" 
                       class="form-control" 
                       id="initial_cost_per_unit" 
                       name="cost_per_unit" 
                       min="0" 
                       step="0.01" 
                       value="{{ item.cost_per_unit or 0 }}">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_cost_type" class="form-label">Cost Entry Type</label>
                <select class="form-control" id="initial_cost_type" name="cost_entry_type">
                  <option value="per_unit">Per Unit Cost</option>
                  <option value="total" selected>Total Cost</option>
                </select>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="form-group mb-3">
            <label for="initial_notes" class="form-label">Notes</label>
            <textarea class="form-control" 
                      id="initial_notes" 
                      name="notes" 
                      rows="2" 
                      placeholder="Initial stock entry...">Initial stock entry</textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('inventory.list_inventory') }}" class="btn btn-secondary">Back to Inventory List</a>
        <button type="button" class="btn btn-outline-secondary" data-bs-target="#editDetailsModal" data-bs-toggle="modal" data-bs-dismiss="modal" data-item-id="{{ item.id }}">Edit Item Details</button>
        <button type="submit" form="initialInventoryForm" class="btn btn-primary">Add Initial Inventory</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="{{ static_asset('js/inventory/inventory_view.js') }}"></script>

<script>
// Function to mark expired items as spoiled
async function markAsSpoiled(type, id) {
    if (!confirm('Only mark this item as spoiled if you have physically removed it from your inventory to maintain proper count.\n\nThis action will remove it from the system and cannot be undone.\n\nProceed?')) return;

    try {
        const response = await fetch('/expiration/api/mark-spoiled', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() 
            },
            body: JSON.stringify({ type: type, id: id })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Marked ${data.spoiled_count} item as spoiled`);
            location.reload();
        } else {
            alert('Error marking item as spoiled: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error marking item as spoiled:', error);
        alert('Network error occurred');
    }
}

// Function to mark expired items as expired
async function markAsExpired(type, id) {
    if (!confirm('Mark this item as expired and remove it from inventory?\n\nThis action targets the specific expired lot and cannot be undone.\n\nProceed?')) return;

    console.log('Mark expired called with:', { type, id });

    try {
        const response = await fetch('/expiration/api/mark-expired', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() 
            },
            body: JSON.stringify({ type: type, id: id })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Marked ${data.expired_count} item as expired`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Expiration error:', error);
        alert('Network error occurred');
    }
}

// Get CSRF token function
function getCSRFToken() {
    const tokenMeta = document.querySelector('meta[name=csrf-token]');
    if (tokenMeta) {
        return tokenMeta.getAttribute('content');
    }

    // Fallback: try to find it in forms
    const csrfInput = document.querySelector('input[name=csrf_token]');
    if (csrfInput) {
        return csrfInput.value;
    }

    return '';
}

// JavaScript for Edit Details Modal
document.addEventListener('DOMContentLoaded', function() {
    const forceInfiniteByTier = {{ 'true' if not org_tracks_inventory_quantities else 'false' }};
    const editDetailsModal = document.getElementById('editDetailsModal');
    if (editDetailsModal) {
        editDetailsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const itemId = button.getAttribute('data-item-id');

            fetch(`/inventory/api/get-item/${itemId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(item => {
                    // Populate form fields (guard against missing elements)
                    const nameEl = document.querySelector('#editDetailsModal input[name="name"]');
                    if (nameEl) nameEl.value = item.name;
                    const qtyEl = document.querySelector('#editDetailsModal input[name="quantity"]');
                    if (qtyEl) qtyEl.value = item.quantity;
                    const unitEl = document.getElementById('unitSelect');
                    if (unitEl) unitEl.value = item.unit;
                    const costEl = document.getElementById('modal_cost_per_unit');
                    if (costEl) costEl.value = item.cost_per_unit;
                    const trackedEl = document.getElementById('modal_is_tracked');
                    if (trackedEl) {
                        trackedEl.checked = forceInfiniteByTier ? false : !!item.is_tracked;
                        trackedEl.disabled = !!forceInfiniteByTier;
                    }
                    const formEl = document.getElementById('editModalForm');
                    if (formEl) formEl.setAttribute('action', `/inventory/edit/${itemId}`);

                    // Handle global locking indicators and states
                    const nameInput = nameEl;
                    const unitSelect = document.getElementById('unitSelect');
                    const costPerUnitInput = document.getElementById('modal_cost_per_unit');
                    const categorySelect = document.getElementById('editCategory');
                    const densityInput = document.getElementById('density');

                    // Toggle readonly/disabled and add visual indicators
                    const isLinkedToGlobal = !!(item.global_item_id && item.ownership !== 'org');

                    // Global link controls (advanced)
                    const globalLinkSection = document.getElementById('globalLinkSection');
                    const globalLinkSummary = document.getElementById('globalLinkSummary');
                    const unlinkBtn = document.getElementById('unlinkGlobalBtn');
                    const relinkBtn = document.getElementById('relinkGlobalBtn');
                    const resyncBtn = document.getElementById('resyncGlobalBtn');

                    if (globalLinkSection && item.global_item_id) {
                        globalLinkSection.style.display = 'block';
                        const giName = item.global_item_name || `#${item.global_item_id}`;
                        const statusLabel = isLinkedToGlobal ? 'Linked (locked)' : 'Unlinked (editable)';
                        if (globalLinkSummary) {
                            globalLinkSummary.innerHTML = `Global item: <strong>${giName}</strong><br>Status: <strong>${statusLabel}</strong>`;
                        }
                        const setButtons = () => {
                            if (unlinkBtn) unlinkBtn.disabled = !isLinkedToGlobal;
                            if (relinkBtn) relinkBtn.disabled = isLinkedToGlobal;
                            if (resyncBtn) resyncBtn.disabled = !isLinkedToGlobal;
                        };
                        setButtons();

                        async function callGlobalLinkAction(action) {
                            const res = await fetch(`/inventory/api/global-link/${item.id}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                                body: JSON.stringify({ action })
                            });
                            const data = await res.json().catch(() => ({}));
                            if (!res.ok || !data.success) {
                                throw new Error((data && (data.error || data.message)) || 'Global link update failed');
                            }
                            // Reload the modal state by re-fetching the item
                            return true;
                        }

                        if (unlinkBtn) {
                            unlinkBtn.onclick = async function() {
                                try {
                                    await callGlobalLinkAction('unlink');
                                    window.location.reload();
                                } catch (e) {
                                    alert(e.message || 'Failed to unlink from global item');
                                }
                            };
                        }
                        if (relinkBtn) {
                            relinkBtn.onclick = async function() {
                                try {
                                    await callGlobalLinkAction('relink');
                                    window.location.reload();
                                } catch (e) {
                                    alert(e.message || 'Failed to relink to global item');
                                }
                            };
                        }
                        if (resyncBtn) {
                            resyncBtn.onclick = async function() {
                                try {
                                    await callGlobalLinkAction('resync');
                                    window.location.reload();
                                } catch (e) {
                                    alert(e.message || 'Failed to re-sync global specs');
                                }
                            };
                        }
                    } else if (globalLinkSection) {
                        globalLinkSection.style.display = 'none';
                    }

                    if (isLinkedToGlobal) {
                        // Name field
                        if (nameInput) {
                            nameInput.readOnly = true;
                            const nameLabel = nameInput.previousElementSibling;
                            if (nameLabel && !nameLabel.querySelector('.badge')) {
                                nameLabel.innerHTML += `
                                    <span class="badge bg-secondary ms-1" title="Locked to global item definition">
                                        <i class="fas fa-lock"></i> Global
                                    </span>
                                `;
                            }
                            if (!nameInput.nextElementSibling || !nameInput.nextElementSibling.classList.contains('text-muted')) {
                                const small = document.createElement('small');
                                small.className = 'text-muted';
                                small.textContent = 'This field is locked because this item is linked to the global library.';
                                nameInput.parentNode.insertBefore(small, nameInput.nextSibling);
                            }
                        }

                        // Unit field
                        if (unitSelect) {
                            unitSelect.disabled = true;
                            const unitLabel = unitSelect.previousElementSibling;
                            if (unitLabel && !unitLabel.querySelector('.badge')) {
                                unitLabel.innerHTML += `
                                    <span class="badge bg-secondary ms-1" title="Locked to global item definition">
                                        <i class="fas fa-lock"></i> Global
                                    </span>
                                `;
                            }
                            if (!unitSelect.nextElementSibling || !unitSelect.nextElementSibling.classList.contains('text-muted')) {
                                const small = document.createElement('small');
                                small.className = 'text-muted';
                                small.textContent = 'This field is locked because this item is linked to the global library.';
                                unitSelect.parentNode.insertBefore(small, unitSelect.nextSibling);
                            }
                        }

                        // Cost Per Unit field - can be modified even if global, unless it's a container
                        if (item.type === 'container') {
                            if (costPerUnitInput) {
                                costPerUnitInput.readOnly = true;
                                const costLabel = costPerUnitInput.previousElementSibling;
                                if (costLabel && !costLabel.querySelector('.badge')) {
                                    costLabel.innerHTML += `
                                        <span class="badge bg-secondary ms-1" title="Locked to global item definition">
                                            <i class="fas fa-lock"></i> Global
                                        </span>
                                    `;
                                }
                                if (!costPerUnitInput.nextElementSibling || !costPerUnitInput.nextElementSibling.classList.contains('text-muted')) {
                                    const small = document.createElement('small');
                                    small.className = 'text-muted';
                                    small.textContent = 'This field is locked because this item is linked to the global library.';
                                    costPerUnitInput.parentNode.insertBefore(small, costPerUnitInput.nextSibling);
                                }
                            }
                        }

                        // If unit is locked, ensure the hidden input has the correct value
                        const hiddenUnitInput = document.querySelector('input[name="unit"][type="hidden"]');
                        if (hiddenUnitInput) {
                            hiddenUnitInput.value = item.unit;
                        }

                    } else {
                        // Ensure fields are not read-only/disabled if not global
                        if (nameInput) nameInput.readOnly = false;
                        if (unitSelect) unitSelect.disabled = false;
                        // Cost per unit is generally editable unless it's a container type
                        if (item.type !== 'container') {
                            if (costPerUnitInput) costPerUnitInput.readOnly = false;
                        } else {
                             if (costPerUnitInput) costPerUnitInput.readOnly = true; // Ensure containers remain locked for cost
                        }

                        // Remove any existing locked indicators and text
                        document.querySelectorAll('.badge .fa-lock').forEach(icon => icon.closest('.badge').remove());
                        document.querySelectorAll('.text-muted small').forEach(small => small.remove());

                        // Custom items: allow category selection and density edits.
                        // If a category is selected and has default density, lock density to that value.
                        if (categorySelect && densityInput) {
                            const applyCategoryDensityLock = function(){
                                const opt = categorySelect.options[categorySelect.selectedIndex];
                                const dd = opt && opt.dataset && opt.dataset.density ? parseFloat(opt.dataset.density) : 0;
                                if (categorySelect.value !== '') {
                                    // Any selected category locks density; prefill if default provided
                                    if (!isNaN(dd) && dd > 0) {
                                        densityInput.value = dd.toFixed(3);
                                    }
                                    densityInput.readOnly = true;
                                    densityInput.disabled = true;
                                } else {
                                    // Custom category unlocks manual density
                                    densityInput.readOnly = false;
                                    densityInput.disabled = false;
                                }
                            };
                            categorySelect.addEventListener('change', applyCategoryDensityLock);
                            applyCategoryDensityLock();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching item details:', error);
                    alert('Failed to load item details for editing. Please try refreshing the page.');
                });
        });
    }
});
</script>
{% endblock %}