{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('inventory.list_inventory') }}">Inventory</a></li>
          <li class="breadcrumb-item active">{{ item.name }}</li>
        </ol>
      </nav>

      <!-- Pending Unit Change Alert -->
      {% if session.get('pending_unit_change') and session['pending_unit_change'].item_id == item.id %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <h5>Unit Change Pending Confirmation</h5>
        <p>You are changing the unit from <strong>{{ session['pending_unit_change'].old_unit }}</strong> to <strong>{{ session['pending_unit_change'].new_unit }}</strong>.</p>
        <p>Click "Edit Details" to confirm your choice about inventory conversion.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endif %}

      {% if item.quantity > 0 or history|length > 0 %}
        {% include "inventory/components/item_summary_card.html" %}

        <!-- Expired Inventory Section -->
        {% if expired_entries and expired_entries|length > 0 %}
        <div class="card mb-3 border-warning">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Expired Inventory (Physically Remove)
              <span class="badge bg-dark ms-2">{{ expired_total }} {{ item.unit or 'count' }}</span>
            </h6>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <strong>Action Required:</strong> These expired entries are still counted in your digital inventory but should be physically removed from storage and marked as spoiled.
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>FIFO Entry</th>
                    <th>Quantity</th>
                    <th>Expired</th>
                    <th>Days Overdue</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in expired_entries %}
                  {% set days_overdue = (now.date() - entry.expiration_date.date()).days %}
                  <tr>
                    <td>#{{ entry.id }}</td>
                    <td>{{ entry.remaining_quantity }} {{ entry.unit }}</td>
                    <td>{{ entry.expiration_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                      <span class="badge bg-danger">{{ days_overdue }} day{{ 's' if days_overdue != 1 else '' }}</span>
                    </td>
                    <td>
                      <button class="btn btn-outline-danger btn-sm" onclick="markAsExpired('fifo', {{ entry.id }})">
                        <i class="fas fa-clock"></i> Mark Expired
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}

        {% include "inventory/components/adjustment_form.html" %}

        <!-- Active Lots Toggle -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Transaction History</h5>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="fifoFilter" onchange="toggleFifoFilter()" {% if fifo_filter %}checked{% endif %}>
                <label class="form-check-label" for="fifoFilter">
                  Show Active Lots
                </label>
              </div>
            </div>
          </div>
        </div>
        
        {% if fifo_filter %}
          {% include "inventory/components/lots_table.html" %}
        {% else %}
          {% include "inventory/components/history_table.html" %}
        {% endif %}
      {% else %}
        <div class="alert alert-warning text-center">
          <h5>Initial Inventory Setup Required</h5>
          <p>This item needs an initial inventory entry before you can view its details.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% include "inventory/components/edit_details_modal.html" %}
{% include "inventory/components/modals.html" %}

<!-- Initial Inventory Modal for Empty FIFO -->
{% if item.quantity == 0 and history|length == 0 %}
<div class="modal fade" id="initialInventoryModal" tabindex="-1" aria-labelledby="initialInventoryModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="initialInventoryModalLabel">Initial Inventory Required</h5>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <h6>This item has no current inventory.</h6>
          <p>Please make the initial stock entry to begin tracking this item. This will create your first FIFO entry and allow you to manage inventory properly.</p>
        </div>

        <form id="initialInventoryForm" method="POST" action="{{ url_for('inventory.adjust_inventory', item_id=item.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="change_type" value="restock">
          <input type="hidden" name="cost_entry_type" value="per_unit">

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_quantity" class="form-label">Initial Quantity *</label>
                <input type="number" 
                       class="form-control" 
                       id="initial_quantity" 
                       name="quantity" 
                       min="0.01" 
                       step="0.01" 
                       required>
              </div>
            </div>
            {% if item.type != 'container' %}
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_unit" class="form-label">Unit</label>
                <select class="form-control" id="initial_unit" name="input_unit">
                  <option value="{{ item.unit }}">{{ item.unit or 'count' }}</option>
                  {% for unit in get_global_unit_list() %}
                    {% if unit != item.unit %}
                      <option value="{{ unit }}">{{ unit }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            {% else %}
            <input type="hidden" name="input_unit" value="count">
            {% endif %}
          </div>

          {% if item.type != 'container' %}
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_cost_per_unit" class="form-label">Cost Per Unit</label>
                <input type="number" 
                       class="form-control" 
                       id="initial_cost_per_unit" 
                       name="cost_per_unit" 
                       min="0" 
                       step="0.01" 
                       value="{{ item.cost_per_unit or 0 }}">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="initial_cost_type" class="form-label">Cost Entry Type</label>
                <select class="form-control" id="initial_cost_type" name="cost_entry_type">
                  <option value="per_unit">Per Unit Cost</option>
                  <option value="total">Total Cost</option>
                </select>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="form-group mb-3">
            <label for="initial_notes" class="form-label">Notes</label>
            <textarea class="form-control" 
                      id="initial_notes" 
                      name="notes" 
                      rows="2" 
                      placeholder="Initial stock entry...">Initial stock entry</textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('inventory.list_inventory') }}" class="btn btn-secondary">Back to Inventory List</a>
        <button type="submit" form="initialInventoryForm" class="btn btn-primary">Add Initial Inventory</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="{{ url_for('static', filename='js/inventory/inventory_view.js') }}"></script>

<script>
// Function to mark expired items as spoiled
async function markAsSpoiled(type, id) {
    if (!confirm('Only mark this item as spoiled if you have physically removed it from your inventory to maintain proper count.\n\nThis action will remove it from the system and cannot be undone.\n\nProceed?')) return;

    try {
        const response = await fetch('/expiration/api/mark-spoiled', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() 
            },
            body: JSON.stringify({ type: type, id: id })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Marked ${data.spoiled_count} item as spoiled`);
            location.reload();
        } else {
            alert('Error marking item as spoiled: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error marking item as spoiled:', error);
        alert('Network error occurred');
    }
}

// Function to mark expired items as expired
async function markAsExpired(type, id) {
    if (!confirm('Mark this item as expired and remove it from inventory?\n\nThis action targets the specific expired lot and cannot be undone.\n\nProceed?')) return;

    console.log('Mark expired called with:', { type, id });

    try {
        const response = await fetch('/expiration/api/mark-expired', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() 
            },
            body: JSON.stringify({ type: type, id: id })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Marked ${data.expired_count} item as expired`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Expiration error:', error);
        alert('Network error occurred');
    }
}

// Get CSRF token function
function getCSRFToken() {
    const tokenMeta = document.querySelector('meta[name=csrf-token]');
    if (tokenMeta) {
        return tokenMeta.getAttribute('content');
    }

    // Fallback: try to find it in forms
    const csrfInput = document.querySelector('input[name=csrf_token]');
    if (csrfInput) {
        return csrfInput.value;
    }

    return '';
}
</script>
{% endblock %}