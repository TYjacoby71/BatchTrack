{% extends "layout.html" %}
{% block content %}
<div>
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-shield-alt"></i> System Permissions Management</h4>
            <p class="text-muted mb-0">Manage all system permissions (Developer access only)</p>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                Toggle where each permission is available (Developer, Customer) and whether it is active.
                Developer-only permissions (dev.*) cannot be customer-scoped.
            </p>
            {% for category, perms in permission_categories.items() %}
            <div class="mb-4">
                <h6 class="text-primary">{{ category|title }} Permissions</h6>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Permission</th>
                                <th>Description</th>
                                <th class="text-center">Dev</th>
                                <th class="text-center">Customer</th>
                                <th class="text-center">Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for perm in perms %}
                            <tr data-permission-name="{{ perm.name }}">
                                <td><code>{{ perm.name }}</code></td>
                                <td>{{ perm.description or 'No description' }}</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input perm-scope-toggle"
                                           data-scope="dev"
                                           {% if perm.dev_enabled %}checked{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input perm-scope-toggle"
                                           data-scope="customer"
                                           {% if perm.customer_enabled %}checked{% endif %}
                                           {% if not perm.customer_allowed %}disabled{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input perm-active-toggle"
                                           {% if perm.active %}checked{% endif %}
                                           {% if not (perm.dev_enabled or perm.customer_enabled) %}disabled{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function getRowState(row) {
    const devToggle = row.querySelector('.perm-scope-toggle[data-scope="dev"]');
    const customerToggle = row.querySelector('.perm-scope-toggle[data-scope="customer"]');
    const activeToggle = row.querySelector('.perm-active-toggle');
    return {
        name: row.dataset.permissionName,
        dev_enabled: devToggle ? devToggle.checked : false,
        customer_enabled: customerToggle ? customerToggle.checked : false,
        is_active: activeToggle ? activeToggle.checked : false
    };
}

function syncActiveToggle(row) {
    const devToggle = row.querySelector('.perm-scope-toggle[data-scope="dev"]');
    const customerToggle = row.querySelector('.perm-scope-toggle[data-scope="customer"]');
    const activeToggle = row.querySelector('.perm-active-toggle');
    if (!activeToggle || !devToggle || !customerToggle) return;
    const hasScope = devToggle.checked || customerToggle.checked;
    activeToggle.disabled = !hasScope;
    if (!hasScope) {
        activeToggle.checked = false;
    }
}

async function updatePermissionRow(row) {
    const payload = getRowState(row);
    const resp = await fetch('/auth/permissions/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if (!data.success) {
        alert(data.message || 'Failed to update permission');
        return false;
    }
    const devToggle = row.querySelector('.perm-scope-toggle[data-scope="dev"]');
    const customerToggle = row.querySelector('.perm-scope-toggle[data-scope="customer"]');
    const activeToggle = row.querySelector('.perm-active-toggle');
    if (devToggle) devToggle.checked = data.permission.dev_enabled;
    if (customerToggle) customerToggle.checked = data.permission.customer_enabled;
    if (activeToggle) activeToggle.checked = data.permission.active;
    if (customerToggle) {
        customerToggle.disabled = !data.permission.customer_allowed;
    }
    syncActiveToggle(row);
    return true;
}

document.querySelectorAll('.perm-scope-toggle, .perm-active-toggle').forEach(toggle => {
    toggle.addEventListener('change', async () => {
        const row = toggle.closest('tr');
        syncActiveToggle(row);
        await updatePermissionRow(row);
    });
});

document.querySelectorAll('tr[data-permission-name]').forEach(syncActiveToggle);
</script>
{% endblock %}