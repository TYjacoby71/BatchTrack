{% extends 'layout.html' %}

{% block title %}BatchTrack.com | Artisan Plan Signup{% endblock %}

{% block content %}
{% set primary_tier_id = (signup_primary_tier_id or preselected_tier or default_tier_id)|string %}
{% set primary_tier = available_tiers.get(primary_tier_id) if available_tiers else none %}
{% set primary_lifetime_offer = (lifetime_offers | first) if lifetime_offers else none %}
<div class="py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-xxl-9">
            <div class="card shadow-sm">
                <div class="card-header text-center">
                    <div class="small text-uppercase text-muted fw-semibold mb-1">
                        Signup Offer Variant: {{ signup_variant|replace('_', ' ')|title }}
                    </div>
                    <h2 class="mb-1">
                        <i class="fas fa-rocket me-2"></i>Choose Your Artisan Plan Access
                    </h2>
                    <p class="text-muted mb-0">
                        One plan. Two ways to pay. Lifetime is limited to founding seats.
                    </p>
                </div>
                <div class="card-body p-4 p-lg-5">
                    {% if oauth_user_info %}
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle me-2"></i>
                        Signed in with {{ (oauth_user_info.oauth_provider or 'OAuth')|title }} as <strong>{{ oauth_user_info.email }}</strong>
                    </div>
                    {% endif %}

                    {% set google_oauth_enabled = (oauth_providers.google if oauth_providers is defined else false) %}
                    {% set facebook_oauth_enabled = (oauth_providers.facebook if oauth_providers is defined else false) %}
                    {% if not oauth_user_info and (google_oauth_enabled or facebook_oauth_enabled) %}
                    <div class="text-center mb-4">
                        <p class="text-muted small mb-2">Optional: sign in before checkout for faster setup.</p>
                        <div class="d-flex flex-column flex-md-row gap-2 justify-content-center">
                            {% if google_oauth_enabled %}
                            <a href="{{ url_for('auth.oauth_google', next=request.full_path) }}" class="btn btn-outline-danger">
                                <i class="fab fa-google me-2"></i>Continue with Google
                            </a>
                            {% endif %}
                            {% if facebook_oauth_enabled %}
                            <a href="{{ url_for('auth.oauth_facebook', next=request.full_path) }}" class="btn btn-outline-primary">
                                <i class="fab fa-facebook-f me-2"></i>Continue with Facebook
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="single-tier-shell mb-4">
                        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
                            <div>
                                <h3 class="h5 fw-bold mb-1">Artisan Plan</h3>
                                <p class="small text-muted mb-0">
                                    Full core system flow with Stripe-reactive pricing.
                                </p>
                            </div>
                            {% if primary_tier %}
                            <span class="badge rounded-pill bg-light text-dark border">
                                Backed by tier logic: {{ primary_tier.name }}
                            </span>
                            {% endif %}
                        </div>

                        {% if not primary_tier %}
                        <div class="alert alert-warning mb-0">
                            No customer-facing tier is configured yet. Please configure at least one Stripe-backed tier.
                        </div>
                        {% else %}
                        <div class="row g-3">
                            {% if has_lifetime_capacity %}
                            <div class="col-12 col-lg-6 {% if signup_variant == 'monthly_primary' %}order-lg-2{% else %}order-lg-1{% endif %}">
                                <article
                                    class="plan-choice-card h-100"
                                    data-plan-kind="lifetime"
                                    role="button"
                                    tabindex="0"
                                    aria-pressed="false"
                                >
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge bg-warning text-dark text-uppercase">Primary lifetime offer</span>
                                        <span class="badge bg-dark text-white">Founding Members</span>
                                    </div>
                                    <h4 class="h6 fw-bold mb-1">Founding Member Lifetime</h4>
                                    <p class="small text-muted mb-2">
                                        One-time payment for lifetime access to the Artisan plan.
                                    </p>
                                    <div class="plan-mode-badge mb-2" data-role="modeBadge">Lifetime</div>
                                    <div class="plan-price mb-2" data-role="priceText">
                                        {{ primary_lifetime_offer.lifetime_price_copy if primary_lifetime_offer else 'One-time pricing at secure checkout' }}
                                    </div>
                                    <p class="small mb-2" data-role="statusText">
                                        {% if primary_lifetime_offer %}
                                        Only {{ primary_lifetime_offer.display_spots_left }} seats left / {{ primary_lifetime_offer.seat_total }}.
                                        {% else %}
                                        Limited seats available.
                                        {% endif %}
                                    </p>
                                    <p class="small text-muted mb-0 d-none" data-role="fallbackText"></p>
                                </article>
                            </div>
                            {% endif %}

                            <div class="col-12 col-lg-6 {% if signup_variant == 'monthly_primary' %}order-lg-1{% else %}order-lg-2{% endif %}">
                                <article
                                    class="plan-choice-card h-100"
                                    data-plan-kind="monthly"
                                    role="button"
                                    tabindex="0"
                                    aria-pressed="false"
                                >
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge bg-primary text-white text-uppercase">Artisan monthly</span>
                                        {% if signup_variant == 'monthly_primary' %}
                                        <span class="badge bg-success">Primary in this variant</span>
                                        {% endif %}
                                    </div>
                                    <h4 class="h6 fw-bold mb-1">Artisan Monthly</h4>
                                    <p class="small text-muted mb-2">
                                        Subscription billing using the same Stripe tier logic as today.
                                    </p>
                                    <div class="plan-mode-badge mb-2" data-role="modeBadge">Monthly</div>
                                    <div class="plan-price mb-2" data-role="priceText">
                                        {{ primary_tier.monthly_price_display or primary_tier.price_display or 'Monthly pricing at secure checkout' }}
                                    </div>
                                    <p class="small mb-2" data-role="statusText">Billed monthly subscription.</p>
                                    <p class="small text-muted mb-0 d-none" data-role="fallbackText"></p>
                                </article>
                            </div>

                            {% if not has_lifetime_capacity %}
                            <div class="col-12">
                                <article
                                    class="plan-choice-card h-100"
                                    data-plan-kind="yearly"
                                    role="button"
                                    tabindex="0"
                                    aria-pressed="false"
                                >
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge bg-secondary text-white text-uppercase">Yearly fallback</span>
                                    </div>
                                    <h4 class="h6 fw-bold mb-1">Artisan Yearly</h4>
                                    <p class="small text-muted mb-2">
                                        Yearly billing is displayed only after lifetime seats are exhausted.
                                    </p>
                                    <div class="plan-mode-badge mb-2" data-role="modeBadge">Yearly</div>
                                    <div class="plan-price mb-2" data-role="priceText">Yearly pricing at secure checkout</div>
                                    <p class="small mb-2" data-role="statusText">Billed yearly subscription.</p>
                                    <p class="small text-muted mb-0 d-none" data-role="fallbackText"></p>
                                </article>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="card border-0 soft-panel mb-4">
                        <div class="card-body py-3">
                            <h4 class="h6 mb-2">Guarantee (placeholder)</h4>
                            <p class="small text-muted mb-0">
                                Add final guarantee language here after copy review.
                            </p>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4" id="tierFeaturesCard">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-3">
                                <div>
                                    <h4 class="mb-1" id="featuresCardTitle">Artisan plan summary</h4>
                                    <p class="text-muted mb-0" id="selectedTierText">Choose a billing option to continue to checkout.</p>
                                </div>
                                <div class="text-lg-end">
                                    <div class="badge rounded-pill text-success border border-success soft-success-badge mb-2" id="selectedTierBadge">
                                        Artisan plan
                                    </div>
                                    <div class="fs-4 fw-bold text-primary" id="tierPriceText">—</div>
                                </div>
                            </div>
                            <div id="lifetimeCounterMessage" class="alert alert-warning py-2 px-3 small d-none mb-3"></div>
                            <ul class="features-checklist mb-0" id="featuresChecklist"></ul>
                        </div>
                    </div>

                    <div class="card border-0 soft-panel mb-4">
                        <div class="card-body py-3">
                            <h4 class="h6 mb-2">Coming soon previews</h4>
                            <ul class="small text-muted mb-0 ps-3">
                                <li>25,000+ ingredient global library</li>
                                <li>Recipe marketplace</li>
                                <li>Shopify sync</li>
                                <li>AI import/parser</li>
                            </ul>
                        </div>
                    </div>

                    <div class="text-center" id="confirmationSection">
                        <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
                            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Login
                            </a>
                            <button type="button" class="btn btn-success btn-lg px-4" id="continueBtn" onclick="proceedToPayment()">
                                <i class="fas fa-credit-card me-2"></i>Continue to Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedTier = {{ primary_tier_id|tojson }};
let selectedLifetimeTier = {{ selected_lifetime_tier|tojson }};
const initialBillingMode = {{ billing_mode|tojson }};
const standardBillingCycle = {{ standard_billing_cycle|tojson }};
const availableTiers = {{ available_tiers|tojson }};
const lifetimeOffers = {{ lifetime_offers|tojson }};
const signupSource = {{ signup_source|tojson }};
const referralCode = {{ referral_code|tojson }};
const initialPromoCode = {{ promo_code|tojson }};
const signupVariant = {{ signup_variant|tojson }};
const hasLifetimeCapacity = Boolean({{ has_lifetime_capacity|tojson }});
const VALID_PLAN_KINDS = ['lifetime', 'monthly', 'yearly'];

const lifetimeByKey = Object.fromEntries(
    lifetimeOffers
        .filter((offer) => offer && offer.key)
        .map((offer) => [String(offer.key), offer])
);
const lifetimeByTier = Object.fromEntries(
    lifetimeOffers
        .filter((offer) => offer && offer.tier_id)
        .map((offer) => [String(offer.tier_id), offer])
);

function getTierData() {
    return availableTiers[String(selectedTier || '')] || null;
}

function getLifetimeOffer() {
    return lifetimeByTier[String(selectedTier || '')] || null;
}

function isConfiguredPrice(priceCopy) {
    const normalized = String(priceCopy || '').trim().toLowerCase();
    return Boolean(normalized) && normalized !== 'contact sales';
}

function parsePriceAmount(priceCopy) {
    const normalized = String(priceCopy || '').replace(/,/g, '');
    const match = normalized.match(/(\d+(?:\.\d{1,2})?)/);
    if (!match) return null;
    const parsed = Number.parseFloat(match[1]);
    return Number.isFinite(parsed) ? parsed : null;
}

function formatUsd(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

function getYearlyPriceDisplay(monthlyPrice, tierData) {
    const monthlyAmount = parsePriceAmount(monthlyPrice);
    if (monthlyAmount !== null) {
        return `${formatUsd(monthlyAmount * 10)} / year`;
    }
    return tierData.yearly_price_display || 'Yearly pricing at secure checkout';
}

function getInitialPlanKind() {
    if (initialBillingMode === 'lifetime' && hasLifetimeCapacity) {
        return 'lifetime';
    }
    if (initialBillingMode === 'standard' && ['monthly', 'yearly'].includes(standardBillingCycle)) {
        return standardBillingCycle;
    }
    if (hasLifetimeCapacity) {
        return signupVariant === 'monthly_primary' ? 'monthly' : 'lifetime';
    }
    return 'monthly';
}

let selectedPlanKind = getInitialPlanKind();

function getPlanState(planKind) {
    const tierData = getTierData();
    if (!tierData) {
        return {
            effectivePlanKind: 'unavailable',
            modeBadgeText: 'Unavailable',
            priceText: '—',
            statusText: 'Tier configuration unavailable.',
            fallbackText: '',
            isUnavailable: true,
            lifetimeOffer: null,
            fallbackFromLifetime: false,
        };
    }

    const monthlyPrice = tierData.monthly_price_display || tierData.price_display || 'Contact Sales';
    const yearlyPrice = getYearlyPriceDisplay(monthlyPrice, tierData);
    const hasMonthly = isConfiguredPrice(monthlyPrice);
    const hasYearly = Boolean(yearlyPrice);
    const lifetimeOffer = getLifetimeOffer();
    const hasLifetime = Boolean(
        lifetimeOffer &&
        lifetimeOffer.tier_id &&
        lifetimeOffer.has_remaining &&
        lifetimeOffer.lifetime_lookup_key
    );

    let effectivePlanKind = planKind;
    let modeBadgeText = planKind === 'lifetime' ? 'Lifetime' : (planKind === 'yearly' ? 'Yearly' : 'Monthly');
    let priceText = monthlyPrice;
    let statusText = 'Billed monthly subscription.';
    let fallbackText = '';
    let fallbackFromLifetime = false;
    let isUnavailable = false;

    if (planKind === 'lifetime') {
        if (hasLifetime) {
            effectivePlanKind = 'lifetime';
            modeBadgeText = 'Lifetime';
            priceText = lifetimeOffer.lifetime_price_copy || 'One-time payment';
            statusText = `Only ${lifetimeOffer.display_spots_left} seats left / ${lifetimeOffer.seat_total}.`;
        } else if (hasMonthly) {
            effectivePlanKind = 'monthly';
            modeBadgeText = 'Monthly fallback';
            priceText = monthlyPrice;
            statusText = 'Founding seats are sold out.';
            fallbackText = 'Continuing with monthly billing.';
            fallbackFromLifetime = true;
        } else if (hasYearly) {
            effectivePlanKind = 'yearly';
            modeBadgeText = 'Yearly fallback';
            priceText = yearlyPrice;
            statusText = 'Founding seats are sold out.';
            fallbackText = 'Continuing with yearly billing.';
            fallbackFromLifetime = true;
        } else {
            effectivePlanKind = 'unavailable';
            modeBadgeText = 'Unavailable';
            priceText = 'Contact Sales';
            statusText = 'No checkout price configured yet.';
            isUnavailable = true;
        }
    } else if (planKind === 'yearly') {
        if (hasLifetimeCapacity) {
            effectivePlanKind = hasMonthly ? 'monthly' : 'unavailable';
            modeBadgeText = hasMonthly ? 'Monthly fallback' : 'Unavailable';
            priceText = hasMonthly ? monthlyPrice : 'Contact Sales';
            statusText = hasMonthly ? 'Yearly is hidden while lifetime seats remain.' : 'Yearly is hidden while lifetime seats remain.';
            fallbackText = hasMonthly ? 'Continuing with monthly billing.' : '';
            isUnavailable = !hasMonthly;
        } else if (hasYearly) {
            effectivePlanKind = 'yearly';
            modeBadgeText = 'Yearly';
            priceText = yearlyPrice;
            statusText = 'Billed yearly subscription (10x monthly display).';
        } else if (hasMonthly) {
            effectivePlanKind = 'monthly';
            modeBadgeText = 'Monthly fallback';
            priceText = monthlyPrice;
            statusText = 'Yearly pricing unavailable.';
            fallbackText = 'Continuing with monthly billing.';
        } else {
            effectivePlanKind = 'unavailable';
            modeBadgeText = 'Unavailable';
            priceText = 'Contact Sales';
            statusText = 'Yearly pricing unavailable.';
            isUnavailable = true;
        }
    } else {
        if (hasMonthly) {
            effectivePlanKind = 'monthly';
            modeBadgeText = 'Monthly';
            priceText = monthlyPrice;
            statusText = 'Billed monthly subscription.';
        } else if (!hasLifetimeCapacity && hasYearly) {
            effectivePlanKind = 'yearly';
            modeBadgeText = 'Yearly fallback';
            priceText = yearlyPrice;
            statusText = 'Monthly pricing unavailable.';
            fallbackText = 'Continuing with yearly billing.';
        } else {
            effectivePlanKind = 'unavailable';
            modeBadgeText = 'Unavailable';
            priceText = 'Contact Sales';
            statusText = 'Monthly pricing unavailable.';
            isUnavailable = true;
        }
    }

    return {
        effectivePlanKind,
        modeBadgeText,
        priceText,
        statusText,
        fallbackText,
        isUnavailable,
        lifetimeOffer,
        fallbackFromLifetime,
    };
}

function updateOfferCards() {
    document.querySelectorAll('.plan-choice-card').forEach((card) => {
        const cardPlanKind = String(card.dataset.planKind || '');
        const planState = getPlanState(cardPlanKind);
        const isSelected = cardPlanKind === selectedPlanKind;

        card.classList.toggle('active-offer', isSelected);
        card.classList.toggle('is-disabled', planState.isUnavailable);
        card.classList.toggle('is-lifetime-fallback', cardPlanKind === 'lifetime' && planState.fallbackFromLifetime);
        card.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        card.setAttribute('aria-disabled', planState.isUnavailable ? 'true' : 'false');

        const modeBadge = card.querySelector('[data-role="modeBadge"]');
        const priceText = card.querySelector('[data-role="priceText"]');
        const statusText = card.querySelector('[data-role="statusText"]');
        const fallbackText = card.querySelector('[data-role="fallbackText"]');

        if (modeBadge) {
            modeBadge.textContent = planState.modeBadgeText;
            modeBadge.dataset.mode = planState.effectivePlanKind || 'unavailable';
        }
        if (priceText) {
            priceText.textContent = planState.priceText;
        }
        if (statusText) {
            statusText.textContent = planState.statusText;
        }
        if (fallbackText) {
            fallbackText.textContent = planState.fallbackText || '';
            fallbackText.classList.toggle('d-none', !planState.fallbackText);
        }
    });
}

function updatePlanSummary() {
    const title = document.getElementById('featuresCardTitle');
    const selectedText = document.getElementById('selectedTierText');
    const badge = document.getElementById('selectedTierBadge');
    const priceText = document.getElementById('tierPriceText');
    const featuresList = document.getElementById('featuresChecklist');
    const lifetimeCounterMessage = document.getElementById('lifetimeCounterMessage');
    const continueBtn = document.getElementById('continueBtn');

    const tierData = getTierData();
    const planState = getPlanState(selectedPlanKind);

    featuresList.innerHTML = '';
    lifetimeCounterMessage.classList.add('d-none');
    lifetimeCounterMessage.classList.remove('alert-info');
    lifetimeCounterMessage.classList.add('alert-warning');

    if (!tierData) {
        title.textContent = 'Artisan plan summary';
        selectedText.textContent = 'Tier configuration unavailable.';
        badge.textContent = 'Unavailable';
        priceText.textContent = '—';
        continueBtn.disabled = true;
        continueBtn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Continue to Payment';
        return;
    }

    const features = tierData.presentation_features || tierData.features || [];
    const featureTotal = Number(
        tierData.presentation_feature_total || tierData.feature_total || features.length
    );
    features.forEach((feature) => {
        const item = document.createElement('li');
        const icon = document.createElement('i');
        icon.className = 'fas fa-check text-success me-2';
        const copy = document.createElement('span');
        copy.textContent = feature;
        item.appendChild(icon);
        item.appendChild(copy);
        featuresList.appendChild(item);
    });

    if (featureTotal > features.length) {
        const moreItem = document.createElement('li');
        moreItem.className = 'text-muted';
        moreItem.textContent = `...and ${featureTotal - features.length} more capabilities inside the app.`;
        featuresList.appendChild(moreItem);
    }

    if (planState.isUnavailable) {
        title.textContent = 'Artisan plan summary';
        selectedText.textContent = 'This plan is currently unavailable for checkout.';
        badge.textContent = 'Unavailable';
        priceText.textContent = '—';
        continueBtn.disabled = true;
        continueBtn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Continue to Payment';
        return;
    }

    title.textContent = 'Artisan plan summary';
    badge.textContent = `Artisan ${planState.modeBadgeText}`;
    priceText.textContent = planState.priceText;

    if (planState.effectivePlanKind === 'lifetime') {
        const lifetimeOffer = planState.lifetimeOffer;
        selectedLifetimeTier = lifetimeOffer ? lifetimeOffer.key : '';
        selectedText.textContent = 'You selected Founding Member Lifetime checkout.';
        continueBtn.disabled = false;
        continueBtn.innerHTML = '<i class="fas fa-gem me-2"></i>Continue to Lifetime Checkout';
        if (lifetimeOffer) {
            lifetimeCounterMessage.textContent = `Only ${lifetimeOffer.display_spots_left} seats left / ${lifetimeOffer.seat_total} for Founding Members.`;
            lifetimeCounterMessage.classList.remove('d-none');
        }
        return;
    }

    selectedLifetimeTier = '';
    continueBtn.disabled = false;
    continueBtn.innerHTML = `<i class="fas fa-credit-card me-2"></i>Continue to ${planState.modeBadgeText} Checkout`;
    selectedText.textContent = `You selected Artisan ${planState.modeBadgeText.toLowerCase()} billing.`;

    if (planState.fallbackText) {
        lifetimeCounterMessage.textContent = planState.fallbackText;
        lifetimeCounterMessage.classList.remove('d-none');
        lifetimeCounterMessage.classList.remove('alert-warning');
        lifetimeCounterMessage.classList.add('alert-info');
    }
}

function proceedToPayment() {
    const tierData = getTierData();
    if (!selectedTier || !tierData) {
        alert('The Artisan tier is not configured for checkout.');
        return;
    }

    const planState = getPlanState(selectedPlanKind);
    if (planState.isUnavailable || !VALID_PLAN_KINDS.includes(planState.effectivePlanKind)) {
        alert('This billing option is not available for checkout yet.');
        return;
    }

    let billingMode = 'standard';
    let billingCycle = planState.effectivePlanKind === 'yearly' ? 'yearly' : 'monthly';

    if (planState.effectivePlanKind === 'lifetime') {
        const offer = planState.lifetimeOffer;
        if (!offer || !offer.has_remaining || !offer.tier_id) {
            alert('Founding lifetime seats are sold out. Please choose monthly billing.');
            return;
        }
        selectedLifetimeTier = offer.key;
        selectedTier = String(offer.tier_id);
        billingMode = 'lifetime';
        billingCycle = 'lifetime';
    } else {
        selectedLifetimeTier = '';
    }

    if (window.BTAnalytics && typeof window.BTAnalytics.capture === 'function') {
        window.BTAnalytics.capture('signup_continue_to_payment_clicked', {
            selected_tier: String(selectedTier || ''),
            requested_plan_kind: selectedPlanKind,
            effective_plan_kind: planState.effectivePlanKind,
            billing_mode: billingMode,
            billing_cycle: billingCycle,
            signup_source: signupSource || null,
            signup_variant: signupVariant || null,
        });
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("core.signup_alias") }}';

    const entries = [
        ['csrf_token', '{{ csrf_token() }}'],
        ['selected_tier', selectedTier],
        ['billing_mode', billingMode],
        ['billing_cycle', billingCycle],
        ['signup_variant', signupVariant],
    ];

    if (signupSource) entries.push(['source', signupSource]);
    if (referralCode) entries.push(['ref', referralCode]);

    if (billingMode === 'lifetime' && selectedLifetimeTier && lifetimeByKey[selectedLifetimeTier]) {
        entries.push(['lifetime_tier', selectedLifetimeTier]);
        entries.push(['promo', lifetimeByKey[selectedLifetimeTier].coupon_code || '']);
    } else if (initialPromoCode) {
        entries.push(['promo', initialPromoCode]);
    }

    if (
        window.BTAnalytics &&
        typeof window.BTAnalytics.getFirstLandingAt === 'function'
    ) {
        const firstLandingAt = window.BTAnalytics.getFirstLandingAt();
        if (firstLandingAt) {
            entries.push(['client_first_landing_at', String(firstLandingAt)]);
        }
    }

    try {
        const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        entries.push(['detected_timezone', detectedTimezone]);
    } catch (error) {
        console.warn('Timezone detection failed', error);
    }

    {% if oauth_user_info %}
    entries.push(['oauth_signup', 'true']);
    {% endif %}

    entries.forEach(([name, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
}

document.addEventListener('DOMContentLoaded', () => {
    const offerCards = Array.from(document.querySelectorAll('.plan-choice-card'));
    const visiblePlanKinds = offerCards.map((card) => String(card.dataset.planKind || ''));
    if (!visiblePlanKinds.includes(selectedPlanKind)) {
        selectedPlanKind = visiblePlanKinds[0] || 'monthly';
    }

    offerCards.forEach((card) => {
        card.addEventListener('click', () => {
            const nextKind = String(card.dataset.planKind || '');
            if (!VALID_PLAN_KINDS.includes(nextKind)) return;
            selectedPlanKind = nextKind;
            updateOfferCards();
            updatePlanSummary();
        });

        card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                const nextKind = String(card.dataset.planKind || '');
                if (!VALID_PLAN_KINDS.includes(nextKind)) return;
                selectedPlanKind = nextKind;
                updateOfferCards();
                updatePlanSummary();
            }
        });
    });

    if (window.BTAnalytics && typeof window.BTAnalytics.capture === 'function') {
        window.BTAnalytics.capture('signup_page_viewed', {
            selected_tier: String(selectedTier || ''),
            requested_plan_kind: selectedPlanKind,
            signup_source: signupSource || null,
            signup_variant: signupVariant || null,
        });
    }

    updateOfferCards();
    updatePlanSummary();
});
</script>

<style>
.single-tier-shell {
    border: 1px solid #dbe2f2;
    border-radius: var(--theme-ext-radius-1f2f59cc9c);
    background: #f9fbff;
    padding: 1rem;
}

.plan-choice-card {
    border: 2px solid #d6dff0;
    border-radius: var(--theme-ext-radius-1f2f59cc9c);
    background: #ffffff;
    padding: 1rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
    cursor: pointer;
}

.plan-choice-card.active-offer {
    border-color: var(--theme-ext-color-7630a14d9f);
    box-shadow: var(--theme-ext-shadow-a9f9d9573c);
    transform: translateY(-2px);
}

.plan-choice-card.is-disabled {
    opacity: 0.72;
}

.plan-choice-card.is-lifetime-fallback {
    border-style: dashed;
    background: #f8f9fd;
}

.plan-mode-badge {
    display: inline-flex;
    align-items: center;
    border-radius: var(--theme-ext-radius-13166981e2);
    font-size: var(--theme-ext-size-6ab716b90b);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-weight: 700;
    padding: 0.25rem 0.6rem;
}

.plan-mode-badge[data-mode="lifetime"] {
    background: #fff4de;
    border: 1px solid #f2d18b;
    color: #7a4f00;
}

.plan-mode-badge[data-mode="yearly"] {
    background: #e4f7ea;
    border: 1px solid #9fd8ad;
    color: #21643a;
}

.plan-mode-badge[data-mode="monthly"] {
    background: #e8f0ff;
    border: 1px solid #9eb8ee;
    color: #244a97;
}

.plan-mode-badge[data-mode="unavailable"] {
    background: #f0f2f6;
    border: 1px solid #d4dae6;
    color: #68738a;
}

.plan-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--theme-ext-color-7630a14d9f);
    line-height: 1.25;
}

.soft-panel {
    background: #f8f9fd;
    border: 1px solid #e0e7f4;
    border-radius: var(--theme-ext-radius-1f2f59cc9c);
}

.features-checklist {
    list-style: none;
    padding: var(--theme-ext-space-369a047e0c);
    margin: var(--theme-ext-space-4cb477d5ee);
    columns: 2;
    column-gap: var(--theme-ext-space-db375252e4);
}

.features-checklist li {
    break-inside: avoid;
    display: flex;
    align-items: flex-start;
    margin-bottom: var(--theme-ext-space-7a506f4f36);
    font-size: var(--theme-ext-size-03c2698f9e);
}

.soft-success-badge {
    background-color: var(--theme-ext-color-5851662767);
}

@media (max-width: 768px) {
    .single-tier-shell,
    .plan-choice-card {
        padding: var(--theme-ext-space-32524b311c);
    }

    .features-checklist {
        columns: 1;
    }
}
</style>
{% endblock %}
