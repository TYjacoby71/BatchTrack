
{% extends 'layout.html' %}

{% block title %}BatchTrack.com | Pricing for Small-Batch Makers{% endblock %}

{% block content %}
<div class="py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card">
                <div class="card-header text-center">
                    <h2 class="mb-1">
                        <i class="fas fa-rocket me-2"></i>Choose Your BatchTrack Plan
                    </h2>
                    <p class="text-muted mb-0">Pick one tier, then choose the card you want: Lifetime, Yearly, or Monthly.</p>
                </div>
                <div class="card-body p-4 p-lg-5">
                    {% if oauth_user_info %}
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle me-2"></i>
                        Signed in with Google as <strong>{{ oauth_user_info.email }}</strong>
                    </div>
                    {% endif %}

                    <div class="alert alert-info py-2 px-3 mb-4 small">
                        <i class="fas fa-layer-group me-2"></i>
                        Each tier is shown as a 3-card solitaire stack. Click any exposed card to select that billing option.
                    </div>

                    <section id="successivePlansSection">
                        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="tierStackGrid">
                            {% for offer in lifetime_offers %}
                            {% set tier_key = (offer.tier_id|string) if offer.tier_id else '' %}
                            {% set tier_data = available_tiers.get(tier_key) if tier_key else None %}
                            {% set monthly_price = tier_data.monthly_price_display if tier_data else None %}
                            {% set yearly_price = tier_data.yearly_price_display if tier_data else None %}
                            <div class="col">
                                <article
                                    class="tier-stack-shell h-100 {% if offer.name|lower == 'enthusiast' %}is-recommended{% endif %}"
                                    data-tier-id="{{ tier_key }}"
                                    data-offer-key="{{ offer.key }}"
                                >
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h3 class="h5 fw-bold mb-1">{{ offer.name }}</h3>
                                            <p class="small text-muted mb-0">{{ tier_data.name if tier_data else 'Tier configuration pending' }}</p>
                                        </div>
                                        {% if offer.name|lower == 'enthusiast' %}
                                        <span class="badge bg-success">Recommended</span>
                                        {% endif %}
                                    </div>

                                    {% if offer.has_remaining %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-bolt me-1"></i>Lifetime seats are currently available.
                                    </div>
                                    {% else %}
                                    <div class="small text-muted mb-2">
                                        <i class="fas fa-hourglass-end me-1"></i>Lifetime sold out for this tier.
                                    </div>
                                    {% endif %}

                                    <div class="tier-plan-stack">
                                        <article
                                            class="stack-plan-card"
                                            data-tier-id="{{ tier_key }}"
                                            data-plan-kind="lifetime"
                                            data-lifetime-key="{{ offer.key }}"
                                            data-enabled="{{ 'true' if offer.tier_id and offer.has_remaining else 'false' }}"
                                        >
                                            <div class="stack-plan-peek">
                                                <span class="stack-plan-label">Lifetime</span>
                                            </div>
                                            <div class="stack-plan-body">
                                                {% if offer.has_remaining %}
                                                <div class="fw-bold text-primary mb-2">{{ offer.lifetime_price_copy }}</div>
                                                <div class="small mb-2">
                                                    Only <strong>{{ offer.display_spots_left }}</strong> spots left / {{ offer.seat_total }}
                                                </div>
                                                <div class="small text-muted">
                                                    Coupon auto-applied: <code>{{ offer.coupon_code }}</code>
                                                </div>
                                                {% else %}
                                                <div class="fw-bold text-muted mb-2">Lifetime sold out</div>
                                                <div class="small text-muted mb-1">All {{ offer.seat_total }} lifetime seats have been claimed.</div>
                                                <div class="small text-muted">Choose Yearly or Monthly below for immediate checkout.</div>
                                                {% endif %}
                                            </div>
                                        </article>

                                        <article
                                            class="stack-plan-card"
                                            data-tier-id="{{ tier_key }}"
                                            data-plan-kind="yearly"
                                            data-enabled="{{ 'true' if tier_data and yearly_price else 'false' }}"
                                        >
                                            <div class="stack-plan-peek">
                                                <span class="stack-plan-label">Yearly</span>
                                            </div>
                                            <div class="stack-plan-body">
                                                {% if tier_data and yearly_price %}
                                                <div class="fw-bold text-primary mb-2">{{ yearly_price }}</div>
                                                <div class="small text-muted">Billed yearly subscription.</div>
                                                {% else %}
                                                <div class="fw-bold text-muted mb-2">Yearly unavailable</div>
                                                <div class="small text-muted">Configure yearly Stripe pricing for this tier.</div>
                                                {% endif %}
                                            </div>
                                        </article>

                                        <article
                                            class="stack-plan-card"
                                            data-tier-id="{{ tier_key }}"
                                            data-plan-kind="monthly"
                                            data-enabled="{{ 'true' if tier_data and monthly_price else 'false' }}"
                                        >
                                            <div class="stack-plan-peek">
                                                <span class="stack-plan-label">Monthly</span>
                                            </div>
                                            <div class="stack-plan-body">
                                                {% if tier_data and monthly_price %}
                                                <div class="fw-bold text-primary mb-2">{{ monthly_price }}</div>
                                                <div class="small text-muted">Billed monthly subscription.</div>
                                                {% else %}
                                                <div class="fw-bold text-muted mb-2">Monthly unavailable</div>
                                                <div class="small text-muted">This tier is not configured for checkout yet.</div>
                                                {% endif %}
                                            </div>
                                        </article>
                                    </div>
                                </article>
                            </div>
                            {% endfor %}
                        </div>
                    </section>

                    <div class="card mt-4 shadow-sm" id="tierFeaturesCard">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-3">
                                <div>
                                    <h4 class="mb-1" id="featuresCardTitle">Plan summary</h4>
                                    <p class="text-muted mb-0" id="selectedTierText">Select a plan to continue to checkout.</p>
                                </div>
                                <div class="text-lg-end">
                                    <div class="badge rounded-pill text-success border border-success soft-success-badge mb-2" id="selectedTierBadge">
                                        No plan selected
                                    </div>
                                    <div class="fs-4 fw-bold text-primary" id="tierPriceText">—</div>
                                </div>
                            </div>
                            <div id="lifetimeCounterMessage" class="alert alert-warning py-2 px-3 small d-none mb-3"></div>
                            <ul class="features-checklist mb-0" id="featuresChecklist"></ul>
                        </div>
                    </div>

                    <div class="text-center mt-4" id="confirmationSection">
                        <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
                            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Login
                            </a>
                            <button type="button" class="btn btn-success btn-lg px-4" id="continueBtn" onclick="proceedToPayment()">
                                <i class="fas fa-credit-card me-2"></i>Continue to Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedTier = '{{ preselected_tier or default_tier_id }}';
let selectedLifetimeTier = '{{ selected_lifetime_tier or "" }}';
let selectedPlanKind = '{{ "lifetime" if billing_mode == "lifetime" else (standard_billing_cycle or "monthly") }}';
const availableTiers = {{ available_tiers|tojson }};
const lifetimeOffers = {{ lifetime_offers|tojson }};
const signupSource = {{ signup_source|tojson }};
const referralCode = {{ referral_code|tojson }};
const initialPromoCode = {{ promo_code|tojson }};
const lifetimeByKey = Object.fromEntries(lifetimeOffers.map((offer) => [offer.key, offer]));
const lifetimeByTier = Object.fromEntries(
    lifetimeOffers
        .filter((offer) => offer.tier_id)
        .map((offer) => [String(offer.tier_id), offer])
);

function getTierData(tierId) {
    return availableTiers[String(tierId)] || null;
}

function getLifetimeOfferForTier(tierId) {
    return lifetimeByTier[String(tierId)] || null;
}

function getPreferredTierId() {
    const enthusiastOffer = lifetimeOffers.find((offer) => {
        return String(offer.name || '').toLowerCase() === 'enthusiast'
            && offer.tier_id
            && getTierData(offer.tier_id);
    });
    if (enthusiastOffer) {
        return String(enthusiastOffer.tier_id);
    }

    const enthusiastTier = Object.entries(availableTiers).find((entry) => {
        const tierData = entry[1] || {};
        return String(tierData.name || '').toLowerCase() === 'enthusiast';
    });
    if (enthusiastTier) {
        return String(enthusiastTier[0]);
    }

    return Object.keys(availableTiers)[0] || '';
}

function getDefaultPlanKindForTier(tierId) {
    const tierData = getTierData(tierId);
    const lifetimeOffer = getLifetimeOfferForTier(tierId);
    if (lifetimeOffer && lifetimeOffer.has_remaining && lifetimeOffer.tier_id) {
        return 'lifetime';
    }
    if (tierData && tierData.yearly_price_display) {
        return 'yearly';
    }
    return 'monthly';
}

function selectPlanCard(shell, card, options = {}) {
    if (!shell || !card) return;
    const syncSelection = options.syncSelection !== false;

    if (syncSelection) {
        const tierId = card.dataset.tierId || shell.dataset.tierId || '';
        if (tierId) {
            selectedTier = String(tierId);
        }
        selectedPlanKind = card.dataset.planKind || 'monthly';
        if (selectedPlanKind === 'lifetime') {
            selectedLifetimeTier = card.dataset.lifetimeKey || '';
        } else {
            selectedLifetimeTier = '';
        }
    }

    updateSelectionState();
    updatePlanSummary();
}

function updateSelectionState() {
    document.querySelectorAll('.tier-stack-shell').forEach((shell) => {
        const shellTierId = String(shell.dataset.tierId || '');
        const isSelectedTier = shellTierId && shellTierId === String(selectedTier);
        shell.classList.toggle('selected-tier', isSelectedTier);

        shell.querySelectorAll('.stack-plan-card').forEach((card) => {
            const isCheckoutCard = isSelectedTier && card.dataset.planKind === selectedPlanKind;
            card.classList.toggle('is-selected-plan', isCheckoutCard);
            card.classList.toggle('is-checkout-selected', isCheckoutCard);
            card.classList.toggle('is-disabled', card.dataset.enabled !== 'true');
        });
    });
}

function updatePlanSummary() {
    const title = document.getElementById('featuresCardTitle');
    const selectedText = document.getElementById('selectedTierText');
    const badge = document.getElementById('selectedTierBadge');
    const priceText = document.getElementById('tierPriceText');
    const featuresList = document.getElementById('featuresChecklist');
    const lifetimeCounterMessage = document.getElementById('lifetimeCounterMessage');
    const continueBtn = document.getElementById('continueBtn');

    featuresList.innerHTML = '';
    lifetimeCounterMessage.classList.add('d-none');

    const tierData = availableTiers[String(selectedTier)];
    if (!tierData) {
        title.textContent = 'Plan summary';
        selectedText.textContent = 'Select a plan to continue to checkout.';
        badge.textContent = 'No plan selected';
        priceText.textContent = '—';
        continueBtn.disabled = true;
        continueBtn.innerHTML = '<i class="fas fa-credit-card me-2"></i>Continue to Payment';
        return;
    }

    const features = tierData.features || [];
    features.forEach((feature) => {
        const item = document.createElement('li');
        item.innerHTML = `<i class="fas fa-check text-success me-2"></i><span>${feature}</span>`;
        featuresList.appendChild(item);
    });

    if (tierData.feature_total && tierData.feature_total > features.length) {
        const moreItem = document.createElement('li');
        moreItem.className = 'text-muted';
        moreItem.textContent = `...and ${tierData.feature_total - features.length} more capabilities inside the app.`;
        featuresList.appendChild(moreItem);
    }

    if (selectedPlanKind === 'lifetime') {
        const offer = lifetimeByKey[selectedLifetimeTier] || getLifetimeOfferForTier(selectedTier);
        if (offer && offer.has_remaining && offer.tier_id) {
            selectedLifetimeTier = offer.key;
            title.textContent = `${offer.name} lifetime summary`;
            selectedText.innerHTML = `You selected <strong>${offer.name} Lifetime</strong> (${offer.base_tier_name}) with coupon code <code>${offer.coupon_code}</code>.`;
            badge.textContent = `${offer.name} Lifetime`;
            priceText.textContent = offer.lifetime_price_copy || 'One-time price of 1 year';
            continueBtn.innerHTML = '<i class="fas fa-gem me-2"></i>Continue to Lifetime Checkout';
            lifetimeCounterMessage.textContent = `Only ${offer.display_spots_left} spots left / ${offer.seat_total} for ${offer.name}.`;
            lifetimeCounterMessage.classList.remove('d-none');
            continueBtn.disabled = false;
        } else {
            title.textContent = 'Lifetime summary';
            selectedText.textContent = 'This lifetime option is currently unavailable. Choose the yearly or monthly card for this tier.';
            badge.textContent = 'Unavailable';
            priceText.textContent = '—';
            continueBtn.innerHTML = '<i class="fas fa-gem me-2"></i>Continue to Lifetime Checkout';
            continueBtn.disabled = true;
            lifetimeCounterMessage.textContent = 'Lifetime pricing is not configured for this selection yet.';
            lifetimeCounterMessage.classList.remove('d-none');
        }
        return;
    }

    const isYearlySelected = selectedPlanKind === 'yearly';
    const hasYearlyOption = Boolean(tierData.yearly_price_display);
    const displayPrice = isYearlySelected
        ? (tierData.yearly_price_display || 'Yearly unavailable')
        : (tierData.monthly_price_display || tierData.price_display || 'Contact Sales');

    title.textContent = `${tierData.name} plan summary`;
    selectedText.innerHTML = `You selected the <strong>${tierData.name}</strong> plan (${isYearlySelected ? 'yearly' : 'monthly'}).`;
    badge.textContent = `${tierData.name} ${isYearlySelected ? 'Yearly' : 'Monthly'}`;
    priceText.textContent = displayPrice;
    continueBtn.innerHTML = `<i class="fas fa-credit-card me-2"></i>Continue to ${isYearlySelected ? 'Yearly' : 'Monthly'} Checkout`;
    continueBtn.disabled = Boolean(isYearlySelected && !hasYearlyOption);

    if (isYearlySelected && !hasYearlyOption) {
        lifetimeCounterMessage.textContent = 'Yearly pricing is not configured for this tier yet. Click the Monthly card in this tier stack.';
        lifetimeCounterMessage.classList.remove('d-none');
    }
}

function proceedToPayment() {
    if (!selectedTier || !availableTiers[String(selectedTier)]) {
        alert('Please select a plan first.');
        return;
    }

    if (selectedPlanKind === 'lifetime') {
        const offer = lifetimeByKey[selectedLifetimeTier] || getLifetimeOfferForTier(selectedTier);
        if (!offer || !offer.has_remaining) {
            alert('That lifetime tier is sold out. Please choose another option.');
            return;
        }
        selectedLifetimeTier = offer.key;
        selectedTier = String(offer.tier_id);
    } else if (selectedPlanKind === 'yearly') {
        const tierData = getTierData(selectedTier);
        if (!tierData || !tierData.yearly_price_display) {
            alert('Yearly pricing is not configured for this tier yet. Please choose monthly.');
            return;
        }
    }

    const billingMode = selectedPlanKind === 'lifetime' ? 'lifetime' : 'standard';
    const billingCycle = selectedPlanKind === 'lifetime' ? 'lifetime' : (selectedPlanKind === 'yearly' ? 'yearly' : 'monthly');

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("auth.signup") }}';

    const entries = [
        ['csrf_token', '{{ csrf_token() }}'],
        ['selected_tier', selectedTier],
        ['billing_mode', billingMode],
        ['billing_cycle', billingCycle],
    ];

    if (signupSource) entries.push(['source', signupSource]);
    if (referralCode) entries.push(['ref', referralCode]);

    if (billingMode === 'lifetime' && selectedLifetimeTier && lifetimeByKey[selectedLifetimeTier]) {
        entries.push(['lifetime_tier', selectedLifetimeTier]);
        entries.push(['promo', lifetimeByKey[selectedLifetimeTier].coupon_code || '']);
    } else if (initialPromoCode) {
        entries.push(['promo', initialPromoCode]);
    }

    try {
        const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        entries.push(['detected_timezone', detectedTimezone]);
    } catch (error) {
        console.warn('Timezone detection failed', error);
    }

    {% if oauth_user_info %}
    entries.push(['oauth_signup', 'true']);
    {% endif %}

    entries.forEach(([name, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
}

document.addEventListener('DOMContentLoaded', () => {
    const tierShells = Array.from(document.querySelectorAll('.tier-stack-shell'));

    tierShells.forEach((shell) => {
        const cards = Array.from(shell.querySelectorAll('.stack-plan-card'));
        cards.forEach((card) => {
            card.addEventListener('click', () => {
                selectPlanCard(shell, card, { syncSelection: true });
            });
        });
    });

    if (!selectedTier || !getTierData(selectedTier)) {
        selectedTier = getPreferredTierId();
    }

    if (!['lifetime', 'yearly', 'monthly'].includes(selectedPlanKind)) {
        selectedPlanKind = getDefaultPlanKindForTier(selectedTier);
    }

    if (selectedPlanKind === 'lifetime') {
        const offer = selectedLifetimeTier ? lifetimeByKey[selectedLifetimeTier] : getLifetimeOfferForTier(selectedTier);
        if (offer && offer.has_remaining && offer.tier_id) {
            selectedLifetimeTier = offer.key;
            selectedTier = String(offer.tier_id);
        } else {
            selectedLifetimeTier = '';
            selectedPlanKind = getDefaultPlanKindForTier(selectedTier);
        }
    }

    const initialTierData = getTierData(selectedTier);
    if (selectedPlanKind === 'yearly' && !(initialTierData && initialTierData.yearly_price_display)) {
        selectedPlanKind = 'monthly';
    }

    const selectedShell = tierShells.find((shell) => {
        return String(shell.dataset.tierId || '') === String(selectedTier);
    });

    if (selectedShell) {
        const matchingCard = Array.from(selectedShell.querySelectorAll('.stack-plan-card')).find((card) => {
            return card.dataset.planKind === selectedPlanKind;
        });
        const fallbackCard = selectedShell.querySelector('.stack-plan-card');
        selectPlanCard(selectedShell, matchingCard || fallbackCard, { syncSelection: false });
    } else {
        const fallbackShell = tierShells.find((shell) => {
            return Boolean(String(shell.dataset.tierId || ''));
        });
        if (fallbackShell) {
            selectedTier = String(fallbackShell.dataset.tierId);
            selectedPlanKind = getDefaultPlanKindForTier(selectedTier);
            const matchingCard = Array.from(fallbackShell.querySelectorAll('.stack-plan-card')).find((card) => {
                return card.dataset.planKind === selectedPlanKind;
            });
            const fallbackCard = fallbackShell.querySelector('.stack-plan-card');
            selectPlanCard(fallbackShell, matchingCard || fallbackCard, { syncSelection: false });
        }
    }

    updateSelectionState();
    updatePlanSummary();
});
</script>

<style>
.tier-stack-shell {
    border: 2px solid #d8e0ef;
    border-radius: 1rem;
    background: #f7f9ff;
    padding: 1rem;
    box-shadow: 0 6px 18px rgba(17, 28, 56, 0.08);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
}

.tier-stack-shell.is-recommended {
    background: linear-gradient(180deg, rgba(25, 135, 84, 0.08), rgba(247, 249, 255, 0.9));
}

.tier-stack-shell.selected-tier {
    border-color: #198754;
    box-shadow: 0 10px 24px rgba(25, 135, 84, 0.2);
    transform: translateY(-2px);
}

.tier-plan-stack {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    padding-bottom: 0.2rem;
}

.stack-plan-card {
    position: relative;
    border: 2px solid #b8c7e4;
    border-radius: 0.95rem;
    background: #ffffff;
    box-shadow: 0 4px 14px rgba(17, 28, 56, 0.08);
    overflow: hidden;
    cursor: pointer;
    transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
}

.stack-plan-card + .stack-plan-card {
    margin-top: -1.1rem;
    margin-left: 0.8rem;
}

.stack-plan-card:nth-of-type(1) {
    z-index: 3;
}

.stack-plan-card:nth-of-type(2) {
    z-index: 2;
}

.stack-plan-card:nth-of-type(3) {
    z-index: 1;
    margin-left: 1.45rem;
}

.stack-plan-card .stack-plan-peek {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.35rem;
    padding: 0.75rem 0.9rem;
    font-weight: 700;
    letter-spacing: 0.01em;
    text-transform: uppercase;
    font-size: 0.82rem;
    background: #edf2ff;
}

.stack-plan-card[data-plan-kind="lifetime"] .stack-plan-peek {
    background: linear-gradient(90deg, rgba(111, 66, 193, 0.14), rgba(111, 66, 193, 0.05));
}

.stack-plan-card[data-plan-kind="yearly"] .stack-plan-peek {
    background: linear-gradient(90deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.04));
}

.stack-plan-card[data-plan-kind="monthly"] .stack-plan-peek {
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.12), rgba(108, 117, 125, 0.04));
}

.stack-plan-card .stack-plan-body {
    padding: 0.8rem 0.95rem 0.95rem;
    border-top: 1px solid #e4e9f4;
    min-height: 7.5rem;
}

.stack-plan-card.is-selected-plan {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(17, 28, 56, 0.15);
    z-index: 6;
}

.stack-plan-card.is-checkout-selected {
    border-color: #198754;
    box-shadow: 0 10px 24px rgba(25, 135, 84, 0.2);
}

.stack-plan-card.is-disabled {
    opacity: 0.76;
}

.features-checklist {
    list-style: none;
    padding: 0;
    margin: 0;
    columns: 2;
    column-gap: 1.5rem;
}

.features-checklist li {
    break-inside: avoid;
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.7rem;
    font-size: 0.96rem;
}

@media (max-width: 768px) {
    .tier-stack-shell {
        padding: 0.85rem;
    }

    .stack-plan-card + .stack-plan-card,
    .stack-plan-card:nth-of-type(3) {
        margin-top: 0.65rem;
        margin-left: 0;
    }

    .stack-plan-card .stack-plan-body {
        min-height: auto;
    }

    .features-checklist {
        columns: 1;
    }
}

.soft-success-badge {
    background-color: rgba(25, 135, 84, 0.12);
}
</style>
{% endblock %}
