
{% extends "layout.html" %}

{% block title %}Plan Production - {{ recipe.name }}{% endblock %}

{% block content %}
<div x-data="planProductionData()" class="container-fluid">
  
  <!-- Page Header -->
  {% include 'components/plan_production/page_header.html' %}

  <div class="row">
    <!-- Left Column - Recipe Info & Stock Check -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-utensils"></i> Recipe: {{ recipe.name }}
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Description:</strong> {{ recipe.description or 'No description' }}</p>
              <p><strong>Yield:</strong> {{ recipe.predicted_yield or 'Not specified' }} {{ recipe.predicted_yield_unit or '' }}</p>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="scale">Production Scale:</label>
                <input type="number" id="scale" class="form-control" 
                       x-model="scale" min="0.1" step="0.1" value="1.0">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock Check Component -->
      {% include 'components/plan_production/stock_check.html' %}
    </div>

    <!-- Right Column - Batch Configuration -->
    <div class="col-lg-4">
      <!-- Batch Configuration -->
      {% include 'components/plan_production/batch_configuration.html' %}

      <!-- Container Management -->
      {% include 'components/plan_production/container_management.html' %}

      <!-- Action Buttons -->
      {% include 'components/plan_production/action_buttons.html' %}
    </div>
  </div>
</div>

<script>
function planProductionData() {
    return {
        // Recipe data
        recipeId: {{ recipe.id }},
        recipeName: "{{ recipe.name }}",
        scale: 1.0,
        
        // Stock check state
        stockChecked: false,
        stockCheckPassed: false,
        stockResults: [],
        
        // Container state
        containersSelected: [],
        autoFill: false,
        containmentPercent: 0,
        containmentIssue: '',
        liveContainmentMessage: 'No containers selected',
        
        // Batch configuration
        batchName: '',
        scheduleProduction: false,
        canStartBatch: false,
        totalCost: 0,
        
        // Methods
        async checkStock() {
            try {
                const response = await fetch(`/recipes/${this.recipeId}/plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scale: this.scale,
                        container_id: this.containersSelected[0]?.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.stockChecked = true;
                    this.stockCheckPassed = data.all_available;
                    this.stockResults = data.stock_results || [];
                    this.totalCost = data.cost_info?.total_cost || 0;
                    this.updateBatchReadiness();
                } else {
                    alert('Stock check failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Stock check error:', error);
                alert('Failed to check stock. Please try again.');
            }
        },
        
        updateBatchReadiness() {
            this.canStartBatch = this.stockCheckPassed && this.containersSelected.length > 0;
        },
        
        startBatch() {
            if (this.canStartBatch) {
                // Navigate to batch start or show success message
                window.location.href = `/batches/start?recipe_id=${this.recipeId}&scale=${this.scale}`;
            }
        }
    };
}
</script>

{% endblock %}
