
{% extends 'layout.html' %}

{% block content %}
<div x-data="planProductionData()" x-init="init()">
  <!-- Page Header -->
  {% include 'components/plan_production/page_header.html' %}

  <!-- Recipe Information Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-utensils"></i> Recipe Information
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Description:</strong> {{ recipe.description or 'No description available' }}</p>
          <p><strong>Yield:</strong> {{ recipe.yield_amount }} {{ recipe.yield_unit }}</p>
          <p><strong>Prep Time:</strong> {{ recipe.prep_time_minutes or 'Not specified' }} minutes</p>
        </div>
        <div class="col-md-6">
          <p><strong>Instructions:</strong></p>
          <div class="instruction-text">
            {{ recipe.instructions | safe if recipe.instructions else 'No instructions provided' }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Batch Configuration -->
  {% include 'components/plan_production/batch_configuration.html' %}

  <!-- Stock Check Section -->
  {% include 'components/plan_production/stock_check.html' %}

  <!-- Container Management -->
  {% include 'components/plan_production/container_management.html' %}

  <!-- Containment Progress -->
  {% include 'components/plan_production/containment_progress.html' %}

  <!-- Action Buttons -->
  {% include 'components/plan_production/action_buttons.html' %}
</div>

<script>
function planProductionData() {
  return {
    recipe: {{ recipe | tojson }},
    scale: 1,
    stockChecked: false,
    stockCheckPassed: false,
    stockCheckResults: [],
    
    containers: [],
    selectedContainers: [],
    containmentPercent: 0,
    liveContainmentMessage: 'No containers selected',
    
    async init() {
      console.log('Plan Production initialized for recipe:', this.recipe.name);
    },
    
    async checkStock() {
      try {
        this.stockChecked = false;
        
        const response = await fetch(`/recipes/${this.recipe.id}/check-stock`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
          },
          body: JSON.stringify({ scale: this.scale })
        });
        
        if (response.ok) {
          const data = await response.json();
          this.stockCheckResults = data.stock_check || [];
          this.stockCheckPassed = data.all_ok || false;
          this.stockChecked = true;
        } else {
          console.error('Stock check failed:', response.statusText);
        }
      } catch (error) {
        console.error('Error checking stock:', error);
      }
    },
    
    async startBatch() {
      if (!this.stockChecked || !this.stockCheckPassed) {
        alert('Please run a successful stock check before starting a batch.');
        return;
      }
      
      const formData = new FormData();
      formData.append('recipe_id', this.recipe.id);
      formData.append('scale', this.scale);
      formData.append('csrf_token', document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '');
      
      try {
        const response = await fetch('/batches/start', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          window.location.href = await response.text();
        } else {
          alert('Failed to start batch. Please try again.');
        }
      } catch (error) {
        console.error('Error starting batch:', error);
        alert('Error starting batch. Please try again.');
      }
    }
  }
}
</script>
{% endblock %}
