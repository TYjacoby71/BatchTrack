{# File: pages/recipes/recipe_form.html
   Synopsis: Create/edit recipe form with versioning context and locked prefix rules.
   Glossary: Test = editable trial version; Variation = branch off master; Prefix = label code. #}
{% extends 'layout.html' %}
{# --- Content block ---
   Purpose: Collect recipe inputs with version-aware gating and helpers. #}
{% block content %}

{% set preselect_ingredient_id = session.pop('preselect_ingredient_id', None) %}
{% set add_ingredient_line = session.pop('add_ingredient_line', False) %}
{% set field_values = form_values if form_values is defined else None %}
{% set is_test_mode = is_test or (recipe and recipe.test_sequence) %}
{% set is_edit_mode = edit_mode if edit_mode is defined else false %}
{% set force_edit_mode = force_edit if force_edit is defined else false %}
{% set is_variation_mode = (not is_test_mode) and (is_variation or (recipe and recipe.parent_recipe_id)) %}
{% set is_master_edit = recipe and recipe.is_master and is_edit_mode %}
{% set lock_name = is_test_mode or is_variation_mode %}
{% set lock_prefix = is_test_mode or is_variation_mode or is_master_edit %}
{% set should_auto_prefix = (not is_edit_mode) and (not is_variation_mode) and (not is_test_mode) %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="d-flex align-items-center gap-2">
        {% if recipe %}
            {% if is_test_mode %}
                Edit Test
            {% elif recipe.parent_recipe_id %}
                Edit Variation
            {% else %}
                Edit Recipe
            {% endif %}
        {% else %}
            {% if is_test_mode %}
                New Test
            {% elif is_variation %}
                New Variation
            {% else %}
                New Recipe
            {% endif %}
        {% endif %}
        {% if is_test_mode %}
            <span class="badge bg-info text-dark">Test{% if recipe and recipe.test_sequence %} {{ recipe.test_sequence }}{% endif %}</span>
        {% endif %}
        {% if recipe and recipe.status == 'draft' %}
            <span class="badge bg-warning text-dark">Draft</span>
        {% endif %}
    </h2>
    <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-outline-secondary d-flex align-items-center gap-2" data-nav-warning="true">
        <i class="fas fa-arrow-left"></i> 
        <span>Back to Recipes</span>
        <small class="text-danger">Save or data may be lost</small>
    </a>
</div>

{% if is_test_mode %}
<div class="alert alert-info mb-4">
    <i class="fas fa-flask"></i>
    Tests must change ingredients, yield, or instructions. Names and label prefixes are generated from the lineage.
</div>
{% endif %}

{% if force_edit_mode %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle"></i>
    You are editing a published recipe. Changes will be recorded in recipe notes with a timestamp.
</div>
{% endif %}

{% if recipe and recipe.parent %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> <strong>Variation of:</strong> {{ recipe.parent.name }}
</div>
{% elif is_variation and parent_recipe %}
<div class="alert alert-info mb-4">
    <i class="fas fa-plus-circle"></i> <strong>New Variation:</strong> Based on {{ parent_recipe.name }}
</div>
{% elif is_import and recipe %}
<div class="alert alert-info mb-4">
    <i class="fas fa-file-import"></i> <strong>Imported recipe:</strong> Review details before saving.
</div>
{% endif %}

{% if draft_prompt is defined and draft_prompt %}
<div class="alert alert-warning d-flex flex-column flex-md-row gap-3 align-items-md-center mb-4" id="draftMissingFieldsAlert">
    <div class="flex-grow-1">
        <strong><i class="fas fa-exclamation-triangle me-1"></i> Missing information</strong>
        <ul class="mb-2">
            {% for field in draft_prompt.missing_fields %}
            <li>{{ field.capitalize() }}</li>
            {% endfor %}
        </ul>
        <p class="mb-2 mb-md-0">Fix the fields above or save what you have as a draft.</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-warning" data-role="dismiss-draft-prompt">
            <i class="fas fa-edit"></i> I'll fix it
        </button>
        {% if not is_test_mode %}
        <button type="button" class="btn btn-outline-primary" id="promptSaveDraftButton">
            <i class="fas fa-file-alt"></i> Save Draft
        </button>
        {% endif %}
    </div>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" action="{% if is_test_mode and not edit_mode %}{{ url_for('recipes.create_test_version', recipe_id=test_base_id) }}{% elif is_variation %}{{ url_for('recipes.create_variation', recipe_id=recipe.parent_recipe_id) }}{% elif recipe and edit_mode %}{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}{% else %}{{ url_for('recipes.new_recipe') }}{% endif %}" id="recipeForm" data-preselect-ingredient-id="{{ preselect_ingredient_id if preselect_ingredient_id else '' }}" data-should-add-line="{{ 'true' if add_ingredient_line else 'false' }}" data-original-yield-unit="{{ recipe.predicted_yield_unit if recipe else '' }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% if cloned_from_id %}<input type="hidden" name="cloned_from_id" value="{{ cloned_from_id }}">{% endif %}
    {% if is_test_mode %}<input type="hidden" name="is_test" value="true">{% endif %}
    <input type="hidden" name="save_mode" id="saveModeInput" value="publish">
    {% if force_edit_mode %}<input type="hidden" name="force_edit" value="1">{% endif %}

    <!-- Basic Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-info-circle"></i> Basic Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="name" class="form-label">{% if is_variation_mode %}Variation Name{% else %}Recipe Name{% endif %}</label>
                        {% set name_value = field_values.get('name') if field_values else (recipe.name if recipe else '') %}
                        {% if is_variation_mode and recipe and recipe.variation_name %}
                            {% set name_value = recipe.variation_name %}
                        {% endif %}
                        <input type="text"
                               name="name"
                               class="form-control{% if lock_name %} bg-light{% endif %}"
                               value="{{ name_value }}"
                               {% if lock_name %}readonly{% endif %}
                               required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="{% if lock_prefix %}label_prefix_display{% else %}label_prefix{% endif %}" class="form-label">Label Prefix{% if not should_auto_prefix %} <span class="text-danger">*</span>{% endif %}</label>
                        <div class="d-flex align-items-center">
                            {% set label_prefix_value = field_values.get('label_prefix') if field_values else (recipe.label_prefix if recipe else '') %}
                            {% set display_prefix = label_prefix_display if label_prefix_display is defined and label_prefix_display else label_prefix_value %}
                            {% if lock_prefix %}
                            <input type="text"
                                   id="label_prefix_display"
                                   value="{{ display_prefix }}"
                                   class="form-control me-2 bg-light"
                                   readonly
                                   disabled>
                            <input type="hidden" name="label_prefix" value="{{ label_prefix_value }}">
                            {% else %}
                            <input type="text"
                                   id="label_prefix"
                                   name="label_prefix"
                                   value="{{ label_prefix_value }}"
                                   maxlength="8"
                                   class="form-control me-2{% if should_auto_prefix %} bg-light{% endif %}"
                                   data-auto-prefix="{{ 'true' if should_auto_prefix else 'false' }}"
                                   data-prefix-endpoint="{{ url_for('api.recipe_prefix') }}"
                                   {% if should_auto_prefix %}readonly{% else %}required{% endif %}>
                            {% endif %}
                            <i class="fas fa-info-circle text-muted" 
                               data-bs-toggle="popover" 
                               data-bs-placement="right"
                               data-bs-trigger="click"
                               data-bs-html="true"
                               data-bs-content="
                                 <div>
                                   <strong>Label Prefix Guidelines:</strong><br>
                                   • Used for batch labeling<br>
                                   • Example: <u>SOAP</u>-2024-001<br>
                                   • Must be unique across all recipes<br>
                                   • Maximum 8 characters<br>
                                   • Only letters and numbers recommended
                                 </div>"
                               title="Label Prefix Help"
                               style="cursor: pointer;">
                            </i>
                        </div>
                        {% if should_auto_prefix %}
                        <div class="form-text">Auto-generated from the recipe name.</div>
                        {% elif lock_prefix %}
                        <div class="form-text">Generated from lineage and locked for edits.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
                  <label for="instructions" class="form-label">Instructions</label>
                  <textarea name="instructions" class="form-control" rows="4" placeholder="Enter detailed instructions for this recipe...">{{ field_values.get('instructions') if field_values else (recipe.instructions if recipe else '') }}</textarea>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="category_id" class="form-label">Product Category <span class="text-danger">*</span></label>
                          {% set selected_cat = field_values.get('category_id')|int if field_values and field_values.get('category_id') else (recipe.category_id if recipe else None) %}
                          <select id="category_id" name="category_id" class="form-select" required>
                            <option value="">Select category</option>
                            {% for c in product_categories %}
                            <option value="{{ c.id }}" data-is-portioned="{{ 'true' if c.is_typically_portioned else 'false' }}" data-skin-enabled="{{ 'true' if c.skin_enabled else 'false' }}" {% if selected_cat and selected_cat == c.id %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text" id="categoryHint" style="display:none;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {% if recipe_sharing_enabled %}
    {% set sharing_scope_value = field_values.get('sharing_scope') if field_values and field_values.get('sharing_scope') else ('public' if recipe and recipe.is_public else 'private') %}
    {% set sale_mode_value = field_values.get('sale_mode') if field_values and field_values.get('sale_mode') else ('sale' if recipe and recipe.is_for_sale else 'free') %}
{% set sale_lock = recipe and (recipe.is_sellable is false) %}
    {% if sale_lock %}
        {% set sale_mode_value = 'free' %}
    {% endif %}
    {% if not recipe_purchase_enabled %}
        {% set sale_mode_value = 'free' %}
    {% endif %}
    {% set sale_price_value = field_values.get('sale_price') if field_values and field_values.get('sale_price') not in (None, '') else (recipe.sale_price if recipe and recipe.sale_price else '') %}
    {% set notes_value = field_values.get('marketplace_notes') if field_values and field_values.get('marketplace_notes') is not none else (recipe.marketplace_notes if recipe else '') %}
    {% set desc_value = field_values.get('public_description') if field_values and field_values.get('public_description') is not none else (recipe.public_description if recipe else '') %}
    {% set existing_cover_src = None %}
    {% if recipe and recipe.cover_image_path %}
        {% set existing_cover_src = url_for('static', filename=recipe.cover_image_path) %}
    {% elif recipe and recipe.cover_image_url %}
        {% set existing_cover_src = recipe.cover_image_url %}
    {% endif %}
    {% set remove_cover_value = field_values.get('remove_cover_image') if field_values and field_values.get('remove_cover_image') is not none else 'false' %}
    {% set cover_preview_hidden = (remove_cover_value == 'true') or (not existing_cover_src) %}
    <div class="card mb-4" id="marketplaceCard">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-store"></i> Recipe Library & Marketplace
            </h5>
            <span class="badge bg-info text-dark">Permission</span>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">Control whether this recipe stays private to your organization or appears in the global recipe library. Public recipes can optionally include a cover image and price.</p>
            <div class="btn-group" role="group" aria-label="Sharing scope">
                <input type="radio" class="btn-check" name="sharing_scope" id="sharingScopePrivate" value="private" autocomplete="off" {% if sharing_scope_value != 'public' %}checked{% endif %}>
                <label class="btn btn-outline-secondary" for="sharingScopePrivate">
                    <i class="fas fa-lock"></i> Private (Org Only)
                </label>
                <input type="radio" class="btn-check" name="sharing_scope" id="sharingScopePublic" value="public" autocomplete="off" {% if sharing_scope_value == 'public' %}checked{% endif %}>
                <label class="btn btn-outline-success" for="sharingScopePublic">
                    <i class="fas fa-globe"></i> Public Library
                </label>
            </div>
            <div id="publicMarketplaceFields" class="border rounded p-3 mt-3" style="display: {% if sharing_scope_value == 'public' %}block{% else %}none{% endif %};">
                <label class="form-label fw-semibold">Listing Type</label>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="sale_mode" id="saleModeFree" value="free" {% if sale_mode_value != 'sale' %}checked{% endif %}>
                        <label class="form-check-label" for="saleModeFree">Free download</label>
                    </div>
                    {% if recipe_purchase_enabled %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="sale_mode" id="saleModeSale" value="sale" {% if sale_mode_value == 'sale' %}checked{% endif %} {% if sale_lock %}disabled{% endif %}>
                        <label class="form-check-label" for="saleModeSale">For sale</label>
                    </div>
                    {% endif %}
                </div>
                {% if sale_lock %}
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-lock"></i>
                    This recipe can't be marked for sale until it qualifies as a unique, sellable work.
                </div>
                {% endif %}
                {% if recipe_purchase_enabled %}
                    <div class="row g-3 align-items-end mt-2" id="salePriceRow" style="display: {% if sale_mode_value == 'sale' and not sale_lock %}flex{% else %}none{% endif %};">
                        <div class="col-md-4">
                            <label class="form-label">Sale price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" name="sale_price" class="form-control" value="{{ sale_price_value }}">
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-secondary mt-3 mb-0">
                        <i class="fas fa-lock"></i>
                        Sale listings require marketplace purchase permission.
                    </div>
                {% endif %}
                <div class="mt-3">
                    <label class="form-label">Marketplace notes</label>
                    <textarea name="marketplace_notes" class="form-control" rows="2" placeholder="Short blurb shown on public cards">{{ notes_value }}</textarea>
                </div>
                {% if recipe_purchase_enabled %}
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="product_store_url" class="form-label">Product Store Link</label>
                        <input type="text" id="product_store_url" name="product_store_url" class="form-control" placeholder="https://yourstore.com/products/..." value="{{ store_url_value }}">
                        <div class="form-text">Optional link displayed only when the recipe is listed as public.</div>
                    </div>
                </div>
                {% endif %}
                <div class="mt-3" id="publicDescriptionRow" style="display: {% if sharing_scope_value == 'public' %}block{% else %}none{% endif %};">
                    <label class="form-label">Public description</label>
                    <textarea name="public_description" class="form-control" rows="3" placeholder="Long-form description for visitors">{{ desc_value }}</textarea>
                </div>
                <div class="mt-3">
                    <label class="form-label">Cover image</label>
                    <input type="file" class="form-control" name="cover_image" accept="image/*">
                    <input type="hidden" name="remove_cover_image" id="removeCoverImageInput" value="{{ remove_cover_value }}">
                    <div id="coverImagePreview" class="mt-2 {% if cover_preview_hidden %}d-none{% endif %}">
                        {% if existing_cover_src %}
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <img src="{{ existing_cover_src }}" alt="Recipe cover" class="rounded border" style="max-height: 120px;">
                            <button type="button" class="btn btn-outline-danger btn-sm" data-role="remove-cover-image">
                                <i class="fas fa-times"></i> Remove existing image
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="form-text">Square images (at least 800px) look best in the library listing.</div>
                </div>
            </div>
            <p class="small text-muted mt-3 mb-0">Marketplace controls are managed by developers via Permissions → Recipe Library & Marketplace.</p>
        </div>
    </div>
    {% endif %}
    {% set skin_pref = field_values.get('skin_opt_in') if field_values and field_values.get('skin_opt_in') is not none else ('true' if (not recipe) or (recipe and recipe.skin_opt_in) else 'false') %}
    <input type="hidden" name="skin_opt_in" id="skinOptInInput" value="{{ skin_pref }}">
    <!-- Yield Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-balance-scale"></i> Expected Yield
            </h5>
        </div>
        <div class="card-body">
            <div class="row" id="bulkYieldRow">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="predicted_yield" class="form-label">Projected Yield Amount</label>
                              <input type="number" class="form-control" id="predicted_yield" name="predicted_yield" value="{{ field_values.get('predicted_yield') if field_values else (recipe.predicted_yield if recipe else '') }}" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="predicted_yield_unit" class="form-label">Projected Yield Unit</label>
                              {% set unit_selected = field_values.get('predicted_yield_unit') if field_values else (recipe.predicted_yield_unit if recipe else '') %}
                              <select class="form-select" id="predicted_yield_unit" name="predicted_yield_unit">
                            <option value="">Select Unit</option>
                            {% for unit in inventory_units %}
                                  <option value="{{ unit.name }}" {% if unit_selected == unit.name %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                        {% if edit_mode and existing_batches and existing_batches > 0 %}
                        <div class="alert alert-warning mt-2" id="yieldUnitWarning" style="display: none;">
                            <small><strong>⚠️ Warning:</strong> You have already made {{ existing_batches }} batch{{ 'es' if existing_batches > 1 else '' }} using this recipe. If you change the yield unit, future batch outputs will be converted to match the storage unit in the inventory manager when creating intermediate ingredients.</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-check form-switch mt-1">
                          {% set portioned_enabled = (field_values and field_values.get('is_portioned') == 'true') or (recipe and recipe.portioning_data and recipe.portioning_data.get('is_portioned')) %}
                          <input class="form-check-input" type="checkbox" id="is_portioned_toggle" name="is_portioned" value="true" {% if portioned_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="is_portioned_toggle">This recipe is portioned into discrete units</label>
                    </div>
                </div>
            </div>

            <!-- Portioning Section -->
            <div id="portioningSection" class="mt-3" style="display:none;">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label class="form-label">This recipe makes how many portions?</label>
                              <input type="number" min="1" step="1" class="form-control" id="portion_count" name="portion_count" placeholder="e.g., 20" value="{{ field_values.get('portion_count') if field_values else (recipe.portioning_data.get('portion_count') if recipe and recipe.portioning_data else '') }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label class="form-label">What do you call a portion?</label>
                              <input type="text" class="form-control" id="portion_name" name="portion_name" placeholder="e.g., bars, cookies, bottles" value="{% if field_values and field_values.get('portion_name') %}{{ field_values.get('portion_name') }}{% elif recipe and recipe.portioning_data and recipe.portioning_data.get('portion_name') %}{{ recipe.portioning_data.get('portion_name') }}{% endif %}">
                            <div class="form-text">Start typing to see common count units. New terms allowed.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Category Skin Host -->
    <div class="card mb-4" id="categorySkinCard" style="display:none;">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0"><i class="fas fa-layer-group"></i> Category Skin</h5>
            <div class="form-check form-switch">
                {% set use_skin_checked = skin_pref != 'false' %}
                <input class="form-check-input" type="checkbox" id="useSkinToggle" {% if use_skin_checked %}checked{% endif %}>
                <label class="form-check-label" for="useSkinToggle">Use category skin</label>
            </div>
        </div>
        <div class="card-body" id="categorySkinHost"></div>
    </div>

    <!-- Category Info / Derivatives -->
    <div class="card mb-4" id="categoryInfoCard" style="display:none;">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="fas fa-info"></i> Info</h5>
        </div>
        <div class="card-body" id="categoryInfoHost"></div>
    </div>

    <!-- Category-specific aids are provided by the shared partial below -->

    <!-- Allowed Containers Card -->
    <div class="card mb-4" id="allowedContainersCard">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-box"></i> Allowed Containers
            </h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Select Allowed Containers</label>
                  {% if field_values %}
                      {% set selected_containers = field_values.getlist('allowed_containers[]') %}
                  {% else %}
                      {% set selected_containers = recipe.allowed_containers if recipe and recipe.allowed_containers else [] %}
                  {% endif %}
                  <div class="row g-2">
                    {% for container in all_containers %}
                      {% set is_checked = ((container.id|string) in selected_containers) or (container.id in selected_containers) %}
                      <div class="col-12 col-md-6 col-lg-4">
                        <div class="form-check border rounded p-2 h-100">
                          <input class="form-check-input"
                                 type="checkbox"
                                 name="allowed_containers[]"
                                 id="allowed_container_{{ container.id }}"
                                 value="{{ container.id }}"
                                 {% if is_checked %}checked{% endif %}>
                          <label class="form-check-label" for="allowed_container_{{ container.id }}">
                            <strong>{{ container.container_display_name }}</strong>
                            <div class="text-muted small">
                              Capacity: {{ container.capacity or '—' }} {{ container.capacity_unit or 'count' }}
                            </div>
                          </label>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  <small class="form-text text-muted d-block mt-2">
                    Leave all unchecked to allow <strong>all organization containers</strong> during Plan Production.
                  </small>
            </div>
        </div>
    </div>

    <!-- Ingredients Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i> Ingredients
            </h5>
            {% if false %}{% endif %}
            {% if recipe and recipe.parent_recipe_id or is_variation %}
    <button type="button" class="btn btn-sm btn-primary" onclick="addIngredient()">
        <i class="fas fa-plus"></i> Add Ingredient
    </button>
        {% endif %}
            <div id="ingredientActionControlsTop" class="btn-group" role="group" aria-label="Ingredient quick actions">
                <button type="button" class="btn btn-sm btn-primary" onclick="addIngredient()">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="openQuickCreateInventory()">
                    <i class="fas fa-bolt"></i> Quick Create Inventory
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openQuickCreateUnit()">
                    <i class="fas fa-ruler"></i> Quick Create Unit
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="ingredients-container">
              {% if recipe and recipe.recipe_ingredients %}
                    {% for assoc in recipe.recipe_ingredients %}
                    <div class="ingredient-entry row mb-3 p-3 border rounded" data-ingredient-id="{{ assoc.inventory_item_id }}">
                        <div class="col-md-4">
                            <label class="form-label">Ingredient</label>
                            <div class="position-relative">
                                <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off" value="{{ assoc.inventory_item.name if assoc.inventory_item else '' }}">
                                <input type="hidden" name="ingredient_ids[]" value="{{ assoc.inventory_item_id or '' }}">
                                <input type="hidden" name="global_item_ids[]" value="">
                                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.001" name="amounts[]" class="form-control" value="{{ assoc.quantity or '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Unit</label>
                            <select name="units[]" class="form-select" required>
                                {% for unit in inventory_units %}
                                <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="conversion-warning text-center small text-muted">
                                <!-- JS will inject conversion warning here -->
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                  {% elif ingredient_prefill %}
                      {% for entry in ingredient_prefill %}
                    <div class="ingredient-entry row mb-3 p-3 border rounded">
                        <div class="col-md-4">
                            <label class="form-label small">Ingredient</label>
                            <div class="position-relative">
                                  <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off" value="{{ entry.name or '' }}">
                                  <input type="hidden" name="ingredient_ids[]" value="{{ entry.inventory_item_id or '' }}">
                                  <input type="hidden" name="global_item_ids[]" value="{{ entry.global_item_id or '' }}">
                                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Amount</label>
                              <input type="number" step="0.01" name="amounts[]" class="form-control" value="{{ entry.quantity or '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Unit</label>
                              <select name="units[]" class="form-select" required data-preset-unit="{{ entry.unit }}">
                                {% for unit_choice in inventory_units %}
                                  <option value="{{ unit_choice.name }}" {% if unit_choice.name == entry.unit %}selected{% endif %}>{{ unit_choice.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="conversion-warning text-center small text-muted">
                                <!-- JS will inject conversion warning here -->
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <p>No ingredients added yet. Click "Add Ingredient" to get started.</p>
                </div>
                {% endif %}
            </div>
            <div id="ingredientActionControlsBottom" class="ingredient-actions-floating d-none" aria-hidden="true">
                <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 w-100">
                    <div class="flex-grow-1 text-muted small">
                        Keep adding ingredients without scrolling—quick actions stay docked here.
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="addIngredient()">
                            <i class="fas fa-plus"></i> Add Ingredient
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="openQuickCreateInventory()">
                            <i class="fas fa-bolt"></i> Quick Create Inventory
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="openQuickCreateUnit()">
                            <i class="fas fa-ruler"></i> Quick Create Unit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consumables Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-tools"></i> Consumables
            </h5>
            <div>
                <button type="button" class="btn btn-sm btn-primary" onclick="addConsumable()">
                    <i class="fas fa-plus"></i> Add Consumable
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="consumables-container">
              {% if recipe and recipe.recipe_consumables %}
                {% for assoc in recipe.recipe_consumables %}
                <div class="consumable-entry row mb-3 p-3 border rounded" data-consumable-id="{{ assoc.inventory_item_id }}">
                    <div class="col-md-4">
                        <label class="form-label">Consumable</label>
                        <select name="consumable_ids[]" class="form-select consumable-select" required>
                            <option value="">Select consumable...</option>
                            {% for item in all_consumables %}
                            <option value="{{ item.id }}" data-unit="{{ item.unit }}" {% if item.id == assoc.inventory_item_id %}selected{% endif %}>{{ item.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Amount</label>
                        <input type="number" step="0.01" name="consumable_amounts[]" class="form-control" value="{{ assoc.quantity or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Unit</label>
                        <select name="consumable_units[]" class="form-select" required>
                            {% for unit in inventory_units %}
                            <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-consumable w-100">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
              {% elif consumable_prefill %}
                  {% for entry in consumable_prefill %}
                  <div class="consumable-entry row mb-3 p-3 border rounded" data-consumable-id="{{ entry.inventory_item_id }}">
                      <div class="col-md-4">
                          <label class="form-label">Consumable</label>
                          <select name="consumable_ids[]" class="form-select consumable-select" required>
                              <option value="">Select consumable...</option>
                              {% for item in all_consumables %}
                              <option value="{{ item.id }}" data-unit="{{ item.unit }}" {% if item.id == entry.inventory_item_id %}selected{% endif %}>{{ item.name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                      <div class="col-md-3">
                          <label class="form-label small">Amount</label>
                          <input type="number" step="0.01" name="consumable_amounts[]" class="form-control" value="{{ entry.quantity or '' }}" required>
                      </div>
                      <div class="col-md-3">
                          <label class="form-label small">Unit</label>
                          <select name="consumable_units[]" class="form-select" required>
                              {% for unit in inventory_units %}
                              <option value="{{ unit.name }}" {% if unit.name == entry.unit %}selected{% endif %}>{{ unit.name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                      <div class="col-md-2 d-flex align-items-end">
                          <button type="button" class="btn btn-outline-danger btn-sm remove-consumable w-100">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </div>
                  {% endfor %}
              {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <p>No consumables added yet. Click "Add Consumable" to get started.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <!-- Exports Card -->
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-export"></i> Exports
            </h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-secondary" href="{% if recipe and recipe.id %}{{ url_for('exports.soap_inci_recipe', recipe_id=recipe.id) }}{% else %}#{% endif %}">Soap INCI</a>
                <a class="btn btn-outline-secondary" href="{% if recipe and recipe.id %}{{ url_for('exports.candle_label_recipe', recipe_id=recipe.id) }}{% else %}#{% endif %}">Candle Label</a>
                <a class="btn btn-outline-secondary" href="{% if recipe and recipe.id %}{{ url_for('exports.baker_sheet_recipe', recipe_id=recipe.id) }}{% else %}#{% endif %}">Baker Sheet</a>
                <a class="btn btn-outline-secondary" href="{% if recipe and recipe.id %}{{ url_for('exports.lotion_inci_recipe', recipe_id=recipe.id) }}{% else %}#{% endif %}">Lotion INCI</a>
            </div>
            {% if not recipe or not recipe.id %}
            <div class="form-text">Save the recipe to enable exports.</div>
            {% endif %}
            {% if current_user.is_authenticated and not has_permission(current_user, 'batches.create') %}
            <div class="alert alert-warning mt-3">
              <i class="fas fa-lock me-1"></i> Starting batches is a premium feature. <a href="{{ url_for('billing.upgrade') }}" class="alert-link">Upgrade</a> to enable batch creation.
            </div>
            {% endif %}
        </div>
    </div>
    <!-- Form Actions -->
    <div class="card">
        <div class="card-body">
            {% set publish_label = 'Save Recipe' %}
            {% if recipe and (recipe.parent_recipe_id or is_variation) %}
                {% set publish_label = 'Save Variation' %}
            {% endif %}
            {% if not recipe and is_variation %}
                {% set publish_label = 'Create Variation' %}
            {% elif not recipe and not is_variation %}
                {% set publish_label = 'Create Recipe' %}
            {% endif %}
            {% if recipe and recipe.status == 'draft' %}
                {% set publish_label = 'Publish Recipe' %}
            {% endif %}
            {% set draft_label = 'Save Draft' %}
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                  <div class="d-flex flex-wrap gap-2">
                      <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary" data-nav-warning="true">
                          <i class="fas fa-arrow-left"></i> Cancel
                      </a>
                      {% if recipe and not is_clone and not is_variation and not parent_recipe %}
                      <button type="button" class="btn btn-danger" onclick="confirmDelete({{ recipe.id }}, {{ 'true' if recipe.parent_recipe_id else 'false' }}, {{ recipe.variations|length }})">
                          <i class="fas fa-trash"></i> 
                          {% if recipe.parent_recipe_id %}Delete Variation{% elif recipe.variations %}Delete Recipe & Variations{% else %}Delete Recipe{% endif %}
                      </button>
                      {% endif %}
                  </div>
                  <div class="d-flex flex-wrap gap-2">
                      <button type="submit" class="btn btn-success" onclick="setSaveMode('publish')">
                          <i class="fas fa-save"></i> {{ publish_label }}
                      </button>
                      <button type="submit" class="btn btn-outline-secondary" onclick="setSaveMode('draft')">
                          <i class="fas fa-file-alt"></i> {{ draft_label }}
                      </button>
                  </div>
                  {% if current_user.is_authenticated and current_user.organization and (not current_user.organization.tier or current_user.organization.tier.is_billing_exempt) %}
                  <span class="text-muted small">Inventory is read-only on the Exempt tier. <a href="{{ url_for('billing.upgrade') }}">Upgrade</a> to adjust inventory or start batches.</span>
                  {% endif %}
            </div>
        </div>
    </div>
</form>

<!-- Drawer modals will be loaded dynamically via DrawerProtocol -->

<script src="{{ url_for('static', filename='js/components/suggestions.js') }}"></script>
<script src="{{ url_for('static', filename='js/recipes/recipe_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/recipes/skins/category_skins.js') }}"></script>
<script src="{{ url_for('static', filename='js/recipes/skins/baking_skin.js') }}"></script>
<script src="{{ url_for('static', filename='js/recipes/skins/cosmetics_skin.js') }}"></script>
<script>
const formEl = document.getElementById('recipeForm');
const saveModeInput = document.getElementById('saveModeInput');
let PRESELECT_INGREDIENT_ID = (formEl.getAttribute('data-preselect-ingredient-id') || '').trim();
PRESELECT_INGREDIENT_ID = PRESELECT_INGREDIENT_ID ? (parseInt(PRESELECT_INGREDIENT_ID, 10) || null) : null;
let SHOULD_ADD_LINE = (formEl.getAttribute('data-should-add-line') || 'false') === 'true';
let ingredientReturnContext = 'main';
let originalYieldUnit = (formEl.getAttribute('data-original-yield-unit') || '').trim();
const ingredientActionTop = document.getElementById('ingredientActionControlsTop');
const ingredientActionBottom = document.getElementById('ingredientActionControlsBottom');
let ingredientActionFloatVisible = false;

function getIngredientLineCount() {
    const container = document.getElementById('ingredients-container');
    if (!container) return 0;
    return container.querySelectorAll('.ingredient-entry').length;
}

function showFloatingIngredientActions() {
    if (!ingredientActionBottom) return;
    if (ingredientActionFloatVisible) return;
    ingredientActionFloatVisible = true;
    ingredientActionBottom.classList.remove('d-none');
    ingredientActionBottom.setAttribute('aria-hidden', 'false');
    const trigger = window.requestAnimationFrame || function(cb){ return setTimeout(cb, 16); };
    trigger(() => ingredientActionBottom.classList.add('is-visible'));
}

function hideFloatingIngredientActions() {
    if (!ingredientActionBottom) return;
    if (!ingredientActionFloatVisible && ingredientActionBottom.classList.contains('d-none')) return;
    ingredientActionFloatVisible = false;
    ingredientActionBottom.classList.remove('is-visible');
    ingredientActionBottom.setAttribute('aria-hidden', 'true');
    let finished = false;
    function finish() {
        if (finished) return;
        finished = true;
        ingredientActionBottom.classList.add('d-none');
        ingredientActionBottom.removeEventListener('transitionend', finish);
    }
    ingredientActionBottom.addEventListener('transitionend', finish);
    setTimeout(finish, 250);
}

function syncIngredientActionAnchors() {
    const hasIngredients = getIngredientLineCount() > 0;
    if (ingredientActionTop) {
        ingredientActionTop.classList.toggle('d-none', hasIngredients);
    }
    if (hasIngredients) {
        showFloatingIngredientActions();
    } else {
        hideFloatingIngredientActions();
    }
}

syncIngredientActionAnchors();

document.addEventListener('DOMContentLoaded', function() {
      const draftAlert = document.getElementById('draftMissingFieldsAlert');
      const draftDismissBtn = document.querySelector('[data-role="dismiss-draft-prompt"]');
      const promptDraftBtn = document.getElementById('promptSaveDraftButton');
      if (draftDismissBtn && draftAlert) {
          draftDismissBtn.addEventListener('click', function() {
              draftAlert.classList.add('d-none');
          });
      }
      if (promptDraftBtn) {
          promptDraftBtn.addEventListener('click', function() {
              setSaveMode('draft');
              if (formEl) {
                  formEl.requestSubmit();
              }
          });
      }
    // Initialize Bootstrap popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body'
        });
    });

    let formDirty = false;
    if (formEl) {
        formEl.addEventListener('input', function() {
            formDirty = true;
        });
    }

    document.querySelectorAll('[data-nav-warning="true"]').forEach(function(el) {
        el.addEventListener('click', function(event) {
            if (formDirty) {
                const confirmLeave = confirm('You have unsaved changes. Save before leaving or data may be lost.');
                if (!confirmLeave) {
                    event.preventDefault();
                }
            }
        });
    });

    // Close popover when clicking elsewhere
    document.addEventListener('click', function (e) {
        if (!e.target.closest('[data-bs-toggle="popover"]')) {
            popoverList.forEach(function(popover) {
                popover.hide();
            });
        }
    });

    // Handle ingredient removal using event delegation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            e.preventDefault();
            const ingredientEntry = e.target.closest('.ingredient-entry');
            if (ingredientEntry) {
                ingredientEntry.remove();

                // Check if we need to show empty state
                const container = document.getElementById('ingredients-container');
                const remainingEntries = container.querySelectorAll('.ingredient-entry');

                if (remainingEntries.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-plus-circle fa-2x mb-2"></i>
                            <p>No ingredients added yet. Click "Add Ingredient" to get started.</p>
                        </div>
                    `;
                }
                  syncIngredientActionAnchors();
            }
        }
    });

    if (SHOULD_ADD_LINE && PRESELECT_INGREDIENT_ID) {
        addIngredient(PRESELECT_INGREDIENT_ID);
    }

    {% if edit_mode and existing_batches and existing_batches > 0 %}
    // Show warning when yield unit is changed
    const yieldUnitSelect = document.getElementById('predicted_yield_unit');
    const yieldWarning = document.getElementById('yieldUnitWarning');

    if (yieldUnitSelect && yieldWarning) {
        yieldUnitSelect.addEventListener('change', function() {
            if (this.value !== originalYieldUnit && this.value !== '') {
                yieldWarning.style.display = 'block';
            } else {
                yieldWarning.style.display = 'none';
            }
        });
    }
    {% endif %}

    // Category-driven portioning guidance and containers visibility when portioned
    const categorySelect = document.getElementById('category_id');
    const isPortionedToggle = document.getElementById('is_portioned_toggle');
    const portioningSection = document.getElementById('portioningSection');
    const categoryHint = document.getElementById('categoryHint');
    const allowedContainersCard = document.getElementById('allowedContainersCard');

    function syncPortioningUI() {
        const on = isPortionedToggle.checked;
        portioningSection.style.display = on ? 'block' : 'none';
        if (allowedContainersCard) {
            allowedContainersCard.style.display = on ? 'none' : 'block';
        }
    }

    function onCategoryChange() {
        const sel = categorySelect.options[categorySelect.selectedIndex];
        const hint = sel ? (sel.getAttribute('data-is-portioned') === 'true') : false;
        if (hint) {
            isPortionedToggle.checked = true;
            categoryHint.style.display = 'block';
            categoryHint.innerHTML = '<small class="text-info">This category is typically portioned. Toggle can be changed.</small>';
        } else {
            if (!isPortionedToggle.dataset.userToggled) {
                isPortionedToggle.checked = false;
            }
            categoryHint.style.display = 'none';
            categoryHint.innerHTML = '';
        }
        syncPortioningUI();
    }

    if (categorySelect && isPortionedToggle) {
        categorySelect.addEventListener('change', onCategoryChange);
        isPortionedToggle.addEventListener('change', () => {
            isPortionedToggle.dataset.userToggled = 'true';
            syncPortioningUI();
        });
        onCategoryChange();
    }

    // Skin host visibility and mounting
    const skinCard = document.getElementById('categorySkinCard');
    const skinHost = document.getElementById('categorySkinHost');
    const infoCard = document.getElementById('categoryInfoCard');
    const useSkinToggle = document.getElementById('useSkinToggle');

    function currentCategoryName(){
        return categorySelect?.options[categorySelect.selectedIndex]?.textContent?.trim() || '';
    }

    function syncSkinVisibility(){
        const selected = currentCategoryName().toLowerCase();
        const sel = categorySelect?.options[categorySelect.selectedIndex];
        const skinEnabled = sel ? (sel.getAttribute('data-skin-enabled') === 'true') : false;
        const hasSkinType = window.CategorySkins && window.CategorySkins.hasSkinFor(selected);
        const showSkin = !!(skinEnabled && hasSkinType);
        if (skinCard) skinCard.style.display = showSkin ? 'block' : 'none';
        if (infoCard) infoCard.style.display = showSkin ? 'block' : 'none';
        if (showSkin && useSkinToggle?.checked){
            window.CategorySkins.mount(selected, skinHost, document.getElementById('categoryInfoHost'));
        } else if (window.CategorySkins) {
            window.CategorySkins.unmount();
        }
    }

    if (categorySelect){
        syncSkinVisibility();
        categorySelect.addEventListener('change', syncSkinVisibility);
    }
    if (useSkinToggle){
        useSkinToggle.addEventListener('change', syncSkinVisibility);
    }
    syncIngredientActionAnchors();

    const sharingScopeRadios = document.querySelectorAll('input[name="sharing_scope"]');
    const publicMarketplaceFields = document.getElementById('publicMarketplaceFields');
    const saleModeRadios = document.querySelectorAll('input[name="sale_mode"]');
    const salePriceRow = document.getElementById('salePriceRow');
    const removeCoverButton = document.querySelector('[data-role="remove-cover-image"]');
    const removeCoverInput = document.getElementById('removeCoverImageInput');
    const coverPreview = document.getElementById('coverImagePreview');
    const coverFileInput = document.querySelector('input[name="cover_image"]');
    const skinOptInput = document.getElementById('skinOptInInput');
    const publicDescriptionRow = document.getElementById('publicDescriptionRow');

    function syncMarketplaceVisibility(){
        if (!publicMarketplaceFields) return;
        const checked = document.querySelector('input[name="sharing_scope"]:checked');
        publicMarketplaceFields.style.display = (checked && checked.value === 'public') ? 'block' : 'none';
        if (publicDescriptionRow){
            publicDescriptionRow.style.display = (checked && checked.value === 'public') ? 'block' : 'none';
        }
    }

    function syncSaleMode(){
        if (!salePriceRow) return;
        const mode = document.querySelector('input[name="sale_mode"]:checked');
        salePriceRow.style.display = (mode && mode.value === 'sale') ? 'flex' : 'none';
    }

    sharingScopeRadios.forEach(radio => radio.addEventListener('change', syncMarketplaceVisibility));
    saleModeRadios.forEach(radio => radio.addEventListener('change', syncSaleMode));
    syncMarketplaceVisibility();
    syncSaleMode();

    if (removeCoverButton && removeCoverInput && coverPreview){
        removeCoverButton.addEventListener('click', function(){
            coverPreview.classList.add('d-none');
            removeCoverInput.value = 'true';
        });
    }
    if (coverFileInput && removeCoverInput){
        coverFileInput.addEventListener('change', function(){
            if (coverFileInput.files && coverFileInput.files.length){
                removeCoverInput.value = 'false';
                if (coverPreview){
                    coverPreview.classList.add('d-none');
                }
            }
        });
    }
    if (skinOptInput && useSkinToggle){
        skinOptInput.value = useSkinToggle.checked ? 'true' : 'false';
        useSkinToggle.addEventListener('change', function(){
            skinOptInput.value = useSkinToggle.checked ? 'true' : 'false';
        });
    }
});

function addIngredient(preselectId = null, presetUnit = null) {
    const container = document.getElementById('ingredients-container');

    // Remove empty state message if it exists
    const emptyState = container.querySelector('.text-center.text-muted');
    if (emptyState) {
        emptyState.remove();
    }

    const entry = document.createElement('div');
    entry.classList.add('ingredient-entry', 'row', 'mb-3', 'p-3', 'border', 'rounded');
    entry.innerHTML = `
        <div class="col-md-4">
            <label class="form-label small">Ingredient</label>
            <div class="position-relative">
                <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off">
                <input type="hidden" name="ingredient_ids[]" value="">
                <input type="hidden" name="global_item_ids[]" value="">
                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Amount</label>
            <input type="number" step="0.01" name="amounts[]" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Unit</label>
            <select name="units[]" class="form-select" required>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="col-12 mt-2">
            <div class="conversion-warning text-center small text-muted">
                <!-- JS will inject conversion warning here -->
            </div>
        </div>
    `;
    container.appendChild(entry);
    syncIngredientActionAnchors();

    if (preselectId) {
        const hidden = entry.querySelector('input[name="ingredient_ids[]"]');
        if (hidden) hidden.value = String(preselectId);
    }

    entry.scrollIntoView({ behavior: 'smooth' });
    return entry;
}

// Open drawers via DrawerProtocol
function openQuickCreateInventory() {
    const detail = {
        modal_url: '/api/drawers/inventory/quick-create-modal',
        success_event: 'inventory.created',
        error_type: 'inventory',
        error_code: 'quick_create'
    };
    window.dispatchEvent(new CustomEvent('openDrawer', { detail: detail }));
}

function openQuickCreateUnit() {
    const detail = {
        modal_url: '/api/drawers/units/quick-create-modal',
        success_event: 'unit.created',
        error_type: 'units',
        error_code: 'quick_create'
    };
    window.dispatchEvent(new CustomEvent('openDrawer', { detail: detail }));
}

function confirmDelete(recipeId, isVariation, variationCount) {
    let msg;
    if (isVariation) {
        msg = 'Are you sure you want to delete this variation?';
    } else if (variationCount > 0) {
        msg = 'Deleting the parent recipe will delete all variations under it.';
    } else {
        msg = 'Are you sure you want to delete this recipe?';
    }

    if (confirm(msg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/recipes/${recipeId}/delete`;

        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = '{{ csrf_token() }}';

        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    }
}

function setIngredientReturnContext(context) {
    ingredientReturnContext = context;
}

function updateConversionWarning(selectElement) {
    // Get the selected ingredient data
    const selectedOption = selectElement.selectedOptions[0];
    if (!selectedOption) return;

    const ingredientType = selectedOption.dataset.type;
    const ingredientUnit = selectedOption.dataset.unit;

    // Find the corresponding unit dropdown and warning div
    const ingredientEntry = selectElement.closest('.ingredient-entry');
    const unitSelect = ingredientEntry.querySelector('select[name="units[]"]');
    const warningDiv = ingredientEntry.querySelector('.conversion-warning');

    if (!unitSelect || !warningDiv) return;

    const selectedUnit = unitSelect.value;

    // Clear previous warnings
    warningDiv.innerHTML = '';

    // Show conversion warning if units don't match
    if (ingredientUnit && selectedUnit && ingredientUnit !== selectedUnit) {
        warningDiv.innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Will convert from ${selectedUnit} to ${ingredientUnit}</span>`;
    }
}

function addConsumable(preselectId = null) {
    const container = document.getElementById('consumables-container');
    const emptyState = container.querySelector('.text-center.text-muted');
    if (emptyState) emptyState.remove();

    const entry = document.createElement('div');
    entry.classList.add('consumable-entry', 'row', 'mb-3', 'p-3', 'border', 'rounded');
    entry.innerHTML = `
        <div class="col-md-4">
            <label class="form-label small">Consumable</label>
            <select name="consumable_ids[]" class="form-select" required>
                <option value="">Select a consumable</option>
                {% for item in all_consumables %}
                <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Amount</label>
            <input type="number" step="0.01" name="consumable_amounts[]" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Unit</label>
            <select name="consumable_units[]" class="form-select" required>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-consumable w-100">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(entry);

    if (preselectId) {
        const select = entry.querySelector('select[name="consumable_ids[]"]');
        if (select) select.value = preselectId;
    }
}

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-consumable')) {
        const entry = e.target.closest('.consumable-entry');
        if (entry) entry.remove();
    }
});

// Inline insertion after quick-create
window.addEventListener('inventory.created', function(e) {
    try {
        const item = e.detail && e.detail.item;
        if (!item) return;
        // Find last ingredient-entry or create one
        let entry = document.querySelector('.ingredient-entry:last-of-type');
        if (!entry) {
            entry = addIngredient();
        }
        const hidden = entry.querySelector('input[name="ingredient_ids[]"]');
        const input = entry.querySelector('input.recipe-ingredient-typeahead');
        if (hidden) hidden.value = String(item.id);
        if (input) input.value = item.name;
    } catch (_) {}
});

// Client-side validation: ensure each ingredient line has a selected item
document.getElementById('recipeForm').addEventListener('submit', function(e) {
    const rows = document.querySelectorAll('.ingredient-entry');
    for (const row of rows) {
        const inv = row.querySelector('input[name="ingredient_ids[]"]').value.trim();
        const gi = row.querySelector('input[name="global_item_ids[]"]').value.trim();
        const hasSelection = inv || gi;
        if (!hasSelection) {
            e.preventDefault();
            // Freeze and guide: highlight row and scroll into view instead of alert/reset
            row.classList.add('border-danger');
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const input = row.querySelector('input.recipe-ingredient-typeahead');
            if (input) input.focus();
            // Inline helper
            const warning = row.querySelector('.conversion-warning');
            if (warning) warning.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Select an ingredient from Inventory or Global.</span>';
            return false;
        }
    }
});

// Unified ingredient typeahead using shared component
(function(){
    function setupMerged(container){
        const input = container.querySelector('input.recipe-ingredient-typeahead');
        const invHidden = container.querySelector('input[name="ingredient_ids[]"]');
        const giHidden = container.querySelector('input[name="global_item_ids[]"]');
        const list = container.querySelector('[data-role="suggestions"]');
        if (!input || !giHidden || !list) return;
        if (typeof window.attachMergedInventoryGlobalTypeahead === 'function'){
            window.attachMergedInventoryGlobalTypeahead({ inputEl: input, invHiddenEl: invHidden, giHiddenEl: giHidden, listEl: list, mode: 'recipe', ingredientFirst: true });
        }
    }
    document.querySelectorAll('.ingredient-entry .position-relative').forEach(setupMerged);
    const originalAdd = addIngredient;
    window.addIngredient = function(preselectId, presetUnit){
        const entry = originalAdd(preselectId, presetUnit);
        const container = entry.querySelector('.position-relative');
        if (container) setupMerged(container);
        return entry;
    };
})();

function setSaveMode(mode) {
    if (!saveModeInput) return;
    saveModeInput.value = mode === 'draft' ? 'draft' : 'publish';
}

// Category aids JS moved into shared include
</script>

{% endblock %}