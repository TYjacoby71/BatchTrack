{% extends 'layout.html' %}
{% block content %}

{% set preselect_ingredient_id = session.pop('preselect_ingredient_id', None) %}
{% set add_ingredient_line = session.pop('add_ingredient_line', False) %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        {% if recipe %}
            {% if recipe.parent_id %}Edit Variation{% else %}Edit Recipe{% endif %}
        {% else %}
            {% if is_variation %}New Variation{% else %}New Recipe{% endif %}
        {% endif %}
    </h2>
    <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Recipes
    </a>
</div>

{% if recipe and recipe.parent %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> <strong>Variation of:</strong> {{ recipe.parent.name }}
</div>
{% elif is_variation and parent_recipe %}
<div class="alert alert-info mb-4">
    <i class="fas fa-plus-circle"></i> <strong>New Variation:</strong> Based on {{ parent_recipe.name }}
</div>
{% elif is_clone and recipe %}
<div class="alert alert-info mb-4">
    <i class="fas fa-copy"></i> <strong>Creating a copy of:</strong> {{ recipe.name }}
</div>
{% endif %}

<form method="post" action="{% if is_clone %}{{ url_for('recipes.new_recipe') }}{% elif is_variation %}{{ url_for('recipes.create_variation', recipe_id=recipe.parent_id) }}{% elif recipe and edit_mode %}{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}{% else %}{{ url_for('recipes.new_recipe') }}{% endif %}" id="recipeForm" data-preselect-ingredient-id="{{ preselect_ingredient_id if preselect_ingredient_id else '' }}" data-should-add-line="{{ 'true' if add_ingredient_line else 'false' }}" data-original-yield-unit="{{ recipe.predicted_yield_unit if recipe else '' }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% if is_clone %}<input type="hidden" name="is_clone" value="true">{% endif %}

    <!-- Basic Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-info-circle"></i> Basic Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="name" class="form-label">{% if recipe and recipe.parent_id or is_variation %}Variation Name{% else %}Recipe Name{% endif %}</label>
                        <input type="text" name="name" class="form-control" value="{{ recipe.name if recipe else '' }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="label_prefix" class="form-label">Label Prefix <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center">
                            <input type="text" id="label_prefix" name="label_prefix" value="{{ recipe.label_prefix if recipe else '' }}" maxlength="8" required class="form-control me-2">
                            <i class="fas fa-info-circle text-muted" 
                               data-bs-toggle="popover" 
                               data-bs-placement="right"
                               data-bs-trigger="click"
                               data-bs-html="true"
                               data-bs-content="
                                 <div>
                                   <strong>Label Prefix Guidelines:</strong><br>
                                   • Used for batch labeling<br>
                                   • Example: <u>SOAP</u>-2024-001<br>
                                   • Must be unique across all recipes<br>
                                   • Maximum 8 characters<br>
                                   • Only letters and numbers recommended
                                 </div>"
                               title="Label Prefix Help"
                               style="cursor: pointer;">
                            </i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
                <label for="instructions" class="form-label">Instructions</label>
                <textarea name="instructions" class="form-control" rows="4" placeholder="Enter detailed instructions for this recipe...">{{ recipe.instructions if recipe else '' }}</textarea>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="category_id" class="form-label">Product Category <span class="text-danger">*</span></label>
                        <select id="category_id" name="category_id" class="form-select" required>
                            <option value="">Select category</option>
                            {% set selected_cat = recipe.category_id if recipe else None %}
                            {% for c in product_categories %}
                            <option value="{{ c.id }}" data-is-portioned="{{ 'true' if c.is_typically_portioned else 'false' }}" {% if selected_cat and selected_cat == c.id %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text" id="categoryHint" style="display:none;"></div>
                    </div>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is_portioned_toggle" name="is_portioned" value="true" {% if recipe and recipe.portioning_data and recipe.portioning_data.get('is_portioned') %}checked{% endif %}>
                        <label class="form-check-label" for="is_portioned_toggle">This recipe is portioned into discrete units</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Yield Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-balance-scale"></i> Expected Yield
            </h5>
        </div>
        <div class="card-body">
            <div class="row" id="bulkYieldRow">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="predicted_yield" class="form-label">Projected Yield Amount</label>
                        <input type="number" class="form-control" id="predicted_yield" name="predicted_yield" value="{{ recipe.predicted_yield if recipe else '' }}" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="predicted_yield_unit" class="form-label">Projected Yield Unit</label>
                        <select class="form-select" id="predicted_yield_unit" name="predicted_yield_unit">
                            <option value="">Select Unit</option>
                            {% for unit in inventory_units %}
                            <option value="{{ unit.name }}" {% if recipe and recipe.predicted_yield_unit == unit.name %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                        {% if edit_mode and existing_batches and existing_batches > 0 %}
                        <div class="alert alert-warning mt-2" id="yieldUnitWarning" style="display: none;">
                            <small><strong>⚠️ Warning:</strong> You have already made {{ existing_batches }} batch{{ 'es' if existing_batches > 1 else '' }} using this recipe. If you change the yield unit, future batch outputs will be converted to match the storage unit in the inventory manager when creating intermediate ingredients.</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Portioning Section -->
            <div id="portioningSection" class="mt-3" style="display:none;">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label class="form-label">This recipe makes how many portions?</label>
                            <input type="number" min="1" step="1" class="form-control" id="portion_count" name="portion_count" placeholder="e.g., 20" value="{{ recipe.portioning_data.get('portion_count') if recipe and recipe.portioning_data else '' }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label class="form-label">What do you call a portion?</label>
                            <input type="text" class="form-control" id="portion_name" name="portion_name" placeholder="e.g., bars, cookies, bottles" value="{% if recipe and recipe.portioning_data and recipe.portioning_data.get('portion_name') %}{{ recipe.portioning_data.get('portion_name') }}{% endif %}">
                            <div class="form-text">Start typing to see common count units. New terms allowed.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Allowed Containers Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-box"></i> Allowed Containers
            </h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="allowed_containers" class="form-label">Select Allowed Containers</label>
                <select id="allowed_containers" name="allowed_containers[]" class="form-select container-select" multiple>
                    {% for container in all_ingredients if container.type == 'container' %}
                    <option value="{{ container.id }}" {% if recipe and recipe.allowed_containers and container.id in recipe.allowed_containers %}selected{% endif %}>
                        {{ container.name }} ({{ container.capacity }} {{ container.capacity_unit }})
                    </option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted">
                    Hold Ctrl (Cmd on Mac) to select multiple containers.<br>
                    <strong>Note:</strong> Container requirement is now determined during batch planning.
                </small>
            </div>
        </div>
    </div>

    <!-- Category Assistant (Specialized Forms) -->
    <div class="card mb-4" id="categoryAssistantCard" style="display:none;">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0"><i class="fas fa-magic"></i> Category Assistant</h5>
            <small class="text-muted">Helps you compute common fields by category. Units default to grams.</small>
        </div>
        <div class="card-body">
            <!-- Soaps -->
            <div id="assistant-soaps" class="assistant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Total oils (g)</label>
                        <input type="number" class="form-control" id="soap_oil_g" step="0.1" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Superfat (%)</label>
                        <input type="number" class="form-control" id="soap_superfat" step="0.1" min="0" max="20" value="5">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Lye Type</label>
                        <select id="soap_lye_type" class="form-select">
                            <option value="NaOH">NaOH (bar)</option>
                            <option value="KOH">KOH (liquid)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Water (% of oils)</label>
                        <input type="number" class="form-control" id="soap_water_pct" step="0.1" min="20" max="50" value="33">
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="soap_calc_btn">Calculate</button>
                    <div id="soap_result" class="align-self-center text-muted small"></div>
                </div>
            </div>

            <!-- Candles -->
            <div id="assistant-candles" class="assistant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Fill per candle (g)</label>
                        <input type="number" class="form-control" id="candle_fill_g" step="0.1" min="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fragrance Load (%)</label>
                        <input type="number" class="form-control" id="candle_fl_pct" step="0.1" min="0" max="15" value="8">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Count</label>
                        <input type="number" class="form-control" id="candle_count" step="1" min="1" value="1">
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="candle_calc_btn">Calculate</button>
                    <div id="candle_result" class="align-self-center text-muted small"></div>
                </div>
            </div>

            <!-- Lotions/Cosmetics -->
            <div id="assistant-lotions" class="assistant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Batch size (g)</label>
                        <input type="number" class="form-control" id="lotion_batch_g" step="0.1" min="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Water phase (%)</label>
                        <input type="number" class="form-control" id="lotion_water_pct" step="0.1" min="0" max="100" value="65">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Oil phase (%)</label>
                        <input type="number" class="form-control" id="lotion_oil_pct" step="0.1" min="0" max="100" value="30">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cool-down (%)</label>
                        <input type="number" class="form-control" id="lotion_cool_pct" step="0.1" min="0" max="100" value="5">
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="lotion_calc_btn">Calculate</button>
                    <div id="lotion_result" class="align-self-center text-muted small"></div>
                </div>
            </div>

            <!-- Baked Goods -->
            <div id="assistant-baked-goods" class="assistant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Flour (g)</label>
                        <input type="number" class="form-control" id="baker_flour_g" step="0.1" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hydration (%)</label>
                        <input type="number" class="form-control" id="baker_hydration" step="0.1" min="40" max="110" value="65">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Salt (%)</label>
                        <input type="number" class="form-control" id="baker_salt" step="0.1" min="0" max="5" value="2">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Yeast (%)</label>
                        <input type="number" class="form-control" id="baker_yeast" step="0.1" min="0" max="5" value="1">
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="baker_calc_btn">Calculate</button>
                    <div id="baker_result" class="align-self-center text-muted small"></div>
                </div>
            </div>

            <!-- Herbal -->
            <div id="assistant-herbal" class="assistant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Ratio (menstruum:herb)</label>
                        <input type="text" class="form-control" id="herbal_ratio" value="5:1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Herb (g)</label>
                        <input type="number" class="form-control" id="herbal_herb_g" step="0.1" min="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Alcohol (%)</label>
                        <input type="number" class="form-control" id="herbal_abv" step="1" min="0" max="100" value="40">
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="herbal_calc_btn">Calculate</button>
                    <div id="herbal_result" class="align-self-center text-muted small"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredients Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i> Ingredients
            </h5>
            {% if false %}{% endif %}
            {% if recipe and recipe.parent_id or is_variation %}
    <button type="button" class="btn btn-sm btn-primary" onclick="addIngredient()">
        <i class="fas fa-plus"></i> Add Ingredient
    </button>
{% endif %}
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-primary" onclick="addIngredient()">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="openQuickCreateInventory()">
                    <i class="fas fa-bolt"></i> Quick Create Inventory
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openQuickCreateUnit()">
                    <i class="fas fa-ruler"></i> Quick Create Unit
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="ingredients-container">
            {% if recipe and recipe.recipe_ingredients %}
                    {% for assoc in recipe.recipe_ingredients %}
                    <div class="ingredient-entry row mb-3 p-3 border rounded" data-ingredient-id="{{ assoc.inventory_item_id }}">
                        <div class="col-md-4">
                            <label class="form-label">Ingredient</label>
                            <div class="position-relative">
                                <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off" value="{{ assoc.inventory_item.name if assoc.inventory_item else '' }}">
                                <input type="hidden" name="ingredient_ids[]" value="{{ assoc.inventory_item_id or '' }}">
                                <input type="hidden" name="global_item_ids[]" value="">
                                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.001" name="amounts[]" class="form-control" value="{{ assoc.quantity or '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Unit</label>
                            <select name="units[]" class="form-select" required>
                                {% for unit in inventory_units %}
                                <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="conversion-warning text-center small text-muted">
                                <!-- JS will inject conversion warning here -->
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% elif ingredient_prefill %}
                    {% for ing_id, amount, unit in ingredient_prefill %}
                    <div class="ingredient-entry row mb-3 p-3 border rounded">
                        <div class="col-md-4">
                            <label class="form-label small">Ingredient</label>
                            <div class="position-relative">
                                <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off" value="">
                                <input type="hidden" name="ingredient_ids[]" value="{{ ing_id or '' }}">
                                <input type="hidden" name="global_item_ids[]" value="">
                                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Amount</label>
                            <input type="number" step="0.01" name="amounts[]" class="form-control" value="{{ amount }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Unit</label>
                            <select name="units[]" class="form-select" required data-preset-unit="{{ unit }}">
                                {% for unit_choice in inventory_units %}
                                <option value="{{ unit_choice.name }}" {% if unit_choice.name == unit %}selected{% endif %}>{{ unit_choice.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="conversion-warning text-center small text-muted">
                                <!-- JS will inject conversion warning here -->
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <p>No ingredients added yet. Click "Add Ingredient" to get started.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% include 'components/recipes/_category_fields.html' %}

    <!-- Consumables Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-tools"></i> Consumables
            </h5>
            <div>
                <button type="button" class="btn btn-sm btn-primary" onclick="addConsumable()">
                    <i class="fas fa-plus"></i> Add Consumable
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="consumables-container">
            {% if recipe and recipe.recipe_consumables %}
                {% for assoc in recipe.recipe_consumables %}
                <div class="consumable-entry row mb-3 p-3 border rounded" data-consumable-id="{{ assoc.inventory_item_id }}">
                    <div class="col-md-4">
                        <label class="form-label">Consumable</label>
                        <select name="consumable_ids[]" class="form-select consumable-select" required>
                            <option value="">Select consumable...</option>
                            {% for item in all_ingredients if item.type == 'consumable' %}
                            <option value="{{ item.id }}" data-unit="{{ item.unit }}" {% if item.id == assoc.inventory_item_id %}selected{% endif %}>{{ item.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Amount</label>
                        <input type="number" step="0.01" name="consumable_amounts[]" class="form-control" value="{{ assoc.quantity or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Unit</label>
                        <select name="consumable_units[]" class="form-select" required>
                            {% for unit in inventory_units %}
                            <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-consumable w-100">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <p>No consumables added yet. Click "Add Consumable" to get started.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </a>
                    {% if recipe and not is_clone and not is_variation and not parent_recipe %}
                    <button type="button" class="btn btn-danger ms-2" onclick="confirmDelete({{ recipe.id }}, {{ 'true' if recipe.parent_id else 'false' }}, {{ recipe.variations|length }})">
                        <i class="fas fa-trash"></i> 
                        {% if recipe.parent_id %}Delete Variation{% elif recipe.variations %}Delete Recipe & Variations{% else %}Delete Recipe{% endif %}
                    </button>
                    {% endif %}
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> {% if recipe and recipe.parent_id or is_variation %}Save Variation{% else %}Save Recipe{% endif %}
                </button>
                {% if current_user.is_authenticated and current_user.organization and current_user.organization.effective_subscription_tier == 'free' %}
                <span class="ms-3 text-muted small">Inventory is read-only on Free Tools tier. <a href="{{ url_for('billing.upgrade') }}">Upgrade</a> to adjust inventory or start batches.</span>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<!-- Drawer modals will be loaded dynamically via DrawerProtocol -->

<script src="{{ url_for('static', filename='js/components/suggestions.js') }}"></script>
<script src="{{ url_for('static', filename='js/recipes/recipe_form.js') }}"></script>
<script>
const formEl = document.getElementById('recipeForm');
let PRESELECT_INGREDIENT_ID = (formEl.getAttribute('data-preselect-ingredient-id') || '').trim();
PRESELECT_INGREDIENT_ID = PRESELECT_INGREDIENT_ID ? (parseInt(PRESELECT_INGREDIENT_ID, 10) || null) : null;
let SHOULD_ADD_LINE = (formEl.getAttribute('data-should-add-line') || 'false') === 'true';
let ingredientReturnContext = 'main';
let originalYieldUnit = (formEl.getAttribute('data-original-yield-unit') || '').trim();

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body'
        });
    });

    // Close popover when clicking elsewhere
    document.addEventListener('click', function (e) {
        if (!e.target.closest('[data-bs-toggle="popover"]')) {
            popoverList.forEach(function(popover) {
                popover.hide();
            });
        }
    });

    // Handle ingredient removal using event delegation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            e.preventDefault();
            const ingredientEntry = e.target.closest('.ingredient-entry');
            if (ingredientEntry) {
                ingredientEntry.remove();

                // Check if we need to show empty state
                const container = document.getElementById('ingredients-container');
                const remainingEntries = container.querySelectorAll('.ingredient-entry');

                if (remainingEntries.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-plus-circle fa-2x mb-2"></i>
                            <p>No ingredients added yet. Click "Add Ingredient" to get started.</p>
                        </div>
                    `;
                }
            }
        }
    });

    if (SHOULD_ADD_LINE && PRESELECT_INGREDIENT_ID) {
        addIngredient(PRESELECT_INGREDIENT_ID);
    }

    {% if edit_mode and existing_batches and existing_batches > 0 %}
    // Show warning when yield unit is changed
    const yieldUnitSelect = document.getElementById('predicted_yield_unit');
    const yieldWarning = document.getElementById('yieldUnitWarning');

    if (yieldUnitSelect && yieldWarning) {
        yieldUnitSelect.addEventListener('change', function() {
            if (this.value !== originalYieldUnit && this.value !== '') {
                yieldWarning.style.display = 'block';
            } else {
                yieldWarning.style.display = 'none';
            }
        });
    }
    {% endif %}

    // Category-driven portioning guidance
    const categorySelect = document.getElementById('category_id');
    const isPortionedToggle = document.getElementById('is_portioned_toggle');
    const portioningSection = document.getElementById('portioningSection');
    const categoryHint = document.getElementById('categoryHint');

    function syncPortioningUI() {
        const on = isPortionedToggle.checked;
        portioningSection.style.display = on ? 'block' : 'none';
    }

    function onCategoryChange() {
        const sel = categorySelect.options[categorySelect.selectedIndex];
        const hint = sel ? (sel.getAttribute('data-is-portioned') === 'true') : false;
        if (hint) {
            isPortionedToggle.checked = true;
            categoryHint.style.display = 'block';
            categoryHint.innerHTML = '<small class="text-info">This category is typically portioned. Toggle can be changed.</small>';
        } else {
            if (!isPortionedToggle.dataset.userToggled) {
                isPortionedToggle.checked = false;
            }
            categoryHint.style.display = 'none';
            categoryHint.innerHTML = '';
        }
        syncPortioningUI();
    }

    if (categorySelect && isPortionedToggle) {
        categorySelect.addEventListener('change', onCategoryChange);
        isPortionedToggle.addEventListener('change', () => {
            isPortionedToggle.dataset.userToggled = 'true';
            syncPortioningUI();
        });
        onCategoryChange();
    }

    // Category Assistant logic
    const assistantCard = document.getElementById('categoryAssistantCard');
    const sections = {
        'soaps': document.getElementById('assistant-soaps'),
        'candles': document.getElementById('assistant-candles'),
        'lotions': document.getElementById('assistant-lotions'),
        'baked goods': document.getElementById('assistant-baked-goods'),
        'herbal': document.getElementById('assistant-herbal')
    };
    function showAssistantFor(catName){
        const key = (catName||'').toLowerCase();
        let any=false;
        Object.keys(sections).forEach(k=>{ const el=sections[k]; if (!el) return; const on = key.indexOf(k) !== -1; el.style.display = on? 'block':'none'; any = any || on; });
        assistantCard.style.display = any? 'block':'none';
    }
    if (categorySelect){
        showAssistantFor(categorySelect.options[categorySelect.selectedIndex]?.textContent);
        categorySelect.addEventListener('change', () => showAssistantFor(categorySelect.options[categorySelect.selectedIndex]?.textContent));
    }

    // Calculators (lightweight; results are guidance; copy amounts into ingredients)
    function round(v){ return Math.round(v*1000)/1000 }
    const soapBtn = document.getElementById('soap_calc_btn');
    if (soapBtn){ soapBtn.addEventListener('click', function(){
        const oil = parseFloat(document.getElementById('soap_oil_g').value||'0');
        const sf = parseFloat(document.getElementById('soap_superfat').value||'0');
        const lyeType = document.getElementById('soap_lye_type').value;
        const waterPct = parseFloat(document.getElementById('soap_water_pct').value||'33');
        if (!(oil>0)) { alert('Enter total oils in grams'); return; }
        const SAP_NAOH = 0.138, SAP_KOH = 0.194; // average defaults
        const sap = (lyeType==='KOH')? SAP_KOH: SAP_NAOH;
        const lye = oil * sap * (1 - sf/100);
        const water = oil * (waterPct/100);
        document.getElementById('soap_result').textContent = `Lye (${lyeType}) ${round(lye)} g, Water ${round(water)} g`;
    }); }

    const candleBtn = document.getElementById('candle_calc_btn');
    if (candleBtn){ candleBtn.addEventListener('click', function(){
        const fill = parseFloat(document.getElementById('candle_fill_g').value||'0');
        const fl = parseFloat(document.getElementById('candle_fl_pct').value||'0');
        const count = parseInt(document.getElementById('candle_count').value||'1', 10);
        if (!(fill>0) || !(count>0)) { alert('Enter fill grams and count'); return; }
        const fragPer = fill*(fl/100), waxPer = fill - fragPer;
        const out = `Per: Fragrance ${round(fragPer)} g, Wax ${round(waxPer)} g. Total: Fragrance ${round(fragPer*count)} g, Wax ${round(waxPer*count)} g`;
        document.getElementById('candle_result').textContent = out;
    }); }

    const lotionBtn = document.getElementById('lotion_calc_btn');
    if (lotionBtn){ lotionBtn.addEventListener('click', function(){
        const batch = parseFloat(document.getElementById('lotion_batch_g').value||'0');
        const wp = parseFloat(document.getElementById('lotion_water_pct').value||'0');
        const op = parseFloat(document.getElementById('lotion_oil_pct').value||'0');
        const cp = parseFloat(document.getElementById('lotion_cool_pct').value||'0');
        if (!(batch>0)) { alert('Enter batch grams'); return; }
        const sum = wp+op+cp; if (Math.abs(sum-100)>0.01){ alert('Phases must sum to 100%'); return; }
        const wg = batch*(wp/100), og = batch*(op/100), cg = batch*(cp/100);
        document.getElementById('lotion_result').textContent = `Water ${round(wg)} g, Oil ${round(og)} g, Cool ${round(cg)} g`;
    }); }

    const bakerBtn = document.getElementById('baker_calc_btn');
    if (bakerBtn){ bakerBtn.addEventListener('click', function(){
        const flour = parseFloat(document.getElementById('baker_flour_g').value||'0');
        const hyd = parseFloat(document.getElementById('baker_hydration').value||'0');
        const salt = parseFloat(document.getElementById('baker_salt').value||'0');
        const yeast = parseFloat(document.getElementById('baker_yeast').value||'0');
        if (!(flour>0)) { alert('Enter flour grams'); return; }
        const waterG = flour*(hyd/100), saltG = flour*(salt/100), yeastG = flour*(yeast/100);
        const total = flour+waterG+saltG+yeastG;
        document.getElementById('baker_result').textContent = `Water ${round(waterG)} g, Salt ${round(saltG)} g, Yeast ${round(yeastG)} g. Total ${round(total)} g`;
    }); }

    const herbalBtn = document.getElementById('herbal_calc_btn');
    if (herbalBtn){ herbalBtn.addEventListener('click', function(){
        const ratio = (document.getElementById('herbal_ratio').value||'').trim();
        const herb = parseFloat(document.getElementById('herbal_herb_g').value||'0');
        if (!/^\d+\s*:\s*\d+$/.test(ratio)) { alert('Enter ratio like 5:1'); return; }
        if (!(herb>0)) { alert('Enter herb grams'); return; }
        const parts = ratio.split(':');
        const per = parseFloat(parts[0])/parseFloat(parts[1]);
        const menstruum = herb*per;
        document.getElementById('herbal_result').textContent = `Menstruum ${round(menstruum)} g for ${round(herb)} g herb`;
    }); }
});

function addIngredient(preselectId = null, presetUnit = null) {
    const container = document.getElementById('ingredients-container');

    // Remove empty state message if it exists
    const emptyState = container.querySelector('.text-center.text-muted');
    if (emptyState) {
        emptyState.remove();
    }

    const entry = document.createElement('div');
    entry.classList.add('ingredient-entry', 'row', 'mb-3', 'p-3', 'border', 'rounded');
    entry.innerHTML = `
        <div class="col-md-4">
            <label class="form-label small">Ingredient</label>
            <div class="position-relative">
                <input type="text" class="form-control recipe-ingredient-typeahead" placeholder="Search inventory and global..." autocomplete="off">
                <input type="hidden" name="ingredient_ids[]" value="">
                <input type="hidden" name="global_item_ids[]" value="">
                <div class="list-group position-absolute w-100 d-none" data-role="suggestions" style="z-index: 1050;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Amount</label>
            <input type="number" step="0.01" name="amounts[]" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Unit</label>
            <select name="units[]" class="form-select" required>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="col-12 mt-2">
            <div class="conversion-warning text-center small text-muted">
                <!-- JS will inject conversion warning here -->
            </div>
        </div>
    `;
    container.appendChild(entry);

    if (preselectId) {
        const hidden = entry.querySelector('input[name="ingredient_ids[]"]');
        if (hidden) hidden.value = String(preselectId);
    }

    entry.scrollIntoView({ behavior: 'smooth' });
    return entry;
}

// Open drawers via DrawerProtocol
function openQuickCreateInventory() {
    const detail = {
        modal_url: '/api/drawer-actions/inventory/quick-create-modal',
        success_event: 'inventory.created',
        error_type: 'inventory',
        error_code: 'quick_create'
    };
    window.dispatchEvent(new CustomEvent('openDrawer', { detail: detail }));
}

function openQuickCreateUnit() {
    const detail = {
        modal_url: '/api/drawer-actions/units/quick-create-modal',
        success_event: 'unit.created',
        error_type: 'units',
        error_code: 'quick_create'
    };
    window.dispatchEvent(new CustomEvent('openDrawer', { detail: detail }));
}

function confirmDelete(recipeId, isVariation, variationCount) {
    let msg;
    if (isVariation) {
        msg = 'Are you sure you want to delete this variation?';
    } else if (variationCount > 0) {
        msg = 'Deleting the parent recipe will delete all variations under it.';
    } else {
        msg = 'Are you sure you want to delete this recipe?';
    }

    if (confirm(msg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/recipes/${recipeId}/delete`;

        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = '{{ csrf_token() }}';

        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    }
}

function setIngredientReturnContext(context) {
    ingredientReturnContext = context;
}

function updateConversionWarning(selectElement) {
    // Get the selected ingredient data
    const selectedOption = selectElement.selectedOptions[0];
    if (!selectedOption) return;

    const ingredientType = selectedOption.dataset.type;
    const ingredientUnit = selectedOption.dataset.unit;

    // Find the corresponding unit dropdown and warning div
    const ingredientEntry = selectElement.closest('.ingredient-entry');
    const unitSelect = ingredientEntry.querySelector('select[name="units[]"]');
    const warningDiv = ingredientEntry.querySelector('.conversion-warning');

    if (!unitSelect || !warningDiv) return;

    const selectedUnit = unitSelect.value;

    // Clear previous warnings
    warningDiv.innerHTML = '';

    // Show conversion warning if units don't match
    if (ingredientUnit && selectedUnit && ingredientUnit !== selectedUnit) {
        warningDiv.innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Will convert from ${selectedUnit} to ${ingredientUnit}</span>`;
    }
}

function addConsumable(preselectId = null) {
    const container = document.getElementById('consumables-container');
    const emptyState = container.querySelector('.text-center.text-muted');
    if (emptyState) emptyState.remove();

    const entry = document.createElement('div');
    entry.classList.add('consumable-entry', 'row', 'mb-3', 'p-3', 'border', 'rounded');
    entry.innerHTML = `
        <div class="col-md-4">
            <label class="form-label small">Consumable</label>
            <select name="consumable_ids[]" class="form-select" required>
                <option value="">Select a consumable</option>
                {% for item in all_ingredients if item.type == 'consumable' %}
                <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Amount</label>
            <input type="number" step="0.01" name="consumable_amounts[]" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label small">Unit</label>
            <select name="consumable_units[]" class="form-select" required>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-consumable w-100">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(entry);

    if (preselectId) {
        const select = entry.querySelector('select[name="consumable_ids[]"]');
        if (select) select.value = preselectId;
    }
}

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-consumable')) {
        const entry = e.target.closest('.consumable-entry');
        if (entry) entry.remove();
    }
});

// Inline insertion after quick-create
window.addEventListener('inventory.created', function(e) {
    try {
        const item = e.detail && e.detail.item;
        if (!item) return;
        // Find last ingredient-entry or create one
        let entry = document.querySelector('.ingredient-entry:last-of-type');
        if (!entry) {
            entry = addIngredient();
        }
        const hidden = entry.querySelector('input[name="ingredient_ids[]"]');
        const input = entry.querySelector('input.recipe-ingredient-typeahead');
        if (hidden) hidden.value = String(item.id);
        if (input) input.value = item.name;
    } catch (_) {}
});

// Client-side validation: ensure each ingredient line has a selected item
document.getElementById('recipeForm').addEventListener('submit', function(e) {
    const rows = document.querySelectorAll('.ingredient-entry');
    for (const row of rows) {
        const inv = row.querySelector('input[name="ingredient_ids[]"]').value.trim();
        const gi = row.querySelector('input[name="global_item_ids[]"]').value.trim();
        const hasSelection = inv || gi;
        if (!hasSelection) {
            e.preventDefault();
            // Freeze and guide: highlight row and scroll into view instead of alert/reset
            row.classList.add('border-danger');
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const input = row.querySelector('input.recipe-ingredient-typeahead');
            if (input) input.focus();
            // Inline helper
            const warning = row.querySelector('.conversion-warning');
            if (warning) warning.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Select an ingredient from Inventory or Global.</span>';
            return false;
        }
    }
});

// Simple typeahead wiring for inventory + global search
(function(){
    function setupTypeahead(container) {
        const input = container.querySelector('input.recipe-ingredient-typeahead');
        const invHidden = container.querySelector('input[name="ingredient_ids[]"]');
        const giHidden = container.querySelector('input[name="global_item_ids[]"]');
        const list = container.querySelector('[data-role="suggestions"]');
        if (!input || !invHidden || !giHidden || !list) return;

        // New behavior: as user types, search org inventory AND global, and allow create-or-link on Enter
        let t;
        function render(groups){
            list.innerHTML='';
            let any=false;
            groups.forEach(group => {
                if (!group.items || !group.items.length) return;
                any = true;
                const header = document.createElement('div');
                header.className = 'list-group-item text-muted small';
                header.textContent = group.title;
                list.appendChild(header);
                group.items.forEach(r => {
                    const a = document.createElement('a');
                    a.href = '#'; a.className='list-group-item list-group-item-action'; a.textContent=r.text;
                    a.addEventListener('click', function(e){ e.preventDefault(); input.value=r.text; invHidden.value=r.id||''; giHidden.value=r.global_item_id||''; list.classList.add('d-none'); list.innerHTML=''; });
                    list.appendChild(a);
                });
            });
            // Add create option
            const q = (input.value||'').trim();
            if (q){
                const a = document.createElement('a');
                a.href='#'; a.className='list-group-item list-group-item-action text-primary'; a.textContent = `Create "${q}"`;
                a.addEventListener('click', function(e){ e.preventDefault(); createInline(q); });
                list.appendChild(a); any=true;
            }
            list.classList.toggle('d-none', !any);
        }
        function search(){
            clearTimeout(t);
            const q = (input.value||'').trim();
            if (!q){ list.classList.add('d-none'); list.innerHTML=''; invHidden.value=''; giHidden.value=''; return; }
            t=setTimeout(function(){
                Promise.all([
                    fetch('/api/ingredients/ingredients/search?q='+encodeURIComponent(q)).then(r=>r.json()).catch(()=>({results:[]})),
                    fetch('/api/ingredients/global-items/search?q='+encodeURIComponent(q)+'&type=ingredient').then(r=>r.json()).catch(()=>({results:[]}))
                ]).then(([inv, gi]) => {
                    const groups = [];
                    if (inv && inv.results && inv.results.length) groups.push({title:'Your Inventory', items: inv.results});
                    if (gi && gi.results && gi.results.length) groups.push({title:'Global Library', items: gi.results});
                    render(groups);
                }).catch(()=>{ list.classList.add('d-none'); list.innerHTML=''; });
            }, 250);
        }
        async function createInline(name){
            try{
                const res = await fetch('/inventory/api/quick-create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: name, type: 'ingredient' }) });
                const data = await res.json();
                if (data && data.success && data.item){
                    input.value = data.item.name; invHidden.value = data.item.id; giHidden.value = data.item.global_item_id||''; list.classList.add('d-none'); list.innerHTML='';
                }
            }catch(_){ /* silent */ }
        }
        input.addEventListener('input', function(){ invHidden.value=''; giHidden.value=''; search(); });
        input.addEventListener('keydown', function(e){ if (e.key==='Enter'){ e.preventDefault(); const q=(input.value||'').trim(); if (q) createInline(q); }});
    }
    // Attach to existing entries
    document.querySelectorAll('.ingredient-entry').forEach(entry => {
        const container = entry.querySelector('.position-relative');
        if (container) setupTypeahead(container);
    });
    // Hook into dynamic addIngredient
    const originalAdd = addIngredient;
    window.addIngredient = function(preselectId, presetUnit){
        const entry = originalAdd(preselectId, presetUnit);
        const container = entry.querySelector('.position-relative');
        if (container) setupTypeahead(container);
        return entry;
    };
})();

// Category aids JS moved into shared include
</script>

{% endblock %}