{# File: pages/recipes/view_recipe.html
   Synopsis: Recipe detail view with lineage, notes, and version actions.
   Glossary: Lineage ID = version identifier; Promotion = make current/master. #}
{% extends 'layout.html' %}
{% from 'macros/forms.html' import csrf_form %}

{% set can_create_variations = has_permission(current_user, 'recipes.create_variations') %}
{% set base_master_name = recipe.recipe_group.name if recipe.recipe_group else recipe.name %}
{% set display_recipe_name = recipe.name %}
{% if not recipe.is_master %}
  {% set base_name = recipe.variation_name or recipe.name %}
  {% if is_test %}
    {% set display_recipe_name = base_name ~ ' - Test ' ~ recipe.test_sequence %}
  {% else %}
    {% set display_recipe_name = base_name %}
  {% endif %}
{% elif is_test %}
  {% set display_recipe_name = recipe.name ~ ' - Test ' ~ recipe.test_sequence %}
{% endif %}
{% set breadcrumb_items = [
    {'label': 'Recipes', 'url': url_for('recipes.list_recipes')},
    {'label': display_recipe_name, 'url': None}
] %}
{% set display_label_prefix = label_prefix_display if label_prefix_display else (recipe.label_prefix or 'BTH') %}

{% block content %}

<!-- Recipe Header Card with merged details -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="flex-grow-1">
        <h2 class="mb-1">{{ display_recipe_name }}</h2>
        <div class="d-flex gap-2 align-items-center mb-2">
          {% if is_published_locked or (is_test and has_batches) %}
            <span class="badge bg-secondary"><i class="fas fa-lock"></i> Locked</span>
          {% endif %}
          {% if is_archived %}
            <span class="badge bg-secondary"><i class="fas fa-archive"></i> Archived</span>
          {% endif %}
          {% if is_test %}
            <span class="badge bg-info text-dark"><i class="fas fa-flask"></i> Test {{ recipe.test_sequence }}</span>
          {% endif %}
          {% if recipe.status == 'draft' %}
            <span class="badge bg-warning text-dark"><i class="fas fa-file-alt"></i> Draft</span>
          {% endif %}
          {% if recipe.is_master %}
            <span class="badge bg-dark"><i class="fas fa-crown"></i> Master</span>
          {% else %}
            <span class="badge bg-info"><i class="fas fa-code-branch"></i> Variation</span>
          {% endif %}
          {% if recipe.is_current %}
            <span class="badge bg-success"><i class="fas fa-check-circle"></i> Current</span>
          {% endif %}
          {% if lineage_id %}
            <span class="badge bg-light text-dark">Lineage {{ lineage_id }}</span>
          {% endif %}
        </div>

        <!-- Merged Details -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <p class="mb-1">
              <strong>Recipe Group:</strong>
              {% if recipe.recipe_group %}
                {{ recipe.recipe_group.name }} ({{ recipe.recipe_group.prefix }})
              {% else %}
                {{ recipe.name }}
              {% endif %}
            </p>
            <p class="mb-1"><strong>Label Prefix:</strong> <span class="badge bg-light text-dark">{{ display_label_prefix }}</span></p>
            {% if recipe.predicted_yield %}
            <p class="mb-1"><strong>Predicted Yield:</strong> {{ recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}</p>
            {% endif %}
          </div>
          <div class="col-md-6">
            {% if recipe.product_category %}
            <p class="mb-1"><strong>Category:</strong> {{ recipe.product_category.name }}</p>
            {% endif %}
            {% if recipe.is_portioned and recipe.portion_name and recipe.portion_count %}
            <p class="mb-1"><strong>Portions:</strong> {{ recipe.portion_count }} {{ recipe.portion_name }}</p>
            {% endif %}
            <p class="mb-1">
              <strong>Version:</strong>
              {% if recipe.is_master %}
                Master v{{ recipe.version_number }}
              {% else %}
                {{ recipe.variation_name or 'Variation' }} v{{ recipe.version_number }}
              {% endif %}
            </p>
          </div>
        </div>

        {% if recipe.parent_master %}
          <p class="text-muted mb-0">
            <i class="fas fa-arrow-up"></i> Variation of:
            <a href="{{ url_for('recipes.view_recipe', recipe_id=recipe.parent_master.id) }}" class="text-decoration-none">
              {{ recipe.parent_master.name }}
            </a>
          </p>
        {% endif %}
      </div>

      <div class="d-flex gap-2 align-items-start">
        {% if is_published_locked %}
          <span class="text-muted small mt-1"><i class="fas fa-lock"></i> Published versions are read-only.</span>
        {% elif is_test and has_batches %}
          <span class="text-muted small mt-1"><i class="fas fa-lock"></i> Tests lock after batches run.</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if is_test %}
<div class="alert alert-info mb-4">
  <i class="fas fa-flask"></i> This is a test version. It will not appear in the marketplace until published as the current version.
</div>
{% elif recipe.status == 'draft' %}
<div class="alert alert-warning mb-4">
  <i class="fas fa-info-circle"></i> This recipe is saved as a draft. Complete the required fields and publish it before planning production or starting batches.
</div>
{% endif %}

{% if can_create_variations %}
<!-- New Version Modal -->
<div class="modal fade" id="newVersionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Create New Version</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Select what you want to create from this lineage branch.</p>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-primary" href="{{ url_for('recipes.create_test_version', recipe_id=recipe.id) }}">
            <i class="fas fa-flask"></i>
            {% if recipe.is_master %}Create Test of Master{% else %}Create Test of Variation{% endif %}
          </a>
          {% if recipe.is_master %}
          <div class="border rounded p-3">
            <label class="form-label small text-muted">New Variation Name</label>
            <form method="get" action="{{ url_for('recipes.create_variation', recipe_id=recipe.id) }}" class="d-flex gap-2">
              <input type="text" name="variation_name" class="form-control" placeholder="e.g., Lavender" required>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-code-branch"></i> Create Variation
              </button>
            </form>
          </div>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Promote Variation Modal -->
<div class="modal fade" id="promoteVariationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning"></i> Promote Variation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>You are about to make <strong>{{ recipe.name }}</strong> the new master recipe for this group.</p>
        <p class="text-muted mb-0">This will create a new master version using the variation's formula.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('recipes.promote_variation_to_master', recipe_id=recipe.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-warning">Confirm Promotion</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- New Group Modal -->
<div class="modal fade" id="newGroupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-seedling text-success"></i> Start New Recipe Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>You are about to start a new recipe group using <strong>{{ recipe.name }}</strong> as the master recipe.</p>
        <p class="text-muted mb-0">This keeps your current group intact and creates a fresh lineage tree.</p>
        <form method="post" action="{{ url_for('recipes.promote_variation_to_new_group', recipe_id=recipe.id) }}" id="newGroupForm" class="mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label class="form-label">New group name</label>
          <input type="text" name="group_name" class="form-control" value="{{ recipe.name }}" maxlength="128" required>
          <div class="form-text">Name the new master recipe and group.</div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success" form="newGroupForm">Create New Group</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Edit Published Recipe Modal -->
<div class="modal fade" id="editUnlockModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning"></i> Edit Published Recipe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          You are about to edit a published recipe. Since your subscription tier allows you to variate and test,
          editing can break the lineage and ruin formula history.
        </p>
        <p class="mb-2">Please be sure you do <strong>not</strong> mean to do one of the following:</p>
        <ol class="mb-3">
          <li>Make a test version of this recipe to try something new.</li>
          <li>Make a variation of this current master recipe to add a new flavor or scent (for example: <strong>{{ base_master_name }} - Lavender</strong>).</li>
        </ol>
        <p class="mb-0">
          If neither of those are what you want, only edit details you forgot or missed,
          like instructions, quantities, missing ingredients, or batch configuration. Changes will be recorded
          in the recipe notes with a timestamp.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id, force='1') }}" class="btn btn-warning">
          Proceed to Edit
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Left Column -->
  <div class="col-lg-8">
    <!-- Instructions Card -->
    {% if recipe.instructions %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-list-ol"></i> Instructions</h5>
      </div>
      <div class="card-body">
        <div class="recipe-instructions">
          {{ recipe.instructions|nl2br }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Notes Card -->
    <div class="card mb-4" id="recipeNotes">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-sticky-note"></i> Notes</h5>
        <span class="badge bg-light text-dark border">{{ recipe_notes|length if recipe_notes else 0 }} notes</span>
      </div>
      <div class="card-body">
        {% if can_add_notes %}
        <form method="post" action="{{ url_for('recipes.add_recipe_note', recipe_id=recipe.id) }}" class="mb-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label class="form-label">Add a note</label>
          <textarea name="note" rows="3" class="form-control" placeholder="Capture corrections or context..."></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button type="submit" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-plus-circle"></i> Save Note
            </button>
          </div>
        </form>
        <hr>
        {% endif %}
        {% if recipe_notes %}
        <ul class="list-group list-group-flush">
          {% for note in recipe_notes %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold text-uppercase text-muted">
                {% if note.event_type in ['EDIT', 'EDIT_OVERRIDE'] %}Edit{% else %}Note{% endif %}
              </span>
              <small class="text-muted">{{ note.created_at.strftime('%b %d, %Y %H:%M') if note.created_at else '—' }}</small>
            </div>
            {% if note.notes %}
            <div class="small mt-1">{{ note.notes|nl2br }}</div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-center py-3 text-muted">
          <i class="fas fa-info-circle mb-2"></i>
          <p class="mb-0">No notes recorded yet.</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Components Card (Ingredients, Consumables, Packaging) -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-flask"></i> Recipe Components</h5>
      </div>
      <div class="card-body">
        {% if recipe.recipe_ingredients %}
        <div class="component-section mb-4">
          <h6 class="text-primary mb-3"><i class="fas fa-leaf"></i> Ingredients</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-end">Quantity</th>
                  <th>Unit</th>
                </tr>
              </thead>
              <tbody>
                {% for assoc in recipe.recipe_ingredients %}
                <tr>
                  <td>
                    <span class="fw-medium">{{ assoc.inventory_item.name }}</span>
                    {% if assoc.inventory_item.type != 'ingredient' %}
                      <span class="badge bg-secondary ms-1">{{ assoc.inventory_item.type }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end">{{ assoc.quantity }}</td>
                  <td>{{ assoc.unit }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% if recipe.recipe_consumables %}
        <div class="component-section mb-4">
          <h6 class="text-info mb-3"><i class="fas fa-tools"></i> Consumables</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-end">Quantity</th>
                  <th>Unit</th>
                </tr>
              </thead>
              <tbody>
                {% for assoc in recipe.recipe_consumables %}
                <tr>
                  <td>
                    <span class="fw-medium">{{ assoc.inventory_item.name if assoc.inventory_item else assoc.inventory_item_id }}</span>
                    {% if assoc.inventory_item and assoc.inventory_item.type != 'consumable' %}
                      <span class="badge bg-secondary ms-1">{{ assoc.inventory_item.type }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end">{{ assoc.quantity }}</td>
                  <td>{{ assoc.unit }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% if not recipe.recipe_ingredients and not recipe.recipe_consumables %}
        <div class="text-center py-4 text-muted">
          <i class="fas fa-flask fa-2x mb-3 opacity-50"></i>
          <p>No components configured for this recipe.</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Recipe Stats Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-chart-bar"></i> Recipe Stats</h5>
      </div>
      <div class="card-body">
        <div class="row text-center g-3">
          <div class="col-3">
            <div class="stat-item p-3 bg-light rounded">
              <div class="h4 text-primary mb-1">{{ recipe.recipe_ingredients|length }}</div>
              <small class="text-muted">Ingredients</small>
            </div>
          </div>
          <div class="col-3">
            <div class="stat-item p-3 bg-light rounded">
              <div class="h4 text-info mb-1">{{ recipe.recipe_consumables|length }}</div>
              <small class="text-muted">Consumables</small>
            </div>
          </div>
          <div class="col-3">
            <div class="stat-item p-3 bg-light rounded">
              <div class="h4 text-success mb-1">{{ recipe.batches|length if recipe.batches else 0 }}</div>
              <small class="text-muted">Batches Made</small>
            </div>
          </div>
          <div class="col-3">
            <div class="stat-item p-3 bg-light rounded">
              <div class="h4 text-warning mb-1">{{ recipe.variations|length if recipe.variations else 0 }}</div>
              <small class="text-muted">Variations</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="col-lg-4">
    {% if can_create_variations and (master_branches or variation_branches) %}
    {% set current_variation_name = recipe.variation_name or recipe.name %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-sitemap"></i> Lineage Selector</h5>
      </div>
      <div class="card-body">
        <label class="form-label small text-muted">Browse lineage</label>
        <select id="lineageBranchSelect" class="form-select mb-2">
          <option value="master" {% if recipe.is_master %}selected{% endif %}>Master</option>
          <option value="variation" {% if not recipe.is_master %}selected{% endif %} {% if not variation_branches %}disabled{% endif %}>Variations</option>
        </select>

        <div id="masterLineageSelectWrap">
          <label class="form-label small text-muted">Master versions</label>
          <select id="masterLineageSelect" class="form-select mb-2" onchange="if (this.value) { window.location = this.value; }">
            {% for branch in master_branches %}
              {% set master = branch.version %}
              <option value="{{ url_for('recipes.view_recipe', recipe_id=master.id) }}" {% if master.id == recipe.id %}selected{% endif %}>
                Master v{{ master.version_number }}{% if master.is_current %} · Current{% endif %}
              </option>
              {% for test in branch.tests %}
                <option value="{{ url_for('recipes.view_recipe', recipe_id=test.id) }}" {% if test.id == recipe.id %}selected{% endif %}>
                  ↳ Test {{ test.test_sequence }}
                </option>
              {% endfor %}
            {% endfor %}
          </select>
        </div>

        <div id="variationLineageSelectWrap" style="display:none;">
          <label class="form-label small text-muted">Variation</label>
          <select id="variationNameSelect" class="form-select mb-2">
            {% for branch in variation_branches %}
              <option value="{{ branch.name }}" {% if branch.name == current_variation_name %}selected{% endif %}>{{ branch.name }}</option>
            {% endfor %}
          </select>
          {% for branch in variation_branches %}
            <select class="form-select variation-lineage-select mb-2"
                    data-variation="{{ branch.name }}"
                    onchange="if (this.value) { window.location = this.value; }"
                    style="display:none;">
              {% for entry in branch.versions %}
                {% set version = entry.version %}
                <option value="{{ url_for('recipes.view_recipe', recipe_id=version.id) }}" {% if version.id == recipe.id %}selected{% endif %}>
                  {{ branch.name }} v{{ version.version_number }}{% if version.is_current %} · Current{% endif %}
                </option>
                {% for test in entry.tests %}
                  <option value="{{ url_for('recipes.view_recipe', recipe_id=test.id) }}" {% if test.id == recipe.id %}selected{% endif %}>
                    ↳ Test {{ test.test_sequence }}
                  </option>
                {% endfor %}
              {% endfor %}
            </select>
          {% endfor %}
        </div>

        <p class="text-muted small mb-0">
          Select a version to view its lineage-specific ingredients, yield, and batches.
        </p>
      </div>
    </div>
    <script>
      (function() {
        const branchSelect = document.getElementById('lineageBranchSelect');
        const masterWrap = document.getElementById('masterLineageSelectWrap');
        const variationWrap = document.getElementById('variationLineageSelectWrap');
        const variationNameSelect = document.getElementById('variationNameSelect');
        const variationSelects = document.querySelectorAll('.variation-lineage-select');

        function syncVariationSelect() {
          if (!variationNameSelect) return;
          const name = variationNameSelect.value;
          let active = null;
          variationSelects.forEach(select => {
            const match = select.getAttribute('data-variation') === name;
            select.style.display = match ? 'block' : 'none';
            if (match) active = select;
          });
          if (!active && variationSelects.length) {
            variationSelects[0].style.display = 'block';
          }
        }

        function syncBranch() {
          if (!branchSelect) return;
          const branch = branchSelect.value;
          const showMaster = branch === 'master';
          if (masterWrap) masterWrap.style.display = showMaster ? 'block' : 'none';
          if (variationWrap) variationWrap.style.display = showMaster ? 'none' : 'block';
          if (!showMaster) {
            syncVariationSelect();
          }
        }

        if (variationNameSelect) {
          variationNameSelect.addEventListener('change', syncVariationSelect);
        }
        if (branchSelect) {
          branchSelect.addEventListener('change', syncBranch);
        }
        syncBranch();
      })();
    </script>
    {% endif %}

    <!-- Actions Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-cog"></i> Actions</h5>
      </div>
      <div class="card-body">
        {% set plan_disabled = (recipe.status == 'draft') or is_archived %}
        {% set plan_title = "Archived recipes cannot be planned" if is_archived else "Publish this recipe before planning production" %}
        {% set edit_disabled = (not is_editable) and (not force_edit_allowed) %}
        {% set version_disabled = is_archived %}
        <div class="d-grid gap-2">
          <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
          </a>
          <a href="{{ url_for('production_planning.plan_production_route', recipe_id=recipe.id) }}"
             class="btn btn-success{% if plan_disabled %} disabled{% endif %}"
             {% if plan_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="{{ plan_title }}"{% endif %}>
            <i class="fas fa-play"></i> Plan Production
          </a>
          {% if is_editable %}
          <a href="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}" class="btn btn-primary">
            <i class="fas fa-edit"></i> {% if is_test %}Edit Test{% else %}Edit Recipe{% endif %}
          </a>
          {% elif force_edit_allowed %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editUnlockModal">
            <i class="fas fa-edit"></i> Edit Recipe
          </button>
          {% else %}
          <a href="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}"
             class="btn btn-primary disabled"
             tabindex="-1"
             aria-disabled="true"
             onclick="return false;"
             title="Published versions are locked. Create a test to edit.">
            <i class="fas fa-edit"></i> {% if is_test %}Edit Test{% else %}Edit Recipe{% endif %}
          </a>
          {% endif %}
          {% if can_create_variations %}
          <button type="button"
                  class="btn btn-outline-primary{% if version_disabled %} disabled{% endif %}"
                  {% if not version_disabled %}data-bs-toggle="modal" data-bs-target="#newVersionModal"{% endif %}
                  {% if version_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="Archived recipes cannot create new versions"{% endif %}>
            <i class="fas fa-plus-circle"></i> Create New Version
          </button>
          {% if is_test %}
            <form method="post" action="{{ url_for('recipes.publish_test_version', recipe_id=recipe.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-warning{% if version_disabled %} disabled{% endif %}" {% if version_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="Archived recipes cannot be promoted"{% endif %}>
                <i class="fas fa-upload"></i> Publish as Current Version
              </button>
            </form>
          {% else %}
            {% if recipe.status == 'published' and not recipe.is_current %}
              <form method="post" action="{{ url_for('recipes.set_current_version_route', recipe_id=recipe.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-success{% if version_disabled %} disabled{% endif %}" {% if version_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="Archived recipes cannot be promoted"{% endif %}>
                  <i class="fas fa-check-circle"></i> Make Current Version
                </button>
              </form>
            {% endif %}
            {% if not recipe.is_master %}
              <button type="button"
                      class="btn btn-outline-warning{% if version_disabled %} disabled{% endif %}"
                      {% if not version_disabled %}data-bs-toggle="modal" data-bs-target="#promoteVariationModal"{% endif %}
                      {% if version_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="Archived recipes cannot be promoted"{% endif %}>
                <i class="fas fa-exchange-alt"></i> Make This the Master
              </button>
              <button type="button"
                      class="btn btn-outline-secondary{% if version_disabled %} disabled{% endif %}"
                      {% if not version_disabled %}data-bs-toggle="modal" data-bs-target="#newGroupModal"{% endif %}
                      {% if version_disabled %}tabindex="-1" aria-disabled="true" onclick="return false;" title="Archived recipes cannot be promoted"{% endif %}>
                <i class="fas fa-seedling"></i> Start New Recipe Group
              </button>
            {% endif %}
          {% endif %}
          {% endif %}
          {% if lineage_enabled %}
          <a href="{{ url_for('recipes.recipe_lineage', recipe_id=recipe.id) }}" class="btn btn-outline-dark">
            <i class="fas fa-project-diagram"></i> View Lineage
          </a>
          {% endif %}
          {% if not is_archived %}
            {% if has_listing %}
              <form method="post" action="{{ url_for('recipes.unlist_recipe_route', recipe_id=recipe.id, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-warning">
                  <i class="fas fa-store-slash"></i> Deactivate Listing
                </button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('recipes.archive_recipe_route', recipe_id=recipe.id, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-secondary">
                  <i class="fas fa-archive"></i> Archive Recipe
                </button>
              </form>
            {% endif %}
          {% else %}
            <form method="post" action="{{ url_for('recipes.restore_recipe_route', recipe_id=recipe.id, next=request.path) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-outline-secondary">
                <i class="fas fa-undo"></i> Restore Recipe
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Origin Details -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-certificate"></i> Origin</h5>
      </div>
      <div class="card-body">
        {% set is_marketplace_origin = recipe.org_origin_source_org or recipe.org_origin_source_recipe or recipe.org_origin_type == 'purchased' %}
        {% set origin_label = 'Authored' %}
        {% if recipe.org_origin_type == 'batchtrack_native' %}
          {% set origin_label = 'BatchTrack Native' %}
        {% elif is_marketplace_origin %}
          {% if recipe.org_origin_purchased %}
            {% set origin_label = 'Marketplace (Purchased)' %}
          {% else %}
            {% set origin_label = 'Marketplace (Free)' %}
          {% endif %}
        {% endif %}
        <dl class="row mb-0">
          <dt class="col-5">Origin</dt>
          <dd class="col-7">
            <span class="badge bg-light text-dark border">{{ origin_label }}</span>
          </dd>
          <dt class="col-5">Origin Recipe</dt>
          <dd class="col-7">
            <a href="{{ url_for('recipes.view_recipe', recipe_id=origin_root_recipe.id) }}" class="text-decoration-none">
              {{ origin_root_recipe.name }}
            </a>
          </dd>
          <dt class="col-5">Root Recipe</dt>
          <dd class="col-7">
            {% if origin_parent_recipe %}
              <a href="{{ url_for('recipes.view_recipe', recipe_id=origin_parent_recipe.id) }}" class="text-decoration-none">
                {{ origin_parent_recipe.name }}
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </dd>
          {% if is_marketplace_origin and recipe.org_origin_source_org %}
          <dt class="col-5">Author</dt>
          <dd class="col-7">
            {% if recipe.org_origin_source_recipe %}
              <a href="{{ url_for('recipe_library_bp.recipe_library_detail', recipe_id=recipe.org_origin_source_recipe.id, slug=slugify(recipe.org_origin_source_recipe.name)) }}" class="text-decoration-none">
                {{ recipe.org_origin_source_org.name }}
              </a>
            {% else %}
              <a href="{{ url_for('recipe_library_bp.organization_marketplace', organization_id=recipe.org_origin_source_org.id) }}" class="text-decoration-none">
                {{ recipe.org_origin_source_org.name }}
              </a>
            {% endif %}
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>

    <!-- Recipe Cost Card -->
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-dollar-sign"></i> Recipe Cost</h5>
      </div>
      <div class="card-body">
        {% set total_cost = 0 %}
        {% set has_costs = false %}

        {% if recipe.recipe_ingredients %}
          <div class="cost-breakdown mb-3">
            <h6 class="text-muted mb-2">Ingredients</h6>
            {% for assoc in recipe.recipe_ingredients %}
              {% if assoc.inventory_item and assoc.inventory_item.cost_per_unit %}
                {% set item_cost = (assoc.quantity * assoc.inventory_item.cost_per_unit) %}
                {% set total_cost = total_cost + item_cost %}
                {% set has_costs = true %}
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small class="text-truncate me-2">{{ assoc.inventory_item.name }}</small>
                  <small class="text-success fw-medium">${{ "%.2f"|format(item_cost) }}</small>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if recipe.recipe_consumables %}
          <div class="cost-breakdown mb-3">
            <h6 class="text-muted mb-2">Consumables</h6>
            {% for assoc in recipe.recipe_consumables %}
              {% if assoc.inventory_item and assoc.inventory_item.cost_per_unit %}
                {% set item_cost = (assoc.quantity * assoc.inventory_item.cost_per_unit) %}
                {% set total_cost = total_cost + item_cost %}
                {% set has_costs = true %}
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small class="text-truncate me-2">{{ assoc.inventory_item.name }}</small>
                  <small class="text-info fw-medium">${{ "%.2f"|format(item_cost) }}</small>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <hr>
        <div class="d-flex justify-content-between align-items-center">
          <strong>Total Recipe Cost:</strong>
          {% if has_costs %}
            <h5 class="text-success mb-0">${{ "%.2f"|format(total_cost) }}</h5>
          {% else %}
            <span class="text-muted">Not available</span>
          {% endif %}
        </div>

        {% if has_costs and recipe.predicted_yield %}
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">Cost per {{ recipe.predicted_yield_unit }}:</small>
              <small class="text-success fw-medium">${{ "%.3f"|format(total_cost / recipe.predicted_yield) }}</small>
            </div>
          </div>
        {% endif %}

        {% if not has_costs %}
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle"></i> Costs will appear when inventory items have pricing data.
          </small>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
.recipe-instructions {
  line-height: 1.6;
  white-space: pre-wrap;
}

.component-section:not(:last-child) {
  border-bottom: 1px solid var(--color-border);
  padding-bottom: 1rem;
}

.stat-item {
  padding: 0.5rem 0;
}

.cost-breakdown .d-flex {
  font-size: 0.875rem;
}

.cost-breakdown h6 {
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
</style>

{% endblock %}