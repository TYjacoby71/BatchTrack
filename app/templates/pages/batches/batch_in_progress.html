{% extends 'layout.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/batches.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <h2>Active Batch</h2>
        <div class="ms-3">
            {% if prev_batch %}
            <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=prev_batch.id) }}" class="btn btn-outline-secondary btn-sm me-1" title="Previous in-progress batch">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm me-1" disabled title="No previous in-progress batch">
                <i class="fas fa-chevron-left"></i>
            </button>
            {% endif %}

            {% if next_batch %}
            <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=next_batch.id) }}" class="btn btn-outline-secondary btn-sm" title="Next in-progress batch">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm" disabled title="No next in-progress batch">
                <i class="fas fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Section 1: Basic Batch Info -->
<div class="batch-header mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#batchDetailsCollapse" aria-expanded="true">
                    <i class="fas fa-chevron-down me-2"></i>Batch Details
                </button>
            </h3>
        </div>
        <div class="collapse show" id="batchDetailsCollapse">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
                        <p><strong>Recipe:</strong> {{ batch.recipe.name }}</p>
                        <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
                        <p><strong>Batch Type:</strong> {{ batch.batch_type|title if batch.batch_type else 'Not Set' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-warning">In Progress</span>
                        </p>
                        <p><strong>Projected Yield:</strong> {{ batch.projected_yield }} {{ batch.projected_yield_unit }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="batchForm" method="post" action="{{ url_for('batches.finish_batch.complete_batch', batch_id=batch.id) }}" enctype="multipart/form-data" onsubmit="return validateBatchForm()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" class="csrf-token">
    <input type="hidden" id="batchId" value="{{ batch.id }}">

    <!-- Section 2: Batch Tools -->
    <div class="mb-4" x-data="{ 
        showTimers: false, 
        showExtraItems: false,
        hasActiveTimers: {{ 'true' if timers and timers|selectattr('status', 'equalto', 'active')|list else 'false' }},
        hasExtraItems: false,
        toggleTimers() {
            this.showTimers = !this.showTimers;
        },
        toggleExtraItems() {
            this.showExtraItems = !this.showExtraItems;
        }
    }">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Batch Tools</h3>
            <div class="d-flex gap-2">
                <button type="button" @click="toggleTimers()" 
                        class="btn btn-outline-primary btn-sm" 
                        :class="{ 'btn-primary text-white': showTimers }">
                    <i class="fas fa-clock"></i> Timers
                    <span x-show="hasActiveTimers && !showTimers" class="badge bg-warning text-dark ms-1">
                        {{ timers|selectattr('status', 'equalto', 'active')|list|length if timers else 0 }}
                    </span>
                </button>
                <button type="button" @click="toggleExtraItems()" 
                        class="btn btn-outline-secondary btn-sm"
                        :class="{ 'btn-secondary text-white': showExtraItems }">
                    <i class="fas fa-plus-circle"></i> Extra Items
                </button>
            </div>
        </div>

        <!-- Timers Section -->
        <div x-show="showTimers" x-transition.duration.300ms class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Batch Timers</h5>
            </div>
            <div class="card-body">
                {% include 'components/batch/timer_component.html' %}
            </div>
        </div>

        <!-- Extra Items Section -->
        <div x-show="showExtraItems" x-transition.duration.300ms class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Extra Items Management</h5>
            </div>
            <div class="card-body">
                <div id="extra-ingredients-container"></div>
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraItemRow('ingredient')">
                        <i class="fas fa-plus"></i> Add Extra Ingredient
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraItemRow('container')">
                        <i class="fas fa-plus"></i> Add Extra Container
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraItemRow('consumable')">
                        <i class="fas fa-plus"></i> Add Extra Consumable
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveExtras()">
                        <i class="fas fa-save"></i> Save All Extras
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No extra container section needed - using existing extra items system -->

    <!-- Section 4: Batch Cost Summary -->
    <div class="batch-summary mb-4">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#batchSummaryCollapse" aria-expanded="true">
                        <i class="fas fa-chevron-down me-2"></i>Batch Summary
                    </button>
                </h3>
            </div>
            <div class="collapse show" id="batchSummaryCollapse">
                <div class="card-body">
                {% if freshness_summary and freshness_summary.overall_freshness_percent is not none %}
                <div class="alert alert-info mb-3">
                    <strong>Freshness (Overall):</strong> {{ freshness_summary.overall_freshness_percent }}%
                </div>
                {% endif %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Amount Used</th>
                            <th>Unit</th>
                            <th>Cost/Unit</th>
                            <th>Line Cost</th>
                            <th>Freshness</th>
                        </tr>
                    </thead>
                    {% set ns = namespace(ingredient_total=0, container_total=0, extras_total=0, extra_container_total=0) %}
                    <tbody>
                        {% if batch.batch_ingredients %}
                        <tr><th colspan="6" class="table-secondary">Ingredients</th></tr>
                        {% for ing in batch.batch_ingredients %}
                            {% set amount = ing.quantity_used|float or 0 %}
                            {% set cost = ing.cost_per_unit|float or 0 %}
                            {% set line_cost = amount * cost %}
                            <tr>
                                <td>{{ ing.inventory_item.name }}</td>
                                <td>{{ "%.2f"|format(amount) }}</td>
                                <td>{{ ing.unit }}</td>
                                <td>${{ "%.2f"|format(cost) }}</td>
                                <td>${{ "%.2f"|format(line_cost) }}</td>
                                <td>
                                    {% if freshness_summary and freshness_summary.items %}
                                        {% set f = (freshness_summary.items | selectattr('inventory_item_id', 'equalto', ing.inventory_item_id) | list | first) %}
                                        {% if f and f.weighted_freshness_percent is not none %}
                                            {{ f.weighted_freshness_percent }}%
                                        {% else %}
                                            &mdash;
                                        {% endif %}
                                    {% else %}
                                        &mdash;
                                    {% endif %}
                                </td>
                            </tr>
                            {% set ns.ingredient_total = ns.ingredient_total + line_cost %}
                        {% endfor %}
                        <tr>
                            <td colspan="5" class="text-end"><em>Ingredients Subtotal:</em></td>
                            <td><strong>${{ "%.2f"|format(ns.ingredient_total) }}</strong></td>
                        </tr>
                        {% endif %}

                        {% if batch.containers %}
                        <tr><th colspan="6" class="table-secondary">Containers</th></tr>
                        {% for container in batch.containers %}
                            {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                            <tr>
                                <td>{{ container.container.name }}</td>
                                <td>{{ container.quantity_used }}</td>
                                <td></td>
                                <td>${{ "%.2f"|format(container.cost_each|float or 0) }}</td>
                                <td>${{ "%.2f"|format(line_cost) }}</td>
                                <td>&mdash;</td>
                            </tr>
                            {% set ns.container_total = ns.container_total + line_cost %}
                        {% endfor %}
                        <tr>
                            <td colspan="5" class="text-end"><em>Containers Subtotal:</em></td>
                            <td><strong>${{ "%.2f"|format(ns.container_total) }}</strong></td>
                        </tr>
                        {% endif %}

                        {% if batch.consumables %}
                        <tr><th colspan="6" class="table-secondary">Consumables</th></tr>
                        {% for cons in batch.consumables %}
                            {% set line_cost = (cons.quantity_used|float or 0) * (cons.cost_per_unit|float or 0) %}
                            <tr>
                                <td>{{ cons.inventory_item.name }}</td>
                                <td>{{ "%.3f"|format(cons.quantity_used|float or 0) }}</td>
                                <td>{{ cons.unit }}</td>
                                <td>${{ "%.2f"|format(cons.cost_per_unit|float or 0) }}</td>
                                <td>${{ "%.2f"|format(line_cost) }}</td>
                                <td>&mdash;</td>
                            </tr>
                            {% set ns.ingredient_total = ns.ingredient_total + line_cost %}
                        {% endfor %}
                        {% endif %}

                        {% if batch.extra_ingredients %}
                        <tr><th colspan="6" class="table-secondary">Extra Ingredients</th></tr>
                        {% for extra in batch.extra_ingredients %}
                            {% set line_cost = (extra.quantity_used|float or 0) * (extra.cost_per_unit|float or 0) %}
                            <tr>
                                <td>{{ extra.inventory_item.name }}</td>
                                <td>{{ "%.3f"|format(extra.quantity_used|float or 0) }}</td>
                                <td>{{ extra.unit }}</td>
                                <td>${{ "%.2f"|format(extra.cost_per_unit|float or 0) }}</td>
                                <td>${{ "%.2f"|format(line_cost) }}</td>
                                <td>
                                    {% if freshness_summary and freshness_summary.items %}
                                        {% set f = (freshness_summary.items | selectattr('inventory_item_id', 'equalto', extra.inventory_item_id) | list | first) %}
                                        {% if f and f.weighted_freshness_percent is not none %}
                                            {{ f.weighted_freshness_percent }}%
                                        {% else %}
                                            &mdash;
                                        {% endif %}
                                    {% else %}
                                        &mdash;
                                    {% endif %}
                                </td>
                            </tr>
                            {% set ns.extras_total = ns.extras_total + line_cost %}
                        {% endfor %}
                        <tr>
                            <td colspan="5" class="text-end"><em>Extra Ingredients Subtotal:</em></td>
                            <td><strong>${{ "%.2f"|format(ns.extras_total) }}</strong></td>
                        </tr>
                        {% endif %}

                        {% if batch.extra_containers %}
                        <tr><th colspan="6" class="table-secondary">Extra Containers</th></tr>
                        {% for container in batch.extra_containers %}
                            {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                            <tr>
                                <td>{{ container.container.name }}</td>
                                <td>{{ container.quantity_used }}</td>
                                <td></td>
                                <td>${{ "%.2f"|format(container.cost_each|float or 0) }}</td>
                                <td>${{ "%.2f"|format(line_cost) }}</td>
                                <td>&mdash;</td>
                            </tr>
                            {% set ns.extra_container_total = ns.extra_container_total + line_cost %}
                        {% endfor %}
                        <tr>
                            <td colspan="5" class="text-end"><em>Extra Containers Subtotal:</em></td>
                            <td><strong>${{ "%.2f"|format(ns.extra_container_total) }}</strong></td>
                        </tr>
                        {% endif %}
                    </tbody>

                    <tfoot>
                        {% set total_cost = (ns.ingredient_total if ns.ingredient_total is defined else 0) + 
                                           (ns.container_total if ns.container_total is defined else 0) + 
                                           (ns.extras_total if ns.extras_total is defined else 0) + 
                                           (ns.extra_container_total if ns.extra_container_total is defined else 0) %}
                        <tr class="table-primary">
                            <td colspan="3">
                                <button type="button" class="btn btn-info btn-sm" onclick="openBatchInventorySummary(this.dataset.batchId)" data-batch-id="{{ batch.id }}">
                                    <i class="fas fa-list-alt"></i> View Batch Source List
                                </button>
                            </td>
                            <td colspan="2" class="text-end"><strong>Total Batch Cost:</strong></td>
                            <td><strong>${{ "%.2f"|format(total_cost) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 5: Notes and Tags -->
    <div class="mb-4">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#notesTagsCollapse" aria-expanded="false">
                        <i class="fas fa-chevron-right me-2"></i>Batch Notes & Tags
                    </button>
                </h3>
            </div>
            <div class="collapse" id="notesTagsCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="notes" class="form-label">Batch Notes</label>
                        <textarea name="notes" rows="4" class="form-control" placeholder="Add any notes about this batch...">{{ batch.notes or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" name="tags" value="{{ batch.tags or '' }}" class="form-control" placeholder="Enter tags separated by commas">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 6: Action Buttons -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" onclick="saveBatchNotes().then(() => window.location.href = '/batches/')" class="btn btn-secondary">
                        <i class="fas fa-save"></i> Save and Exit
                    </button>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-warning" onclick="cancelBatch()">
                        <i class="fas fa-ban"></i> Cancel Batch
                    </button>
                    <button type="button" class="btn btn-danger" onclick="markBatchFailed()">
                        <i class="fas fa-exclamation-triangle"></i> Mark Failed
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finishBatchModal">
                        <i class="fas fa-check"></i> Complete Batch
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Templates for extra ingredients/containers -->
<template id="extra-ingredient-template">
    <div class="extra-row row g-2 mb-3 align-items-center p-2 border rounded" data-type="ingredient">
        <div class="col-md-4">
            <select class="form-select item-select" onchange="updateRowCost(this)">
                <option value="">Select ingredient</option>
                {% for ingredient in all_ingredients %}
                    <option value="{{ ingredient.id }}" data-cost="{{ ingredient.cost_per_unit or 0 }}" data-unit="{{ ingredient.unit }}">{{ ingredient.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control qty" placeholder="Quantity" step="0.01" />
        </div>
        <div class="col-md-2">
            <select class="form-select unit">
                {% for unit in units %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control cost" placeholder="Cost per unit" step="0.01" readonly />
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</template>

<template id="extra-container-template">
    <div class="extra-row row g-2 mb-3 align-items-center p-2 border rounded" data-type="container">
        <div class="col-md-3">
            <select class="form-select item-select" onchange="updateRowCost(this)">
                <option value="">Select container</option>
                {% for container in inventory_items if container.type == 'container' %}
                    <option value="{{ container.id }}" data-cost="{{ container.cost_per_unit or 0 }}" data-stock="{{ container.stock_amount or 0 }}">{{ container.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control qty" placeholder="Qty" min="1" />
        </div>
        <div class="col-md-3">
            <select class="form-select reason">
                <option value="extra_yield">Extra Yield</option>
                <option value="damaged">Broken/Damaged</option>
            </select>
            <div class="form-text">
                <small>Reason will be tracked for batch history queries</small>
            </div>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control cost" placeholder="Cost each" step="0.01" readonly />
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</template>

<template id="extra-consumable-template">
    <div class="extra-row row g-2 mb-3 align-items-center p-2 border rounded" data-type="consumable">
        <div class="col-md-4">
            <select class="form-select item-select" onchange="updateRowCost(this)">
                <option value="">Select consumable</option>
                {% for item in all_ingredients if item.type == 'consumable' %}
                    <option value="{{ item.id }}" data-cost="{{ item.cost_per_unit or 0 }}" data-unit="{{ item.unit }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control qty" placeholder="Quantity" step="0.01" />
        </div>
        <div class="col-md-2">
            <select class="form-select unit">
                {% for unit in units %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control cost" placeholder="Cost per unit" step="0.01" readonly />
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</template>

{# Finish Batch Modal - include only once #}
{% include 'components/batch/finish_batch_modal.html' %}

{# FIFO Insight Modal #}
{% include 'components/batch/fifo_insight_modal.html' %}

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{{ url_for('static', filename='js/batches/batch_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/batches/fifo_modal.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle collapse icons
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(element => {
        const target = document.querySelector(element.getAttribute('data-bs-target'));
        if (target) {
            target.addEventListener('show.bs.collapse', () => {
                const icon = element.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
            });
            target.addEventListener('hide.bs.collapse', () => {
                const icon = element.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            });
        }
    });
});

// Function to open the batch inventory summary modal
function openBatchInventorySummary(batchId) {
    loadBatchInventorySummary(batchId);
    $('#batchInventorySummaryModal').modal('show');
}

// Load batch inventory summary
async function loadBatchInventorySummary(batchId) {
    try {
        const response = await fetch(`/batches/api/batch-inventory-summary/${batchId}`);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error fetching batch summary:', response.status, errorText);
            return;
        }

        const data = await response.json();

        if (!data.success) {
            console.error('Error fetching batch summary:', data.error || 'Unknown error');
            return;
        }

        // Process the data and update the UI
        updateInventorySummaryUI(data);
    } catch (error) {
        console.error('Error fetching batch summary:', error);
    }
}

// Placeholder for the UI update function
function updateInventorySummaryUI(data) {
    const tbody = document.querySelector('#batchInventorySummaryModal tbody');
    tbody.innerHTML = ''; // Clear existing rows

    if (data.summary && data.summary.length > 0) {
        data.summary.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.item_name}</td>
                <td>${item.amount_used}</td>
                <td>${item.unit}</td>
                <td>${item.cost_per_unit ? '$' + parseFloat(item.cost_per_unit).toFixed(2) : '&mdash;'}</td>
                <td>${item.line_cost ? '$' + parseFloat(item.line_cost).toFixed(2) : '&mdash;'}</td>
                <td>${item.freshness_percent ? item.freshness_percent + '%' : '&mdash;'}</td>
            `;
            tbody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">No inventory summary data available.</td>';
        tbody.appendChild(row);
    }
}

// Timer management functions
function startTimer(name, duration) {
    const batchIdEl = document.getElementById('batchId');
    const batchId = Number(batchIdEl && batchIdEl.value ? batchIdEl.value : 0);
    fetch(`/timers/api/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            "batch_id": batchId,
            "name": name,
            "duration_minutes": duration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error starting timer: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Timer error:', error);
        alert('Network error occurred');
    });
}

// Auto-complete expired timers and refresh display
function checkAndCompleteExpiredTimers() {
    fetch('/timers/api/complete-expired', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.completed_count > 0) {
            // Reload page if any timers were completed
            location.reload();
        }
    })
    .catch(error => {
        console.error('Timer completion error:', error);
    });
}

// Check for expired timers every 30 seconds
setInterval(checkAndCompleteExpiredTimers, 30000);
</script>

{% endblock %}