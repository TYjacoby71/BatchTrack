{% extends 'layout.html' %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div class="d-flex align-items-center">
        <h2>Batch Details</h2>
        <div class="ms-3">
            {% if prev_batch %}
            <a href="{{ url_for('batches.view_batch', batch_identifier=prev_batch.id) }}" class="btn btn-outline-secondary btn-sm me-1" title="Previous {{ batch.status }} batch">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm me-1" disabled title="No previous {{ batch.status }} batch">
                <i class="fas fa-chevron-left"></i>
            </button>
            {% endif %}

            {% if next_batch %}
            <a href="{{ url_for('batches.view_batch', batch_identifier=next_batch.id) }}" class="btn btn-outline-secondary btn-sm" title="Next {{ batch.status }} batch">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm" disabled title="No next {{ batch.status }} batch">
                <i class="fas fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
    <button onclick="window.print()" class="btn btn-secondary">
        <i class="fas fa-print"></i> Print Batch Details
    </button>
</div>

<!-- Print Header (only visible when printing) -->
<div class="print-only" style="display: none;">
    <div class="batch-header">
        <h1>Batch Production Report</h1>
        <div class="batch-info">
            <div class="batch-info-left">
                <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
                <p><strong>Recipe:</strong> {{ batch.recipe.name }}</p>
                <p><strong>Scale:</strong> {{ batch.scale }}</p>
                <p><strong>Status:</strong> <span class="badge">{{ batch.status|title }}</span></p>
            </div>
            <div class="batch-info-right">
                <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% if batch.completed_at %}
                <p><strong>Completed:</strong> {{ batch.completed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% elif batch.failed_at %}
                <p><strong>Failed:</strong> {{ batch.failed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% elif batch.cancelled_at %}
                <p><strong>Cancelled:</strong> {{ batch.cancelled_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% endif %}
                <p><strong>Print Date:</strong> {{ current_time.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Section 1: Basic Batch Info (Always Visible) -->
<div class="batch-header mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#batchDetailsCollapse" aria-expanded="true">
                    <i class="fas fa-chevron-down me-2"></i>Batch Details
                </button>
            </h3>
        </div>
        <div class="collapse show" id="batchDetailsCollapse">
            <div class="card-body">
                <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
                <p><strong>Recipe:</strong> {{ batch.recipe.name }}</p>
                <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
                <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% if batch.completed_at %}
                <p><strong>Completed:</strong> {{ batch.completed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% elif batch.failed_at %}
                <p><strong>Failed:</strong> {{ batch.failed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% elif batch.cancelled_at %}
                <p><strong>Cancelled:</strong> {{ batch.cancelled_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% endif %}
                <p><strong>Status:</strong> 
                    <span class="badge {% if batch.status == 'completed' %}bg-success
                                {% elif batch.status == 'failed' %}bg-danger
                                {% elif batch.status == 'cancelled' %}bg-secondary
                                {% else %}bg-warning{% endif %}">
                        {{ batch.status|title }}
                    </span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Print Output Section (only visible when printing) -->
{% if batch.status != 'cancelled' %}
<div class="print-only" style="display: none;">
    <div class="section-header">Output Details</div>
    <div class="batch-info">
        <div class="batch-info-left">
            <p><strong>Output Type:</strong> {{ batch.batch_type|title }}</p>
            {% if batch.batch_type == 'product' and batch.product %}
                <p><strong>Product:</strong> {{ batch.product.name }}</p>
                {% if batch.variant %}
                    <p><strong>Variant:</strong> {{ batch.variant }}</p>
                {% endif %}
            {% endif %}
        </div>
        <div class="batch-info-right">
            <p><strong>Projected Yield:</strong> {{ batch.projected_yield }} {{ batch.projected_yield_unit }}</p>
            <p><strong>Final Yield:</strong> {% if batch.final_quantity %}{{ batch.final_quantity }} {{ batch.output_unit }}{% else %}N/A{% endif %}</p>
            {% if batch.is_perishable %}
                <p><strong>Shelf Life:</strong> {{ batch.shelf_life_days }} days</p>
                {% if batch.expiration_date %}
                    <p><strong>Expiration Date:</strong> {{ batch.expiration_date.strftime('%Y-%m-%d') }}</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Section 2: Output Info (Hidden if Cancelled) -->
{% if batch.status != 'cancelled' %}
<div class="batch-output mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#outputDetailsCollapse" aria-expanded="false">
                    <i class="fas fa-chevron-right me-2"></i>Output Details
                </button>
            </h3>
        </div>
        <div class="collapse" id="outputDetailsCollapse">
            <div class="card-body">
                <p><strong>Output Type:</strong> {{ batch.batch_type|title }}</p>

                {% if batch.batch_type == 'product' and batch.product %}
                    <p><strong>Product:</strong> <a href="{{ url_for('products.view_product', product_id=batch.product.id) }}">{{ batch.product.name }}</a></p>
                    {% if batch.variant %}
                        <p><strong>Variant:</strong> {{ batch.variant }}</p>
                    {% endif %}
                {% endif %}

                <p><strong>Projected Yield:</strong> {{ batch.projected_yield }} {{ batch.projected_yield_unit }}</p>
                <p><strong>Final Yield:</strong> {% if batch.final_quantity %}{{ batch.final_quantity }} {{ batch.output_unit }}{% else %}N/A{% endif %}</p>
                           {% if batch.is_perishable %}
                    <p><strong>Shelf Life:</strong> {{ batch.shelf_life_days }} days</p>
                    {% if batch.expiration_date %}
                        <p><strong>Expiration Date:</strong> {{ batch.expiration_date.strftime('%Y-%m-%d') }}</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Print Inventory Summary (only visible when printing) -->
<div class="print-only" style="display: none;">
    <div class="section-header">{% if batch.status == 'cancelled' %}Inventory Refunded{% else %}Inventory Used{% endif %}</div>
    {% set ns = namespace(ingredient_total=0, container_total=0, extras_total=0, extra_container_total=0) %}

    <table class="table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Amount</th>
                <th>Unit</th>
                <th>Cost/Unit</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% if batch.batch_ingredients %}
            <tr><th colspan="5" style="background: #e0e0e0; text-align: left;">INGREDIENTS</th></tr>
            {% for ing in batch.batch_ingredients %}
                {% set amount = ing.quantity_used|float or 0 %}
                {% set cost = ing.cost_per_unit|float or 0 %}
                {% set line_cost = amount * cost %}
                <tr>
                    <td>{{ ing.inventory_item.name }}</td>
                    <td>{{ "%.2f"|format(amount) }}</td>
                    <td>{{ ing.unit }}</td>
                    <td>${{ "%.2f"|format(cost) }}</td>
                    <td>${{ "%.2f"|format(line_cost) }}</td>
                </tr>
                {% set ns.ingredient_total = ns.ingredient_total + line_cost %}
            {% endfor %}
            {% endif %}

            {% if batch.containers %}
            <tr><th colspan="5" style="background: #e0e0e0; text-align: left;">CONTAINERS</th></tr>
            {% for container in batch.containers %}
                {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ "%.2f"|format(container.quantity_used|float or 0) }}</td>
                    <td>-</td>
                    <td>${{ "%.2f"|format(container.cost_each|float or 0) }}</td>
                    <td>${{ "%.2f"|format(line_cost) }}</td>
                </tr>
                {% set ns.container_total = ns.container_total + line_cost %}
            {% endfor %}
            {% endif %}

            {% if batch.extra_ingredients %}
            <tr><th colspan="5" style="background: #e0e0e0; text-align: left;">EXTRA INGREDIENTS</th></tr>
            {% for extra in batch.extra_ingredients %}
                {% set line_cost = (extra.quantity|float or 0) * (extra.cost_per_unit|float or 0) %}
                <tr>
                    <td>{{ extra.inventory_item.name }}</td>
                    <td>{{ "%.3f"|format(extra.quantity|float or 0) }}</td>
                    <td>{{ extra.unit }}</td>
                    <td>${{ "%.2f"|format(extra.cost_per_unit) }}</td>
                    <td>${{ "%.2f"|format(line_cost) }}</td>
                </tr>
                {% set ns.extras_total = ns.extras_total + line_cost %}
            {% endfor %}
            {% endif %}

            {% if batch.extra_containers %}
            <tr><th colspan="5" style="background: #e0e0e0; text-align: left;">EXTRA CONTAINERS</th></tr>
            {% for container in batch.extra_containers %}
                {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ container.quantity_used }}</td>
                    <td>-</td>
                    <td>${{ "%.2f"|format(container.cost_each) }}</td>
                    <td>${{ "%.2f"|format(line_cost) }}</td>
                </tr>
                {% set ns.extra_container_total = ns.extra_container_total + line_cost %}
            {% endfor %}
            {% endif %}
        </tbody>
        <tfoot>
            {% set total_cost = (ns.ingredient_total if ns.ingredient_total is defined else 0) + 
                               (ns.container_total if ns.container_total is defined else 0) + 
                               (ns.extras_total if ns.extras_total is defined else 0) + 
                               (ns.extra_container_total if ns.extra_container_total is defined else 0) %}
            <tr>
                <td colspan="4"><strong>TOTAL BATCH COST</strong></td>
                <td><strong>${{ "%.2f"|format(total_cost) }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Section 3: Batch Summary -->
<div class="batch-summary mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#batchSummaryCollapse" aria-expanded="true">
                    <i class="fas fa-chevron-down me-2"></i>{% if batch.status == 'cancelled' %}Inventory Refunded{% else %}Inventory Used{% endif %}
                </button>
            </h3>
        </div>
        <div class="collapse show" id="batchSummaryCollapse">
            <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Amount Used</th>
                        <th>Unit</th>
                        <th>Cost/Unit</th>
                        <th>Line Cost</th>
                    </tr>
                </thead>
                {% set ns = namespace(ingredient_total=0, container_total=0, extras_total=0, extra_container_total=0) %}
                <tbody>
                    {% if batch.batch_ingredients %}
                    <tr><th colspan="5">Ingredients</th></tr>
                    {% for ing in batch.batch_ingredients %}
                        {% set amount = ing.quantity_used|float or 0 %}
                        {% set cost = ing.cost_per_unit|float or 0 %}
                        {% set line_cost = amount * cost %}
                        <tr>
                            <td>
                                <a href="{{ url_for('inventory.view_inventory', id=ing.inventory_item.id) }}?fifo=true" 
                                   class="text-decoration-none" title="View FIFO details for {{ ing.inventory_item.name }}">
                                    {{ ing.inventory_item.name }}
                                </a>
                            </td>
                            <td>{{ "%.2f"|format(amount) }}</td>
                            <td>{{ ing.unit }}</td>
                            <td>${{ "%.2f"|format(cost) }}</td>
                            <td>${{ "%.2f"|format(line_cost) }}</td>
                        </tr>
                        {% set ns.ingredient_total = ns.ingredient_total + line_cost %}
                    {% endfor %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Ingredients Subtotal:</em></td>
                        <td>${{ "%.2f"|format(ns.ingredient_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.containers %}
                    <tr><th colspan="5">Containers</th></tr>
                    {% for container in batch.containers %}
                        {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                        <tr>
                            <td>{{ container.container.name }}</td>
                            <td>{{ "%.2f"|format(container.quantity_used|float or 0) }}</td>
                            <td></td>
                            <td>${{ "%.2f"|format(container.cost_each|float or 0) }}</td>
                            <td>${{ "%.2f"|format(line_cost) }}</td>
                        </tr>
                        {% set ns.container_total = ns.container_total + line_cost %}
                    {% endfor %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Containers Subtotal:</em></td>
                        <td>${{ "%.2f"|format(ns.container_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.extra_ingredients %}
                    <tr><th colspan="5">Extra Ingredients</th></tr>
                    {% for extra in batch.extra_ingredients %}
                        {% set line_cost = (extra.quantity|float or 0) * (extra.cost_per_unit|float or 0) %}
                        <tr>
                            <td>
                                <a href="{{ url_for('inventory.view_inventory', id=extra.inventory_item.id) }}?fifo=true" 
                                   class="text-decoration-none" title="View FIFO details for {{ extra.inventory_item.name }}">
                                    {{ extra.inventory_item.name }}
                                </a>
                            </td>
                            <td>{{ "%.3f"|format(extra.quantity|float or 0) }}</td>
                            <td>{{ extra.unit }}</td>
                            <td>${{ "%.2f"|format(extra.cost_per_unit) }}</td>
                            <td>${{ "%.2f"|format(line_cost) }}</td>
                        </tr>
                        {% set ns.extras_total = ns.extras_total + line_cost %}
                    {% endfor %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Extra Ingredients Subtotal:</em></td>
                        <td>${{ "%.2f"|format(ns.extras_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.extra_containers %}
                    <tr><th colspan="5">Extra Containers</th></tr>
                    {% for container in batch.extra_containers %}
                        {% set line_cost = (container.quantity_used|float or 0) * (container.cost_each|float or 0) %}
                        <tr>
                            <td>{{ container.container.name }}</td>
                            <td>{{ container.quantity_used }}</td>
                            <td></td>
                            <td>${{ "%.2f"|format(container.cost_each) }}</td>
                            <td>${{ "%.2f"|format(line_cost) }}</td>
                        </tr>
                        {% set ns.extra_container_total = ns.extra_container_total + line_cost %}
                    {% endfor %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Extra Containers Subtotal:</em></td>
                        <td>${{ "%.2f"|format(ns.extra_container_total) }}</td>
                    </tr>
                    {% endif %}
                </tbody>

                <tfoot>
                    {% set total_cost = (ns.ingredient_total if ns.ingredient_total is defined else 0) + 
                                       (ns.container_total if ns.container_total is defined else 0) + 
                                       (ns.extras_total if ns.extras_total is defined else 0) + 
                                       (ns.extra_container_total if ns.extra_container_total is defined else 0) %}
                    <tr class="table-primary">
                        {% if batch.status in ['completed', 'failed'] %}
                        <td colspan="2">
                            <button type="button" class="btn btn-info btn-sm" onclick="openBatchInventorySummary({{ batch.id }})">
                                <i class="fas fa-list-alt"></i> View Batch Source List
                            </button>
                        </td>
                        <td colspan="2" class="text-end"><strong>Total Batch Cost:</strong></td>
                        {% else %}
                        <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                        {% endif %}
                        <td><strong>${{ "%.2f"|format(total_cost) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
            </div>
        </div>
    </div>
</div>

<!-- Print Notes Section (only visible when printing) -->
<div class="print-only notes-section" style="display: none;">
    <div class="section-header">Batch Notes</div>
    {% if batch.notes %}
    <div class="notes-content">
        <strong>Notes:</strong><br>
        {{ batch.notes|nl2br }}
    </div>
    {% endif %}
    {% if batch.tags %}
    <div class="notes-content">
        <strong>Tags:</strong> {{ batch.tags }}
    </div>
    {% endif %}
    {% if batch.status_reason %}
    <div class="notes-content">
        <strong>Status Reason:</strong> {{ batch.status_reason }}
    </div>
    {% endif %}
</div>

<!-- Notes and Tags Section -->
<div class="notes-section">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#notesCollapse" aria-expanded="false">
                    <i class="fas fa-chevron-right me-2"></i>Batch Notes
                </button>
            </h3>
        </div>
        <div class="collapse" id="notesCollapse">
            <div class="card-body">
                <form method="post" action="{{ url_for('batches.update_batch_notes', batch_id=batch.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <textarea name="notes" rows="4" class="form-control mb-3">{{ batch.notes or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" name="tags" class="form-control" value="{{ batch.tags or '' }}">
                    </div>
                    <button type="submit" class="btn btn-secondary">Save and Return to Batch List</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Print Footer (only visible when printing) -->
<div class="print-only print-footer" style="display: none;">
    <p>BatchTrack Production Report - Generated on {{ current_time.strftime('%Y-%m-%d %H:%M') }}</p>
</div>
<style>
.btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    cursor: pointer;
}

.btn-outline-primary {
    transition: all 0.2s ease-in-out;
}

.btn-outline-secondary:disabled {
    cursor: not-allowed;
}

.collapse-icon {
    transition: transform 0.2s ease-in-out;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle collapse icon rotation
    const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        const target = document.querySelector(element.getAttribute('data-bs-target'));
        if (target) {
            target.addEventListener('show.bs.collapse', function() {
                const icon = element.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
            });

            target.addEventListener('hide.bs.collapse', function() {
                const icon = element.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            });
        }
    });
});
</script>

{# FIFO Insight Modal for completed/failed batches #}
{% if batch.status in ['completed', 'failed'] %}
{% include 'components/batch/fifo_insight_modal.html' %}

<script src="{{ url_for('static', filename='js/batches/fifo_modal.js') }}"></script>
{% endif %}

{% endblock %}