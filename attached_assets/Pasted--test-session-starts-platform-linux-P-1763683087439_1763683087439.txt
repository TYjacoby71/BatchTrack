============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.3.5, pluggy-1.5.0 -- /home/runner/workspace/.pythonlibs/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/workspace
collected 76 items                                                             

tests/developer/test_analytics_catalog.py::test_catalog_service_domains_structure PASSED [  1%]
tests/developer/test_analytics_catalog.py::test_developer_catalog_view_renders PASSED [  2%]
tests/test_auth_permissions.py::test_permission_required_allows_authorized_user PASSED [  3%]
tests/test_auth_permissions.py::test_permission_required_denies_user_without_permission PASSED [  5%]
tests/test_auth_permissions.py::test_permission_required_requires_authentication PASSED [  6%]
tests/test_batch_label_generator.py::test_generate_batch_label_code_defaults PASSED [  7%]
tests/test_batch_label_generator.py::test_generate_batch_label_code_with_prefix_and_sequence PASSED [  9%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_tier_permission_is_the_hard_ceiling PASSED [ 10%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_billing_status_enforcement[active-200] PASSED [ 11%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_billing_status_enforcement[payment_failed-302] PASSED [ 13%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_billing_status_enforcement[past_due-302] PASSED [ 14%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_billing_status_enforcement[suspended-302] PASSED [ 15%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_billing_status_enforcement[canceled-302] PASSED [ 17%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_developer_can_masquerade_regardless_of_billing PASSED [ 18%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_complete_security_cascade PASSED [ 19%]
tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_create_checkout_session_preserves_urls PASSED [ 21%]
tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment PASSED [ 22%]
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service PASSED [ 23%]
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_product_expired_calls_canonical_service PASSED [ 25%]
tests/test_extras_expiration.py::test_extras_cannot_use_expired_lot PASSED [ 26%]
tests/test_global_link_drawer.py::test_global_link_suggestions_and_link_flow PASSED [ 27%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_oauth_service_exists PASSED [ 28%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_auth_login_endpoint_exists PASSED [ 30%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_auth_callback_endpoint_exists PASSED [ 31%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_oauth_state_validation_path PASSED [ 32%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_oauth_service_methods_exist PASSED [ 34%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_oauth_configuration_status PASSED [ 35%]
tests/test_google_oauth.py::TestGoogleOAuthCharacterization::test_oauth_callback_invalid_state PASSED [ 36%]
tests/test_help_routes_access.py::test_help_pages_are_public PASSED      [ 38%]
tests/test_inventory_adjustment_guardrails.py::test_no_direct_quantity_mutations_outside_canonical_service PASSED [ 39%]
tests/test_inventory_adjustment_initial_stock.py::test_batch_deduction_does_not_create_initial_stock PASSED [ 40%]
tests/test_inventory_costing_toggle.py::TestInventoryCostingToggleAndWAC::test_wac_updates_after_restock_and_deduct_fifo_mode PASSED [ 42%]
tests/test_inventory_costing_toggle.py::TestInventoryCostingToggleAndWAC::test_wac_updates_after_restock_average_mode PASSED [ 43%]
tests/test_inventory_costing_toggle.py::TestInventoryCostingToggleAndWAC::test_resolve_cost_per_unit_divides_total_entries PASSED [ 44%]
tests/test_inventory_costing_toggle.py::TestInventoryCostingToggleAndWAC::test_resolve_cost_per_unit_requires_positive_quantity_for_total PASSED [ 46%]
tests/test_inventory_fifo.py::TestInventoryFIFOCharacterization::test_single_entry_point_exists PASSED [ 47%]
tests/test_inventory_fifo.py::TestInventoryFIFOCharacterization::test_fifo_deduction_order PASSED [ 48%]
tests/test_inventory_fifo.py::TestInventoryFIFOCharacterization::test_inventory_adjustment_delegates_properly PASSED [ 50%]
tests/test_inventory_routes_canonicalization.py::test_batch_start_routes_all_deductions_through_canonical_service PASSED [ 51%]
tests/test_inventory_routes_canonicalization.py::test_expiration_service_uses_canonical_adjustment PASSED [ 52%]
tests/test_plan_production_gating.py::test_api_start_batch_requires_override_before_force PASSED [ 53%]
tests/test_plan_production_integration.py::test_plan_start_finish_non_portioned PASSED [ 55%]
tests/test_plan_production_integration.py::test_plan_start_finish_portioned PASSED [ 56%]
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ PASSED [ 57%]
tests/test_pos_integration_canonicalization.py::test_process_sale_delegates_to_canonical_service PASSED [ 59%]
tests/test_pos_integration_canonicalization.py::test_reserve_inventory_calls_canonical_service PASSED [ 60%]
tests/test_pos_integration_canonicalization.py::test_confirm_sale_uses_canonical_service PASSED [ 61%]
tests/test_pos_integration_canonicalization.py::test_confirm_return_uses_canonical_service PASSED [ 63%]
tests/test_public_tools_access.py::test_public_tools_pages_are_accessible PASSED [ 64%]
tests/test_public_tools_and_exports_smoke.py::test_public_tools_draft_and_prefill PASSED [ 65%]
tests/test_public_tools_and_exports_smoke.py::test_exports_tool_and_recipe_csv_pdf PASSED [ 67%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_reservation_service_imports_canonical_service PASSED [ 68%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_reservation_service_structure PASSED [ 69%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_create_reservation_uses_canonical_service PASSED [ 71%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_release_reservation_uses_canonical_service PASSED [ 72%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_reservation_model_integration PASSED [ 73%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_reservation_status_management PASSED [ 75%]
tests/test_reservation_canonicalization.py::TestReservationCanonicalService::test_reservation_canonical_dependency PASSED [ 76%]
tests/test_reservation_canonicalization.py::TestReservationServiceErrorHandling::test_invalid_reservation_handling PASSED [ 77%]
tests/test_reservation_canonicalization.py::TestReservationServiceErrorHandling::test_service_initialization PASSED [ 78%]
tests/test_reservation_canonicalization.py::TestReservationServiceErrorHandling::test_canonical_service_availability PASSED [ 80%]
tests/test_reservation_canonicalization.py::test_reservation_service_module_imports PASSED [ 81%]
tests/test_retention_drawer.py::test_retention_flow_ack_to_delete PASSED [ 82%]
tests/test_signup_stripe_flow.py::test_signup_flow_end_to_end PASSED     [ 84%]
tests/test_signup_tiers.py::TestSignupTierCharacterization::test_signup_endpoint_exists PASSED [ 85%]
tests/test_signup_tiers.py::TestSignupTierCharacterization::test_tier_bypass_behavior PASSED [ 86%]
tests/test_signup_tiers.py::TestSignupTierCharacterization::test_organization_tier_assignment PASSED [ 88%]
tests/test_signup_tiers.py::TestSignupTierCharacterization::test_permission_gating_exists PASSED [ 89%]
tests/test_signup_tiers.py::TestSignupTierCharacterization::test_signup_service_delegation PASSED [ 90%]
tests/test_single_session_enforcement.py::test_subsequent_login_invalidates_existing_session PASSED [ 92%]
tests/test_start_batch_integration.py::test_start_batch_uses_generator_and_persists_label PASSED [ 93%]
tests/test_stripe_webhooks.py::test_stripe_webhook_valid_signature_dispatches PASSED [ 94%]
tests/test_stripe_webhooks.py::test_stripe_webhook_returns_400_when_signature_invalid PASSED [ 96%]
tests/test_stripe_webhooks.py::test_stripe_webhook_returns_500_when_secret_missing PASSED [ 97%]
tests/test_stripe_webhooks.py::test_invoice_payment_failed_marks_org_payment_failed PASSED [ 98%]
tests/test_timezone_conventions.py::test_no_naive_datetime_usage PASSED  [100%]

=============================== warnings summary ===============================
tests/developer/test_analytics_catalog.py: 1 warning
tests/test_auth_permissions.py: 3 warnings
tests/test_batch_label_generator.py: 2 warnings
tests/test_billing_and_tier_enforcement.py: 9 warnings
tests/test_expiration_canonicalization.py: 1 warning
tests/test_extras_expiration.py: 1 warning
tests/test_global_link_drawer.py: 1 warning
tests/test_google_oauth.py: 7 warnings
tests/test_help_routes_access.py: 1 warning
tests/test_inventory_adjustment_initial_stock.py: 1 warning
tests/test_inventory_costing_toggle.py: 4 warnings
tests/test_inventory_fifo.py: 3 warnings
tests/test_inventory_routes_canonicalization.py: 2 warnings
tests/test_plan_production_gating.py: 1 warning
tests/test_plan_production_integration.py: 2 warnings
tests/test_portioning_sku_derivation.py: 1 warning
tests/test_pos_integration_canonicalization.py: 3 warnings
tests/test_public_tools_access.py: 1 warning
tests/test_public_tools_and_exports_smoke.py: 2 warnings
tests/test_reservation_canonicalization.py: 6 warnings
tests/test_retention_drawer.py: 1 warning
tests/test_signup_stripe_flow.py: 1 warning
tests/test_signup_tiers.py: 5 warnings
tests/test_single_session_enforcement.py: 1 warning
tests/test_start_batch_integration.py: 1 warning
tests/test_stripe_webhooks.py: 4 warnings
  /home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/extension.py:881: SAWarning: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: batch, product_sku; and backend does not support ALTER.  To restore at least a partial sort, apply use_alter=True to ForeignKey and ForeignKeyConstraint objects involved in the cycle to mark these as known cycles that will be ignored.
    getattr(metadata, op_name)(bind=engine)

tests/test_billing_and_tier_enforcement.py::TestBillingAndTierEnforcement::test_create_checkout_session_preserves_urls
  /home/runner/workspace/app/services/billing_service.py:174: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    tier = SubscriptionTier.query.get(tier_id) if tier_id is not None else None

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_inventory_routes_canonicalization.py::test_expiration_service_uses_canonical_adjustment
  /home/runner/workspace/app/blueprints/expiration/services.py:512: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    lot = InventoryLot.query.get(entry_id)

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_inventory_routes_canonicalization.py::test_expiration_service_uses_canonical_adjustment
  /home/runner/workspace/app/blueprints/expiration/services.py:520: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    entry = UnifiedInventoryHistory.query.get(entry_id)

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_inventory_routes_canonicalization.py::test_expiration_service_uses_canonical_adjustment
  /home/runner/workspace/app/blueprints/expiration/services.py:525: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    entry = InventoryHistory.query.get(entry_id)

tests/test_extras_expiration.py::test_extras_cannot_use_expired_lot
tests/test_inventory_routes_canonicalization.py::test_batch_start_routes_all_deductions_through_canonical_service
tests/test_plan_production_integration.py::test_plan_start_finish_non_portioned
tests/test_plan_production_integration.py::test_plan_start_finish_portioned
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_start_batch_integration.py::test_start_batch_uses_generator_and_persists_label
  /home/runner/workspace/app/services/batch_service/batch_operations.py:41: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    recipe = Recipe.query.get(snap_recipe_id)

tests/test_extras_expiration.py::test_extras_cannot_use_expired_lot
tests/test_inventory_routes_canonicalization.py::test_batch_start_routes_all_deductions_through_canonical_service
tests/test_plan_production_integration.py::test_plan_start_finish_non_portioned
tests/test_plan_production_integration.py::test_plan_start_finish_portioned
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_start_batch_integration.py::test_start_batch_uses_generator_and_persists_label
  /home/runner/workspace/app/services/batch_service/batch_operations.py:169: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    fresh_batch = Batch.query.get(batch.id)

tests/test_extras_expiration.py::test_extras_cannot_use_expired_lot
  /home/runner/workspace/app/services/batch_service/batch_operations.py:684: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    batch = Batch.query.get(batch_id)

tests/test_extras_expiration.py::test_extras_cannot_use_expired_lot
  /home/runner/workspace/app/services/batch_service/batch_operations.py:781: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    inventory_item = InventoryItem.query.get(item["item_id"])

tests/test_plan_production_gating.py::test_api_start_batch_requires_override_before_force
tests/test_plan_production_gating.py::test_api_start_batch_requires_override_before_force
tests/test_plan_production_integration.py::test_plan_start_finish_non_portioned
tests/test_plan_production_integration.py::test_plan_start_finish_portioned
  /home/runner/workspace/app/blueprints/batches/routes.py:336: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    recipe = Recipe.query.get(recipe_id)

tests/test_plan_production_integration.py::test_plan_start_finish_non_portioned
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
  /home/runner/workspace/app/services/batch_service/batch_operations.py:577: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    refreshed = Batch.query.get(batch_id)

tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
  /home/runner/workspace/app/services/recipe_service/_core.py:105: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    u = Unit.query.get(buid)

tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
tests/test_portioning_sku_derivation.py::test_portioning_sku_labels_differ
  /home/runner/workspace/app/blueprints/batches/finish_batch.py:348: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    category = ProductCategory.query.get(product.category_id) if getattr(product, 'category_id', None) else None

tests/test_pos_integration_canonicalization.py::test_reserve_inventory_calls_canonical_service
  /home/runner/workspace/app/services/pos_integration.py:44: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    original_item = InventoryItem.query.get(item_id)

tests/test_pos_integration_canonicalization.py::test_confirm_sale_uses_canonical_service
  /home/runner/workspace/app/services/pos_integration.py:207: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    item = InventoryItem.query.get(reservation.product_item_id)

tests/test_pos_integration_canonicalization.py::test_confirm_return_uses_canonical_service
  /home/runner/workspace/app/services/pos_integration.py:265: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    item = InventoryItem.query.get(reservation.product_item_id)

tests/test_signup_stripe_flow.py::test_signup_flow_end_to_end
  /home/runner/workspace/app/blueprints/auth/routes.py:477: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    tier_obj = SubscriptionTier.query.get(tier_id)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================= 76 passed, 102 warnings in 223.77s (0:03:43) =================
