Thanks for the detailed post ‚Äî this gives a great overview. Let me walk you through where InventoryHistory entries are created and where unit_cost gets set, especially in the context of your question:

‚úÖ Where the History Entry is Created
You asked specifically about the adjust_inventory route. Here's what it does:

üìå For deductions (spoil, trash, recount when lowering quantity):
Calls deduct_fifo(), which pulls from InventoryHistory in FIFO order and reduces remaining_quantity.

Then creates a new InventoryHistory entry for each deduction (lines ~159-171):

python
Copy
Edit
for entry_id, deduction_amount in deduction_plan:
    current_cost = item.cost_per_unit if change_type == 'restock' else None
    history = InventoryHistory(
        ...
        unit_cost=current_cost,
    )
‚ö†Ô∏è This unit_cost logic is inconsistent:

It sets the unit cost only if the change_type is restock, which doesn't make sense here since it's a deduction.

You probably meant to always track the cost per unit from the original FIFO entry, not from item.cost_per_unit.

‚úÖ A better approach:
Use the unit_cost returned from deduct_fifo() ‚Äî which already provides the entry.unit_cost ‚Äî for accuracy.

üìå For additions (restock, positive adjustment, or positive recount):
A single new InventoryHistory entry is created (lines ~174-186):

python
Copy
Edit
history = InventoryHistory(
    ...
    unit_cost=cost_per_unit,
)
‚úÖ This is the correct location and logic ‚Äî unit_cost is taken directly from the form or inferred from the item.

üß† Summary of unit_cost Flow by Change Type
Change Type	Source of unit_cost	Logged In History?
restock	User input or item.cost_per_unit	‚úÖ Yes
adjustment	Same as above	‚úÖ Yes
spoil, trash	‚ö†Ô∏è Currently None	‚ö†Ô∏è Yes, but incomplete
recount (down)	Should come from FIFO source entry	‚ö†Ô∏è Should be used
recount (up)	Comes from form input (if any)	‚úÖ Yes
cost_override	Always logged	‚úÖ Yes

‚úÖ Suggested Fix for Deduction Block:
Update this block inside adjust_inventory:

python
Copy
Edit
for entry_id, deduction_amount in deduction_plan:
    history = InventoryHistory(
        ...
        unit_cost=current_cost,
    )
To:

python
Copy
Edit
for entry_id, deduction_amount, entry_cost in deduction_plan:
    history = InventoryHistory(
        ...
        unit_cost=entry_cost,
    )
That way the cost per unit from the original FIFO entry is preserved in the deduction record.