from app.extensions import limiter, cache
from app.utils.cache_utils import should_bypass_cache, stable_cache_key
from app.services.cache_invalidation import global_library_cache_key
from app.services.global_item_listing_service import (
    DEFAULT_PER_PAGE_OPTIONS as GLOBAL_LIBRARY_PER_PAGE_OPTIONS,
    DEFAULT_SCOPE as GLOBAL_LIBRARY_DEFAULT_SCOPE,
    SCOPE_LABELS as GLOBAL_SCOPE_LABELS,
    VALID_SCOPES as GLOBAL_LIBRARY_VALID_SCOPES,
    fetch_global_item_listing,
)

global_library_bp = Blueprint('global_library_bp', __name__)


@global_library_bp.route('/global-items')
@limiter.limit("60000/hour;5000/minute")
def global_library():
    """Public, read-only view of the Global Inventory Library.
    Supports filtering by item type and ingredient category, plus text search.
    Query params:
      - type: ingredient|container|packaging|consumable (optional)
      - category: ingredient category name (only when type=ingredient)
      - search: free text search across name and aka names
    """
    scope_param = (request.args.get('scope') or request.args.get('type') or '').strip()
    search_query = (request.args.get('search') or '').strip()
    raw_category = (request.args.get('category') or '').strip()
--
        "page_size": per_page_value,
    }
    raw_cache_key = stable_cache_key("global_library", cache_payload)
    cache_key = global_library_cache_key(raw_cache_key)

    bypass_cache = should_bypass_cache()
    if bypass_cache:
        cache.delete(cache_key)
    else:
        cached_page = cache.get(cache_key)
        if cached_page is not None:
            return cached_page

    listing = fetch_global_item_listing(
--
        params = _shared_query_params()
        params["page"] = str(page_number)
        return url_for('global_library_bp.global_library', **params)

    def build_scope_url(target_scope: str) -> str:
        params = _shared_query_params(target_scope)
        params.pop("page", None)
        params["scope"] = target_scope
        return url_for('global_library_bp.global_library', **params)

    clear_filters_url = url_for('global_library_bp.global_library', scope=active_scope)
    canonical_url = url_for('global_library_bp.global_library', _external=True)
    description_bits = [
        "Search the BatchTrack global inventory library.",
        "Browse ingredients, containers, packaging, and consumables with authoritative specs.",
    ]
    if active_scope:
        description_bits.insert(0, f"{GLOBAL_SCOPE_LABELS.get(active_scope, active_scope.title())} in the BatchTrack library.")

    can_manage = current_user.is_authenticated and getattr(current_user, "user_type", "") == "developer"

    rendered = render_template(
--
        is_public_view=True,
        slugify=slugify_value,
        developer_link_base=url_for('developer.global_item_detail', item_id=0)[:-1] if can_manage else None,
        page_title="Global Item Library — BatchTrack",
        page_description=" ".join(description_bits),
        canonical_url=canonical_url,
    )

    if not bypass_cache:
        cache.set(cache_key, rendered, timeout=current_app.config.get("GLOBAL_LIBRARY_CACHE_TTL", 300))
    return rendered


@global_library_bp.route('/global-items/<int:item_id>')
@global_library_bp.route('/global-items/<int:item_id>-<slug>')
def global_item_detail(item_id: int, slug: Optional[str] = None):
    """Public detail page for a specific Global Item."""
    gi = GlobalItem.query.filter(
        GlobalItem.is_archived != True,
        GlobalItem.id == item_id,
    ).first_or_404()

    canonical_slug = slugify_value(gi.name)
    if slug != canonical_slug:
        return redirect(
            url_for('global_library_bp.global_item_detail', item_id=item_id, slug=canonical_slug),
            code=301,
        )

    metadata = gi.metadata_json or {}
    description = metadata.get('meta_description') or f"{gi.name} specs, density, and usage guidance from the BatchTrack global library."
    page_title = metadata.get('meta_title') or f"{gi.name} — {gi.item_type.capitalize()} Reference"
    canonical_url = url_for('global_library_bp.global_item_detail', item_id=item_id, slug=canonical_slug, _external=True)

    rollup = {}
    cost = {}
    try:
        rollup = AnalyticsDataService.get_global_item_rollup(item_id) or {}
    except Exception:
        rollup = {}
    try:
        cost = AnalyticsDataService.get_cost_distribution(item_id) or {}
    except Exception:
--

    return render_template(
        'library/global_item_detail.html',
        item=gi,
        metadata=metadata,
        related_items=related_items,
        rollup=rollup,
        cost=cost,
        structured_data=ld_json,
        page_title=page_title,
        page_description=description,
        canonical_url=canonical_url,
        page_og_image=metadata.get('hero_image'),
--


@global_library_bp.route('/global-items/<int:item_id>/stats')
def global_library_item_stats(item_id: int):
    """Public stats endpoint for a GlobalItem, including cost distribution, rollup,
    basic item details, and category-based visibility flags when applicable.
    """
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"Stats request for global item {item_id}")

    try:
        from app.models.global_item import GlobalItem
        gi = GlobalItem.query.get_or_404(item_id)