Run # Initialize empty database
/opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
[2025-08-14 02:03:51,564] INFO in unit_utils: BatchTrack startup
INFO  [alembic.env] Imported model module: app.models.batch
INFO  [alembic.env] Imported model module: app.models.billing_snapshot
INFO  [alembic.env] Imported model module: app.models.category
INFO  [alembic.env] Imported model module: app.models.developer_permission
INFO  [alembic.env] Imported model module: app.models.developer_role
INFO  [alembic.env] Imported model module: app.models.inventory
INFO  [alembic.env] Imported model module: app.models.mixins
INFO  [alembic.env] Imported model module: app.models.models
INFO  [alembic.env] Imported model module: app.models.permission
INFO  [alembic.env] Imported model module: app.models.pricing_snapshot
INFO  [alembic.env] Imported model module: app.models.product
INFO  [alembic.env] Imported model module: app.models.recipe
INFO  [alembic.env] Imported model module: app.models.reservation
INFO  [alembic.env] Imported model module: app.models.role
INFO  [alembic.env] Imported model module: app.models.statistics
INFO  [alembic.env] Imported model module: app.models.stripe_event
INFO  [alembic.env] Imported model module: app.models.subscription_tier
INFO  [alembic.env] Imported model module: app.models.unified_inventory_history
INFO  [alembic.env] Imported model module: app.models.unit
INFO  [alembic.env] Imported model module: app.models.user_preferences
INFO  [alembic.env] Imported model module: app.models.user_role_assignment
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 4481595c5f02, empty message
INFO  [alembic.runtime.migration] Running upgrade 4481595c5f02 -> 132971c1d456, add all missing columns to match model definitions
INFO  [alembic.runtime.migration] Running upgrade 132971c1d456 -> f3b0e59fe9c1, add missing recipe columns
INFO  [alembic.runtime.migration] Running upgrade f3b0e59fe9c1 -> add_missing_timestamps, add missing timestamp columns
INFO  [alembic.runtime.migration] Running upgrade add_missing_timestamps -> fix_nullable_constraints, fix nullable columns and add constraints
INFO  [alembic.runtime.migration] Running upgrade fix_nullable_constraints -> add_unit_timestamps, add missing timestamp columns to unit table
INFO  [alembic.runtime.migration] Running upgrade add_unit_timestamps -> add_missing_created_at_columns, add missing created_at and updated_at columns to all models
INFO  [alembic.runtime.migration] Running upgrade add_missing_created_at_columns -> add_missing_table_schemas, add missing table schemas for billing_snapshot, pricing_snapshot, and statistics
INFO  [alembic.runtime.migration] Running upgrade add_missing_table_schemas -> fix_password_hash_length, fix password_hash column length
INFO  [alembic.runtime.migration] Running upgrade fix_password_hash_length -> 8b7aa70df87d, fix user_role_assignment constraints to allow NULL role_id for developer roles
INFO  [alembic.runtime.migration] Running upgrade 8b7aa70df87d -> 9d2a5c7f8b1e, fix inventory history constraints
INFO  [alembic.runtime.migration] Running upgrade 9d2a5c7f8b1e -> 1a2b3c4d5e6f, force drop unwanted columns
âœ… Migration completed: All columns added WITHOUT constraints
âš ï¸  TODO: Create a separate migration to add constraints after seeding
âœ… Recipe migration completed: All columns added safely
=== Adding missing columns and constraints ===
Warning: Could not create foreign key constraint: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
Warning: Could not create organization FK: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
Warning: Could not create developer_role FK: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
âœ… Migration completed: Added missing columns and tables
=== Fixing nullable columns and adding constraints ===
Updating user.user_type NULL values...
Updating organization.is_active NULL values...
Updating user.is_active NULL values...
Updating user.is_organization_owner NULL values...
Updating role.is_system_role NULL values...
Updating user_role_assignment.is_active NULL values...
Updating subscription_tier.is_active NULL values...
âœ… Migration completed: Updated NULL values to match model expectations
âš ï¸  Note: Columns remain nullable in database schema but models enforce NOT NULL
=== Adding missing timestamp columns to unit table ===
Adding timestamp columns to unit table...
  âœ… Added created_at column
  âœ… Added updated_at column
Adding timestamp columns to custom_unit_mapping table...
  â„¹ï¸  created_at column already exists
  âœ… Added updated_at column
Adding timestamp columns to conversion_log table...
  âœ… Added created_at column
  âœ… Added updated_at column
âœ… Migration completed: Added missing timestamp columns
=== Adding missing timestamp columns to all models ===
   Checking table: batch
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: billing_snapshot
      âœ… Added created_at column
      âœ… Added updated_at column
   âš ï¸  Skipping 'ingredient_category' - timestamps intentionally excluded
   Checking table: inventory_item
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'inventory_item' timestamp columns up to date
   Checking table: permission
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: pricing_snapshot
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: product
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'product' timestamp columns up to date
   Checking table: product_sku
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'product_sku' timestamp columns up to date
   Checking table: product_sku_history
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: product_variant
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'product_variant' timestamp columns up to date
   Checking table: recipe
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'recipe' timestamp columns up to date
   Checking table: recipe_ingredient
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: reservation
      â„¹ï¸  created_at column already exists
      âœ… Added updated_at column
   Checking table: role
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'role' timestamp columns up to date
   âš ï¸  Table 'statistics' doesn't exist, skipping
   Checking table: subscription_tier
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'subscription_tier' timestamp columns up to date
   Checking table: user_role_assignment
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: developer_role
      âœ… Added created_at column
      âœ… Added updated_at column
   Checking table: organization
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'organization' timestamp columns up to date
   Checking table: user
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'user' timestamp columns up to date
   Checking table: custom_unit_mapping
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'custom_unit_mapping' timestamp columns up to date
   Checking table: conversion_log
      â„¹ï¸  created_at column already exists
      â„¹ï¸  updated_at column already exists
      âœ… Table 'conversion_log' timestamp columns up to date
   Checking table: tag
      âœ… Added created_at column
      âœ… Added updated_at column
âœ… Migration completed: Added 19 timestamp columns across all tables
âš ï¸  All timestamp columns added as nullable for safety
=== Adding missing table schemas ===
   Creating billing_snapshots table...
   Warning: Could not create billing_snapshots organization FK: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
   Creating pricing_snapshots table...
   statistics table already exists - skipping
   Adding timestamps to existing organization_stats table...
âœ… Missing table schemas processed successfully
âš ï¸  Note: Skipping ingredient_category as requested
=== Fixing password_hash column length ===
   Updating user.password_hash column length from 120 to 255...
   âœ… Updated password_hash column to varchar(255)
âœ… Migration completed: password_hash column can now store longer hashes
=== Fixing user_role_assignment constraints ===
   Updating user_role_assignment.role_id to allow NULL...
   âœ… Updated role_id column to allow NULL values
   âš ï¸  Check constraint may already exist: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
âœ… User role assignment constraints fixed successfully
=== Fixing inventory history constraints ===
   âœ… inventory_history table already exists
   Dropping unwanted quantity_before column...
   âš ï¸  Direct SQL drop failed: (sqlite3.OperationalError) near "EXISTS": syntax error
[SQL: ALTER TABLE inventory_history DROP COLUMN IF EXISTS quantity_before CASCADE]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
   âœ… Dropped quantity_before column using batch mode
   Adding missing column: remaining_quantity
   Adding missing column: fifo_code
   Adding missing column: expiration_date
   Adding missing column: fifo_reference_id
   Adding missing column: quantity_used
   Adding missing column: is_perishable
   Adding missing column: shelf_life_days
   Updating remaining_quantity for existing records...
   âœ… Updated remaining_quantity values
   Cleaning up invalid data...
   âœ… Cleaned up invalid data
   âš ï¸  Could not add constraint ck_inventory_history_remaining_quantity_non_negative: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
   âœ… Created index: idx_inventory_history_item_remaining
   âœ… Created index: idx_inventory_history_fifo_code
   âœ… Created index: idx_inventory_history_timestamp
âœ… Inventory history constraints fixed successfully
=== Force dropping unwanted columns ===
   Database type detected: sqlite
   â„¹ï¸  Column quantity_before does not exist
   Attempting to drop column: quantity_after
   âœ… Dropped column: quantity_after (SQLite)
   Attempting to drop column: reason
   âœ… Dropped column: reason (SQLite)
   Attempting to drop column: user_id
INFO  [alembic.runtime.migration] Running upgrade 1a2b3c4d5e6f -> add_billing_columns_org, add billing columns to organization
INFO  [alembic.runtime.migration] Running upgrade add_billing_columns_org -> whop_integration, Add Whop integration fields to Organization
INFO  [alembic.runtime.migration] Running upgrade whop_integration -> a1b2c3d4e5f6789012345678901234ab, Add Whop integration fields to SubscriptionTier
INFO  [alembic.runtime.migration] Running upgrade a1b2c3d4e5f6789012345678901234ab -> 0e15af770cb3, simplify subscription tier model - remove billing fields
INFO  [alembic.runtime.migration] Running upgrade 0e15af770cb3 -> f4e5d6c7b8a9, remove nonexistent billing columns
INFO  [alembic.runtime.migration] Running upgrade f4e5d6c7b8a9 -> drop_deprecated_billing_columns, drop deprecated billing columns
INFO  [alembic.runtime.migration] Running upgrade drop_deprecated_billing_columns -> add_offline_billing_support, Add offline billing support
INFO  [alembic.runtime.migration] Running upgrade add_offline_billing_support -> 3f7a8b9c2d5e, Add offline billing support and missing billing fields
INFO  [alembic.runtime.migration] Running upgrade 3f7a8b9c2d5e -> 4246268c4e7c, add_oauth_and_email_verification_fields
INFO  [alembic.runtime.migration] Running upgrade 4246268c4e7c -> fix_missing_email_verification, fix missing email verification columns
INFO  [alembic.runtime.migration] Running upgrade fix_missing_email_verification -> add_fallback_price_column, add_fallback_price_column
INFO  [alembic.runtime.migration] Running upgrade add_fallback_price_column -> 9a2b8c4d5e6f, fix missing oauth columns postgresql
INFO  [alembic.runtime.migration] Running upgrade 9a2b8c4d5e6f -> b5c7d8e9f1a2, replace billing provider booleans with enum fields
INFO  [alembic.runtime.migration] Running upgrade b5c7d8e9f1a2 -> fix_unit_symbol_nullable, make unit symbol nullable for custom units
INFO  [alembic.runtime.migration] Running upgrade fix_unit_symbol_nullable -> c8f2e5a9b1d4, fix fallback_price column type from Numeric to String
INFO  [alembic.runtime.migration] Running upgrade c8f2e5a9b1d4 -> fix_product_sku_name_column, fix product_sku name column mismatch
INFO  [alembic.runtime.migration] Running upgrade fix_product_sku_name_column -> add_unique_constraint_stripe, add unique constraint on stripe event id
INFO  [alembic.runtime.migration] Running upgrade add_unique_constraint_stripe -> add_tier_key_column, add tier_key column to subscription_tier
INFO  [alembic.runtime.migration] Running upgrade add_tier_key_column -> add_legacy_compatibility_fields, add legacy compatibility fields to subscription tier
INFO  [alembic.runtime.migration] Running upgrade add_legacy_compatibility_fields -> 39e309ff02d1, add legacy compatibility fields to subscription tier
INFO  [alembic.runtime.migration] Running upgrade 39e309ff02d1 -> add_is_verified_to_user, add is_verified field to user table
INFO  [alembic.runtime.migration] Running upgrade add_is_verified_to_user -> add_email_verified_at_column, add email_verified_at column
INFO  [alembic.runtime.migration] Running upgrade add_email_verified_at_column -> 6f9bc65166b3, Create unified inventory history and merge data
   âœ… Dropped column: user_id (SQLite)
   âœ… Added required column: created_by
   âœ… Added required column: unit_cost
=== Force drop completed ===
=== Adding billing columns to organization table ===
   âœ… Organization table exists
   âœ… Column subscription_tier_id already exists
   Adding column: stripe_subscription_id
   âœ… Added stripe_subscription_id
   âœ… Column stripe_customer_id already exists
   Adding column: billing_info
   âœ… Added billing_info
   Adding column: next_billing_date
   âœ… Added next_billing_date
   âœ… Column subscription_status already exists
   Adding column: signup_source
   âœ… Added signup_source
   Adding column: promo_code
   âœ… Added promo_code
   Adding column: referral_code
   âœ… Added referral_code
   âœ… Column contact_email already exists
   Adding foreign key constraint for subscription_tier_id...
   âš ï¸  Could not add foreign key constraint: No support for ALTER of constraints in SQLite dialect. Please refer to the batch mode feature which allows for SQLite migrations using a copy-and-move strategy.
   Updating default subscription_status for existing records...
   âœ… Updated subscription_status defaults
âœ… Billing columns migration completed
=== Simplifying subscription tier model - removing billing fields ===
   Checking developer_permission table...
   âš ï¸  developer_permission.updated_at does not exist - skipping
   âš ï¸  developer_permission.created_at does not exist - skipping
   Checking developer_role table...
   Dropping developer_role.updated_at
   Dropping developer_role.created_at
   Checking subscription_tier table...
   âš ï¸  subscription_tier.whop_plan_id does not exist - skipping
   âš ï¸  subscription_tier.stripe_price_id does not exist - skipping
   âš ï¸  subscription_tier.billing_cycle does not exist - skipping
âœ… Migration completed: Simplified subscription tier model
=== Removing nonexistent billing columns ===
   âœ… Column billing_cycle already doesn't exist
   âœ… Column pricing_category already doesn't exist
   âœ… Column price_amount already doesn't exist
   âœ… Column currency already doesn't exist
=== Migration completed ===
=== Dropping deprecated billing columns ===
   âœ… Column billing_cycle doesn't exist (already clean)
   âœ… Column pricing_category doesn't exist (already clean)
   âœ… Column price_amount doesn't exist (already clean)
   âœ… Column currency doesn't exist (already clean)
=== Migration completed ===
=== Mock migration: add_offline_billing_support ===
   No changes to apply - this is a mock revision for production sync
âœ… Mock migration completed
=== Adding offline billing support and missing billing fields ===
   Adding offline support to subscription_tier...
   âœ… Added last_billing_sync
   âœ… Added grace_period_days
   Adding fields to organization...
   Adding column: last_online_sync
   âœ… Added last_online_sync
   Adding column: offline_tier_cache
   âœ… Added offline_tier_cache
   Adding column: billing_status
   âœ… Added billing_status
   âœ… Column stripe_customer_id already exists
   âœ… Column stripe_subscription_id already exists
   âœ… Column whop_license_key already exists
   âœ… Column whop_product_tier already exists
   âœ… Column whop_verified already exists
   Updating default values for existing records...
   âœ… Updated default values
âœ… Offline billing and missing fields migration completed
=== Adding OAuth and email verification fields ===
   Adding created_at column to developer_permission...
   Adding created_at column to developer_role...
   âš ï¸  email_verified column already exists, skipping
   âš ï¸  email_verification_token column already exists, skipping
   Adding email_verification_sent_at column...
   Adding oauth_provider column...
   Adding oauth_provider_id column...
   âš ï¸  password_reset_token column already exists, skipping
   Adding password_reset_sent_at column...
   Adding google_id column...
âœ… Migration completed: OAuth and email verification fields
ðŸ”§ Fixing missing email verification columns...
   âœ… email_verification_sent_at column already exists
   âœ… password_reset_sent_at column already exists
âœ… Email verification columns fix completed
=== Adding fallback_price column to subscription_tier ===
   Adding fallback_price column...
âœ… fallback_price column added successfully
=== OAuth Column Fix (SQLite/PostgreSQL compatible) ===
   âš ï¸  oauth_provider column already exists, skipping
   âš ï¸  oauth_provider_id column already exists, skipping
   âš ï¸  password_reset_token column already exists, skipping
   âš ï¸  password_reset_sent_at column already exists, skipping
   âš ï¸  email_verification_sent_at column already exists, skipping
   No columns to add - all OAuth columns already exist
âœ… OAuth columns migration completed
=== Replacing billing provider booleans with enum fields ===
   Adding tier_type column...
   Adding billing_provider column...
   Migrating existing data from legacy boolean columns...
   âš ï¸  Data migration failed: (sqlite3.OperationalError) no such column: requires_stripe_billing
[SQL: 
                UPDATE subscription_tier
                SET
                  tier_type = CASE
                    WHEN COALESCE(requires_stripe_billing, 0) = 1
                      OR COALESCE(requires_google_billing, 0) = 1  
                      OR COALESCE(requires_whop_billing, 0) = 1
                    THEN 'paid' ELSE 'free' END,
                  billing_provider = CASE
                    WHEN COALESCE(requires_stripe_billing, 0) = 1 THEN 'stripe'
                    WHEN COALESCE(requires_google_billing, 0) = 1 THEN 'google'
                    WHEN COALESCE(requires_whop_billing, 0) = 1 THEN 'whop'
                    ELSE NULL END
            ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
   Dropping legacy boolean columns...
   âœ… Dropped requires_whop_billing
âœ… Billing provider enum migration completed
=== Making unit symbol nullable ===
   â„¹ï¸  Index ix_unit_standard_unique doesn't exist, skipping
   âœ… Made symbol column nullable
   âœ… Created new ix_unit_symbol index
âœ… Migration completed: Unit symbol is now nullable
=== Fixing fallback_price column type ===
   Converting fallback_price from Numeric to String...
âœ… fallback_price column type fixed
=== Fixing product_sku name/sku_name column mismatch ===
   name column exists: True
   sku_name column exists: True
   Both columns exist - migrating data and dropping 'name'
   âœ… Migrated name data to sku_name
   âœ… Dropped old 'name' column
Creating stripe_event table...
âœ… Created stripe_event table
=== Adding missing columns to subscription_tier ===
   Adding tier_key column...
âœ… tier_key column added successfully
   âš ï¸  max_users column already exists, skipping
   Adding max_monthly_batches column...
âœ… max_monthly_batches column added successfully
   Setting default values for max_monthly_batches...
   Populating tier_key values from key column...
=== Migration completed ===
=== No-op migration: add_legacy_compatibility_fields ===
âœ… This is a placeholder migration with no changes
=== Adding legacy compatibility fields to subscription_tier ===
   Adding stripe_product_id column...
âœ… stripe_product_id column added successfully
   Adding stripe_price_id column...
âœ… stripe_price_id column added successfully
   âš ï¸  stripe_price_id_monthly column already exists, skipping
   âš ï¸  stripe_price_id_yearly column already exists, skipping
=== Legacy compatibility fields migration completed ===
=== Adding is_verified field to user table ===
   Adding is_verified column...
âœ… is_verified column added successfully
=== Migration completed ===
=== Adding email_verified_at column (no-op) ===
   Column already exists in current schema
âœ… Migration completed
=== Creating UnifiedInventoryHistory and migrating data ===
   Creating unified_inventory_history table...
   Creating indexes...
   Migrating data from inventory_history...
   âš ï¸  Error migrating inventory_history: (sqlite3.OperationalError) no such column: ih.note
[SQL: 
            INSERT INTO unified_inventory_history (
                inventory_item_id, timestamp, change_type, quantity_change, unit,
                unit_cost, remaining_quantity, fifo_reference_id, fifo_code,
                batch_id, created_by, notes, quantity_used, used_for_batch_id,
                is_perishable, shelf_life_days, expiration_date, organization_id
            )
            SELECT 
                ih.inventory_item_id,
                COALESCE(ih.timestamp, datetime('now')) as timestamp,
                COALESCE(ih.change_type, 'unknown') as change_type,
                COALESCE(ih.quantity_change, 0.0) as quantity_change,
                COALESCE(ih.unit, 'g') as unit,
                ih.unit_cost,
                COALESCE(ih.remaining_quantity, 0.0) as remaining_quantity,
                ih.fifo_reference_id,
                ih.fifo_code,
                ih.batch_id,
                ih.created_by,
                COALESCE(ih.note, ih.reason) as notes,
                COALESCE(ih.quantity_used, 0.0) as quantity_used,
                ih.used_for_batch_id,
                COALESCE(ih.is_perishable, 0) as is_perishable,
                ih.shelf_life_days,
                ih.expiration_date,
                COALESCE(ii.organization_id, 1) as organization_id
            FROM inventory_history ih
            LEFT JOIN inventory_item ii ON ih.inventory_item_id = ii.id
        ]
INFO  [alembic.runtime.migration] Running upgrade 6f9bc65166b3 -> 57d6ce45a761, empty message
(Background on this error at: https://sqlalche.me/e/20/e3q8)
   Migrating data from product_sku_history...
   âœ… Successfully migrated product_sku_history data
   âœ… Unified inventory history migration completed
/opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
[2025-08-14 02:03:54,022] INFO in unit_utils: BatchTrack startup
INFO  [alembic.env] Imported model module: app.models.batch
INFO  [alembic.env] Imported model module: app.models.billing_snapshot
INFO  [alembic.env] Imported model module: app.models.category
INFO  [alembic.env] Imported model module: app.models.developer_permission
INFO  [alembic.env] Imported model module: app.models.developer_role
INFO  [alembic.env] Imported model module: app.models.inventory
INFO  [alembic.env] Imported model module: app.models.mixins
INFO  [alembic.env] Imported model module: app.models.models
INFO  [alembic.env] Imported model module: app.models.permission
INFO  [alembic.env] Imported model module: app.models.pricing_snapshot
INFO  [alembic.env] Imported model module: app.models.product
INFO  [alembic.env] Imported model module: app.models.recipe
INFO  [alembic.env] Imported model module: app.models.reservation
INFO  [alembic.env] Imported model module: app.models.role
INFO  [alembic.env] Imported model module: app.models.statistics
INFO  [alembic.env] Imported model module: app.models.stripe_event
INFO  [alembic.env] Imported model module: app.models.subscription_tier
INFO  [alembic.env] Imported model module: app.models.unified_inventory_history
INFO  [alembic.env] Imported model module: app.models.unit
INFO  [alembic.env] Imported model module: app.models.user_preferences
INFO  [alembic.env] Imported model module: app.models.user_role_assignment
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
/home/runner/work/BatchTrack/BatchTrack/migrations/env.py:139: SAWarning: Cannot correctly sort tables; there are unresolvable cycles between tables "batch, product_sku", which is usually caused by mutually dependent foreign key constraints.  Foreign key constraints involving these tables will not be considered; this warning may raise an error in a future release.
  context.run_migrations()
INFO  [alembic.autogenerate.compare] Detected added table 'developer_role_permission'
INFO  [alembic.autogenerate.compare] Detected added table 'subscription_tier_permission'
INFO  [alembic.autogenerate.compare] Detected removed table 'pricing_snapshot'
INFO  [alembic.autogenerate.compare] Detected removed table 'billing_snapshot'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (sku_id)(id) on table batch
INFO  [alembic.autogenerate.compare] Detected added foreign key (sku_id)(inventory_item_id) on table batch
INFO  [alembic.autogenerate.compare] Detected removed column 'batch.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.container_id'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.container_quantity'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.quantity_used'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.fill_quantity'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.fill_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.cost_each'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_container.organization_id'
INFO  [alembic.autogenerate.compare] Detected added foreign key (container_id)(id) on table batch_container
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table batch_container
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.container_name'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.container_unit'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.qr_code'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.notes'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.quantity_filled'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.label_printed'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_container.container_size'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_ingredient.organization_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'batch_ingredient.unit'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table batch_ingredient
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_ingredient.fifo_deduction_log'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_inventory_log.action'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_inventory_log.quantity_change'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_inventory_log.old_stock'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_inventory_log.new_stock'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_inventory_log.organization_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'batch_inventory_log.unit'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (user_id)(id) on table batch_inventory_log
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table batch_inventory_log
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.quantity_used'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.cost_per_unit'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.total_cost'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.user_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.quantity_before'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_inventory_log.quantity_after'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_timer.name'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_timer.duration_seconds'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_timer.status'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_timer.organization_id'
INFO  [alembic.autogenerate.compare] Detected added column 'batch_timer.created_by'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'batch_timer.batch_id'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table batch_timer
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table batch_timer
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_timer.timer_name'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_timer.notes'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_timer.is_active'
INFO  [alembic.autogenerate.compare] Detected removed column 'batch_timer.duration_minutes'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.organization_id'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.confirmed_tier'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.confirmed_status'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.period_start'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.period_end'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'billing_snapshots.last_stripe_sync'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table billing_snapshots
INFO  [alembic.autogenerate.compare] Detected removed column 'billing_snapshots.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'conversion_log.amount'
INFO  [alembic.autogenerate.compare] Detected added column 'conversion_log.result'
INFO  [alembic.autogenerate.compare] Detected added column 'conversion_log.conversion_type'
INFO  [alembic.autogenerate.compare] Detected added column 'conversion_log.ingredient_name'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'conversion_log.user_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'conversion_log.from_unit'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'conversion_log.to_unit'
INFO  [alembic.autogenerate.compare] Detected removed column 'conversion_log.to_amount'
INFO  [alembic.autogenerate.compare] Detected removed column 'conversion_log.conversion_factor'
INFO  [alembic.autogenerate.compare] Detected removed column 'conversion_log.from_amount'
INFO  [alembic.autogenerate.compare] Detected removed column 'conversion_log.category_density'
INFO  [alembic.autogenerate.compare] Detected added column 'custom_unit_mapping.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'custom_unit_mapping.from_unit'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'custom_unit_mapping.to_unit'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (ingredient_id)(id) on table custom_unit_mapping
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table custom_unit_mapping
INFO  [alembic.autogenerate.compare] Detected removed column 'custom_unit_mapping.ingredient_id'
INFO  [alembic.autogenerate.compare] Detected added column 'developer_permission.category'
INFO  [alembic.autogenerate.compare] Detected added column 'developer_permission.is_active'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'developer_permission.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to Text() on 'developer_permission.description'
INFO  [alembic.autogenerate.compare] Detected added column 'developer_role.category'
INFO  [alembic.autogenerate.compare] Detected added column 'developer_role.is_active'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=80) to String(length=64) on 'developer_role.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to Text() on 'developer_role.description'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.container_id'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.container_quantity'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.quantity_used'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.fill_quantity'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.fill_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.cost_each'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.reason'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_container.organization_id'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table extra_batch_container
INFO  [alembic.autogenerate.compare] Detected added foreign key (container_id)(id) on table extra_batch_container
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.container_name'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.container_unit'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.notes'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.quantity_filled'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_container.container_size'
INFO  [alembic.autogenerate.compare] Detected added column 'extra_batch_ingredient.organization_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'extra_batch_ingredient.unit'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (added_by)(id) on table extra_batch_ingredient
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table extra_batch_ingredient
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_ingredient.added_by'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_ingredient.reason'
INFO  [alembic.autogenerate.compare] Detected removed column 'extra_batch_ingredient.added_at'
INFO  [alembic.autogenerate.compare] Detected added column 'ingredient_category.description'
INFO  [alembic.autogenerate.compare] Detected added column 'ingredient_category.color'
INFO  [alembic.autogenerate.compare] Detected added column 'ingredient_category.default_density'
INFO  [alembic.autogenerate.compare] Detected added column 'ingredient_category.is_active'
INFO  [alembic.autogenerate.compare] Detected added column 'ingredient_category.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=64) on 'ingredient_category.name'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table ingredient_category
INFO  [alembic.autogenerate.compare] Detected removed column 'ingredient_category.density'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_history.note'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_history.used_for_batch_id'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_history.organization_id'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'inventory_history.change_type'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'inventory_history.quantity_change'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'inventory_history.unit'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'inventory_history.remaining_quantity'
INFO  [alembic.autogenerate.compare] Detected type change from REAL() to Float() on 'inventory_history.unit_cost'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'inventory_history.fifo_code'
INFO  [alembic.autogenerate.compare] Detected type change from DATE() to DateTime() on 'inventory_history.expiration_date'
INFO  [alembic.autogenerate.compare] Detected removed index 'idx_inventory_history_fifo_code' on 'inventory_history'
INFO  [alembic.autogenerate.compare] Detected removed index 'idx_inventory_history_item_remaining' on 'inventory_history'
INFO  [alembic.autogenerate.compare] Detected removed index 'idx_inventory_history_timestamp' on 'inventory_history'
INFO  [alembic.autogenerate.compare] Detected added foreign key (used_for_batch_id)(id) on table inventory_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table inventory_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table inventory_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (fifo_reference_id)(id) on table inventory_history
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.density'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.type'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.is_active'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.is_archived'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.is_perishable'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.shelf_life_days'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.storage_amount'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.storage_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.created_by'
INFO  [alembic.autogenerate.compare] Detected added column 'inventory_item.intermediate'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'inventory_item.name'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'inventory_item.quantity'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'inventory_item.unit'
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('name',)'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table inventory_item
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.supplier'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.storage_location'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.batch_code'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.notes'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.fifo_code'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.item_type'
INFO  [alembic.autogenerate.compare] Detected removed column 'inventory_item.purchase_date'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'organization.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=120) to String(length=256) on 'organization.contact_email'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'organization.subscription_status'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'organization.subscription_tier'
INFO  [alembic.autogenerate.compare] Detected added foreign key (subscription_tier_id)(id) on table organization
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.timezone'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.subscription_item_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.subscription_end_date'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.billing_cycle'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization.subscription_start_date'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.completed_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.failed_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.cancelled_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.active_users'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.total_inventory_value'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.total_products'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.total_products_made'
INFO  [alembic.autogenerate.compare] Detected added column 'organization_stats.last_updated'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization_stats.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization_stats.last_batch_date'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization_stats.total_production_value'
INFO  [alembic.autogenerate.compare] Detected removed column 'organization_stats.avg_batch_cost'
INFO  [alembic.autogenerate.compare] Detected added column 'permission.category'
INFO  [alembic.autogenerate.compare] Detected added column 'permission.is_active'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'permission.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to Text() on 'permission.description'
INFO  [alembic.autogenerate.compare] Detected removed column 'permission.updated_at'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.stripe_price_id'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.stripe_lookup_key'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.stripe_product_id'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.unit_amount'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.interval'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.product_name'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'pricing_snapshots.last_stripe_sync'
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('stripe_price_id',)'
INFO  [alembic.autogenerate.compare] Detected removed column 'pricing_snapshots.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'product.base_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'product.subcategory'
INFO  [alembic.autogenerate.compare] Detected added column 'product.low_stock_threshold'
INFO  [alembic.autogenerate.compare] Detected added column 'product.is_discontinued'
INFO  [alembic.autogenerate.compare] Detected added column 'product.created_by'
INFO  [alembic.autogenerate.compare] Detected added column 'product.shopify_product_id'
INFO  [alembic.autogenerate.compare] Detected added column 'product.etsy_shop_section_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'product.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'product.category'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_product_name_per_org' on '('name', 'organization_id')'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (base_recipe_id)(id) on table product
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table product
INFO  [alembic.autogenerate.compare] Detected removed column 'product.base_recipe_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'product.image_url'
INFO  [alembic.autogenerate.compare] Detected added column 'product_sku.sku'
INFO  [alembic.autogenerate.compare] Detected added column 'product_sku.quantity_override'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'product_sku.product_id'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'product_sku.size_label'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'product_sku.sku_code'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'product_sku.sku_code'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_active_skus'' on '('is_active', 'is_product_active')'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_inventory_item'' on '('inventory_item_id',)'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_product_variant'' on '('product_id', 'variant_id')'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_product_sku_inventory_item_id'' on '('inventory_item_id',)'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_barcode' on '('barcode',)'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_sku_combination' on '('product_id', 'variant_id', 'size_label', 'fifo_id')'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_upc' on '('upc',)'
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('barcode',)'
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('sku',)'
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('upc',)'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table product_sku
INFO  [alembic.autogenerate.compare] Detected added foreign key (quality_checked_by)(id) on table product_sku
INFO  [alembic.autogenerate.compare] Detected added foreign key (variant_id)(id) on table product_sku
INFO  [alembic.autogenerate.compare] Detected added foreign key (container_id)(id) on table product_sku
INFO  [alembic.autogenerate.compare] Detected added foreign key (batch_id)(id) on table product_sku
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku.price'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku.cost'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku.size'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku.barcode_type'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku.size_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'product_sku_history.organization_id'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'product_sku_history.inventory_item_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'product_sku_history.change_type'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'product_sku_history.quantity_change'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'product_sku_history.unit'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'product_sku_history.unit'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_change_type'' on '('change_type',)'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_fifo_code'' on '('fifo_code',)'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_inventory_item_remaining'' on '('inventory_item_id', 'remaining_quantity')'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_inventory_item_timestamp'' on '('inventory_item_id', 'timestamp')'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (user_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected removed foreign key (sku_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (container_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (inventory_item_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (fifo_reference_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected added foreign key (quality_checked_by)(id) on table product_sku_history
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.user_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.quantity_before'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.reason'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.sku_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_sku_history.quantity_after'
INFO  [alembic.autogenerate.compare] Detected added column 'product_variant.color'
INFO  [alembic.autogenerate.compare] Detected added column 'product_variant.material'
INFO  [alembic.autogenerate.compare] Detected added column 'product_variant.scent'
INFO  [alembic.autogenerate.compare] Detected added column 'product_variant.created_by'
INFO  [alembic.autogenerate.compare] Detected added column 'product_variant.organization_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'product_variant.name'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_product_variant' on '('product_id', 'name')'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (recipe_id)(id) on table product_variant
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table product_variant
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table product_variant
INFO  [alembic.autogenerate.compare] Detected removed column 'product_variant.price_modifier'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_variant.cost_modifier'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_variant.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'product_variant.recipe_id'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.label_prefix'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.qr_image'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.parent_id'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.is_locked'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.predicted_yield'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.predicted_yield_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe.allowed_containers'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'recipe.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=128) on 'recipe.name'
INFO  [alembic.autogenerate.compare] Detected added foreign key (parent_id)(id) on table recipe
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.base_yield'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.description'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.is_active'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.tags'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.yield_unit'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.notes'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.version'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe_ingredient.order_position'
INFO  [alembic.autogenerate.compare] Detected added column 'recipe_ingredient.organization_id'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'recipe_ingredient.unit'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table recipe_ingredient
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe_ingredient.order_index'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe_ingredient.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'recipe_ingredient.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.order_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.reservation_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.product_item_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.reserved_item_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.unit_cost'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.sale_price'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.customer'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.source_fifo_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.source_batch_id'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.status'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.source'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.released_at'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.converted_at'
INFO  [alembic.autogenerate.compare] Detected added column 'reservation.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'reservation.unit'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_expires_at'' on '('expires_at',)'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_order_status'' on '('order_id', 'status')'
INFO  [alembic.autogenerate.compare] Detected added index ''idx_reserved_item_status'' on '('reserved_item_id', 'status')'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_reservation_order_id'' on '('order_id',)'
INFO  [alembic.autogenerate.compare] Detected removed foreign key (inventory_item_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected removed foreign key (batch_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected removed foreign key (user_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected added foreign key (source_batch_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected added foreign key (reserved_item_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected added foreign key (product_item_id)(id) on table reservation
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.inventory_item_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.reservation_type'
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.user_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.reference_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'reservation.batch_id'
INFO  [alembic.autogenerate.compare] Detected added column 'role.is_active'
INFO  [alembic.autogenerate.compare] Detected added column 'role.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=80) to String(length=64) on 'role.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to Text() on 'role.description'
INFO  [alembic.autogenerate.compare] Detected added unique constraint 'unique_role_name_org' on '('name', 'organization_id')'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table role
INFO  [alembic.autogenerate.compare] Detected removed column 'role.updated_at'
INFO  [alembic.autogenerate.compare] Detected removed unique constraint 'uq_stripe_event_event_id' on 'stripe_event'
INFO  [alembic.autogenerate.compare] Detected changed index 'ix_stripe_event_event_id' on 'stripe_event': unique=False to unique=True
INFO  [alembic.autogenerate.compare] Detected added column 'subscription_tier.user_limit'
INFO  [alembic.autogenerate.compare] Detected added column 'subscription_tier.is_customer_facing'
INFO  [alembic.autogenerate.compare] Detected added column 'subscription_tier.is_available'
INFO  [alembic.autogenerate.compare] Detected added column 'subscription_tier.stripe_lookup_key'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'subscription_tier.name'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'subscription_tier.key'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=32) on 'subscription_tier.key'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to String(length=128) on 'subscription_tier.stripe_price_id_monthly'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=255) to String(length=128) on 'subscription_tier.stripe_price_id_yearly'
INFO  [alembic.autogenerate.compare] Detected NOT NULL on column 'subscription_tier.max_users'
INFO  [alembic.autogenerate.compare] Detected changed index 'ix_subscription_tier_tier_key' on 'subscription_tier': unique=False to unique=True
INFO  [alembic.autogenerate.compare] Detected added unique constraint None on '('key',)'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.is_active'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.whop_product_name'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.price_yearly'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.max_organizations'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.features'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.whop_last_synced'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.price_monthly'
INFO  [alembic.autogenerate.compare] Detected removed column 'subscription_tier.display_name'
INFO  [alembic.autogenerate.compare] Detected added column 'tag.description'
INFO  [alembic.autogenerate.compare] Detected added column 'tag.is_active'
INFO  [alembic.autogenerate.compare] Detected added column 'tag.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'tag.name'
INFO  [alembic.autogenerate.compare] Detected added unique constraint '_tag_name_org_uc' on '('name', 'organization_id')'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table tag
INFO  [alembic.autogenerate.compare] Detected removed column 'tag.updated_at'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'unified_inventory_history.remaining_quantity'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'unified_inventory_history.quantity_used'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'unified_inventory_history.is_perishable'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'unified_inventory_history.is_reserved'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'unified_inventory_history.organization_id'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_unified_inventory_history_change_type'' on '('change_type',)'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_unified_inventory_history_expiration_date'' on '('expiration_date',)'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_unified_inventory_history_fifo_code'' on '('fifo_code',)'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_unified_inventory_history_inventory_item_id'' on '('inventory_item_id',)'
INFO  [alembic.autogenerate.compare] Detected added index ''ix_unified_inventory_history_timestamp'' on '('timestamp',)'
INFO  [alembic.autogenerate.compare] Detected added column 'unit.base_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'unit.is_active'
INFO  [alembic.autogenerate.compare] Detected added column 'unit.is_custom'
INFO  [alembic.autogenerate.compare] Detected added column 'unit.is_mapped'
INFO  [alembic.autogenerate.compare] Detected added column 'unit.created_by'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'unit.name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=10) to String(length=16) on 'unit.symbol'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=20) to String(length=32) on 'unit.unit_type'
INFO  [alembic.autogenerate.compare] Detected removed index 'ix_unit_symbol' on 'unit'
INFO  [alembic.autogenerate.compare] Detected added unique constraint '_unit_name_org_uc' on '('name', 'organization_id')'
INFO  [alembic.autogenerate.compare] Detected added foreign key (created_by)(id) on table unit
INFO  [alembic.autogenerate.compare] Detected removed column 'unit.is_base_unit'
INFO  [alembic.autogenerate.compare] Detected added column 'user.last_login'
INFO  [alembic.autogenerate.compare] Detected added column 'user.timezone'
INFO  [alembic.autogenerate.compare] Detected added column 'user.deleted_at'
INFO  [alembic.autogenerate.compare] Detected added column 'user.deleted_by'
INFO  [alembic.autogenerate.compare] Detected added column 'user.is_deleted'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=80) to String(length=64) on 'user.username'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'user.password_hash'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=64) on 'user.first_name'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=100) to String(length=64) on 'user.last_name'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'user.email'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=20) to String(length=32) on 'user.user_type'
INFO  [alembic.autogenerate.compare] Detected added foreign key (deleted_by)(id) on table user
INFO  [alembic.autogenerate.compare] Detected removed column 'user.password_reset_expires'
INFO  [alembic.autogenerate.compare] Detected removed column 'user.google_id'
INFO  [alembic.autogenerate.compare] Detected removed column 'user.is_verified'
INFO  [alembic.autogenerate.compare] Detected removed column 'user.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.organization_id'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.max_dashboard_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_expiration_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_timer_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_low_stock_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_batch_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_fault_alerts'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_alert_badges'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.compact_view'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.show_quick_actions'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.created_at'
INFO  [alembic.autogenerate.compare] Detected added column 'user_preferences.updated_at'
INFO  [alembic.autogenerate.compare] Detected type change from TEXT() to String(length=32) on 'user_preferences.dashboard_layout'
INFO  [alembic.autogenerate.compare] Detected type change from VARCHAR(length=50) to String(length=64) on 'user_preferences.timezone'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table user_preferences
INFO  [alembic.autogenerate.compare] Detected removed column 'user_preferences.email_notifications'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_preferences.date_format'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_preferences.theme'
INFO  [alembic.autogenerate.compare] Detected added foreign key (developer_role_id)(id) on table user_role_assignment
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table user_role_assignment
INFO  [alembic.autogenerate.compare] Detected removed column 'user_role_assignment.created_at'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_role_assignment.updated_at'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.organization_id'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.total_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.completed_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.failed_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.cancelled_batches'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.total_recipes'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.recipes_created'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.inventory_adjustments'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.inventory_items_created'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.products_created'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.total_products_made'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.last_updated'
INFO  [alembic.autogenerate.compare] Detected added column 'user_stats.created_at'
INFO  [alembic.autogenerate.compare] Detected added foreign key (organization_id)(id) on table user_stats
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.last_batch_date'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.last_login'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.total_batches_created'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.preferred_units'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.total_recipes_created'
INFO  [alembic.autogenerate.compare] Detected removed column 'user_stats.updated_at'
Generating /home/runner/work/BatchTrack/BatchTrack/migrations/versions/test_check_test_migration_check.py ...  done
âŒ Migration drift detected! Models don't match migrations.
Run 'flask db migrate' and commit the result.
Error: Process completed with exit code 1.
