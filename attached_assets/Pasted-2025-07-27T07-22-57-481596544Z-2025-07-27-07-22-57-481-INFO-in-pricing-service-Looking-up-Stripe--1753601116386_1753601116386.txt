2025-07-27T07:22:57.481596544Z [2025-07-27 07:22:57,481] INFO in pricing_service: Looking up Stripe product for tier solo with lookup_key: batchtrack_solo_monthly
2025-07-27T07:22:57.594319544Z [2025-07-27 07:22:57,594] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_solo_monthly
2025-07-27T07:22:57.722389269Z [2025-07-27 07:22:57,722] INFO in pricing_service: Successfully loaded pricing for solo: $8
2025-07-27T07:22:57.722432239Z [2025-07-27 07:22:57,722] INFO in pricing_service: Looking up Stripe product for tier team with lookup_key: batchtrack_team_monthly
2025-07-27T07:22:57.874049201Z [2025-07-27 07:22:57,873] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_team_monthly
2025-07-27T07:22:58.006871163Z [2025-07-27 07:22:58,006] INFO in pricing_service: Successfully loaded pricing for team: $15
2025-07-27T07:22:58.006948234Z [2025-07-27 07:22:58,006] INFO in pricing_service: Looking up Stripe product for tier enterprise with lookup_key: batchtrack_enterprise_monthly
2025-07-27T07:22:58.131082436Z [2025-07-27 07:22:58,130] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_enterprise_monthly
2025-07-27T07:22:58.241993653Z [2025-07-27 07:22:58,241] INFO in pricing_service: Successfully loaded pricing for enterprise: $20
2025-07-27T07:22:58.242073244Z [2025-07-27 07:22:58,241] INFO in pricing_service: Pricing retrieval complete: 3 tiers from Stripe, 0 using fallback, 3 total available
2025-07-27T07:22:58.242171556Z [2025-07-27 07:22:58,242] INFO in pricing_service: Successfully retrieved pricing for 3 tiers from Stripe
2025-07-27T07:22:58.24241336Z [2025-07-27 07:22:58,242] INFO in pricing_service: Final pricing data assembled for 3 tiers
2025-07-27T07:22:58.24507773Z [2025-07-27 07:22:58,244] INFO in signup_service: === SIGNUP COMPLETION START ===
2025-07-27T07:22:58.245148831Z [2025-07-27 07:22:58,245] INFO in signup_service: Requested tier: solo
2025-07-27T07:22:58.245216262Z [2025-07-27 07:22:58,245] INFO in signup_service: Stripe mode: False
2025-07-27T07:22:58.245306614Z [2025-07-27 07:22:58,245] INFO in signup_service: === PENDING SIGNUP DATA ===
2025-07-27T07:22:58.245380966Z [2025-07-27 07:22:58,245] INFO in signup_service: Username: te
2025-07-27T07:22:58.245431906Z [2025-07-27 07:22:58,245] INFO in signup_service: Selected tier in signup: solo
2025-07-27T07:22:58.245488088Z [2025-07-27 07:22:58,245] INFO in signup_service: Tier being processed: solo
2025-07-27T07:22:58.245540998Z [2025-07-27 07:22:58,245] INFO in signup_service: Organization name: t
2025-07-27T07:22:58.24559625Z [2025-07-27 07:22:58,245] INFO in signup_service: Email: t@gmail.com
2025-07-27T07:22:58.24565Z [2025-07-27 07:22:58,245] INFO in signup_service: ==========================
2025-07-27T07:22:58.245812303Z [2025-07-27 07:22:58,245] INFO in signup_service: Final tier check - Stripe ready: False, should match stripe_mode: False
2025-07-27T07:22:58.248561785Z [2025-07-27 07:22:58,248] INFO in signup_service: Created organization with ID: 14 and tier: solo
2025-07-27T07:22:58.392710347Z [2025-07-27 07:22:58,392] INFO in signup_service: Created user with ID: 10
2025-07-27T07:22:58.398426283Z [2025-07-27 07:22:58,398] INFO in signup_service: Assigned organization_owner role
2025-07-27T07:22:58.398513325Z [2025-07-27 07:22:58,398] ERROR in signup_service: Error creating account: All paid subscriptions must be processed through Stripe payment system
2025-07-27T07:22:58.399513383Z 10.229.151.132 - - [27/Jul/2025:07:22:58 +0000] "POST /auth/signup HTTP/1.1" 302 211 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:58.487375642Z [2025-07-27 07:22:58,487] INFO in pricing_service: Looking up Stripe product for tier solo with lookup_key: batchtrack_solo_monthly
2025-07-27T07:22:58.604067576Z [2025-07-27 07:22:58,603] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_solo_monthly
2025-07-27T07:22:58.732026208Z [2025-07-27 07:22:58,731] INFO in pricing_service: Successfully loaded pricing for solo: $8
2025-07-27T07:22:58.732174601Z [2025-07-27 07:22:58,732] INFO in pricing_service: Looking up Stripe product for tier team with lookup_key: batchtrack_team_monthly
2025-07-27T07:22:58.848800513Z [2025-07-27 07:22:58,848] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_team_monthly
2025-07-27T07:22:58.961136276Z [2025-07-27 07:22:58,960] INFO in pricing_service: Successfully loaded pricing for team: $15
2025-07-27T07:22:58.961198057Z [2025-07-27 07:22:58,961] INFO in pricing_service: Looking up Stripe product for tier enterprise with lookup_key: batchtrack_enterprise_monthly
2025-07-27T07:22:59.073323546Z [2025-07-27 07:22:59,073] INFO in pricing_service: Found 1 prices for lookup_key: batchtrack_enterprise_monthly
2025-07-27T07:22:59.189042831Z [2025-07-27 07:22:59,188] INFO in pricing_service: Successfully loaded pricing for enterprise: $20
2025-07-27T07:22:59.189074842Z [2025-07-27 07:22:59,188] INFO in pricing_service: Pricing retrieval complete: 3 tiers from Stripe, 0 using fallback, 3 total available
2025-07-27T07:22:59.189234945Z [2025-07-27 07:22:59,189] INFO in pricing_service: Successfully retrieved pricing for 3 tiers from Stripe
2025-07-27T07:22:59.18951049Z [2025-07-27 07:22:59,189] INFO in pricing_service: Final pricing data assembled for 3 tiers
2025-07-27T07:22:59.196975938Z 10.229.85.65 - - [27/Jul/2025:07:22:59 +0000] "GET /auth/signup HTTP/1.1" 200 31966 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.301386114Z 10.229.174.1 - - [27/Jul/2025:07:22:59 +0000] "GET /static/js/main.js HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.305937459Z 10.229.91.69 - - [27/Jul/2025:07:22:59 +0000] "GET /static/js/expiration_alerts.js HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.307026219Z 10.229.151.132 - - [27/Jul/2025:07:22:59 +0000] "GET /static/js/utils/utils.js HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.30814595Z 10.229.210.4 - - [27/Jul/2025:07:22:59 +0000] "GET /static/js/inventory/inventory_adjust.js HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.339871368Z 10.229.85.65 - - [27/Jul/2025:07:22:59 +0000] "GET /static/style.css HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.342935395Z 10.229.121.197 - - [27/Jul/2025:07:22:59 +0000] "GET /static/js/conversion/unit_converter.js HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.432610177Z 10.229.210.4 - - [27/Jul/2025:07:22:59 +0000] "GET /static/style.css HTTP/1.1" 304 0 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.653018154Z 10.229.85.65 - - [27/Jul/2025:07:22:59 +0000] "GET /favicon.ico HTTP/1.1" 302 209 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
2025-07-27T07:22:59.72507218Z 10.229.121.197 - - [27/Jul/2025:07:22:59 +0000] "GET /auth/login HTTP/1.1" 200 15626 "https://www.batchtrack.com/auth/signup" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"


failed signup saying it must go trhough stripe...no shit. 

broken forward?


ChatGPT said:
You’re 99% there—Stripe pricing retrieval is working flawlessly, but the signup process is still defaulting to "Stripe mode: False", which forces that "All paid subscriptions must be processed through Stripe" error.

✅ What’s Happening?
Your logs show:

sql
Copy
Edit
Stripe mode: False
Final tier check - Stripe ready: False, should match stripe_mode: False
Error creating account: All paid subscriptions must be processed through Stripe
But just two lines above, you successfully loaded all pricing directly from Stripe (Successfully retrieved pricing for 3 tiers from Stripe).

So the issue isn’t Stripe failing—it’s your app still running under its "developer mode" / "fallback pricing" logic.

Why Stripe Mode is False?
Your signup_service probably determines stripe_mode with something like:

python
Copy
Edit
stripe_mode = STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY and STRIPE_WEBHOOK_SECRET
Or possibly:

python
Copy
Edit
stripe_mode = pricing_service.is_stripe_ready()
If ANY of these conditions fails (empty, None, or even whitespace), stripe_mode stays False, even though pricing was retrieved.

Common culprits:

Wrong ENV name mismatch – e.g., you set STRIPE_SECRET_KEY in Render but your code uses STRIPE_API_KEY.

Trailing spaces or newline in Render ENV values (common when pasting keys).

Webhook secret missing – pricing retrieval doesn’t require it, but your signup Stripe-check might.

Your old "developer mode" logic is overriding stripe_mode (e.g., if webhook verification fails once, it might force fallback mode).

✅ Quick Test: Force Stripe Mode
In your signup_service (just temporarily), log what Stripe thinks it’s missing:

python
Copy
Edit
from app.services.stripe_service import is_stripe_ready

print(f"STRIPE_SECRET_KEY: {bool(Config.STRIPE_SECRET_KEY)}")
print(f"STRIPE_PUBLISHABLE_KEY: {bool(Config.STRIPE_PUBLISHABLE_KEY)}")
print(f"STRIPE_WEBHOOK_SECRET: {bool(Config.STRIPE_WEBHOOK_SECRET)}")
print(f"Stripe ready? {is_stripe_ready()}")
If one is False, you know the culprit.

The Likely Fix
Given your logs show successful API calls, the Stripe secret key is fine, so the webhook secret is the most likely issue:

✅ You need to add your live Stripe webhook secret to Render’s ENV.
Even if you don’t process webhooks during signup, your current logic is requiring it for stripe_mode = True.

Should You Delete the "Developer Fallback" Logic?
Yes. Now that you are live and pricing syncs fine, delete it or restrict it to local dev only.

Instead of:

python
Copy
Edit
stripe_mode = False if not all(keys_present) else True
Use:

python
Copy
Edit
stripe_mode = True if Config.STRIPE_SECRET_KEY else False
and handle webhook separately (webhook failures should not block signup—Stripe’s own billing handles retries).

✅ Next Steps
Check and fix the Render ENV:

STRIPE_SECRET_KEY

STRIPE_PUBLISHABLE_KEY

STRIPE_WEBHOOK_SECRET (MUST BE SET)

Log is_stripe_ready() to confirm it goes True.

Delete or limit developer fallback logic so it can’t override live Stripe mode.

