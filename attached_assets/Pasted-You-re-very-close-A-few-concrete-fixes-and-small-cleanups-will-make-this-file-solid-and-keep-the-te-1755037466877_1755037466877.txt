You’re very close! A few concrete fixes and small cleanups will make this file solid and keep the tests happy.

Needed fixes
Import what you use

You use session → add:

python
Copy
Edit
from flask import session
You reference IngredientCategory and User in queries/template context → add (adjust path if your models are split):

python
Copy
Edit
from app.models import IngredientCategory, User
Remove dupes / unused

process_inventory_adjustment is imported twice—drop one.

If you’re not using permission_required / role_required in this module, you can remove those imports to avoid brittle imports. (It’s fine to leave them if you plan to decorate routes soon.)

Fix redirects: parameter name
Your route is view_inventory(id) so url_for('inventory.view_inventory', **id=...**) is required. You currently use item_id= in a few places.
Change every:

python
Copy
Edit
url_for('inventory.view_inventory', item_id=item.id)
to:

python
Copy
Edit
url_for('inventory.view_inventory', id=item.id)
Keep the canonical calls exactly where tests expect
You’ve got this right:

For recount in /adjust/<id> you call process_inventory_adjustment(..., change_type='recount', unit=...).

For initial stock (no history + restock) you call process_inventory_adjustment with unit and cost_override — that matches the test’s assert_called_once_with.

Minor correctness nits (non-blocking for tests)

In add_inventory, you pass custom_expiration_date= into process_inventory_adjustment. The canonical service typically honors custom_shelf_life_days and computes expiration_date itself. If your service doesn’t read custom_expiration_date, you can drop that arg (or ensure the service reads it from kwargs).

You import Unit but don’t use it here—safe to remove.

Quick diff-style summary
Add:

python
Copy
Edit
from flask import session
from app.models import IngredientCategory, User
Remove one duplicate:

python
Copy
Edit
from app.services.inventory_adjustment import process_inventory_adjustment  # keep only once
Fix redirects in /adjust/<id> (and any others):

python
Copy
Edit
return redirect(url_for('inventory.view_inventory', id=item.id))
Smoke check tests to run
Route delegation:

cpp
Copy
Edit
pytest -q tests/test_inventory_routes_canonicalization.py::test_recount_adjustment_uses_canonical_service \
           tests/test_inventory_routes_canonicalization.py::TestInventoryRoutesCanonicalService::test_adjust_inventory_initial_stock_calls_canonical_service
FIFO path you already fixed elsewhere:

cpp
Copy
Edit
pytest -q tests/test_inventory_fifo.py::TestInventoryFIFOCharacterization::test_fifo_deduction_order
If those pass, you’re aligned with PR2’s goal: thin routes, single canonical entry, FIFO doing the heavy lifting.