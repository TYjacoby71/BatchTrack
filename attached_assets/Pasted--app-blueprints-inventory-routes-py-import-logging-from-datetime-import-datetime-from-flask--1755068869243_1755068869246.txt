# app/blueprints/inventory/routes.py

import logging
from datetime import datetime

from flask import Blueprint, flash, jsonify, redirect, render_template, request, session, url_for
from flask_login import current_user, login_required
from sqlalchemy import and_, func
from sqlalchemy.orm import joinedload

from app.models import (IngredientCategory, InventoryHistory, InventoryItem,
                        User, db)
# This is the ONLY service needed for adjustments now.
from app.services.inventory_adjustment import process_inventory_adjustment
from app.utils.timezone_utils import TimezoneUtils

logger = logging.getLogger(__name__)

inventory_bp = Blueprint('inventory', __name__, template_folder='templates')


@inventory_bp.route('/')
@login_required
def list_inventory():
    """Renders the main inventory list page."""
    show_archived = request.args.get('show_archived') == 'true'
    query = InventoryItem.query.filter_by(organization_id=current_user.organization_id)

    # Exclude product-related items from this general inventory view
    query = query.filter(~InventoryItem.type.in_(['product', 'product-reserved']))

    if not show_archived:
        query = query.filter(InventoryItem.is_archived != True)

    inventory_items = query.order_by(InventoryItem.is_archived.asc(), InventoryItem.name.asc()).all()
    categories = IngredientCategory.query.filter_by(organization_id=current_user.organization_id).all()
    total_value = sum(item.quantity * item.cost_per_unit for item in inventory_items if item.quantity and item.cost_per_unit)

    return render_template('inventory_list.html',
                           items=inventory_items,
                           categories=categories,
                           total_value=total_value,
                           show_archived=show_archived)


@inventory_bp.route('/view/<int:id>')
@login_required
def view_inventory(id):
    """Renders the detailed view for a single inventory item."""
    item = InventoryItem.query.filter_by(id=id, organization_id=current_user.organization_id).first_or_404()
    
    page = request.args.get('page', 1, type=int)
    per_page = 25 # Increased for better usability
    
    history_query = InventoryHistory.query.filter_by(inventory_item_id=id).options(
        joinedload(InventoryHistory.batch),
        joinedload(InventoryHistory.used_for_batch)
    ).order_by(InventoryHistory.timestamp.desc())

    pagination = history_query.paginate(page=page, per_page=per_page, error_out=False)

    return render_template('inventory/view.html',
                           item=item,
                           history=pagination.items,
                           pagination=pagination)


@inventory_bp.route('/add', methods=['POST'])
@login_required
def add_inventory():
    """Handles the creation of a new inventory item."""
    name = request.form.get('name')
    if not name:
        flash('Item name is required.', 'error')
        return redirect(url_for('inventory.list_inventory'))

    # Check for duplicate name within the organization
    existing_item = InventoryItem.query.filter_by(name=name, organization_id=current_user.organization_id).first()
    if existing_item:
        flash(f'An item named "{name}" already exists.', 'error')
        return redirect(url_for('inventory.list_inventory'))

    try:
        item = InventoryItem(
            name=name,
            quantity=0, # All items start at 0, quantity is set by the initial transaction
            type=request.form.get('type', 'ingredient'),
            organization_id=current_user.organization_id,
            is_archived=False
        )
        db.session.add(item)
        db.session.flush() # Flush to get the new item.id

        initial_quantity = float(request.form.get('quantity', 0.0))
        if initial_quantity > 0:
            process_inventory_adjustment(
                item_id=item.id,
                quantity=initial_quantity,
                change_type='restock',
                notes='Initial stock creation',
                created_by=current_user.id
            )
        
        db.session.commit()
        flash('Inventory item added successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        logger.error(f"Error adding inventory item: {e}", exc_info=True)
        flash(f'Error adding item: {str(e)}', 'error')

    return redirect(url_for('inventory.list_inventory'))


@inventory_bp.route('/adjust/<int:id>', methods=['POST'])
@login_required
def adjust_inventory(id):
    """
    A single, clean route to handle ALL inventory adjustments.
    It gathers form data and passes it to the canonical service for processing.
    """
    item = InventoryItem.query.get_or_404(id)
    if item.organization_id != current_user.organization_id:
        flash("You do not have permission to adjust this item.", "error")
        return redirect(url_for('inventory.list_inventory'))

    try:
        # Gather all data from the form
        adj_type = request.form.get('adjustment_type', '').strip().lower()
        quantity_str = request.form.get('quantity', '0.0')
        notes = request.form.get('notes')
        unit = request.form.get('input_unit') or item.unit
        
        if not adj_type:
            raise ValueError("An adjustment type (e.g., 'spoil', 'recount') is required.")
            
        quantity = float(quantity_str)

        # Make a single, clean call to the now-robust canonical service
        process_inventory_adjustment(
            item_id=id,
            quantity=quantity,
            change_type=adj_type,
            unit=unit,
            notes=notes,
            created_by=current_user.id
        )

        flash(f'Inventory adjustment "{adj_type.replace("_", " ").title()}" was successful.', 'success')

    except ValueError as e:
        # Catch specific, known errors (like insufficient stock or bad input from the service)
        flash(f'Adjustment failed: {str(e)}', 'error')
    except Exception as e:
        # Catch any other unexpected errors from the service layer
        flash(f'An unexpected server error occurred. Please contact support.', 'error')
        logger.error(f"Unexpected error in adjust_inventory for item {id}: {e}", exc_info=True)

    return redirect(url_for('inventory.view_inventory', id=id))


@inventory_bp.route('/edit/<int:id>', methods=['POST'])
@login_required
def edit_inventory(id):
    """Handles updates to an inventory item's details."""
    item = InventoryItem.query.get_or_404(id)
    if item.organization_id != current_user.organization_id:
        flash("You do not have permission to edit this item.", "error")
        return redirect(url_for('inventory.list_inventory'))

    try:
        item.name = request.form.get('name', item.name)
        item.low_stock_threshold = float(request.form.get('low_stock_threshold', item.low_stock_threshold or 0.0))
        # Add other fields from your original edit route here if needed
        
        db.session.commit()
        flash(f'"{item.name}" updated successfully.', 'success')
    except Exception as e:
        db.session.rollback()
        logger.error(f"Error editing inventory item {id}: {e}", exc_info=True)
        flash(f'Error updating item: {str(e)}', 'error')

    return redirect(url_for('inventory.view_inventory', id=id))


@inventory_bp.route('/archive/<int:id>')
@login_required
def archive_inventory(id):
    """Archives an inventory item."""
    item = InventoryItem.query.get_or_404(id)
    if item.organization_id != current_user.organization_id:
        flash("You do not have permission to archive this item.", "error")
        return redirect(url_for('inventory.list_inventory'))

    try:
        item.is_archived = True
        db.session.commit()
        flash(f'"{item.name}" has been archived.', 'success')
    except Exception as e:
        db.session.rollback()
        logger.error(f"Error archiving item {id}: {e}", exc_info=True)
        flash(f'Error archiving item: {str(e)}', 'error')
        
    return redirect(url_for('inventory.list_inventory'))


@inventory_bp.route('/restore/<int:id>')
@login_required
def restore_inventory(id):
    """Restores an archived inventory item."""
    item = InventoryItem.query.get_or_404(id)
    if item.organization_id != current_user.organization_id:
        flash("You do not have permission to restore this item.", "error")
        return redirect(url_for('inventory.list_inventory'))

    try:
        item.is_archived = False
        db.session.commit()
        flash(f'"{item.name}" has been restored.', 'success')
    except Exception as e:
        db.session.rollback()
        logger.error(f"Error restoring item {id}: {e}", exc_info=True)
        flash(f'Error restoring item: {str(e)}', 'error')

    return redirect(url_for('inventory.list_inventory', show_archived='true'))