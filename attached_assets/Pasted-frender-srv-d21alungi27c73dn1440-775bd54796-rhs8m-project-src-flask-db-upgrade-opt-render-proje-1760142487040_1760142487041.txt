frender@srv-d21alungi27c73dn1440-775bd54796-rhs8m:~/project/src$ flask db upgrade
/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(

=== Blueprint Registration Summary ===
✅ Successful: 29
   - Authentication
   - Admin
   - Developer
   - Inventory
   - Recipes
   - Batches
   - Organization
   - Billing
   - Settings
   - Timers
   - Expiration
   - Conversion
   - Products Main
   - Public API
   - Main API
   - Drawer Actions
   - Density Reference
   - Retention Drawer API
   - Global Link Drawer API
   - App Routes
   - Legal Routes
   - Bulk Stock
   - Fault Log
   - Tag Manager
   - Global Library Public
   - Waitlist
   - Public Tools
   - Production Planning
   - Exports

🎉 All blueprints registered successfully!
INFO  [alembic.env] Imported model module: app.models.addon
INFO  [alembic.env] Imported model module: app.models.batch
INFO  [alembic.env] Imported model module: app.models.billing_snapshot
INFO  [alembic.env] Imported model module: app.models.category
INFO  [alembic.env] Imported model module: app.models.developer_permission
INFO  [alembic.env] Imported model module: app.models.developer_role
INFO  [alembic.env] Imported model module: app.models.domain_event
INFO  [alembic.env] Imported model module: app.models.freshness_snapshot
INFO  [alembic.env] Imported model module: app.models.global_item
INFO  [alembic.env] Imported model module: app.models.global_item_alias
INFO  [alembic.env] Imported model module: app.models.inventory
INFO  [alembic.env] Imported model module: app.models.inventory_lot
INFO  [alembic.env] Imported model module: app.models.mixins
INFO  [alembic.env] Imported model module: app.models.models
INFO  [alembic.env] Imported model module: app.models.permission
INFO  [alembic.env] Imported model module: app.models.pricing_snapshot
INFO  [alembic.env] Imported model module: app.models.product
INFO  [alembic.env] Imported model module: app.models.product_category
INFO  [alembic.env] Imported model module: app.models.recipe
INFO  [alembic.env] Imported model module: app.models.reservation
INFO  [alembic.env] Imported model module: app.models.retention
INFO  [alembic.env] Imported model module: app.models.role
INFO  [alembic.env] Imported model module: app.models.statistics
INFO  [alembic.env] Imported model module: app.models.stripe_event
INFO  [alembic.env] Imported model module: app.models.subscription_tier
INFO  [alembic.env] Imported model module: app.models.unified_inventory_history
INFO  [alembic.env] Imported model module: app.models.unit
INFO  [alembic.env] Imported model module: app.models.user_preferences
INFO  [alembic.env] Imported model module: app.models.user_role_assignment
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 20250922_01_align_extras -> 20250922_02, Add inventory cost method toggle and valuation method fields
=== Adding inventory cost method toggle and valuation method fields ===
Adding inventory_cost_method to organization...
✅ Added inventory_cost_method column
Adding inventory_cost_method_changed_at to organization...
✅ Added inventory_cost_method_changed_at column
Adding valuation_method to unified_inventory_history...
✅ Added valuation_method column
Adding cost_method to batch...
✅ Added cost_method column
Adding cost_method_locked_at to batch...
✅ Added cost_method_locked_at column
✅ Inventory cost method migration completed
INFO  [alembic.runtime.migration] Running upgrade 20250922_02 -> 20250923_01, Create product_category table
=== Creating product_category table ===
Creating product_category table...
✅ Created product_category table
✅ Created index ix_product_category_organization_id on product_category
✅ Created index ix_product_category_name on product_category
✅ Product category migration completed
INFO  [alembic.runtime.migration] Running upgrade 20250923_01 -> 20250923_02, Add category_id to product and recipe, backfill to Uncategorized, set NOT NULL
Starting product and recipe category migration...
Adding category_id column to product table...
Adding category_id column to recipe table...
Backfilling product category_id values...
Found 0 products with NULL category_id
Backfilling recipe category_id values...
Found 0 recipes with NULL category_id
Adding constraints to product table...
Created foreign key fk_product_category
Created index ix_product_category_id
Set product.category_id to NOT NULL
Adding constraints to recipe table...
Created foreign key fk_recipe_category
Created index ix_recipe_category_id
Set recipe.category_id to NOT NULL
✅ Product and recipe category migration completed successfully!
INFO  [alembic.runtime.migration] Running upgrade 20250923_02 -> 20250923_03, Add portioning_data JSON to recipe and batch
Added portioning_data column to recipe table
Added portioning_data column to batch table
INFO  [alembic.runtime.migration] Running upgrade 20250923_03 -> 20250923_04, Add sku_name_template to product_category
   ✅ sku_name_template column added successfully
INFO  [alembic.runtime.migration] Running upgrade 20250923_04 -> 20250924_01, Drop Product.base_unit column
INFO  [alembic.runtime.migration] Running upgrade 20250924_01 -> 20250925_01, Add portion columns to recipe and batch: is_portioned, portion_name, counts
Added column is_portioned to recipe
Added column portion_name to recipe
Added column counts to recipe
Added column is_portioned to batch
Added column portion_name to batch
Added column counts to batch
INFO  [alembic.runtime.migration] Running upgrade 20250925_01 -> 20250925_02, Add plan_snapshot JSON to batch
Added column plan_snapshot to batch
INFO  [alembic.runtime.migration] Running upgrade 20250925_02 -> 20250925_03, Add portion_unit_id FK to recipe and batch
Added column portion_unit_id to recipe
Added column portion_unit_id to batch
INFO  [alembic.runtime.migration] Running upgrade 20250925_03 -> 20250925_04, Add container structured attributes to inventory_item and global_item
Added column container_material to inventory_item
Added column container_volume to inventory_item
Added column container_volume_unit to inventory_item
Added column container_dimensions to inventory_item
Added column container_color to inventory_item
Added column container_closure_type to inventory_item
Added column container_shape to inventory_item
Added column container_material to global_item
Added column container_volume to global_item
Added column container_volume_unit to global_item
Added column container_dimensions to global_item
Added column container_color to global_item
Added column container_closure_type to global_item
Added column container_shape to global_item
INFO  [alembic.runtime.migration] Running upgrade 20250925_04 -> 20250930_1, Add global_item_alias table and performance indexes
=== Adding alias table and performance indexes ===
   Creating global_item_alias table...
   ✅ global_item_alias table created
   ✅ Created GIN index for alias search
   ✅ Backfilled aliases from aka_names
   Creating index ix_inventory_item_org on inventory_item.organization_id...
   ✅ Created index ix_inventory_item_org
   Creating index ix_inventory_lot_org on inventory_lot.organization_id...
   ✅ Created index ix_inventory_lot_org
   Creating index ix_unified_history_org on unified_inventory_history.organization_id...
   ✅ Created index ix_unified_history_org
   Creating index ix_recipe_org on recipe.organization_id...
   ✅ Created index ix_recipe_org
   Creating index ix_batch_org on batch.organization_id...
   ✅ Created index ix_batch_org
   Creating index ix_user_org on user.organization_id...
   ✅ Created index ix_user_org
   ✅ Created JSONB GIN index on aka_names
✅ Alias and indexes migration completed
INFO  [alembic.runtime.migration] Running upgrade 20250930_1 -> 20250930_2, Add soap making and cosmetic formulation attributes to inventory items
=== Adding soap making and cosmetic formulation fields to inventory items ===
Processing inventory_item table...
  ✅ Added saponification_value to inventory_item
  ✅ Added iodine_value to inventory_item
  ✅ Added melting_point_c to inventory_item
  ✅ Added flash_point_c to inventory_item
  ✅ Added ph_value to inventory_item
  ✅ Added moisture_content_percent to inventory_item
  ✅ Added shelf_life_months to inventory_item
  ✅ Added comedogenic_rating to inventory_item
✅ Soap making and cosmetic formulation fields migration completed successfully
INFO  [alembic.runtime.migration] Running upgrade 20250930_2 -> 20250930_3, Add soap making and cosmetic formulation attributes to global_item table
=== Adding soap making and cosmetic formulation fields to global_item ===
Processing global_item table...
  ✅ Added saponification_value to global_item
  ✅ Added iodine_value to global_item
  ✅ Added melting_point_c to global_item
  ✅ Added flash_point_c to global_item
  ✅ Added ph_value to global_item
  ✅ Added moisture_content_percent to global_item
  ✅ Added shelf_life_months to global_item
  ✅ Added comedogenic_rating to global_item
✅ Soap making and cosmetic formulation fields migration for global_item completed successfully
INFO  [alembic.runtime.migration] Running upgrade 20250930_3 -> 20250930_4, Add visibility control fields for soap-making attributes to ingredient categories
=== Adding visibility control fields to ingredient_category ===
   ✅ show_saponification_value column added successfully
   ✅ show_iodine_value column added successfully
   ✅ show_melting_point_c column added successfully
   ✅ show_flash_point_c column added successfully
   ✅ show_ph_value column added successfully
   ✅ show_moisture_content_percent column added successfully
   ✅ show_shelf_life_months column added successfully
   ✅ show_comedogenic_rating column added successfully
✅ Visibility control fields migration completed
INFO  [alembic.runtime.migration] Running upgrade 20250930_4 -> 20250930_5, Set default visibility flags for global ingredient categories
Setting visibility defaults for global ingredient categories from JSON files...
   ❌ Error processing fragrance_oils.json: (psycopg2.errors.UndefinedColumn) column "show_flash_point" of relation "ingredient_category" does not exist
LINE 3:                     SET show_flash_point = true, show_shelf_...
                                ^

[SQL: 
                    UPDATE ingredient_category 
                    SET show_flash_point = %(show_flash_point)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_flash_point': True, 'show_shelf_life_months': True, 'category_name': 'Fragrance Oils'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
   ❌ Error processing oils_liquid_fats.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_saponification_value = %(show_saponification_value)s, show_iodine_value = %(show_iodine_value)s, show_melting_point = %(show_melting_point)s, show_shelf_life_months = %(show_shelf_life_months)s, show_comedogenic_rating = %(show_comedogenic_rating)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_saponification_value': True, 'show_iodine_value': True, 'show_melting_point': True, 'show_shelf_life_months': True, 'show_comedogenic_rating': True, 'category_name': 'Oils (Carrier & Fixed)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing herbs_spices_dried_botanicals.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Herbs & Spices (Dried & Ground)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing waxes.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_saponification_value = %(show_saponification_value)s, show_iodine_value = %(show_iodine_value)s, show_melting_point = %(show_melting_point)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_saponification_value': True, 'show_iodine_value': True, 'show_melting_point': True, 'show_shelf_life_months': True, 'category_name': 'Waxes'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing fruits_nuts_seeds_whole_chopped.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Fruits, Nuts & Seeds (Whole/Chopped)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing clays.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Clays'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing flours_powders_organic.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Flours & Powders (Organic)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing cultures_scobys_fermentation.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Yeast & Cultures'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing preservatives_additives.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_shelf_life_months': True, 'category_name': 'Preservatives & Additives'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing colorants_pigments.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Colorants (Pigments)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing butters_solid_fats.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_saponification_value = %(show_saponification_value)s, show_iodine_value = %(show_iodine_value)s, show_melting_point = %(show_melting_point)s, show_shelf_life_months = %(show_shelf_life_months)s, show_comedogenic_rating = %(show_comedogenic_rating)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_saponification_value': True, 'show_iodine_value': True, 'show_melting_point': True, 'show_shelf_life_months': True, 'show_comedogenic_rating': True, 'category_name': 'Butters & Solid Fats'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing salts_minerals_crystalline.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Salts & Minerals (Crystalline)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing botanicals_whole_parts.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Botanicals (Dried & Whole/Parts)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing extracts_alcohols_solvents.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_flash_point = %(show_flash_point)s, show_ph_value = %(show_ph_value)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_flash_point': True, 'show_ph_value': True, 'show_shelf_life_months': True, 'category_name': 'Extracts & Alcohols (Solvents)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing essential_oils.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_flash_point = %(show_flash_point)s, show_shelf_life_months = %(show_shelf_life_months)s, show_comedogenic_rating = %(show_comedogenic_rating)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_flash_point': True, 'show_shelf_life_months': True, 'show_comedogenic_rating': True, 'category_name': 'Essential Oils'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing active_ingredients_cosmetics.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_shelf_life_months = %(show_shelf_life_months)s, show_comedogenic_rating = %(show_comedogenic_rating)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_shelf_life_months': True, 'show_comedogenic_rating': True, 'category_name': 'Active Ingredients (Cosmetics)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing surfactants_emulsifiers.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_shelf_life_months': True, 'category_name': 'Surfactants & Emulsifiers'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing liquids_aqueous.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_ph_value = %(show_ph_value)s, show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_ph_value': True, 'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Liquids (Aqueous)'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing miscellaneous.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_shelf_life_months': True, 'category_name': 'Miscellaneous'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing sugars_syrups.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Sugars & Syrups'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
   ❌ Error processing starches_thickeners.json: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
                    UPDATE ingredient_category 
                    SET show_moisture_content = %(show_moisture_content)s, show_shelf_life_months = %(show_shelf_life_months)s
                    WHERE name = %(category_name)s AND organization_id IS NULL
                ]
[parameters: {'show_moisture_content': True, 'show_shelf_life_months': True, 'category_name': 'Starches & Thickeners'}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
✅ Category visibility defaults set successfully!
Traceback (most recent call last):
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/opt/render/project/src/.venv/bin/flask", line 8, in <module>
    sys.exit(main())
             ~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask/cli.py", line 1129, in main
    cli.main()
    ~~~~~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1082, in main
    rv = self.invoke(ctx)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1697, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
                           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1697, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
                           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1443, in invoke
    return ctx.invoke(self.callback, **ctx.params)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 788, in invoke
    return __callback(*args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask/cli.py", line 400, in decorator
    return ctx.invoke(f, *args, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 788, in invoke
    return __callback(*args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/cli.py", line 150, in upgrade
    _upgrade(directory, revision, sql, tag, x_arg)
    ~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/__init__.py", line 111, in wrapped
    f(*args, **kwargs)
    ~^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/__init__.py", line 200, in upgrade
    command.upgrade(config, revision, sql=sql, tag=tag)
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/command.py", line 408, in upgrade
    script.run_env()
    ~~~~~~~~~~~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/script/base.py", line 586, in run_env
    util.load_python_file(self.dir, "env.py")
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/util/pyfiles.py", line 95, in load_python_file
    module = load_module_py(module_id, path)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/util/pyfiles.py", line 113, in load_module_py
    spec.loader.exec_module(module)  # type: ignore
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "<frozen importlib._bootstrap_external>", line 1026, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/opt/render/project/src/migrations/env.py", line 147, in <module>
    run_migrations_online()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/opt/render/project/src/migrations/env.py", line 141, in run_migrations_online
    context.run_migrations()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 8, in run_migrations
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/environment.py", line 946, in run_migrations
    self.get_context().run_migrations(**kw)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/migration.py", line 630, in run_migrations
    head_maintainer.update_to_step(step)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/migration.py", line 862, in update_to_step
    self._update_version(from_, to_)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/migration.py", line 797, in _update_version
    ret = self.context.impl._exec(
        self.context._version.update()
    ...<4 lines>...
        )
    )
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/ddl/impl.py", line 246, in _exec
    return conn.execute(construct, params)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1638, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE alembic_version SET version_num='20250930_5' WHERE alembic_version.version_num = '20250930_4']
(Background on this error at: https://sqlalche.me/e/20/2j85)