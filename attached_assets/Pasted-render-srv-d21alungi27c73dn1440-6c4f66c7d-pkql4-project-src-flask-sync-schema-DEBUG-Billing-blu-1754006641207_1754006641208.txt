render@srv-d21alungi27c73dn1440-6c4f66c7d-pkql4:~/project/src$ flask sync-schema
DEBUG: Billing blueprint imported successfully: <Blueprint 'billing'>
DEBUG: Billing blueprint name: billing
DEBUG: Billing blueprint url_prefix: /billing
DEBUG: Billing blueprint registered successfully
Registered API routes: ['/api/reservations/create', '/api/reservations/release/<int:reservation_id>', '/api/reservations/convert-to-sale/<int:reservation_id>', '/api/reservations/expire-old', '/api/products/<int:product_id>/variants', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/server-time', '/api/server-time', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/check-stock', '/api/categories', '/api/ingredient/<int:id>/density', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/api/api/fifo-details/<int:inventory_id>', '/api/api/batch-inventory-summary/<int:batch_id>', '/api/api/reservations/create', '/api/api/reservations/release/<int:reservation_id>', '/api/api/reservations/convert-to-sale/<int:reservation_id>', '/api/api/reservations/expire-old', '/api/dashboard-alerts', '/api/dismiss-alert', '/api/units', '/api/convert-units']
Container routes found: ['/settings/bulk-update-containers', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/debug-containers', '/available-containers/<int:recipe_id>', '/containers/available', '/batches/<int:batch_id>/containers', '/batches/<int:batch_id>/containers/<int:container_id>', '/batches/<int:batch_id>/containers/<int:container_id>/adjust']
Billing routes found: ['/billing/reconciliation-needed', '/billing/reconcile-to-free', '/billing/upgrade', '/billing/checkout/<tier>/<billing_cycle>', '/billing/checkout/<tier>', '/billing/customer-portal', '/billing/cancel-subscription', '/billing/webhooks/stripe', '/billing/complete-signup-from-stripe', '/billing/debug']
Billing endpoints: [('/billing/reconciliation-needed', 'billing.reconciliation_needed'), ('/billing/reconcile-to-free', 'billing.reconcile_to_free'), ('/billing/upgrade', 'billing.upgrade'), ('/billing/checkout/<tier>/<billing_cycle>', 'billing.checkout'), ('/billing/checkout/<tier>', 'billing.checkout'), ('/billing/customer-portal', 'billing.customer_portal'), ('/billing/cancel-subscription', 'billing.cancel_subscription'), ('/billing/webhooks/stripe', 'billing.stripe_webhook'), ('/billing/complete-signup-from-stripe', 'billing.complete_signup_from_stripe'), ('/billing/debug', 'billing.debug_billing')]
[2025-08-01 00:01:40,992] INFO in unit_utils: BatchTrack startup
ğŸš€ Syncing database schema to match models (safe mode)...
ğŸ“¦ Dynamically importing all models...
   âœ“ Organization
   âœ“ User
   âœ“ InventoryItem
   âœ“ InventoryHistory
   âœ“ BatchInventoryLog
   âœ“ Recipe
   âœ“ RecipeIngredient
   âœ“ Batch
   âœ“ BatchIngredient
   âœ“ BatchContainer
   âœ“ ExtraBatchContainer
   âœ“ BatchTimer
   âœ“ ExtraBatchIngredient
   âœ“ Unit
   âœ“ CustomUnitMapping
   âœ“ ConversionLog
   âœ“ IngredientCategory
   âœ“ Tag
   âœ“ Product
   âœ“ ProductVariant
   âœ“ ProductSKU
   âœ“ ProductSKUHistory
   âœ“ Reservation
   âœ“ Role
   âœ“ Permission
   âœ“ UserRoleAssignment
   âœ“ UserPreferences
   âœ“ UserStats
   âœ“ OrganizationStats
   âœ“ SubscriptionTier
   âœ“ DeveloperPermission
   âœ“ DeveloperRole
   âœ“ BillingSnapshot
   âœ“ PricingSnapshot
   âœ“ Loaded models from batch.py
   âœ“ Loaded models from billing_snapshot.py
   âœ“ Loaded models from category.py
   âœ“ Loaded models from developer_permission.py
   âœ“ Loaded models from developer_role.py
   âœ“ Loaded models from inventory.py
   âœ“ Loaded models from mixins.py
   âœ“ Loaded models from models.py
   âœ“ Loaded models from permission.py
   âœ“ Loaded models from pricing_snapshot.py
   âœ“ Loaded models from product.py
   âœ“ Loaded models from recipe.py
   âœ“ Loaded models from reservation.py
   âœ“ Loaded models from role.py
   âœ“ Loaded models from statistics.py
   âœ“ Loaded models from subscription_tier.py
   âœ“ Loaded models from unit.py
   âœ“ Loaded models from user_preferences.py
   âœ“ Loaded models from user_role_assignment.py
âœ… 34 models imported dynamically
ğŸ“Š Found 40 existing tables
ğŸ—ï¸  Creating any missing tables...
âœ… No new tables needed
ğŸ”§ Checking for missing columns in existing tables...
   ğŸ“‹ Table 'inventory_item' missing columns: is_perishable, shelf_life_days, is_archived, is_active, density, type, storage_amount, intermediate, storage_unit, created_by
      âœ… Added column: is_perishable (BOOLEAN)
      âœ… Added column: shelf_life_days (INTEGER)
      âœ… Added column: is_archived (BOOLEAN)
      âœ… Added column: is_active (BOOLEAN)
      âœ… Added column: density (FLOAT)
      âŒ Failed to add column type: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "inventory_item" ADD COLUMN "type" VARCHAR(32) NULL DEFAULT ingredient]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: storage_amount (FLOAT)
      âœ… Added column: intermediate (BOOLEAN)
      âœ… Added column: storage_unit (VARCHAR(32))
      âœ… Added column: created_by (INTEGER)
   ğŸ“‹ Table 'unit' missing columns: is_custom, is_mapped, is_active, created_at, type, base_unit, created_by
      âœ… Added column: is_custom (BOOLEAN)
      âœ… Added column: is_mapped (BOOLEAN)
      âœ… Added column: is_active (BOOLEAN)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: type (VARCHAR(32))
      âœ… Added column: base_unit (VARCHAR(64))
      âœ… Added column: created_by (INTEGER)
   ğŸ“‹ Table 'custom_unit_mapping' missing columns: created_by
      âœ… Added column: created_by (INTEGER)
   ğŸ“‹ Table 'reservation' missing columns: source, source_batch_id, sale_price, order_id, unit_cost, converted_at, source_fifo_id, customer, status, product_item_id, reservation_id, reserved_item_id, released_at, created_by
      âŒ Failed to add column source: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "reservation" ADD COLUMN "source" VARCHAR(64) NULL DEFAULT shopify]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: source_batch_id (INTEGER)
      âœ… Added column: sale_price (FLOAT)
      âœ… Added column: order_id (VARCHAR(128))
      âœ… Added column: unit_cost (FLOAT)
      âœ… Added column: converted_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: source_fifo_id (INTEGER)
      âœ… Added column: customer (VARCHAR(128))
      âŒ Failed to add column status: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "reservation" ADD COLUMN "status" VARCHAR(32) NULL DEFAULT active]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: product_item_id (INTEGER)
      âœ… Added column: reservation_id (VARCHAR(128))
      âœ… Added column: reserved_item_id (INTEGER)
      âœ… Added column: released_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: created_by (INTEGER)
   ğŸ“‹ Table 'permission' missing columns: created_at, category, is_active
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: category (VARCHAR(64))
      âœ… Added column: is_active (BOOLEAN)
   âš ï¸  No model found for table: developer_role_permission
   ğŸ“‹ Table 'developer_permission' missing columns: created_at, category, is_active
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: category (VARCHAR(64))
      âœ… Added column: is_active (BOOLEAN)
   ğŸ“‹ Table 'batch_timer' missing columns: name, organization_id, status, duration_seconds, created_by
      âœ… Added column: name (VARCHAR(128))
      âœ… Added column: organization_id (INTEGER)
      âŒ Failed to add column status: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "batch_timer" ADD COLUMN "status" VARCHAR(32) NULL DEFAULT active]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: duration_seconds (INTEGER)
      âœ… Added column: created_by (INTEGER)
   ğŸ“‹ Table 'user' missing columns: deleted_by, timezone, is_deleted, deleted_at, last_login
      âœ… Added column: deleted_by (INTEGER)
      âŒ Failed to add column timezone: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "user" ADD COLUMN "timezone" VARCHAR(64) NULL DEFAULT UTC]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: is_deleted (BOOLEAN)
      âœ… Added column: deleted_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: last_login (TIMESTAMP WITHOUT TIME ZONE)
   ğŸ“‹ Table 'conversion_log' missing columns: ingredient_name, result, conversion_type, amount
      âœ… Added column: ingredient_name (VARCHAR(128))
      âœ… Added column: result (FLOAT)
      âœ… Added column: conversion_type (VARCHAR(64))
      âœ… Added column: amount (FLOAT)
   ğŸ“‹ Table 'product_sku_history' missing columns: organization_id
      âœ… Added column: organization_id (INTEGER)
   ğŸ“‹ Table 'organization' missing columns: promo_code, referral_code, signup_source
      âœ… Added column: promo_code (VARCHAR(32))
      âœ… Added column: referral_code (VARCHAR(32))
      âœ… Added column: signup_source (VARCHAR(64))
   âœ… Table 'user_role_assignment' schema is up to date
   ğŸ“‹ Table 'extra_batch_container' missing columns: reason, fill_unit, quantity_used, container_quantity, container_id, organization_id, cost_each, fill_quantity
      âŒ Failed to add column reason: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "extra_batch_container" ADD COLUMN "reason" VARCHAR(20) NULL DEFAULT extra_yield]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: fill_unit (VARCHAR(32))
      âœ… Added column: quantity_used (INTEGER)
      âœ… Added column: container_quantity (INTEGER)
      âœ… Added column: container_id (INTEGER)
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: cost_each (FLOAT)
      âœ… Added column: fill_quantity (FLOAT)
   ğŸ“‹ Table 'recipe' missing columns: predicted_yield_unit, is_locked, predicted_yield, allowed_containers, parent_id, qr_image, label_prefix
      âŒ Failed to add column predicted_yield_unit: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "recipe" ADD COLUMN "predicted_yield_unit" VARCHAR(50) NULL DEFAULT oz]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: is_locked (BOOLEAN)
      âœ… Added column: predicted_yield (FLOAT)
      âœ… Added column: allowed_containers (BYTEA)
      âœ… Added column: parent_id (INTEGER)
      âœ… Added column: qr_image (VARCHAR(128))
      âœ… Added column: label_prefix (VARCHAR(8))
   âœ… Table 'batch' schema is up to date
   âœ… Table 'billing_snapshots' schema is up to date
   ğŸ“‹ Table 'batch_inventory_log' missing columns: action, new_stock, quantity_change, old_stock, organization_id
      âœ… Added column: action (VARCHAR(32))
      âœ… Added column: new_stock (FLOAT)
      âœ… Added column: quantity_change (FLOAT)
      âœ… Added column: old_stock (FLOAT)
      âœ… Added column: organization_id (INTEGER)
   ğŸ“‹ Table 'batch_ingredient' missing columns: organization_id
      âœ… Added column: organization_id (INTEGER)
   ğŸ“‹ Table 'organization_stats' missing columns: total_inventory_value, failed_batches, total_products, active_users, total_products_made, created_at, last_updated, cancelled_batches, completed_batches
      âœ… Added column: total_inventory_value (FLOAT)
      âœ… Added column: failed_batches (INTEGER)
      âœ… Added column: total_products (INTEGER)
      âœ… Added column: active_users (INTEGER)
      âœ… Added column: total_products_made (FLOAT)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: last_updated (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: cancelled_batches (INTEGER)
      âœ… Added column: completed_batches (INTEGER)
   ğŸ“‹ Table 'developer_role' missing columns: created_at, category, is_active
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âŒ Failed to add column category: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "developer_role" ADD COLUMN "category" VARCHAR(32) NULL DEFAULT developer]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: is_active (BOOLEAN)
   ğŸ“‹ Table 'recipe_ingredient' missing columns: order_position, organization_id
      âœ… Added column: order_position (INTEGER)
      âœ… Added column: organization_id (INTEGER)
   ğŸ“‹ Table 'batch_container' missing columns: fill_unit, quantity_used, container_quantity, container_id, organization_id, cost_each, fill_quantity
      âœ… Added column: fill_unit (VARCHAR(32))
      âœ… Added column: quantity_used (INTEGER)
      âœ… Added column: container_quantity (INTEGER)
      âœ… Added column: container_id (INTEGER)
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: cost_each (FLOAT)
      âœ… Added column: fill_quantity (FLOAT)
   ğŸ“‹ Table 'extra_batch_ingredient' missing columns: organization_id
      âœ… Added column: organization_id (INTEGER)
   âœ… Table 'product_sku' schema is up to date
   âš ï¸  No model found for table: alembic_version
   âš ï¸  No model found for table: billing_snapshot
   âš ï¸  No model found for table: pricing_snapshot
   ğŸ“‹ Table 'subscription_tier' missing columns: is_customer_facing, trial_start, is_available, last_synced, fallback_price_monthly, cancel_at_period_end, stripe_lookup_key, requires_stripe_billing, stripe_price_monthly, trial_end, stripe_price_yearly, status, current_period_start, fallback_price_yearly, stripe_subscription_id, stripe_customer_id, current_period_end, user_limit, next_billing_date
      âœ… Added column: is_customer_facing (BOOLEAN)
      âœ… Added column: trial_start (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: is_available (BOOLEAN)
      âœ… Added column: last_synced (TIMESTAMP WITHOUT TIME ZONE)
      âŒ Failed to add column fallback_price_monthly: (psycopg2.errors.UndefinedParameter) there is no parameter $0

[SQL: ALTER TABLE "subscription_tier" ADD COLUMN "fallback_price_monthly" VARCHAR(32) NULL DEFAULT $0]
(Background on this error at: https://sqlalche.me/e/20/f405)
      âœ… Added column: cancel_at_period_end (BOOLEAN)
      âœ… Added column: stripe_lookup_key (VARCHAR(128))
      âœ… Added column: requires_stripe_billing (BOOLEAN)
      âœ… Added column: stripe_price_monthly (VARCHAR(32))
      âœ… Added column: trial_end (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: stripe_price_yearly (VARCHAR(32))
      âŒ Failed to add column status: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "subscription_tier" ADD COLUMN "status" VARCHAR(32) NULL DEFAULT inactive]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: current_period_start (TIMESTAMP WITHOUT TIME ZONE)
      âŒ Failed to add column fallback_price_yearly: (psycopg2.errors.UndefinedParameter) there is no parameter $0

[SQL: ALTER TABLE "subscription_tier" ADD COLUMN "fallback_price_yearly" VARCHAR(32) NULL DEFAULT $0]
(Background on this error at: https://sqlalche.me/e/20/f405)
      âœ… Added column: stripe_subscription_id (VARCHAR(128))
      âœ… Added column: stripe_customer_id (VARCHAR(128))
      âœ… Added column: current_period_end (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: user_limit (INTEGER)
      âœ… Added column: next_billing_date (TIMESTAMP WITHOUT TIME ZONE)
   âš ï¸  No model found for table: subscription_tier_permission
   ğŸ“‹ Table 'tag' missing columns: is_active, created_at, created_by, description
      âœ… Added column: is_active (BOOLEAN)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: created_by (INTEGER)
      âœ… Added column: description (TEXT)
   ğŸ“‹ Table 'user_preferences' missing columns: show_batch_alerts, show_timer_alerts, show_alert_badges, show_expiration_alerts, organization_id, show_quick_actions, compact_view, max_dashboard_alerts, show_low_stock_alerts, show_fault_alerts, created_at, updated_at
      âœ… Added column: show_batch_alerts (BOOLEAN)
      âœ… Added column: show_timer_alerts (BOOLEAN)
      âœ… Added column: show_alert_badges (BOOLEAN)
      âœ… Added column: show_expiration_alerts (BOOLEAN)
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: show_quick_actions (BOOLEAN)
      âœ… Added column: compact_view (BOOLEAN)
      âœ… Added column: max_dashboard_alerts (INTEGER)
      âœ… Added column: show_low_stock_alerts (BOOLEAN)
      âœ… Added column: show_fault_alerts (BOOLEAN)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: updated_at (TIMESTAMP WITHOUT TIME ZONE)
   ğŸ“‹ Table 'product' missing columns: etsy_shop_section_id, low_stock_threshold, is_discontinued, subcategory, created_by, base_unit, shopify_product_id
      âœ… Added column: etsy_shop_section_id (VARCHAR(64))
      âœ… Added column: low_stock_threshold (FLOAT)
      âœ… Added column: is_discontinued (BOOLEAN)
      âœ… Added column: subcategory (VARCHAR(64))
      âœ… Added column: created_by (INTEGER)
      âŒ Failed to add column base_unit: (psycopg2.errors.FeatureNotSupported) cannot use column reference in DEFAULT expression

[SQL: ALTER TABLE "product" ADD COLUMN "base_unit" VARCHAR(32) NULL DEFAULT g]
(Background on this error at: https://sqlalche.me/e/20/tw8g)
      âœ… Added column: shopify_product_id (VARCHAR(64))
   ğŸ“‹ Table 'user_stats' missing columns: failed_batches, products_created, total_recipes, inventory_adjustments, total_products_made, organization_id, created_at, last_updated, cancelled_batches, inventory_items_created, recipes_created, total_batches, completed_batches
      âœ… Added column: failed_batches (INTEGER)
      âœ… Added column: products_created (INTEGER)
      âœ… Added column: total_recipes (INTEGER)
      âœ… Added column: inventory_adjustments (INTEGER)
      âœ… Added column: total_products_made (FLOAT)
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: last_updated (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: cancelled_batches (INTEGER)
      âœ… Added column: inventory_items_created (INTEGER)
      âœ… Added column: recipes_created (INTEGER)
      âœ… Added column: total_batches (INTEGER)
      âœ… Added column: completed_batches (INTEGER)
   âš ï¸  No model found for table: role_permission
   ğŸ“‹ Table 'product_variant' missing columns: scent, material, organization_id, created_by, color
      âœ… Added column: scent (VARCHAR(64))
      âœ… Added column: material (VARCHAR(64))
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: created_by (INTEGER)
      âœ… Added column: color (VARCHAR(32))
   ğŸ“‹ Table 'inventory_history' missing columns: note, expiration_date, is_perishable, shelf_life_days, fifo_reference_id, quantity_used, unit_cost, organization_id, remaining_quantity, used_for_batch_id, created_by, fifo_code
      âœ… Added column: note (TEXT)
      âœ… Added column: expiration_date (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: is_perishable (BOOLEAN)
      âœ… Added column: shelf_life_days (INTEGER)
      âœ… Added column: fifo_reference_id (INTEGER)
      âœ… Added column: quantity_used (FLOAT)
      âœ… Added column: unit_cost (FLOAT)
      âœ… Added column: organization_id (INTEGER)
      âœ… Added column: remaining_quantity (FLOAT)
      âœ… Added column: used_for_batch_id (INTEGER)
      âœ… Added column: created_by (INTEGER)
      âœ… Added column: fifo_code (VARCHAR(32))
   ğŸ“‹ Table 'ingredient_category' missing columns: description, is_active, created_at, default_density, created_by, color
      âœ… Added column: description (TEXT)
      âœ… Added column: is_active (BOOLEAN)
      âœ… Added column: created_at (TIMESTAMP WITHOUT TIME ZONE)
      âœ… Added column: default_density (FLOAT)
      âœ… Added column: created_by (INTEGER)
      âŒ Failed to add column color: (psycopg2.errors.SyntaxError) trailing junk after numeric literal at or near "6c757d"
LINE 1: ...category" ADD COLUMN "color" VARCHAR(7) NULL DEFAULT #6c757d
                                                                 ^

[SQL: ALTER TABLE "ingredient_category" ADD COLUMN "color" VARCHAR(7) NULL DEFAULT #6c757d]
(Background on this error at: https://sqlalche.me/e/20/f405)
   ğŸ“‹ Table 'role' missing columns: created_by, is_active
      âœ… Added column: created_by (INTEGER)
      âœ… Added column: is_active (BOOLEAN)
   âœ… Table 'pricing_snapshots' schema is up to date
ğŸ“Š Total tables: 40
ğŸ“Š Total columns added: 166
âœ… Database schema safely synced to match models!
ğŸ”„ Note: This only adds missing tables/columns - existing data is preserved
âš ï¸  New columns are added as nullable for safety
render@srv-d21alungi27c73dn1440-6c4f66c7d-pkql4:~/project/src$ 