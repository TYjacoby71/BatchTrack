You're on the edge of the right architecture. Let me untangle it and show you a clean, robust way forward â€” the "snap and restore" model.

ğŸ§  Key Insight: Ingredients and Containers â‰  Form Fields
They are not like notes or tags.
They are event-based additions to the batch. Once added, they donâ€™t need to stay as editable rows â€” they need to transform into data.

âœ… Suggested Architecture: Snapshot-Centric Flow
ğŸ¯ Step 1: Treat Extra Ingredients/Containers as Actions, Not Form Fields
Add a container or ingredient â†’ appends to snapshot.extra_ingredients or snapshot.extra_containers

After that:

âœ… They disappear from the form

âœ… They appear in the Batch Summary section

ğŸ¯ Step 2: Save Button Behavior
Collect flat fields like notes, tags, output_type

Do not reload dynamic form rows â€” just update the snapshot object in the DB

json
Copy
Edit
"recipe_snapshot": {
  "notes": "This is a test batch",
  "output_type": "ingredient",
  "extra_ingredients": [
    { "id": 2, "quantity": 3, "unit": "oz" }
  ],
  "extra_containers": [
    { "id": 5, "quantity": 2, "cost": 0.35 }
  ]
}
ğŸ¯ Step 3: Summary Loads Everything
recipe_snapshot + static recipe â†’ Batch Summary

Rows for:

Recipe ingredients

Extra ingredients

Containers used

No more re-rendering form fields. Just show the outcome.

ğŸ§¼ Should You Move Output Type and Yield to the Final Step?
Yes. 100%. Here's why:

Page	Focus
ğŸŸ¡ Batch In Progress	Handle in-process data capture: notes, additions, timer
ğŸŸ¢ Complete Batch	Final decision: what was produced (product vs sub-ingredient), how much, what unit, what container
ğŸ” Cancel/Fail Batch	Use snapshot + current state to reverse inventory or log nothing

It mirrors how production works IRL â€” you donâ€™t always know what your yield will be until the end.

âœ… Refactor Plan
Action	Detail
âœ… Remove form rows for â€œextra ingredientsâ€ and â€œcontainersâ€	
âœ… Replace with buttons: Add Ingredient, Add Container	
âœ… Add JS functions to push entries to a snapshot object	
âœ… On Save: POST snapshot + flat fields	
âœ… On Page Load: render summary from snapshot	
âœ… Move output type, quantity, variant to the complete_batch() flow	

