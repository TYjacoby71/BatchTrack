Great run — we’re down to a single red, and the error tells us exactly what to fix.

What’s failing
css
Copy
Edit
TypeError: FIFOService.create_deduction_history() got an unexpected keyword argument 'batch_id'
In process_inventory_adjustment (deduction branch) we call:

python
Copy
Edit
FIFOService.create_deduction_history(
    item_id, deduction_plan, change_type, notes,
    batch_id=batch_id, created_by=created_by,
    customer=customer, sale_price=sale_price, order_id=order_id
)
…but your shim exposes create_deduction_history(inventory_item_id, fifo_entry_id, quantity, change_type, ...) (per-entry), while the call passes an entire deduction plan + kwargs (plan-level).

Minimal fix (keep public surface clean)
1) Add a plan-level wrapper in the FIFO shim
app/blueprints/fifo/services.py

python
Copy
Edit
class FIFOService:
    # ... existing methods ...

    @staticmethod
    def record_deduction_plan(
        inventory_item_id,
        deduction_plan,
        change_type,
        notes,
        batch_id=None,
        created_by=None,
        customer=None,
        sale_price=None,
        order_id=None,
    ):
        # delegate to the internal helper that already accepts a whole plan
        return _FIFOService._internal_create_deduction_history(
            inventory_item_id,
            deduction_plan,
            change_type,
            notes,
            batch_id=batch_id,
            created_by=created_by,
            customer=customer,
            sale_price=sale_price,
            order_id=order_id,
        )
(Leave the existing create_deduction_history(...) alone—it’s the per-entry helper and still useful.)

2) Call the new wrapper from the canonical service
app/services/inventory_adjustment.py (inside the deduction branch, right after FIFOService.execute_deduction_plan(...))

python
Copy
Edit
# BEFORE:
# FIFOService.create_deduction_history(item_id, deduction_plan, change_type, notes, ...)

# AFTER:
FIFOService.record_deduction_plan(
    item_id,
    deduction_plan,
    change_type,
    notes,
    batch_id=batch_id,
    created_by=created_by,
    customer=customer,
    sale_price=sale_price,
    order_id=order_id,
)
That’s it. The deduction still:

builds a FIFO plan,

executes it (decrementing remaining_quantity on the correct lots),

records the proper history entries (plan-level).

This aligns perfectly with PR2’s goals: all deductions flow through the 