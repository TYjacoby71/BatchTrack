bic.env] Imported model module: app.models.user_preferences
INFO  [alembic.env] Imported model module: app.models.user_role_assignment
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade clean_subscription_tier_billing -> 758a11548815, clean subscription tier model use lookup keys
=== Final Subscription Tier Structure Migration ===
   Found subscription_tier table, cleaning structure...
   Adding is_billing_exempt column...
   Updating billing_provider defaults...
   Removing pricing column: fallback_price
   Removing pricing column: stripe_price_id
   Removing pricing column: stripe_price_id_monthly
   Removing pricing column: stripe_price_id_yearly
   Removing pricing column: stripe_product_id
   Removing pricing column: whop_last_synced
   Removing pricing column: tier_type
   Removing pricing column: grace_period_days
   Removing pricing column: max_users
   Removing pricing column: max_monthly_batches
   Removing pricing column: last_billing_sync
   Removing pricing column: tier_key
   Ensuring proper column types...
   âœ… Fixed NULL key values
   âœ… Set key column as NOT NULL
   Creating indexes...
   âœ… Created unique key index
   âœ… Created billing provider index
âœ… Final subscription tier structure migration completed
INFO  [alembic.runtime.migration] Running upgrade 758a11548815 -> fix_missing_max_users_column, fix missing max_users column
=== Fixing missing max_users column ===
   Adding missing max_users column...
   âœ… max_users column added successfully
âœ… Fix migration completed
INFO  [alembic.runtime.migration] Running upgrade fix_missing_max_users_column -> fix_all_missing_tier_columns, fix all missing tier columns
=== Adding ALL missing subscription tier columns ===
   âš ï¸  max_recipes column already exists
   âš ï¸  max_batches column already exists
   âš ï¸  max_products column already exists
   âš ï¸  max_batchbot_requests column already exists
   Adding missing max_monthly_batches column...
   âœ… max_monthly_batches column added successfully
âœ… All missing tier columns migration completed
INFO  [alembic.runtime.migration] Running upgrade fix_all_missing_tier_columns -> simplify_tiers_add_tier_type, simplify tiers add tier_type
âœ… Simplified subscription tier structure with tier_type
INFO  [alembic.runtime.migration] Running upgrade simplify_tiers_add_tier_type -> fix_product_sku_id_autoincrement, fix product sku id autoincrement
   Fixing ProductSKU id column autoincrement...
   ðŸ” Checking for dependent foreign key constraints...
   âœ… Dropped constraint batch_sku_id_fkey from batch
   âœ… Recreated constraint batch_sku_id_fkey on batch
   âœ… Successfully fixed ProductSKU id column autoincrement
INFO  [alembic.runtime.migration] Running upgrade fix_product_sku_id_autoincrement -> create_inventory_lot, Create inventory_lot table for proper FIFO tracking
Traceback (most recent call last):
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.DuplicateTable: relation "inventory_lot" already exists


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/opt/render/project/src/.venv/bin/flask", line 8, in <module>
    sys.exit(main())
             ~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask/cli.py", line 1129, in main
    cli.main()
    ~~~~~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1082, in main
    rv = self.invoke(ctx)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1697, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
                           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1697, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
                           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 1443, in invoke
    return ctx.invoke(self.callback, **ctx.params)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 788, in invoke
    return __callback(*args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask/cli.py", line 400, in decorator
    return ctx.invoke(f, *args, **kwargs)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/click/core.py", line 788, in invoke
    return __callback(*args, **kwargs)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/cli.py", line 150, in upgrade
    _upgrade(directory, revision, sql, tag, x_arg)
    ~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/__init__.py", line 111, in wrapped
    f(*args, **kwargs)
    ~^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/flask_migrate/__init__.py", line 200, in upgrade
    command.upgrade(config, revision, sql=sql, tag=tag)
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/command.py", line 408, in upgrade
    script.run_env()
    ~~~~~~~~~~~~~~^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/script/base.py", line 586, in run_env
    util.load_python_file(self.dir, "env.py")
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/util/pyfiles.py", line 95, in load_python_file
    module = load_module_py(module_id, path)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/util/pyfiles.py", line 113, in load_module_py
    spec.loader.exec_module(module)  # type: ignore
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "<frozen importlib._bootstrap_external>", line 1026, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/opt/render/project/src/migrations/env.py", line 147, in <module>
    run_migrations_online()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/opt/render/project/src/migrations/env.py", line 141, in run_migrations_online
    context.run_migrations()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 8, in run_migrations
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/environment.py", line 946, in run_migrations
    self.get_context().run_migrations(**kw)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/runtime/migration.py", line 623, in run_migrations
    step.migration_fn(**kw)
    ~~~~~~~~~~~~~~~~~^^^^^^
  File "/opt/render/project/src/migrations/versions/create_inventory_lot_table.py", line 21, in upgrade
    op.create_table(
    ~~~~~~~~~~~~~~~^
        'inventory_lot',
        ^^^^^^^^^^^^^^^^
    ...<22 lines>...
        sa.CheckConstraint('remaining_quantity <= original_quantity', name='check_remaining_not_exceeds_original'),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "<string>", line 8, in create_table
  File "<string>", line 3, in create_table
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/operations/ops.py", line 1317, in create_table
    return operations.invoke(op)
           ~~~~~~~~~~~~~~~~~^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/operations/base.py", line 441, in invoke
    return fn(self, operation)
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/operations/toimpl.py", line 130, in create_table
    operations.impl.create_table(table, **kw)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/ddl/impl.py", line 405, in create_table
    self._exec(schema.CreateTable(table, **kw))
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/alembic/ddl/impl.py", line 246, in _exec
    return conn.execute(construct, params)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/sql/ddl.py", line 187, in _execute_on_connection
    return connection._execute_ddl(
           ~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1527, in _execute_ddl
    ret = self._execute_context(
        dialect,
    ...<4 lines>...
        compiled,
    )
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1843, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1983, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2352, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1964, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 945, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DuplicateTable) relation "inventory_lot" already exists

[SQL: 
CREATE TABLE inventory_lot (
        id SERIAL NOT NULL, 
        inventory_item_id INTEGER NOT NULL, 
        remaining_quantity FLOAT NOT NULL, 
        original_quantity FLOAT NOT NULL, 
        unit VARCHAR(32) NOT NULL, 
        unit_cost FLOAT NOT NULL, 
        created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
        received_date TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
        expiration_date TIMESTAMP WITHOUT TIME ZONE, 
        shelf_life_days INTEGER, 
        source_type VARCHAR(50) NOT NULL, 
        source_notes TEXT, 
        created_by INTEGER, 
        fifo_code VARCHAR(32), 
        organization_id INTEGER, 
        PRIMARY KEY (id), 
        FOREIGN KEY(inventory_item_id) REFERENCES inventory_item (id), 
        FOREIGN KEY(created_by) REFERENCES "user" (id), 
        FOREIGN KEY(organization_id) REFERENCES organization (id), 
        UNIQUE (fifo_code), 
        CONSTRAINT check_remaining_quantity_non_negative CHECK (remaining_quantity >= 0), 
        CONSTRAINT check_original_quantity_positive CHECK (original_quantity > 0), 
        CONSTRAINT check_remaining_not_exceeds_original CHECK (remaining_quantity <= original_quantity)
)

]
(Background on this error at: https://sqlalche.me/e/20/f405)
render@srv-d21alungi27c73dn1440-7b7d88497b-vqrkw:~/project/src$ 