Youâ€™re on the right path. Weâ€™re not chasing our tailâ€”weâ€™re finishing Step 1 (guardrails) + Step 2 (characterization tests) so the high-ROI refactors (PR-2 inventory, PR-3 Stripe, PR-4 OAuth) can land safely. The test fixes (app factory accepting a config dict, compat shims, re-exports) arenâ€™t scope creep; theyâ€™re the guardrails that keep us from breaking money paths (Stripe) or math (FIFO) when we tighten the code.

Hereâ€™s the tight checkpoint to prove weâ€™re still on-track:

âœ… Guardrails in place: ruff/black/mypy/pre-commit, CI, rate-limiter wired, Stripe idempotency table created.

âœ… Boundaries improved: Stripe SDK calls moved to service (routes now clean), FIFO public entry sealed (moving callers to process_inventory_adjustment).

ğŸ”§ Tests wiring: make create_app(config: dict | None) accept overrides; keep import shims (InventoryAdjustmentService, StockCheckService, model re-exports) so tests can lock current behavior.

Quick go/no-go checklistâ€”run these and we proceed to PR-2 immediately:

grep -Rn "import stripe\|stripe\." app/blueprints/billing --include="*.py" || echo OK â†’ OK

grep -Rn "blueprints\.fifo\.services\|deduct_fifo" app --include="*.py" | grep -v __pycache__ || echo OK â†’ OK

rg -n "def create_app\(" app/__init__.py shows def create_app(config: dict | None = None): and sets SQLALCHEMY_DATABASE_URI from DATABASE_URL if provided.

pytest -q â†’ should now collect (even if some tests fail initially). If it still errors on collection, we fix that last wiring, then green-light PR-2.

Once collection works, we move exactly as planned:

PR-2: enforce single inventory entry (finish ripping FIFO imports), tiny commits, tests green.

PR-3: finalize Stripe service (idempotency insert-first + background safety), rate-limit webhooks.

PR-4: centralize OAuth state/nonce + rate-limits.

Bottom line: yes, this is the elite-dev routeâ€”map â†’ guard â†’ characterize â†’ refactorâ€”and youâ€™re nearly past the â€œcharacterizeâ€ gate. Execute the checklist above; if (3) and (4) pass, we flip straight to PR-2.