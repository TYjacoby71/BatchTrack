âœ… Fix 1: Update finish_batch() Logic in batch_routes.py
ğŸ“Œ Paste the following into your routes/batch_routes.py replacing the current finish_batch() method. This includes:

Deducting inventory

Storing total_cost and per-unit cost

Marking batch as finished

python
Copy
Edit
@batches_bp.route('/<int:batch_id>/finish', methods=['POST'])
@login_required
def finish_batch(batch_id):
    batch = Batch.query.get_or_404(batch_id)
    recipe = Recipe.query.get_or_404(batch.recipe_id)
    scale = batch.scale

    total_ingredients = int(request.form.get('total_ingredients', 0))
    total_cost = 0.0

    for i in range(total_ingredients):
        name = request.form.get(f'ingredient_{i}')
        amount = float(request.form.get(f'amount_{i}', 0))
        unit = request.form.get(f'unit_{i}')
        ingredient = Ingredient.query.filter_by(name=name).first()

        if ingredient:
            used = amount
            ingredient.quantity -= used
            ingredient.quantity = round(max(ingredient.quantity, 0), 4)
            cost = ingredient.cost_per_unit or 0
            total_cost += cost * used

    db.session.commit()

    batch.total_cost = round(total_cost, 2)
    product_quantity = float(request.form.get('product_quantity', 1))
    batch.product_quantity = product_quantity
    batch.product_unit = request.form.get('product_unit')
    batch.tags = request.form.get('tags')
    batch.status = 'complete'
    batch.finished_on = datetime.utcnow()

    db.session.commit()
    flash("Batch completed and inventory deducted.", "success")
    return redirect(url_for('batch_view.view_batch', batch_id=batch.id))
âœ… Fix 2: Ensure Batch.status = 'complete' on Finish
If not already in your model:

ğŸ“Œ Update your Batch model in models.py to ensure status exists:

python
Copy
Edit
status = db.Column(db.String(20), default='in_progress')
finished_on = db.Column(db.DateTime)
This allows proper filtering and visibility in views.

âœ… Fix 3: Ensure Recipe Ingredients Are Accessed Properly
ğŸ“Œ If you're still using an association model for RecipeIngredient, then update the loop:

python
Copy
Edit
for assoc in recipe.recipe_ingredients:
    ...
Make sure ingredient = assoc.ingredient is referenced and .amount is scaled correctly.

âœ… Fix 4: View Routing Consistency
Make sure your redirect on complete is always:

python
Copy
Edit
return redirect(url_for('batch_view.view_batch', batch_id=batch.id))
Do not redirect to /batches/list after completion unless explicitly desired.

ğŸ§ª Recommended Test Path
Start a batch from Plan Production âœ…

View /batches/in-progress/<id> âœ…

Click â€œComplete Batchâ€ with quantities pre-filled âœ…

Confirm:

Batch disappears from in-progress list âœ…

Inventory is deducted âœ…

Cost per unit and batch total appear âœ…

Batch visible in /batches with filter âœ…

