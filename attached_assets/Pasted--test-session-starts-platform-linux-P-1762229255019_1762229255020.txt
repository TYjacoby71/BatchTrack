============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.3.5, pluggy-1.5.0 -- /home/runner/workspace/.pythonlibs/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/workspace
collected 4 items                                                              

tests/test_timezone_conventions.py::test_no_naive_datetime_usage PASSED  [ 25%]
tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment PASSED [ 50%]
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service FAILED [ 75%]
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_product_expired_calls_canonical_service PASSED [100%]

=================================== FAILURES ===================================
_ TestExpirationCanonicalService.test_mark_fifo_expired_calls_canonical_service _

self = <tests.test_expiration_canonicalization.TestExpirationCanonicalService object at 0x7fbb3d40c710>
mock_user = <AsyncMock name='current_user' id='140442046020240'>
mock_history = <MagicMock name='InventoryHistory' id='140442041117136'>
mock_process = <MagicMock name='process_inventory_adjustment' id='140442046114640'>

    @patch('app.blueprints.expiration.services.process_inventory_adjustment')
    @patch('app.blueprints.expiration.services.InventoryHistory')
    @patch('app.blueprints.expiration.services.current_user')
    def test_mark_fifo_expired_calls_canonical_service(self, mock_user, mock_history, mock_process):
        """Test that marking FIFO entry as expired calls process_inventory_adjustment"""
        from app import create_app
    
        app = create_app({'TESTING': True})
        with app.app_context():
            # Mock the FIFO entry
            mock_fifo_entry = MagicMock()
            mock_fifo_entry.id = 123
            mock_fifo_entry.inventory_item_id = 456
            mock_fifo_entry.remaining_quantity = 10.0
            mock_fifo_entry.unit = 'g'
    
            mock_history.query.get.return_value = mock_fifo_entry
            mock_user.id = 1
            mock_user.is_authenticated = True
            mock_process.return_value = True
    
            # Call the service
            success, message = ExpirationService.mark_as_expired('fifo', 123, quantity=5.0, notes="Test expiration")
    
            # Verify canonical service was called
>           mock_process.assert_called_once_with(
                item_id=456,
                quantity=-5.0,
                change_type="spoil",
                unit='g',
                notes="Expired lot disposal #123: Test expiration",
                created_by=1
            )

tests/test_expiration_canonicalization.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/unittest/mock.py:951: in assert_called_once_with
    return self.assert_called_with(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='process_inventory_adjustment' id='140442046114640'>
args = ()
kwargs = {'change_type': 'spoil', 'created_by': 1, 'item_id': 456, 'notes': 'Expired lot disposal #123: Test expiration', ...}
expected = call(item_id=456, quantity=-5.0, change_type='spoil', unit='g', notes='Expired lot disposal #123: Test expiration', created_by=1)
actual = call(item_id=38, quantity=-5.0, change_type='spoil', unit='count', notes='Expired lot disposal #123: Test expiration', created_by=1)
_error_message = <function NonCallableMock.assert_called_with.<locals>._error_message at 0x7fbb3519b1a0>
cause = None

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\n  Actual: %s'
                    % (expected, actual))
            raise AssertionError(error_message)
    
        def _error_message():
            msg = self._format_mock_failure_message(args, kwargs)
            return msg
        expected = self._call_matcher(_Call((args, kwargs), two=True))
        actual = self._call_matcher(self.call_args)
        if actual != expected:
            cause = expected if isinstance(expected, Exception) else None
>           raise AssertionError(_error_message()) from cause
E           AssertionError: expected call not found.
E           Expected: process_inventory_adjustment(item_id=456, quantity=-5.0, change_type='spoil', unit='g', notes='Expired lot disposal #123: Test expiration', created_by=1)
E             Actual: process_inventory_adjustment(item_id=38, quantity=-5.0, change_type='spoil', unit='count', notes='Expired lot disposal #123: Test expiration', created_by=1)

/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/unittest/mock.py:939: AssertionError
----------------------------- Captured stdout call -----------------------------

=== Blueprint Registration Summary ===
âœ… Successful: 29
   - Authentication
   - Admin
   - Developer
   - Inventory
   - Recipes
   - Batches
   - Organization
   - Billing
   - Settings
   - Timers
   - Expiration
   - Conversion
   - Products Main
   - Public API
   - Main API
   - Drawer Actions
   - Density Reference
   - Retention Drawer API
   - Global Link Drawer API
   - App Routes
   - Legal Routes
   - Bulk Stock
   - Fault Log
   - Tag Manager
   - Global Library Public
   - Waitlist
   - Public Tools
   - Production Planning
   - Exports

ðŸŽ‰ All blueprints registered successfully!
=============================== warnings summary ===============================
tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_product_expired_calls_canonical_service
  /home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
    warnings.warn(

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service
  /home/runner/workspace/app/blueprints/expiration/services.py:510: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    lot = InventoryLot.query.get(entry_id)

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service
  /home/runner/workspace/app/blueprints/expiration/services.py:518: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    entry = UnifiedInventoryHistory.query.get(entry_id)

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
  /home/runner/workspace/app/blueprints/expiration/services.py:523: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    entry = InventoryHistory.query.get(entry_id)

tests/test_expiration_canonicalization.py::test_expiration_service_uses_canonical_adjustment
  /home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_sqlalchemy/extension.py:881: SAWarning: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: batch, product_sku; and backend does not support ALTER.  To restore at least a partial sort, apply use_alter=True to ForeignKey and ForeignKeyConstraint objects involved in the cycle to mark these as known cycles that will be ignored.
    getattr(metadata, op_name)(bind=engine)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_expiration_canonicalization.py::TestExpirationCanonicalService::test_mark_fifo_expired_calls_canonical_service - AssertionError: expected call not found.
=================== 1 failed, 3 passed, 9 warnings in 9.08s ====================
