render@srv-d21alungi27c73dn1440-d8bdfdb79-xkrgl:~/project/src$ flask db upgrade
DEBUG: Billing blueprint imported successfully: <Blueprint 'billing'>
DEBUG: Billing blueprint name: billing
DEBUG: Billing blueprint url_prefix: /billing
DEBUG: Billing blueprint registered successfully
Registered API routes: ['/api/reservations/create', '/api/reservations/release/<int:reservation_id>', '/api/reservations/convert-to-sale/<int:reservation_id>', '/api/reservations/expire-old', '/api/products/<int:product_id>/variants', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/server-time', '/api/server-time', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/check-stock', '/api/categories', '/api/ingredient/<int:id>/density', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/api/api/fifo-details/<int:inventory_id>', '/api/api/batch-inventory-summary/<int:batch_id>', '/api/api/reservations/create', '/api/api/reservations/release/<int:reservation_id>', '/api/api/reservations/convert-to-sale/<int:reservation_id>', '/api/api/reservations/expire-old', '/api/dashboard-alerts', '/api/dismiss-alert', '/api/units', '/api/convert-units']
Container routes found: ['/settings/bulk-update-containers', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/debug-containers', '/available-containers/<int:recipe_id>', '/containers/available', '/batches/<int:batch_id>/containers', '/batches/<int:batch_id>/containers/<int:container_id>', '/batches/<int:batch_id>/containers/<int:container_id>/adjust']
Billing routes found: ['/billing/reconciliation-needed', '/billing/reconcile-to-free', '/billing/upgrade', '/billing/checkout/<tier>/<billing_cycle>', '/billing/checkout/<tier>', '/billing/customer-portal', '/billing/cancel-subscription', '/billing/webhooks/stripe', '/billing/complete-signup-from-stripe', '/billing/debug']
Billing endpoints: [('/billing/reconciliation-needed', 'billing.reconciliation_needed'), ('/billing/reconcile-to-free', 'billing.reconcile_to_free'), ('/billing/upgrade', 'billing.upgrade'), ('/billing/checkout/<tier>/<billing_cycle>', 'billing.checkout'), ('/billing/checkout/<tier>', 'billing.checkout'), ('/billing/customer-portal', 'billing.customer_portal'), ('/billing/cancel-subscription', 'billing.cancel_subscription'), ('/billing/webhooks/stripe', 'billing.stripe_webhook'), ('/billing/complete-signup-from-stripe', 'billing.complete_signup_from_stripe'), ('/billing/debug', 'billing.debug_billing')]
[2025-08-01 22:52:44,339] INFO in unit_utils: BatchTrack startup
INFO  [alembic.env] Imported model module: app.models.batch
INFO  [alembic.env] Imported model module: app.models.billing_snapshot
INFO  [alembic.env] Imported model module: app.models.category
INFO  [alembic.env] Imported model module: app.models.developer_permission
INFO  [alembic.env] Imported model module: app.models.developer_role
INFO  [alembic.env] Imported model module: app.models.inventory
INFO  [alembic.env] Imported model module: app.models.mixins
INFO  [alembic.env] Imported model module: app.models.models
INFO  [alembic.env] Imported model module: app.models.permission
INFO  [alembic.env] Imported model module: app.models.pricing_snapshot
INFO  [alembic.env] Imported model module: app.models.product
INFO  [alembic.env] Imported model module: app.models.recipe
INFO  [alembic.env] Imported model module: app.models.reservation
INFO  [alembic.env] Imported model module: app.models.role
INFO  [alembic.env] Imported model module: app.models.statistics
INFO  [alembic.env] Imported model module: app.models.subscription_tier
INFO  [alembic.env] Imported model module: app.models.unit
INFO  [alembic.env] Imported model module: app.models.user_preferences
INFO  [alembic.env] Imported model module: app.models.user_role_assignment
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade add_missing_created_at_columns -> add_missing_table_schemas, add missing table schemas for billing_snapshot, pricing_snapshot, and statistics
=== Adding missing table schemas ===
   billing_snapshots table already exists - skipping
   pricing_snapshots table already exists - skipping
   statistics table already exists - skipping
   Adding timestamps to existing organization_stats table...
‚úÖ Missing table schemas processed successfully
‚ö†Ô∏è  Note: Skipping ingredient_category as requested
INFO  [alembic.runtime.migration] Running upgrade add_missing_table_schemas -> fix_password_hash_length, fix password_hash column length
=== Fixing password_hash column length ===
   Updating user.password_hash column length from 120 to 255...
   ‚úÖ Updated password_hash column to varchar(255)
‚úÖ Migration completed: password_hash column can now store longer hashes
render@srv-d21alungi27c73dn1440-d8bdfdb79-xkrgl:~/project/src$ flask init-production
DEBUG: Billing blueprint imported successfully: <Blueprint 'billing'>
DEBUG: Billing blueprint name: billing
DEBUG: Billing blueprint url_prefix: /billing
DEBUG: Billing blueprint registered successfully
Registered API routes: ['/api/reservations/create', '/api/reservations/release/<int:reservation_id>', '/api/reservations/convert-to-sale/<int:reservation_id>', '/api/reservations/expire-old', '/api/products/<int:product_id>/variants', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/server-time', '/api/server-time', '/api/dismiss-alert', '/api/dashboard-alerts', '/api/check-stock', '/api/categories', '/api/ingredient/<int:id>/density', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/api/api/fifo-details/<int:inventory_id>', '/api/api/batch-inventory-summary/<int:batch_id>', '/api/api/reservations/create', '/api/api/reservations/release/<int:reservation_id>', '/api/api/reservations/convert-to-sale/<int:reservation_id>', '/api/api/reservations/expire-old', '/api/dashboard-alerts', '/api/dismiss-alert', '/api/units', '/api/convert-units']
Container routes found: ['/settings/bulk-update-containers', '/api/debug-containers', '/api/available-containers/<int:recipe_id>', '/api/containers/available', '/api/batches/<int:batch_id>/containers', '/api/batches/<int:batch_id>/containers/<int:container_id>', '/api/batches/<int:batch_id>/containers/<int:container_id>/adjust', '/debug-containers', '/available-containers/<int:recipe_id>', '/containers/available', '/batches/<int:batch_id>/containers', '/batches/<int:batch_id>/containers/<int:container_id>', '/batches/<int:batch_id>/containers/<int:container_id>/adjust']
Billing routes found: ['/billing/reconciliation-needed', '/billing/reconcile-to-free', '/billing/upgrade', '/billing/checkout/<tier>/<billing_cycle>', '/billing/checkout/<tier>', '/billing/customer-portal', '/billing/cancel-subscription', '/billing/webhooks/stripe', '/billing/complete-signup-from-stripe', '/billing/debug']
Billing endpoints: [('/billing/reconciliation-needed', 'billing.reconciliation_needed'), ('/billing/reconcile-to-free', 'billing.reconcile_to_free'), ('/billing/upgrade', 'billing.upgrade'), ('/billing/checkout/<tier>/<billing_cycle>', 'billing.checkout'), ('/billing/checkout/<tier>', 'billing.checkout'), ('/billing/customer-portal', 'billing.customer_portal'), ('/billing/cancel-subscription', 'billing.cancel_subscription'), ('/billing/webhooks/stripe', 'billing.stripe_webhook'), ('/billing/complete-signup-from-stripe', 'billing.complete_signup_from_stripe'), ('/billing/debug', 'billing.debug_billing')]
[2025-08-01 22:52:59,334] INFO in unit_utils: BatchTrack startup
üöÄ BatchTrack Production Seeding Starting...
‚ö†Ô∏è  Assumes database schema is already migrated (flask db upgrade)
=== Step 1: System foundations ===
=== Seeding Consolidated Permissions System ===
Seeding organization permissions...
Processing category: Main dashboard and overview features
  Updated: dashboard.view
Processing category: All inventory tracking, adjustments, and stock management
  Updated: inventory.view
  Updated: inventory.edit
  Updated: inventory.adjust
  Updated: inventory.reserve
  Updated: inventory.delete
  Updated: inventory.view_costs
Processing category: Recipe creation, editing, and production planning
  Updated: recipes.view
  Updated: recipes.create
  Updated: recipes.edit
  Updated: recipes.delete
  Updated: recipes.scale
  Updated: recipes.plan_production
Processing category: Production batch tracking from start to finish
  Updated: batches.view
  Updated: batches.create
  Updated: batches.edit
  Updated: batches.finish
  Updated: batches.cancel
  Updated: batches.view_costs
Processing category: Product catalog, SKUs, and sales tracking
  Updated: products.view
  Updated: products.create
  Updated: products.edit
  Updated: products.delete
  Updated: products.manage_variants
  Updated: products.sales_tracking
Processing category: Organization settings, users, and roles management
  Updated: organization.view
  Updated: organization.edit
  Updated: organization.manage_users
  Updated: organization.manage_roles
  Updated: organization.manage_billing
  Updated: organization.view_audit_logs
Processing category: Alert management and notification preferences
  Updated: alerts.view
  Updated: alerts.manage
  Updated: alerts.dismiss
Processing category: Reporting, analytics, and business insights
  Updated: reports.view
  Updated: reports.export
  Updated: reports.advanced
  Updated: reports.custom
Processing category: Third-party integrations and marketplace connections
  Updated: integrations.shopify
  Updated: integrations.marketplace
  Updated: integrations.api_access
Processing category: AI-powered features and automation
  Updated: ai.recipe_optimization
  Updated: ai.demand_forecasting
  Updated: ai.quality_insights
‚úÖ Organization permissions seeded successfully!
Seeding developer permissions...
Processing category: Core system administration and management
  Updated: dev.system_admin
  Updated: dev.dashboard
  Updated: dev.debug_mode
  Updated: dev.access_logs
  Updated: dev.system_settings
Processing category: Database management and migration operations
  Updated: dev.run_migrations
  Updated: dev.seed_data
  Updated: dev.backup_restore
Processing category: Cross-organization management and oversight
  Updated: dev.all_organizations
  Updated: dev.create_organizations
  Updated: dev.modify_any_organization
  Updated: dev.delete_organizations
Processing category: Global user and permission management
  Updated: dev.manage_users
  Updated: dev.manage_roles
  Updated: dev.assign_permissions
Processing category: Subscription tiers and billing oversight
  Updated: dev.manage_tiers
  Updated: dev.billing_override
  Updated: dev.view_all_billing
Processing category: All organization-level permissions available to developers
  Updated: app.dashboard.view
  Updated: app.inventory.view
  Updated: app.inventory.edit
  Updated: app.inventory.adjust
  Updated: app.inventory.reserve
  Updated: app.inventory.delete
  Updated: app.inventory.view_costs
  Updated: app.recipes.view
  Updated: app.recipes.create
  Updated: app.recipes.edit
  Updated: app.recipes.delete
  Updated: app.recipes.scale
  Updated: app.recipes.plan_production
  Updated: app.batches.view
  Updated: app.batches.create
  Updated: app.batches.edit
  Updated: app.batches.finish
  Updated: app.batches.cancel
  Updated: app.batches.view_costs
  Updated: app.products.view
  Updated: app.products.create
  Updated: app.products.edit
  Updated: app.products.delete
  Updated: app.products.manage_variants
  Updated: app.products.sales_tracking
  Updated: app.organization.view
  Updated: app.organization.edit
  Updated: app.organization.manage_users
  Updated: app.organization.manage_roles
  Updated: app.organization.manage_billing
  Updated: app.organization.view_audit_logs
  Updated: app.alerts.view
  Updated: app.alerts.manage
  Updated: app.alerts.dismiss
  Updated: app.reports.view
  Updated: app.reports.export
  Updated: app.reports.advanced
  Updated: app.reports.custom
  Updated: app.integrations.shopify
  Updated: app.integrations.marketplace
  Updated: app.integrations.api_access
  Updated: app.ai.recipe_optimization
  Updated: app.ai.demand_forecasting
  Updated: app.ai.quality_insights
‚úÖ Developer permissions seeded successfully!
Seeding developer roles...
‚úÖ Created/updated system_admin role with 62 permissions
‚úÖ Created/updated developer role with 7 permissions
‚úÖ Created/updated support role with 8 permissions
‚úÖ Developer roles seeded successfully!
=== Seeding Organization System Roles ===
‚ÑπÔ∏è  organization_owner system role already exists
‚úÖ Organization system roles seeded successfully!
‚úÖ Assigned 0 permissions to fresh organization owner role
‚úÖ Cleaned up old permissions
‚úÖ Consolidated permissions system seeded successfully!

üìä Summary:
Organization permissions: 44
Developer permissions: 62
‚úÖ Permissions seeded
=== Seeding Subscription Tiers Only ===
=== Seeding Subscription Tiers (Create Only Mode) ===
‚ÑπÔ∏è  Exempt tier already exists
‚ÑπÔ∏è  Tier 'free' already exists - PRESERVING existing configuration
‚ÑπÔ∏è  Tier 'solo' already exists - PRESERVING existing configuration
‚ÑπÔ∏è  Tier 'team' already exists - PRESERVING existing configuration
‚ÑπÔ∏è  Tier 'enterprise' already exists - PRESERVING existing configuration
‚úÖ Subscription tiers seeded successfully!
   - Existing tiers were PRESERVED and not modified
   - Only new tiers were created from JSON configuration
=== Migrating Organizations to Tier IDs ===
‚úÖ Organization migration completed!
‚úÖ Subscription tiers seeding completed!
   - Exempt tier created with unlimited permissions
   - New tiers created from JSON configuration
   - Existing tier configurations were PRESERVED
   - Ready for user seeder to create organizations
‚úÖ Subscription tiers seeded
=== Seeding 45 standard units ===
‚úÖ Added 0 new units
‚ÑπÔ∏è  Total units in database: 45
‚úÖ Units seeded
=== Step 2: Initial admin setup ===
=== Creating Default Organization with Essential Users ===
‚ÑπÔ∏è  No organizations found - creating default organization
‚úÖ Created default organization: BatchTrack Organization (ID: 4)
‚ÑπÔ∏è  Using organization: BatchTrack Organization (ID: 4)
   - Subscription tier: exempt (Exempt Plan)
‚úÖ Created developer user: dev/dev123 with system_admin role
‚ö†Ô∏è  User/organization seeding issue: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(psycopg2.errors.NotNullViolation) null value in column "role_id" of relation "user_role_assignment" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null, 2025-08-01 22:53:00.929762, null, null, 1, t, null, null).

[SQL: INSERT INTO user_role_assignment (user_id, role_id, developer_role_id, organization_id, is_active, assigned_at, assigned_by) VALUES (%(user_id)s, %(role_id)s, %(developer_role_id)s, %(organization_id)s, %(is_active)s, %(assigned_at)s, %(assigned_by)s) RETURNING user_role_assignment.id]
[parameters: {'user_id': 1, 'role_id': None, 'developer_role_id': 1, 'organization_id': None, 'is_active': True, 'assigned_at': datetime.datetime(2025, 8, 1, 22, 53, 0, 929762), 'assigned_by': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
   Continuing with remaining steps...
=== Step 3: Organization setup ===
‚ö†Ô∏è  Category seeding issue: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(psycopg2.errors.NotNullViolation) null value in column "role_id" of relation "user_role_assignment" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null, 2025-08-01 22:53:00.929762, null, null, 1, t, null, null).

[SQL: INSERT INTO user_role_assignment (user_id, role_id, developer_role_id, organization_id, is_active, assigned_at, assigned_by) VALUES (%(user_id)s, %(role_id)s, %(developer_role_id)s, %(organization_id)s, %(is_active)s, %(assigned_at)s, %(assigned_by)s) RETURNING user_role_assignment.id]
[parameters: {'user_id': 1, 'role_id': None, 'developer_role_id': 1, 'organization_id': None, 'is_active': True, 'assigned_at': datetime.datetime(2025, 8, 1, 22, 53, 0, 929762), 'assigned_by': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
‚úÖ Production seeding complete!
üîí Login: admin/admin (CHANGE IMMEDIATELY)
üìù Note: This command can be run multiple times safely
üìä Database status:
   - Status check failed: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(psycopg2.errors.NotNullViolation) null value in column "role_id" of relation "user_role_assignment" violates not-null constraint
DETAIL:  Failing row contains (1, 1, null, 2025-08-01 22:53:00.929762, null, null, 1, t, null, null).

[SQL: INSERT INTO user_role_assignment (user_id, role_id, developer_role_id, organization_id, is_active, assigned_at, assigned_by) VALUES (%(user_id)s, %(role_id)s, %(developer_role_id)s, %(organization_id)s, %(is_active)s, %(assigned_at)s, %(assigned_by)s) RETURNING user_role_assignment.id]
[parameters: {'user_id': 1, 'role_id': None, 'developer_role_id': 1, 'organization_id': None, 'is_active': True, 'assigned_at': datetime.datetime(2025, 8, 1, 22, 53, 0, 929762), 'assigned_by': None}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
render@srv-d21alungi27c73dn1440-d8bdfdb79-xkrgl:~/project/src$ 