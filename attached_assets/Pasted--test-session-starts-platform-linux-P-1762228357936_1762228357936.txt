============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.3.5, pluggy-1.5.0 -- /home/runner/workspace/.pythonlibs/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/workspace
collected 85 items / 84 deselected / 1 selected                                

tests/test_timezone_conventions.py::test_no_naive_datetime_usage FAILED  [100%]

=================================== FAILURES ===================================
_________________________ test_no_naive_datetime_usage _________________________

    def test_no_naive_datetime_usage():
        """Ensure no code uses naive datetime helpers."""
    
        failures: list[str] = []
        utcnow_pattern = re.compile(r"datetime\.utcnow\s*\(")
        now_pattern = re.compile(r"datetime\.now\s*\(")
    
        for path in sorted(_iter_python_files()):
            text = path.read_text(encoding="utf-8")
    
            # 1. Forbid datetime.utcnow
            for match in utcnow_pattern.finditer(text):
                line_no = _line_number(text, match.start())
                failures.append(
                    f"{path.relative_to(PROJECT_ROOT)}:{line_no} uses forbidden datetime.utcnow()"
                )
    
            # 2. Require timezone context for datetime.now
            for match in now_pattern.finditer(text):
                line_no = _line_number(text, match.start())
    
                # Capture contextual snippet (covers multi-line calls).
                snippet = text[match.start(): match.start() + 120]
    
                if any(marker in snippet for marker in ALLOWED_NOW_CONTEXT):
                    continue
    
                # Allow occurrences inside comments or strings by doing a light
                # check on the immediate line content.
                line_start = text.rfind("\n", 0, match.start()) + 1
                line_end = text.find("\n", match.start())
                if line_end == -1:
                    line_end = len(text)
                line_text = text[line_start:line_end].strip()
    
                if line_text.startswith("#") or line_text.startswith("'") or line_text.startswith('"'):
                    continue
    
                failures.append(
                    f"{path.relative_to(PROJECT_ROOT)}:{line_no} should use timezone-aware datetime.now("  # noqa: E501
                )
    
>       assert not failures, "\n".join(["Timezone guardrails failed:"] + failures)
E       AssertionError: Timezone guardrails failed:
E         app/blueprints/api/routes.py:280 uses forbidden datetime.utcnow()
E       assert not ['app/blueprints/api/routes.py:280 uses forbidden datetime.utcnow()']

tests/test_timezone_conventions.py:100: AssertionError
=========================== short test summary info ============================
FAILED tests/test_timezone_conventions.py::test_no_naive_datetime_usage - AssertionError: Timezone guardrails failed:
======================= 1 failed, 84 deselected in 6.18s =======================
