what js function was added?


ChatGPT said:
Here‚Äôs the JavaScript function that was added during the broken update ‚Äî which wasn‚Äôt present in btv-896 (original) but appears in btv-896 (3):

üîß ‚ùósubmitFinishBatch() ‚Äî the culprit
js
Copy
Edit
function submitFinishBatch() {
  const modalForm = document.getElementById('finishBatchModalForm');
  if (!modalForm) return;

  const formData = new FormData(modalForm);
  const finalQtyInput = modalForm.querySelector('#final_quantity');
  const finalQty = parseFloat(finalQtyInput?.value);
  const isPerishable = document.getElementById('is_perishable').checked;

  if (!finalQty || isNaN(finalQty) || finalQty <= 0) {
    alert('Please enter a valid final quantity');
    return;
  }

  formData.set('final_quantity', finalQty);  // this was added to manually push the value
  formData.set('is_perishable', isPerishable ? 'on' : 'off');

  if (isPerishable) {
    const shelfLife = document.getElementById('shelf_life_days').value;
    if (!shelfLife || parseInt(shelfLife) <= 0) {
      alert('Please enter valid shelf life days for perishable items');
      return;
    }
    formData.set('shelf_life_days', shelfLife);
    formData.set('expiration_date', document.getElementById('expiration_date').value);
  }

  fetch(modalForm.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': formData.get('csrf_token'),
      'Accept': 'application/json'
    }
  })
  .then(async response => {
    const text = await response.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      // fallback for HTML response
      const div = document.createElement('div');
      div.innerHTML = text;
      const flashMessage = div.querySelector('.alert');
      if (flashMessage) {
        throw new Error(flashMessage.textContent.trim());
      }
      if (response.redirected || response.ok) {
        window.location.href = response.url || '/batches/';
        return;
      }
      throw new Error('Failed to complete batch');
    }

    if (data.error) {
      throw new Error(data.error);
    }

    window.location.href = '/batches/';
  })
  .catch(err => {
    const flashDiv = document.createElement('div');
    flashDiv.className = 'alert alert-danger alert-dismissible fade show';
    flashDiv.innerHTML = `
      ${err.message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    const modalBody = document.querySelector('.modal-body');
    modalBody.insertBefore(flashDiv, modalBody.firstChild);
  });
}
üö´ Problem with this JS function
Overrides native form submission

Requires a bunch of formData.set() calls

If anything breaks (JS not loaded, modal misfires, value skipped), nothing submits

Causes silent failures unless debugged carefully

‚úÖ In btv-896 (original), this did not exist
You were relying on:

html
Copy
Edit
<form method="POST" action="...">
  <button type="submit">Complete Batch</button>
</form>
Which submits all form fields reliably to Flask ‚Äî and Flask handles the redirect.