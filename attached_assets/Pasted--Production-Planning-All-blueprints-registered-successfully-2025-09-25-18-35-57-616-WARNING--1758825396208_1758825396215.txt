 Production Planning

üéâ All blueprints registered successfully!
2025-09-25 18:35:57,616 WARNING:  * Debugger is active!
2025-09-25 18:35:58,076 INFO: Expiration alerts debug: expired_fifo=3, expired_products=0, expiring_fifo=3, expiring_products=0
2025-09-25 18:35:58,076 INFO: Current time: 2025-09-25 18:35:58.060964, cutoff: 2025-10-02 18:35:58.060964
2025-09-25 18:35:58,130 [INFO] app.utils.unit_utils: Getting global unit list
2025-09-25 18:35:58,130 INFO: Getting global unit list
2025-09-25 18:35:59,264 INFO: Expiration alerts debug: expired_fifo=3, expired_products=0, expiring_fifo=3, expiring_products=0
2025-09-25 18:35:59,264 INFO: Current time: 2025-09-25 18:35:59.101719, cutoff: 2025-10-02 18:35:59.101719
2025-09-25 18:35:59,278 INFO: Dashboard alerts requested - found 3 alerts
2025-09-25 18:36:07,891 [DEBUG] app.services.stock_check.handlers.ingredient_handler: Ingredient Apples: 15.0 count available, need 1.0 count
2025-09-25 18:36:07,891 DEBUG: Ingredient Apples: 15.0 count available, need 1.0 count
üîç BATCH_SERVICE DEBUG: Starting batch from snapshot for recipe Goat Milk Soap
üîç BATCH_SERVICE DEBUG: Creating batch with portioning_data: None
üîç BATCH_SERVICE DEBUG: Batch object created with label: GMS-2025-007
üîç BATCH_SERVICE DEBUG: Batch.portioning_data after creation: None
2025-09-25 18:36:10,435 [ERROR] app.services.batch_service.batch_operations: Error processing batch ingredients: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(builtins.TypeError) Object of type PortioningPlan is not JSON serializable
[SQL: INSERT INTO batch (recipe_id, label_code, batch_type, projected_yield, projected_yield_unit, sku_id, final_quantity, output_unit, scale, status, status_reason, notes, tags, total_cost, created_by, organization_id, started_at, completed_at, failed_at, cancelled_at, inventory_credited, is_perishable, shelf_life_days, expiration_date, remaining_quantity, portioning_data, is_portioned, portion_name, projected_portions, final_portions, plan_snapshot, portion_unit_id, cost_method, cost_method_locked_at) VALUES (%(recipe_id)s, %(label_code)s, %(batch_type)s, %(projected_yield)s, %(projected_yield_unit)s, %(sku_id)s, %(final_quantity)s, %(output_unit)s, %(scale)s, %(status)s, %(status_reason)s, %(notes)s, %(tags)s, %(total_cost)s, %(created_by)s, %(organization_id)s, %(started_at)s, %(completed_at)s, %(failed_at)s, %(cancelled_at)s, %(inventory_credited)s, %(is_perishable)s, %(shelf_life_days)s, %(expiration_date)s, %(remaining_quantity)s, %(portioning_data)s::JSON, %(is_portioned)s, %(portion_name)s, %(projected_portions)s, %(final_portions)s, %(plan_snapshot)s::JSON, %(portion_unit_id)s, %(cost_method)s, %(cost_method_locked_at)s) RETURNING batch.id]
[parameters: [{'cost_method_locked_at': datetime.datetime(2025, 9, 25, 18, 36, 10, 433470), 'label_code': 'GMS-2025-007', 'recipe_id': 12, 'created_by': 5, 'status' ... (935 characters truncated) ... 'tags': None, 'projected_portions': None, 'completed_at': None, 'failed_at': None, 'portion_unit_id': None, 'output_unit': None, 'portion_name': None}]]
2025-09-25 18:36:10,435 ERROR: Error processing batch ingredients: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(builtins.TypeError) Object of type PortioningPlan is not JSON serializable
[SQL: INSERT INTO batch (recipe_id, label_code, batch_type, projected_yield, projected_yield_unit, sku_id, final_quantity, output_unit, scale, status, status_reason, notes, tags, total_cost, created_by, organization_id, started_at, completed_at, failed_at, cancelled_at, inventory_credited, is_perishable, shelf_life_days, expiration_date, remaining_quantity, portioning_data, is_portioned, portion_name, projected_portions, final_portions, plan_snapshot, portion_unit_id, cost_method, cost_method_locked_at) VALUES (%(recipe_id)s, %(label_code)s, %(batch_type)s, %(projected_yield)s, %(projected_yield_unit)s, %(sku_id)s, %(final_quantity)s, %(output_unit)s, %(scale)s, %(status)s, %(status_reason)s, %(notes)s, %(tags)s, %(total_cost)s, %(created_by)s, %(organization_id)s, %(started_at)s, %(completed_at)s, %(failed_at)s, %(cancelled_at)s, %(inventory_credited)s, %(is_perishable)s, %(shelf_life_days)s, %(expiration_date)s, %(remaining_quantity)s, %(portioning_data)s::JSON, %(is_portioned)s, %(portion_name)s, %(projected_portions)s, %(final_portions)s, %(plan_snapshot)s::JSON, %(portion_unit_id)s, %(cost_method)s, %(cost_method_locked_at)s) RETURNING batch.id]
[parameters: [{'cost_method_locked_at': datetime.datetime(2025, 9, 25, 18, 36, 10, 433470), 'label_code': 'GMS-2025-007', 'recipe_id': 12, 'created_by': 5, 'status' ... (935 characters truncated) ... 'tags': None, 'projected_portions': None, 'completed_at': None, 'failed_at': None, 'portion_unit_id': None, 'output_unit': None, 'portion_name': None}]]
2025-09-25 18:36:10,436 [ERROR] app.services.batch_service.batch_operations: Error processing batch consumables: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(builtins.TypeError) Object of type PortioningPlan is not JSON serializable
[SQL: INSERT INTO batch (recipe_id, label_code, batch_type, projected_yield, projected_yield_unit, sku_id, final_quantity, output_unit, scale, status, status_reason, notes, tags, total_cost, created_by, organization_id, started_at, completed_at, failed_at, cancelled_at, inventory_credited, is_perishable, shelf_life_days, expiration_date, remaining_quantity, portioning_data, is_portioned, portion_name, projected_portions, final_portions, plan_snapshot, portion_unit_id, cost_method, cost_method_locked_at) VALUES (%(recipe_id)s, %(label_code)s, %(batch_type)s, %(projected_yield)s, %(projected_yield_unit)s, %(sku_id)s, %(final_quantity)s, %(output_unit)s, %(scale)s, %(status)s, %(status_reason)s, %(notes)s, %(tags)s, %(total_cost)s, %(created_by)s, %(organization_id)s, %(started_at)s, %(completed_at)s, %(failed_at)s, %(cancelled_at)s, %(inventory_credited)s, %(is_perishable)s, %(shelf_life_days)s, %(expiration_date)s, %(remaining_quantity)s, %(portioning_data)s::JSON, %(is_portioned)s, %(portion_name)s, %(projected_portions)s, %(final_portions)s, %(plan_snapshot)s::JSON, %(portion_unit_id)s, %(cost_method)s, %(cost_method_locked_at)s) RETURNING batch.id]
[parameters: [{'cost_method_locked_at': datetime.datetime(2025, 9, 25, 18, 36, 10, 433470), 'label_code': 'GMS-2025-007', 'recipe_id': 12, 'created_by': 5, 'status' ... (935 characters truncated) ... 'tags': None, 'projected_portions': None, 'completed_at': None, 'failed_at': None, 'portion_unit_id': None, 'output_unit': None, 'portion_name': None}]] (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-25 18:36:10,436 ERROR: Error processing batch consumables: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)
(builtins.TypeError) Object of type PortioningPlan is not JSON serializable
[SQL: INSERT INTO batch (recipe_id, label_code, batch_type, projected_yield, projected_yield_unit, sku_id, final_quantity, output_unit, scale, status, status_reason, notes, tags, total_cost, created_by, organization_id, started_at, completed_at, failed_at, cancelled_at, inventory_credited, is_perishable, shelf_life_days, expiration_date, remaining_quantity, portioning_data, is_portioned, portion_name, projected_portions, final_portions, plan_snapshot, portion_unit_id, cost_method, cost_method_locked_at) VALUES (%(recipe_id)s, %(label_code)s, %(batch_type)s, %(projected_yield)s, %(projected_yield_unit)s, %(sku_id)s, %(final_quantity)s, %(output_unit)s, %(scale)s, %(status)s, %(status_reason)s, %(notes)s, %(tags)s, %(total_cost)s, %(created_by)s, %(organization_id)s, %(started_at)s, %(completed_at)s, %(failed_at)s, %(cancelled_at)s, %(inventory_credited)s, %(is_perishable)s, %(shelf_life_days)s, %(expiration_date)s, %(remaining_quantity)s, %(portioning_data)s::JSON, %(is_portioned)s, %(portion_name)s, %(projected_portions)s, %(final_portions)s, %(plan_snapshot)s::JSON, %(portion_unit_id)s, %(cost_method)s, %(cost_method_locked_at)s) RETURNING batch.id]
[parameters: [{'cost_method_locked_at': datetime.datetime(2025, 9, 25, 18, 36, 10, 433470), 'label_code': 'GMS-2025-007', 'recipe_id': 12, 'created_by': 5, 'status' ... (935 characters truncated) ... 'tags': None, 'projected_portions': None, 'completed_at': None, 'failed_at': None, 'portion_unit_id': None, 'output_unit': None, 'portion_name': None}]] (Background on this error at: https://sqlalche.me/e/20/7s2a)
