{% extends 'layout.html' %}
{% block content %}

<h2>Hi {{ current_user.username or 'there' }}, what do you want to do?</h2>

{% if expired %}
<div class="alert alert-danger mb-3">
    <strong>⚠️ Expired Inventory:</strong>
    <ul class="mb-0">
        {% for item in expired %}
            <li>{{ item.variant_label }} {{ item.size_label }} – {{ item.unit }} (Batch #{{ item.batch_id }}) – Expired on {{ item.expiration_date }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if low_stock_items %}
<div class="alert alert-warning">
  <strong>⚠️ Low Stock Alerts:</strong>
  <ul class="list-unstyled mb-0 mt-2">
    {% for item in low_stock_items %}
      <li>{{ item.name }} – {{ item.quantity }} {{ item.unit }} remaining (Threshold: {{ item.low_stock_threshold }} {{ item.unit }})</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="mb-3 d-flex gap-2">
  {% if active_batch %}
    <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=active_batch.id) }}" class="btn btn-warning">Continue Batch</a>
  {% endif %}
  <button onclick="document.getElementById('startFlowModal').style.display='block'" class="btn btn-primary">Start Batch</button>
</div>

<!-- Recipe Selection Modal -->
<div id="startFlowModal" class="card mt-4" style="display:none;">
  <div class="card-header">
    <h5 class="card-title mb-0">Start New Batch</h5>
  </div>
  <div class="card-body">
    <form id="recipeForm" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <div class="mb-3">
        <label for="recipe_id" class="form-label">Recipe</label>
        <select name="recipe_id" id="recipe_id" class="form-select" required>
          <option value="">Choose Recipe...</option>
          {% for recipe in recipes %}
          <option value="{{ recipe.id }}">{{ recipe.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Check if selected recipe has variants -->
      <div id="variantSection" class="mb-3" style="display: none;">
        <label for="variant_id" class="form-label">Variant <span class="text-muted">(optional)</span></label>
        <select name="variant_id" id="variant_id" class="form-select">
          <option value="">No variant</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="scale" class="form-label">Scale</label>
        <input type="number" step="0.1" name="scale" value="1.0" class="form-control" required>
        <div class="form-text">Adjust recipe proportions (1.0 = original size)</div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Continue to Production Planning</button>
        <button type="button" onclick="document.getElementById('startFlowModal').style.display='none'" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const recipeSelect = document.getElementById('recipe_id');
  const variantSection = document.getElementById('variantSection');
  const variantSelect = document.getElementById('variant_id');
  const recipeForm = document.getElementById('recipeForm');
  
  // Recipe data with variants (this would be populated from your backend)
  const recipeVariants = {
    {% for recipe in recipes %}
    {% if recipe.variations %}
    "{{ recipe.id }}": [
      {% for variant in recipe.variations %}
      {"id": "{{ variant.id }}", "name": "{{ variant.name }}"}{% if not loop.last %},{% endif %}
      {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endif %}
    {% endfor %}
  };
  
  if (recipeSelect) {
    recipeSelect.addEventListener('change', function() {
      const selectedRecipeId = this.value;
      
      if (selectedRecipeId && recipeVariants[selectedRecipeId]) {
        // Show variant section and populate variants
        variantSection.style.display = 'block';
        variantSelect.innerHTML = '<option value="">No variant</option>';
        
        recipeVariants[selectedRecipeId].forEach(variant => {
          const option = document.createElement('option');
          option.value = variant.id;
          option.textContent = variant.name;
          variantSelect.appendChild(option);
        });
      } else {
        // Hide variant section
        variantSection.style.display = 'none';
        variantSelect.innerHTML = '<option value="">No variant</option>';
      }
    });

    // Handle form submission with dynamic action
    recipeForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const selectedRecipeId = recipeSelect.value;
      if (selectedRecipeId) {
        // Set the form action to the correct recipe planning URL
        this.action = `/recipes/${selectedRecipeId}/plan`;
        this.submit();
      } else {
        alert('Please select a recipe');
      }
    });
  }
});
</script>

{% if alert %}
<div class="alert alert-warning mt-3">
  ⚠️ <strong>{{ alert }}</strong>
</div>
{% endif %}

{% endblock %}