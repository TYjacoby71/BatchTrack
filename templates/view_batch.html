
{% extends 'layout.html' %}
{% block content %}
<h2>View Batch</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe.name }}</p>
    <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
    <p><strong>Status:</strong> <span class="badge {% if batch.status == 'completed' %}bg-success{% elif batch.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">{{ batch.status_display }}</span></p>
    
    {% if batch.status not in ['cancelled'] %}
        <p><strong>Total Cost:</strong> ${{ batch.total_cost or 'N/A' }}</p>

        {% if batch.product_id %}
            <p><strong>Output Type:</strong> Product</p>
            <p><strong>Product Name:</strong> {{ batch.product.name }}</p>
            {% if batch.variant %}
                <p><strong>Variant:</strong> {{ batch.variant }}</p>
            {% endif %}
            <p><strong>Quantity Produced:</strong> {{ batch.product_quantity }}</p>
            <p><strong>Output Unit:</strong> {{ batch.product_unit }}</p>
            {% if batch.total_cost and batch.product_quantity %}
                <p><strong>Unit Cost:</strong> ${{ (batch.total_cost / batch.product_quantity) | round(2) }}</p>
            {% endif %}
        {% else %}
            <p><strong>Output Type:</strong> Ingredient</p>
            <p><strong>Quantity Produced:</strong> {{ batch.product_quantity or 'N/A' }}</p>
            <p><strong>Unit:</strong> {{ batch.product_unit or 'N/A' }}</p>
        {% endif %}

        <!-- Show ingredients used -->
        <div class="mt-4">
            <h4>Ingredients Used</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Cost/Unit</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ingredient in batch.ingredients %}
                    <tr>
                        <td>{{ ingredient.ingredient.name }}</td>
                        <td>{{ "%.2f"|format(ingredient.amount_used) }}</td>
                        <td>{{ ingredient.unit }}</td>
                        <td>${{ "%.2f"|format(ingredient.ingredient.cost_per_unit or 0) }}</td>
                        <td>${{ "%.2f"|format((ingredient.amount_used or 0) * (ingredient.ingredient.cost_per_unit or 0)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Show containers used -->
        {% if batch.containers %}
        <div class="mt-4">
            <h4>Containers Used</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Cost Each</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% for container in batch.containers %}
                    <tr>
                        <td>{{ container.container.name }}</td>
                        <td>{{ container.quantity_used }}</td>
                        <td>${{ "%.2f"|format(container.cost_each) }}</td>
                        <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Show extra ingredients if any -->
        {% if batch.extra_ingredients %}
        <div class="mt-4">
            <h4>Extra Ingredients Used</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Cost/Unit</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% for extra in batch.extra_ingredients %}
                    <tr>
                        <td>{{ extra.ingredient.name }}</td>
                        <td>{{ "%.2f"|format(extra.quantity) }}</td>
                        <td>{{ extra.unit }}</td>
                        <td>${{ "%.2f"|format(extra.cost_per_unit) }}</td>
                        <td>${{ "%.2f"|format(extra.quantity * extra.cost_per_unit) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    {% endif %}

    {% if batch.status == 'cancelled' %}
    <div class="mt-4">
        <h4>Inventory Refunded</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Amount</th>
                    <th>Unit</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for ingredient in batch.ingredients %}
                <tr>
                    <td>{{ ingredient.ingredient.name }}</td>
                    <td>{{ ingredient.amount_used }}</td>
                    <td>{{ ingredient.unit }}</td>
                    <td>Ingredient</td>
                </tr>
                {% endfor %}
                {% for container in batch.containers %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ container.quantity_used }}</td>
                    <td>{{ container.container.unit }}</td>
                    <td>Container</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if batch.extra_ingredients %}
    <div class="mt-4">
        <h4>Extra Ingredients Used</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Cost/Unit</th>
                    <th>Total Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for extra in batch.extra_ingredients %}
                <tr>
                    <td>{{ extra.ingredient.name }}</td>
                    <td>{{ "%.2f"|format(extra.quantity) }}</td>
                    <td>{{ extra.unit }}</td>
                    <td>${{ "%.2f"|format(extra.cost_per_unit) }}</td>
                    <td>${{ "%.2f"|format(extra.quantity * extra.cost_per_unit) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<hr>

<h3>Batch Notes</h3>
<form method="post" action="{{ url_for('batches.update_batch_notes', batch_id=batch.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <textarea name="notes" rows="4" class="form-control mb-3">{{ batch.notes or '' }}</textarea>
    {% if batch.tags %}
        <h3 class="mt-4">Tags</h3>
        <p>{{ batch.tags }}</p>
    {% endif %}
    <button type="submit" class="btn btn-secondary">Save and Return to Batch List</button>
</form>
{% endblock %}
