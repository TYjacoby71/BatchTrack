{% extends 'layout.html' %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <h2>Batch Details</h2>
    <button onclick="window.print()" class="btn btn-secondary">
        <i class="fas fa-print"></i> Print Batch Details
    </button>
</div>
<!-- Section 1: Basic Batch Info (Always Visible) -->
<div class="batch-header mb-4">
    <h2>Batch Details</h2>
    <div class="card">
        <div class="card-body">
            <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
            <p><strong>Recipe:</strong> {{ batch.recipe.name }}</p>
            <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
            <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
            <p><strong>Status:</strong> 
                <span class="badge {% if batch.status == 'completed' %}bg-success
                            {% elif batch.status == 'failed' %}bg-danger
                            {% elif batch.status == 'cancelled' %}bg-secondary
                            {% else %}bg-warning{% endif %}">
                    {{ batch.status|title }}
                </span>
            </p>
        </div>
    </div>
</div>

<!-- Section 2: Output Info (Hidden if Cancelled) -->
{% if batch.status != 'cancelled' %}
<div class="batch-output mb-4">
    <h3>Output Details</h3>
    <div class="card">
        <div class="card-body">
            <p><strong>Output Type:</strong> {{ batch.batch_type|title }}</p>

            {% if batch.batch_type == 'product' and batch.product %}
                <p><strong>Product:</strong> <a href="{{ url_for('products.view_product', product_id=batch.product.id) }}">{{ batch.product.name }}</a></p>
                {% if batch.variant %}
                    <p><strong>Variant:</strong> {{ batch.variant }}</p>
                {% endif %}
            {% endif %}

            <p><strong>Projected Yield:</strong> {{ batch.yield_amount }} {{ batch.yield_unit }}</p>
            <p><strong>Final Yield:</strong> {{ batch.final_quantity or 'N/A' }} {{ batch.output_unit or batch.yield_unit }}</p>
                       {% if batch.is_perishable %}
                <p><strong>Shelf Life:</strong> {{ batch.shelf_life_days }} days</p>
                {% if batch.expiration_date %}
                    <p><strong>Expiration Date:</strong> {{ batch.expiration_date.strftime('%Y-%m-%d') }}</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Section 3: Batch Summary -->
<div class="batch-summary mb-4">
    <h3>{% if batch.status == 'cancelled' %}Inventory Refunded{% else %}Inventory Used{% endif %}</h3>
    <div class="card">
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Amount Used</th>
                        <th>Unit</th>
                        <th>Cost/Unit</th>
                        <th>Line Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% if batch.ingredients %}
                    <tr><th colspan="5">Ingredients</th></tr>
                    {% for ing in batch.ingredients %}
                    <tr>
                        <td>{{ ing.ingredient.name }}</td>
                        <td>{{ "%.2f"|format(ing.amount_used) }}</td>
                        <td>{{ ing.unit }}</td>
                        <td>${{ "%.2f"|format(ing.cost_per_unit or 0) }}</td>
                        <td>${{ "%.2f"|format((ing.amount_used or 0) * (ing.cost_per_unit or 0)) }}</td>
                    </tr>
                    {% endfor %}
                    {% set ingredient_total = (batch.ingredients|sum(attribute='amount_used') or 0) * (batch.ingredients|sum(attribute='cost_per_unit') or 0) %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Ingredients Subtotal:</em></td>
                        <td>${{ "%.2f"|format(ingredient_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.containers %}
                    <tr><th colspan="5">Containers</th></tr>
                    {% for container in batch.containers %}
                    <tr>
                        <td>{{ container.container.name }}</td>
                        <td>{{ container.quantity_used }}</td>
                        <td>{{ container.container.unit }}</td>
                        <td>${{ "%.2f"|format(container.cost_each) }}</td>
                        <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                    </tr>
                    {% endfor %}
                    {% set container_total = (batch.containers|sum(attribute='quantity_used') or 0) * (batch.containers|sum(attribute='cost_each') or 0) %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Containers Subtotal:</em></td>
                        <td>${{ "%.2f"|format(container_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.extra_ingredients %}
                    <tr><th colspan="5">Extra Ingredients</th></tr>
                    {% for extra in batch.extra_ingredients %}
                    <tr>
                        <td>{{ extra.ingredient.name }}</td>
                        <td>{{ "%.2f"|format(extra.quantity) }}</td>
                        <td>{{ extra.unit }}</td>
                        <td>${{ "%.2f"|format(extra.cost_per_unit) }}</td>
                        <td>${{ "%.2f"|format(extra.quantity * extra.cost_per_unit) }}</td>
                    </tr>
                    {% endfor %}
                    {% set extras_total = (batch.extra_ingredients|sum(attribute='quantity') or 0) * (batch.extra_ingredients|sum(attribute='cost_per_unit') or 0) %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Extra Ingredients Subtotal:</em></td>
                        <td>${{ "%.2f"|format(extras_total) }}</td>
                    </tr>
                    {% endif %}

                    {% if batch.extra_containers %}
                    <tr><th colspan="5">Extra Containers</th></tr>
                    {% for container in batch.extra_containers %}
                    <tr>
                        <td>{{ container.container.name }}</td>
                        <td>{{ container.quantity_used }}</td>
                        <td>{{ container.container.unit }}</td>
                        <td>${{ "%.2f"|format(container.cost_each) }}</td>
                        <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                    </tr>
                    {% endfor %}
                    {% set extra_container_total = (batch.extra_containers|sum(attribute='quantity_used') or 0) * (batch.extra_containers|sum(attribute='cost_each') or 0) %}
                    <tr>
                        <td colspan="4" class="text-end"><em>Extra Containers Subtotal:</em></td>
                        <td>${{ "%.2f"|format(extra_container_total) }}</td>
                    </tr>
                    {% endif %}
                </tbody>
                <tfoot>
                    {% set total_cost = (ingredient_total if ingredient_total else 0) + (container_total if container_total else 0) + (extras_total if extras_total else 0) + (extra_container_total if extra_container_total else 0) %}
                    <tr>
                        <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                        <td><strong>${{ "%.2f"|format(total_cost) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Notes and Tags Section -->
<div class="notes-section">
    <h3>Batch Notes</h3>
    <form method="post" action="{{ url_for('batches.update_batch_notes', batch_id=batch.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <textarea name="notes" rows="4" class="form-control mb-3">{{ batch.notes or '' }}</textarea>
        </div>
        <div class="mb-3">
            <label for="tags" class="form-label">Tags</label>
            <input type="text" name="tags" class="form-control" value="{{ batch.tags or '' }}">
        </div>
        <button type="submit" class="btn btn-secondary">Save and Return to Batch List</button>
    </form>
</div>
{% endblock %}