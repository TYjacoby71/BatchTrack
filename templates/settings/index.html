{% extends 'layout.html' %}
{% block content %}
<div class="container">
    <h2>Settings</h2>

    <form id="settingsForm" class="mt-4" method="post">
        {{ csrf_token() }}
        

        <!-- Alert Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Alert Settings</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Low Stock Threshold</label>
                    <input type="number" class="form-control" 
                           name="alerts.low_stock_threshold"
                           value="{{ settings.get('alerts', {}).get('low_stock_threshold', 5) }}">
                </div>
                <div class="form-group">
                    <label>Notification Type</label>
                    <select class="form-control" name="alerts.notification_type">
                        <option value="dashboard" {% if settings.get('alerts', {}).get('notification_type') == 'dashboard' %}selected{% endif %}>Dashboard</option>
                        <option value="popup" {% if settings.get('alerts', {}).get('notification_type') == 'popup' %}selected{% endif %}>Popup</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Recipe Builder Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Recipe Builder Settings</h3>
            </div>
            <div class="card-body">
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input"
                               name="recipe_builder.enable_variations"
                               {% if settings.get('recipe_builder', {}).get('enable_variations') %}checked{% endif %}>
                        Enable Recipe Variations
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input"
                               name="recipe_builder.enable_containers"
                               {% if settings.get('recipe_builder', {}).get('enable_containers') %}checked{% endif %}>
                        Enable Container Selection
                    </label>
                </div>
            </div>
        </div>

        <!-- Unit Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Unit Management</h3>
            </div>
            <div class="card-body">
                <a href="{{ url_for('conversion.manage_units') }}" class="btn btn-primary">Manage Units</a>
                <div class="mt-3">
                    <p>Click the button above to manage inventory and product units.</p>
                </div>
            </div>
        </div>

        <!-- Category Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Category Management</h3>
            </div>
            <div class="card-body">
                <p>Category management will be implemented here.</p>
                <div id="categoryManagementPlaceholder">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2">No categories defined yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save"></i> Save Settings
        </button>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} mt-3">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<script>
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {};

    // Collect all form data
    const inputs = this.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            const path = input.name.split('.');
            let current = formData;
            for (let i = 0; i < path.length - 1; i++) {
                if (!current[path[i]]) current[path[i]] = {};
                current = current[path[i]];
            }
            current[path[path.length - 1]] = input.checked;
        } else {
            const path = input.name.split('.');
            let current = formData;
            for (let i = 0; i < path.length - 1; i++) {
                if (!current[path[i]]) current[path[i]] = {};
                current = current[path[i]];
            }
            current[path[path.length - 1]] = input.value;
        }
    });

    // Save settings
    fetch('/settings/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Settings saved successfully');
        }
    });
});
</script>
{% endblock %}