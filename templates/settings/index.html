{% extends "layout.html" %}
{% block content %}
<div class="container" x-data="settingsManager()">
    <h2><i class="fas fa-cog"></i> System Settings</h2>
    <p class="text-muted">Configure BatchTrack to match your workflow and preferences</p>

    <!-- Success/Error Messages -->
    <div x-show="showMessage" x-transition class="alert" :class="messageType === 'success' ? 'alert-success' : 'alert-danger'" style="display: none;">
        <span x-text="message"></span>
        <button type="button" class="btn-close" @click="showMessage = false"></button>
    </div>

    <!-- Alert Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning"></i> Alert Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dashboard Alerts</h6>
                            <div class="mb-3">
                                <label for="max-dashboard-alerts" class="form-label">
                                    Maximum alerts on dashboard (recommended: 1-3 for focus)
                                </label>
                                <select class="form-select" id="max-dashboard-alerts" 
                                        x-model="settings.alerts.max_dashboard_alerts" 
                                        @change="updateSetting('max_dashboard_alerts', $event.target.value)">
                                    <option value="1">1 alert (minimal)</option>
                                    <option value="2">2 alerts (focused)</option>
                                    <option value="3">3 alerts (balanced)</option>
                                    <option value="5">5 alerts (detailed)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="low-stock-threshold" class="form-label">Low stock threshold</label>
                                <input type="number" class="form-control" id="low-stock-threshold" 
                                       x-model="settings.alerts.low_stock_threshold" 
                                       @change="updateSetting('low_stock_threshold', $event.target.value)"
                                       min="1" max="100">
                            </div>

                            <div class="mb-3">
                                <label for="expiration-warning-days" class="form-label">Expiration warning (days ahead)</label>
                                <input type="number" class="form-control" id="expiration-warning-days" 
                                       x-model="settings.alerts.expiration_warning_days"
                                       @change="updateSetting('expiration_warning_days', $event.target.value)"
                                       min="1" max="30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Alert Types</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-expiration-alerts" 
                                       x-model="settings.alerts.show_expiration_alerts"
                                       @change="updateSetting('show_expiration_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-expiration-alerts">
                                    Expiration alerts (expired & expiring soon)
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-timer-alerts" 
                                       x-model="settings.alerts.show_timer_alerts"
                                       @change="updateSetting('show_timer_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-timer-alerts">
                                    Timer alerts (expired timers)
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-low-stock-alerts" 
                                       x-model="settings.alerts.show_low_stock_alerts"
                                       @change="updateSetting('show_low_stock_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-low-stock-alerts">
                                    Low stock alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-batch-alerts"
                                       x-model="settings.alerts.show_batch_alerts"
                                       @change="updateSetting('show_batch_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-batch-alerts">
                                    Stuck batch alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-fault-alerts" 
                                       x-model="settings.alerts.show_fault_alerts"
                                       @change="updateSetting('show_fault_alerts', $event.target.checked)">
                                <label class="form-check-label" for="show-fault-alerts">
                                    System fault alerts
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-alert-badges" 
                                       x-model="settings.alerts.show_alert_badges"
                                       @change="updateSetting('show_alert_badges', $event.target.checked)">
                                <label class="form-check-label" for="show-alert-badges">
                                    Show alert badges in navigation
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Tools Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs text-primary"></i> Production Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Batch Management</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-timer-completion" 
                                       x-model="settings.batch_rules.require_timer_completion"
                                       @change="updateSetting('require_timer_completion', $event.target.checked)">
                                <label class="form-check-label" for="require-timer-completion">
                                    Require timer completion before finishing batch
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="allow-intermediate-tags"
                                       x-model="settings.batch_rules.allow_intermediate_tags"
                                       @change="updateSetting('allow_intermediate_tags', $event.target.checked)">
                                <label class="form-check-label" for="allow-intermediate-tags">
                                    Allow intermediate tags during batch
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-finish-confirmation"
                                       x-model="settings.batch_rules.require_finish_confirmation"
                                       @change="updateSetting('require_finish_confirmation', $event.target.checked)">
                                <label class="form-check-label" for="require-finish-confirmation">
                                    Require confirmation before finishing batch
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="stuck-batch-hours" class="form-label">Mark batches as stuck after (hours)</label>
                                <input type="number" class="form-control" id="stuck-batch-hours" 
                                       x-model="settings.batch_rules.stuck_batch_hours"
                                       @change="updateSetting('stuck_batch_hours', $event.target.value)"
                                       min="1" max="168">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Recipe & Planning</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-variations" 
                                       x-model="settings.recipe_builder.enable_variations"
                                       @change="updateSetting('enable_variations', $event.target.checked)">
                                <label class="form-check-label" for="enable-variations">
                                    Enable recipe variations
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-containers" 
                                       x-model="settings.recipe_builder.enable_containers"
                                       @change="updateSetting('enable_containers', $event.target.checked)">
                                <label class="form-check-label" for="enable-containers">
                                    Enable container management
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-scale-recipes"
                                       x-model="settings.recipe_builder.auto_scale_recipes"
                                       @change="updateSetting('auto_scale_recipes', $event.target.checked)">
                                <label class="form-check-label" for="auto-scale-recipes">
                                    Auto-scale recipes based on inventory
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-cost-breakdown"
                                       x-model="settings.recipe_builder.show_cost_breakdown"
                                       @change="updateSetting('show_cost_breakdown', $event.target.checked)">
                                <label class="form-check-label" for="show-cost-breakdown">
                                    Show cost breakdown in recipes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes text-success"></i> Inventory Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Tracking Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-fifo-tracking"
                                       x-model="settings.inventory.enable_fifo_tracking"
                                       @change="updateSetting('enable_fifo_tracking', $event.target.checked)">
                                <label class="form-check-label" for="enable-fifo-tracking">
                                    Enable FIFO (First In, First Out) tracking
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-expiration-dates"
                                       x-model="settings.inventory.show_expiration_dates"
                                       @change="updateSetting('show_expiration_dates', $event.target.checked)">
                                <label class="form-check-label" for="show-expiration-dates">
                                    Show expiration dates in inventory
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-calculate-costs"
                                       x-model="settings.inventory.auto_calculate_costs"
                                       @change="updateSetting('auto_calculate_costs', $event.target.checked)">
                                <label class="form-check-label" for="auto-calculate-costs">
                                    Auto-calculate ingredient costs
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-supplier-info"
                                       x-model="settings.inventory.show_supplier_info"
                                       @change="updateSetting('show_supplier_info', $event.target.checked)">
                                <label class="form-check-label" for="show-supplier-info">
                                    Show supplier information
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Advanced Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-barcode-scanning"
                                       x-model="settings.inventory.enable_barcode_scanning"
                                       @change="updateSetting('enable_barcode_scanning', $event.target.checked)">
                                <label class="form-check-label" for="enable-barcode-scanning">
                                    Enable barcode scanning (future feature)
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-bulk-operations"
                                       x-model="settings.inventory.enable_bulk_operations"
                                       @change="updateSetting('enable_bulk_operations', $event.target.checked)">
                                <label class="form-check-label" for="enable-bulk-operations">
                                    Enable bulk inventory operations
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="showInventoryRefund" 
                                       x-model="settings.alerts.show_inventory_refund"
                                       @change="updateSetting('show_inventory_refund', $event.target.checked)">
                                <label class="form-check-label" for="showInventoryRefund">
                                    Show inventory refund details
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-bag text-info"></i> Product Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Product Features</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-product-variants"
                                       x-model="settings.products.enable_variants"
                                       @change="updateSetting('enable_variants', $event.target.checked)">
                                <label class="form-check-label" for="enable-product-variants">
                                    Enable product variants
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-profit-margins"
                                       x-model="settings.products.show_profit_margins"
                                       @change="updateSetting('show_profit_margins', $event.target.checked)">
                                <label class="form-check-label" for="show-profit-margins">
                                    Show profit margins
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="track-production-costs"
                                       x-model="settings.products.track_production_costs"
                                       @change="updateSetting('track_production_costs', $event.target.checked)">
                                <label class="form-check-label" for="track-production-costs">
                                    Track production costs
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Product Display</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-product-images"
                                       x-model="settings.products.enable_product_images"
                                       @change="updateSetting('enable_product_images', $event.target.checked)">
                                <label class="form-check-label" for="enable-product-images">
                                    Enable product images
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-generate-skus"
                                       x-model="settings.products.auto_generate_skus"
                                       @change="updateSetting('auto_generate_skus', $event.target.checked)">
                                <label class="form-check-label" for="auto-generate-skus">
                                    Auto-generate SKU codes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools text-secondary"></i> System Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Management</h6>
                            <div class="list-group mb-3">
                                <a href="{{ url_for('conversion_bp.manage_units') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ruler text-info"></i> Unit Management
                                </a>
                                <a href="{{ url_for('tags.manage_tags') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-tags text-success"></i> Tag Management
                                </a>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-backup"
                                       x-model="settings.system.auto_backup"
                                       @change="updateSetting('auto_backup', $event.target.checked)">
                                <label class="form-check-label" for="auto-backup">
                                    Enable automatic backups
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="log-level" class="form-label">System log level</label>
                                <select class="form-select" id="log-level"
                                        x-model="settings.system.log_level"
                                        @change="updateSetting('log_level', $event.target.value)">
                                    <option value="ERROR">Error only</option>
                                    <option value="WARNING">Warning & above</option>
                                    <option value="INFO">Info & above</option>
                                    <option value="DEBUG">Debug (verbose)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Display Preferences</h6>
                            <div class="mb-3">
                                <label for="items-per-page" class="form-label">Items per page</label>
                                <select class="form-select" id="items-per-page"
                                        x-model="settings.display.per_page"
                                        @change="updateSetting('per_page', $event.target.value)">
                                    <option value="10">10 items</option>
                                    <option value="20">20 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-csv-export" 
                                       x-model="settings.display.enable_csv_export"
                                       @change="updateSetting('enable_csv_export', $event.target.checked)">
                                <label class="form-check-label" for="enable-csv-export">
                                    Enable CSV export functionality
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-save-forms"
                                       x-model="settings.display.auto_save_forms"
                                       @change="updateSetting('auto_save_forms', $event.target.checked)">
                                <label class="form-check-label" for="auto-save-forms">
                                    Auto-save form progress
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="compact-view"
                                       x-model="settings.display.compact_view"
                                       @change="updateSetting('compact_view', $event.target.checked)">
                                <label class="form-check-label" for="compact-view">
                                    Use compact view layouts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Preferences Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-info"></i> User Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dashboard Layout</h6>
                            <div class="mb-3">
                                <label for="dashboard-layout" class="form-label">Default dashboard view</label>
                                <select class="form-select" id="dashboard-layout"
                                        x-model="settings.display.dashboard_layout"
                                        @change="updateSetting('dashboard_layout', $event.target.value)">
                                    <option value="compact">Compact (minimal information)</option>
                                    <option value="standard">Standard (balanced view)</option>
                                    <option value="detailed">Detailed (all information)</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-quick-actions" 
                                       x-model="settings.display.show_quick_actions"
                                       @change="updateSetting('show_quick_actions', $event.target.checked)">
                                <label class="form-check-label" for="show-quick-actions">
                                    Show quick action buttons
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Accessibility</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="reduce-animations"
                                       x-model="settings.accessibility.reduce_animations"
                                       @change="updateSetting('reduce_animations', $event.target.checked)">
                                <label class="form-check-label" for="reduce-animations">
                                    Reduce animations and transitions
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="high-contrast-mode"
                                       x-model="settings.accessibility.high_contrast_mode"
                                       @change="updateSetting('high_contrast_mode', $event.target.checked)">
                                <label class="form-check-label" for="high-contrast-mode">
                                    High contrast mode
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="keyboard-navigation" 
                                       x-model="settings.accessibility.keyboard_navigation"
                                       @change="updateSetting('keyboard_navigation', $event.target.checked)">
                                <label class="form-check-label" for="keyboard-navigation">
                                    Enhanced keyboard navigation
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="large-buttons"
                                       x-model="settings.accessibility.large_buttons"
                                       @change="updateSetting('large_buttons', $event.target.checked)">
                                <label class="form-check-label" for="large-buttons">
                                    Use larger buttons and controls
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-envelope text-warning"></i> Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Notification Types</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="browser-notifications"
                                       x-model="settings.notifications.browser_notifications"
                                       @change="updateSetting('browser_notifications', $event.target.checked)">
                                <label class="form-check-label" for="browser-notifications">
                                    Browser notifications
                                </label>
                            </div>

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="email-alerts"
                                       x-model="settings.notifications.email_alerts"
                                       @change="updateSetting('email_alerts', $event.target.checked)">
                                <label class="form-check-label" for="email-alerts">
                                    Email alerts (future feature)
                                </label>
                            </div>

                            <div class="mb-3">
                                <label for="alert-frequency" class="form-label">Alert frequency</label>
                                <select class="form-select" id="alert-frequency"
                                        x-model="settings.notifications.alert_frequency"
                                        @change="updateSetting('alert_frequency', $event.target.value)">
                                    <option value="immediate">Immediate</option>
                                    <option value="hourly">Hourly digest</option>
                                    <option value="daily">Daily digest</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Quiet Hours</h6>
                            <div class="mb-3">
                                <label for="quiet-hours-start" class="form-label">Quiet hours start</label>
                                <input type="time" class="form-control" id="quiet-hours-start" 
                                       x-model="settings.notifications.quiet_hours_start"
                                       @change="updateSetting('quiet_hours_start', $event.target.value)">
                            </div>

                            <div class="mb-3">
                                <label for="quiet-hours-end" class="form-label">Quiet hours end</label>
                                <input type="time" class="form-control" id="quiet-hours-end" 
                                       x-model="settings.notifications.quiet_hours_end"
                                       @change="updateSetting('quiet_hours_end', $event.target.value)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Settings Button -->
    <div class="row">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg" @click="saveAllSettings()" :disabled="saving">
                <i class="fas fa-save"></i> 
                <span x-text="saving ? 'Saving...' : 'Save All Settings'"></span>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg ms-2" @click="resetToDefaults()" :disabled="saving">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('settingsManager', () => ({
        settings: {
            alerts: {
                max_dashboard_alerts: {{ settings.alerts.max_dashboard_alerts or 3 }},
                show_expiration_alerts: {{ 'true' if settings.alerts.show_expiration_alerts else 'false' }},
                show_timer_alerts: {{ 'true' if settings.alerts.show_timer_alerts else 'false' }},
                show_low_stock_alerts: {{ 'true' if settings.alerts.show_low_stock_alerts else 'false' }},
                show_batch_alerts: {{ 'true' if settings.alerts.show_batch_alerts else 'false' }},
                show_fault_alerts: {{ 'true' if settings.alerts.show_fault_alerts else 'false' }},
                low_stock_threshold: {{ settings.alerts.low_stock_threshold or 5 }},
                expiration_warning_days: {{ settings.alerts.expiration_warning_days or 7 }},
                show_inventory_refund: {{ 'true' if settings.alerts.show_inventory_refund else 'false' }},
                show_alert_badges: {{ 'true' if settings.alerts.show_alert_badges else 'false' }}
            },
            batch_rules: {
                require_timer_completion: {{ 'true' if settings.batch_rules.require_timer_completion else 'false' }},
                allow_intermediate_tags: {{ 'true' if settings.batch_rules.allow_intermediate_tags else 'false' }},
                require_finish_confirmation: {{ 'true' if settings.batch_rules.require_finish_confirmation else 'false' }},
                stuck_batch_hours: {{ settings.batch_rules.stuck_batch_hours or 24 }}
            },
            recipe_builder: {
                enable_variations: {{ 'true' if settings.recipe_builder.enable_variations else 'false' }},
                enable_containers: {{ 'true' if settings.recipe_builder.enable_containers else 'false' }},
                auto_scale_recipes: {{ 'true' if settings.recipe_builder.auto_scale_recipes else 'false' }},
                show_cost_breakdown: {{ 'true' if settings.recipe_builder.show_cost_breakdown else 'false' }}
            },
            inventory: {
                enable_fifo_tracking: {{ 'true' if settings.inventory.enable_fifo_tracking else 'false' }},
                show_expiration_dates: {{ 'true' if settings.inventory.show_expiration_dates else 'false' }},
                auto_calculate_costs: {{ 'true' if settings.inventory.auto_calculate_costs else 'false' }},
                enable_barcode_scanning: {{ 'true' if settings.inventory.enable_barcode_scanning else 'false' }},
                show_supplier_info: {{ 'true' if settings.inventory.show_supplier_info else 'false' }},
                enable_bulk_operations: {{ 'true' if settings.inventory.enable_bulk_operations else 'false' }}
            },
            products: {
                enable_variants: {{ 'true' if settings.products.enable_variants else 'false' }},
                show_profit_margins: {{ 'true' if settings.products.show_profit_margins else 'false' }},
                auto_generate_skus: {{ 'true' if settings.products.auto_generate_skus else 'false' }},
                enable_product_images: {{ 'true' if settings.products.enable_product_images else 'false' }},
                track_production_costs: {{ 'true' if settings.products.track_production_costs else 'false' }}
            },
            display: {
                per_page: {{ settings.display.per_page or 20 }},
                enable_csv_export: {{ 'true' if settings.display.enable_csv_export else 'false' }},
                auto_save_forms: {{ 'true' if settings.display.auto_save_forms else 'false' }},
                dashboard_layout: '{{ settings.display.dashboard_layout or "standard" }}',
                show_quick_actions: {{ 'true' if settings.display.show_quick_actions else 'false' }},
                compact_view: {{ 'true' if settings.display.compact_view else 'false' }}
            },
            accessibility: {
                reduce_animations: {{ 'true' if settings.accessibility.reduce_animations else 'false' }},
                high_contrast_mode: {{ 'true' if settings.accessibility.high_contrast_mode else 'false' }},
                keyboard_navigation: {{ 'true' if settings.accessibility.keyboard_navigation else 'false' }},
                large_buttons: {{ 'true' if settings.accessibility.large_buttons else 'false' }}
            },
            system: {
                auto_backup: {{ 'true' if settings.system.auto_backup else 'false' }},
                log_level: '{{ settings.system.log_level or "INFO" }}'
            },
            notifications: {
                browser_notifications: {{ 'true' if settings.notifications.browser_notifications else 'false' }},
                email_alerts: {{ 'true' if settings.notifications.email_alerts else 'false' }},
                alert_frequency: '{{ settings.notifications.alert_frequency or "immediate" }}',
                quiet_hours_start: '{{ settings.notifications.quiet_hours_start or "22:00" }}',
                quiet_hours_end: '{{ settings.notifications.quiet_hours_end or "08:00" }}'
            }
        },
        saving: false,
        showMessage: false,
        message: '',
        messageType: 'success',

        updateSetting(key, value) {
            // Convert string values to proper types
            if (value === 'true') value = true;
            if (value === 'false') value = false;
            if (!isNaN(value) && value !== '') value = parseInt(value);

            fetch('/settings/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({[key]: value})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.showSuccessMessage('Setting saved');
                } else {
                    this.showErrorMessage('Error saving setting: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Settings save error:', error);
                this.showErrorMessage('Error saving setting');
            });
        },

        saveAllSettings() {
            this.saving = true;

            fetch('/settings/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.settings)
            })
            .then(response => response.json())
            .then(data => {
                this.saving = false;
                if (data.status === 'success') {
                    this.showSuccessMessage('All settings saved successfully!');
                } else {
                    this.showErrorMessage('Error saving settings: ' + data.message);
                }
            })
            .catch(error => {
                this.saving = false;
                console.error('Settings save error:', error);
                this.showErrorMessage('Error saving settings. Please try again.');
            });
        },

        resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                this.settings = {
                    alerts: {
                        max_dashboard_alerts: 3,
                        show_expiration_alerts: true,
                        show_timer_alerts: true,
                        show_low_stock_alerts: true,
                        show_batch_alerts: false,
                        show_fault_alerts: true,
                        low_stock_threshold: 5,
                        expiration_warning_days: 7,
                        show_inventory_refund: false,
                        show_alert_badges: true
                    },
                    batch_rules: {
                        require_timer_completion: true,
                        allow_intermediate_tags: false,
                        require_finish_confirmation: true,
                        stuck_batch_hours: 24
                    },
                    recipe_builder: {
                        enable_variations: true,
                        enable_containers: true,
                        auto_scale_recipes: false,
                        show_cost_breakdown: true
                    },
                    inventory: {
                        enable_fifo_tracking: true,
                        show_expiration_dates: true,
                        auto_calculate_costs: true,
                        enable_barcode_scanning: false,
                        show_supplier_info: true,
                        enable_bulk_operations: true
                    },
                    products: {
                        enable_variants: false,
                        show_profit_margins: false,
                        auto_generate_skus: false,
                        enable_product_images: false,
                        track_production_costs: false
                    },
                    display: {
                        per_page: 20,
                        enable_csv_export: false,
                        auto_save_forms: false,
                        dashboard_layout: 'standard',
                        show_quick_actions: false,
                        compact_view: false
                    },
                    accessibility: {
                        reduce_animations: false,
                        high_contrast_mode: false,
                        keyboard_navigation: false,
                        large_buttons: false
                    },
                    system: {
                        auto_backup: false,
                        log_level: 'INFO'
                    },
                    notifications: {
                        browser_notifications: false,
                        email_alerts: false,
                        alert_frequency: 'immediate',
                        quiet_hours_start: '22:00',
                        quiet_hours_end: '08:00'
                    }
                };
                this.saveAllSettings();
            }
        },

        showSuccessMessage(msg) {
            this.message = msg;
            this.messageType = 'success';
            this.showMessage = true;
            setTimeout(() => { this.showMessage = false; }, 3000);
        },

        showErrorMessage(msg) {
            this.message = msg;
            this.messageType = 'error';
            this.showMessage = true;
            setTimeout(() => { this.showMessage = false; }, 5000);
        }
    }));
});
</script>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}