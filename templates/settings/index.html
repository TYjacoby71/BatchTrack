
{% extends "layout.html" %}
{% block content %}
<div class="container">
    <h2>Settings</h2>
    
    <!-- Alert Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning"></i> Alert Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dashboard Alerts</h6>
                            <div class="mb-3">
                                <label for="max-dashboard-alerts" class="form-label">
                                    Maximum alerts on dashboard (recommended: 1-3 for focus)
                                </label>
                                <select class="form-select" id="max-dashboard-alerts" name="max_dashboard_alerts">
                                    <option value="1">1 alert (minimal)</option>
                                    <option value="2">2 alerts (focused)</option>
                                    <option value="3" selected>3 alerts (balanced)</option>
                                    <option value="5">5 alerts (detailed)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Alert Types</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-expiration-alerts" checked>
                                <label class="form-check-label" for="show-expiration-alerts">
                                    Expiration alerts (expired & expiring soon)
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-timer-alerts" checked>
                                <label class="form-check-label" for="show-timer-alerts">
                                    Timer alerts (expired timers)
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-low-stock-alerts" checked>
                                <label class="form-check-label" for="show-low-stock-alerts">
                                    Low stock alerts
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-batch-alerts">
                                <label class="form-check-label" for="show-batch-alerts">
                                    Stuck batch alerts
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-fault-alerts" checked>
                                <label class="form-check-label" for="show-fault-alerts">
                                    System fault alerts
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Threshold Settings</h6>
                            <div class="mb-3">
                                <label for="low-stock-threshold" class="form-label">Low stock threshold</label>
                                <input type="number" class="form-control" id="low-stock-threshold" 
                                       value="{{ settings.alerts.low_stock_threshold or 5 }}" min="1" max="100">
                            </div>
                            
                            <div class="mb-3">
                                <label for="expiration-warning-days" class="form-label">Expiration warning (days ahead)</label>
                                <input type="number" class="form-control" id="expiration-warning-days" 
                                       value="7" min="1" max="30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Display Options</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="showInventoryRefund" 
                                       {% if settings.alerts.show_inventory_refund %}checked{% endif %}
                                       onchange="updateSetting('alerts.show_inventory_refund', this.checked)">
                                <label class="form-check-label" for="showInventoryRefund">
                                    Show inventory refund details
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-alert-badges" checked>
                                <label class="form-check-label" for="show-alert-badges">
                                    Show alert badges in navigation
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Tools Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs text-primary"></i> Production Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Batch Management</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="require-timer-completion" 
                                       {% if settings.batch_rules.require_timer_completion %}checked{% endif %}>
                                <label class="form-check-label" for="require-timer-completion">
                                    Require timer completion before finishing batch
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="allow-intermediate-tags">
                                <label class="form-check-label" for="allow-intermediate-tags">
                                    Allow intermediate tags during batch
                                </label>
                            </div>
                            
                            <div class="mb-3">
                                <label for="stuck-batch-hours" class="form-label">Mark batches as stuck after (hours)</label>
                                <input type="number" class="form-control" id="stuck-batch-hours" 
                                       value="24" min="1" max="168">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Recipe & Planning</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-variations" 
                                       {% if settings.recipe_builder.enable_variations %}checked{% endif %}>
                                <label class="form-check-label" for="enable-variations">
                                    Enable recipe variations
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-containers" 
                                       {% if settings.recipe_builder.enable_containers %}checked{% endif %}>
                                <label class="form-check-label" for="enable-containers">
                                    Enable container management
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-scale-recipes">
                                <label class="form-check-label" for="auto-scale-recipes">
                                    Auto-scale recipes based on inventory
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools text-secondary"></i> System Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Management</h6>
                            <div class="list-group">
                                <a href="{{ url_for('conversion_bp.manage_units') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ruler text-info"></i> Unit Management
                                </a>
                                <a href="{{ url_for('tags.manage_tags') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-tags text-success"></i> Tag Management
                                </a>
                                <a href="{{ url_for('admin.cleanup_tools') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-broom text-warning"></i> Database Cleanup Tools
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Display Preferences</h6>
                            <div class="mb-3">
                                <label for="items-per-page" class="form-label">Items per page</label>
                                <select class="form-select" id="items-per-page">
                                    <option value="10">10 items</option>
                                    <option value="20" {% if settings.per_page == 20 %}selected{% endif %}>20 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </select>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable-csv-export" 
                                       {% if settings.enable_csv_export %}checked{% endif %}>
                                <label class="form-check-label" for="enable-csv-export">
                                    Enable CSV export functionality
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-save-forms">
                                <label class="form-check-label" for="auto-save-forms">
                                    Auto-save form progress
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Preferences Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-info"></i> User Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dashboard Layout</h6>
                            <div class="mb-3">
                                <label for="dashboard-layout" class="form-label">Default dashboard view</label>
                                <select class="form-select" id="dashboard-layout">
                                    <option value="compact">Compact (minimal information)</option>
                                    <option value="standard" selected>Standard (balanced view)</option>
                                    <option value="detailed">Detailed (all information)</option>
                                </select>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="show-quick-actions" checked>
                                <label class="form-check-label" for="show-quick-actions">
                                    Show quick action buttons
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Accessibility</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="reduce-animations">
                                <label class="form-check-label" for="reduce-animations">
                                    Reduce animations and transitions
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="high-contrast-mode">
                                <label class="form-check-label" for="high-contrast-mode">
                                    High contrast mode
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="keyboard-navigation" checked>
                                <label class="form-check-label" for="keyboard-navigation">
                                    Enhanced keyboard navigation
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Settings Button -->
    <div class="row">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg" onclick="saveAllSettings()">
                <i class="fas fa-save"></i> Save All Settings
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="resetToDefaults()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
        </div>
    </div>
</div>

<script>
function updateSetting(key, value) {
    // Existing function for individual setting updates
    fetch('/settings/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({[key]: value})
    });
}

function saveAllSettings() {
    const settings = {
        alerts: {
            max_dashboard_alerts: document.getElementById('max-dashboard-alerts').value,
            show_expiration_alerts: document.getElementById('show-expiration-alerts').checked,
            show_timer_alerts: document.getElementById('show-timer-alerts').checked,
            show_low_stock_alerts: document.getElementById('show-low-stock-alerts').checked,
            show_batch_alerts: document.getElementById('show-batch-alerts').checked,
            show_fault_alerts: document.getElementById('show-fault-alerts').checked,
            low_stock_threshold: document.getElementById('low-stock-threshold').value,
            expiration_warning_days: document.getElementById('expiration-warning-days').value,
            show_inventory_refund: document.getElementById('showInventoryRefund').checked,
            show_alert_badges: document.getElementById('show-alert-badges').checked
        },
        batch_rules: {
            require_timer_completion: document.getElementById('require-timer-completion').checked,
            allow_intermediate_tags: document.getElementById('allow-intermediate-tags').checked,
            stuck_batch_hours: document.getElementById('stuck-batch-hours').value
        },
        recipe_builder: {
            enable_variations: document.getElementById('enable-variations').checked,
            enable_containers: document.getElementById('enable-containers').checked,
            auto_scale_recipes: document.getElementById('auto-scale-recipes').checked
        },
        display: {
            per_page: document.getElementById('items-per-page').value,
            enable_csv_export: document.getElementById('enable-csv-export').checked,
            auto_save_forms: document.getElementById('auto-save-forms').checked,
            dashboard_layout: document.getElementById('dashboard-layout').value,
            show_quick_actions: document.getElementById('show-quick-actions').checked
        },
        accessibility: {
            reduce_animations: document.getElementById('reduce-animations').checked,
            high_contrast_mode: document.getElementById('high-contrast-mode').checked,
            keyboard_navigation: document.getElementById('keyboard-navigation').checked
        }
    };
    
    fetch('/settings/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Settings saved successfully!');
        } else {
            alert('Error saving settings: ' + data.message);
        }
    });
}

function resetToDefaults() {
    if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        // Reset all form elements to their default values
        document.getElementById('max-dashboard-alerts').value = '3';
        document.getElementById('low-stock-threshold').value = '5';
        document.getElementById('expiration-warning-days').value = '7';
        document.getElementById('stuck-batch-hours').value = '24';
        document.getElementById('items-per-page').value = '20';
        document.getElementById('dashboard-layout').value = 'standard';
        
        // Reset all checkboxes to their defaults
        const defaultChecked = ['show-expiration-alerts', 'show-timer-alerts', 'show-low-stock-alerts', 'show-fault-alerts', 'show-alert-badges', 'enable-variations', 'enable-containers', 'enable-csv-export', 'show-quick-actions', 'keyboard-navigation'];
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = defaultChecked.includes(checkbox.id);
        });
        
        saveAllSettings();
    }
}
</script>
{% endblock %}
