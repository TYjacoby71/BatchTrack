{% extends 'layout.html' %}
{% block content %}

<h2>Plan Production: {{ recipe.name }}</h2>

<form id="planProductionForm" method="post" action="{{ url_for('batches.start_batch') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="recipe_id" value="{{ recipe.id }}">

  <!-- Scale and Projected Yield -->
  <div class="row mb-4">
    <div class="col-md-6">
      <label for="scale">Scale:</label>
      <input type="number" class="form-control" name="scale" id="scale" value="1" min="0.1" step="0.1" onchange="updateProjectedYield()" required>
    </div>
    <div class="col-md-6">
      <label>Projected Yield:</label>
      <div id="projectedYield" class="form-control-plaintext" data-base-yield="{{ recipe.predicted_yield }}" data-base-unit="{{ recipe.predicted_yield_unit }}">
        {{ recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}
      </div>
    </div>
  </div>

  <!-- Stock Check Button -->
  <button type="button" class="btn btn-primary mb-4" onclick="checkStock()">Check Stock</button>

  <!-- Ingredient Stock Check Results -->
  <div id="ingredientStockSection" style="display: none;">
    <div class="card mb-4">
      <div class="card-header"><h5>Ingredient Stock Check</h5></div>
      <div class="card-body">
        <div id="ingredientStockResults" class="table-responsive"></div>
      </div>
    </div>
  </div>

  <!-- Mode Toggles (Shown only after Stock OK) -->
  <div id="modeTogglesSection" class="row my-4" style="display: none;">
    <div class="col-md-6">
      <label for="flexMode">Flexible Mode</label>
      <input type="checkbox" id="flexMode" name="flex_mode">
      <small class="form-text text-muted">Allows proceeding without full containment.</small>
    </div>
    <div class="col-md-6">
      <label for="autoFill">Auto-Fill Containers</label>
      <input type="checkbox" id="autoFill" name="auto_fill" checked>
      <small class="form-text text-muted">Auto select best-fit containers to match batch.</small>
    </div>
  </div>

  <!-- Container Planning Section -->
  <div id="containerPlanningSection" style="display: none;">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between">
        <h5>Select Containers</h5>
        <button type="button" class="btn btn-outline-primary btn-sm" id="addContainerBtn">Add Container</button>
      </div>
      <div class="card-body">
        <div id="containerSelectionArea"></div>

        <label class="mt-3">Containment Progress:</label>
        <div class="progress" style="height: 20px;">
          <div id="fillProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
        </div>
        <small id="remainingToContain" class="form-text text-muted"></small>

        <div id="containmentError" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex justify-content-between mt-4">
    <div>
      <button type="button" id="exportShoppingListBtn" class="btn btn-warning" style="display: none;">Export Shopping List</button>
    </div>
    <div>
      <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary">Cancel</a>
      <button type="submit" id="startBatchButton" class="btn btn-success" style="display: none;">Start Batch</button>
    </div>
  </div>

</form>

{% endblock %}

{% block scripts %}
<script>
// Plan Production Page JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const scaleInput = document.getElementById('scale');
  const projectedYieldElement = document.getElementById('projectedYield');
  const stockCheckSection = document.getElementById('ingredientStockSection');
  const ingredientResultsContainer = document.getElementById('ingredientStockResults');
  const flexModeToggle = document.getElementById('flexMode');
  const autoFillToggle = document.getElementById('autoFill');
  const containerPlanningSection = document.getElementById('containerPlanningSection');
  const containerArea = document.getElementById('containerSelectionArea');
  const fillProgressBar = document.getElementById('fillProgressBar');
  const remainingDisplay = document.getElementById('remainingToContain');
  const containmentError = document.getElementById('containmentError');
  const modeTogglesSection = document.getElementById('modeTogglesSection');
  const exportButton = document.getElementById('exportShoppingListBtn');
  const startBatchButton = document.getElementById('startBatchButton');
  const addContainerBtn = document.getElementById('addContainerBtn');

  function updateProjectedYield() {
    const baseYield = parseFloat(projectedYieldElement.dataset.baseYield) || 0;
    const scale = parseFloat(scaleInput.value) || 1;
    const unit = projectedYieldElement.dataset.baseUnit || '';
    const newYield = (baseYield * scale).toFixed(2);
    projectedYieldElement.innerText = `${newYield} ${unit}`;
  }

  function checkStock() {
    const recipeId = document.querySelector('input[name="recipe_id"]').value;
    const scale = parseFloat(scaleInput.value) || 1;

    fetch('/api/check-stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipe_id: recipeId, scale: scale })
    })
    .then(response => response.json())
    .then(data => {
      renderStockResults(data.stock_check);
      stockCheckData = data.stock_check;
      missingItems = stockCheckData.filter(item => item.status !== 'OK');
      stockCheckSection.style.display = 'block';
      modeTogglesSection.style.display = 'block';
      containerPlanningSection.style.display = 'block';
      updateButtons();
    })
    .catch(error => {
      console.error('Error checking stock:', error);
      alert('Failed to check stock.');
    });
  }

  // Add event listeners
  if (scaleInput) {
    scaleInput.addEventListener('change', updateProjectedYield);
  }
  
  const checkStockBtn = document.querySelector('button[onclick="checkStock()"]');
  if (checkStockBtn) {
    checkStockBtn.addEventListener('click', checkStock);
  }

  // Initialize
  updateProjectedYield();
});
</script>
{% endblock %}