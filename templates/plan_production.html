{% extends 'layout.html' %}
{% block content %}
<h2>Plan Production: {{ recipe.name }}</h2>

<form id="planProductionForm">
  <input type="hidden" name="recipe_id" value="{{ recipe.id }}">

  <!-- Scale Selection -->
  <div class="form-group">
    <label for="scale">Scale:</label>
    <input type="number" class="form-control" name="scale" id="scale" value="1" min="0.1" step="0.1" required>
  </div>

  <!-- Flex/Strict Toggle -->
  <div class="form-group">
    <label for="flexMode">Flexible Mode?</label>
    <input type="checkbox" id="flexMode" name="flex_mode">
    <small class="form-text text-muted">If off, strict container rules will apply.</small>
  </div>

  <!-- Auto-fill Toggle (only if strict mode is on) -->
  <div class="form-group" id="autoFillSection" style="display:none;">
    <label for="autoFill">Auto-Fill Containers?</label>
    <input type="checkbox" id="autoFill" name="auto_fill" checked>
    <small class="form-text text-muted">Automatically pick best matching containers if available.</small>
  </div>

  <!-- Vertical Fill Bar and Remaining Display -->
  <div class="form-group">
    <label>Batch Containment Progress:</label>
    <div class="progress" style="height: 20px;">
      <div id="fillProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <p id="remainingToContain">Remaining to contain: 0 units</p>
  </div>

  <!-- Container Picker Area -->
  <div class="form-group">
    <label>Add Containers:</label>
    <div id="containerSelectionArea">
      <!-- JS will inject container rows here -->
    </div>
    <button type="button" class="btn btn-secondary mt-2" id="addContainerBtn">Add Container</button>
  </div>

  <!-- Error Message Area -->
  <div id="containmentError" style="display:none;" class="alert alert-danger">
    ⚠ Cannot fully contain batch at this scale.
    <br>
    <button type="button" id="overrideButton" class="btn btn-danger mt-2">
      Continue anyway — I'll put it in a Ziplock if I have to
    </button>
  </div>

  <button type="submit" class="btn btn-primary mt-3">Check Stock</button>

  <!-- Stock Check Results Area -->
  <div id="stockCheckResults" class="my-4"></div>

  <!-- Action Buttons -->
  <button id="startBatchButton" class="btn btn-success" style="display:none;">Start Batch</button>
  <button id="exportShoppingListButton" class="btn btn-warning" style="display:none;">Export Shopping List</button>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/plan_production.js') }}"></script>
<script>
function addContainerRow() {
  const row = document.createElement('div');
  row.className = 'container-row d-flex align-items-center gap-2 mb-2';
  row.innerHTML = `
    <select class="form-select container-select" required>
      <option value="">Select Container</option>
      {% for container in containers %}
      <option value="{{ container.id }}" 
              data-capacity="{{ container.storage_amount }}"
              data-unit="{{ container.storage_unit }}">
        {{ container.name }} ({{ container.storage_amount }} {{ container.storage_unit }})
      </option>
      {% endfor %}
    </select>
    <input type="number" class="form-control container-quantity" 
           min="1" value="1" required>
    <button type="button" class="btn btn-danger btn-sm remove-container">×</button>
  `;

  row.querySelector('.remove-container').addEventListener('click', () => {
    row.remove();
    updateContainmentProgress();
  });

  row.querySelector('.container-quantity').addEventListener('change', updateContainmentProgress);
  row.querySelector('.container-select').addEventListener('change', updateContainmentProgress);

  containerArea.appendChild(row);
  updateContainmentProgress();
}
</script>
{% endblock %}