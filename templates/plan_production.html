{% extends 'layout.html' %}
{% block content %}

<h2>Plan Production: {{ recipe.name }}</h2>

<form id="planProductionForm" method="post" action="{{ url_for('batches.start_batch') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="recipe_id" value="{{ recipe.id }}">

  <!-- Scale and Projected Yield -->
  <div class="row mb-4">
    <div class="col-md-6">
      <label for="scale">Scale:</label>
      <input type="number" class="form-control" name="scale" id="scale" value="1" min="0.1" step="0.1" onchange="updateProjectedYield()" required>
    </div>
    <div class="col-md-6">
      <label>Projected Yield:</label>
      <div id="projectedYield" class="form-control-plaintext" data-base-yield="{{ recipe.predicted_yield }}" data-base-unit="{{ recipe.predicted_yield_unit }}">
        {{ recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}
      </div>
    </div>
  </div>

  <!-- Stock Check Button -->
  <button type="button" class="btn btn-primary mb-4" onclick="checkStock()">Check Stock</button>

  <!-- Ingredient Stock Check Results -->
  <div id="ingredientStockSection" style="display: none;">
    <div class="card mb-4">
      <div class="card-header"><h5>Ingredient Stock Check</h5></div>
      <div class="card-body">
        <div id="ingredientStockResults" class="table-responsive"></div>
      </div>
    </div>
  </div>

  <!-- Mode Toggles (Shown only after Stock OK) -->
  <div id="modeTogglesSection" class="row my-4" style="display: none;">
    <div class="col-md-6">
      <label for="flexMode">Flexible Mode</label>
      <input type="checkbox" id="flexMode" name="flex_mode">
      <small class="form-text text-muted">Allows proceeding without full containment.</small>
    </div>
    <div class="col-md-6">
      <label for="autoFill">Auto-Fill Containers</label>
      <input type="checkbox" id="autoFill" name="auto_fill" checked>
      <small class="form-text text-muted">Auto select best-fit containers to match batch.</small>
    </div>
  </div>

  <!-- Container Planning Section -->
  <div id="containerPlanningSection" style="display: none;">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between">
        <h5>Select Containers</h5>
        <button type="button" class="btn btn-outline-primary btn-sm" id="addContainerBtn">Add Container</button>
      </div>
      <div class="card-body">
        <div id="containerSelectionArea"></div>

        <label class="mt-3">Containment Progress:</label>
        <div class="progress" style="height: 20px;">
          <div id="fillProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
        </div>
        <small id="remainingToContain" class="form-text text-muted"></small>

        <div id="containmentError" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex justify-content-between mt-4">
    <div>
      <button type="button" id="exportShoppingListBtn" class="btn btn-warning" style="display: none;">Export Shopping List</button>
    </div>
    <div>
      <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary">Cancel</a>
      <button type="submit" id="startBatchButton" class="btn btn-success" style="display: none;">Start Batch</button>
    </div>
  </div>

</form>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/plan_production.js') }}"></script>
{% endblock %}