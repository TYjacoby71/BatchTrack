
{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('batches.view_batch', batch_identifier=batch.id) }}">Batch {{ batch.label_code }}</a></li>
            <li class="breadcrumb-item active">{{ ingredient.name }} FIFO Breakdown</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-12">
            <h2>FIFO Usage Breakdown</h2>
            <p><strong>Batch:</strong> {{ batch.label_code }} - {{ batch.recipe.name }}</p>
            <p><strong>Ingredient:</strong> {{ ingredient.name }}</p>
        </div>
    </div>

    {% if fifo_breakdown %}
    <div class="card">
        <div class="card-header">
            <h4>FIFO Sources Used</h4>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Amount Used</th>
                        <th>Unit</th>
                        <th>Source Date</th>
                        <th>Source Type</th>
                        <th>Cost/Unit</th>
                        <th>FIFO Code</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_amount = 0 %}
                    {% set total_cost = 0 %}
                    {% for item in fifo_breakdown %}
                    {% set total_amount = total_amount + item.amount_used %}
                    {% set line_cost = item.amount_used * (item.source_cost or 0) %}
                    {% set total_cost = total_cost + line_cost %}
                    <tr>
                        <td>{{ "%.3f"|format(item.amount_used) }}</td>
                        <td>{{ item.unit }}</td>
                        <td>{{ item.source_date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <span class="badge {% if item.source_type == 'restock' %}bg-success{% else %}bg-info{% endif %}">
                                {{ item.source_type|title }}
                            </span>
                        </td>
                        <td>${{ "%.3f"|format(item.source_cost or 0) }}</td>
                        <td><code>{{ item.fifo_code }}</code></td>
                        <td>{{ item.source_notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-info">
                        <th>{{ "%.3f"|format(total_amount) }}</th>
                        <th>{{ fifo_breakdown[0].unit if fifo_breakdown else '' }}</th>
                        <th colspan="3">Total Cost: ${{ "%.3f"|format(total_cost) }}</th>
                        <th colspan="2"></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h5>No FIFO Data Available</h5>
        <p>This could happen if:</p>
        <ul>
            <li>The batch was created before FIFO tracking was implemented</li>
            <li>The ingredient was manually adjusted rather than through batch processing</li>
            <li>FIFO data was cleaned up or migrated</li>
        </ul>
    </div>
    {% endif %}

    <div class="mt-3">
        <a href="{{ url_for('batches.view_batch', batch_identifier=batch.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Batch
        </a>
    </div>
</div>
{% endblock %}
