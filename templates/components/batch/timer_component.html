
<div x-data="{ 
  showTimerForm: false,
  showTimerList: false,
  name: '',
  hours: '',
  minutes: '',
  seconds: '',
  csrfToken: document.querySelector('input[name=csrf_token]').value,
  calculateTotalSeconds() {
    return (parseInt(this.hours || 0) * 3600) + 
           (parseInt(this.minutes || 0) * 60) + 
           parseInt(this.seconds || 0);
  },
  async createTimer() {
    const totalSeconds = this.calculateTotalSeconds();
    if (totalSeconds < 1) {
      alert('Please enter a valid duration');
      return;
    }

    const response = await fetch('/timers/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.csrfToken
      },
      body: JSON.stringify({
        name: this.name,
        batch_id: {{ batch.id }},
        duration_seconds: totalSeconds
      })
    });

    const result = await response.json();
    if (result.status === 'success') {
      window.location.reload();
    } else {
      alert('Failed to create timer');
    }
  }
}">
  <div class="d-flex align-items-center gap-2">
    <button type="button" @click="showTimerForm = !showTimerForm" class="btn btn-outline-primary">
      + Add Timer
    </button>
    <button type="button" @click="showTimerList = !showTimerList" class="btn btn-outline-secondary btn-sm" title="Show/Hide Timer List">
      <span x-text="showTimerList ? '▼' : '▶'" style="font-size: 10px;"></span>
    </button>
  </div>

  <div x-show="showTimerList" class="mt-3" x-transition>
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Name</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for timer in timers if timer.batch_id == batch.id %}
          <tr>
            <td>{{ timer.name }}</td>
            <td>{{ timer.duration_seconds // 60 }}m {{ timer.duration_seconds % 60 }}s</td>
            <td>{{ timer.status|title }}</td>
            <td>
              {% if timer.status != 'completed' %}
              <form method="POST" action="{{ url_for('timers.complete_timer', timer_id=timer.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-success">Complete</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div x-show="showTimerForm" class="card mt-3">
    <div class="card-body">
      <div class="timer-form">
        <div class="mb-3">
          <label class="form-label">Timer Label</label>
          <input type="text" class="form-control" x-model="name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (H:M:S)</label>
          <div class="d-flex gap-2">
            <input type="number" class="form-control" x-model="hours" placeholder="H" min="0">
            <input type="number" class="form-control" x-model="minutes" placeholder="M" min="0">
            <input type="number" class="form-control" x-model="seconds" placeholder="S" min="0">
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" @click="createTimer" class="btn btn-success">Create Timer</button>
          <button type="button" @click="showTimerForm = false" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>
