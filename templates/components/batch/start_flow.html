
{# Batch Start Flow Component #}
<div class="batch-start-flow" 
     x-data="{ 
       currentStep: 'recipe',
       recipeId: '',
       scale: 1.0,
       stockResults: null,
       
       async checkStock() {
         try {
           const response = await fetch('/api/check-stock', {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json',
               'X-CSRFToken': document.querySelector('input[name=csrf_token]').value
             },
             body: JSON.stringify({
               recipe_id: this.recipeId,
               scale: this.scale
             })
           });
           const data = await response.json();
           if (data.error) throw new Error(data.error);
           this.stockResults = data.stock_check;
           this.currentStep = 'stock';
         } catch (error) {
           alert('Error checking stock: ' + error.message);
         }
       }
     }">
  <div class="start-flow-header">
    <h3>Start New Batch</h3>
  </div>
  
  <div class="step-container" x-show="currentStep === 'recipe'">
    <div class="form-group">
      <label>Select Recipe:</label>
      <select class="form-select recipe-select" 
              x-model="recipeId" 
              @change="currentStep = 'scale'"
              required>
        <option value="">Choose Recipe...</option>
        {% for recipe in recipes %}
        <option value="{{ recipe.id }}">{{ recipe.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="step-container" x-show="currentStep === 'scale'">
    <div class="form-group">
      <label>Batch Scale:</label>
      <input type="number" 
             class="form-control" 
             x-model.number="scale" 
             min="0.1" 
             step="0.1">
      <button class="btn btn-primary mt-2" 
              @click="checkStock()">
        Check Stock
      </button>
    </div>
  </div>

  <div class="step-container" x-show="currentStep === 'stock'">
    <div id="stockCheckResults" class="mt-4">
      <template x-if="stockResults">
        <div>
          <h4>Stock Check Results</h4>
          <table class="table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Needed</th>
                <th>Available</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="item in stockResults" :key="item.name">
                <tr>
                  <td x-text="item.name"></td>
                  <td x-text="item.needed + ' ' + item.unit"></td>
                  <td x-text="item.available + ' ' + item.unit"></td>
                  <td :class="{
                    'text-success': item.status === 'OK',
                    'text-warning': item.status === 'LOW',
                    'text-danger': item.status === 'NEEDED'
                  }" x-text="item.status"></td>
                </tr>
              </template>
            </tbody>
          </table>
          
          <form method="post" action="{{ url_for('batches.start_batch') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="recipe_id" :value="recipeId">
            <input type="hidden" name="scale" :value="scale">
            <button type="submit" 
                    class="btn btn-success"
                    x-show="stockResults.every(item => item.status === 'OK')">
              Start Batch
            </button>
          </form>
        </div>
      </template>
    </div>
  </div>
</div>
