
{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
</div>

<form method="post" action="{{ url_for('batches.finish_batch', batch_id=batch.id) }}" enctype="multipart/form-data">
    <!-- Output Type Selection -->
    <div class="form-group">
        <label for="output_type">Output Type:</label>
        <select name="output_type" id="output_type" class="form-select" onchange="toggleOutputFields()" required>
            <option value="product">Product</option>
            <option value="ingredient">Ingredient</option>
        </select>
    </div>

    <!-- Product Yield Section -->
    <div id="productFields" class="form-group mt-4">
        <label for="product_quantity">
            Batch Yield
            <span data-bs-toggle="tooltip" title="How much usable product or inventory this batch created. Example: 12 jars, 3 bottles, etc.">‚ùì</span>
        </label>
        <input type="number" name="product_quantity" value="1" min="1" class="form-control" required>
        <select name="product_unit" class="form-select mb-3" required>
            {% for unit in product_units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Ingredient Yield Section -->
    <div id="ingredientFields" class="form-group mt-4" style="display:none;">
        <label for="ingredient_unit" class="form-label mb-2">Unit Type:</label>
        <select name="ingredient_unit" class="form-select mb-3" required>
            {% for unit in inventory_units %}
            <option value="{{ unit.name }}" {% if unit.type == 'inventory' %}selected{% endif %}>{{ unit.name }}</option>
            {% endfor %}
        </select>
        <label for="ingredient_quantity">Ingredient Yield:</label>
        <input type="number" name="ingredient_quantity" value="1" min="1" class="form-control" required>
    </div>

    <!-- Batch Cost Summary -->
    <div class="batch-summary mt-4">
        <h4>Batch Summary</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Ingredient</th>
                    <th>Amount Used</th>
                    <th>Unit</th>
                    <th>Cost/Unit</th>
                    <th>Line Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for cost in ingredient_costs %}
                <tr>
                    <td>{{ cost.name }}</td>
                    <td>{{ "%.2f"|format(cost.used) }}</td>
                    <td>{{ cost.unit }}</td>
                    <td>${{ "%.2f"|format(cost.cost_per_unit) }}</td>
                    <td>${{ "%.2f"|format(cost.line_cost) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                    <td><strong>${{ "%.2f"|format(batch_cost) if batch_cost else '0.00' }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Extra Ingredients Section -->
    <div class="extra-ingredients mt-4">
        <h4>Extra Ingredients Used</h4>
        <button type="button" onclick="addIngredientRow()" class="btn btn-outline-secondary mb-3">+ Add Ingredient</button>
        <div id="ingredientInputs"></div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section mt-4">
        <h4>Batch Notes</h4>
        <textarea name="notes" rows="4" class="form-control">{{ batch.notes or '' }}</textarea>
    </div>

    <!-- Tags Section -->
    <div class="form-group mt-3">
        <label for="tags">Tags (comma-separated):</label>
        <input type="text" name="tags" value="{{ batch.tags or '' }}" class="form-control">
    </div>

    <!-- Timer Section -->
    <div class="form-group mt-4">
        <h4>üïí Batch Timers</h4>
        <div id="timerContainer"></div>
        <button type="button" class="btn btn-outline-secondary" onclick="addTimerRow()">‚ûï Add Timer</button>
    </div>

    <!-- Submission Buttons -->
    <div class="button-group mt-4">
        <button type="submit" name="action" value="finish" class="btn btn-success">‚úì Complete Batch</button>
        <button type="submit" name="action" value="fail" class="btn btn-danger">‚úï Mark as Failed</button>
    </div>
</form>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function toggleOutputFields() {
    const type = document.getElementById('output_type').value;
    const productFields = document.getElementById('productFields');
    const ingredientFields = document.getElementById('ingredientFields');

    productFields.style.display = type === 'product' ? 'block' : 'none';
    ingredientFields.style.display = type === 'ingredient' ? 'block' : 'none';
}

function addIngredientRow() {
    const row = document.createElement('div');
    row.classList.add('row', 'mb-2', 'align-items-center');
    row.innerHTML = `
        <div class="col-md-4">
            <select class="form-select ingredient-select" name="extra_ingredients[]" required>
                <option value="">Select Ingredient</option>
                {% for ing in all_ingredients %}
                <option value="{{ ing.name }}">{{ ing.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" step="0.01" class="form-control" name="extra_amounts[]" placeholder="Amount" required>
        </div>
        <div class="col-md-3">
            <select class="form-select unit-select" name="extra_units[]" required>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 text-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">‚úï</button>
        </div>
    `;
    document.getElementById('ingredientInputs').appendChild(row);
    initializeSelect2(row);
}

function addTimerRow() {
    const container = document.getElementById('timerContainer');
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center mb-2';
    
    div.innerHTML = `
        <input type="datetime-local" name="batch_timers[]" class="form-control me-2" required>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚úï</button>
    `;
    
    container.appendChild(div);
}

function initializeSelect2(container) {
    $(container).find('.ingredient-select').select2({
        placeholder: 'Search ingredients...',
        width: '100%'
    });
    
    $(container).find('.unit-select').select2({
        placeholder: 'Select unit',
        width: '100%'
    });
}

// Initialize tooltips and Select2
document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    
    $('.ingredient-select').select2({
        placeholder: 'Search ingredients...',
        width: '100%'
    });
    
    $('.unit-select').select2({
        placeholder: 'Select unit',
        width: '100%'
    });
});

// Initialize output fields on load
toggleOutputFields();
</script>
{% endblock %}
