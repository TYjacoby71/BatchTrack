{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
</div>

<div class="notes-section">
    <h3>Batch Notes</h3>
    <form method="post" action="{{ url_for('batches.update_batch_notes', batch_id=batch.id) }}">
        <textarea name="notes" rows="4" cols="50">{{ batch.notes or '' }}</textarea>
        <button type="submit" class="button secondary">Update Notes</button>
    </form>
</div>

<div class="actions-section">
    <h3>Finish Batch</h3>
    <form method="post" action="{{ url_for('batches.finish_batch', batch_id=batch.id) }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="output_type"><strong>This batch creates:</strong></label>
            <select id="output_type" name="output_type" class="form-select" onchange="toggleOutputFields()">
                <option value="product" selected>ðŸ“¦ Product</option>
                <option value="ingredient">ðŸ§ª Ingredient</option>
            </select>
        </div>
    <div class="ingredients-used">
        <h3>Confirm Ingredients Used</h3>
        {% for item in ingredient_costs %}
        <div class="ingredient-row">
            <input type="hidden" name="ingredient_{{ loop.index0 }}" value="{{ item.name }}">
            <label>{{ item.name }} ({{ item.unit }}):</label>
            <input type="number" name="amount_{{ loop.index0 }}" value="{{ item.used | round(2) }}" step="0.01">
            <span class="cost-info"> @ ${{ item.cost_per_unit }} = ${{ item.line_cost }}</span>
            <input type="hidden" name="unit_{{ loop.index0 }}" value="{{ item.unit }}">
        </div>
    {% endfor %}
        <input type="hidden" name="total_ingredients" value="{{ recipe.ingredients | length }}">
    </div>
        <div id="productFields">
            <div class="form-group">
                <label for="product_quantity">Product Quantity:</label>
                <input type="number" name="product_quantity" id="product_quantity_input" value="1" min="1" required>
                <input type="hidden" id="batchCostData" value="{{ batch_cost or 0 }}">
            </div>

            <div class="form-group">
                <label for="product_unit">Product Unit:</label>
                <select name="product_unit" required>
                    {% for unit in product_units %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="product_image">Product Image:</label>
                <input type="file" name="product_image" accept="image/*">
            </div>
        </div>

        <div id="ingredientFields" style="display: none;">
            <div class="form-group">
                <label for="ingredient_name">Ingredient Name:</label>
                <input type="text" name="ingredient_name" class="form-control" value="{{ batch.recipe_name }}" readonly>
            </div>

            <div class="form-group">
                <label for="ingredient_quantity">Yield Quantity:</label>
                <input type="number" name="ingredient_quantity" class="form-control" value="1" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="ingredient_unit">Unit:</label>
                <select name="ingredient_unit" class="form-select">
                    {% for unit in inventory_units %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#quickAddUnitModal">+ Add New Unit</button>
            </div>
        </div>

        <div class="form-group">
            <label for="tags">Tags (comma-separated):</label>
            <input type="text" name="tags" value="{{ batch.tags or '' }}">
        </div>

        <div class="extra-ingredients">
            <h4>Additional Ingredients Used</h4>
            <div id="ingredientInputs">
                <div class="ingredient-row">
                    <input type="text" name="extra_ingredients[]" placeholder="Ingredient name">
                    <input type="number" name="extra_amounts[]" placeholder="Amount" step="0.01">
                    <input type="text" name="extra_units[]" placeholder="Unit">
                </div>
            </div>
            <button type="button" onclick="addIngredientRow()" class="button secondary">+ Add Ingredient</button>
        </div>

        <div class="button-group">
            <button type="submit" name="action" value="finish" class="button primary">âœ“ Complete Batch</button>
            <button type="submit" name="action" value="fail" class="button warning">âœ• Mark as Failed</button>
        </div>
    </form>

    <form method="post" action="{{ url_for('batches.cancel_batch', batch_id=batch.id) }}" class="cancel-form">
        <button type="submit" class="button danger">â†© Cancel Batch</button>
    </form>
</div>
<div class="summary-section mt-4">
        <h4>Batch Summary</h4>
        <ul>
            <li><strong>Total Batch Cost:</strong> 
                <span id="totalBatchCost">${{ "%.2f"|format(batch_cost|float) if batch_cost is not none else "0.00" }}</span>
            </li>
            <li><strong>Product Quantity:</strong> 
                <span id="productQuantityPreview">â€”</span>
            </li>
            <li><strong>Unit Cost:</strong>
                <span id="unitCostPreview" class="text-muted">Calculating...</span>
            </li>
        </ul>
    </div>

    <script>
    function toggleOutputFields() {
        const type = document.getElementById('output_type').value;
        document.getElementById('productFields').style.display = type === 'product' ? 'block' : 'none';
        document.getElementById('ingredientFields').style.display = type === 'ingredient' ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const quantityInput = document.getElementById('product_quantity_input');
        const unitCostOutput = document.getElementById('unitCostPreview');
        const productQtyOutput = document.getElementById('productQuantityPreview');
        const batchCost = parseFloat(document.getElementById('batchCostData').value || 0);

        function updateUnitCost() {
            const qty = parseFloat(quantityInput.value);
            if (!qty || qty <= 0) {
                unitCostOutput.innerText = "â€”";
                productQtyOutput.innerText = "â€”";
                return;
            }

            const unitCost = batchCost / qty;
            productQtyOutput.innerText = qty;
            unitCostOutput.innerText = `$${unitCost.toFixed(2)}`;
        }

        quantityInput.addEventListener('input', updateUnitCost);
        updateUnitCost();
    });
    </script>
{% endblock %}