{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
</div>

{% if batch.containers %}
<div class="mt-4">
    <h4>Containers Planned:</h4>
    <ul class="list-group">
        {% for container in batch.containers %}
        <li class="list-group-item">
            Container ID: {{ container.id }} | Quantity: {{ container.quantity }}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<form id="batchForm" method="post" action="{{ url_for('batches.finish_batch', batch_id=batch.id) }}" enctype="multipart/form-data" onsubmit="return validateBatchForm()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" class="csrf-token">
    <!-- Output Type Selection -->
    <div class="form-group">
        <label for="output_type">Batch Type:</label>
        <div class="d-flex align-items-center gap-2">
            <select name="output_type" id="output_type" class="form-select" onchange="toggleOutputFields()" required>
                <option value="product">Product</option>
                <option value="ingredient">Ingredient</option>
            </select>
            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="What unit is this batch stored in? ex. 15 oz or 25 ml">?</button>
        </div>
    </div>

    <!-- Product Yield Section (Refined) -->
    <div id="productFields" class="form-group mt-4">
        <h4>Product Output</h4>

        <div class="mb-3">
            <label for="product_id" class="form-label">Link to Product</label>
            <select name="product_id" class="form-select" required>
                {% for product in products %}
                    <option value="{{ product.id }}">{{ product.name }}{% if product.variant %} ({{ product.variant }}){% endif %}</option>
                {% endfor %}
            </select>
            <a href="/products/new" class="btn btn-link">+ Add New Product</a>
        </div>

        <div class="mb-3">
            <label for="variant_label" class="form-label">Variant (optional)</label>
            <input type="text" class="form-control" name="variant_label" placeholder="e.g., 4 oz, Citrus">
        </div>

        <div class="mb-3">
            <label for="output_unit" class="form-label">Output Unit</label>
            <select name="output_unit" class="form-select" required>
                {% for unit in units %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="final_quantity" class="form-label">Final Quantity Produced</label>
            <input type="number" step="1" class="form-control" name="final_quantity" required>
        </div>
    </div>

    <!-- Ingredient Yield Section -->
    <div id="ingredientFields" class="form-group mt-4" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <label for="ingredient_unit" class="form-label mb-0">Unit Type:</label>
            <span class="text-muted">Projected yield: {{ batch.scale * recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}</span>
        </div>
        <select name="ingredient_unit" class="form-select mb-3" required>
            {% for unit in units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
        <label for="ingredient_quantity">Ingredient Yield:</label>
        <input type="number" name="ingredient_quantity" value="1" min="1" class="form-control" required>
    </div>


    <!-- INGREDIENT SECTION -->
    <div class="mt-4">
        <h4>Ingredients Used</h4>
        <div id="ingredient-list">
            {% for bi in ingredients %}
            <div class="ingredient-row d-flex gap-2 mb-2">
                <select name="ingredients[{{ loop.index0 }}][id]" class="form-select">
                    {% for ing in inventory_items if ing.type == 'ingredient' %}
                    <option value="{{ ing.id }}" {% if bi.ingredient_id == ing.id %}selected{% endif %}>{{ ing.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" step="0.01" name="ingredients[{{ loop.index0 }}][amount]" value="{{ bi.amount_used }}" class="form-control">
                <select name="ingredients[{{ loop.index0 }}][unit]" class="form-select">
                    {% for unit in units %}
                    <option value="{{ unit.name }}" {% if unit.name == bi.unit %}selected{% endif %}>{{ unit.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addIngredientRow()" class="btn btn-outline-secondary mt-2">+ Add Ingredient</button>
    </div>

    <!-- Recipe Snapshot Data -->
<input type="hidden" id="recipe-snapshot" value="{{ batch.recipe_snapshot|tojson if batch.recipe_snapshot else '[]' }}">

<!-- CONTAINER SECTION -->
<div class="mt-4">
    <h4>Containers Used</h4>
    <div id="container-list">
            {% for bc in containers %}
            <div class="container-row d-flex gap-2 mb-2">
                <select name="containers[{{ loop.index0 }}][id]" class="form-select">
                    {% for item in inventory_items if item.type == 'container' %}
                    <option value="{{ item.id }}" {% if bc.container_id == item.id %}selected{% endif %}>{{ item.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="containers[{{ loop.index0 }}][qty]" value="{{ bc.quantity_used }}" class="form-control" placeholder="Quantity">
                <input type="number" step="0.01" name="containers[{{ loop.index0 }}][cost_each]" value="{{ bc.cost_each or 0.0 }}" class="form-control" placeholder="Cost Each">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addContainerRow()" class="btn btn-outline-secondary mt-2">+ Add Container</button>
    </div>

    <!-- TIMER SECTION -->
    <div class="mt-4">
        <h4>Timers</h4>
        <div id="timer-list">
            {% for t in timers %}
            <div class="timer-row d-flex gap-2 mb-2">
                <input type="text" name="timers[{{ loop.index0 }}][name]" value="{{ t.name }}" class="form-control" placeholder="Timer Name">
                <input type="number" name="timers[{{ loop.index0 }}][duration_seconds]" value="{{ t.duration_seconds }}" class="form-control" placeholder="Duration (seconds)">
                <span class="text-muted align-self-center">(Started: {{ t.start_time.strftime('%Y-%m-%d %H:%M') if t.start_time else 'Not started' }})</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addTimerRow()" class="btn btn-outline-secondary mt-2">+ Add Timer</button>
    </div>

    <!-- Batch Cost Summary -->
    <div class="batch-summary mt-4">
        <h4>Batch Summary</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Amount Used</th>
                    <th>Unit</th>
                    <th>Cost/Unit</th>
                    <th>Line Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for cost in ingredient_costs %}
                <tr>
                    <td>{{ cost.name }}</td>
                    <td>{{ "%.2f"|format(cost.used) }}</td>
                    <td>{{ cost.unit }}</td>
                    <td>${{ "%.2f"|format(cost.cost_per_unit) }}</td>
                    <td>${{ "%.2f"|format(cost.line_cost) }}</td>
                </tr>
                {% endfor %}
                {% for container in containers %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ container.quantity_used }}</td>
                    <td>count</td>
                    <td>${{ "%.2f"|format(container.cost_each) }}</td>
                    <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                    <td><strong>${{ "%.2f"|format(batch_cost) if batch_cost else '0.00' }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>


    <!-- Notes Section -->
    <div class="notes-section mt-4">
        <h4>Batch Notes</h4>
        <textarea name="notes" rows="4" class="form-control">{{ batch.saved_notes or batch.notes or '' }}</textarea>
    </div>

    <!-- Tags Section -->
    <div class="form-group mt-3">
        <label for="tags">Tags (comma-separated):</label>
        <input type="text" name="tags" value="{{ batch.saved_tags or batch.tags or '' }}" class="form-control">
    </div>


    <!-- Submission Buttons -->
    <div class="button-group mt-4 d-flex justify-content-between">
        <div>
            <button type="button" onclick="saveBatch(event)" class="btn btn-primary me-2">Save & Exit</button>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning" onclick="cancelBatch()">Cancel Batch</button>
            <button type="button" onclick="finishBatch('fail')" class="btn btn-danger">Mark as Failed</button>
            {% set has_active_timers = batch.timers and batch.timers|selectattr('completed', 'equalto', False)|list|length > 0 %}
            {% if not has_active_timers %}
                <button type="button" onclick="finishBatch('finish')" class="btn btn-success">✓ Complete Batch</button>
            {% else %}
                <button type="button" class="btn btn-success" disabled>✓ Complete Batch</button>
                <a href="{{ url_for('batches.force_finish_batch', batch_id=batch.id) }}" class="btn btn-sm btn-outline-danger">Force Finish</a>
            {% endif %}
        </div>
    </div>
</form>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function toggleOutputFields() {
    const type = document.getElementById('output_type').value;
    const productFields = document.getElementById('productFields');
    const ingredientFields = document.getElementById('ingredientFields');

    productFields.style.display = type === 'product' ? 'block' : 'none';
    ingredientFields.style.display = type === 'ingredient' ? 'block' : 'none';

    const select = document.querySelector('[name="product_unit"]');
    const productUnits = select ? select.querySelectorAll('.product-unit') : [];
    const inventoryUnits = select ? select.querySelectorAll('.inventory-unit') : [];

    productUnits.forEach(opt => opt.style.display = type === 'product' ? '' : 'none');
    inventoryUnits.forEach(opt => opt.style.display = type === 'ingredient' ? '' : 'none');

    if (select) {
        select.value = '';
    }
}

function addIngredientRow() {
    const row = document.createElement('div');
    row.classList.add('ingredient-row', 'd-flex', 'gap-2', 'mb-2');
    row.innerHTML = `
        <select class="form-select ingredient-select" name="ingredients[]" data-placeholder="Search ingredients..." required>
            <option value="">Search ingredients...</option>
            {% for item in inventory_items if item.type == 'ingredient' %}
                <option value="{{ item.id }}">{{ item.name }} ({{ item.quantity }} {{ item.unit }} available)</option>
            {% endfor %}
        </select>
        <input type="number" step="0.01" class="form-control" name="amounts[]" placeholder="Amount" required>
        <select class="form-select unit-select" name="units[]" data-placeholder="Select unit..." required>
            <option value="">Select unit...</option>
            {% for unit in units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
    `;
    document.getElementById('ingredient-list').appendChild(row);
    initializeSelect2(row);
}

function addContainerRow() {
    const row = document.createElement('div');
    row.classList.add('container-row', 'd-flex', 'gap-2', 'mb-2');
    row.innerHTML = `
        <select class="form-select container-select" name="containers[]" required>
            <option value="">Select Container</option>
            {% for container in inventory_items if container.type == 'container' %}
                <option value="{{ container.id }}">{{ container.name }} ({{ container.storage_amount or 0 }} {{ container.storage_unit or 'units' }})</option>
            {% endfor %}
        </select>
        <input type="number" step="1" class="form-control" name="container_amounts[]" placeholder="Amount" required>
        <input type="number" step="0.01" class="form-control" name="container_costs[]" placeholder="Cost Each" required>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
    `;
    document.getElementById('container-list').appendChild(row);
    initializeSelect2(row);
}

function addTimerRow() {
    const container = document.getElementById('timer-list');
    const div = document.createElement('div');
    div.className = 'timer-row d-flex gap-2 mb-2';

    div.innerHTML = `
        <input type="text" name="timers[]" class="form-control me-2" placeholder="Timer Name" required>
        <input type="number" name="timer_durations[]" class="form-control me-2" placeholder="Duration (seconds)" required>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
    `;

    container.appendChild(div);
}

function initializeSelect2(container) {
    $(container).find('.ingredient-select').select2({
        placeholder: 'Search ingredients...',
        width: '100%'
    });

    $(container).find('.unit-select').select2({
        placeholder: 'Select unit',
        width: '100%'
    });

    $(container).find('.container-select').select2({
        placeholder: 'Select container',
        width: '100%'
    });
}

document.addEventListener('DOMContentLoaded', () => {
    $('.ingredient-select').select2({ 
        placeholder: 'Search ingredients...',
        width: '100%',
        allowClear: true
    });
    $('.unit-select').select2({ 
        placeholder: 'Select unit...',
        width: '100%',
        allowClear: true
    });
    $('.container-select').select2({
        placeholder: 'Select container',
        width: '100%',
        allowClear: true
    });
    toggleOutputFields();
});
</script>
{% endblock %}