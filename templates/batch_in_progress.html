
{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
</div>

<form method="post" action="{{ url_for('batches.finish_batch', batch_id=batch.id) }}" enctype="multipart/form-data">
    <!-- Notes Section -->
    <div class="notes-section">
        <h3>Batch Notes</h3>
        <textarea name="notes" rows="4" cols="50" class="form-control">{{ batch.notes or '' }}</textarea>
    </div>

    <!-- Tags Section -->
    <div class="form-group mt-2">
        <label for="tags">Tags (comma-separated):</label>
        <input type="text" name="tags" value="{{ batch.tags or '' }}" class="form-control">
    </div>

    <!-- Yield Section -->
    <div class="form-group mt-4">
        <label for="product_quantity">Batch Yield:
            <span title="Tell us how many units your batch produced." style="cursor: help;">‚ùî</span>
        </label>
        <input type="number" name="product_quantity" value="1" min="1" class="form-control" required>
    </div>

    <!-- Unit Selection -->
    <div class="form-group">
        <label for="product_unit">Unit Type:</label>
        <select name="product_unit" class="form-select" required>
            {% for unit in product_units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Extra Ingredients Used Section -->
    <div class="form-group mt-4">
        <button type="button" class="btn btn-outline-primary" onclick="addIngredientRow()">+ Extra Ingredients Used</button>
        <div id="ingredientInputs" class="mt-3"></div>
    </div>

    <!-- Timer Section -->
    <div class="form-group mt-4">
        <h4>Batch Timers</h4>
        <div id="timer-container"></div>
        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addTimer()">üóìÔ∏è Add Timer</button>
    </div>

    <!-- Submission Buttons -->
    <div class="button-group mt-4">
        <button type="submit" name="action" value="finish" class="btn btn-success">‚úì Complete Batch</button>
        <button type="submit" name="action" value="fail" class="btn btn-danger">‚úï Mark as Failed</button>
    </div>
</form>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function addIngredientRow() {
    const wrapper = document.getElementById('ingredientInputs');
    const row = document.createElement('div');
    row.classList.add('ingredient-row', 'mb-3');
    row.innerHTML = `
        <div class="d-flex gap-2 flex-wrap">
            <select name="extra_ingredients[]" class="form-select ingredient-select" style="min-width: 200px;" required>
                <option value="">Select Ingredient</option>
                {% for ing in all_ingredients %}
                <option value="{{ ing.id }}">{{ ing.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="extra_amounts[]" step="0.01" placeholder="Amount" class="form-control" style="width: 120px;" required>
            <select name="extra_units[]" class="form-select unit-select" style="min-width: 150px;" required>
                <option value="">Unit</option>
                {% for unit in inventory_units %}
                <option value="{{ unit.name }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.ingredient-row').remove()">‚ùå</button>
        </div>
    `;
    wrapper.appendChild(row);

    // Enable Select2 search boxes
    $(row.querySelector('.ingredient-select')).select2({
        placeholder: "Search Ingredient",
        allowClear: true
    });
    
    $(row.querySelector('.unit-select')).select2({
        placeholder: "Select Unit",
        allowClear: true
    });
}

// Initialize any existing Select2 dropdowns when page loads
$(document).ready(function() {
    $('.ingredient-select').select2({
        placeholder: "Search Ingredient",
        allowClear: true
    });
    
    $('.unit-select').select2({
        placeholder: "Select Unit",
        allowClear: true
    });
});

function addTimer() {
    const container = document.getElementById('timer-container');
    const div = document.createElement('div');
    div.classList.add('timer-entry', 'd-flex', 'align-items-center', 'gap-2', 'mb-2');
    div.innerHTML = `
        <input type="datetime-local" name="batch_timers[]" class="form-control" style="max-width: 250px;" required>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">‚ùå</button>
    `;
    container.appendChild(div);
}
</script>
{% endblock %}
