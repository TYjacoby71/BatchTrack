{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
</div>


<form id="batchForm" method="post" action="{{ url_for('finish_batch.complete_batch', batch_id=batch.id) }}" enctype="multipart/form-data" onsubmit="return validateBatchForm()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" class="csrf-token">
    <!-- Yield info will be handled in modal -->
    <div class="form-group mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Projected yield: {{ batch.scale * recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}</span>
        </div>
    </div>


<!-- EXTRA INGREDIENTS SECTION -->
<div class="mt-4" x-data="{ showExtras: false }">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Extra Ingredients Used</h4>
        <button type="button" class="btn btn-sm btn-outline-secondary" @click="showExtras = !showExtras">
            <span x-text="showExtras ? 'üîº Hide' : 'üîΩ Show'"></span>
        </button>
    </div>
    <div x-show="showExtras">
        <div id="extra-ingredients-container"></div>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraIngredientRow()">‚ûï Add Extra Ingredient</button>
        <button type="button" class="btn btn-primary" onclick="saveExtras()">üíæ Save Extras</button>
    </div>
</div>

<template id="extra-ingredient-template">
    <div class="extra-row d-flex gap-2 mb-2">
        <select class="form-select ingredient-select select2-input" style="width: 200px;" onchange="updateRowCost(this)">
            {% for ing in all_ingredients if ing.type == 'ingredient' %}
            <option value="{{ ing.id }}" data-cost="{{ ing.cost_per_unit }}">{{ ing.name }}</option>
            {% endfor %}
        </select>
        <input type="number" class="form-control qty" placeholder="Quantity" step="0.01" />
        <select class="form-select unit select2-input" style="width: 120px;">
            {% for unit in units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
        <input type="number" class="form-control cost" placeholder="Cost per unit" step="0.01" readonly />
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚úñ</button>
    </div>
</template>

    <!-- EXTRA CONTAINERS SECTION -->
<div class="mt-4" x-data="{ showContainers: false }">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Extra Containers Used</h4>
        <button type="button" class="btn btn-sm btn-outline-secondary" @click="showContainers = !showContainers">
            <span x-text="showContainers ? 'üîº Hide' : 'üîΩ Show'"></span>
        </button>
    </div>
    <div x-show="showContainers">
        <div id="extra-containers-container"></div>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addExtraContainerRow()">‚ûï Add Extra Container</button>
        <button type="button" class="btn btn-primary" onclick="saveExtraContainers()">üíæ Save Extra Containers</button>
    </div>
</div>

<template id="extra-container-template">
    <div class="extra-container-row d-flex gap-2 mb-2">
        <select class="form-select container-select select2-input" style="width: 200px;" onchange="updateRowCost(this)">
            {% for cont in inventory_items if cont.type == 'container' %}
            <option value="{{ cont.id }}" data-cost="{{ cont.cost_per_unit }}">{{ cont.name }}</option>
            {% endfor %}
        </select>
        <input type="number" class="form-control qty" placeholder="Quantity" step="1" min="1" />
        <input type="number" class="form-control cost" placeholder="Cost per unit" step="0.01" readonly />
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚úñ</button>
    </div>
</template>


<!-- Timer Section -->
    <div class="mt-4" x-data="{ 
      timers: [],
      newTimerName: '',
      newTimerDuration: '',
      addingTimer: false,
      timerCounter: 0,
      init() {
        this.timers = {{ batch.timers|map(attribute='to_dict')|list|tojson|safe }};
        this.updateTimers();
      },
      updateTimers() {
        this.timers = this.timers.map(timer => ({
          ...timer,
          timeLeft: this.calculateTimeLeft(timer),
          status: this.getTimerStatus(timer)
        }));
        setTimeout(() => this.updateTimers(), 1000);
      },
      calculateTimeLeft(timer) {
        if (!timer.start_time) return 'Not Started';
        const start = new Date(timer.start_time);
        const now = new Date();
        const duration = timer.duration_seconds * 1000;
        const diff = (start.getTime() + duration) - now.getTime();
        if (diff <= 0) return 'Expired';
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        return `${minutes}m ${seconds}s`;
      },
      getTimerStatus(timer) {
        if (timer.completed) return 'completed';
        if (!timer.start_time) return 'pending';
        const timeLeft = this.calculateTimeLeft(timer);
        return timeLeft === 'Expired' ? 'expired' : 'active';
      },
      async saveTimers() {
        try {
          const response = await fetch(`/timers/batch/${this.timers[0].batch_id}/save`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
              timers: this.timers.filter(t => !t.temp_id)
            })
          });
          if (response.ok) {
            const data = await response.json();
            this.timers = data.timers;
          }
        } catch (error) {
          console.error('Error saving timers:', error);
        }
      }

    }">
    <h4>Timers</h4>
    <template x-if="timers.length === 0">
        <p>No timers are currently running.</p>
    </template>
    
    <table class="table" x-show="timers.length > 0">
        <thead>
            <tr>
                <th>Name</th>
                <th>Duration</th>
                <th>Time Left</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="timer in timers" :key="timer.id">
                <tr :class="{
                    'table-danger': timer.status === 'expired',
                    'table-success': timer.status === 'completed',
                    'table-warning': timer.status === 'pending'
                }">
                    <td x-text="timer.name"></td>
                    <td x-text="timer.duration_string"></td>
                    <td>
                        <span x-text="timer.timeLeft"></span>
                        <span x-show="timer.status === 'expired'" class="badge bg-danger ms-2">‚è∞ Expired</span>
                    </td>
                    <td class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" 
                                x-show="!timer.completed && timer.status !== 'expired'"
                                @click="timer.completed = true; saveTimers()">Complete</button>
                        <button class="btn btn-sm btn-danger" 
                                @click="timers = timers.filter(t => t.id !== timer.id)">Remove</button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <div x-show="addingTimer">
        <input type="text" x-model="newTimerName" placeholder="Timer Name" class="form-control mb-2">
        <input type="text" x-model="newTimerDuration" placeholder="Duration (e.g., 1h30m)" class="form-control mb-2">
        <button class="btn btn-sm btn-success" @click="
            const durationSeconds = parseDuration(newTimerDuration);
            if (isNaN(durationSeconds)) {
                alert('Invalid duration format. Please use formats like 1h30m or 30m.');
                return;
            }
            timers.push({
                id: Math.random(), // Temporary ID
                name: newTimerName,
                duration_seconds: durationSeconds,
                duration_string: newTimerDuration,
                start_time: new Date().toISOString(),
                timeLeft: 'Calculating...'
            });
            newTimerName = '';
            newTimerDuration = '';
            addingTimer = false;
            updateTimers();
        ">Add Timer</button>
        <button class="btn btn-sm btn-secondary" @click="addingTimer = false">Cancel</button>
    </div>

    <button class="btn btn-sm btn-primary" x-show="!addingTimer" @click="addingTimer = true">‚ûï Add New Timer</button>
</div>

    <!-- Batch Cost Summary -->
    <!-- Batch Cost Summary -->
    <div class="batch-summary mt-4">
        <h4>Batch Summary</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Amount Used</th>
                    <th>Unit</th>
                    <th>Cost/Unit</th>
                    <th>Line Cost</th>
                </tr>
            </thead>
            <tbody>
                {% if batch.ingredients %}
                <tr><th colspan="5">Ingredients</th></tr>
                {% for ing in batch.ingredients %}
                <tr>
                    <td>{{ ing.ingredient.name }}</td>
                    <td>{{ "%.2f"|format(ing.amount_used) }}</td>
                    <td>{{ ing.unit }}</td>
                    <td>${{ "%.2f"|format(ing.cost_per_unit or 0) }}</td>
                    <td>${{ "%.2f"|format((ing.amount_used or 0) * (ing.cost_per_unit or 0)) }}</td>
                </tr>
                {% endfor %}
                {% set ingredient_total = (batch.ingredients|sum(attribute='amount_used') or 0) * (batch.ingredients|sum(attribute='ingredient.cost_per_unit') or 0) %}
                <tr>
                    <td colspan="4" class="text-end"><em>Ingredients Subtotal:</em></td>
                    <td>${{ "%.2f"|format(ingredient_total) }}</td>
                </tr>
                {% endif %}

                {% if batch.containers %}
                <tr><th colspan="5">Containers</th></tr>
                {% for container in batch.containers %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ container.quantity_used }}</td>
                    <td></td>
                    <td>${{ "%.2f"|format(container.cost_each) }}</td>
                    <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                </tr>
                {% endfor %}
                {% set container_total = (batch.containers|sum(attribute='quantity_used') or 0) * (batch.containers|sum(attribute='cost_each') or 0) %}
                <tr>
                    <td colspan="4" class="text-end"><em>Containers Subtotal:</em></td>
                    <td>${{ "%.2f"|format(container_total) }}</td>
                </tr>
                {% endif %}

                {% if batch.extra_ingredients %}
                <tr><th colspan="5">Extra Ingredients</th></tr>
                {% for extra in batch.extra_ingredients %}
                <tr>
                    <td>{{ extra.ingredient.name }}</td>
                    <td>{{ "%.3f"|format(extra.quantity) }}</td>
                    <td>{{ extra.unit }}</td>
                    <td>${{ "%.2f"|format(extra.cost_per_unit or 0) }}</td>
                    <td>${{ "%.2f"|format((extra.quantity or 0) * (extra.cost_per_unit or 0)) }}</td>
                </tr>
                {% endfor %}
                {% set extras_total = (batch.extra_ingredients|sum(attribute='quantity') or 0) * (batch.extra_ingredients|sum(attribute='cost_per_unit') or 0) %}
                <tr>
                    <td colspan="4" class="text-end"><em>Extra Ingredients Subtotal:</em></td>
                    <td>${{ "%.2f"|format(extras_total) }}</td>
                </tr>
                {% endif %}

                {% if batch.extra_containers %}
                <tr><th colspan="5">Extra Containers</th></tr>
                {% for container in batch.extra_containers %}
                <tr>
                    <td>{{ container.container.name }}</td>
                    <td>{{ container.quantity_used }}</td>
                    <td></td>
                    <td>${{ "%.2f"|format(container.cost_each) }}</td>
                    <td>${{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                </tr>
                {% endfor %}
                {% set extra_container_total = (batch.extra_containers|sum(attribute='quantity_used') or 0) * (batch.extra_containers|sum(attribute='cost_each') or 0) %}
                <tr>
                    <td colspan="4" class="text-end"><em>Extra Containers Subtotal:</em></td>
                    <td>${{ "%.2f"|format(extra_container_total) }}</td>
                </tr>
                {% endif %}
            </tbody>

            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                    <td><strong>${{ "%.2f"|format(batch_cost) if batch_cost else '0.00' }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>



    <!-- Notes Section -->
    <div class="notes-section mt-4">
        <h4>Batch Notes</h4>
        <textarea name="notes" rows="4" class="form-control">{{ batch.notes or '' }}</textarea>
    </div>

    <!-- Tags Section -->
    <div class="form-group mt-3">
        <label for="tags">Tags (comma-separated):</label>
        <input type="text" name="tags" value="{{ batch.tags or '' }}" class="form-control">
    </div>


    <!-- Submission Buttons -->
    <div class="button-group mt-4 d-flex justify-content-between">
        <div>
            <button type="button" onclick="saveBatchAndExit()" class="btn btn-secondary">Save and Exit</button>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning" onclick="cancelBatch()">Cancel Batch</button>
            <button type="button" class="btn btn-danger" onclick="markBatchFailed()">‚ö†Ô∏è Mark Failed</button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finishBatchModal">‚úì Complete Batch</button>
            {% include 'components/batch/finish_batch_modal.html' %}
            {% if has_active_timers %}
                <a href="{{ url_for('batches.force_finish_batch', batch_id=batch.id) }}" class="btn btn-sm btn-outline-danger">Force Finish</a>
            {% endif %}
        </div>
    </div>
</form>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{{ url_for('static', filename='js/batches/batch_form.js') }}"></script>

<script>
    function parseDuration(durationString) {
        const regex = /(\d+h)?(\d+m)?(\d+s)?/;
        const matches = durationString.match(regex);

        if (!matches) {
            return NaN;
        }

        let hours = matches[1] ? parseInt(matches[1]) : 0;
        let minutes = matches[2] ? parseInt(matches[2]) : 0;
        let seconds = matches[3] ? parseInt(matches[3]) : 0;

        return hours * 3600 + minutes * 60 + seconds;
    }
</script>

{% endblock %}