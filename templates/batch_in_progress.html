{% extends 'layout.html' %}
{% block content %}
<h2>Batch In Progress</h2>

<div class="batch-details">
    <p><strong>Label Code:</strong> {{ batch.label_code }}</p>
    <p><strong>Recipe:</strong> {{ batch.recipe_name }}</p>
    <p><strong>Scale Planned:</strong> {{ batch.scale }}</p>
    <p><strong>Started:</strong> {{ batch.started_at.strftime('%Y-%m-%d %H:%M') }}</p>
</div>


<form id="batchForm" method="post" action="{{ url_for('batches.finish_batch', batch_id=batch.id) }}" enctype="multipart/form-data" onsubmit="return validateBatchForm()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" class="csrf-token">
    <!-- Yield info will be handled in modal -->
    <div class="form-group mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Projected yield: {{ batch.scale * recipe.predicted_yield }} {{ recipe.predicted_yield_unit }}</span>
        </div>
    </div>


    <!-- INGREDIENT SECTION -->
    <div class="mt-4">
        <h4>Ingredients Used</h4>
        <div id="ingredient-list">
            {% for bi in ingredients %}
            <div class="ingredient-row d-flex gap-2 mb-2">
                <select name="ingredients[{{ loop.index0 }}][id]" class="form-select" disabled>
                    {% for ing in inventory_items if ing.type == 'ingredient' %}
                    <option value="{{ ing.id }}" {% if bi.ingredient_id == ing.id %}selected{% endif %}>{{ ing.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" step="0.01" name="ingredients[{{ loop.index0 }}][amount]" value="{{ bi.amount_used }}" class="form-control" disabled>
                <select name="ingredients[{{ loop.index0 }}][unit]" class="form-select" disabled>
                    {% for unit in units %}
                    <option value="{{ unit.name }}" {% if unit.name == bi.unit %}selected{% endif %}>{{ unit.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- CONTAINER SECTION -->
    <div class="mt-4">
        <h4>Containers Used</h4>
        <div id="container-list">
            {% for bc in containers %}
            <div class="container-row d-flex gap-2 mb-2">
                <select name="containers[{{ loop.index0 }}][id]" class="form-select" disabled>
                    {% for item in inventory_items if item.type == 'container' %}
                    <option value="{{ item.id }}" {% if bc.container_id == item.id %}selected{% endif %}>{{ item.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="containers[{{ loop.index0 }}][qty]" value="{{ bc.quantity_used }}" class="form-control" placeholder="Quantity" disabled>
                <input type="number" step="0.01" name="containers[{{ loop.index0 }}][cost_each]" value="{{ bc.cost_each or 0.0 }}" class="form-control" placeholder="Cost Each" disabled>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- TIMER SECTION -->
    <div class="mt-4">
        <h4>Timers</h4>
        <div id="timer-list">
            {% for t in timers %}
            <div class="timer-row d-flex gap-2 mb-2">
                <input type="text" name="timers[{{ loop.index0 }}][name]" value="{{ t.name }}" class="form-control" placeholder="Timer Name">
                <input type="number" name="timers[{{ loop.index0 }}][duration_seconds]" value="{{ t.duration_seconds }}" class="form-control" placeholder="Duration (seconds)">
                <span class="text-muted align-self-center">(Started: {{ t.start_time.strftime('%Y-%m-%d %H:%M') if t.start_time else 'Not started' }})</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">✕</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addTimerRow()" class="btn btn-outline-secondary mt-2">+ Add Timer</button>
    </div>

    <!-- Batch Cost Summary -->
    <div class="batch-summary mt-4">
        <h4>Batch Summary</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Amount Used</th>
                    <th>Unit</th>
                    <th>Cost/Unit</th>
                    <th>Line Cost</th>
                </tr>
            </thead>
            <tbody>
              {% if batch.ingredients %}
                <tr><th colspan="5">Ingredients</th></tr>
                {% for ing in batch.ingredients %}
                  <tr>
                    <td>{{ ing.ingredient.name }}</td>
                    <td>{{ "%.2f"|format(ing.amount_used) }}</td>
                    <td>{{ ing.unit }}</td>
                    <td>{{ "%.2f"|format(ing.ingredient.cost_per_unit or 0) }}</td>
                    <td>{{ "%.2f"|format((ing.amount_used or 0) * (ing.ingredient.cost_per_unit or 0)) }}</td>
                  </tr>
                {% endfor %}
              {% endif %}

              {% if batch.containers %}
                <tr><th colspan="5">Containers</th></tr>
                {% for container in batch.containers %}
                  <tr>
                    <td>{{ container.container.name }} ({{ container.container_id }})</td>
                    <td>{{ container.quantity_used }}</td>
                    <td></td>
                    <td>{{ "%.2f"|format(container.cost_each) }}</td>
                    <td>{{ "%.2f"|format(container.quantity_used * container.cost_each) }}</td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>

            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><strong>Total Batch Cost:</strong></td>
                    <td><strong>${{ "%.2f"|format(batch_cost) if batch_cost else '0.00' }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>


    <!-- Notes Section -->
    <div class="notes-section mt-4">
        <h4>Batch Notes</h4>
        <textarea name="notes" rows="4" class="form-control">{{ batch.notes or '' }}</textarea>
    </div>

    <!-- Tags Section -->
    <div class="form-group mt-3">
        <label for="tags">Tags (comma-separated):</label>
        <input type="text" name="tags" value="{{ batch.tags or '' }}" class="form-control">
    </div>


    <!-- Submission Buttons -->
    <div class="button-group mt-4 d-flex justify-content-between">
        <div>
            <button type="button" onclick="saveBatch(event)" class="btn btn-primary me-2">Save</button>
            <a href="{{ url_for('batches.list_batches') }}" class="btn btn-secondary">Exit</a>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning" onclick="cancelBatch()">Cancel Batch</button>
            <button type="button" class="btn btn-danger" onclick="markBatchFailed()">⚠️ Mark Failed</button>
            <button type="button" onclick="showFinishBatchModal()" class="btn btn-success">✓ Complete Batch</button>
            {% include 'components/batch/finish_batch_modal.html' %}
            {% set has_active_timers = batch.timers and batch.timers|selectattr('completed', 'equalto', False)|list|length > 0 %}
            {% if has_active_timers %}
                <button type="button" class="btn btn-success" disabled>✓ Complete Batch</button>
                <a href="{{ url_for('batches.force_finish_batch', batch_id=batch.id) }}" class="btn btn-sm btn-outline-danger">Force Finish</a>
            {% endif %}
        </div>
    </div>
</form>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{{ url_for('static', filename='js/batches/batch_form.js') }}"></script>

{% endblock %}