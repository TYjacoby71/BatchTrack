{% extends 'layout.html' %}
{% block content %}

{% set preselect_ingredient_id = session.pop('preselect_ingredient_id', None) %}
{% set add_ingredient_line = session.pop('add_ingredient_line', False) %}

<h2>
    {% if recipe %}
        {% if recipe.parent_id %}Edit Variation{% else %}Edit Recipe{% endif %}
    {% else %}
        {% if is_variation %}New Variation{% else %}New Recipe{% endif %}
    {% endif %}
</h2>

{% if recipe and recipe.parent %}
<div class="alert alert-info mb-3">
    <strong>Variation of:</strong> {{ recipe.parent.name }}
</div>
{% elif is_variation and parent_recipe %}
<div class="alert alert-info mb-3">
    <strong>New Variation:</strong> Based on {{ parent_recipe.name }}
</div>
{% elif is_clone and recipe %}
<div class="alert alert-info mb-3">
    <strong>Creating a copy of:</strong> {{ recipe.name }}
</div>
{% endif %}

<form method="post" action="{{ url_for('recipes.new_recipe' if is_clone else ('recipes.create_variation' if is_variation else ('recipes.edit_recipe' if recipe and not is_clone else 'recipes.new_recipe')), recipe_id=recipe.parent_id if is_variation else (recipe.id if recipe and not is_clone else None)) }}" id="recipeForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% if is_clone %}<input type="hidden" name="is_clone" value="true">{% endif %}

    <div class="form-group">
        <label for="name">{% if recipe and recipe.parent_id or is_variation %}Variation Name{% else %}Recipe Name{% endif %}:</label>
        <input type="text" name="name" value="{{ recipe.name if recipe else '' }}" required>
    </div>

    <div class="form-group">
        <label for="instructions">Instructions:</label>
        <textarea name="instructions" rows="4">{{ recipe.instructions if recipe else '' }}</textarea>
    </div>

    <div class="form-group">
        <label for="label_prefix">Label Prefix:</label>
        <input type="text" name="label_prefix" value="{{ recipe.label_prefix if recipe else '' }}" maxlength="8">
    </div>

    <div class="form-group">
        <label for="predicted_yield">Projected Yield Amount:</label>
        <input type="number" class="form-control" id="predicted_yield" name="predicted_yield" value="{{ recipe.predicted_yield if recipe else '' }}" step="0.01" min="0">
    </div>

    <div class="form-group">
        <label for="predicted_yield_unit">Projected Yield Unit:</label>
        <select class="form-select" id="predicted_yield_unit" name="predicted_yield_unit">
            <option value="">Select Unit</option>
            <option value="oz" {% if recipe and recipe.predicted_yield_unit == 'oz' %}selected{% endif %}>Ounces (oz)</option>
            <option value="ml" {% if recipe and recipe.predicted_yield_unit == 'ml' %}selected{% endif %}>Milliliters (ml)</option>
            <option value="g" {% if recipe and recipe.predicted_yield_unit == 'g' %}selected{% endif %}>Grams (g)</option>
            <option value="count" {% if recipe and recipe.predicted_yield_unit == 'count' %}selected{% endif %}>Count (units)</option>
        </select>
    </div>

    <hr>

    <div class="form-group">
        <label>Does this recipe require containers?</label>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="requires_containers" id="requiresContainers" {% if recipe and recipe.requires_containers %}checked{% endif %}>
            <label class="form-check-label" for="requiresContainers">
              Yes, this recipe needs containers.
            </label>
        </div>
    </div>

    <div class="form-group" id="allowedContainersSection" style="{% if not (recipe and recipe.requires_containers) %}display:none;{% endif %}">
        <label for="allowed_containers">Select Allowed Containers:</label>
        <select id="allowed_containers" name="allowed_containers[]" class="form-select container-select" multiple>
            {% for container in all_ingredients if container.type == 'container' %}
            <option value="{{ container.id }}" {% if recipe and container.id in recipe.allowed_containers %}selected{% endif %}>
                {{ container.name }} ({{ container.storage_amount }} {{ container.storage_unit }})
            </option>
            {% endfor %}
        </select>
    </div>

    <hr>

    <div class="form-group">
        <label>Ingredients:</label>
        <button type="button" onclick="addIngredient()">Add Ingredient</button>
        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#quickAddIngredientModal" onclick="setIngredientReturnContext('main')">Quick Add Ingredient</button>
        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#quickAddContainerModal" onclick="setIngredientReturnContext('main')">Quick Add Container</button>
        <div id="ingredients-container">
            {% if recipe and recipe.recipe_ingredients %}
                {% for assoc in recipe.recipe_ingredients %}
                <div class="ingredient-entry">
                    <select name="ingredient_ids[]" required>
                        <option value="">Select an ingredient</option>
                        {% for available_ing in all_ingredients if available_ing.type != 'container' %}
                        <option value="{{ available_ing.id }}" {% if available_ing.id == assoc.inventory_item_id %}selected{% endif %}>{{ available_ing.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" step="0.01" name="amounts[]" value="{{ assoc.amount }}" required>
                    <select name="units[]" required>
                        {% for unit in inventory_units %}
                        <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>{{ unit.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <hr>

    <div class="form-group mt-3 d-flex justify-content-between">
        <div>
            <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary">Cancel</a>
            {% if recipe and not is_clone and not is_variation and not parent_recipe %}
            <button type="button" class="btn btn-danger" onclick="confirmDelete({{ recipe.id }}, {{ 'true' if recipe.parent_id else 'false' }}, {{ recipe.variations|length }})">
                {% if recipe.parent_id %}Delete Variation{% elif recipe.variations %}Delete Recipe & Variations{% else %}Delete Recipe{% endif %}
            </button>
            {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">{% if recipe and recipe.parent_id or is_variation %}Save Variation{% else %}Save Recipe{% endif %}</button>
    </div>
</form>

{% include 'quick_add_ingredient_modal.html' %}

<!-- Quick Add Container Modal -->
<div class="modal fade" id="quickAddContainerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Container</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddContainerForm">
          <div class="mb-3">
            <label for="containerName" class="form-label">Container Name</label>
            <input type="text" class="form-control" id="containerName" required>
          </div>
          <div class="mb-3">
            <label for="storageAmount" class="form-label">Storage Amount</label>
            <input type="number" class="form-control" id="storageAmount" step="0.01" required>
          </div>
          <div class="mb-3">
            <label for="storageUnit" class="form-label">Storage Unit</label>
            <select class="form-select" id="storageUnit" required>
              <option value="">Select Unit</option>
              {% for unit in inventory_units %}
              <option value="{{ unit.name }}">{{ unit.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Add Container</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let PRESELECT_INGREDIENT_ID = {{ preselect_ingredient_id or 'null' }};
let SHOULD_ADD_LINE = {{ 'true' if add_ingredient_line else 'false' }};
let ingredientReturnContext = 'main';

document.addEventListener('DOMContentLoaded', function() {
    if (SHOULD_ADD_LINE && PRESELECT_INGREDIENT_ID) {
        addIngredient(PRESELECT_INGREDIENT_ID);
    }

    const requiresContainersCheckbox = document.getElementById('requiresContainers');
    const allowedContainersSection = document.getElementById('allowedContainersSection');

    if (requiresContainersCheckbox && allowedContainersSection) {
        requiresContainersCheckbox.addEventListener('change', function() {
            allowedContainersSection.style.display = this.checked ? 'block' : 'none';
        });
    }

    const quickAddContainerForm = document.getElementById('quickAddContainerForm');
    if (quickAddContainerForm) {
        quickAddContainerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('containerName').value;
            const amount = document.getElementById('storageAmount').value;
            const unit = document.getElementById('storageUnit').value;

            fetch('/quick-add/container', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ name, storage_amount: amount, storage_unit: unit })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) throw new Error(data.error);

                const containerSelect = document.getElementById('allowed_containers');
                if (containerSelect) {
                    const option = new Option(
                        `${data.name} (${data.storage_amount} ${data.storage_unit})`,
                        data.id,
                        false,
                        true
                    );
                    containerSelect.add(option);
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddContainerModal'));
                if (modal) modal.hide();

                // Reset form
                quickAddContainerForm.reset();
            })
            .catch(err => alert('Failed to add container: ' + err.message));
        });
    }
});

function addIngredient(preselectId = null) {
    const container = document.getElementById('ingredients-container');
    const entry = document.createElement('div');
    entry.classList.add('ingredient-entry');
    entry.innerHTML = `
        <select name="ingredient_ids[]" required>
            <option value="">Select an ingredient</option>
            {% for ing in all_ingredients if ing.type != 'container' %}
            <option value="{{ ing.id }}">{{ ing.name }}</option>
            {% endfor %}
        </select>
        <input type="number" step="0.01" name="amounts[]" required>
        <select name="units[]" required>
            {% for unit in inventory_units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
        </select>
        <button type="button" onclick="this.parentElement.remove()">Remove</button>
    `;
    container.appendChild(entry);
    if (preselectId) {
        const select = entry.querySelector('select[name="ingredient_ids[]"]');
        if (select) select.value = preselectId;
    }
    entry.scrollIntoView({ behavior: 'smooth' });
    return entry;
}

function confirmDelete(recipeId, isVariation, variationCount) {
    let msg;
    if (isVariation) {
        msg = 'Are you sure you want to delete this variation?';
    } else if (variationCount > 0) {
        msg = 'Deleting the parent recipe will delete all variations under it.';
    } else {
        msg = 'Are you sure you want to delete this recipe?';
    }

    if (confirm(msg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/recipes/${recipeId}/delete`;

        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = '{{ csrf_token() }}';

        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    }
}

function setIngredientReturnContext(context) {
    ingredientReturnContext = context;
}
</script>

{% endblock %}