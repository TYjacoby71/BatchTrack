{% extends 'layout.html' %}
{% block content %}
<h2>{% if recipe %}Edit{% else %}New{% endif %} Recipe</h2>

{% if recipe %}
  <form method="post" action="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}">
{% else %}
  <form method="post" action="{{ url_for('recipes.new_recipe') }}">
{% endif %}

    <div class="form-group">
        <label for="name">Recipe Name:</label>
        <input type="text" name="name" value="{{ recipe.name if recipe else '' }}" required>
    </div>

    <div class="form-group">
        <label for="instructions">Instructions:</label>
        <textarea name="instructions" rows="4">{{ recipe.instructions if recipe else '' }}</textarea>
    </div>

    <div class="form-group">
        <label for="label_prefix">Label Prefix:</label>
        <input type="text" name="label_prefix" value="{{ recipe.label_prefix if recipe else '' }}" maxlength="8">
    </div>

    <div class="form-group">
        <label>Ingredients:</label>
        <button type="button" onclick="addIngredient()">Add Ingredient</button>
        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#quickAddIngredientModal" onclick="setIngredientReturnContext('main')">Quick Add Ingredient</button>
        <div id="ingredients-container">
            {% if recipe and recipe.recipe_ingredients %}
                {% for assoc in recipe.recipe_ingredients %}
                <div class="ingredient-entry">
                    <select name="ingredient_ids[]" required>
                        <option value="">Select an ingredient</option>
                        {% for available_ing in all_ingredients %}
                        <option value="{{ available_ing.id }}" {% if available_ing.id == assoc.ingredient.id %}selected{% endif %}>
                            {{ available_ing.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="number" step="0.01" name="amounts[]" value="{{ assoc.amount }}" required>
                    <select name="units[]" required>
                        {% for unit in inventory_units %}
                        <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>
                            {{ unit.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="form-group mt-3">
        <button type="submit" class="btn btn-primary">Save Recipe</button>
    </div>
</form>

<!-- Quick Add Ingredient Modal -->
<div class="modal fade" id="quickAddIngredientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Ingredient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="quickIngredientName" class="form-label">Ingredient Name</label>
          <input type="text" class="form-control" id="quickIngredientName">
        </div>
        <div class="mb-3">
          <label for="quickIngredientUnit" class="form-label">Unit</label>
          <select id="quickIngredientUnit" class="form-select">
            {% for unit in inventory_units %}
            <option value="{{ unit.name }}">{{ unit.name }}</option>
            {% endfor %}
          </select>
          <a href="#" data-bs-toggle="modal" data-bs-target="#quickAddUnitModal" onclick="setUnitReturnContext('ingredient')" data-bs-dismiss="modal">+ Add New Unit</a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveQuickIngredient">Add Ingredient</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Add Unit Modal -->
<div class="modal fade" id="quickAddUnitModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Unit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUnitForm">
          <div class="mb-3">
            <label for="unitName" class="form-label">Unit Name</label>
            <input type="text" class="form-control" id="unitName" required>
          </div>
          <div class="mb-3">
            <label for="unitType" class="form-label">Type</label>
            <select class="form-select" id="unitType">
              <option value="count">Count</option>
              <option value="volume">Volume</option>
              <option value="weight">Weight</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveQuickUnit">Add Unit</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap + Logic -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables
const PRESELECT_INGREDIENT_ID = {{ preselect_ingredient_id or 'null' }};
const SHOULD_ADD_LINE = {{ 'true' if add_ingredient_line else 'false' }};
let ingredientReturnContext = 'main';
let lastIngredientDropdown = null;
let unitReturnContext = 'main';

// Functions
function setUnitReturnContext(context) {
  unitReturnContext = context;
}

function addIngredient(preselectId = null) {
  const container = document.getElementById('ingredients-container');
  const entry = document.createElement('div');
  entry.classList.add('ingredient-entry');
  entry.innerHTML = `
    <select name="ingredient_ids[]" required>
      <option value="">Select an ingredient</option>
      {% for ing in all_ingredients %}
      <option value="{{ ing.id }}" ${preselectId === {{ ing.id }} ? 'selected' : ''}>{{ ing.name }}</option>
      {% endfor %}
    </select>
    <input type="number" step="0.01" name="amounts[]" required>
    <select name="units[]" required>
      {% for unit in inventory_units %}
      <option value="{{ unit.name }}">{{ unit.name }}</option>
      {% endfor %}
    </select>
    <button type="button" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(entry);
  if (preselectId) {
    const select = entry.querySelector('select[name="ingredient_ids[]"]');
    if (select) select.value = preselectId;
  }
  entry.scrollIntoView({ behavior: 'smooth' });
  return entry;
}

function setIngredientReturnContext(source, dropdown = null) {
  ingredientReturnContext = source;
  lastIngredientDropdown = dropdown;
}

function addIngredient(preselectId = null) {
  const container = document.getElementById('ingredients-container');
  const entry = document.createElement('div');
  entry.classList.add('ingredient-entry');
  entry.innerHTML = `
    <select name="ingredient_ids[]" required>
      <option value="">Select an ingredient</option>
      {% for ing in all_ingredients %}
      <option value="{{ ing.id }}">{{ ing.name }}</option>
      {% endfor %}
    </select>
    <input type="number" step="0.01" name="amounts[]" required>
    <select name="units[]" required>
      {% for unit in inventory_units %}
      <option value="{{ unit.name }}">{{ unit.name }}</option>
      {% endfor %}
    </select>
    <button type="button" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(entry);
  if (preselectId) {
    const select = entry.querySelector('select[name="ingredient_ids[]"]');
    if (select) select.value = preselectId;
  }
  entry.scrollIntoView({ behavior: 'smooth' });
  return entry;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  // Handle initial ingredient line if needed
  if (SHOULD_ADD_LINE && PRESELECT_INGREDIENT_ID) {
    addIngredient(PRESELECT_INGREDIENT_ID);
  }

  // Quick Add Unit Handler
  document.getElementById('saveQuickUnit').addEventListener('click', function() {
  const name = document.getElementById('unitName').value.trim();
  const type = document.getElementById('unitType').value;
  const button = this;

  if (!name) return alert('Unit name required.');

  button.disabled = true;
  button.innerText = "Saving...";

  fetch('/quick-add/unit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, type })
  })
  .then(async response => {
    if (!response.ok) {
      const err = await response.text();
      throw new Error(err);
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert("Error: " + data.error);
      return;
    }

    // Add new unit to all unit dropdowns in the main form
    document.querySelectorAll("select[name='units[]']").forEach(select => {
      const option = new Option(data.name, data.name, false, true);
      select.add(option);
    });

    // Add it to the unit dropdown in the ingredient modal
    const quickUnit = document.getElementById('quickIngredientUnit');
    const quickOption = new Option(data.name, data.name, false, true);
    quickUnit.add(quickOption);
    quickUnit.value = data.name;

    // Close modal and remove overlay
    const unitModalEl = document.getElementById('quickAddUnitModal');
    const unitModal = bootstrap.Modal.getInstance(unitModalEl) || new bootstrap.Modal(unitModalEl);
    unitModal.hide();
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

    // Reopen ingredient modal if needed
    if (unitReturnContext === 'ingredient') {
      setTimeout(() => {
        const ingredientModalEl = document.getElementById('quickAddIngredientModal');
        const ingredientModal = bootstrap.Modal.getInstance(ingredientModalEl) || new bootstrap.Modal(ingredientModalEl);
        ingredientModal.show();
      }, 250);
    }

    // Reset form + state
    document.getElementById('unitName').value = '';
    document.getElementById('unitType').selectedIndex = 0;
    unitReturnContext = 'main';
  })
  .catch(error => {
    console.error("Unit Add Error:", error);
    alert("Something went wrong while adding the unit.");
  })
  .finally(() => {
    button.disabled = false;
    button.innerText = "Add Unit";
  });
});
    });
  });

  // Quick Add Ingredient Handler
  document.getElementById('saveQuickIngredient').addEventListener('click', function() {
    const name = document.getElementById('quickIngredientName').value.trim();
    const unit = document.getElementById('quickIngredientUnit').value;

    if (!name || !unit) {
      alert('Both name and unit are required.');
      return;
    }

    const button = this;
    button.disabled = true;
    button.innerText = 'Adding...';

    fetch('/ingredients/quick-add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, unit })
    })
    .then(async response => {
      if (!response.ok) {
        const err = await response.text();
        throw new Error(err);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }

      // Close modal and clean up
      const modal = document.getElementById('quickAddIngredientModal');
      let bsModal = bootstrap.Modal.getInstance(modal);
      if (!bsModal) bsModal = new bootstrap.Modal(modal);
      bsModal.hide();

      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

      // Add new ingredient entry
      const entry = addIngredient(data.id);

      // Reset the form
      document.getElementById('quickIngredientName').value = '';
      document.getElementById('quickIngredientUnit').selectedIndex = 0;

      // Reset context
      ingredientReturnContext = 'main';
      lastIngredientDropdown = null;
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to add ingredient. Please try again.');
    })
    .finally(() => {
      button.disabled = false;
      button.innerText = 'Add Ingredient';
    });
  });
});
</script>
{% endblock %}