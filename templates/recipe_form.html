{% extends 'layout.html' %}
{% block content %}
<h2>
    {% if recipe %}
        {% if recipe.parent_id %}Edit Variation{% else %}Edit Recipe{% endif %}
    {% else %}
        {% if is_variation %}New Variation{% else %}New Recipe{% endif %}
    {% endif %}
</h2>

{% if recipe and recipe.parent %}
<div class="alert alert-info mb-3">
    <strong>Variation of:</strong> {{ recipe.parent.name }}
</div>
{% elif is_variation and parent_recipe %}
<div class="alert alert-info mb-3">
    <strong>New Variation:</strong> Based on {{ parent_recipe.name }}
</div>
{% endif %}

{% if recipe %}
  <form method="post" action="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}" id="recipeForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{% else %}
  <form method="post" action="{{ url_for('recipes.new_recipe') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{% endif %}

    <div class="form-group">
        <label for="name">{% if recipe and recipe.parent_id or is_variation %}Variation Name{% else %}Recipe Name{% endif %}:</label>
        <input type="text" name="name" value="{{ recipe.name if recipe else '' }}" required>
    </div>

    <div class="form-group">
        <label for="instructions">Instructions:</label>
        <textarea name="instructions" rows="4">{{ recipe.instructions if recipe else '' }}</textarea>
    </div>

    <div class="form-group">
        <label for="label_prefix">Label Prefix:</label>
        <input type="text" name="label_prefix" value="{{ recipe.label_prefix if recipe else '' }}" maxlength="8">
    </div>

    <div class="form-group">
        <label>Ingredients:</label>
        <button type="button" onclick="addIngredient()">Add Ingredient</button>
        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#quickAddIngredientModal" onclick="setIngredientReturnContext('main')">Quick Add Ingredient</button>
        <div id="ingredients-container">
            {% if recipe and recipe.recipe_ingredients %}
                {% for assoc in recipe.recipe_ingredients %}
                <div class="ingredient-entry">
                    <select name="ingredient_ids[]" required>
                        <option value="">Select an ingredient</option>
                        {% for available_ing in all_ingredients %}
                        <option value="{{ available_ing.id }}" {% if available_ing.id == assoc.inventory_item_id %}selected{% endif %}>
                            {{ available_ing.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="number" step="0.01" name="amounts[]" value="{{ assoc.amount }}" required>
                    <select name="units[]" required>
                        {% for unit in inventory_units %}
                        <option value="{{ unit.name }}" {% if unit.name == assoc.unit %}selected{% endif %}>
                            {{ unit.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="form-group mt-3 d-flex justify-content-between">
        <div>
            <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-secondary">Cancel</a>
            {% if recipe and edit_mode %}
            <form method="post" action="{{ url_for('recipes.delete_recipe', recipe_id=recipe.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if recipe.parent_id %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this variation? This action cannot be undone.')">Delete Variation</button>
                {% elif recipe.variations %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this recipe and ALL its variations? This action cannot be undone.')">Delete Recipe & Variations</button>
                {% else %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this recipe? This action cannot be undone.')">Delete Recipe</button>
                {% endif %}
            </form>
            {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">Save Recipe</button>
    </div>
</form>

{% include 'quick_add_ingredient_modal.html' %}

<!-- Quick Add Unit Modal -->
<div class="modal fade" id="quickAddUnitModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Add Unit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUnitForm">
          <div class="mb-3">
            <label for="unitName" class="form-label">Unit Name</label>
            <input type="text" class="form-control" id="unitName" required>
          </div>
          <div class="mb-3">
            <label for="unitType" class="form-label">Type</label>
            <select class="form-select" id="unitType">
              <option value="count">Count</option>
              <option value="volume">Volume</option>
              <option value="weight">Weight</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveQuickUnit">Add Unit</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap + Logic -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables
let PRESELECT_INGREDIENT_ID = {{ preselect_ingredient_id or 'null' }};
let SHOULD_ADD_LINE = {{ 'true' if add_ingredient_line else 'false' }};
let ingredientReturnContext = 'main';
let lastIngredientDropdown = null;
let unitReturnContext = 'main';

function addIngredient(preselectId = null) {
  const container = document.getElementById('ingredients-container');
  const entry = document.createElement('div');
  entry.classList.add('ingredient-entry');
  entry.innerHTML = `
    <select name="ingredient_ids[]" required>
      <option value="">Select an ingredient</option>
      {% for ing in all_ingredients %}
      <option value="{{ ing.id }}" ${preselectId == {{ ing.id }} ? 'selected' : ''}>{{ ing.name }}</option>
      {% endfor %}
    </select>
    <input type="number" step="0.01" name="amounts[]" required>
    <select name="units[]" required>
      {% for unit in inventory_units %}
      <option value="{{ unit.name }}">{{ unit.name }}</option>
      {% endfor %}
    </select>
    <button type="button" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(entry);
  if (preselectId) {
    const select = entry.querySelector('select[name="ingredient_ids[]"]');
    if (select) select.value = preselectId;
  }
  entry.scrollIntoView({ behavior: 'smooth' });
  return entry;
}

// Functions
function setIngredientReturnContext(source, dropdown = null) {
  ingredientReturnContext = source;
  lastIngredientDropdown = dropdown;
}

function addIngredient(preselectId = null) {
  const container = document.getElementById('ingredients-container');
  const entry = document.createElement('div');
  entry.classList.add('ingredient-entry');
  entry.innerHTML = `
    <select name="ingredient_ids[]" required>
      <option value="">Select an ingredient</option>
      {% for ing in all_ingredients %}
      <option value="{{ ing.id }}">{{ ing.name }}</option>
      {% endfor %}
    </select>
    <input type="number" step="0.01" name="amounts[]" required>
    <select name="units[]" required>
      {% for unit in inventory_units %}
      <option value="{{ unit.name }}">{{ unit.name }}</option>
      {% endfor %}
    </select>
    <button type="button" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(entry);
  if (preselectId) {
    const select = entry.querySelector('select[name="ingredient_ids[]"]');
    if (select) select.value = preselectId;
  }
  entry.scrollIntoView({ behavior: 'smooth' });
  return entry;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  // Handle initial ingredient line if needed
  if (SHOULD_ADD_LINE && PRESELECT_INGREDIENT_ID) {
    addIngredient(PRESELECT_INGREDIENT_ID);
  }

  // Quick Add Unit Handler
  document.getElementById('saveQuickUnit').addEventListener('click', function() {
    const name = document.getElementById('unitName').value;
    const type = document.getElementById('unitType').value;

    if (!name) return alert('Unit name required.');

    fetch('/recipes/units/quick-add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, type })
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) return alert('Error: ' + data.error);

      // Add to all unit dropdowns
      document.querySelectorAll("select[name='units[]']").forEach(select => {
        select.add(new Option(data.name, data.name, false, true));
      });

      // Add to quick ingredient unit dropdown
      const quickUnit = document.getElementById('quickIngredientUnit');
      quickUnit.add(new Option(data.name, data.name, false, true));
      quickUnit.value = data.name;

      // Handle modal transitions
      const unitModalEl = document.getElementById('quickAddUnitModal');
      const unitModal = bootstrap.Modal.getInstance(unitModalEl);
      if (unitModal) {
        unitModal.hide();

        // Clean up modal artifacts
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        if (unitReturnContext === 'ingredient') {
          // Wait for unit modal to fully close
          setTimeout(() => {
            const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
            ingredientModal.show();
            unitReturnContext = 'main'; // Reset context
          }, 300);
        }
      }

      // Reset form
      document.getElementById('unitName').value = '';
      document.getElementById('unitType').selectedIndex = 0;
    });
  });

  // Quick Add Ingredient Handler
  document.getElementById('saveQuickIngredient').addEventListener('click', function() {
    const name = document.getElementById('quickIngredientName').value.trim();
    const unit = document.getElementById('quickIngredientUnit').value;

    if (!name || !unit) {
      alert('Both name and unit are required.');
      return;
    }

    const button = this;
    button.disabled = true;
    button.innerText = 'Adding...';

    fetch('/ingredients/quick-add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, unit })
    })
    .then(async response => {
      if (!response.ok) {
        const err = await response.text();
        throw new Error(err);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) return alert('Error: ' + data.error);

      // Close the modal
      const modal = document.getElementById('quickAddIngredientModal');
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();

      // Clean up UI artifacts
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

      // Let the server handle the row prefill
      window.location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to add ingredient. Please try again.');

      // Clean up modal state after error
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

      // Re-init modal for clean state
      const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
      ingredientModal.hide();
    })
    .finally(() => {
      button.disabled = false;
      button.innerText = 'Add Ingredient';

      // Additional cleanup in finally block
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    });
  });

  // Added event listener for closing the unit modal
  document.getElementById('quickAddUnitModal').addEventListener('hidden.bs.modal', function () {
    if (unitReturnContext === 'ingredient') {
      const ingredientModal = new bootstrap.Modal(document.getElementById('quickAddIngredientModal'));
      setTimeout(() => ingredientModal.show(), 300);
      unitReturnContext = 'main';
    }
  });
});
</script>
{% endblock %}