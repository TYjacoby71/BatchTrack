<!-- History Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">History</h5>
  </div>
  <div class="card-body">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Change Type</th>
          <th>Quantity Change</th>
          <th>Remaining</th>
          <th>Cost per Unit</th>
          <th>Total Cost</th>
          <th>Used For</th>
          <th>Credited/Debited To</th>
          <th>FIFO ID 
            <i class="fas fa-info-circle text-muted ms-1" 
               data-bs-toggle="popover" 
               data-bs-placement="top"
               data-bs-trigger="click"
               data-bs-html="true"
               data-bs-content="
                 <div class='fifo-prefix-guide'>
                   <h6 class='mb-2'>FIFO ID Prefixes</h6>
                   <div class='row'>
                     <div class='col-6'>
                       <strong>RSK</strong> - Restock<br>
                       <strong>BTC</strong> - Batch<br>
                       <strong>SPL</strong> - Spoilage<br>
                       <strong>TRS</strong> - Trash
                     </div>
                     <div class='col-6'>
                       <strong>RCN</strong> - Recount<br>
                       <strong>FIN</strong> - Finished Batch<br>
                       <strong>REF</strong> - Refunded<br>
                       <strong>CST</strong> - Cost Override
                     </div>
                   </div>
                 </div>"
               title="FIFO ID Reference"
               style="cursor: pointer;">
            </i>
          </th>
          <th>Exp Date</th>
          <th>Quantity Used</th>
          <th>Created By</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in history %}
        <tr>
          <td>{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ entry.change_type|title }}</td>
          <td>{{ entry.quantity_change }}{% if item.type != 'container' %} {{ entry.unit }}{% endif %}</td>
          <td>{{ "%.2f"|format(entry.remaining_quantity) if entry.remaining_quantity is not none and entry.change_type in ['restock', 'finished_batch'] else 'NA' }}</td>
          <td>${{ "%.2f"|format(entry.unit_cost) if entry.unit_cost is not none else 'NA' }}</td>
          <td>{% if entry.unit_cost is not none %}${{ "%.2f"|format(abs(entry.quantity_change) * entry.unit_cost) }}{% else %}NA{% endif %}</td>
          <td>
            {% if entry.change_type in ['batch', 'spoil', 'trash', 'refunded'] and entry.batch %}
              <a href="{{ url_for('batches.view_batch', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
            {% else %}
              NA
            {% endif %}
          </td>
          <td>
            {% if entry.fifo_reference_id %}
              {% set ref_entry = history|selectattr('id', 'equalto', entry.fifo_reference_id)|first %}
              {% if ref_entry and ref_entry.change_type == 'finished_batch' and ref_entry.batch %}
                {% if ref_entry.batch.status == 'in_progress' %}
                  <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=ref_entry.batch.id) }}">{{ ref_entry.batch.label_code }}</a>
                {% else %}
                  <a href="{{ url_for('batches.view_batch', batch_identifier=ref_entry.batch.id) }}">{{ ref_entry.batch.label_code }}</a>
                {% endif %}
              {% elif ref_entry %}
                <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.fifo_reference_id }}">
                  {{ get_change_type_prefix(ref_entry.change_type) }}-{{ int_to_base36(ref_entry.id).zfill(6) }}
                </a>
              {% else %}
                <a href="{{ url_for('inventory.view_inventory', id=item.id) }}#entry-{{ entry.fifo_reference_id }}">
                  {{ get_change_type_prefix('restock') }}-{{ int_to_base36(entry.fifo_reference_id).zfill(6) }}
                </a>
              {% endif %}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if entry.change_type == 'finished_batch' and entry.batch %}
              {% if entry.batch.status == 'in_progress' %}
                <a href="{{ url_for('batches.view_batch_in_progress', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
              {% else %}
                <a href="{{ url_for('batches.view_batch', batch_identifier=entry.batch.id) }}">{{ entry.batch.label_code }}</a>
              {% endif %}
            {% else %}
              {{ get_change_type_prefix(entry.change_type) }}-{{ int_to_base36(entry.id).zfill(6) }}
            {% endif %}
          </td>
          <td {% if entry.is_perishable and entry.expiration_date %}
              class="{% if entry.remaining_quantity > 0 and entry.expiration_date and entry.expiration_date.date() < now.date() %}bg-warning{% endif %}"
              {% endif %}>
              {{ entry.expiration_date.strftime('%Y-%m-%d') if entry.expiration_date else '-' }}
          </td>
          <td>{{ entry.quantity_used if entry.quantity_used is not none and entry.quantity_used != 0 else 'NA' }}</td>
          <td>{% if entry.created_by %}{{ User.query.get(entry.created_by).username }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if pagination.pages > 1 %}
    <nav aria-label="History navigation">
      <ul class="pagination">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.prev_num) }}">&laquo;</a>
        </li>
        {% endif %}

        {% for page in pagination.iter_pages() %}
        {% if page %}
        <li class="page-item {% if page == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=page) }}">{{ page }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('inventory.view_inventory', id=item.id, page=pagination.next_num) }}">&raquo;</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>