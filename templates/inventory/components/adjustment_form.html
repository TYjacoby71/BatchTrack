<div class="card mt-3">
  <div class="card-header">
    <h5><i class="fas fa-edit"></i> Adjust Inventory</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('inventory.adjust_inventory', id=item.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <!-- Change Type Selection -->
      <div class="mb-3">
        <label for="change_type" class="form-label">Change Type</label>
        <select class="form-control" id="change_type" name="change_type" required>
          <option value="">Select change type...</option>
          <option value="restock">Restock</option>
          <option value="spoil">Mark as Spoiled</option>
          <option value="trash">Discard/Trash</option>
          <option value="recount">Manual Recount</option>
        </select>
      </div>

      <!-- Quantity Input -->
      <div class="row">
        <div class="col-md-8">
          <label for="quantity" class="form-label">Quantity</label>
          <input type="number" step="0.01" class="form-control" id="quantity" name="quantity" required>
        </div>
        <div class="col-md-4">
          <label for="unit" class="form-label">Unit</label>
          <select class="form-control" id="unit" name="unit" required>
            <option value="{{ item.unit }}">{{ item.unit }}</option>
            {% if item.conversions %}
              {% for conversion in item.conversions %}
                <option value="{{ conversion.to_unit }}">{{ conversion.to_unit }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
      </div>

      <!-- Cost Override Section -->
      <div class="mt-3" id="costSection" style="display: none;">
        <label for="restock_cost" class="form-label">Cost per {{ item.unit }}</label>
        <input type="number" step="0.01" class="form-control" id="restock_cost" name="restock_cost">
        <small class="form-text text-muted">Leave empty to use current cost ({{ "${:,.2f}".format(item.cost_per_unit) }})</small>
      </div>

      <!-- Expiration Override Section -->
      {% if item.is_perishable %}
      <div class="mt-3" id="expirationOverrideSection" style="display: none;">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="override_expiration" name="override_expiration">
          <label class="form-check-label" for="override_expiration">
            Override shelf life (default: {{ item.shelf_life_days }} days)
          </label>
        </div>
        <div id="shelfLifeField" style="display: none;" class="mt-2">
          <label for="custom_shelf_life_days" class="form-label">Custom Shelf Life (days)</label>
          <input type="number" class="form-control" id="custom_shelf_life_days" name="custom_shelf_life_days" min="1">
        </div>
      </div>
      {% endif %}

      <!-- Notes -->
      <div class="mt-3">
        <label for="notes" class="form-label">Notes</label>
        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
      </div>

      <button type="submit" class="btn btn-primary mt-3">
        <i class="fas fa-save"></i> Apply Adjustment
      </button>
    </form>
  </div>
</div>

<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
  const changeTypeSelect = document.getElementById('change_type');
  const costSection = document.getElementById('costSection');
  const costInput = document.getElementById('restock_cost');

  // Only set up expiration handling if the section exists
  const expirationOverrideSection = document.getElementById('expirationOverrideSection');
  const overrideExpirationCheckbox = document.getElementById('override_expiration');
  const shelfLifeField = document.getElementById('shelfLifeField');

  if (changeTypeSelect) {
    changeTypeSelect.addEventListener('change', function() {
      const selectedType = this.value;

      // Handle cost section visibility
      if (costSection && costInput) {
        if (selectedType === 'restock') {
          costSection.style.display = 'block';
          costInput.disabled = false;
        } else {
          costSection.style.display = 'none';
          costInput.disabled = true;
          costInput.value = '';
        }
      }

      // Handle expiration section visibility (only if it exists)
      if (expirationOverrideSection) {
        if (selectedType === 'restock') {
          expirationOverrideSection.style.display = 'block';
        } else {
          expirationOverrideSection.style.display = 'none';
          if (overrideExpirationCheckbox) {
            overrideExpirationCheckbox.checked = false;
          }
          if (shelfLifeField) {
            shelfLifeField.style.display = 'none';
          }
        }
      }
    });
  }

  // Handle expiration override checkbox (only if it exists)
  if (overrideExpirationCheckbox && shelfLifeField) {
    overrideExpirationCheckbox.addEventListener('change', function() {
      if (this.checked) {
        shelfLifeField.style.display = 'block';
      } else {
        shelfLifeField.style.display = 'none';
        const customShelfLifeInput = document.getElementById('custom_shelf_life_days');
        if (customShelfLifeInput) {
          customShelfLifeInput.value = '';
        }
      }
    });
  }
});
</script>