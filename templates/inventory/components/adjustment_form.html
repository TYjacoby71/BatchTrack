<!-- Inventory Adjustment -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Adjust Inventory</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('inventory.adjust_inventory', id=item.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label>Change Type</label>
            <select class="form-control" name="change_type" required>
              <option value="restock">Restock</option>
              <option value="spoil">Spoilage</option>
              <option value="trash">Trash</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label>Quantity Change</label>
            <div class="input-group">
              <input type="number" class="form-control" name="quantity" step="0.01" required>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label>Unit</label>
            <select class="form-control" name="unit" required>
              {% for unit in get_global_unit_list() %}
                <option value="{{ unit.name }}" {% if unit.name == item.unit %}selected{% endif %}>
                  {{ unit.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label>Cost Override (for restock only)</label>
            <input type="number" class="form-control" name="restock_cost" step="0.01" placeholder="Leave blank to use current cost">
          </div>
        </div>
      </div>
      <div class="form-group mt-3">
        <label>Notes</label>
        <textarea class="form-control" name="notes" rows="2"></textarea>
      </div>
      <button type="submit" class="btn btn-primary mt-3">Submit Adjustment</button>
    </form>
  </div>
</div>

<script>
document.getElementById('costEntryType').addEventListener('change', function() {
  const costInput = document.getElementById('costPerUnit');
  const helpText = document.getElementById('costHelp');
  const currentCost = {{ item.cost_per_unit or 0 }};

  switch(this.value) {
    case 'no_change':
      costInput.value = currentCost;
      costInput.readOnly = true;
      helpText.textContent = 'Using current cost per unit';
      break;
    case 'per_unit':
      costInput.value = '';
      costInput.readOnly = false;
      helpText.textContent = 'Enter cost per individual unit';
      break;
    case 'total':
      costInput.value = '';
      costInput.readOnly = false;
      helpText.textContent = 'Enter total cost - will be divided by quantity';
      break;
  }
});

document.querySelector('input[name="quantity"]').addEventListener('input', function() {
  const costType = document.getElementById('costEntryType');
  if (costType.value === 'total') {
    const qty = parseFloat(this.value) || 0;
    document.getElementById('costHelp').textContent = 
      `Enter total cost - will be divided by ${qty} units`;
  }
});

document.getElementById('costEntryType').dispatchEvent(new Event('change'));

document.querySelector('select[name="change_type"]').addEventListener('change', function() {
  const costInput = document.getElementById('costPerUnit');
  costInput.disabled = ['spoil', 'trash'].includes(this.value);
  if (costInput.disabled) costInput.value = '';
});
</script>