
<!-- Inventory Adjustment -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Adjust Inventory</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('inventory.adjust_inventory', id=item.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label>Change Type</label>
            <select class="form-control" name="change_type" required>
              <option value="restock">Restock</option>
              <option value="spoil">Spoilage</option>
              <option value="trash">Trash</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label>Quantity Change</label>
            <div class="input-group">
              <input type="number" class="form-control" name="quantity" {% if item.type == 'container' %}step="1" min="1"{% else %}step="0.01" min="0.01"{% endif %} required>
              {% if item.type != 'container' %}
              <select class="form-control" name="input_unit" required>
                {% for unit in get_global_unit_list() %}
                  <option value="{{ unit.name }}" {% if unit.name == item.unit %}selected{% endif %}>{{ unit.name }}</option>
                {% endfor %}
              </select>
              {% else %}
              <input type="hidden" name="input_unit" value="count">
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label>Cost Entry Type</label>
            <select class="form-control" name="cost_entry_type" id="costEntryType">
              <option value="no_change">No Change</option>
              <option value="per_unit">Per Unit Cost</option>
              <option value="total">Total Cost</option>
            </select>
          </div>
          <div class="form-group mt-2">
            <label>Cost</label>
            <input type="number" class="form-control" name="cost_per_unit" step="0.01" id="costPerUnit">
            <small class="form-text text-muted" id="costHelp"></small>
          </div>
        </div>
      </div>
      <!-- Shelf Life Override -->
      <div class="form-group mt-3" id="expirationOverrideSection" style="display: none;">
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="override_expiration" name="override_expiration">
          <label class="form-check-label" for="override_expiration">
            Override shelf life for this restock
          </label>
        </div>
        <div id="shelfLifeField" style="display: none;">
          <label for="custom_shelf_life_days">Custom Shelf Life (days)</label>
          <input type="number" class="form-control" id="custom_shelf_life_days" name="custom_shelf_life_days" min="1">
          <small class="form-text text-muted">
            This will override the ingredient's default shelf life for this specific restock entry. Expiration date will be calculated automatically.
          </small>
        </div>
      </div>
      
      <div class="form-group mt-3">
        <label>Notes</label>
        <textarea class="form-control" name="notes" rows="2"></textarea>
      </div>
      <button type="submit" class="btn btn-primary mt-3">Submit Adjustment</button>
    </form>
  </div>
</div>

<script>
document.getElementById('costEntryType').addEventListener('change', function() {
  const costInput = document.getElementById('costPerUnit');
  const helpText = document.getElementById('costHelp');
  const currentCost = {{ item.cost_per_unit or 0 }};

  switch(this.value) {
    case 'no_change':
      costInput.value = currentCost;
      costInput.readOnly = true;
      helpText.textContent = 'Using current cost per unit';
      break;
    case 'per_unit':
      costInput.value = '';
      costInput.readOnly = false;
      helpText.textContent = 'Enter cost per individual unit';
      break;
    case 'total':
      costInput.value = '';
      costInput.readOnly = false;
      helpText.textContent = 'Enter total cost - will be divided by quantity';
      break;
  }
});

document.querySelector('input[name="quantity"]').addEventListener('input', function() {
  const costType = document.getElementById('costEntryType');
  if (costType.value === 'total') {
    const qty = parseFloat(this.value) || 0;
    document.getElementById('costHelp').textContent = 
      `Enter total cost - will be divided by ${qty} units`;
  }
});

document.getElementById('costEntryType').dispatchEvent(new Event('change'));

document.querySelector('select[name="change_type"]').addEventListener('change', function() {
  const costInput = document.getElementById('costPerUnit');
  const expirationSection = document.getElementById('expirationOverrideSection');
  
  costInput.disabled = ['spoil', 'trash'].includes(this.value);
  if (costInput.disabled) costInput.value = '';
  
  // Show expiration override only for restock operations
  if (this.value === 'restock') {
    expirationSection.style.display = 'block';
  } else {
    expirationSection.style.display = 'none';
    document.getElementById('override_expiration').checked = false;
    document.getElementById('expirationDateField').style.display = 'none';
  }
});

// Handle expiration override checkbox
document.getElementById('override_expiration').addEventListener('change', function() {
  const dateField = document.getElementById('expirationDateField');
  dateField.style.display = this.checked ? 'block' : 'none';
  
  if (!this.checked) {
    document.getElementById('expiration_date').value = '';
  }
});
</script>
