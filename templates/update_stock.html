{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<h2>ðŸ“¥ Stock Update</h2>
<form method="POST" action="/stock/inventory/update" id="updateForm">
  <div style="margin-bottom: 20px;">
    <h3>Update Ingredients</h3>
    <style>
      .ingredient-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .ingredient-row {
        max-width: 900px;
      }
      .ingredient-row select[name="ingredient_name[]"],
      .ingredient-row input[name="delta[]"],
      .ingredient-row select[name="unit[]"],
      .ingredient-row select[name="reason[]"] {
        flex: 1;
        width: 150px;
      }
      /* Override Select2 container width */
      .select2-container {
        width: 150px !important;
      }
      .delete-btn {
        background: #ff4444;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
      }
      .add-more-btn {
        margin: 0 0 20px 0;
      }
    </style>
    <div id="ingredient-rows">
      <div class="ingredient-row">
        <select name="ingredient_name[]" required onchange="if(this.value === '__add_new__') window.location.href='/add-ingredient?next=/stock/inventory/update'">
          <option value="">Select Ingredient</option>
          {% for ing in ingredients %}
          <option value="{{ ing.name }}">{{ ing.name }} (Current: {{ ing.quantity }} {{ ing.unit }})</option>
          {% endfor %}
          <option value="__add_new__" style="background-color: #4CAF50; color: white;">âž• Quick add new ingredient</option>
        </select>
        <input type="number" step="any" name="delta[]" placeholder="Change Amount">
        <select name="unit[]" required>
          {% for category in units %}
          <optgroup label="{{ units[category]['label'] }}">
            {% for unit in units[category]['units'] %}
            <option value="{{ unit }}">{{ unit }}</option>
            {% endfor %}
          </optgroup>
          {% endfor %}
        </select>
        <select name="reason[]" required>
          <option value="Purchase">Purchase (Add)</option>
          <option value="Loss">Loss (Remove)</option>
          <option value="Spoiled">Spoiled (Remove)</option>
          <option value="Donation">Donation (Remove)</option>
        </select>
        <button type="button" class="delete-btn" onclick="deleteRow(this)" style="display: none;">Ã—</button>
      </div>
    </div>
    <button type="button" onclick="addIngredientRow()" class="btn add-more-btn">+ Add Another Ingredient</button>
  </div>
  <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

<script>
function addIngredientRow() {
  const container = document.getElementById('ingredient-rows');
  const template = container.querySelector('.ingredient-row').cloneNode(true);
  // Reset the values
  template.querySelectorAll('select, input').forEach(el => el.value = '');
  // Show delete button for all rows when there's more than one
  container.querySelectorAll('.delete-btn').forEach(btn => btn.style.display = 'block');
  template.querySelector('.delete-btn').style.display = 'block';
  container.appendChild(template);
}

function deleteRow(btn) {
  const container = document.getElementById('ingredient-rows');
  btn.closest('.ingredient-row').remove();
  // Hide delete button if only one row remains
  if (container.children.length === 1) {
    container.querySelector('.delete-btn').style.display = 'none';
  }
}

function initializeSelect2() {
  $('select[name="ingredient_name[]"]').select2({
    placeholder: "Search for an ingredient...",
    width: '100%'
  });
}

// Initialize Select2 on page load
$(document).ready(function() {
  initializeSelect2();
  // Override Select2 styling
  $(".select2-container").css("width", "200px");
});

// Initialize Select2 after adding new row
const originalAddIngredientRow = addIngredientRow;
addIngredientRow = function() {
  originalAddIngredientRow();
  initializeSelect2();
};
</script>
{% endblock %}