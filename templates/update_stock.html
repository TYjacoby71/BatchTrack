{% extends "layout.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<h2>ðŸ“¥ Stock Update</h2>

<form method="POST" action="/stock/inventory/update" id="updateForm">
  <div style="margin-bottom: 20px;">
    <h3>Update Ingredients</h3>

    <style>
      .ingredient-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
        max-width: 900px;
      }
      .ingredient-row select,
      .ingredient-row input {
        flex: 1;
        width: 150px;
      }
      .select2-container {
        width: 150px !important;
      }
      .delete-btn {
        background: #ff4444;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
      }
      .add-more-btn {
        margin: 0 0 20px 0;
      }
    </style>

    <div id="ingredient-rows">
      <div class="ingredient-row">
        <select name="ingredient_name[]" required onchange="setUnitFromIngredient(this)">
          <option value="">Select Ingredient</option>
          {% for ing in ingredients %}
          <option value="{{ ing.name }}" data-unit="{{ ing.unit }}">{{ ing.name }} (Current: {{ ing.quantity }} {{ ing.unit }})</option>
          {% endfor %}
          <option value="__add_new__" data-url="/quickadd?next=/stock/inventory/update" style="background-color: #4CAF50; color: white;">âž• Quick add new ingredient</option>
        </select>
        <input type="number" step="any" name="delta[]" placeholder="Change Amount">
        <select name="unit[]" required>
          {% for category in units %}
          <optgroup label="{{ units[category]['label'] }}">
            {% for unit in units[category]['units'] %}
            <option value="{{ unit }}">{{ unit }}</option>
            {% endfor %}
          </optgroup>
          {% endfor %}
          <option value="__add_unit__" style="background-color: #4CAF50; color: white;">âž• Add Unit</option>
        </select>
        <select name="reason[]" required>
          <option value="Purchase">Purchase (Add)</option>
          <option value="Loss">Loss (Remove)</option>
          <option value="Spoiled">Spoiled (Remove)</option>
          <option value="Donation">Donation (Remove)</option>
        </select>
        <button type="button" class="delete-btn" onclick="deleteRow(this)" style="display: none;">Ã—</button>
      </div>
    </div>

    <button type="button" onclick="addIngredientRow()" class="btn add-more-btn">+ Add Another Ingredient</button>
  </div>

  <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

<script>
function addIngredientRow() {
  const container = document.getElementById('ingredient-rows');
  const row = document.createElement('div');
  row.classList.add('ingredient-row');

  row.innerHTML = `
    <select name="ingredient_name[]" required onchange="setUnitFromIngredient(this)">
      <option value="">Select Ingredient</option>
      {% for ing in ingredients %}
      <option value="{{ ing.name }}" data-unit="{{ ing.unit }}">{{ ing.name }} (Current: {{ ing.quantity }} {{ ing.unit }})</option>
      {% endfor %}
      <option value="__add_new__" data-url="/quickadd?next=/stock/inventory/update" style="background-color: #4CAF50; color: white;">âž• Quick add new ingredient</option>
    </select>
    <input type="number" step="any" name="delta[]" placeholder="Change Amount">
    <select name="unit[]" required>
      {% for category in units %}
      <optgroup label="{{ units[category]['label'] }}">
        {% for unit in units[category]['units'] %}
        <option value="{{ unit }}">{{ unit }}</option>
        {% endfor %}
      </optgroup>
      {% endfor %}
      <option value="__add_unit__" style="background-color: #4CAF50; color: white;">âž• Add Unit</option>
    </select>
    <select name="reason[]" required>
      <option value="Purchase">Purchase (Add)</option>
      <option value="Loss">Loss (Remove)</option>
      <option value="Spoiled">Spoiled (Remove)</option>
      <option value="Donation">Donation (Remove)</option>
    </select>
    <button type="button" class="delete-btn" onclick="deleteRow(this)">Ã—</button>
  `;

  container.appendChild(row);

  // Initialize select2 for this row's ingredient dropdown
  $(row).find('select[name="ingredient_name[]"]').select2({
    placeholder: "Search for an ingredient...",
    width: '100%'
  });

  // Add unit selector handling for the new row
  row.querySelector('select[name="unit[]"]').addEventListener('change', function() {
    if (this.value === '__add_unit__') {
      window.location.href = '/units?return_url=' + encodeURIComponent(window.location.pathname);
    }
  });

  showAllDeleteButtons();
}

// Add event handler for the initial row's unit dropdown
document.querySelector('select[name="unit[]"]').addEventListener('change', function() {
  if (this.value === '__add_unit__') {
    window.location.href = '/units?return_url=' + encodeURIComponent(window.location.pathname);
  }
});

function setUnitFromIngredient(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const defaultUnit = selectedOption.getAttribute('data-unit');
  const row = selectElement.closest('.ingredient-row');
  const unitSelect = row.querySelector('select[name="unit[]"]');

  if (!defaultUnit || !unitSelect) return;

  for (let option of unitSelect.options) {
    if (option.value === defaultUnit) {
      unitSelect.value = defaultUnit;
      break;
    }
  }
}

function deleteRow(btn) {
  const container = document.getElementById('ingredient-rows');
  btn.closest('.ingredient-row').remove();
  if (container.children.length === 1) {
    container.querySelector('.delete-btn').style.display = 'none';
  }
}

function showAllDeleteButtons() {
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.style.display = 'block';
  });
}

$(document).ready(function () {
  $('select[name="ingredient_name[]"]').select2({
    placeholder: "Search for an ingredient...",
    width: '100%'
  });
});
</script>
{% endblock %}