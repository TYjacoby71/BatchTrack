
{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('products.list_products') }}">Products</a></li>
          <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
      </nav>

      <!-- Product Summary Card -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3>{{ product.name }}</h3>
          <div>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addVariantModal">
              + Add Variant
            </button>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                Actions
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#variants">
                  <i class="fas fa-eye"></i> View Variants
                </a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProductModal">
                  <i class="fas fa-edit"></i> Edit Product
                </a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>Product Base Unit:</strong> {{ product.product_base_unit }}
            </div>
            <div class="col-md-3">
              <strong>Low Stock Alert:</strong> {{ product.low_stock_threshold }}
            </div>
            <div class="col-md-3">
              <strong>Created:</strong> {{ product.created_at.strftime('%Y-%m-%d') }}
            </div>
            <div class="col-md-3">
              <strong>Total Variants:</strong> {{ product.variations|length + 1 }}
              <small class="text-muted">(includes Base)</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Variants & Inventory Table -->
      <div class="card mb-4" id="variants">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4>Variants & Inventory</h4>
          <div>
            <small class="text-muted me-3">Click chevron to expand size details</small>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addManualStockModal">
              <i class="fas fa-plus"></i> Add Manual Stock
            </button>
          </div>
        </div>
        <div class="card-body">
          {% if inventory_groups or product.variations %}
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th style="width: 40px;"></th>
                  <th>Variant Name</th>
                  <th>SKU</th>
                  <th>Total Quantity</th>
                  <th>Size Count</th>
                  <th>Avg Cost</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Base Variant -->
                {% set base_inventory = inventory_groups.values()|selectattr('variant', 'equalto', 'Base')|list %}
                {% set base_total_qty = base_inventory|sum(attribute='total_quantity')|default(0) %}
                {% set base_size_count = base_inventory|length %}
                {% set base_avg_cost = (base_inventory|sum(attribute='avg_cost')|default(0) / base_inventory|length) if base_inventory|length > 0 else 0 %}
                
                <tr class="variant-main-row">
                  <td>
                    {% if base_inventory %}
                    <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" data-bs-target="#base-sizes">
                      <i class="fas fa-chevron-right" id="base-chevron"></i>
                    </button>
                    {% endif %}
                  </td>
                  <td>
                    <strong>Base</strong>
                    <small class="text-muted d-block">Default variant</small>
                  </td>
                  <td>
                    <span class="text-muted">-</span>
                  </td>
                  <td>
                    <span class="{% if base_total_qty <= 0 %}text-danger{% elif base_total_qty < 10 %}text-warning{% else %}text-success{% endif %}">
                      {{ "%.2f"|format(base_total_qty) }}
                    </span>
                  </td>
                  <td>{{ base_size_count }} sizes</td>
                  <td>${{ "%.3f"|format(base_avg_cost) }}</td>
                  <td>
                    {% if base_total_qty <= 0 %}
                      <span class="badge bg-danger">Out of Stock</span>
                    {% elif base_total_qty < product.low_stock_threshold %}
                      <span class="badge bg-warning">Low Stock</span>
                    {% else %}
                      <span class="badge bg-success">In Stock</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-secondary btn-xs dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addManualStockModal" onclick="setVariant('Base')">
                          <i class="fas fa-plus"></i> Add Stock
                        </a></li>
                      </ul>
                    </div>
                  </td>
                </tr>
                
                <!-- Base Variant Size Details -->
                {% if base_inventory %}
                <tr class="collapse" id="base-sizes">
                  <td colspan="8" class="p-0">
                    <div class="ps-4 pe-2 py-2" style="background-color: #f8f9fa;">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr class="table-light">
                            <th style="width: 40px;"></th>
                            <th>Size Label</th>
                            <th>Unit</th>
                            <th>Quantity</th>
                            <th>Batches</th>
                            <th>Cost/Unit</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for group_key, group in inventory_groups.items() %}
                            {% if group.variant == 'Base' %}
                            <tr>
                              <td></td>
                              <td>{{ group.batches[0].size_label if group.batches else '-' }}</td>
                              <td>{{ group.unit }}</td>
                              <td>
                                {% set remaining_total = group.batches|selectattr('quantity', 'gt', 0)|sum(attribute='quantity') %}
                                <span class="{% if remaining_total <= 0 %}text-danger{% elif remaining_total < group.total_quantity * 0.2 %}text-warning{% else %}text-success{% endif %}">
                                  {{ "%.2f"|format(remaining_total) }}
                                </span>
                              </td>
                              <td>{{ group.batches|selectattr('quantity', 'gt', 0)|list|length }}/{{ group.batches|length }}</td>
                              <td>${{ "%.3f"|format(group.avg_cost) }}</td>
                              <td>
                                {% if group.batches and group.batches|length > 0 and group.batches[0].size_label %}
                                <a href="{{ url_for('products.view_variant_inventory', product_id=product.id, variant=group.variant, size_label=group.batches[0].size_label) }}" class="btn btn-info btn-xs">
                                  <i class="fas fa-eye"></i> FIFO
                                </a>
                                {% endif %}
                              </td>
                            </tr>
                            {% endif %}
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endif %}

                <!-- Other Variants -->
                {% for variation in product.variations %}
                {% set var_inventory = inventory_groups.values()|selectattr('variant', 'equalto', variation.name)|list %}
                {% set var_total_qty = var_inventory|sum(attribute='total_quantity')|default(0) %}
                {% set var_size_count = var_inventory|length %}
                {% set var_avg_cost = (var_inventory|sum(attribute='avg_cost')|default(0) / var_inventory|length) if var_inventory|length > 0 else 0 %}
                
                <tr class="variant-main-row">
                  <td>
                    {% if var_inventory %}
                    <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" data-bs-target="#var-{{ variation.id }}-sizes">
                      <i class="fas fa-chevron-right" id="var-{{ variation.id }}-chevron"></i>
                    </button>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ variation.name }}</strong>
                    {% if variation.description %}
                    <small class="text-muted d-block">{{ variation.description }}</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if variation.sku %}
                    <span class="badge bg-secondary">{{ variation.sku }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="{% if var_total_qty <= 0 %}text-danger{% elif var_total_qty < 10 %}text-warning{% else %}text-success{% endif %}">
                      {{ "%.2f"|format(var_total_qty) }}
                    </span>
                  </td>
                  <td>{{ var_size_count }} sizes</td>
                  <td>${{ "%.3f"|format(var_avg_cost) }}</td>
                  <td>
                    {% if var_total_qty <= 0 %}
                      <span class="badge bg-danger">Out of Stock</span>
                    {% elif var_total_qty < product.low_stock_threshold %}
                      <span class="badge bg-warning">Low Stock</span>
                    {% else %}
                      <span class="badge bg-success">In Stock</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-secondary btn-xs dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('products.view_variation', product_id=product.id, variation_id=variation.id) }}">
                          <i class="fas fa-eye"></i> View Details
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addManualStockModal" onclick="setVariant('{{ variation.name }}')">
                          <i class="fas fa-plus"></i> Add Stock
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editVariationModal" onclick="setEditVariation({{ variation.id }}, '{{ variation.name }}', '{{ variation.sku or '' }}', '{{ variation.description or '' }}')">
                          <i class="fas fa-edit"></i> Edit Variant
                        </a></li>
                      </ul>
                    </div>
                  </td>
                </tr>

                <!-- Variant Size Details -->
                {% if var_inventory %}
                <tr class="collapse" id="var-{{ variation.id }}-sizes">
                  <td colspan="8" class="p-0">
                    <div class="ps-4 pe-2 py-2" style="background-color: #f8f9fa;">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr class="table-light">
                            <th style="width: 40px;"></th>
                            <th>Size Label</th>
                            <th>Unit</th>
                            <th>Quantity</th>
                            <th>Batches</th>
                            <th>Cost/Unit</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for group_key, group in inventory_groups.items() %}
                            {% if group.variant == variation.name %}
                            <tr>
                              <td></td>
                              <td>{{ group.batches[0].size_label if group.batches else '-' }}</td>
                              <td>{{ group.unit }}</td>
                              <td>
                                {% set remaining_total = group.batches|selectattr('quantity', 'gt', 0)|sum(attribute='quantity') %}
                                <span class="{% if remaining_total <= 0 %}text-danger{% elif remaining_total < group.total_quantity * 0.2 %}text-warning{% else %}text-success{% endif %}">
                                  {{ "%.2f"|format(remaining_total) }}
                                </span>
                              </td>
                              <td>{{ group.batches|selectattr('quantity', 'gt', 0)|list|length }}/{{ group.batches|length }}</td>
                              <td>${{ "%.3f"|format(group.avg_cost) }}</td>
                              <td>
                                {% if group.batches and group.batches|length > 0 and group.batches[0].size_label %}
                                <a href="{{ url_for('products.view_variant_inventory', product_id=product.id, variant=group.variant, size_label=group.batches[0].size_label) }}" class="btn btn-info btn-xs">
                                  <i class="fas fa-eye"></i> FIFO
                                </a>
                                {% endif %}
                              </td>
                            </tr>
                            {% endif %}
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="alert alert-info">
              No inventory found. Products are added to inventory when batches are completed.
              <hr>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addManualStockModal">
                Add Manual Stock
              </button>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Product Events Log -->
      <div class="card">
        <div class="card-header">
          <h4>Activity Log</h4>
        </div>
        <div class="card-body">
          {% if product.events %}
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for event in product.events|reverse %}
                <tr>
                  <td>{{ event.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <span class="badge bg-{% if 'deduction' in event.event_type %}warning{% elif 'spoil' in event.event_type %}danger{% else %}info{% endif %}">
                      {{ event.event_type.replace('_', ' ').title() }}
                    </span>
                  </td>
                  <td>{{ event.note }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="alert alert-info">No activity recorded yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('products.edit_product', product_id=product.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" name="name" class="form-control" value="{{ product.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Product Base Unit</label>
            <select name="product_base_unit" class="form-select" required>
              {% for unit in get_global_unit_list() %}
                <option value="{{ unit.name }}" {% if unit.name == product.product_base_unit %}selected{% endif %}>
                  {{ unit.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Low Stock Threshold</label>
            <input type="number" name="low_stock_threshold" class="form-control" 
                   value="{{ product.low_stock_threshold }}" step="0.01" min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Variant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addVariantForm">
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <div class="mb-3">
            <label class="form-label">Variant Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">SKU (Optional)</label>
            <input type="text" name="sku" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addVariant()">Add Variant</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Variant Modal -->
<div class="modal fade" id="editVariationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Variant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="" id="editVariationForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Variant Name</label>
            <input type="text" name="name" id="editVariantName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">SKU (Optional)</label>
            <input type="text" name="sku" id="editVariantSku" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" id="editVariantDescription" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Manual Stock Modal -->
<div class="modal fade" id="addManualStockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Manual Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('products.add_manual_stock', product_id=product.id) }}">
        {{ csrf_token() }}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Variant</label>
            <select name="variant_name" id="manualStockVariant" class="form-select" required>
              <option value="Base">Base</option>
              {% for variation in product.variations %}
              <option value="{{ variation.name }}">{{ variation.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Container Type (Optional)</label>
            <select name="container_id" class="form-select">
              <option value="">No Container (Standalone Product)</option>
              {% for container in available_containers %}
              <option value="{{ container.id }}">
                {{ container.name }} ({{ container.storage_amount }} {{ container.storage_unit }})
                - Available: {{ container.quantity }}
              </option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">
              Select "No Container" for standalone products like bread loaves, whole items, etc.
            </small>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" name="quantity" class="form-control" step="0.01" min="0.01" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Unit Cost per Item</label>
            <input type="number" name="unit_cost" class="form-control" step="0.001" min="0" value="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Stock</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.btn-xs {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.variant-main-row {
  border-left: 3px solid #007bff;
}

.variant-main-row:hover {
  background-color: #f8f9fa;
}

/* Chevron rotation animation */
.chevron-rotate {
  transform: rotate(90deg);
  transition: transform 0.2s ease;
}

/* Nested table styling */
.table tbody tr td .table {
  border: none;
}

.table tbody tr td .table thead th {
  border-top: none;
  font-size: 0.875rem;
  font-weight: 600;
}

.table tbody tr td .table tbody td {
  border-top: 1px solid #e9ecef;
  font-size: 0.875rem;
}
</style>

<script>
// Add variant via AJAX
function addVariant() {
  const form = document.getElementById('addVariantForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);

  fetch("{{ url_for('products.add_variant', product_id=product.id) }}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name=csrf_token]').value
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    alert('Error adding variant: ' + error);
  });
}

// Set variant for manual stock modal
function setVariant(variantName) {
  document.getElementById('manualStockVariant').value = variantName;
}

// Set edit variation modal data
function setEditVariation(variationId, name, sku, description) {
  document.getElementById('editVariantName').value = name;
  document.getElementById('editVariantSku').value = sku;
  document.getElementById('editVariantDescription').value = description;
  document.getElementById('editVariationForm').action = `/products/{{ product.id }}/variation/${variationId}/edit`;
}

// Handle chevron rotation and collapse
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners for all collapse toggles
  document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
    button.addEventListener('click', function() {
      const chevron = this.querySelector('i');
      const target = document.querySelector(this.dataset.bsTarget);
      
      // Toggle chevron rotation immediately
      if (chevron.classList.contains('fa-chevron-right')) {
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
      } else {
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
      }
    });
  });
});
</script>
{% endblock %}
