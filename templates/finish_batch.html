
{% extends "layout.html" %}
{% block content %}
<h2>Finish Batch: {{ batch.recipe_name }}</h2>

<form method="POST">
  <h3>Batch Information</h3>
  <label>Batch Type:</label><br>
  <select name="batch_type" required>
    <option value="inventory">Inventory Item</option>
    <option value="product">Final Product</option>
  </select><br><br>

  <h3>Ingredient Usage Adjustment</h3>
  <p><small>Adjust actual quantities used if different from recipe amounts</small></p>
  <div id="ingredient-adjustments">
    {% for ingredient in batch.ingredients %}
    <div class="ingredient-row">
      <input type="hidden" name="ingredient_name[]" value="{{ ingredient.name }}">
      <label>{{ ingredient.name }} (Recipe called for: {{ ingredient.quantity }} {{ ingredient.unit }})</label><br>
      <input type="number" step="any" name="quantity_used[]" value="{{ ingredient.quantity }}" placeholder="Actual amount used">
      <span>{{ ingredient.unit }}</span>
    </div>
    {% endfor %}
  </div>
  <br>

  <label>Was the batch successful?</label><br>
  <input type="radio" name="success" value="yes" required> Yes
  <input type="radio" name="success" value="no"> No<br><br>

  <label>Yield:</label><br>
  <input type="number" step="any" name="yield_qty" required>
  <label>Units:</label>
  <select name="yield_unit" required>
    {% for category in units %}
    <optgroup label="{{ units[category]['label'] }}">
        {% for unit in units[category]['units'] %}
        <option value="{{ unit }}">{{ unit }}</option>
        {% endfor %}
    </optgroup>
    {% endfor %}
  </select><br><br>

  <label>Notes:</label><br>
  <textarea name="notes"></textarea><br><br>

  <label>Label Info:</label><br>
  <textarea name="label_info" placeholder="Enter information for product label"></textarea><br><br>

  <label>Expiration:</label><br>
  <input type="radio" name="is_perishable" value="yes" onclick="document.getElementById('expiry_days').disabled=false"> Perishable
  <input type="radio" name="is_perishable" value="no" onclick="document.getElementById('expiry_days').disabled=true" checked> Non-perishable<br>
  <input type="number" id="expiry_days" name="expiry_days" placeholder="Days until expiration" disabled><br><br>

  <button type="submit">Complete Batch</button>
</form>

<form method="POST" action="/batches/invalidate/{{ batch.id }}" style="margin-top: 2em;">
  <button type="submit" style="color: red;">Mark Batch as Invalid (restores ingredients)</button>
</form>
{% endblock %}
